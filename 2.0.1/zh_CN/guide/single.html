<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>The Grails Framework null</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
    </head>

    <body class="body" onload="addJsClass();">
        <div id="navigation">
            <ul>
                <li>
                    <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                        <a href="../guide/index.html" class="button">Table of contents</a>
                        <div id="nav-summary-childs" style="display:none;">
                            
                            <div class="toc-item" style="margin-left:0"><a href="#introduction"><strong>1</strong><span>&#31616;&#20171;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#gettingStarted"><strong>2</strong><span>&#36215;&#27493;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#conf"><strong>3</strong><span>&#37197;&#32622;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#commandLine"><strong>4</strong><span>&#21629;&#20196;&#34892;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#GORM"><strong>5</strong><span>&#23545;&#35937;&#20851;&#31995;&#26144;&#23556;&#65288;GORM&#65289;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#theWebLayer"><strong>6</strong><span>Web&#23618;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#validation"><strong>7</strong><span>Validation</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#services"><strong>8</strong><span>The Service Layer</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#testing"><strong>9</strong><span>Testing</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#i18n"><strong>10</strong><span>Internationalization</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#security"><strong>11</strong><span>Security</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#plugins"><strong>12</strong><span>Plugins</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#webServices"><strong>13</strong><span>Web Services</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#spring"><strong>14</strong><span>Grails and Spring</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#hibernate"><strong>15</strong><span>Grails and Hibernate</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#scaffolding"><strong>16</strong><span>Scaffolding</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#deployment"><strong>17</strong><span>Deployment</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#contributing"><strong>18</strong><span>Contributing to Grails</span></a></div>
                            
                        </div>
                    </div>
                </li>
                <li class="separator selected">
                    <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
                </li>
            </ul>
        </div>
        <div id="header">
            <div class="images clearfix">
                
                <span id="logo"><a href="http://grails.org" target="_blank"><img alt="Grails Logo" title="The Grails Framework" src="../../img/grails.png" border="0"/></a></span>
                
                
                <span id="sponsor"><a href="http://springsource.com" target="_blank"><img alt="SpringSource Logo" title="SpringSource - Weapons for the War on Java Complexity" src="../../img/springsource-logo.png" border="0"/></a></span>
                
            </div>
            <p>See the light - agile, industrial strength, rapid web application development made easy</p>
        </div>


        <table id="colset" border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td id="col1">
                    <div id="main" class="corner-all">

                        <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                        <div class="project">
                            <h1>The Grails Framework - Reference Documentation</h1>
                            <p><strong>Authors:</strong> Graeme Rocher, Peter Ledbrook, Marc Palmer, Jeff Brown, Luke Daley, Burt Beckwith</p>
                            <p><strong>Version:</strong> null</p>
                            
                        </div>

                        
                        <div id="table-of-content">
                            <h2>Table of Contents</h2>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#introduction"><strong>1</strong><span>&#31616;&#20171;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#whatsNew"><strong>1.1</strong><span>Grails 2.0&#26377;&#37027;&#20123;&#26032;&#29305;&#24615;?</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#developmentEnvironmentFeatures"><strong>1.1.1</strong><span>&#38754;&#21521;&#24320;&#21457;&#30340;&#29305;&#24615;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#coreFeatures"><strong>1.1.2</strong><span>&#26680;&#24515;&#29305;&#24615;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#webFeatures"><strong>1.1.3</strong><span>Web&#23618;&#29305;&#24615;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#persistenceFeatures"><strong>1.1.4</strong><span>&#25345;&#20037;&#23618;&#29305;&#24615;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#testingFeatures"><strong>1.1.5</strong><span>&#27979;&#35797;&#29305;&#24615;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>2</strong><span>&#36215;&#27493;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>2.1</strong><span>&#23433;&#35013;&#30340;&#21069;&#25552;&#26465;&#20214;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#downloadingAndInstalling"><strong>2.2</strong><span>&#19979;&#36733;&#23433;&#35013;Grails</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#upgradingFromPreviousVersionsOfGrails"><strong>2.3</strong><span>&#20174;&#32769;&#29256;&#26412;Grails&#21319;&#32423;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#creatingAnApplication"><strong>2.4</strong><span>&#21019;&#24314;Grails&#24212;&#29992;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#aHelloWorldExample"><strong>2.5</strong><span>Hello World&#31034;&#20363;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#usingInteractiveMode"><strong>2.6</strong><span>&#20351;&#29992;&#20132;&#20114;&#27169;&#24335;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#ide"><strong>2.7</strong><span>IDE&#35774;&#32622;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#conventionOverConfiguration"><strong>2.8</strong><span>&#35268;&#32422;&#37197;&#32622;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#runningAnApplication"><strong>2.9</strong><span>&#36816;&#34892;&#24212;&#29992;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#testingAnApplication"><strong>2.10</strong><span>&#27979;&#35797;&#24212;&#29992;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#deployingAnApplication"><strong>2.11</strong><span>&#37096;&#32626;&#24212;&#29992;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#supportedJavaEEContainers"><strong>2.12</strong><span>&#25152;&#25903;&#25345;&#30340;Java EE&#23481;&#22120;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#generatingAnApplication"><strong>2.13</strong><span>&#29983;&#25104;&#24212;&#29992;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#creatingArtefacts"><strong>2.14</strong><span>&#21019;&#24314;&#24037;&#20214;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#conf"><strong>3</strong><span>&#37197;&#32622;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#config"><strong>3.1</strong><span>&#22522;&#26412;&#37197;&#32622;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#builtInOptions"><strong>3.1.1</strong><span>&#20869;&#32622;&#36873;&#39033;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#logging"><strong>3.1.2</strong><span>&#26085;&#24535;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#configGORM"><strong>3.1.3</strong><span>&#37197;&#32622;GORM</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#environments"><strong>3.2</strong><span>&#29615;&#22659;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#dataSource"><strong>3.3</strong><span>&#25968;&#25454;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#dataSourcesAndEnvironments"><strong>3.3.1</strong><span>&#25968;&#25454;&#28304;&#21644;&#29615;&#22659;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#JNDIDataSources"><strong>3.3.2</strong><span>JNDI&#25968;&#25454;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#automaticDatabaseMigration"><strong>3.3.3</strong><span>&#33258;&#21160;&#25968;&#25454;&#24211;&#36801;&#31227;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#transactionAwareDataSourceProxy"><strong>3.3.4</strong><span>&#20107;&#21153;&#24863;&#30693;&#30340;&#25968;&#25454;&#28304;&#20195;&#29702;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#databaseConsole"><strong>3.3.5</strong><span>&#25968;&#25454;&#24211;&#31649;&#29702;&#30028;&#38754;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#multipleDatasources"><strong>3.3.6</strong><span>&#22810;&#25968;&#25454;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#configExternalized"><strong>3.4</strong><span>&#22806;&#37096;&#37197;&#32622;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#versioning"><strong>3.5</strong><span>&#29256;&#26412;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#docengine"><strong>3.6</strong><span>&#25991;&#26723;&#24341;&#25806;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#ivy"><strong>3.7</strong><span>&#20381;&#36182;&#35299;&#26512;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#configurationsAndDependencies"><strong>3.7.1</strong><span>&#37197;&#32622;&#21644;&#20381;&#36182;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#dependencyRepositories"><strong>3.7.2</strong><span>&#20381;&#36182;&#23384;&#20648;&#24211;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#debuggingResolution"><strong>3.7.3</strong><span>&#35843;&#35797;&#35299;&#26512;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#inheritedDependencies"><strong>3.7.4</strong><span>&#20381;&#36182;&#32487;&#25215;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#providingDefaultDependencies"><strong>3.7.5</strong><span>&#32570;&#30465;&#30340;&#20381;&#36182;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#changingDependencies"><strong>3.7.6</strong><span>&#24555;&#29031;&#21644;&#20854;&#20182;&#21464;&#21270;&#30340;&#20381;&#36182;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#dependencyReports"><strong>3.7.7</strong><span>&#20381;&#36182;&#25253;&#21578;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#pluginJARDependencies"><strong>3.7.8</strong><span>&#25554;&#20214;&#30340;JAR&#20381;&#36182;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mavenIntegration"><strong>3.7.9</strong><span>Maven&#38598;&#25104;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mavendeploy"><strong>3.7.10</strong><span>&#37096;&#32626;&#21040;Maven&#23384;&#20648;&#24211;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#pluginDependencies"><strong>3.7.11</strong><span>&#25554;&#20214;&#20381;&#36182;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#commandLine"><strong>4</strong><span>&#21629;&#20196;&#34892;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#interactiveMode"><strong>4.1</strong><span>&#20132;&#20114;&#27169;&#24335;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#creatingGantScripts"><strong>4.2</strong><span>&#21019;&#24314;Gant&#33050;&#26412;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#reusingGrailsScripts"><strong>4.3</strong><span>&#37325;&#29992;Grails&#33050;&#26412;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#events"><strong>4.4</strong><span>&#38057;&#23376;&#20107;&#20214;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#buildCustomising"><strong>4.5</strong><span>&#33258;&#23450;&#20041;&#26500;&#24314;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#antAndMaven"><strong>4.6</strong><span>Ant&#21644;Maven</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#GORM"><strong>5</strong><span>&#23545;&#35937;&#20851;&#31995;&#26144;&#23556;&#65288;GORM&#65289;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#quickStartGuide"><strong>5.1</strong><span>&#24555;&#36895;&#20837;&#38376;&#25351;&#21335;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#basicCRUD"><strong>5.1.1</strong><span>&#22522;&#26412;&#30340;&#22686;&#21024;&#25913;&#26597;&#65288;CRUD&#65289;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#domainClasses"><strong>5.2</strong><span>&#39046;&#22495;&#65288;Domain&#65289;&#24314;&#27169;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#gormAssociation"><strong>5.2.1</strong><span>GORM&#20013;&#30340;&#20851;&#32852;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#manyToOneAndOneToOne"><strong>5.2.1.1</strong><span>Many-to-one&#21644;one-to-one</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#oneToMany"><strong>5.2.1.2</strong><span>One-to-many</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#manyToMany"><strong>5.2.1.3</strong><span>Many-to-many</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#basicCollectionTypes"><strong>5.2.1.4</strong><span>&#22522;&#26412;&#30340;&#38598;&#21512;&#31867;&#22411;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#gormComposition"><strong>5.2.2</strong><span>GORM&#20013;&#30340;&#32452;&#21512;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#inheritanceInGORM"><strong>5.2.3</strong><span>GORM&#20013;&#30340;&#32487;&#25215;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#sets,ListsAndMaps"><strong>5.2.4</strong><span>&#38598;&#21512;&#12289;&#21015;&#34920;&#21644;&#26144;&#23556;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#persistenceBasics"><strong>5.3</strong><span>&#25345;&#20037;&#21270;&#22522;&#30784;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#savingAndUpdating"><strong>5.3.1</strong><span>&#20445;&#23384;&#21644;&#26356;&#26032;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#deletingObjects"><strong>5.3.2</strong><span>&#21024;&#38500;&#23545;&#35937;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#cascades"><strong>5.3.3</strong><span>&#29702;&#35299;&#32423;&#32852;&#26356;&#26032;&#21644;&#21024;&#38500;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#fetching"><strong>5.3.4</strong><span>&#31435;&#21363;&#21152;&#36733;&#21644;&#24310;&#36831;&#21152;&#36733;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#locking"><strong>5.3.5</strong><span>&#24754;&#35266;&#38145;&#21644;&#20048;&#35266;&#38145;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#modificationChecking"><strong>5.3.6</strong><span>&#20462;&#25913;&#26816;&#26597;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#querying"><strong>5.4</strong><span>GORM&#26597;&#35810;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#finders"><strong>5.4.1</strong><span>&#21160;&#24577;&#26597;&#35810;&#22120;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#whereQueries"><strong>5.4.2</strong><span>Where&#26597;&#35810;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#criteria"><strong>5.4.3</strong><span>&#26465;&#20214;&#26597;&#35810;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#detachedCriteria"><strong>5.4.4</strong><span>&#20998;&#31163;&#30340;&#26465;&#20214;&#26597;&#35810;(Detached Criteria)</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#hql"><strong>5.4.5</strong><span>Hibernate &#26597;&#35810;&#35821;&#35328;&#65288;HQL&#65289;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#advancedGORMFeatures"><strong>5.5</strong><span>&#39640;&#32423;GORM&#29305;&#24615;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#eventsAutoTimestamping"><strong>5.5.1</strong><span>&#20107;&#20214;&#21644;&#33258;&#21160;&#26102;&#38388;&#25139;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#ormdsl"><strong>5.5.2</strong><span>&#33258;&#23450;&#20041;ORM&#26144;&#23556;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#tableAndColumnNames"><strong>5.5.2.1</strong><span>&#34920;&#21517;&#21644;&#21015;&#21517;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#caching"><strong>5.5.2.2</strong><span>&#32531;&#23384;&#31574;&#30053;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#inheritanceStrategies"><strong>5.5.2.3</strong><span>&#32487;&#25215;&#31574;&#30053;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#identity"><strong>5.5.2.4</strong><span>&#25968;&#25454;&#24211;&#26631;&#35782;&#31526;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#compositePrimaryKeys"><strong>5.5.2.5</strong><span>&#22797;&#21512;&#20027;&#38190;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#databaseIndices"><strong>5.5.2.6</strong><span>&#25968;&#25454;&#24211;&#32034;&#24341;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#optimisticLockingAndVersioning"><strong>5.5.2.7</strong><span>&#20048;&#35266;&#38145;&#21644;&#29256;&#26412;&#23450;&#20041;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#fetchingDSL"><strong>5.5.2.8</strong><span>&#31435;&#21363;&#21152;&#36733;&#21644;&#24310;&#36831;&#21152;&#36733;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#customCascadeBehaviour"><strong>5.5.2.9</strong><span>&#33258;&#23450;&#20041;&#32423;&#32852;&#34892;&#20026;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#customHibernateTypes"><strong>5.5.2.10</strong><span>&#33258;&#23450;&#20041;Hibernate&#30340;&#31867;&#22411;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#derivedProperties"><strong>5.5.2.11</strong><span>&#27966;&#29983;&#23646;&#24615;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#customNamingStrategy"><strong>5.5.2.12</strong><span>&#33258;&#23450;&#20041;&#30340;&#21629;&#21517;&#31574;&#30053;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#defaultSortOrder"><strong>5.5.3</strong><span>&#32570;&#30465;&#25490;&#24207;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#programmaticTransactions"><strong>5.6</strong><span>&#20107;&#21153;&#32534;&#31243;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#gormConstraints"><strong>5.7</strong><span>GORM&#19982;&#32422;&#26463;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#theWebLayer"><strong>6</strong><span>Web&#23618;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#controllers"><strong>6.1</strong><span>&#25511;&#21046;&#22120;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#understandingControllersAndActions"><strong>6.1.1</strong><span>&#29702;&#35299;&#25511;&#21046;&#22120;&#21644;&#25805;&#20316;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#controllersAndScopes"><strong>6.1.2</strong><span>&#25511;&#21046;&#22120;&#21644;&#20316;&#29992;&#22495;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#modelsAndViews"><strong>6.1.3</strong><span>&#27169;&#22411;&#21644;&#35270;&#22270;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#redirectsAndChaining"><strong>6.1.4</strong><span>&#37325;&#23450;&#21521;&#21644;&#38142;&#65288;Chaining&#65289;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#interceptors"><strong>6.1.5</strong><span>&#25511;&#21046;&#22120;&#25318;&#25130;&#22120;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#dataBinding"><strong>6.1.6</strong><span>&#25968;&#25454;&#32465;&#23450;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#xmlAndJSON"><strong>6.1.7</strong><span>XML&#21644;JSON&#21709;&#24212;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#moreOnJSONBuilder"><strong>6.1.8</strong><span>&#20851;&#20110;JSONBuilder</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#uploadingFiles"><strong>6.1.9</strong><span>&#19978;&#20256;&#25991;&#20214;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#commandObjects"><strong>6.1.10</strong><span>&#21629;&#20196;&#23545;&#35937;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#formtokens"><strong>6.1.11</strong><span>&#22788;&#29702;&#37325;&#22797;&#30340;&#34920;&#21333;&#25552;&#20132;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#typeConverters"><strong>6.1.12</strong><span>&#31616;&#21333;&#31867;&#22411;&#36716;&#25442;&#22120;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#asynchronousRequestProcessing"><strong>6.1.13</strong><span>&#24322;&#27493;&#35831;&#27714;&#22788;&#29702;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#gsp"><strong>6.2</strong><span>Groovy&#26381;&#21153;&#22120;&#39029;&#38754;(GSP)</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#GSPBasics"><strong>6.2.1</strong><span>GSP&#22522;&#30784;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#variablesAndScopes"><strong>6.2.1.1</strong><span>&#21464;&#37327;&#21644;&#20316;&#29992;&#22495;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#logicAndIteration"><strong>6.2.1.2</strong><span>&#36923;&#36753;&#21644;&#36845;&#20195;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#pageDirectives"><strong>6.2.1.3</strong><span>&#39029;&#38754;&#25351;&#20196;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#expressions"><strong>6.2.1.4</strong><span>&#34920;&#36798;&#24335;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#tags"><strong>6.2.2</strong><span>GSP&#26631;&#31614;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#tagVariablesAndScopes"><strong>6.2.2.1</strong><span>&#21464;&#37327;&#21644;&#20316;&#29992;&#22495;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#tagLogicAndIteration"><strong>6.2.2.2</strong><span>&#36923;&#36753;&#21644;&#36845;&#20195;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#searchAndFiltering"><strong>6.2.2.3</strong><span>&#25628;&#32034;&#21644;&#36807;&#28388;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#linksAndResources"><strong>6.2.2.4</strong><span>&#38142;&#25509;&#21644;&#36164;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#formsAndFields"><strong>6.2.2.5</strong><span>&#34920;&#21333;&#21644;&#23383;&#27573;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#tagsAsMethodCalls"><strong>6.2.2.6</strong><span>&#26631;&#31614;&#30340;&#26041;&#27861;&#35843;&#29992;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#viewsAndTemplates"><strong>6.2.3</strong><span>&#35270;&#22270;&#21644;&#27169;&#26495;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#layouts"><strong>6.2.4</strong><span>&#20351;&#29992;Sitemesh&#24067;&#23616;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#resources"><strong>6.2.5</strong><span>&#38745;&#24577;&#36164;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#includingResourcesUsingTheResourceTags"><strong>6.2.5.1</strong><span>&#36890;&#36807;&#36164;&#28304;&#26631;&#31614;&#24341;&#29992;&#36164;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#otherResourceTags"><strong>6.2.5.2</strong><span>&#20854;&#20182;&#36164;&#28304;&#26631;&#31614;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#declaringResources"><strong>6.2.5.3</strong><span>&#22768;&#26126;&#36164;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#overridingPluginResources"><strong>6.2.5.4</strong><span>&#35206;&#30422;&#25554;&#20214;&#36164;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#optimizingYourResources"><strong>6.2.5.5</strong><span>&#20248;&#21270;&#36164;&#28304;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#debugging"><strong>6.2.5.6</strong><span>&#35843;&#35797;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#preventingProcessingOfResources"><strong>6.2.5.7</strong><span>&#38459;&#27490;&#36164;&#28304;&#22788;&#29702;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#otherResourcesPlugins"><strong>6.2.5.8</strong><span>&#20854;&#20182;&#36164;&#28304;&#24863;&#30693;&#30340;&#25554;&#20214;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#sitemeshContentBlocks"><strong>6.2.6</strong><span>Sitemesh&#30340;&#20869;&#23481;&#22359;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#makingChangesToADeployedApplication"><strong>6.2.7</strong><span>&#20462;&#25913;&#24050;&#32463;&#37096;&#32626;&#30340;&#24212;&#29992;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#GSPDebugging"><strong>6.2.8</strong><span>GSP&#35843;&#35797;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#taglibs"><strong>6.3</strong><span>&#26631;&#31614;&#24211;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#taglibVariablesAndScopes"><strong>6.3.1</strong><span>&#21464;&#37327;&#21644;&#20316;&#29992;&#22495;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#simpleTags"><strong>6.3.2</strong><span>&#31616;&#21333;&#26631;&#31614;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#logicalTags"><strong>6.3.3</strong><span>&#36923;&#36753;&#26631;&#31614;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#iterativeTags"><strong>6.3.4</strong><span>&#36845;&#20195;&#26631;&#31614;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#namespaces"><strong>6.3.5</strong><span>&#26631;&#31614;&#21629;&#21517;&#31354;&#38388;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#usingJSPTagLibraries"><strong>6.3.6</strong><span>&#20351;&#29992;JSP&#26631;&#31614;&#24211;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#tagReturnValue"><strong>6.3.7</strong><span>&#26631;&#31614;&#30340;&#36820;&#22238;&#20540;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#urlmappings"><strong>6.4</strong><span>URL&#26144;&#23556;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mappingToControllersAndActions"><strong>6.4.1</strong><span>&#26144;&#23556;&#21040;&#25511;&#21046;&#22120;&#21644;&#25805;&#20316;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#embeddedVariables"><strong>6.4.2</strong><span>&#23884;&#20837;&#24335;&#21464;&#37327;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mappingToViews"><strong>6.4.3</strong><span>&#26144;&#23556;&#21040;&#35270;&#22270;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mappingToResponseCodes"><strong>6.4.4</strong><span>&#26144;&#23556;&#21040;&#21709;&#24212;&#20195;&#30721;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mappingHTTP"><strong>6.4.5</strong><span>&#26144;&#23556;&#21040;HTTP&#26041;&#27861;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mappingWildcards"><strong>6.4.6</strong><span>&#26144;&#23556;&#21040;&#36890;&#37197;&#31526;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#automaticLinkRewriting"><strong>6.4.7</strong><span>&#33258;&#21160;&#37325;&#20889;&#38142;&#25509;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#applyingConstraints"><strong>6.4.8</strong><span>&#24212;&#29992;&#32422;&#26463;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#namedMappings"><strong>6.4.9</strong><span>&#21629;&#21517;URL&#26144;&#23556;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#customizingUrlFormat"><strong>6.4.10</strong><span>&#33258;&#23450;&#20041;URL&#26684;&#24335;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#webflow"><strong>6.5</strong><span>Web&#24037;&#20316;&#27969;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#startAndEndStates"><strong>6.5.1</strong><span>&#24320;&#22987;&#21644;&#32467;&#26463;&#29366;&#24577;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#actionStatesAndViewStates"><strong>6.5.2</strong><span>&#25805;&#20316;&#29366;&#24577;&#21644;&#35270;&#22270;&#29366;&#24577;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#flowExecutionEvents"><strong>6.5.3</strong><span>&#24037;&#20316;&#27969;&#25191;&#34892;&#20107;&#20214;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#flowScopes"><strong>6.5.4</strong><span>&#24037;&#20316;&#27969;&#30340;&#20316;&#29992;&#22495;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#dataBindingAndValidation"><strong>6.5.5</strong><span>&#25968;&#25454;&#32465;&#23450;&#21644;&#39564;&#35777;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#subflowsAndConversations"><strong>6.5.6</strong><span>&#23376;&#27969;&#31243;&#21644;&#20250;&#35805;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#filters"><strong>6.6</strong><span>&#36807;&#28388;&#22120;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#applyingFilters"><strong>6.6.1</strong><span>&#24212;&#29992;&#36807;&#28388;&#22120;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#filterTypes"><strong>6.6.2</strong><span>&#36807;&#28388;&#22120;&#30340;&#31867;&#22411;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#filterVariablesAndScopes"><strong>6.6.3</strong><span>&#21464;&#37327;&#21644;&#20316;&#29992;&#22495;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#filterDependencies"><strong>6.6.4</strong><span>&#36807;&#28388;&#22120;&#20381;&#36182;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#ajax"><strong>6.7</strong><span>Ajax</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#ajaxSupport"><strong>6.7.1</strong><span>Ajax&#25903;&#25345;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#remotingLinking"><strong>6.7.1.1</strong><span>&#24322;&#27493;&#36229;&#38142;&#25509;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#updatingContent"><strong>6.7.1.2</strong><span>&#26356;&#26032;&#20869;&#23481;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#remoteFormSubmission"><strong>6.7.1.3</strong><span>&#24322;&#27493;Form&#25552;&#20132;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:30px"><a href="#ajaxEvents"><strong>6.7.1.4</strong><span>Ajax&#20107;&#20214;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#ajaxWithPrototype"><strong>6.7.2</strong><span>&#29992;Prototype&#23454;&#29616;Ajax</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#ajaxWithDojo"><strong>6.7.3</strong><span>&#29992;Dojo&#23454;&#29616;Ajax</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#ajaxWithGWT"><strong>6.7.4</strong><span>&#29992;GWT&#23454;&#29616;Ajax</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#ajaxOnTheServer"><strong>6.7.5</strong><span>&#26381;&#21153;&#31471;&#30340;Ajax</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#contentNegotiation"><strong>6.8</strong><span>&#20869;&#23481;&#21327;&#21830;</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#validation"><strong>7</strong><span>Validation</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#constraints"><strong>7.1</strong><span>Declaring Constraints</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#validatingConstraints"><strong>7.2</strong><span>Validating Constraints</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#validationOnTheClient"><strong>7.3</strong><span>Validation on the Client</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#validationAndInternationalization"><strong>7.4</strong><span>Validation and Internationalization</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#validationNonDomainAndCommandObjectClasses"><strong>7.5</strong><span>Validation Non Domain and Command Object Classes</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#services"><strong>8</strong><span>The Service Layer</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#declarativeTransactions"><strong>8.1</strong><span>Declarative Transactions</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#transactionsRollbackAndTheSession"><strong>8.1.1</strong><span>Transactions Rollback and the Session</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#scopedServices"><strong>8.2</strong><span>Scoped Services</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#dependencyInjectionServices"><strong>8.3</strong><span>Dependency Injection and Services</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#usingServicesFromJava"><strong>8.4</strong><span>Using Services from Java</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#testing"><strong>9</strong><span>Testing</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#unitTesting"><strong>9.1</strong><span>Unit Testing</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#unitTestingControllers"><strong>9.1.1</strong><span>Unit Testing Controllers</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#unitTestingTagLibraries"><strong>9.1.2</strong><span>Unit Testing Tag Libraries</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#unitTestingDomains"><strong>9.1.3</strong><span>Unit Testing Domains</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#unitTestingFilters"><strong>9.1.4</strong><span>Unit Testing Filters</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#unitTestingURLMappings"><strong>9.1.5</strong><span>Unit Testing URL Mappings</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#mockingCollaborators"><strong>9.1.6</strong><span>Mocking Collaborators</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#integrationTesting"><strong>9.2</strong><span>Integration Testing</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#functionalTesting"><strong>9.3</strong><span>Functional Testing</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#i18n"><strong>10</strong><span>Internationalization</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#understandingMessageBundles"><strong>10.1</strong><span>Understanding Message Bundles</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#changingLocales"><strong>10.2</strong><span>Changing Locales</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#readingMessages"><strong>10.3</strong><span>Reading Messages</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#scaffoldingAndI18n"><strong>10.4</strong><span>Scaffolding and i18n</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#security"><strong>11</strong><span>Security</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#securingAgainstAttacks"><strong>11.1</strong><span>Securing Against Attacks</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#codecs"><strong>11.2</strong><span>Encoding and Decoding Objects</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#authentication"><strong>11.3</strong><span>Authentication</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#securityPlugins"><strong>11.4</strong><span>Security Plugins</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#springSecurity"><strong>11.4.1</strong><span>Spring Security</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#shiro"><strong>11.4.2</strong><span>Shiro</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#plugins"><strong>12</strong><span>Plugins</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#creatingAndInstallingPlugins"><strong>12.1</strong><span>Creating and Installing Plugins</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#repositories"><strong>12.2</strong><span>Plugin Repositories</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#understandingPluginStructure"><strong>12.3</strong><span>Understanding a Plugin's Structure</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#providingBasicArtefacts"><strong>12.4</strong><span>Providing Basic Artefacts</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#evaluatingConventions"><strong>12.5</strong><span>Evaluating Conventions</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#hookingIntoBuildEvents"><strong>12.6</strong><span>Hooking into Build Events</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#hookingIntoRuntimeConfiguration"><strong>12.7</strong><span>Hooking into Runtime Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#addingDynamicMethodsAtRuntime"><strong>12.8</strong><span>Adding Dynamic Methods at Runtime</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#participatingInAutoReloadEvents"><strong>12.9</strong><span>Participating in Auto Reload Events</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#understandingPluginLoadOrder"><strong>12.10</strong><span>Understanding Plugin Load Order</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#artefactApi"><strong>12.11</strong><span>The Artefact API</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#queryingArtefacts"><strong>12.11.1</strong><span>Asking About Available Artefacts</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#customArtefacts"><strong>12.11.2</strong><span>Adding Your Own Artefact Types</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#binaryPlugins"><strong>12.12</strong><span>Binary Plugins</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#webServices"><strong>13</strong><span>Web Services</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#REST"><strong>13.1</strong><span>REST</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#SOAP"><strong>13.2</strong><span>SOAP</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#RSSAndAtom"><strong>13.3</strong><span>RSS and Atom</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#spring"><strong>14</strong><span>Grails and Spring</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#theUnderpinningsOfGrails"><strong>14.1</strong><span>The Underpinnings of Grails</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#springdslAdditional"><strong>14.2</strong><span>Configuring Additional Beans</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#springdsl"><strong>14.3</strong><span>Runtime Spring with the Beans DSL</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#theBeanBuilderDSLExplained"><strong>14.4</strong><span>The BeanBuilder DSL Explained</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#propertyPlaceholderConfiguration"><strong>14.5</strong><span>Property Placeholder Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#propertyOverrideConfiguration"><strong>14.6</strong><span>Property Override Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#hibernate"><strong>15</strong><span>Grails and Hibernate</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#usingHibernateXMLMappingFiles"><strong>15.1</strong><span>Using Hibernate XML Mapping Files</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#mappingWithHibernateAnnotations"><strong>15.2</strong><span>Mapping with Hibernate Annotations</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#addingConstraints"><strong>15.3</strong><span>Adding Constraints</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#scaffolding"><strong>16</strong><span>Scaffolding</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#deployment"><strong>17</strong><span>Deployment</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#contributing"><strong>18</strong><span>Contributing to Grails</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#issues"><strong>18.1</strong><span>Report Issues in JIRA</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#build"><strong>18.2</strong><span>Build From Source and Run Tests</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#patchesCore"><strong>18.3</strong><span>Submit Patches to Grails Core</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#patchesDoc"><strong>18.4</strong><span>Submit Patches to Grails Documentation</span></a></div>
                            
                            <div style="clear:both" ></div>
                        </div>
                        
                        
<a name="1. Introduction"><!-- Legacy link --></a>
<h1 id="introduction">1 简介</h1>
如今的Java Web开发对于需求来说已经变得过于复杂。当今众多Java领域的Web开发框架不仅使用复杂，而且并没有很好的遵循Don't Repeat Yourself（DRY）原则。<p class="paragraph"/>像Rails，Django和TurboGears这样的动态框架在Web开发领域开辟了一条新的道路，Grails基于这些概念之上，采用动态方法减小了Java平台上进行Web开发的复杂度，不过与那些框架不同的是，Grails是构建在Spring和Hibernate等Java已有的技术之上的。<p class="paragraph"/>Grails是一个full-stack框架，它借助于核心技术与相关的插件（plug-in）来解决Web开发中方方面面的问题，其中包括：
<ul class="star">
<li>易于使用的基于<a href="http://www.hibernate.org" target="blank">Hibernate</a>的对象-关系映射(ORM)层</li>
<li>称为Groovy Server Pages (GSP)的表现层技术</li>
<li>基于<a href="http://www.springframework.org" target="blank">Spring</a> MVC的控制器层</li>
<li>构建于<a href="http://groovy.codehaus.org/Gant" target="blank">Gant</a> 上的命令行脚本运行环境</li>
<li>内置<a href="http://tomcat.apache.org服务器，不用重新启动服务器就可以进行重新加载" target="blank">Tomcat</a></li>
<li>利用内置的Spring 容器实现依赖注入</li>
<li>基于Spring的MessageSource核心概念，提供了对国际化（i18n）的支持</li>
<li>基于Spring事务抽象概念，实现事务服务层</li>
</ul><p class="paragraph"/>借助于功能强大的Groovy动态语言和领域特定语言（Domain Specific Language，DSL），以上那些特性变得非常易用。<p class="paragraph"/>这篇文档会向你介绍如何使用Grails框架来搭建Web应用程序。<p class="paragraph"/><div class="hidden-block"><p class="paragraph"/>Java web development as it stands today is dramatically more complicated than it needs to be. Most modern web frameworks in the Java space are over complicated and don't embrace the Don't Repeat Yourself (DRY) principles.<p class="paragraph"/>Dynamic frameworks like Rails, Django and TurboGears helped pave the way to a more modern way of thinking about web applications. Grails builds on these concepts and dramatically reduces the complexity of building web applications on the Java platform. What makes it different, however, is that it does so by building on already established Java technologies like Spring and Hibernate.<p class="paragraph"/>Grails is a full stack framework and attempts to solve as many pieces of the web development puzzle through the core technology and its associated plugins. Included out the box are things like:
<ul class="star">
<li>An easy to use Object Relational Mapping (ORM) layer built on <a href="http://www.hibernate.org" target="blank">Hibernate</a></li>
<li>An expressive view technology called Groovy Server Pages (GSP)</li>
<li>A controller layer built on <a href="http://www.springframework.org" target="blank">Spring</a> MVC</li>
<li>A command line scripting environment built on the Groovy-powered <a href="http://groovy.codehaus.org/Gant" target="blank">Gant</a></li>
<li>An embedded <a href="http://tomcat.apache.org" target="blank">Tomcat</a> container which is configured for on the fly reloading</li>
<li>Dependency injection with the inbuilt Spring container</li>
<li>Support for internationalization (i18n) built on Spring's core MessageSource concept</li>
<li>A transactional service layer built on Spring's transaction abstraction</li>
</ul><p class="paragraph"/>All of these are made easy to use through the power of the <a href="http://groovy.codehaus.org" target="blank">Groovy</a> language and the extensive use of Domain Specific Languages​​ (DSLs)<p class="paragraph"/>This documentation will take you through getting started with Grails and building web applications with the Grails framework.<p class="paragraph"/></div>

<a name="1.1 What's new in Grails 2.0?"><!-- Legacy link --></a>
<h2 id="whatsNew">1.1 Grails 2.0有那些新特性?</h2>
<div class="hidden-block">
This section covers the new features that are present in 2.0 and is broken down into sections covering the build system, core APIs, the web tier, persistence enhancements and improvements in testing. Note there are many more small enhancements and improvements, these sections just cover some of the highlights.
</div><p class="paragraph"/>在本章节中，主要涉及当前2.0中的新特性，这些又被细分为系统构建、核心API、WEB层、持久层的增强以及在测试方面的改进。值得一提的是，虽然还有其他更多少范围的增强和改进，但在本章后续的章节中只会将其中的一些亮点进行介绍。


<a name="1.1.1 Development Environment Features"><!-- Legacy link --></a>
<h2 id="developmentEnvironmentFeatures">1.1.1 面向开发的特性</h2>
<div class="hidden-block">
<h4>Interactive Mode and Console Enhancements</h4><p class="paragraph"/>Grails 2.0 features brand new console output that is more concise and user friendly to consume. An example of the new output when running tests can be seen below:<p class="paragraph"/><img border="0" class="center" src="../../img/test-output.png"></img><p class="paragraph"/>In general Grails makes its best effort to display update information on a single line and only present the information that is crucial. This means that while in previous versions of Grails the <a href="../ref/Command Line/war.html" class="commandLine">war</a> command produced many lines of output, in Grails 2.0 only 1 line of output is produced:<p class="paragraph"/><img border="0" class="center" src="../../img/war-output.png"></img><p class="paragraph"/>In addition simply typing 'grails' at the command line activates the new interactive mode which features TAB completion, command history and keeps the JVM running to ensure commands execute much quicker than otherwise<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-output.png"></img><p class="paragraph"/>For more information on the new features of the console refer to the section of the user guide that covers the <a href="../guide/single.html#interactiveMode" class="guide">console and interactive mode</a>.
</div><p class="paragraph"/><h4>交互模式和命令行的增强</h4><p class="paragraph"/>Grails 2.0中新的命令行输出将更加简洁和友好，以执行测试为例，新的输出如下图所示：<p class="paragraph"/><img border="0" class="center" src="../../img/test-output.png"></img><p class="paragraph"/>总的来说，Grails尽量在一行中显示所有相关的更新信息，并且仅仅显示当前最重要的信息，换句话说，以前版本的<a href="../ref/Command Line/war.html" class="commandLine">war</a>命令将产生很多行的输出，但是在2.0中，只有如下图所示的一行输出。<p class="paragraph"/><img border="0" class="center" src="../../img/war-output.png"></img><p class="paragraph"/>此外如果只是简单的输入'grails'命令，系统将进入新的带TAB补全和纪录命令历史的交互模式。在此模式下，JVM一直保持运行，这样就可以保证命令的执行可以比其他情况快速。新的交互模式如下图所示：<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-output.png"></img><p class="paragraph"/>更多命令行新特性请参考本用户手册的<a href="../guide/single.html#interactiveMode" class="guide">命令行和交互模式</a>章节。<p class="paragraph"/><div class="hidden-block">
<h4>Reloading Agent</h4><p class="paragraph"/>Grails 2.0 reloading mechanism no longer uses class loaders, but instead uses a JVM agent to reload changes to class files. This results in greatly improved reliability when reloading changes and also ensures that the class files stored in disk remain consistent with the class files loaded in memory, which reduces the need to run the <a href="../ref/Command Line/clean.html" class="commandLine">clean</a> command.
</div><p class="paragraph"/><h4>重新加载代理</h4><p class="paragraph"/>Grails 2.0的重新加载机制不再使用用户的类加载器(Class Loaders)，而是使用JVM代理来重新加载那些改变过的类.这样一来，既能提高系统的稳定性，也可以保证磁盘和内存中的类的一致性，从而可以减少执行<a href="../ref/Command Line/clean.html" class="commandLine">clean</a>的次数。<p class="paragraph"/><div class="hidden-block">
<h4>New Test Report and Documentation Templates</h4><p class="paragraph"/>There are new templates for displaying test results that are clearer and more user friendly than the previous reports:<p class="paragraph"/><img border="0" class="center" src="../../img/test-template.png"></img><p class="paragraph"/>In addition, the Grails documentation engine has received a facelift with a new template for presenting Grails application and plugin documentation:<p class="paragraph"/><img border="0" class="center" src="../../img/doc-template.png"></img><p class="paragraph"/>See the section on the <a href="../guide/single.html#docengine" class="guide">documentation engine</a> for more usage info.
</div><p class="paragraph"/><h4>全新的测试报告和文档模板</h4><p class="paragraph"/>相比以前的测试报告，现在的测试结果显示更加简洁清晰和友好，新的报告截图如下：<p class="paragraph"/><img border="0" class="center" src="../../img/test-template.png"></img><p class="paragraph"/>除此之外，Grails的文档引擎也采用了全新的模板来展现其插件和应用的文档，如下图所示：<p class="paragraph"/><img border="0" class="center" src="../../img/doc-template.png"></img><p class="paragraph"/>更多信息请参考<a href="../guide/single.html#docengine" class="guide">文档引擎</a>章节。<p class="paragraph"/><div class="hidden-block">
<h4>Use a TOC for Project Docs</h4><p class="paragraph"/>The old documentation engine relied on you putting section numbers into the gdoc filenames. Although convenient, this effectively made it difficult to restructure your user guide by inserting new chapters and sections. In addition, any such restructuring or renaming of section titles resulted in breaking changes to the URLs.<p class="paragraph"/>You can now use logical names for your gdoc files and define the structure and section titles in a YAML table-of-contents file, as described in the section on the <a href="../guide/single.html#docengine" class="guide">documentation engine</a>. The logical names appear in the URLs, so as long as you don't change those, your URLs will always remain the same no matter how much restructuring or changing of titles you do.<p class="paragraph"/>Grails 2.0 even provides a <a href="../ref/Command Line/migrate-docs.html" class="commandLine">migrate-docs</a> command to aid you in migrating existing gdoc user guides.
</div><p class="paragraph"/><h4>在项目文档中使用目录索引(TOC-Table Of Contents)</h4><p class="paragraph"/>旧有的文档引擎将章节号写死在gdoc文件中，此举虽然便利，但是会导致在新增章节的时候很难重新构造你的用户手册，而且任何章节标题的改动，将会导致此章节的URL失效.（在处理多国语言的时候尤其不便－译者注）<p class="paragraph"/>现在，你可以将结构和章节的标题的逻辑名称定义在YAML目录索引（TOC，在<a href="../guide/single.html#docengine" class="guide">文档引擎</a>有更多描述）文件中，这样在你的gdoc文件中只需使用相应的逻辑名称即可。如此一来，不管你改了结构或者标题，只要你在URL中的逻辑名称没有改变，那么你URL将不会受任何影响。<p class="paragraph"/>对已有的gdoc用户手册，Grails 2.0还提供了<a href="../ref/Command Line/migrate-docs.html" class="commandLine">migrate-docs</a>命令来帮助你进行迁移。<p class="paragraph"/><div class="hidden-block">
<h4>Enhanced Error Reporting and Diagnosis</h4><p class="paragraph"/>Error reporting and problem diagnosis has been greatly improved with a new errors view that analyses stack traces and recursively displays problem areas in your code:<p class="paragraph"/><img border="0" class="center" src="../../img/errors-view.png"></img><p class="paragraph"/>In addition stack trace filtering has been further enhanced to display only relevant trace information:<p class="paragraph"/><div class="code"><pre>Line | Method
&#45;&#62;&#62;   9 | getValue     in Book.groovy
&#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45;
|     7 | getBookValue in BookService.groovy
|   886 | runTask . .  in ThreadPoolExecutor.java
|   908 | run          in     ''
^   662 | run . . . .  in <span class="java&#45;object">Thread</span>.java</pre></div>
</div><p class="paragraph"/><h4>错误报告和诊断的增强</h4><p class="paragraph"/>错误报告和问题诊断现在得到了极大的提高，在新的错误视图中，系统分析堆栈的异常，并且在你的代码中递归的显示问题区域。如下图所示：<p class="paragraph"/><img border="0" class="center" src="../../img/errors-view.png"></img><p class="paragraph"/>此外，加强的异常堆栈跟踪过滤，只显示相关的异常跟踪信息，如下边代码所示：<p class="paragraph"/><div class="code"><pre>Line | Method
&#45;&#62;&#62;   9 | getValue     in Book.groovy
&#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45; &#45;
|     7 | getBookValue in BookService.groovy
|   886 | runTask . .  in ThreadPoolExecutor.java
|   908 | run          in     ''
^   662 | run . . . .  in <span class="java&#45;object">Thread</span>.java</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>H2 Database and Console</h4><p class="paragraph"/>Grails 2.0 now uses the H2 database instead of HSQLDB, and enables the H2 database console in development mode (at the URI /dbconsole) so that the in-memory database can be easily queried from the browser:<p class="paragraph"/><img border="0" class="center" src="../../img/h2-console.png"></img>
</div><p class="paragraph"/><h4>H2数据库及其管理界面</h4><p class="paragraph"/>在Grails 2.0中，已经舍弃了HSQLDB，取而代之的是H2数据库，并且在开发模式下，还增加了数据库管理界面（通过URI /dbconsole访问），这样即使数据库在内存模式下，也可以通过浏览器来查询，管理界面如下：<p class="paragraph"/><img border="0" class="center" src="../../img/h2-console.png"></img><p class="paragraph"/><div class="hidden-block">
<h4>Plugin Usage Tracking</h4><p class="paragraph"/>To enhance community awareness of the most popular plugins an opt-in plugin usage tracking system has been included where users can participate in providing feedback to the plugin community on which plugins are most popular.<p class="paragraph"/>This will help drive the roadmap and increase support of key plugins while reducing the need to support older or less popular plugins thus helping plugin development teams focus their efforts.
</div><p class="paragraph"/><h4>跟踪插件的使用情况</h4><p class="paragraph"/>为了增强社区对最受欢迎插件的意识，一种称之为“单向确认(opt-in)”的跟踪插件使用情况系统被引入，这样用户可以将那些是最受欢迎的插件反馈给插件社区。<p class="paragraph"/>这有助于推动系统的线路图和增加对重要插件的支持，同时对那些陈旧或者不受欢迎的减插件少不必要的支持，从而帮助插件开发团队做更多有意义的事情。<p class="paragraph"/><div class="hidden-block">
<h4>Dependency Resolution Improvements</h4><p class="paragraph"/>There are numerous improvements to dependency resolution handling via Ivy including:
<ul class="star">
<li>Grails now makes a best effort to cache the previous resolve and avoid resolving again unless you change <code>BuildConfig.groovy</code>.</li>
<li>Plugins dependencies now appear in the dependency report generated by <code>grails dependency-report</code></li>
<li>Plugins published with the release plugin now publish their transitive plugin dependencies in the generated POM which are later resolved.</li>
<li>It is now possible to customize the ivy cache directory via <code>BuildConfig.groovy</code></li>
</ul><p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    cacheDir <span class="java&#45;quote">"target/ivy&#45;cache"</span>
&#125;</pre></div>
<ul class="star">
<li>You can change the ivy cache directory for all projects via <code>settings.groovy</code></li>
</ul><p class="paragraph"/><div class="code"><pre>grails.dependency.cache.dir = <span class="java&#45;quote">"$&#123;userHome&#125;/.ivy2/cache"</span></pre></div>
<ul class="star">
<li>It is now possible to completely disable resolution from inherited repositories (repositories defined by other plugins):</li>
</ul><p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;<p class="paragraph"/>    repositories &#123;
        inherits <span class="java&#45;keyword">false</span> // Whether to inherit repository definitions from plugins
        &#8230;
    &#125;
    &#8230;
&#125;</pre></div>
<ul class="star">
<li>It is now possible to easily disable checksum validation errors:</li>
</ul><p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    checksums <span class="java&#45;keyword">false</span> // whether to verify checksums or not
&#125;</pre></div>
</div><p class="paragraph"/><h4>依赖解决方案的增强</h4><p class="paragraph"/>在解决依赖问题方面，因为Ivy的协助，有了大量的改进：
<ul class="star">
<li>在不改变<code>BuildConfig.groovy</code>的前提下，Grails将尽量使用以前的缓存，从而避免了再解析检查。</li>
<li>通过<code>grails dependency-report</code>，现在可以生成插件的依赖关系报告。</li>
<li>通过release plugin发布的插件现在可以将其依赖关系的传递性生成在POM中，以备后用。</li>
<li>通过<code>BuildConfig.groovy</code>，现在可以自定义ivy的缓存目录了，代码如下：</li>
</ul><p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    cacheDir <span class="java&#45;quote">"target/ivy&#45;cache"</span>
&#125;</pre></div>
<ul class="star">
<li>通过修改 <code>settings.groovy</code> 配置来改变所有工程的ivy缓存目录，比如：</li>
</ul><p class="paragraph"/><div class="code"><pre>grails.dependency.cache.dir = <span class="java&#45;quote">"$&#123;userHome&#125;/.ivy2/cache"</span></pre></div>
<ul class="star">
<li>在继承过来的存储仓库（定义在别的插件中）中，现在可以完全使继承过来的失效，代码如下：</li>
</ul><p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;<p class="paragraph"/>    repositories &#123;
        inherits <span class="java&#45;keyword">false</span> // Whether to inherit repository definitions from plugins
        &#8230;
    &#125;
    &#8230;
&#125;</pre></div>
<ul class="star">
<li>可以方便的解决因为校验和导致的验证错误，代码如下：</li>
</ul><p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    checksums <span class="java&#45;keyword">false</span> // whether to verify checksums or not
&#125;</pre></div>


<a name="1.1.2 Core Features"><!-- Legacy link --></a>
<h2 id="coreFeatures">1.1.2 核心特性</h2>
<div class="hidden-block">
<h4>Binary Plugins</h4><p class="paragraph"/>Grails plugins can now be packaged as JAR files and published to standard maven repositories. This even works for GSP and static resources (with resources plugin 1.0.1). See the section on <a href="../guide/single.html#binaryPlugins" class="guide">Binary plugins</a> for more information.
</div><p class="paragraph"/><h4>二进制插件</h4><p class="paragraph"/>在Grails 2.0中插件可以被打包为JAR文件，并且可以发布到标准的maven存储空间, 此外还可以通过resources插件(1.0.1版本)将GSP和静态资源进行处理。更多细节请参考<a href="../guide/single.html#binaryPlugins" class="guide">二进制插件</a>章节。<p class="paragraph"/><div class="hidden-block">
<h4>Groovy 1.8</h4><p class="paragraph"/>Grails 2.0 comes with Groovy 1.8 which includes many new <a href="http://docs.codehaus.org/display/GROOVY/Groovy+1.8+release+notes" target="blank">features and enhancements</a>
</div><p class="paragraph"/><h4>Groovy 1.8</h4><p class="paragraph"/>Grails 2.0使用了Groovy 1.8中很多的<a href="http://docs.codehaus.org/display/GROOVY/Groovy+1.8+release+notes" target="blank">新特性和增强</a><p class="paragraph"/><div class="hidden-block">
<h4>Spring 3.1 Profile Support</h4><p class="paragraph"/>Grails' existing environment support has been bridged into the Spring 3.1 profile support. For example when running with a custom Grails environment called "production", a Spring profile of "production" is activated so that you can use Spring's bean configuration APIs to configure beans for a specific profile.
</div><p class="paragraph"/><h4>支持Spring 3.1的个性配置(Profile)</h4><p class="paragraph"/>Grails原来所支持的环境配置现在已经通过Spring 3.1的Profile来实现了，比如要执行一个自定义的"production"环境,那么Spring的"production"Profile将被激活，这样你就可以通过Spring的bean配置API来操作了。


<a name="1.1.3 Web Features"><!-- Legacy link --></a>
<h2 id="webFeatures">1.1.3 Web层特性</h2>
<div class="hidden-block">
<h4>Controller Actions as Methods</h4><p class="paragraph"/>It is now possible to define controller actions as methods instead of using closures as in previous versions of Grails. In fact this is now the preferred way of expressing an action. For example:<p class="paragraph"/><div class="code"><pre>// action as a method
def index() &#123;<p class="paragraph"/>&#125;
// action as a closure
def index = &#123;<p class="paragraph"/>&#125;</pre></div>
</div><p class="paragraph"/><h4>使用函数方法来定义控制器的动作</h4><p class="paragraph"/>以前Grails的动作只能通过闭包来定义，现在通过一般的函数方法也可以定义了，实际上这也是优先推荐的方式，比如：<p class="paragraph"/><div class="code"><pre>// action as a method
def index() &#123;<p class="paragraph"/>&#125;
// action as a closure
def index = &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Binding Primitive Method Action Arguments</h4><p class="paragraph"/>It is now possible to bind form parameters to action arguments where the name of the form element matches the argument name. For example given the following form:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form name=<span class="xml&#45;quote">"myForm"</span> action=<span class="xml&#45;quote">"save"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;input name=<span class="xml&#45;quote">"name"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;input name=<span class="xml&#45;quote">"age"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/g:form&#62;</span></pre></div><p class="paragraph"/>You can define an action that declares arguments for each input and automatically converts the parameters to the appropriate type:<p class="paragraph"/><div class="code"><pre>def save(<span class="java&#45;object">String</span> name, <span class="java&#45;object">int</span> age) &#123;
    // remaining
&#125;</pre></div>
</div><p class="paragraph"/><h4>自动绑定带参数的动作方法</h4><p class="paragraph"/>现在可以将表单（form）参数跟动作参数进行自动匹配了，只要表单下边子元素的名称名字跟参数名称一致即可，以如下的表单为例：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form name=<span class="xml&#45;quote">"myForm"</span> action=<span class="xml&#45;quote">"save"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;input name=<span class="xml&#45;quote">"name"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;input name=<span class="xml&#45;quote">"age"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/g:form&#62;</span></pre></div><p class="paragraph"/>你可以定义其动作参数为每一个输入元素的名字，系统会自动将参数值转换为其响应的类型，如以下代码所示：<p class="paragraph"/><div class="code"><pre>def save(<span class="java&#45;object">String</span> name, <span class="java&#45;object">int</span> age) &#123;
    // remaining
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Static Resource Abstraction</h4><p class="paragraph"/>A new <a href="../guide/single.html#resources" class="guide">static resource abstraction</a> is included that allows declarative handling of JavaScript, CSS and image resources including automatic ordering, compression, caching and gzip handling.
</div><p class="paragraph"/><h4>静态资源</h4><p class="paragraph"/>新引入的<a href="../guide/single.html#resources" class="guide">静态资源</a>抽象，可以声明式地处理JavaScript、CSS以及图像资源的自动排序、压缩、缓存.<p class="paragraph"/><div class="hidden-block">
<h4>Servlet 3.0 Async Features</h4><p class="paragraph"/>Grails now supports Servlet 3.0 including the Asynchronous programming model defined by the specification:<p class="paragraph"/><div class="code"><pre>def index() &#123;
    def ctx = startAsync()
    ctx.start &#123;
        <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Stand"</span>).save()
        render template:<span class="java&#45;quote">"books"</span>, model:&#91;books:Book.list()&#93;
        ctx.complete()
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>Servlet 3.0 的异步特性</h4><p class="paragraph"/>Grails现在已经支持Servlet 3.0了，且包含了其规范中定义的异步编程模型，比如：<p class="paragraph"/><div class="code"><pre>def index() &#123;
    def ctx = startAsync()
    ctx.start &#123;
        <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Stand"</span>).save()
        render template:<span class="java&#45;quote">"books"</span>, model:&#91;books:Book.list()&#93;
        ctx.complete()
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Link Generation API</h4><p class="paragraph"/>A general purpose <code>LinkGenerator</code> class is now available that is usable anywhere within a Grails application and not just within the context of a controller. For example if you need to generate links in a service or an asynchronous background job outside the scope of a request:<p class="paragraph"/><div class="code"><pre>LinkGenerator grailsLinkGenerator<p class="paragraph"/>def generateLink() &#123;
    grailsLinkGenerator.link(controller:<span class="java&#45;quote">"book"</span>, action:<span class="java&#45;quote">"list"</span>)
&#125;</pre></div>
</div><p class="paragraph"/><h4>生成超链接的API</h4><p class="paragraph"/>在Grails应用，新增的通用<code>LinkGenerator</code>类，可以在任何地方生成超链接了，不像以前，只能局限于控制器的上下文中。比如，你要在一个服务或者异步的后台任务等超出web请求范围内使用，可以参考如下代码：<p class="paragraph"/><div class="code"><pre>LinkGenerator grailsLinkGenerator<p class="paragraph"/>def generateLink() &#123;
    grailsLinkGenerator.link(controller:<span class="java&#45;quote">"book"</span>, action:<span class="java&#45;quote">"list"</span>)
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Page Rendering API</h4><p class="paragraph"/>Like the <code>LinkGenerator</code> the new <code>PageRenderer</code> can be used to render GSP pages outside the scope of a web request, such as in a scheduled job or web service. The <code>PageRenderer</code> class features a very similar API to the <code>render</code> method found within controllers:<p class="paragraph"/><div class="code"><pre>grails.gsp.PageRenderer groovyPageRenderer<p class="paragraph"/>void welcomeUser(User user) &#123;
    def contents = groovyPageRenderer.render(view:<span class="java&#45;quote">"/emails/welcomeLetter"</span>, model:&#91;user: user&#93;)
    sendEmail &#123;
        to user.email
        body contents
    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>PageRenderer</code> service also allows you to pre-process GSPs into HTML templates:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/path/to/welcome.html"</span>).withWriter &#123; w &#45;&#62;
    groovyPageRenderer.renderTo(view:<span class="java&#45;quote">"/page/content"</span>, w)
&#125;</pre></div>
</div><p class="paragraph"/><h4>页面渲染API</h4><p class="paragraph"/>跟<code>LinkGenerator</code>类似，新增的<code>PageRenderer</code>能够在超出web请求范围之外的任何地方渲染GSP页面，比如被调度的任务或者WEB服务接口中。<code>PageRenderer</code> 类的API跟在控制器中使用的<code>render</code>方法很类似，比如：<p class="paragraph"/><div class="code"><pre>grails.gsp.PageRenderer groovyPageRenderer<p class="paragraph"/>void welcomeUser(User user) &#123;
    def contents = groovyPageRenderer.render(view:<span class="java&#45;quote">"/emails/welcomeLetter"</span>, model:&#91;user: user&#93;)
    sendEmail &#123;
        to user.email
        body contents
    &#125;
&#125;</pre></div><p class="paragraph"/><code>PageRenderer</code>服务还允许你将GSP页面预处理成为HTML模板：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/path/to/welcome.html"</span>).withWriter &#123; w &#45;&#62;
    groovyPageRenderer.renderTo(view:<span class="java&#45;quote">"/page/content"</span>, w)
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Filter Exclusions</h4><p class="paragraph"/>Filters may now express controller, action and uri exclusions to offer more options for expressing to which requests a particular filter should be applied.<p class="paragraph"/><div class="code"><pre>filter1(actionExclude: 'log&#42;') &#123;
    before = &#123;
        // …
    &#125;
&#125;
filter2(controllerExclude: 'auth') &#123;
    before = &#123;
        // …
    &#125;
&#125;<p class="paragraph"/>filter3(uriExclude: '/secure&#42;') &#123;
    before = &#123;
        // …
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>过滤器的排除</h4><p class="paragraph"/>过滤器现在可以明确的指定是排除控制器、动作、还是URI，这为特定请求的过滤器提供了更多选项。<p class="paragraph"/><div class="code"><pre>filter1(actionExclude: 'log&#42;') &#123;
    before = &#123;
        // …
    &#125;
&#125;
filter2(controllerExclude: 'auth') &#123;
    before = &#123;
        // …
    &#125;
&#125;<p class="paragraph"/>filter3(uriExclude: '/secure&#42;') &#123;
    before = &#123;
        // …
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Performance Improvements</h4><p class="paragraph"/>Performance of GSP page rendering has once again been improved by optimizing the GSP compiler to inline method calls where possible.
</div><p class="paragraph"/><h4>性能的提升</h4><p class="paragraph"/>通过将GSP编译器优化成内联方法，使得GSP的页面渲染性能又一次得到提升。<p class="paragraph"/><div class="hidden-block">
<h4>HTML5 Scaffolding</h4><p class="paragraph"/>There is a new HTML5-based scaffolding UI:<p class="paragraph"/><img border="0" class="center" src="../../img/scaffolding-ui.png"></img><p class="paragraph"/></div><p class="paragraph"/><h4>HTML5脚手架</h4><p class="paragraph"/>新增的基于HTML5的脚手架界面如下：<p class="paragraph"/><img border="0" class="center" src="../../img/scaffolding-ui.png"></img><p class="paragraph"/>
<div class="hidden-block">
<h4>jQuery by Default</h4><p class="paragraph"/>The jQuery plugin is now the default JavaScript library installed into a Grails application. For backwards compatibility a <a href="http://grails.org/plugin/prototype" target="blank">Prototype plugin</a> is available. Refer to the <a href="http://grails.org/plugin/prototype" target="blank">documentation</a> on the Prototype plugin for installation instructions.<p class="paragraph"/></div><p class="paragraph"/><h4>jQuery作为缺省JavaScript库</h4><p class="paragraph"/>jQuery插件已经作为一个缺省的JavaScript库被安装到Grails应用当中。因为向后兼容的原因，<a href="http://grails.org/plugin/prototype" target="blank">Prototype插件</a>依然是有效的，其安装指令请参考<a href="http://grails.org/plugin/prototype" target="blank">Prototype插件官方文档</a>。<p class="paragraph"/><div class="hidden-block">
<h4>Easy Date Parsing</h4><p class="paragraph"/>A new <code>date</code> method has been added to the <code>params</code> object to allow easy, null-safe parsing of dates:<p class="paragraph"/><div class="code"><pre>def val = params.date('myDate', 'dd&#45;MM&#45;yyyy')<p class="paragraph"/>// or a list <span class="java&#45;keyword">for</span> formats
def val = params.date('myDate', &#91;'yyyy&#45;MM&#45;dd', 'yyyyMMdd', 'yyMMdd'&#93;)<p class="paragraph"/>// or the format read from messages.properties via the key 'date.myDate.format'
def val = params.date('myDate')</pre></div>
</div><p class="paragraph"/><h4>易用的日期解析</h4><p class="paragraph"/><code>params</code>对象新增了一个<code>date</code>方法，用以轻松地、空指针安全地解析日期，比如：<p class="paragraph"/><div class="code"><pre>def val = params.date('myDate', 'dd&#45;MM&#45;yyyy')<p class="paragraph"/>// or a list <span class="java&#45;keyword">for</span> formats
def val = params.date('myDate', &#91;'yyyy&#45;MM&#45;dd', 'yyyyMMdd', 'yyMMdd'&#93;)<p class="paragraph"/>// or the format read from messages.properties via the key 'date.myDate.format'
def val = params.date('myDate')</pre></div>


<a name="1.1.4 Persistence Features"><!-- Legacy link --></a>
<h2 id="persistenceFeatures">1.1.4 持久层特性</h2>
<div class="hidden-block">
<h4>The GORM API</h4><p class="paragraph"/>The GORM API has been formalized into a set of classes (<code>GormStaticApi</code>, <code>GormInstanceApi</code> and <code>GormValidationApi</code>) that get statically wired into every domain class at the byte code level. The result is better code completion for IDEs, better integration with Java and the potential for more GORM implementations for other types of data stores.
</div><p class="paragraph"/><h4>GORM API</h4><p class="paragraph"/>GORM API现在已正式规范为类的集合（<code>GormStaticApi</code>, <code>GormInstanceApi</code>, <code>GormValidationApi</code>），并且在每个领域类的字节码级别上进行注入的。如此一来，对IDE的代码补齐，Java的集成，以及潜在的其他类型的GORM实现来说，提供了更好的支持。<p class="paragraph"/><div class="hidden-block">
<h4>New findOrCreate and findOrSave Methods</h4><p class="paragraph"/>Domain classes have support for the findOrCreateWhere, findOrSaveWhere, findOrCreateBy and findOrSaveBy query methods which behave just like findWhere and findBy methods except that they should never return null. If a matching instance cannot be found in the database then a new instance is created, populated with values represented in the query parameters and returned. In the case of findOrSaveWhere and findOrSaveBy, the instance is saved before being returned.<p class="paragraph"/><div class="code"><pre>def book = Book.findOrCreateWhere(author: 'Douglas Adams', title: <span class="java&#45;quote">"The Hitchiker's Guide To The Galaxy"</span>)
def book = Book.findOrSaveWhere(author: 'Daniel Suarez', title: 'Daemon')
def book = Book.findOrCreateByAuthorAndTitle('Daniel Suarez', 'Daemon')
def book = Book.findOrSaveByAuthorAndTitle('Daniel Suarez', 'Daemon')</pre></div>
</div><p class="paragraph"/><h4>全新的findOrCreate和findOrSave方法</h4><p class="paragraph"/>领域类现在已经支持findOrCreateWhere, findOrSaveWhere, findOrCreateBy和findOrSaveBy查询方法，这些方法除了不返回null值以外，跟findWhere和findBy方法基本类似。如果在数据库中没有找到符合条件的实例，系统将会根据查询参数创建一个全新的实例返回，不过在findOrSaveWhere 和findOrSaveBy中,实例是先保存入库再返回的。示例代码如下：<p class="paragraph"/><div class="code"><pre>def book = Book.findOrCreateWhere(author: 'Douglas Adams', title: <span class="java&#45;quote">"The Hitchiker's Guide To The Galaxy"</span>)
def book = Book.findOrSaveWhere(author: 'Daniel Suarez', title: 'Daemon')
def book = Book.findOrCreateByAuthorAndTitle('Daniel Suarez', 'Daemon')
def book = Book.findOrSaveByAuthorAndTitle('Daniel Suarez', 'Daemon')</pre></div><p class="paragraph"/>
<div class="hidden-block">
<h4>Detached Criteria and Where Queries</h4><p class="paragraph"/>Grails 2.0 features support for <a href="../guide/single.html#detachedCriteria" class="guide">DetachedCriteria</a> which are criteria queries that are not associated with any session or connection and thus can be more easily reused and composed:<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
def results = criteria.list(max:4, sort:<span class="java&#45;quote">"firstName"</span>)</pre></div><p class="paragraph"/>To support the addition of <a href="../guide/single.html#detachedCriteria" class="guide">DetachedCriteria</a> queries and encourage their use a new <code>where</code> method and DSL has been introduced to greatly reduce the complexity of criteria queries:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    (lastName != <span class="java&#45;quote">"Simpson"</span> &#38;&#38; firstName != <span class="java&#45;quote">"Fred"</span>) || (firstName == <span class="java&#45;quote">"Bart"</span> &#38;&#38; age &#62; 9)
&#125;
def results = query.list(sort:<span class="java&#45;quote">"firstName"</span>)</pre></div><p class="paragraph"/>See the documentation on <a href="../guide/single.html#detachedCriteria" class="guide">DetachedCriteria</a> and <a href="../guide/single.html#whereQueries" class="guide">Where Queries</a> for more information.
</div><p class="paragraph"/><h4>分离的Criteria和Where查询</h4><p class="paragraph"/>Grails 2.0中<a href="../guide/single.html#detachedCriteria" class="guide">分离的Criteria</a>是指条件（Criteria）查询不再跟任何数据库会话或者连接关联，因此可以很方便的复用和构造，比如：<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
def results = criteria.list(max:4, sort:<span class="java&#45;quote">"firstName"</span>)</pre></div><p class="paragraph"/>为了支持<a href="../guide/single.html#detachedCriteria" class="guide">分离的Criteria</a>查询和减少条件查询的复杂性，一个新的<code>where</code>方法及其DSL被引入，比如：<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    (lastName != <span class="java&#45;quote">"Simpson"</span> &#38;&#38; firstName != <span class="java&#45;quote">"Fred"</span>) || (firstName == <span class="java&#45;quote">"Bart"</span> &#38;&#38; age &#62; 9)
&#125;
def results = query.list(sort:<span class="java&#45;quote">"firstName"</span>)</pre></div><p class="paragraph"/>更多信息请参考本手册的<a href="../guide/single.html#detachedCriteria" class="guide">分离的Criteria</a> and <a href="../guide/single.html#whereQueries" class="guide">Where Queries</a>章节。<p class="paragraph"/>
<div class="hidden-block">
<h4>Abstract Inheritance</h4><p class="paragraph"/>GORM now supports abstract inheritance trees which means you can define queries and associations linking to abstract classes:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">abstract</span> class Media &#123;
    <span class="java&#45;object">String</span> title
    …
&#125;
class Book <span class="java&#45;keyword">extends</span> Media &#123;
&#125;
class Album <span class="java&#45;keyword">extends</span> Media &#123;<p class="paragraph"/>&#125;
class Account &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;purchasedMedia:Media&#93;
&#125;<p class="paragraph"/>..<p class="paragraph"/>def allMedia = Media.list()</pre></div>
</div><p class="paragraph"/><h4>抽象继承</h4><p class="paragraph"/>GORM现在支持抽象的继承树或者说现在你可以定义抽象类的查询和关联了，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">abstract</span> class Media &#123;
    <span class="java&#45;object">String</span> title
    …
&#125;
class Book <span class="java&#45;keyword">extends</span> Media &#123;
&#125;
class Album <span class="java&#45;keyword">extends</span> Media &#123;<p class="paragraph"/>&#125;
class Account &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;purchasedMedia:Media&#93;
&#125;<p class="paragraph"/>..<p class="paragraph"/>def allMedia = Media.list()</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Multiple Data Sources Support</h4><p class="paragraph"/>It is now possible to define multiple datasources in <code>DataSource.groovy</code> and declare one or more datasources a particular domain uses by default:<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasource 'ZIP_CODES'
   &#125;
&#125;</pre></div><p class="paragraph"/>If multiple datasources are specified for a domain then you can use the name of a particular datasource as a namespace in front of any regular GORM method:<p class="paragraph"/><div class="code"><pre>def zipCode = ZipCode.auditing.get(42)</pre></div><p class="paragraph"/>For more information see the section on <a href="../guide/single.html#multipleDatasources" class="guide">Multiple Data Sources</a> in the user guide.
</div><p class="paragraph"/><h4>支持多个数据源</h4><p class="paragraph"/>现在，可以在<code>DataSource.groovy</code>定义多个数据源了，对于特定的领域类来说，声明一个或者多个数据源的示例如下：<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasource 'ZIP_CODES'
   &#125;
&#125;</pre></div><p class="paragraph"/>在使用有多个数据源的领域类时候，只需要在常规的GORM方法前加上特定数据源名称即可。比如：<p class="paragraph"/><div class="code"><pre>def zipCode = ZipCode.auditing.get(42)</pre></div><p class="paragraph"/>更多信息请参考本手册的<a href="../guide/single.html#multipleDatasources" class="guide">多数据源</a>章节<p class="paragraph"/><div class="hidden-block">
<h4>Database Migrations</h4><p class="paragraph"/>A new <a href="http://grails.org/plugin/database-migration" target="blank">database migration plugin</a> has been designed and built for Grails 2.0 allowing you to apply migrations to your database, rollback changes and diff your domain model with the current state of the database.
</div><p class="paragraph"/><h4>数据库迁移（Database Migration）</h4><p class="paragraph"/>新设计的<a href="http://grails.org/plugin/database-migration" target="blank">数据库迁移插件</a>完全是基于Grails 2.0的，有了它，你可以迁移你的数据库了，比如根据当前的数据库状态回滚所做的变化，比较领域模型。<p class="paragraph"/><div class="hidden-block">
<h4>Database Reverse Engineering</h4><p class="paragraph"/>A new <a href="http://www.grails.org/plugin/db-reverse-engineer" target="blank">database reverse engineering</a> plugin has been designed and built for Grails 2.0 that allows you to generate a domain model from an existing database schema.
</div><p class="paragraph"/><h4>数据库逆向工程</h4><p class="paragraph"/>基于Grails 2.0的<a href="http://www.grails.org/plugin/db-reverse-engineer" target="blank">数据库逆向工程插件</a>可以根据已有的数据库模式（database schema），自动生成领域模型。<p class="paragraph"/><div class="hidden-block">
<h4>Hibernate 3.6</h4><p class="paragraph"/>Grails 2.0 is now built on Hibernate 3.6
</div><p class="paragraph"/><h4>Hibernate 3.6</h4><p class="paragraph"/>Grails 2.0现在基于Hibernate 3.6了<p class="paragraph"/><div class="hidden-block">
<h4>Bag Collections</h4><p class="paragraph"/>You can now use Hibernate <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/collections.html" target="blank">Bag</a>s for mapped collections to avoid the memory and performance issues of loading large collections to enforce <code>Set</code> uniqueness or <code>List</code> order.<p class="paragraph"/>For more information see the section on <a href="../guide/single.html#sets,ListsAndMaps" class="guide">Sets, Lists and Maps</a> in the user guide.
</div><p class="paragraph"/><h4>Bag集合</h4><p class="paragraph"/>现在Hibernate的<a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/collections.html" target="blank">Bag</a>集合（Bag集合，即在集合中允许重复，可以简单的看作为Set和List的结合体－－译者注）在Grails 2.0中也得到了支持，由此也比较好的解决了加载大数据量集合转换（<code>Set</code>必须唯一或者<code>List</code>必须有序）导致的内存和性能问题。<p class="paragraph"/>更多信息请参考本手册的<a href="../guide/single.html#sets,ListsAndMaps" class="guide">集合、列表、映射</a>章节。


<a name="1.1.5 Testing Features"><!-- Legacy link --></a>
<h2 id="testingFeatures">1.1.5 测试特性</h2>
<div class="hidden-block">
<h4>New Unit Testing Console Output</h4><p class="paragraph"/>Test output from the test-app command has been improved:<p class="paragraph"/><img border="0" class="center" src="../../img/test-output.png"></img>
</div><p class="paragraph"/><h4>新的单元测试输出结果</h4><p class="paragraph"/>运行<code>test-app</code>命令的输出结果已经提升为如下图所示：<p class="paragraph"/><img border="0" class="center" src="../../img/test-output.png"></img><p class="paragraph"/><div class="hidden-block">
<h4>New Unit Testing API</h4><p class="paragraph"/>There is a new unit testing API based on mixins that supports JUnit 3, 4 and Spock style tests (with Spock 0.6 and above). Example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.test.mixin.TestFor<p class="paragraph"/>@TestFor(SimpleController)
class SimpleControllerTests  &#123;
    void testIndex() &#123;
        controller.home()<p class="paragraph"/>        assert view == <span class="java&#45;quote">"/simple/homePage"</span>
        assert model.title == <span class="java&#45;quote">"Hello World"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The <a href="../guide/single.html#testing" class="guide">documentation on testing</a> has also been re-written around this new framework.
</div><p class="paragraph"/><h4>新的单元测试API</h4><p class="paragraph"/>新的单元测试API现在支持JUnit 3, 4和Spock风格(Spock 0.6以上)的测试了，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.test.mixin.TestFor<p class="paragraph"/>@TestFor(SimpleController)
class SimpleControllerTests  &#123;
    void testIndex() &#123;
        controller.home()<p class="paragraph"/>        assert view == <span class="java&#45;quote">"/simple/homePage"</span>
        assert model.title == <span class="java&#45;quote">"Hello World"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>本文档中的<a href="../guide/single.html#testing" class="guide">测试</a>部分也基于此框架进行了重写。<p class="paragraph"/><div class="hidden-block">
<h4>Unit Testing GORM</h4><p class="paragraph"/>A new in-memory GORM implementation is present that supports many more features of the GORM API making unit testing of criteria queries, named queries and other previously unsupported methods possible.
</div><p class="paragraph"/><h4>GORM的单元测试</h4><p class="paragraph"/>在单元测试方面，新的基于内存的GORM实现，使得GORM在条件查询、命名查询以及以前并未支持的方法也得到了很好的支持。<p class="paragraph"/><div class="hidden-block">
<h4>Faster Unit Testing with Interactive Mode</h4><p class="paragraph"/>The new interactive mode (activated by typing 'grails') greatly improves the execution time of running unit and integration tests.
</div><p class="paragraph"/><h4>交互模式下更快的单元测试</h4><p class="paragraph"/>新的交互模式（通过输入'grails'命令激活）极大的缩短了单元和集成测试的运行时间。<p class="paragraph"/><div class="hidden-block">
<h4>Unit Test Scaffolding</h4><p class="paragraph"/>A unit test is now generated for scaffolded controllers
</div><p class="paragraph"/><h4>脚手架（Scaffolding）的单元测试</h4><p class="paragraph"/>使用脚手架的控制器现在也自动生成一个单元测试。


<a name="2. Getting Started"><!-- Legacy link --></a>
<h1 id="gettingStarted">2 起步</h1>



<h2 id="requirements">2.1 安装的前提条件</h2>
<div class="hidden-block">
Before installing Grails you will as a minimum need a Java Development Kit (JDK) installed version 1.6 or above and environment variable called <code>JAVA_HOME</code> pointing to the location of this installation. On some platforms (for example OS X) the Java installation is automatically detected. However in many cases you will want to manually configure the location of Java. For example:<p class="paragraph"/><div class="code"><pre>export JAVA_HOME=/Library/Java/Home
export PATH=<span class="java&#45;quote">"$PATH:$JAVA_HOME/bin"</span></pre></div><p class="paragraph"/>Note that although JDK 1.6 is required to use Grails at development time it is possible to deploy Grails to JDK 1.5 VMs by setting the <code>grails.project.source.level</code> and <code>grails.project.target.level</code> settings to "1.5" in <code>grails-app/conf/BuildConfig.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.project.source.level = 1.5
grails.project.target.level = 1.5</pre></div><p class="paragraph"/>In addition, Grails supports Servlet versions 2.5 and above. If you wish to use newer features of the Servlet API (such as 3.0) you should configure the <code>grails.servlet.version</code> in <code>BuildConfig.groovy</code> appropriately:<p class="paragraph"/><div class="code"><pre>grails.servlet.version = <span class="java&#45;quote">"3.0"</span></pre></div>
</div><p class="paragraph"/>在安装Grails以前，你至少需要先安装1.6或者更高版本的JDK，并且设置名为<code>JAVA_HOME</code>全局环境变量来指向它。有些平台（比如OS X），Java的安装是自动检测的，但是还是有不少的平台是需要手工来配置Java的安装位置的，比如：<p class="paragraph"/><div class="code"><pre>export JAVA_HOME=/Library/Java/Home
export PATH=<span class="java&#45;quote">"$PATH:$JAVA_HOME/bin"</span></pre></div><p class="paragraph"/>注意！虽然Grails的开发环境是需要JDK 1.6，但是仍然可以将其应用发布于JDK 1.5 VM上，这可以通过设置<code>grails-app/conf/BuildConfig.groovy</code>中的<code>grails.project.source.level</code>和<code>grails.project.target.level</code>值为"1.5"：<p class="paragraph"/><div class="code"><pre>grails.project.source.level = 1.5
grails.project.target.level = 1.5</pre></div><p class="paragraph"/>此外，Grails支持的Servlet版本至少是2.5。如果你想使用最新的Servlet API（比如3.0）特性，你需要配置<code>BuildConfig.groovy</code>中的<code>grails.servlet.version</code>为合适的值才行，比如：<p class="paragraph"/><div class="code"><pre>grails.servlet.version = <span class="java&#45;quote">"3.0"</span></pre></div>


<a name="2.1 Downloading and Installing"><!-- Legacy link --></a>
<h2 id="downloadingAndInstalling">2.2 下载安装Grails</h2>
<div class="hidden-block">
The first step to getting up and running with Grails is to install the distribution. To do so follow these steps:
<ul class="star">
<li><a href="http://grails.org/Download" target="blank">Download</a> a binary distribution of Grails and extract the resulting zip file to a location of your choice</li>
<li>Set the GRAILS_HOME environment variable to the location where you extracted the zip</li>
<ul class="star">
<li>On Unix/Linux based systems this is typically a matter of adding something like the following <code>export GRAILS_HOME=/path/to/grails</code> to your profile</li>
<li>On Windows this is typically a matter of setting an environment variable under <code>My Computer/Advanced/Environment Variables</code></li>
</ul>
<li>Then add the <code>bin</code> directory to your <code>PATH</code> variable:</li>
<ul class="star">
<li>On Unix/Linux based systems this can be done by adding <code>export PATH="$PATH:$GRAILS_HOME/bin"</code> to your profile</li>
<li>On Windows this is done by modifying the <code>Path</code> environment variable under <code>My Computer/Advanced/Environment Variables</code></li>
</ul></ul><p class="paragraph"/>If Grails is working correctly you should now be able to type <code>grails -version</code> in the terminal window and see output similar to this:<p class="paragraph"/><pre class="bq"><code>
Grails version: 2.0.0
</div></code></pre><p class="paragraph"/>首先需要下载Grails的发行包并进行安装，执行步骤如下：
<ul class="star">
<li><a href="http://grails.org/Download" target="blank">下载</a> Grails二进制发行包并解压到指定的文件目录下</li>
<li>在环境变量中添加GRAILS_HOME,值为上一步解压的文件目录。</li>
<ul class="star">
<li>Unix/Linux系统中，通常将<code>export GRAILS_HOME=/path/to/grails</code>追加到到用户的启动配置文件中（通常是<code>.profile</code>或者<code>.bashrc</code>等－译者注）</li>
<li>Windows系统上右击“我的电脑”/“属性”/“高级”/“环境变量”，点击新建。</li>
</ul>
<li>将GRAILS_HOME的<code>bin</code>目录追加到系统的<code>PATH</code>变量中：</li>
<ul class="star">
<li>Unix/Linux系统中，通常将<code>export PATH="$PATH:$GRAILS_HOME/bin"</code>追加到到用户的启动配置文件中（同上）</li>
<li>Windows系统上右击“我的电脑”/“属性”/“高级”/“环境变量”，修改PATH变量的值。</li>
</ul></ul><p class="paragraph"/>如果环境变量设置无误，此时可以打开终端（window下为命令提示符，Unix/Linux下为Shell），输入 <code>grails -version</code> 如果屏幕上显示如下提示则说明安装成功：<p class="paragraph"/><pre class="bq"><code>
Grails version: 2.0.0</code></pre><p class="paragraph"/>

<a name="2.2 Upgrading from previous versions of Grails"><!-- Legacy link --></a>
<h2 id="upgradingFromPreviousVersionsOfGrails">2.3 从老版本Grails升级</h2>
<div class="hidden-block">
Although the Grails development team have tried to keep breakages to a minimum there are a number of items to consider when upgrading a Grails 1.0.x, 1.1.x, 1.2.x, or 1.3.x applications to Grails 2.0. The major changes are described in detail below.<p class="paragraph"/></div><p class="paragraph"/>虽然Grails的开发团队已经尽最大可能地将破坏减少到最少，但是当从1.0.x、1.1.x、1.2.x或者1.3.x升级到2.0的时候，依然有很多注意事项。下面详细地描述了这些重要变化。<p class="paragraph"/><h3>从Grails 1.3.x升级</h3><p class="paragraph"/><div class="hidden-block">
<h4>HSQLDB Has Been Replaced With H2</h4><p class="paragraph"/>HSQLDB is still bundled with Grails but is not configured as a default runtime dependency.  Upgrade options include replacing HSQLDB references in DataSource.groovy with H2 references or adding HSQLDB as a runtime dependency for the application.<p class="paragraph"/>If you want to run an application with different versions of Grails, it's simplest to add HSQLDB as a runtime dependency, which you can do in BuildConfig.groovy:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    inherits(<span class="java&#45;quote">"global"</span>) &#123;
    &#125;
    repositories &#123;
        grailsPlugins()
        grailsHome()
        grailsCentral()
    &#125;<p class="paragraph"/>    dependencies &#123;
        // Add HSQLDB as a runtime dependency
        runtime 'hsqldb:hsqldb:1.8.0.10'
    &#125;
&#125;</pre></div><p class="paragraph"/>A default DataSource.groovy which is compatible with H2 looks like this:<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
    username = <span class="java&#45;quote">"sa"</span>
    password = <span class="java&#45;quote">""</span>
&#125;
// environment specific settings
environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span> // one of 'create', 'create&#45;drop','update'
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Another significant difference between H2 and HSQLDB is in the handling of <code>byte&#91;]</code> domain class properties. HSQLDB's default BLOB size is large and so you typically don't need to specify a maximum size. But H2 defaults to a maximum size of 255 bytes! If you store images in the database, the saves are likely to fail because of this. The easy fix is to add a <code>maxSize</code> constraint to the <code>byte&#91;]</code> property:<p class="paragraph"/><div class="code"><pre>class MyDomain &#123;
    <span class="java&#45;object">byte</span>&#91;&#93; data<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        data maxSize: 1024 &#42; 1024 &#42; 2 // 2MB
    &#125;
&#125;</pre></div><p class="paragraph"/>This constraint influences schema generation, so in the above example H2 will have the <code>data</code> column set to <code>BINARY(2097152)</code> by Hibernate.
</div><p class="paragraph"/><h4>H2代替HSQLDB</h4><p class="paragraph"/>Grails依然自带HSQLDB，但在配置中已经没有了运行时依赖。升级的选择可以是将DataSource.groovy中的HSQLDB替换为H2，或者在你的应用中增加运行时依赖。<p class="paragraph"/>如果你想让你的应用运行在不同的Grails版本中，那么最简单的方法就是在BuildConfig.groovy中增加HSQLDB的运行时依赖，如下所示：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    inherits(<span class="java&#45;quote">"global"</span>) &#123;
    &#125;
    repositories &#123;
        grailsPlugins()
        grailsHome()
        grailsCentral()
    &#125;<p class="paragraph"/>    dependencies &#123;
        // Add HSQLDB as a runtime dependency
        runtime 'hsqldb:hsqldb:1.8.0.10'
    &#125;
&#125;</pre></div><p class="paragraph"/>缺省DataSource.groovy中H2配置如下：<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
    username = <span class="java&#45;quote">"sa"</span>
    password = <span class="java&#45;quote">""</span>
&#125;
// environment specific settings
environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span> // one of 'create', 'create&#45;drop','update'
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>H2和HSQLDB另外一个重大差异是其对领域类 <code>byte&#91;]</code> 属性的处理。HSQLDB中其BLOB已经足够大，以至于无需再设定最大值了。而H2其默认最大值是255字节，因此如果要在数据库中存储图像，其保存失败多不半是因为此限制。要解决此问题，只需在 <code>byte&#91;]</code> 属性中增加一个 <code>maxSize</code> 约束，比如：<p class="paragraph"/><div class="code"><pre>class MyDomain &#123;
    <span class="java&#45;object">byte</span>&#91;&#93; data<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        data maxSize: 1024 &#42; 1024 &#42; 2 // 2MB
    &#125;
&#125;</pre></div><p class="paragraph"/>此约束会影响数据库脚本的生成，上述示例中Hibernate会将H2的 <code>data</code> 字段设置为 <code>BINARY(2097152)</code> 。<p class="paragraph"/><div class="hidden-block">
<h4>Abstract Inheritance Changes</h4><p class="paragraph"/>In previous versions of Grails abstract classes in <code>grails-app/domain</code> were not treated as persistent. This is no longer the case and has a significant impact on upgrading your application. For example consider the following domain model in a Grails 1.3.x application:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">abstract</span> class Sellable &#123;<p class="paragraph"/>&#125;
class Book <span class="java&#45;keyword">extends</span> Sellable &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>In Grails 1.3.x you would get a BOOK table and the properties from the <code>Sellable</code> class would be stored within the <code>BOOK</code> table. However, in Grails 2.0.x you will get  <code>SELLABLE</code> table and the default table-per-hierarchy inheritance rules apply with all properties of the <code>Book</code> stored in the <code>SELLABLE</code> table.<p class="paragraph"/>You have two options when upgrading in this scenario:
<ol>
<li>Move the abstract <code>Sellable</code> class into the src/groovy package. If the <code>Sellable</code> class is in the <code>src/groovy</code> directory it will no longer be regarded a persistent</li>
<li>Use the <a href="http://grails.org/plugin/database-migration" target="blank">database migration</a> plugin to apply the appropriate changes to the database (typically renaming the table to the root abstract class of the inheritance tree)</li>
</ol><p class="paragraph"/></div><p class="paragraph"/><h4>抽象继承的变化</h4><p class="paragraph"/>在以前版本的Grails中， <code>grails-app/domain</code> 下的抽象类并没有被持久化。现在这个情况已经不复存在，而且对升级你的应用的来说，也有着重要的影响。比如以下Grails 1.3.x应用的领域模型：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">abstract</span> class Sellable &#123;<p class="paragraph"/>&#125;
class Book <span class="java&#45;keyword">extends</span> Sellable &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>在Grails 1.3.x中，你将生成一个BOOK表，并且继承自 <code>Sellable</code> 类的属性将存储在 <code>BOOK</code> 表中。但是在Grails 2.0.x中，你将生成 <code>SELLABLE</code> 表，并且使用缺省的单表继承（table-per-hierarchy）的继承规则的话，那么 <code>Book</code> 中的所有属性将存储在 <code>SELLABLE</code> 表中。<p class="paragraph"/>这种情况下的升级，你有两种选择：
<ol>
<li>将抽象类 <code>Sellable</code> 移至src/groovy目录下。如果 <code>Sellable</code> 类在 <code>src/groovy</code> 目录下边，那么将不再被持久化。</li>
<li>使用 <a href="http://grails.org/plugin/database-migration" target="blank">数据库迁移</a> 插件让这些变化在数据库中生效（通常是将表名重新命名为继承树中跟抽象类的名称）</li>
</ol><p class="paragraph"/><div class="hidden-block">
<h4>Criteria Queries Default to INNER JOIN</h4><p class="paragraph"/>The previous default of LEFT JOIN for criteria queries across associations is now INNER JOIN.
</div><p class="paragraph"/><h4>条件查询缺省使用内连接（INNER JOIN）</h4><p class="paragraph"/>相比以前的左连接（LEFT JOIN），现在关联查询使用内连接了。<p class="paragraph"/><div class="hidden-block">
<h4>Invalid Constraints Now Thrown an Exception</h4><p class="paragraph"/>Previously if you defined a constraint on a property that doesn't exist no error would be thrown:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> constraints = &#123;
        bad nullable:<span class="java&#45;keyword">false</span> // invalid property, no error thrown
    &#125;
&#125;</pre></div><p class="paragraph"/>Now the above code will result in an exception
</div><p class="paragraph"/><h4>约束无效时抛出异常</h4><p class="paragraph"/>在以前的版本中，如果你在约束中定义了一个不存在的属性，没有任何异常被抛出，比如：<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> constraints = &#123;
        bad nullable:<span class="java&#45;keyword">false</span> // invalid property, no error thrown
    &#125;
&#125;</pre></div><p class="paragraph"/>现在，上述代码将抛出一个异常了。<p class="paragraph"/><div class="hidden-block">
<h4>Logging By Convention Changes</h4><p class="paragraph"/>The packages that you should use for Grails artifacts have mostly changed. In particular:
<ul class="star">
<li><code>service</code> -&#62; <code>services</code></li>
<li><code>controller</code> -&#62; <code>controllers</code></li>
<li><code>tagLib</code> -&#62; <code>taglib</code> (case change)</li>
<li><code>bootstrap</code> -&#62; <code>conf</code></li>
<li><code>dataSource</code> -&#62; <code>conf</code></li>
</ul><p class="paragraph"/>You can find out more about logging by convention in the <a href="../guide/single.html#logging" class="guide">main part</a> of the user guide, under "Configuring loggers". This change is a side-effect of injecting the <code>log</code> property into artefacts at compile time.
</div><p class="paragraph"/><h4>日志规约的变化</h4><p class="paragraph"/>你使用的Grails工件包名大部分发生了改变，特别是以下几个：
<ul class="star">
<li><code>service</code> -&#62; <code>services</code></li>
<li><code>controller</code> -&#62; <code>controllers</code></li>
<li><code>tagLib</code> -&#62; <code>taglib</code> (大小写变化)</li>
<li><code>bootstrap</code> -&#62; <code>conf</code></li>
<li><code>dataSource</code> -&#62; <code>conf</code></li>
</ul><p class="paragraph"/>你可以在本手册的"日志配置"部分中的 <a href="../guide/single.html#logging" class="guide">主体部分</a> 发现更多的日志规约内容，此外这种变化的一个副作用就是将 <code>log</code> 属性在编译时就注入到工件类中。<p class="paragraph"/><div class="hidden-block">
<h4>jQuery Replaces Prototype</h4><p class="paragraph"/>The Protoype Javascript library has been removed from Grails core and now new Grails applications have the jQuery plugin configured by default. This will only impact you if you are using Prototype with the adaptive AJAX tags in your application, e.g. &#60;g:remoteLink/&#62; etc, because those tags will break as soon as you upgrade.<p class="paragraph"/>To resolve this issue, simply install the <a href="http://grails.org/plugin/prototype" target="blank">Prototype plugin</a> in your application. You can also remove the prototype files from your <code>web-app/js/prototype</code> directory if you want.
</div><p class="paragraph"/><h4>jQuery替代Prototype</h4><p class="paragraph"/>Protoype库已经从Grails核心中移除了，取而代之的是jQuery插件。这将影响你应用中使用Prototype的AJAX标签，比如 &#60;g:remoteLink/&#62; 等，因为这些标签会在你升级后失效。<p class="paragraph"/>要解决此问题，只需要在你应用中安装 <a href="http://grails.org/plugin/prototype" target="blank">Prototype插件</a> 即可，或者移除 <code>web-app/js/prototype</code> 目录下的prototype文件。<p class="paragraph"/><div class="hidden-block">
<h4>Access Control and Resources</h4><p class="paragraph"/>The Resources plugin is a great new feature of Grails, but you do need to be aware that it adds an extra URL at <code>/static</code>. If you have access control in your application, this may mean that the static resources require an authenticated user to load them! Make sure your access rules take account of the <code>/static</code> URL.
</div><p class="paragraph"/><h4>访问控制和资源</h4><p class="paragraph"/>Resources插件是Grails非常棒的新特性，但前提是需要增加一个额外的 <code>/static</code> URL地址。如果你的应用中有权限访问控制的话，这意味着这些静态资源也需要授权用户才能加载他们，因此一定要确定你的访问控制规则已经包含了 <code>/static</code> URL地址<p class="paragraph"/><div class="hidden-block">
<h4>Controller Public Methods</h4><p class="paragraph"/>As of Grails 2.0, public methods of controllers are now treated as actions in addition to actions defined as traditional Closures. If you were relying on the use of methods for privacy controls or as helper methods then this could result in unexpected behavior. To resolve this issue you should mark all methods of your application that are not to be exposed as actions as <code>private</code> methods.
</div><p class="paragraph"/><h4>控制器的Public方法</h4><p class="paragraph"/>在Grails 2.0的控制器中，除了传统的必包动作以外，还将公共方法也视为动作。这意味着如果你将这些公共方法作为私有控制或者辅助方法的话，将会导致不可预知的结果。要解决此问题，只需要将应用中不希望暴露为动作的方法全部标记为 <code>private</code> 方法。<p class="paragraph"/><div class="hidden-block">
<h4>The redirect Method</h4><p class="paragraph"/>The <a href="../ref/Controllers/redirect.html" class="controllers">redirect</a> method no longer commits the response. The result of this is code that relies of this behavior will break in 2.0. For example:<p class="paragraph"/><div class="code"><pre>redirect action: <span class="java&#45;quote">"next"</span>
<span class="java&#45;keyword">if</span> (response.committed) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div><p class="paragraph"/>In this case in Grails 1.3.x and below the <code>response.committed</code> property would return true and the <code>if</code> block will execute. In Grails 2.0 this is no longer the case and you should instead use the new <code>isRedirected()</code> method of the <code>request</code> object:<p class="paragraph"/><div class="code"><pre>redirect action: <span class="java&#45;quote">"next"</span>
<span class="java&#45;keyword">if</span> (request.redirected) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div><p class="paragraph"/>Another side-effect of the changes to the redirect method is that it now always uses the <code>grails.serverURL</code> configuration option if it's set. Previous versions of Grails included default values for all the environments, but when upgrading to Grails 2.0 those values more often than not break redirection. So, we recommend you remove the development and test settings for <code>grails.serverURL</code> or replace them with something appropriate for your application.
</div><p class="paragraph"/><h4>redirect方法</h4><p class="paragraph"/> <a href="../ref/Controllers/redirect.html" class="controllers">redirect</a> 方法不再提交响应，因此依赖此行为的代码在2.0中不再有效，比如：<p class="paragraph"/><div class="code"><pre>redirect action: <span class="java&#45;quote">"next"</span>
<span class="java&#45;keyword">if</span> (response.committed) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div><p class="paragraph"/>在Grails 1.3.x中上述代码的 <code>response.committed</code> 属性将返回true，并且其 <code>if</code> 代码块将得到执行。而在Grails 2.0中，要使上述代码可以工作，需要使用 <code>request</code> 的 <code>isRedirected()</code>  方法来替代之，如下：<p class="paragraph"/><div class="code"><pre>redirect action: <span class="java&#45;quote">"next"</span>
<span class="java&#45;keyword">if</span> (request.redirected) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div><p class="paragraph"/>redirect方法此变化的一个副作用是：如果配置选项中的 <code>grails.serverURL</code> 被设置，那么它将一直使用此值，而以前版本Grails的缺省值是应用于全部环境的，但是升级到Grails 2.0后，这些值往往不是中断重定向。因此我们推荐你移除开发和测试环境中 <code>grails.serverURL</code> 的设置，或者将他们替换为合适的值。<p class="paragraph"/><div class="hidden-block">
<h4>Content Negotiation</h4><p class="paragraph"/>As of Grails 2.0 the <a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a> method of controllers no longer takes into account the request content type (dictated by the <code>CONTENT_TYPE</code> header), but instead deals exclusively with the response content type (dictated by the <code>ACCEPT</code> header or file extension). This means that if your application has code that relies on reading XML from the request using <code>withFormat</code> this will no longer work:<p class="paragraph"/><div class="code"><pre>def processBook() &#123;
    withFormat &#123;
        xml &#123;
            // read request XML
        &#125;
        html &#123;
            // read request parameters
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Instead you use the <code>withFormat</code> method provided on the <code>request</code> object:<p class="paragraph"/><div class="code"><pre>def processBook() &#123;
    request.withFormat &#123;
        xml &#123;
            // read request XML
        &#125;
        html &#123;
            // read request parameters
        &#125;
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>内容协商（Content Negotiation）</h4><p class="paragraph"/>Grails 2.0的控制器方法 <a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a> 依赖的不再是请求内容类型（通过 <code>CONTENT_TYPE</code> 来确定），而是响应内容类型（通过 <code>ACCEPT</code> 或者文件的扩展名来确定）。换句话说，如果你的应用代码中依赖请求的 <code>withFormat</code> 将不再有效，比如：<p class="paragraph"/><div class="code"><pre>def processBook() &#123;
    withFormat &#123;
        xml &#123;
            // read request XML
        &#125;
        html &#123;
            // read request parameters
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>这种情况，你需要明确的指定是 <code>request</code> 的 <code>withFormat</code> 方法，如下所示：<p class="paragraph"/><div class="code"><pre>def processBook() &#123;
    request.withFormat &#123;
        xml &#123;
            // read request XML
        &#125;
        html &#123;
            // read request parameters
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Command Line Output</h4><p class="paragraph"/>Ant output is now hidden by default to keep the noise in the terminal to a minimum. That means if you use <code>ant.echo</code> in your scripts to communicate messages to the user, we recommend switching to an alternative mechanism.<p class="paragraph"/>For status related messages, you can use the event system:<p class="paragraph"/><div class="code"><pre>event <span class="java&#45;quote">"StatusUpdate"</span>, &#91;<span class="java&#45;quote">"Some message"</span>&#93;
event <span class="java&#45;quote">"StatusFinal"</span>,  &#91;<span class="java&#45;quote">"Some message"</span>&#93;
event <span class="java&#45;quote">"StatusError"</span>,  &#91;<span class="java&#45;quote">"Some message"</span>&#93;</pre></div><p class="paragraph"/>For more control you can use the <code>grailsConsole</code> script variable, which gives you access to an instance of <a href="../../api/grails/build/logging/GrailsConsole.html" class="api">GrailsConsole</a>. In particular, you can log information messages with <code>log()</code> or <code>info()</code>, errors and warnings with <code>error()</code> and <code>warning()</code>, and request user input with <code>userInput()</code>.
</div><p class="paragraph"/><h4>命令行输出</h4><p class="paragraph"/>缺省情况下，为了让字符终端的干扰减少到最少，Ant的输出信息现在已经被屏蔽了。换句话说，如果你的脚本中使用 <code>ant.echo</code> 来显示用户信息，我们推荐你使用其他机制。<p class="paragraph"/>对跟状态相关的信息来说，你可以使用event系统，比如：<p class="paragraph"/><div class="code"><pre>event <span class="java&#45;quote">"StatusUpdate"</span>, &#91;<span class="java&#45;quote">"Some message"</span>&#93;
event <span class="java&#45;quote">"StatusFinal"</span>,  &#91;<span class="java&#45;quote">"Some message"</span>&#93;
event <span class="java&#45;quote">"StatusError"</span>,  &#91;<span class="java&#45;quote">"Some message"</span>&#93;</pre></div><p class="paragraph"/>想要获得更多的控制，你可以使用 <code>grailsConsole</code> 脚本变量，它是 <a href="../../api/grails/build/logging/GrailsConsole.html" class="api">GrailsConsole</a>的一个实例。此外你还可以使用 <code>log()</code> 或者 <code>info()</code> 来记录日志信息，使用 <code>error()</code> 和 <code>warning()</code> 来记录错误和警告信息，使用 <code>userInput()</code> 来获取用户的输入。<p class="paragraph"/><div class="hidden-block">
<h4>Ivy cache location has changed</h4><p class="paragraph"/>The default Ivy cache location for Grails has changed. If the thought of yet another cache of JARs on your disk horrifies you, then you can change this in your <code>settings.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.dependency.cache.dir = <span class="java&#45;quote">"$&#123;userHome&#125;/.ivy2/cache"</span></pre></div><p class="paragraph"/>If you do this, be aware that you may run into problems running Grails 2 and earlier versions of Grails side-by-side. These problems can be avoided by excluding "xml-apis" and "commons-digester" from the inherited global dependencies in Grails 1.3 and earlier projects.
</div><p class="paragraph"/><h4>Ivy缓存位置变化</h4><p class="paragraph"/>Grails的缺省Ivy缓存位置已经改变。如果磁盘上多出来的另外一个JAR缓存让你不舒服，那你依然可以通过修改 <code>settings.groovy</code> 来改变它，如下：<p class="paragraph"/><div class="code"><pre>grails.dependency.cache.dir = <span class="java&#45;quote">"$&#123;userHome&#125;/.ivy2/cache"</span></pre></div><p class="paragraph"/>如果这么做了，那么你需要知道Grails 2和以前版本的Grails运行在一起，可能会导致问题。这些问题可以通过排除全局依赖中的"xml-apis"和"commons-digester"来避免，因为在Grails 1.3及其以前版本的全局依赖中，包含冲突版本。<p class="paragraph"/><div class="hidden-block">
<h4>Updated Underlying APIs</h4><p class="paragraph"/>Grails 2.0 contains updated dependencies including Servlet 3.0, Tomcat 7, Spring 3.1, Hibernate 3.6 and Groovy 1.8. This means that certain plugins and applications that that depend on earlier versions of these APIs may no longer work. For example the Servlet 3.0 <code>HttpServletRequest</code> interface includes new methods, so if a plugin implements this interface for Servlet 2.5 but not for Servlet 3.0 then said plugin will break. The same can be said of any Spring interface.
</div><p class="paragraph"/><h4>更新基础API</h4><p class="paragraph"/>Grails 2.0的依赖现在已经更新到Servlet 3.0、Tomcat 7、Spring 3.1、Hibernate 3.6和Groovy 1.8，这对某些依赖于以前版本API的插件和应用来说，将不会再工作。比如Servlet 3.0的 <code>HttpServletRequest</code> 接口包含的新方法，将会导致那些依赖于Servlet 2.5的插件不再有效。同理，对任何Spring接口来说，也是一样。<p class="paragraph"/><div class="hidden-block">
<h4>Removal of release-plugin</h4><p class="paragraph"/>The built in <code>release-plugin</code> command for releases plugins to the central Grails plugin repository has been removed. The new <a href="http://grails.org/plugin/release" target="blank">release</a> plugin should be used instead which provides an equivalent <code>publish-plugin</code> command.
</div><p class="paragraph"/><h4>移除release-plugin</h4><p class="paragraph"/>内置的用于将插件发布到Grails官方插件存储库的 <code>release-plugin</code> 命令已经被移除了，一个全新的 <a href="http://grails.org/plugin/release" target="blank">release</a> 插件被用于做跟 <code>publish-plugin</code> 命令相同的工作。<p class="paragraph"/><h4>移除废弃类</h4><p class="paragraph"/>已经废弃的类有： <code>grails.web.JsonBuilder</code> 和 <code>grails.web.OpenRicoBuilder</code><p class="paragraph"/><h3>从Grails 1.2.x升级</h3><p class="paragraph"/><div class="hidden-block">
<h4>Plugin Repositories</h4><p class="paragraph"/>As of Grails 1.3, Grails no longer natively supports resolving plugins against secured SVN repositories. The plugin resolution mechanism in Grails 1.2 and below has been replaced by one built on <a href="http://ant.apache.org/ivy/" target="blank">Ivy</a>, the upside of which is that you can now resolve Grails plugins against Maven repositories as well as regular Grails repositories.<p class="paragraph"/>Ivy supports a much richer setter of repository resolvers for resolving plugins, including support for Webdav, HTTP, SSH and FTP. See the section on <a href="http://ant.apache.org/ivy/history/trunk/settings/resolvers.html" target="blank">resolvers</a> in the Ivy docs for all the available options and the section of <a href="../guide/single.html#repositories" class="guide">plugin repositories</a> in the user guide which explains how to configure additional resolvers.<p class="paragraph"/>If you still need support for resolving plugins against secured SVN repositories then the <a href="http://code.google.com/p/ivysvn/" target="blank">IvySvn</a> project provides a set of resolvers for SVN repositories.
</div><p class="paragraph"/><h4>插件存储库</h4><p class="paragraph"/>在Grails 1.3中，系统不再支持原生的具有安全SVN存储库的插件解析。从Grails 1.2以来，插件的解析机制就已经被内置的 <a href="http://ant.apache.org/ivy/" target="blank">Ivy</a>所替代，这么做的好处是你不仅可以使用常规的Grails存储库，还可以使用Maven存储库来解析插件。<p class="paragraph"/>对于解析插件来说，Ivy支持更丰富的存储库解析器设置，包括 Webdav、HTTP、SSH和FTP。更多有效的解析器请参考Ivy文档的 <a href="http://ant.apache.org/ivy/history/trunk/settings/resolvers.html" target="blank">resolvers</a> 章节，至于如何详尽的配置这些解析器，请参考本手册的 <a href="../guide/single.html#repositories" class="guide">插件存储库</a><p class="paragraph"/>如果你依旧使用安全SVN存储库，那么 <a href="http://code.google.com/p/ivysvn/" target="blank">IvySvn</a> 工程为SVN存储库提供了一系列的解析器。<p class="paragraph"/><h3>从Grails 1.1.x升级</h3><p class="paragraph"/><div class="hidden-block">
<h4>Plugin paths</h4><p class="paragraph"/>In Grails 1.1.x typically a <code>pluginContextPath</code> variable was used to establish paths to plugin resources. For example:<p class="paragraph"/><div class="code"><pre>&#60;g:resource dir=<span class="java&#45;quote">"$&#123;pluginContextPath&#125;/images"</span> file=<span class="java&#45;quote">"foo.jpg"</span> /&#62;</pre></div><p class="paragraph"/>In Grails 1.2 views have been made plugin aware and this is no longer necessary:<p class="paragraph"/><div class="code"><pre>&#60;g:resource dir=<span class="java&#45;quote">"images"</span> file=<span class="java&#45;quote">"foo.jpg"</span> /&#62;</pre></div><p class="paragraph"/>Additionally the above example will no longer link to an application image from a plugin view. To do so change the above to:<p class="paragraph"/><div class="code"><pre>&#60;g:resource contextPath=<span class="java&#45;quote">""</span> dir=<span class="java&#45;quote">"images"</span> file=<span class="java&#45;quote">"foo.jpg"</span> /&#62;</pre></div><p class="paragraph"/>The same rules apply to the <a href="../ref/Tags/javascript.html" class="tags">javascript</a> and <a href="../ref/Tags/render.html" class="tags">render</a> tags.
</div><p class="paragraph"/><h4>插件路径</h4><p class="paragraph"/>在Grails 1.1.x中，通常使用 <code>pluginContextPath</code> 变量来指定插件资源的路径，比如：<p class="paragraph"/><div class="code"><pre>&#60;g:resource dir=<span class="java&#45;quote">"$&#123;pluginContextPath&#125;/images"</span> file=<span class="java&#45;quote">"foo.jpg"</span> /&#62;</pre></div><p class="paragraph"/>在Grails 1.2的视图中，插件已经可以自动识别了，因此也就没有存在的必要了，比如：<p class="paragraph"/><div class="code"><pre>&#60;g:resource dir=<span class="java&#45;quote">"images"</span> file=<span class="java&#45;quote">"foo.jpg"</span> /&#62;</pre></div><p class="paragraph"/>此外上述示例在插件视图中不会引用当前应用的图像，要想引用当前的，需要如下代码所示：<p class="paragraph"/><div class="code"><pre>&#60;g:resource contextPath=<span class="java&#45;quote">""</span> dir=<span class="java&#45;quote">"images"</span> file=<span class="java&#45;quote">"foo.jpg"</span> /&#62;</pre></div><p class="paragraph"/>此规则同样适用于 <a href="../ref/Tags/javascript.html" class="tags">javascript</a> 和 <a href="../ref/Tags/render.html" class="tags">render</a> 标签.<p class="paragraph"/><div class="hidden-block">
<h4>Tag and Body return values</h4><p class="paragraph"/>Tags no longer return <code>java.lang.String</code> instances but instead return a Grails <code>StreamCharBuffer</code> instance. The <code>StreamCharBuffer</code> class implements all the same methods as <code>String</code> but doesn't extend <code>String</code>, so code like this will break:<p class="paragraph"/><div class="code"><pre>def foo = body()
<span class="java&#45;keyword">if</span> (foo <span class="java&#45;keyword">instanceof</span> <span class="java&#45;object">String</span>) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div><p class="paragraph"/>In these cases you should check for the <code>java.lang.CharSequence</code> interface, which both <code>String</code> and <code>StreamCharBuffer</code> implement:<p class="paragraph"/><div class="code"><pre>def foo = body()
<span class="java&#45;keyword">if</span> (foo <span class="java&#45;keyword">instanceof</span> CharSequence) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div>
</div><p class="paragraph"/><h4>标签及代码块（Body）的返回值</h4><p class="paragraph"/>标签不再返回 <code>java.lang.String</code> 类型实例了，取而代之的是Grails的 <code>StreamCharBuffer</code> 实例。 <code>StreamCharBuffer</code> 类没有继承自 <code>String</code> 但实现了跟 <code>String</code> 完全相同的方法，因此如下代码将不会如期的工作：<p class="paragraph"/><div class="code"><pre>def foo = body()
<span class="java&#45;keyword">if</span> (foo <span class="java&#45;keyword">instanceof</span> <span class="java&#45;object">String</span>) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div><p class="paragraph"/>在上述的代码中，你应该判断 <code>java.lang.CharSequence</code> 接口，因为 <code>String</code> 和 <code>StreamCharBuffer</code> 都实现了此接口：<p class="paragraph"/><div class="code"><pre>def foo = body()
<span class="java&#45;keyword">if</span> (foo <span class="java&#45;keyword">instanceof</span> CharSequence) &#123;
    // <span class="java&#45;keyword">do</span> something
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>New JSONBuilder</h4><p class="paragraph"/>There is a new version of <code>JSONBuilder</code> which is semantically different from the one used in earlier versions of Grails. However, if your application depends on the older semantics you can still use the deprecated implementation by setting the following property to <code>true</code> in Config.groovy:<p class="paragraph"/><div class="code"><pre>grails.json.legacy.builder=<span class="java&#45;keyword">true</span></pre></div>
</div><p class="paragraph"/><h4>新的JSONBuilder</h4><p class="paragraph"/>跟以前版本的Grails相比，新版本的 <code>JSONBuilder</code> 在语法上有着显著的差异，尽管如此，如果你的应用依赖于旧有的要废弃的语法，你仍然可以通过设置Config.groovy中如下的属性为 <code>true</code> 的方式来实现：<p class="paragraph"/><div class="code"><pre>grails.json.legacy.builder=<span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Validation on Flush</h4><p class="paragraph"/>Grails now executes validation routines when the underlying Hibernate session is flushed to ensure that no invalid objects are persisted. If one of your constraints (such as a custom validator) executes a query then this can cause an additional flush, resulting in a <code>StackOverflowError</code>. For example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> constraints = &#123;
    author validator: &#123; a &#45;&#62;
        assert a != Book.findByTitle(<span class="java&#45;quote">"My Book"</span>).author
    &#125;
&#125;</pre></div><p class="paragraph"/>The above code can lead to a <code>StackOverflowError</code> in Grails 1.2. The solution is to run the query in a new Hibernate <code>session</code> (which is recommended in general as doing Hibernate work during flushing can cause other issues):<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> constraints = &#123;
    author validator: &#123; a &#45;&#62;
        Book.withNewSession &#123;
            assert a != Book.findByTitle(<span class="java&#45;quote">"My Book"</span>).author
        &#125;
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>Flush时校验</h4><p class="paragraph"/>现在Grails将在Hibernate会话被清除（Flush）的时候才进行校验检查，这样就保证了只有有效的对象才能入库。如果你的约束（比如一个自定义的校验）执行一个查询，并且此查询将导致一个额外的清除，那么系统将抛出 <code>StackOverflowError</code> 错误，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> constraints = &#123;
    author validator: &#123; a &#45;&#62;
        assert a != Book.findByTitle(<span class="java&#45;quote">"My Book"</span>).author
    &#125;
&#125;</pre></div><p class="paragraph"/>上述代码在Grails 1.2中将导致 <code>StackOverflowError</code> 错误，解决之道就是在新的Hibernate <code>session</code> 中运行查询（这也是因为Hibernate的清除导致问题所推荐的通用解决之道），比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> constraints = &#123;
    author validator: &#123; a &#45;&#62;
        Book.withNewSession &#123;
            assert a != Book.findByTitle(<span class="java&#45;quote">"My Book"</span>).author
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><h3>从Grails 1.0.x升级</h3><p class="paragraph"/><div class="hidden-block">
<h4>Groovy 1.6</h4><p class="paragraph"/>Grails 1.1 and above ship with Groovy 1.6 and no longer supports code compiled against Groovy 1.5. If you have a library that was compiled with Groovy 1.5 you must recompile it against Groovy 1.6 or higher before using it with Grails 1.1.
</div><p class="paragraph"/><h4>Groovy 1.6</h4><p class="paragraph"/>Grails 1.1以后的版本已经采用Groovy 1.6，并且不再支持Groovy 1.5所编译的代码。因此如果你的库是Groovy 1.5编译的，那么在使用Grails 1.1以前，你必须要在Groovy 1.6或者更高版本重新编译才行。<p class="paragraph"/><div class="hidden-block">
<h4>Java 5.0</h4><p class="paragraph"/>Grails 1.1 now no longer supports JDK 1.4, if you wish to continue using Grails then it is recommended you stick to the Grails 1.0.x stream until you are able to upgrade your JDK.
</div><p class="paragraph"/><h4>Java 5.0</h4><p class="paragraph"/>Grails 1.1不再对JDK 1.4提供支持，因此在不能升级你的JDK期间，要想继续使用Grails，只能推荐你继续使用Grails 1.0.x系列。<p class="paragraph"/><div class="hidden-block">
<h4>Configuration Changes</h4><p class="paragraph"/>1) The setting <code>grails.testing.reports.destDir</code> has been renamed to <code>grails.project.test.reports.dir</code> for consistency.<p class="paragraph"/>2) The following settings have been moved from <code>grails-app/conf/Config.groovy</code> to <code>grails-app/conf/BuildConfig.groovy</code>:
<ul class="star">
<ul class="star">
<li><code>grails.config.base.webXml</code></li>
<li><code>grails.project.war.file</code> (renamed from <code>grails.war.destFile</code>)</li>
<li><code>grails.war.dependencies</code></li>
<li><code>grails.war.copyToWebApp</code></li>
<li><code>grails.war.resources</code></li>
</ul></ul><p class="paragraph"/>3) The <code>grails.war.java5.dependencies</code> option is no longer supported, since Java 5.0 is now the baseline (see above).<p class="paragraph"/>4) The use of jsessionid (now considered harmful) is disabled by default. If your application requires jsessionid you can re-enable its usage by adding the following to <code>grails-app/conf/Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.views.enable.jsessionid=<span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>5) The syntax used to configure Log4j has changed. See the user guide section on <a href="../guide/single.html#logging" class="guide">Logging</a> for more information.
</div><p class="paragraph"/><h4>配置的变化</h4><p class="paragraph"/>1) 为了保持一致性，<code>grails.testing.reports.destDir</code> 已经被重新命名为 <code>grails.project.test.reports.dir</code><p class="paragraph"/>2) 以下一些配置已经从 <code>grails-app/conf/Config.groovy</code> 移到了 <code>grails-app/conf/BuildConfig.groovy</code> 中：
<ul class="star">
<ul class="star">
<li><code>grails.config.base.webXml</code></li>
<li><code>grails.project.war.file</code> (原名是 <code>grails.war.destFile</code> )</li>
<li><code>grails.war.dependencies</code></li>
<li><code>grails.war.copyToWebApp</code></li>
<li><code>grails.war.resources</code></li>
</ul></ul><p class="paragraph"/>3) 不再支持 <code>grails.war.java5.dependencies</code> 选项，因为Java 5.0现在已经是最低要求了（见上描述）。<p class="paragraph"/>4) 缺省情况下，jsessionid（被认为是有害的）用法被禁止的。如果你的应用确实需要jsessionid，那么你可以通过在<code>grails-app/conf/Config.groovy</code> 中增加下述代码：<p class="paragraph"/><div class="code"><pre>grails.views.enable.jsessionid=<span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>5) 配置Log4j的语法发生变化，详细可参考本手册的 <a href="../guide/single.html#logging" class="guide">日志</a> 章节。<p class="paragraph"/><div class="hidden-block">
<h4>Plugin Changes</h4><p class="paragraph"/>As of version 1.1, Grails no longer stores plugins inside your <code>PROJECT_HOME/plugins</code> directory by default. This may result in compilation errors in your application unless you either re-install all your plugins or set the following property in <code>grails-app/conf/BuildConfig.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.project.plugins.dir=<span class="java&#45;quote">"./plugins"</span></pre></div>
</div><p class="paragraph"/><h4>插件的变化</h4><p class="paragraph"/>在1.1版本中，Grails不再将 <code>PROJECT_HOME/plugins</code> 目录作为缺省插件目录。这可能会导致你应用的编译错误，因此你需要将所有的插件重新安装或者在 <code>grails-app/conf/BuildConfig.groovy</code> 中设置如下选项：<p class="paragraph"/><div class="code"><pre>grails.project.plugins.dir=<span class="java&#45;quote">"./plugins"</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Script Changes</h4><p class="paragraph"/>1) If you were previously using Grails 1.0.3 or below the following syntax is no longer support for importing scripts from GRAILS_HOME:<p class="paragraph"/><div class="code"><pre>Ant.property(environment:<span class="java&#45;quote">"env"</span>)
grailsHome = Ant.antProject.properties.<span class="java&#45;quote">"env.GRAILS_HOME"</span><p class="paragraph"/>includeTargets &#60;&#60; <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"$&#123;grailsHome&#125;/scripts/Bootstrap.groovy"</span>)</pre></div><p class="paragraph"/>Instead you should use the new <code>grailsScript</code> method to import a named script:<p class="paragraph"/><div class="code"><pre>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsBootstrap"</span>)</pre></div><p class="paragraph"/>2) Due to an upgrade of Gant all references to the variable <code>Ant</code> should be changed to <code>ant</code>.<p class="paragraph"/>3) The root directory of the project is no longer on the classpath, so loading a resource like this will no longer work:<p class="paragraph"/><div class="code"><pre>def stream = getClass().classLoader.getResourceAsStream(
                   <span class="java&#45;quote">"grails&#45;app/conf/my&#45;config.xml"</span>)</pre></div><p class="paragraph"/>Instead you should use the Java File APIs with the <code>basedir</code> property:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"$&#123;basedir&#125;/grails&#45;app/conf/my&#45;config.xml"</span>).withInputStream &#123; stream &#45;&#62;
    // read the file
&#125;</pre></div>
</div><p class="paragraph"/><h4>脚本的变化</h4><p class="paragraph"/>1) 如果你正在使用Grails 1.0.3或者更早的版本，那么如下从GRAILS_HOME中导入脚本的语法将不再被支持：<p class="paragraph"/><div class="code"><pre>Ant.property(environment:<span class="java&#45;quote">"env"</span>)
grailsHome = Ant.antProject.properties.<span class="java&#45;quote">"env.GRAILS_HOME"</span><p class="paragraph"/>includeTargets &#60;&#60; <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"$&#123;grailsHome&#125;/scripts/Bootstrap.groovy"</span>)</pre></div><p class="paragraph"/>而应该使用新的 <code>grailsScript</code> 方法来导入命名脚本：<p class="paragraph"/><div class="code"><pre>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsBootstrap"</span>)</pre></div><p class="paragraph"/>2) 因为升级Gant的原因，所有使用 <code>Ant</code> 的变量全部改为 <code>ant</code> 了。<p class="paragraph"/>3) 工程的根目录不再是classpath的一部分，因此如下方式的加载资源将不再有效：<p class="paragraph"/><div class="code"><pre>def stream = getClass().classLoader.getResourceAsStream(
                   <span class="java&#45;quote">"grails&#45;app/conf/my&#45;config.xml"</span>)</pre></div><p class="paragraph"/>而应该采用Java File API加 <code>basedir</code> 的方式来处理：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"$&#123;basedir&#125;/grails&#45;app/conf/my&#45;config.xml"</span>).withInputStream &#123; stream &#45;&#62;
    // read the file
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Command Line Changes</h4><p class="paragraph"/>The <code>run-app-https</code> and <code>run-war-https</code> commands no longer exist and have been replaced by an argument to <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>:<p class="paragraph"/><div class="code"><pre>grails run&#45;app &#45;https</pre></div>
</div><p class="paragraph"/><h4>命令行的变化</h4><p class="paragraph"/><code>run-app-https</code> 和 <code>run-war-https</code> 命令不再支持，你可以通过<a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>加参数方式来实现：<p class="paragraph"/><div class="code"><pre>grails run&#45;app &#45;https</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Data Mapping Changes</h4><p class="paragraph"/>1) Enum types are now mapped using their String value rather than the ordinal value. You can revert to the old behavior by changing your mapping as follows:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mapping = &#123;
    someEnum enumType:<span class="java&#45;quote">"ordinal"</span>
&#125;</pre></div><p class="paragraph"/>2) Bidirectional one-to-one associations are now mapped with a single column on the owning side and a foreign key reference. You shouldn't need to change anything; however you should drop column on the inverse side as it contains duplicate data.
</div><p class="paragraph"/><h4>数据映射的变化</h4><p class="paragraph"/>1) 枚举类型（Enum）已经被映射为字符串值，而不是数值。不过你也可以通过如下的配置恢复到以前旧有的行为：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mapping = &#123;
    someEnum enumType:<span class="java&#45;quote">"ordinal"</span>
&#125;</pre></div><p class="paragraph"/>2) 双向的one-to-one关联现在已经被映射到持有者一侧的一个字段以及一个外建引用，除了将另外一侧的字段删除以外，你不需要改变任何东西。<p class="paragraph"/><div class="hidden-block">
<h4>REST Support</h4><p class="paragraph"/>Incoming XML requests are now no longer automatically parsed. To enable parsing of REST requests you can do so using the <code>parseRequest</code> argument inside a URL mapping:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/book"</span>(controller:<span class="java&#45;quote">"book"</span>,parseRequest:<span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>Alternatively, you can use the new <code>resource</code> argument, which enables parsing by default:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/book"</span>(resource:<span class="java&#45;quote">"book"</span>)</pre></div>
</div><p class="paragraph"/><h4>支持REST</h4><p class="paragraph"/>输入的XML请求不再被自动地解析，为了能够解析REST请求，你需要在URL映射中增加 <code>parseRequest</code> 参数：<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/book"</span>(controller:<span class="java&#45;quote">"book"</span>,parseRequest:<span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>或者使用新的 <code>resource</code> 参数，其缺省情况下是解析的，如下：<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/book"</span>(resource:<span class="java&#45;quote">"book"</span>)</pre></div>


<a name="2.3 Creating an Application"><!-- Legacy link --></a>
<h2 id="creatingAnApplication">2.4 创建Grails应用</h2>
<div class="hidden-block">
To create a Grails application you first need to familiarize yourself with the usage of the <code>grails</code> command which is used in the following manner:<p class="paragraph"/><div class="code"><pre>grails &#91;command name&#93;</pre></div><p class="paragraph"/>Run <a href="../ref/Command Line/create-app.html" class="commandLine">create-app</a> to create an application:<p class="paragraph"/><pre class="bq"><code>
grails create-app helloworld</code></pre><p class="paragraph"/>This will create a new directory inside the current one that contains the project. Navigate to this directory in your console:<p class="paragraph"/><div class="code"><pre>cd helloworld</pre></div>
</div><p class="paragraph"/>在创建应用程序之前，先熟悉一下 <code>grails</code> 命令的使用（grails中的命令都在终端中输入，请参考上面的讲解）。通常的方式如下：<p class="paragraph"/><div class="code"><pre>grails &#91;command name&#93;</pre></div><p class="paragraph"/>要创建一个应用，只需要运行<a href="../ref/Command Line/create-app.html" class="commandLine">create-app</a>命令即可，比如：<p class="paragraph"/><pre class="bq"><code>
grails create-app helloworld</code></pre><p class="paragraph"/>系统将会在当前目录下创建一个新的helloworld目录，在终端里边浏览目录的命令如下：<p class="paragraph"/><div class="code"><pre>cd helloworld</pre></div><p class="paragraph"/>

<a name="2.4 A Hello World Example"><!-- Legacy link --></a>
<h2 id="aHelloWorldExample">2.5 Hello World示例</h2>
<div class="hidden-block">
To implement the typical "hello world!" example <code>cd</code> into the  directory created in the previous section and activate interactive mode:<p class="paragraph"/><div class="code"><pre>$ cd helloworld
$ grails</pre></div><p class="paragraph"/>Grails' interactive mode will be activated and you should see a prompt that looks like the following:<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-helloworld.png"></img><p class="paragraph"/>Now run the <a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a> command:<p class="paragraph"/><pre class="bq"><code>
grails&#62; create-controller hello</code></pre><p class="paragraph"/>This will create a new controller (Refer to the section on <a href="../guide/single.html#controllers" class="guide">Controllers</a> for more information) in the <code>grails-app/controllers</code> directory called <code>helloworld/HelloController.groovy</code>.<p class="paragraph"/><blockquote class="note">
If no package is specified with create-controller script, Grails automatically uses the application name as the package name. This default is configurable with the <code>grails.project.groupId</code> attribute in Config.groovy.
</blockquote><p class="paragraph"/>Controllers are capable of dealing with web requests and to fulfil the "hello world!" use case our implementation needs to look like the following:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> helloworld<p class="paragraph"/>class HelloController &#123;<p class="paragraph"/>    def world() &#123;
        render <span class="java&#45;quote">"Hello World!"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Job done. Now start-up the container with another new command called <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>:<p class="paragraph"/><pre class="bq"><code>
grails&#62; run-app</code></pre><p class="paragraph"/>This will start-up a server on port 8080 and you should now be able to access your application with the URL: <code>http://localhost:8080/helloworld</code><p class="paragraph"/>The result will look something like the following screenshot:<p class="paragraph"/><img border="0" class="center" src="../../img/intropage.png"></img><p class="paragraph"/>This is the Grails intro page which is rendered by the <code>web-app/index.gsp</code> file. You will note it has a detected the presence of your controller and clicking on the link to our controller we can see the text "Hello World!" printed to the browser window.
</div><p class="paragraph"/>为了完成这个经典的“hello world!”示例，我们需要先 <code>cd</code> 到上一节所创建的"helloworld"目录下，并且激活交互模式，指令如下：<p class="paragraph"/><div class="code"><pre>$ cd helloworld
$ grails</pre></div><p class="paragraph"/>上述命令将Grails的交互模式激活，你将会看到类似于下图所示的截图：<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-helloworld.png"></img><p class="paragraph"/>现在再来运行如下所示的 <a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a> 命令：<p class="paragraph"/><pre class="bq"><code>
grails&#62; create-controller hello</code></pre><p class="paragraph"/>运行该命令后，将会在<code>grails-app/controllers</code>目录下边创建一个名字为 <code>helloworld/HelloController.groovy</code> 的控制器（更多信息请参考<a href="../guide/single.html#controllers" class="guide">控制器</a>章节）。<p class="paragraph"/><blockquote class="note">
如果在create-controller命令中没有指定包名，那么Grails自动地将应用的名称作为包名.这个缺省配置是通过Config.groovy文件中地 <code>grails.project.groupId</code> 属性来指定地。
</blockquote><p class="paragraph"/>控制器主要用来完成对Web请求的处理，为了能够实现"hello world!"示例，我们的实现代码如下：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> helloworld<p class="paragraph"/>class HelloController &#123;<p class="paragraph"/>    def world() &#123;
        render <span class="java&#45;quote">"Hello World!"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>大功告成！现在则需要运行另外一个<a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>命令来启动容器：<p class="paragraph"/><pre class="bq"><code>
grails&#62; run-app</code></pre><p class="paragraph"/>命令完成后，服务器将监听8080端口，因此你可以通过 <code>http://localhost:8080/helloworld</code> 来访问应用。<p class="paragraph"/>其显示结果如下图所示：<p class="paragraph"/><img border="0" class="center" src="../../img/intropage.png"></img><p class="paragraph"/>上图是Grails的 <code>web-app/index.gsp</code> 文件所生成的简介页面，你还会看到系统自动检测到的现有控制器，点击它，你将会看到"Hello World!"显示在浏览器窗口。


<h2 id="usingInteractiveMode">2.6 使用交互模式</h2>
<div class="hidden-block">
Grails 2.0 features an interactive mode which makes command execution faster since the JVM doesn't have to be restarted for each command. To use interactive mode simple type 'grails' from the root of any projects and use TAB completion to get a list of available commands. See the screenshot below for an example:<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-output.png"></img><p class="paragraph"/>For more information on the capabilities of interactive mode refer to the section on <a href="../guide/single.html#interactiveMode" class="guide">Interactive Mode</a> in the user guide.
</div><p class="paragraph"/>Grails 2.0的交互模式可以让命令执行的更快，因为每个命令无需再重新启动JVM了。要使用交互模式，只需要在工程的根目录下输入'grails'，然后使用TAB键可以得到一个有效的命令列表，如下图所示：<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-output.png"></img><p class="paragraph"/>更多交互模式的功能请参考本手册的<a href="../guide/single.html#interactiveMode" class="guide">交互模式</a>章节。


<a name="2.5 Getting Set-up in an IDE"><!-- Legacy link --></a>
<h2 id="ide">2.7 IDE设置</h2>
<div class="hidden-block">
<h4>IntelliJ IDEA</h4><p class="paragraph"/><a href="http://www.jetbrains.com/idea" target="blank">IntelliJ IDEA</a> and the <a href="http://www.jetbrains.net/confluence/display/GRVY/Groovy+Home" target="blank">JetGroovy</a> plugin offer good support for Groovy and Grails developers. Refer to the section on <a href="http://www.jetbrains.com/idea/features/groovy_grails.html" target="blank">Groovy and Grails</a> support on the JetBrains website for a feature overview.<p class="paragraph"/>To integrate Grails with IntelliJ run the following command to generate appropriate project files:<p class="paragraph"/><div class="code"><pre>grails integrate&#45;with &#45;&#45;intellij</pre></div>
</div><p class="paragraph"/><h4>IntelliJ IDEA</h4><p class="paragraph"/><a href="http://www.jetbrains.com/idea" target="blank">IntelliJ IDEA</a>和<a href="http://www.jetbrains.net/confluence/display/GRVY/Groovy+Home" target="blank">JetGroovy</a>插件为Groovy和Grails的开发提供了非常棒的支持。 JetBrains所支持的特性概览，请参考其<a href="http://www.jetbrains.com/idea/features/groovy_grails.html" target="blank">Groovy和Grails</a>章节。<p class="paragraph"/>在Grails中集成IntelliJ，只需要运行如下命令来生成其合适的工程文件即可：<p class="paragraph"/><div class="code"><pre>grails integrate&#45;with &#45;&#45;intellij</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Eclipse</h4><p class="paragraph"/>We recommend that users of <a href="http://www.eclipse.org/" target="blank">Eclipse</a> looking to develop Grails application take a look at <a href="http://www.springsource.com/products/sts" target="blank">SpringSource Tool Suite</a>, which offers built in support for Grails including automatic classpath management, a GSP editor and quick access to Grails commands. See the <a href="http://www.grails.org/STS+Integration" target="blank">STS Integration</a> page for an overview.
</div><p class="paragraph"/><h4>Eclipse</h4><p class="paragraph"/>对使用 <a href="http://www.eclipse.org/" target="blank">Eclipse</a> 来开发Grails应用的用户，我们建议了解一下<a href="http://www.springsource.com/products/sts" target="blank">SpringSource工具集（STS）</a>，其内置了对Grails支持，比如自动classpath管理、GSP编辑器以及快速的Grails命令访问。 <a href="http://www.grails.org/STS+Integration" target="blank">集成STS</a>页面中有其概况介绍。<p class="paragraph"/><div class="hidden-block">
<h4>NetBeans</h4><p class="paragraph"/>NetBeans provides a Groovy/Grails plugin that automatically recognizes Grails projects and provides the ability to run Grails applications in the IDE, code completion and integration with the Glassfish server. For an overview of features see the <a href="http://www.grails.org/NetBeans+Integration" target="blank">NetBeans Integration</a> guide on the Grails website which was written by the NetBeans team.
</div><p class="paragraph"/><h4>NetBeans</h4><p class="paragraph"/>NetBeans下的Groovy/Grails插件，能够自动识别Grails工程、直接在IDE中运行Grails应用。代码补全以及自动跟Glassfish容器集成。NetBeans团队还在Grails官方网站介绍了<a href="http://www.grails.org/NetBeans+Integration" target="blank">集成NetBeans</a>概况。<p class="paragraph"/><div class="hidden-block">
<h4>TextMate</h4><p class="paragraph"/>Since Grails' focus is on simplicity it is often possible to utilize more simple editors and <a href="http://macromates.com/" target="blank">TextMate</a> on the Mac has an excellent Groovy/Grails bundle available from the <a href="http://wiki.macromates.com/Main/SubversionCheckout" target="blank">Texmate bundles SVN</a>.<p class="paragraph"/>To integrate Grails with TextMate run the following command to generate appropriate project files:<p class="paragraph"/><div class="code"><pre>grails integrate&#45;with &#45;&#45;textmate</pre></div><p class="paragraph"/>Alternatively TextMate can easily open any project with its command line integration by issuing the following command from the root of your project:<p class="paragraph"/><div class="code"><pre>mate .</pre></div>
</div><p class="paragraph"/><h4>TextMate</h4><p class="paragraph"/>因为Grails一直关注其简单性，因此很简单的编辑器也可以来开发其应用。Mac下的 <a href="http://macromates.com/" target="blank">TextMate</a> 就有很优秀的Groovy/Grails bundle，已经直接在其官方<a href="http://wiki.macromates.com/Main/SubversionCheckout" target="blank">Texmate bundles SVN</a>中了。<p class="paragraph"/>要在Grails中集成TextMate，只需要运行如下命令来生成其合适的工程文件即可：<p class="paragraph"/><div class="code"><pre>grails integrate&#45;with &#45;&#45;textmate</pre></div><p class="paragraph"/>或者在你工程的根目录下，使用TextMate的命令行方式打开，执行命令如下：<p class="paragraph"/><div class="code"><pre>mate .</pre></div>


<a name="2.6 Convention over Configuration"><!-- Legacy link --></a>
<h2 id="conventionOverConfiguration">2.8 规约配置</h2>
<div class="hidden-block">
Grails uses "convention over configuration" to configure itself. This typically means that the name and location of files is used instead of explicit configuration, hence you need to familiarize yourself with the directory structure provided by Grails.<p class="paragraph"/>Here is a breakdown and links to the relevant sections:
<ul class="star">
<li><code>grails-app</code> - top level directory for Groovy sources</li>
<ul class="star">
<li><code>conf</code> - <a href="../guide/single.html#conf" class="guide">Configuration sources</a>.</li>
<li><code>controllers</code> - <a href="../guide/single.html#controllers" class="guide">Web controllers</a> - The C in MVC.</li>
<li><code>domain</code> - The <a href="../guide/single.html#GORM" class="guide">application domain</a>.</li>
<li><code>i18n</code> - Support for <a href="../guide/single.html#i18n" class="guide">internationalization (i18n)</a>.</li>
<li><code>services</code> - The <a href="../guide/single.html#services" class="guide">service layer</a>.</li>
<li><code>taglib</code> - <a href="../guide/single.html#taglibs" class="guide">Tag libraries</a>.</li>
<li><code>utils</code> - Grails specific utilities.</li>
<li><code>views</code> - <a href="../guide/single.html#gsp" class="guide">Groovy Server Pages</a> - The V in MVC.</li>
</ul>
<li><code>scripts</code> - <a href="../guide/single.html#commandLine" class="guide">Gant scripts</a>.</li>
<li><code>src</code> - Supporting sources</li>
<ul class="star">
<li><code>groovy</code> - Other Groovy sources</li>
<li><code>java</code> - Other Java sources</li>
</ul>
<li><code>test</code>  - <a href="../guide/single.html#testing" class="guide">Unit and integration tests</a>.</li>
</ul><p class="paragraph"/></div><p class="paragraph"/>Grails中的配置遵循“规约优于配置”的原则，即通过文件的名称和位置来替代显式的配置，因此需要熟悉以下几个目录结构的用途。<p class="paragraph"/>此处仅为一个简单的分解，详细请参考相关章节：
<ul class="star">
<li><code>grails-app</code> - Groovy源文件的顶级目录</li>
<ul class="star">
<li><code>conf</code> - <a href="../guide/single.html#conf" class="guide">配置</a>.</li>
<li><code>controllers</code> - <a href="../guide/single.html#controllers" class="guide">Web控制器</a> - MVC中的C（控制器）.</li>
<li><code>domain</code> - <a href="../guide/single.html#GORM" class="guide">领域模型</a>.</li>
<li><code>i18n</code> - <a href="../guide/single.html#i18n" class="guide">国际化(i18n)</a>支持.</li>
<li><code>services</code> - <a href="../guide/single.html#services" class="guide">服务层</a>.</li>
<li><code>taglib</code> - <a href="../guide/single.html#taglibs" class="guide">标签库</a>.</li>
<li><code>utils</code> - Grails相关的工具类.</li>
<li><code>views</code> - <a href="../guide/single.html#gsp" class="guide">Groovy服务器页面（GSP)</a> - MVC中的V(视图).</li>
</ul>
<li><code>scripts</code> - <a href="../guide/single.html#commandLine" class="guide">Gant脚本</a>.</li>
<li><code>src</code> - 源文件目录</li>
<ul class="star">
<li><code>groovy</code> - 其他的Groovy源文件</li>
<li><code>java</code> - 其他的Java源文件</li>
</ul>
<li><code>test</code>  - <a href="../guide/single.html#testing" class="guide">单元和集成测试</a>.</li>
</ul><p class="paragraph"/>

<a name="2.7 Running an Application"><!-- Legacy link --></a>
<h2 id="runningAnApplication">2.9 运行应用</h2>
<div class="hidden-block">
Grails applications can be run with the built in Tomcat server using the <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a> command which will load a server on port 8080 by default:<p class="paragraph"/><div class="code"><pre>grails run&#45;app</pre></div><p class="paragraph"/>You can specify a different port by using the <code>server.port</code> argument:<p class="paragraph"/><div class="code"><pre>grails &#45;Dserver.port=8090 run&#45;app</pre></div><p class="paragraph"/>Note that it is better to start up the application in interactive mode since a container restart is much quicker:<p class="paragraph"/><div class="code"><pre>$ grails
grails&#62; run&#45;app
| Server running. Browse to http://localhost:8080/helloworld
| Application loaded in interactive mode. Type 'exit' to shutdown.
| Downloading: plugins&#45;list.xml
grails&#62; exit
| Stopping Grails server
grails&#62; run&#45;app
| Server running. Browse to http://localhost:8080/helloworld
| Application loaded in interactive mode. Type 'exit' to shutdown.
| Downloading: plugins&#45;list.xml</pre></div><p class="paragraph"/>More information on the <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a> command can be found in the reference guide.
</div><p class="paragraph"/><a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>命令使用内置的端口为8080的Tomcat容器来运行Grails应用，比如：<p class="paragraph"/><div class="code"><pre>grails run&#45;app</pre></div><p class="paragraph"/>你可以使用 <code>server.port</code> 参数来指定不同的端口，比如：<p class="paragraph"/><div class="code"><pre>grails &#45;Dserver.port=8090 run&#45;app</pre></div><p class="paragraph"/>提示！你最好在交互模式中启动你的应用，因为其容器的重新启动将更快，如下：<p class="paragraph"/><div class="code"><pre>$ grails
grails&#62; run&#45;app
| Server running. Browse to http://localhost:8080/helloworld
| Application loaded in interactive mode. Type 'exit' to shutdown.
| Downloading: plugins&#45;list.xml
grails&#62; exit
| Stopping Grails server
grails&#62; run&#45;app
| Server running. Browse to http://localhost:8080/helloworld
| Application loaded in interactive mode. Type 'exit' to shutdown.
| Downloading: plugins&#45;list.xml</pre></div><p class="paragraph"/>关于<a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>命令的更多信息，在本手册的参考指南中有介绍。


<a name="2.8 Testing an Application"><!-- Legacy link --></a>
<h2 id="testingAnApplication">2.10 测试应用</h2>
<div class="hidden-block">
The <code>create-*</code> commands in Grails automatically create unit or integration tests for you within the <code>test/unit</code> or <code>test/integration</code> directory. It is of course up to you to populate these tests with valid test logic, information on which can be found in the section on <a href="../guide/single.html#testing" class="guide">Testing</a>.<p class="paragraph"/>To execute tests you run the <a href="../ref/Command Line/test-app.html" class="commandLine">test-app</a> command as follows:<p class="paragraph"/><div class="code"><pre>grails test&#45;app</pre></div>
</div><p class="paragraph"/>那些 <code>create-*</code> 命令将会在你的 <code>test/unit</code> 或者 <code>test/integration</code> 目录下自动创建单元或者集成测试，当然了，这些验证这些测试的逻辑还是需要你来处理的，更多信息可以在<a href="../guide/single.html#testing" class="guide">测试</a>章节中找到。<p class="paragraph"/>执行这些测试，只需要输入<a href="../ref/Command Line/test-app.html" class="commandLine">test-app</a>命令即可，比如：<p class="paragraph"/><div class="code"><pre>grails test&#45;app</pre></div>


<a name="2.9 Deploying an Application"><!-- Legacy link --></a>
<h2 id="deployingAnApplication">2.11 部署应用</h2>
<div class="hidden-block">
Grails applications are deployed as Web Application Archives (WAR files), and Grails includes the <a href="../ref/Command Line/war.html" class="commandLine">war</a> command for performing this task:<p class="paragraph"/><div class="code"><pre>grails war</pre></div><p class="paragraph"/>This will produce a WAR file under the <code>target</code> directory which can then be deployed as per your container's instructions.<p class="paragraph"/>Unlike most scripts which default to the <code>development</code> environment unless overridden, the <code>war</code> command runs in the <code>production</code> environment by default. You can override this like any script by specifying the environment name, for example:<p class="paragraph"/><div class="code"><pre>grails dev war</pre></div><p class="paragraph"/><blockquote class="warning">
NEVER deploy Grails using the <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a> command as this command sets Grails up for auto-reloading at runtime which has a severe performance and scalability implications
</blockquote><p class="paragraph"/>When deploying Grails you should always run your containers JVM with the <code>-server</code> option and with sufficient memory allocation. A good set of VM flags would be:<p class="paragraph"/><div class="code"><pre>&#45;server &#45;Xmx512M &#45;XX:MaxPermSize=256m</pre></div>
</div><p class="paragraph"/>Grails应用程序以Web应用归档（WAR）文件的形式进行部署，因此Grails提供了<a href="../ref/Command Line/war.html" class="commandLine">war</a>命令，执行如下命令：<p class="paragraph"/><div class="code"><pre>grails war</pre></div><p class="paragraph"/>将会在 <code>target</code> 目录下产生一个WAR文件，可以根据不同的服务器容器进行相应地部署。<p class="paragraph"/>跟运行在 <code>development</code> 环境下的大多数其他命令脚本不同， <code>war</code> 命令缺省是运行在 <code>production</code> 环境中的，当然，你也可以通过指定环境名称的方式来覆盖任意脚本缺省环境，比如：<p class="paragraph"/><div class="code"><pre>grails dev war</pre></div><p class="paragraph"/><blockquote class="warning">
一定不要使用run-app命令来部署Grails，因为此命令会在运行时自动加载，这样会对服务器的性能和可扩展性有严重影响。
</blockquote><p class="paragraph"/>部署Grails的时候，你要确保你容器的JVM总是使用 <code>-server</code> 选项，并且还有有足够的内存。推荐的VM参数如下：<p class="paragraph"/><div class="code"><pre>&#45;server &#45;Xmx512M &#45;XX:MaxPermSize=256m</pre></div>


<a name="2.10 Supported Java EE Containers"><!-- Legacy link --></a>
<h2 id="supportedJavaEEContainers">2.12 所支持的Java EE容器</h2>
<div class="hidden-block">
Grails runs on any container that supports Servlet 2.5 and above and is known to work on the following specific container products:
<ul class="star">
<li>Tomcat 7</li>
<li>Tomcat 6</li>
<li>SpringSource tc Server</li>
<li>Eclipse Virgo</li>
<li>GlassFish 3</li>
<li>GlassFish 2</li>
<li>Resin 4</li>
<li>Resin 3</li>
<li>JBoss 6</li>
<li>JBoss 5</li>
<li>Jetty 7</li>
<li>Jetty 6</li>
<li>IBM Websphere 7.0</li>
<li>IBM Websphere 6.1</li>
<li>Oracle Weblogic 10.3</li>
<li>Oracle Weblogic 10</li>
<li>Oracle Weblogic 9</li>
</ul><p class="paragraph"/>Some containers have bugs however, which in most cases can be worked around. A <a href="http://grails.org/Deployment" target="blank">list of known deployment issues</a> can be found on the Grails wiki.
</div><p class="paragraph"/>Grails可以运行于任何支持Servlet 2.5及其以上的容器，以下这些特定容器已经测试可以工作：
<ul class="star">
<li>Tomcat 7</li>
<li>Tomcat 6</li>
<li>SpringSource tc Server</li>
<li>Eclipse Virgo</li>
<li>GlassFish 3</li>
<li>GlassFish 2</li>
<li>Resin 4</li>
<li>Resin 3</li>
<li>JBoss 6</li>
<li>JBoss 5</li>
<li>Jetty 7</li>
<li>Jetty 6</li>
<li>IBM Websphere 7.0</li>
<li>IBM Websphere 6.1</li>
<li>Oracle Weblogic 10.3</li>
<li>Oracle Weblogic 10</li>
<li>Oracle Weblogic 9</li>
</ul><p class="paragraph"/>虽然有些容器还有问题，但是大部分情况是可以解决的。在Grails中可以找到<a href="http://grails.org/Deployment" target="blank">已知部署问题列表</a>。


<a name="2.11 Generating an Application"><!-- Legacy link --></a>
<h2 id="generatingAnApplication">2.13 生成应用</h2>
<div class="hidden-block">
To get started quickly with Grails it is often useful to use a feature called <a href="../guide/single.html#scaffolding" class="guide">Scaffolding</a> to generate the skeleton of an application. To do this use one of the <code>generate-*</code> commands such as <a href="../ref/Command Line/generate-all.html" class="commandLine">generate-all</a>, which will generate a <a href="../guide/single.html#controllers" class="guide">controller</a> (and its unit test) and the associated <a href="../guide/single.html#gsp" class="guide">views</a>:<p class="paragraph"/><div class="code"><pre>grails generate&#45;all Book</pre></div>
</div><p class="paragraph"/>在创建完Grails应用后，通常会使用<a href="../guide/single.html#scaffolding" class="guide">脚手架</a>来生成整个应用程序的骨架。这是通过使用 <code>generate-*</code> 命令来完成的，例如使用<a href="../ref/Command Line/generate-all.html" class="commandLine">generate-all</a>命令来生成<a href="../guide/single.html#controllers" class="guide">控制器</a>（包括单元测试）及相应<a href="../guide/single.html#gsp" class="guide">视图</a><p class="paragraph"/><div class="code"><pre>grails generate&#45;all Book</pre></div>


<a name="2.12 Creating Artefacts"><!-- Legacy link --></a>
<h2 id="creatingArtefacts">2.14 创建工件</h2>
<div class="hidden-block">
Grails ships with a few convenience targets such as <a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a>, <a href="../ref/Command Line/create-domain-class.html" class="commandLine">create-domain-class</a> and so on that will create <a href="../guide/single.html#controllers" class="guide">Controllers</a> and different artefact types for you.
<blockquote class="note">
These are just for your convenience and you can just as easily use an IDE or your favourite text editor.
</blockquote>
For example to create the basis of an application you typically need a <a href="../guide/single.html#GORM" class="guide">domain model</a>:<p class="paragraph"/><div class="code"><pre>grails create&#45;domain&#45;class book</pre></div><p class="paragraph"/>This will result in the creation of a domain class at <code>grails-app/domain/Book.groovy</code> such as:<p class="paragraph"/><div class="code"><pre>class Book &#123;
&#125;</pre></div><p class="paragraph"/>There are many such <code>create-*</code> commands that can be explored in the command line reference guide.<p class="paragraph"/><blockquote class="note">
To decrease the amount of time it takes to run Grails scripts, use the <a href="../ref/Command Line/interactive.html" class="commandLine">interactive</a> mode.
</blockquote><p class="paragraph"/></div><p class="paragraph"/>Grails还为我们提供了像<a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a>、 <a href="../ref/Command Line/create-domain-class.html" class="commandLine">create-domain-class</a>等命令，以方便地创建<a href="../guide/single.html#controllers" class="guide">控制器</a>和其他的工件类型。
<blockquote class="note">
这些仅仅是方便而已，你依然可以轻松的使用IDE或者你自己喜爱的文本编辑器（比如记事本、TextMate、VIM等--译者注）。
</blockquote>
以创建一个基本的应用为例，你通常至少需要一个<a href="../guide/single.html#GORM" class="guide">领域模型</a>，比如：<p class="paragraph"/><div class="code"><pre>grails create&#45;domain&#45;class book</pre></div><p class="paragraph"/>将会在 <code>grails-app/domain/Book.groovy</code> 中创建一个如下所示的领域类：<p class="paragraph"/><div class="code"><pre>class Book &#123;
&#125;</pre></div><p class="paragraph"/>在命令行参考指南中，你还可以看到更多 <code>create-*</code> 命令。<p class="paragraph"/><blockquote class="note">
为了减少Grails脚本的运行时间，请使用commandLine模式。
</blockquote>


<a name="3. Configuration"><!-- Legacy link --></a>
<h1 id="conf">3 配置</h1>
<div class="hidden-block">
It may seem odd that in a framework that embraces "convention-over-configuration" that we tackle this topic now, but since what configuration there is typically a one-off, it is best to get it out the way.<p class="paragraph"/>With Grails' default settings you can actually develop an application without doing any configuration whatsoever. Grails ships with an embedded servlet container and in-memory H2 database, so there isn't even a database to set up.<p class="paragraph"/>However, typically you should configure a more robust database at some point and that is described in the following section.
</div><p class="paragraph"/>也许在这里谈论配置对于一个遵循“规约优于配置”的框架来说，会让人感到比较奇怪，但是实际上我们这里所说的配置是两个不同的概念，请不要混淆。<p class="paragraph"/>实际上Grails的默认配置已经足以我们进行开发，并且它内置了容器和内存模式的H2数据库，这样我们几乎连数据库都不用配置了。<p class="paragraph"/>不过，在将来你肯定是想要配置一个真正的数据库的，下面的章节将介绍如何实现。


<a name="3.1 Basic Configuration"><!-- Legacy link --></a>
<h2 id="config">3.1 基本配置</h2>
<div class="hidden-block">
For general configuration Grails provides a file called <code>grails-app/conf/Config.groovy</code>. This file uses Groovy's <a href="http://groovy.codehaus.org/ConfigSlurper" target="blank">ConfigSlurper</a> which is very similar to Java properties files except it is pure Groovy hence you can reuse variables and use proper Java types!<p class="paragraph"/>You can add your own configuration in here, for example:<p class="paragraph"/><div class="code"><pre>foo.bar.hello = <span class="java&#45;quote">"world"</span></pre></div><p class="paragraph"/>Then later in your application you can access these settings in one of two ways. The most common is from the <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> object, which is available as a variable in controllers and tag libraries:<p class="paragraph"/><div class="code"><pre>assert <span class="java&#45;quote">"world"</span> == grailsApplication.config.foo.bar.hello</pre></div><p class="paragraph"/>The other way involves getting a reference to the <a href="../../api/org/codehaus/groovy/grails/commons/ConfigurationHolder.html" class="api">ConfigurationHolder</a> class that holds a reference to the configuration object:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.commons.&#42;
&#8230;
def config = ConfigurationHolder.config
assert <span class="java&#45;quote">"world"</span> == config.foo.bar.hello</pre></div><p class="paragraph"/><blockquote class="warning">
ConfigurationHolder and ApplicationHolder are deprecated and will be removed in a future version of Grails, so it is highly preferable to access the <code>GrailsApplication</code> and config from the <code>grailsApplication</code> variable.
</blockquote>
</div><p class="paragraph"/>Grails提供了一个 <code>grails-app/conf/Config.groovy</code> 配置文件，用来完成通用的配置。此文件除了是Groovy的<a href="http://groovy.codehaus.org/ConfigSlurper" target="blank">ConfigSlurper</a> 之外，其他非常类似于Java属性文件，这样就既可以重用变量又可以使用合适的Java类！<p class="paragraph"/>你可以添加属于你自己的配置信息，例如：<p class="paragraph"/><div class="code"><pre>foo.bar.hello = <span class="java&#45;quote">"world"</span></pre></div><p class="paragraph"/>在你随后的应用中，你可以使用以下两种方法中的一种来访问这些配置。最常用的就是 <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> 对象，不过此对象仅在控制器和标签库中有效。比如：<p class="paragraph"/><div class="code"><pre>assert <span class="java&#45;quote">"world"</span> == grailsApplication.config.foo.bar.hello</pre></div><p class="paragraph"/>另外一种方法是获取 <a href="../../api/org/codehaus/groovy/grails/commons/ConfigurationHolder.html" class="api">ConfigurationHolder</a> 类的一个引用，此类中包含着配置对象，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.commons.&#42;
&#8230;
def config = ConfigurationHolder.config
assert <span class="java&#45;quote">"world"</span> == config.foo.bar.hello</pre></div><p class="paragraph"/><blockquote class="warning">
ConfigurationHolder和ApplicationHolder现在已经被废弃，并且将在Grails的未来版本中移除，因此强烈推荐采用 <code>GrailsApplication</code> 的实例变量 <code>grailsApplication</code> 方式来访问配置对象。
</blockquote>


<a name="3.1.1 Built in options"><!-- Legacy link --></a>
<h2 id="builtInOptions">3.1.1 内置选项</h2>
<div class="hidden-block">
Grails also provides the following configuration options:
<ul class="star">
<li><code>grails.config.locations</code>  - The location of properties files or addition Grails Config files that should be merged with main configuration</li>
<li><code>grails.enable.native2ascii</code> - Set this to false if you do not require native2ascii conversion of Grails i18n properties files</li>
<li><code>grails.views.default.codec</code> - Sets the default encoding regime for GSPs - can be one of 'none', 'html', or 'base64' (default: 'none'). To reduce risk of XSS attacks, set this to 'html'.</li>
<li><code>grails.views.gsp.encoding</code> - The file encoding used for GSP source files (default is 'utf-8')</li>
<li><code>grails.mime.file.extensions</code> - Whether to use the file extension to dictate the mime type in <a href="../guide/single.html#contentNegotiation" class="guide">Content Negotiation</a></li>
<li><code>grails.mime.types</code> - A map of supported mime types used for <a href="../guide/single.html#contentNegotiation" class="guide">Content Negotiation</a></li>
<li><code>grails.serverURL</code> - A string specifying the server URL portion of absolute links, including server name e.g. grails.serverURL="http://my.yourportal.com". See <a href="../ref/Tags/createLink.html" class="Tags">createLink</a>.</li>
</ul><p class="paragraph"/></div><p class="paragraph"/>Grails同样提供了如下配置选项：
<ul class="star">
<li><code>grails.config.locations</code>  - 配置文件的位置，包括属性文件或者其他需要合并到主配置的Grails配置文件</li>
<li><code>grails.enable.native2ascii</code> - 如果不需要native2ascii来转化Grails i18n属性文件的话，将该选项设为false</li>
<li><code>grails.views.default.codec</code> - 设置GSP的默认编码制式，可以是：'none', 'html', 或者 'base64' (缺省为'none'). 为了减少XSS攻击的风险，建议设置成'html'.</li>
<li><code>grails.views.gsp.encoding</code> - GSP源文件的字符编码（缺省是'utf-8'）</li>
<li><code>grails.mime.file.extensions</code> - 是否使用文件的扩展名表示<a href="../guide/single.html#contentNegotiation" class="guide">内容协商</a>中的媒体类型(mime type)</li>
<li><code>grails.mime.types</code> - <a href="../guide/single.html#contentNegotiation" class="guide">内容协商</a>所支持的媒体类型</li>
<li><code>grails.serverURL</code> - 一个指向服务器URL的绝对地址，包括服务器名称，比如grails.serverURL="http://my.yourportal.com". 详细请看<a href="../ref/Tags/createLink.html" class="Tags">createLink</a>。</li>
</ul><p class="paragraph"/><div class="hidden-block">
<h3>War generation</h3>
<ul class="star">
<li><code>grails.project.war.file</code> - Sets the name and location of the WAR file generated by the <a href="../ref/Command Line/war.html" class="commandLine">war</a> command</li>
<li><code>grails.war.dependencies</code> - A closure containing Ant builder syntax or a list of JAR filenames. Lets you customise what libaries are included in the WAR file.</li>
<li><code>grails.war.copyToWebApp</code> - A closure containing Ant builder syntax that is legal inside an Ant copy, for example "fileset()". Lets you control what gets included in the WAR file from the "web-app" directory.</li>
<li><code>grails.war.resources</code> - A closure containing Ant builder syntax. Allows the application to do any other other work before building the final WAR file</li>
</ul><p class="paragraph"/>For more information on using these options, see the section on <a href="../guide/single.html#deployment" class="guide">deployment</a>
</div><p class="paragraph"/><h3> War生成选项</h3>
<ul class="star">
<li><code>grails.project.war.file</code> - 设置 <a href="../ref/Command Line/war.html" class="commandLine">war</a> 命令生成WAR文件的名称和位置</li>
<li><code>grails.war.dependencies</code> - 符合Ant生成器语法的闭包或者JAR文件的列表,让你可以定制WAR文件所需要的依赖库。</li>
<li><code>grails.war.copyToWebApp</code> - 完成Ant拷贝且满足其生成器语法的闭包，比如"fileset()"。让你控制"web-app"目录下那些资源可以被打包到WAR文件中。</li>
<li><code>grails.war.resources</code> - 符合Ant生成器语法的闭包，运行应用在构建最终的WAR文件前做任何其他的预处理</li>
</ul><p class="paragraph"/>这些选项的更多信息，请参考 <a href="../guide/single.html#deployment" class="guide">部署</a> 章节。


<a name="3.1.2 Logging"><!-- Legacy link --></a>
<h2 id="logging">3.1.2 日志</h2>
<div class="hidden-block">
<h3>The Basics</h3><p class="paragraph"/>Grails uses its common configuration mechanism to provide the settings for the underlying <a href="http://logging.apache.org/log4j/1.2/index.html" target="blank">Log4j</a> log system, so all you have to do is add a <code>log4j</code> setting to the file <code>grails-app/conf/Config.groovy</code>.<p class="paragraph"/>So what does this <code>log4j</code> setting look like? Here's a basic example:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    error  'org.codehaus.groovy.grails.web.servlet',  //  controllers
           'org.codehaus.groovy.grails.web.pages' //  GSP<p class="paragraph"/>    warn   'org.apache.catalina'
&#125;</pre></div><p class="paragraph"/>This says that for loggers whose name starts with 'org.codehaus.groovy.grails.web.servlet' or 'org.codehaus.groovy.grails.web.pages', only messages logged at 'error' level and above will be shown. Loggers with names starting with 'org.apache.catalina' logger only show messages at the 'warn' level and above. What does that mean? First of all, you have to understand how levels work.
</div><p class="paragraph"/><h3>基础</h3><p class="paragraph"/>Grails利用其自身的配置机制来提供对 <a href="http://logging.apache.org/log4j/1.2/index.html" target="blank">Log4j</a> 日志系统的配置，因此你所需要做的只是将<code>log4j</code>配置添加到<code>grails-app/conf/Config.groovy</code>配置文件中。<p class="paragraph"/>那么<code>log4j</code>该配置什么样子呢？下边是一个基础的示例：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    error  'org.codehaus.groovy.grails.web.servlet',  //  controllers
           'org.codehaus.groovy.grails.web.pages' //  GSP<p class="paragraph"/>    warn   'org.apache.catalina'
&#125;</pre></div><p class="paragraph"/>在上述示例中，那些名称以'org.codehaus.groovy.grails.web.servlet'或者'org.codehaus.groovy.grails.web.pages'开头的记录器，仅仅记录级别高于或等于'error'的信息；而名字以'org.apache.catalina'开始的记录器仅仅记录级别高于或等于'warn'的信息。要了解此中的意义，首先要知道日志级别是如何工作的。<p class="paragraph"/><div class="hidden-block">
<h4>Logging levels</h4><p class="paragraph"/>The are several standard logging levels, which are listed here in order of descending priority:
<ol>
<li>off</li>
<li>fatal</li>
<li>error</li>
<li>warn</li>
<li>info</li>
<li>debug</li>
<li>trace</li>
<li>all</li>
</ol><p class="paragraph"/>When you log a message, you implicitly give that message a level. For example, the method <code>log.error(msg)</code> will log a message at the 'error' level. Likewise, <code>log.debug(msg)</code> will log it at 'debug'. Each of the above levels apart from 'off' and 'all' have a corresponding log method of the same name.<p class="paragraph"/>The logging system uses that  <em class="italic">message</em>  level combined with the configuration for the logger (see next section) to determine whether the message gets written out. For example, if you have an 'org.example.domain' logger configured like so:<p class="paragraph"/><div class="code"><pre>warn 'org.example.domain'</pre></div><p class="paragraph"/>then messages with a level of 'warn', 'error', or 'fatal' will be written out. Messages at other levels will be ignored.<p class="paragraph"/>Before we go on to loggers, a quick note about those 'off' and 'all' levels. These are special in that they can only be used in the configuration; you can't log messages at these levels. So if you configure a logger with a level of 'off', then no messages will be written out. A level of 'all' means that you will see all messages. Simple.
</div><p class="paragraph"/><h4>日志级别</h4><p class="paragraph"/>以下是按照优先级降序（由高到低）排列的标准日志级别：
<ol>
<li>off</li>
<li>fatal</li>
<li>error</li>
<li>warn</li>
<li>info</li>
<li>debug</li>
<li>trace</li>
<li>all</li>
</ol><p class="paragraph"/>当你记录一条消息的时候，已经暗含地给此消息指定了级别，比如<code>log.error(msg)</code>方法，就是使用其'error'级别，同理<code>log.debug(msg)</code>指定的是'debug'。上述从'off'到'all'的级别都有一个同名对应的日志方法。<p class="paragraph"/>日志系统使用记录器（介绍见下一节）配置的  <em class="italic">message</em>  级别来判断此消息是否应该输出，比如你有一个'org.example.domain'记录器，其配置如下：<p class="paragraph"/><div class="code"><pre>warn 'org.example.domain'</pre></div><p class="paragraph"/>那么级别是'warn'、'error'或者'fatal'的消息都将会输出，而其他级别的都将被忽略。<p class="paragraph"/>在我们继续记录器以前，我们需要对'off'和'all'的级别做一个小关注，它们都只能在配置中使用，你不能使用它们记录任何日志信息。因此如果你将级别配置为'off'，那么将不会有任何信息输出，而配置为'all'意味着你将看到所有的日志信息。<p class="paragraph"/><div class="hidden-block">
<h4>Loggers</h4><p class="paragraph"/>Loggers are fundamental to the logging system, but they are a source of some confusion. For a start, what are they? Are they shared? How do you configure them?<p class="paragraph"/>A logger is the object you log messages to, so in the call <code>log.debug(msg)</code>, <code>log</code> is a logger instance (of type <a href="http://commons.apache.org/logging/apidocs/org/apache/commons/logging/Log.html" target="blank">Log</a>). These loggers are cached and uniquely identified by name, so if two separate classes use loggers with the same name, those loggers are actually the same instance.<p class="paragraph"/>There are two main ways to get hold of a logger:
<ol>
<li>use the <code>log</code> instance injected into artifacts such as domain classes, controllers and services;</li>
<li>use the Commons Logging API directly.</li>
</ol><p class="paragraph"/>If you use the dynamic <code>log</code> property, then the name of the logger is 'grails.app.&#60;type&#62;.&#60;className&#62;', where <code>type</code> is the type of the artifact, for example 'controller' or 'service, and <code>className</code> is the fully qualified name of the artifact. For example, if you have this service:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.example<p class="paragraph"/>class MyService &#123;
    &#8230;
&#125;</pre></div><p class="paragraph"/>then the name of the logger will be 'grails.app.service.org.example.MyService'.<p class="paragraph"/>For other classes, the typical approach is to store a logger based on the class name in a constant static field:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.other<p class="paragraph"/><span class="java&#45;keyword">import</span> org.apache.commons.logging.LogFactory<p class="paragraph"/>class MyClass &#123;
    <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> log = LogFactory.getLog(<span class="java&#45;keyword">this</span>)
    &#8230;
&#125;</pre></div><p class="paragraph"/>This will create a logger with the name 'org.other.MyClass' - note the lack of a 'grails.app.' prefix since the class isn't an artifact. You can also pass a name to the <code>getLog()</code> method, such as "myLogger", but this is less common because the logging system treats names with dots ('.') in a special way.
</div><p class="paragraph"/><h4>记录器（Loggers）</h4><p class="paragraph"/>记录器是日志系统的基础，但是依然有一些根源上的困惑，比如它们是什么？可否共享？以及如何配置它们？<p class="paragraph"/>一个记录器就是你要将信息记录进去的对象，因此<code>log.debug(msg)</code>中的<code>log</code>就是一个记录器实例（其类型是<a href="http://commons.apache.org/logging/apidocs/org/apache/commons/logging/Log.html" target="blank">Log</a>）. 这些记录器通过唯一的名字标识被缓存起来，因此如果两个不同的类使用同一个名字的记录器，那么这些记录器是同一个运行实例。<p class="paragraph"/>主要有两种方法来获取一个记录器：
<ol>
<li>使用注入到工件（比如领域类、控制器以及服务）中的<code>log</code>实例</li>
<li>直接使用Commons Logging API。</li>
</ol><p class="paragraph"/>如果你使用动态的<code>log</code>属性，那么记录器的名字是'grails.app.&#60;type&#62;.&#60;className&#62;'，此处的<code>type</code>是工件的类型，比如'controller'或者'service'，而<code>className</code>则是此工件的全名，假设你有如下的一个服务：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.example<p class="paragraph"/>class MyService &#123;
    &#8230;
&#125;</pre></div><p class="paragraph"/>那么上述记录器的名字是'grails.app.service.org.example.MyService'。<p class="paragraph"/>对其他类来说，典型的方法是将记录器作为此类的一个静态常量字段，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.other<p class="paragraph"/><span class="java&#45;keyword">import</span> org.apache.commons.logging.LogFactory<p class="paragraph"/>class MyClass &#123;
    <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> log = LogFactory.getLog(<span class="java&#45;keyword">this</span>)
    &#8230;
&#125;</pre></div><p class="paragraph"/>上述代码中将创建一个名字为'org.other.MyClass'的记录器，注意：此处并没有'grails.app.'前缀，因为此类不是一个Grails工件。你还可以一个自定义的名字（比如"myLogger"）给<code>getLog()</code>方法，但是这种用法并不常见，因为在日志系统中，名字中的点（'.'）是被特殊处理的。<p class="paragraph"/><div class="hidden-block">
<h4>Configuring loggers</h4><p class="paragraph"/>You have already seen how to configure loggers in Grails:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    error  'org.codehaus.groovy.grails.web.servlet'
&#125;</pre></div><p class="paragraph"/>This example configures loggers with names starting with 'org.codehaus.groovy.grails.web.servlet' to ignore any messages sent to them at a level of 'warn' or lower. But is there a logger with this name in the application? No. So why have a configuration for it? Because the above rule applies to any logger whose name  <em class="italic">begins with</em>  'org.codehaus.groovy.grails.servlet.' as well. For example, the rule applies to both the <code>org.codehaus.groovy.grails.web.servlet.GrailsDispatcherServlet</code> class and the <code>org.codehaus.groovy.grails.web.servlet.mvc.GrailsWebRequest</code> one.<p class="paragraph"/>In other words, loggers are hierarchical. This makes configuring them by package much simpler than it would otherwise be.<p class="paragraph"/>The most common things that you will want to capture log output from are your controllers, services, and other artifacts. Use the convention mentioned earlier to do that:  <em class="italic">grails.app.&#60;artifactType&#62;.&#60;className&#62;</em> . In particular the class name must be fully qualifed, i.e. with the package if there is one:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    // Set level <span class="java&#45;keyword">for</span> all application artifacts
    info <span class="java&#45;quote">"grails.app"</span><p class="paragraph"/>    // Set <span class="java&#45;keyword">for</span> a specific controller in the <span class="java&#45;keyword">default</span> <span class="java&#45;keyword">package</span>
    debug <span class="java&#45;quote">"grails.app.controllers.YourController"</span><p class="paragraph"/>    // Set <span class="java&#45;keyword">for</span> a specific domain class
    debug <span class="java&#45;quote">"grails.app.domain.org.example.Book"</span><p class="paragraph"/>    // Set <span class="java&#45;keyword">for</span> all taglibs
    info <span class="java&#45;quote">"grails.app.taglib"</span>
&#125;</pre></div><p class="paragraph"/>The standard artifact names used in the logging configuration are:
<ul class="star">
<li><code>conf</code> - For anything under <code>grails-app/conf</code> such as <code>BootStrap.groovy</code> (but excluding filters)</li>
<li><code>filters</code> - For filters</li>
<li><code>taglib</code> - For tag libraries</li>
<li><code>services</code> - For service classes</li>
<li><code>controllers</code> - For controllers</li>
<li><code>domain</code> - For domain entities</li>
</ul><p class="paragraph"/>Grails itself generates plenty of logging information and it can sometimes be helpful to see that. Here are some useful loggers from Grails internals that you can use, especially when tracking down problems with your application:
<ul class="star">
<li><code>org.codehaus.groovy.grails.commons</code> - Core artifact information such as class loading etc.</li>
<li><code>org.codehaus.groovy.grails.web</code> - Grails web request processing</li>
<li><code>org.codehaus.groovy.grails.web.mapping</code> - URL mapping debugging</li>
<li><code>org.codehaus.groovy.grails.plugins</code> - Log plugin activity</li>
<li><code>grails.spring</code> - See what Spring beans Grails and plugins are defining</li>
<li><code>org.springframework</code> - See what Spring is doing</li>
<li><code>org.hibernate</code> - See what Hibernate is doing</li>
</ul><p class="paragraph"/>So far, we've only looked at explicit configuration of loggers. But what about all those loggers that  <em class="italic">don't</em>  have an explicit configuration? Are they simply ignored? The answer lies with the root logger.
</div><p class="paragraph"/><h4>配置记录器</h4><p class="paragraph"/>你已在Grails中看到如何配置记录器了，比如：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    error  'org.codehaus.groovy.grails.web.servlet'
&#125;</pre></div><p class="paragraph"/>此示例中，名字以'org.codehaus.groovy.grails.web.servlet'开始的记录器将忽略所有'warn'级别以下的消息。打住，在你的应用中真有此名字的记录器么？没有，那我们为什么要这样配置它呢？因为上述的规则将应用于任何以'org.codehaus.groovy.grails.servlet.'_开始_的记录器，比如类<code>org.codehaus.groovy.grails.web.servlet.GrailsDispatcherServlet</code>和<code>org.codehaus.groovy.grails.web.servlet.mvc.GrailsWebRequest</code>。<p class="paragraph"/>换句话说，记录器是分层级的，这使得用包名来配置比其他方式容易很多。<p class="paragraph"/>在应用中，你最常记录的是控制器、服务以及其他工件的输出日志，这可以通过以前提到过的_grails.app.&#60;artifactType&#62;.&#60;className&#62;_来实现。需要注意的是类名必须是全名（包括包名），如下所示：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    // Set level <span class="java&#45;keyword">for</span> all application artifacts
    info <span class="java&#45;quote">"grails.app"</span><p class="paragraph"/>    // Set <span class="java&#45;keyword">for</span> a specific controller in the <span class="java&#45;keyword">default</span> <span class="java&#45;keyword">package</span>
    debug <span class="java&#45;quote">"grails.app.controllers.YourController"</span><p class="paragraph"/>    // Set <span class="java&#45;keyword">for</span> a specific domain class
    debug <span class="java&#45;quote">"grails.app.domain.org.example.Book"</span><p class="paragraph"/>    // Set <span class="java&#45;keyword">for</span> all taglibs
    info <span class="java&#45;quote">"grails.app.taglib"</span>
&#125;</pre></div><p class="paragraph"/>在日志配置中，常用的标准工件名称如下：
<ul class="star">
<li><code>conf</code> - <code>grails-app/conf</code>下的任何类（过滤器除外），比如：<code>BootStrap.groovy</code></li>
<li><code>filters</code> - 过滤器</li>
<li><code>taglib</code> - 标签库</li>
<li><code>services</code> - 服务类</li>
<li><code>controllers</code> - 控制器</li>
<li><code>domain</code> - 领域类</li>
</ul><p class="paragraph"/>Grails本身也带有大量的日志信息，有时候这些信息对我们的开发很有裨益，尤其要诊断你应用的问题的时候。以下是一些你可能使用到的内部记录器：
<ul class="star">
<li><code>org.codehaus.groovy.grails.commons</code> - 核心工件信息，比如类加载等</li>
<li><code>org.codehaus.groovy.grails.web</code> - Grails的web请求处理</li>
<li><code>org.codehaus.groovy.grails.web.mapping</code> - 调试URL映射信息</li>
<li><code>org.codehaus.groovy.grails.plugins</code> - 记录插件的活动情况</li>
<li><code>grails.spring</code> - 在Grails和插件中定义的Spring的beans</li>
<li><code>org.springframework</code> - Spring的活动情况</li>
<li><code>org.hibernate</code> - Hibernate的活动情况</li>
</ul><p class="paragraph"/>到目前为止，我们仅仅查看了记录器的显式配置，那么其他那些_没有_明确指定的将是什么情况呢？它们是被简单的忽略了么？请看下面的根记录器小节。<p class="paragraph"/><div class="hidden-block">
<h4>The Root Logger</h4><p class="paragraph"/>All logger objects inherit their configuration from the root logger, so if no explicit configuration is provided for a given logger, then any messages that go to that logger are subject to the rules defined for the root logger. In other words, the root logger provides the default configuration for the logging system.<p class="paragraph"/>Grails automatically configures the root logger to only handle messages at 'error' level and above, and all the messages are directed to the console (stdout for those with a C background). You can customise this behaviour by specifying a 'root' section in your logging configuration like so:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    root &#123;
        info()
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>The above example configures the root logger to log messages at 'info' level and above to the default console appender. You can also configure the root logger to log to one or more named appenders (which we'll talk more about shortly):<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        file name:'file', file:'/<span class="java&#45;keyword">var</span>/logs/mylog.log'
    &#125;
    root &#123;
        debug 'stdout', 'file'
    &#125;
&#125;</pre></div><p class="paragraph"/>In the above example, the root logger will log to two appenders - the default 'stdout' (console) appender and a custom 'file' appender.<p class="paragraph"/>For power users there is an alternative syntax for configuring the root logger: the root <code>org.apache.log4j.Logger</code> instance is passed as an argument to the log4j closure. This lets you work with the logger directly:<p class="paragraph"/><div class="code"><pre>log4j = &#123; root &#45;&#62;
    root.level = org.apache.log4j.Level.DEBUG
    &#8230;
&#125;</pre></div><p class="paragraph"/>For more information on what you can do with this <code>Logger</code> instance, refer to the Log4j API documentation.<p class="paragraph"/>Those are the basics of logging pretty well covered and they are sufficient if you're happy to only send log messages to the console. But what if you want to send them to a file? How do you make sure that messages from a particular logger go to a file but not the console? These questions and more will be answered as we look into appenders.
</div><p class="paragraph"/><h4>根记录器</h4><p class="paragraph"/>所有的记录器对象配置都是从其根记录器继承而来的，因此一个记录器如果没有明确地配置，那么此记录器的任何消息规则都使用其根记录器的定义。或者说，根记录器提供日志系统的缺省配置。<p class="paragraph"/>Grails自动地将根记录器配置成只处理'error'级别地消息，并且将这些消息显示在命令行终端（stdout是从C语言中借鉴而来）中。你可以通过'root'来重新定义其行为，比如：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    root &#123;
        info()
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>上述示例将配置根记录器记录并且输出'info'级别的消息到缺省的字符输出器。你也可以配置根记录器将信息记录到一个或者多个输出器（在下小节中详细讨论）中。比如：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        file name:'file', file:'/<span class="java&#45;keyword">var</span>/logs/mylog.log'
    &#125;
    root &#123;
        debug 'stdout', 'file'
    &#125;
&#125;</pre></div><p class="paragraph"/>在上述示例中，根记录器将记录到两个输出器中：缺省的'stdout'输出器和自定义的'file'输出器。<p class="paragraph"/>对高级用户来说，还有另外一种配置根记录器的方式：传递给log4j闭包的参数root是<code>org.apache.log4j.Logger</code>实例，这让你可以直接操作logger：<p class="paragraph"/><div class="code"><pre>log4j = &#123; root &#45;&#62;
    root.level = org.apache.log4j.Level.DEBUG
    &#8230;
&#125;</pre></div><p class="paragraph"/>更多<code>Logger</code>实例的信息，请参考Log4j API文档。<p class="paragraph"/>如果你仅仅满足于将日志信息输出到字符终端，那么目前所涉及到的基本信息已经足够用的了。但是如果你还想输出到一个文件呢？以及想将特定记录器的信息输出到一个特定文件，而不是字符终端，又该如何做呢？这些疑问将在下一节的输出器中得到解答。<p class="paragraph"/><div class="hidden-block">
<h3>Appenders</h3><p class="paragraph"/>Loggers are a useful mechanism for filtering messages, but they don't physically write the messages anywhere. That's the job of the appender, of which there are various types. For example, there is the default one that writes messages to the console, another that writes them to a file, and several others. You can even create your own appender implementations&#33;<p class="paragraph"/>This diagram shows how they fit into the logging pipeline:<p class="paragraph"/><img border="0" class="center" src="../../img/logging.png"></img><p class="paragraph"/>As you can see, a single logger may have several appenders attached to it. In a standard Grails configuration, the console appender named 'stdout' is attached to all loggers through the default root logger configuration. But that's the only one. Adding more appenders can be done within an 'appenders' block:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        rollingFile name: <span class="java&#45;quote">"myAppender"</span>,
                    maxFileSize: 1024,
                    file: <span class="java&#45;quote">"/tmp/logs/myApp.log"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The following appenders are available by default:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Name</strong></th><th><strong class="bold">Class</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>jdbc</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/jdbc/JDBCAppender.html" target="blank">JDBCAppender</a></td><td>Logs to a JDBC connection.</td></tr><tr class="table-even"><td>console</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/ConsoleAppender.html" target="blank">ConsoleAppender</a></td><td>Logs to the console.</td></tr><tr class="table-odd"><td>file</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/FileAppender.html" target="blank">FileAppender</a></td><td>Logs to a single file.</td></tr><tr class="table-even"><td>rollingFile</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/RollingFileAppender.html" target="blank">RollingFileAppender</a></td><td>Logs to rolling files, for example a new file each day.</td></tr></table><p class="paragraph"/>Each named argument passed to an appender maps to a property of the underlying <a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/Appender.html" target="blank">Appender</a> implementation. So the previous example sets the <code>name</code>, <code>maxFileSize</code> and <code>file</code> properties of the <code>RollingFileAppender</code> instance.<p class="paragraph"/>You can have as many appenders as you like - just make sure that they all have unique names. You can even have multiple instances of the same appender type, for example several file appenders that log to different files.<p class="paragraph"/>If you prefer to create the appender programmatically or if you want to use an appender implementation that's not available in the above syntax, simply declare an <code>appender</code> entry with an instance of the appender you want:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.log4j.&#42;<p class="paragraph"/>log4j = &#123;
    appenders &#123;
        appender <span class="java&#45;keyword">new</span> RollingFileAppender(
                name: <span class="java&#45;quote">"myAppender"</span>,
                maxFileSize: 1024,
                file: <span class="java&#45;quote">"/tmp/logs/myApp.log"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>This approach can be used to configure <code>JMSAppender</code>, <code>SocketAppender</code>, <code>SMTPAppender</code>, and more.<p class="paragraph"/>Once you have declared your extra appenders, you can attach them to specific loggers by passing the name as a key to one of the log level methods from the previous section:<p class="paragraph"/><div class="code"><pre>error myAppender: <span class="java&#45;quote">"grails.app.controllers.BookController"</span></pre></div><p class="paragraph"/>This will ensure that the 'grails.app.controller.BookController' logger sends log messages to 'myAppender' as well as any appenders configured for the root logger. To add more than one appender to the logger, then add them to the same level declaration:<p class="paragraph"/><div class="code"><pre>error myAppender:      <span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
      myFileAppender:  &#91;<span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
                        <span class="java&#45;quote">"grails.app.services.BookService"</span>&#93;,
      rollingFile:     <span class="java&#45;quote">"grails.app.controllers.BookController"</span></pre></div><p class="paragraph"/>The above example also shows how you can configure more than one logger at a time for a given appender (<code>myFileAppender</code>) by using a list.<p class="paragraph"/>Be aware that you can only configure a single level for a logger, so if you tried this code:<p class="paragraph"/><div class="code"><pre>error myAppender:      <span class="java&#45;quote">"grails.app.controllers.BookController"</span>
debug myFileAppender:  <span class="java&#45;quote">"grails.app.controllers.BookController"</span>
fatal rollingFile:     <span class="java&#45;quote">"grails.app.controllers.BookController"</span></pre></div><p class="paragraph"/>you'd find that only 'fatal' level messages get logged for 'grails.app.controllers.BookController'. That's because the last level declared for a given logger wins. What you probably want to do is limit what level of messages an appender writes.<p class="paragraph"/>An appender that is attached to a logger configured with the 'all' level will generate a lot of logging information. That may be fine in a file, but it makes working at the console difficult. So we configure the console appender to only write out messages at 'info' level or above:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"stdout"</span>, threshold: org.apache.log4j.Level.INFO
    &#125;
&#125;</pre></div><p class="paragraph"/>The key here is the <code>threshold</code> argument which determines the cut-off for log messages. This argument is available for all appenders, but do note that you currently have to specify a <code>Level</code> instance - a string such as "info" will not work.
</div><p class="paragraph"/><h3>输出器（Appenders）</h3><p class="paragraph"/>记录器是很好的信息过滤机制，但是它们并不将信息进行任何物理的写操作，这些都是不同类型的输出器所做的事。比如缺省的一个就是将信息输出到字符终端，另外一个输出到一个文件等等，更有甚者，你还可以创建你自己的输出器！<p class="paragraph"/>下图展示了输出器在日志管道系统中的位置：<p class="paragraph"/><img border="0" class="center" src="../../img/logging.png"></img><p class="paragraph"/>如你所见，一个记录器可以挂载多个输出器。 在一个标准的Grails配置中，所有从根记录器而来的记录器都有一个名为'stdout'并唯一的字符终端输出器。你可以通过'appenders'代码块来增加更多的输出器，比如：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        rollingFile name: <span class="java&#45;quote">"myAppender"</span>,
                    maxFileSize: 1024,
                    file: <span class="java&#45;quote">"/tmp/logs/myApp.log"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>以下是缺省情况下，有效输出器的清单：<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">名称</strong></th><th><strong class="bold">类名</strong></th><th><strong class="bold">描述</strong></th></tr><tr class="table-odd"><td>jdbc</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/jdbc/JDBCAppender.html" target="blank">JDBCAppender</a></td><td>记录到JDBC连接。</td></tr><tr class="table-even"><td>console</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/ConsoleAppender.html" target="blank">ConsoleAppender</a></td><td>记录到字符终端。</td></tr><tr class="table-odd"><td>file</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/FileAppender.html" target="blank">FileAppender</a></td><td>记录到一个文件。</td></tr><tr class="table-even"><td>rollingFile</td><td><a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/RollingFileAppender.html" target="blank">RollingFileAppender</a></td><td>记录到滚动文件，比如一天一个新文件。</td></tr></table><p class="paragraph"/>传递给输出器的每一个命名参数都将映射成实现了<a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/Appender.html" target="blank">Appender</a>接口的属性，因此上述的<code>RollingFileAppender</code>的实例中，<code>name</code>、<code>maxFileSize</code>和<code>file</code>都是其属性而已。<p class="paragraph"/>你可以添加任意你需要的输出器，只要确保它们的名字不重复就可以了。同一类型的输出器，你甚至还可以有多个实例，比如将日志内容输出到不同的文件中。<p class="paragraph"/>你如果倾向于手工创建输出器或者你需要的输出器不在上述的列表中，那么你只需简单的声明一个<code>appender</code>代码即可，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.log4j.&#42;<p class="paragraph"/>log4j = &#123;
    appenders &#123;
        appender <span class="java&#45;keyword">new</span> RollingFileAppender(
                name: <span class="java&#45;quote">"myAppender"</span>,
                maxFileSize: 1024,
                file: <span class="java&#45;quote">"/tmp/logs/myApp.log"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>此种方法通常用来配置<code>JMSAppender</code>、<code>SocketAppender</code>和<code>SMTPAppender</code>等输出器。<p class="paragraph"/>一旦你声明了这些额外的输出器，那么你还需要将它们跟特定的记录器进行关联，这可以通过记录器的名称和记录级别来完成，比如：<p class="paragraph"/><div class="code"><pre>error myAppender: <span class="java&#45;quote">"grails.app.controllers.BookController"</span></pre></div><p class="paragraph"/>这样就可以保证记录器'grails.app.controller.BookController'将消息发送到'myAppender'中以及配置在根记录器中的任何输出器，要在记录器中增加更多的输出器，只需要将他们加入到同级别的声明即可，比如：<p class="paragraph"/><div class="code"><pre>error myAppender:      <span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
      myFileAppender:  &#91;<span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
                        <span class="java&#45;quote">"grails.app.services.BookService"</span>&#93;,
      rollingFile:     <span class="java&#45;quote">"grails.app.controllers.BookController"</span></pre></div><p class="paragraph"/>上述示例同时也展示了在一个给定的输出器(<code>myFileAppender</code>)中如何通过列表来配置多个记录器。<p class="paragraph"/>需要注意的是：一个记录器只能配置一个级别，如果你配置了如下的内容：<p class="paragraph"/><div class="code"><pre>error myAppender:      <span class="java&#45;quote">"grails.app.controllers.BookController"</span>
debug myFileAppender:  <span class="java&#45;quote">"grails.app.controllers.BookController"</span>
fatal rollingFile:     <span class="java&#45;quote">"grails.app.controllers.BookController"</span></pre></div><p class="paragraph"/>你将会发现'grails.app.controllers.BookController'记录器只记录'fatal'级别的消息，这是因为最后的级别设置将以前的覆盖掉了。你这样做的意图是想限制输出器的级别。<p class="paragraph"/>一个根'all'级别记录器关联的输出器将记录大量的日志信息，如果记录在文件中，也许还能忍受，但在字符终端完全是另外一回事。因此我们需要将字符终端的输出器只记录'info'及其级别以上内容：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"stdout"</span>, threshold: org.apache.log4j.Level.INFO
    &#125;
&#125;</pre></div><p class="paragraph"/>此处的<code>threshold</code>参数用以判断那些消息需要截去。此参数对所有的输出器有效，但需要注意的是你必须使用<code>Level</code>实例－"info"字符串的便利用法不能工作。<p class="paragraph"/><div class="hidden-block">
<h3>Custom Layouts</h3><p class="paragraph"/>By default the Log4j DSL assumes that you want to use a <a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/PatternLayout.html" target="blank">PatternLayout</a>. However, there are other layouts available including:
<ul class="star">
<li><code>xml</code> - Create an XML log file</li>
<li><code>html</code> - Creates an HTML log file</li>
<li><code>simple</code> - A simple textual log</li>
<li><code>pattern</code> - A Pattern layout</li>
</ul><p class="paragraph"/>You can specify custom patterns to an appender using the <code>layout</code> setting:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"customAppender"</span>,
                layout: pattern(conversionPattern: <span class="java&#45;quote">"%c&#123;2&#125; %m%n"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>This also works for the built-in appender "stdout", which logs to the console:
<div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"stdout"</span>,
                layout: pattern(conversionPattern: <span class="java&#45;quote">"%c&#123;2&#125; %m%n"</span>)
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h3>自定义布局</h3><p class="paragraph"/>多数情况下，Log4j DSL使用缺省的<a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/PatternLayout.html" target="blank">PatternLayout</a>，除此之外，还有以下布局可以选择：
<ul class="star">
<li><code>xml</code> - 创建一个XML日志文件</li>
<li><code>html</code> - 创建一个HTML日志文件</li>
<li><code>simple</code> - 简单的文本文件</li>
<li><code>pattern</code> - Pattern布局的文件</li>
</ul><p class="paragraph"/>你可以通过<code>layout</code>来给一个输出器自定义布局：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"customAppender"</span>,
                layout: pattern(conversionPattern: <span class="java&#45;quote">"%c&#123;2&#125; %m%n"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>此配置对内置的"stdout"（输出到字符终端）也有效：
<div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"stdout"</span>,
                layout: pattern(conversionPattern: <span class="java&#45;quote">"%c&#123;2&#125; %m%n"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Environment-specific configuration</h3><p class="paragraph"/>Since the logging configuration is inside <code>Config.groovy</code>, you can put it inside an environment-specific block. However, there is a problem with this approach: you have to provide the full logging configuration each time you define the <code>log4j</code> setting. In other words, you cannot selectively override parts of the configuration - it's all or nothing.<p class="paragraph"/>To get around this, the logging DSL provides its own environment blocks that you can put anywhere in the configuration:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"stdout"</span>,
                layout: pattern(conversionPattern: <span class="java&#45;quote">"%c&#123;2&#125; %m%n"</span>)<p class="paragraph"/>        environments &#123;
            production &#123;
                rollingFile name: <span class="java&#45;quote">"myAppender"</span>, maxFileSize: 1024,
                            file: <span class="java&#45;quote">"/tmp/logs/myApp.log"</span>
            &#125;
        &#125;
    &#125;<p class="paragraph"/>    root &#123;
        //&#8230;
    &#125;<p class="paragraph"/>    // other shared config
    info <span class="java&#45;quote">"grails.app.controllers"</span><p class="paragraph"/>    environments &#123;
        production &#123;
            // Override previous setting <span class="java&#45;keyword">for</span> 'grails.app.controllers'
            error <span class="java&#45;quote">"grails.app.controllers"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>The one place you can't put an environment block is  <em class="italic">inside</em>  the <code>root</code> definition, but you can put the <code>root</code> definition inside an environment block.
</div><p class="paragraph"/><h3>特定环境的配置</h3><p class="paragraph"/>既然日志是配置在<code>Config.groovy</code>中，你自然也就可以将其配置在环境相关的代码块中。不过这种方式有一个小问题：每次你配置<code>log4j</code>的时候，你必须提供完整的日志配置。或者换句话说，你不能选择性的覆盖部分配置－要么全覆盖要么一点也不覆盖。<p class="paragraph"/>为了避免此问题，日志DSL提供了自己的environment代码块配置，这样你就可以自由的配置了。<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        console name: <span class="java&#45;quote">"stdout"</span>,
                layout: pattern(conversionPattern: <span class="java&#45;quote">"%c&#123;2&#125; %m%n"</span>)<p class="paragraph"/>        environments &#123;
            production &#123;
                rollingFile name: <span class="java&#45;quote">"myAppender"</span>, maxFileSize: 1024,
                            file: <span class="java&#45;quote">"/tmp/logs/myApp.log"</span>
            &#125;
        &#125;
    &#125;<p class="paragraph"/>    root &#123;
        //&#8230;
    &#125;<p class="paragraph"/>    // other shared config
    info <span class="java&#45;quote">"grails.app.controllers"</span><p class="paragraph"/>    environments &#123;
        production &#123;
            // Override previous setting <span class="java&#45;keyword">for</span> 'grails.app.controllers'
            error <span class="java&#45;quote">"grails.app.controllers"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>此处需要注意的是：你不能将environment代码块放在<code>root</code>定义的_内部_，但是你可以将其放在environment代码块中。<p class="paragraph"/><div class="hidden-block">
<h3>Full stacktraces</h3><p class="paragraph"/>When exceptions occur, there can be an awful lot of noise in the stacktrace from Java and Groovy internals. Grails filters these typically irrelevant details and restricts traces to non-core Grails/Groovy class packages.<p class="paragraph"/>When this happens, the full trace is always logged to the <code>StackTrace</code> logger, which by default writes its output to a file called <code>stacktrace.log</code>. As with other loggers though, you can change its behaviour in the configuration. For example if you prefer full stack traces to go to the console, add this entry:<p class="paragraph"/><div class="code"><pre>error stdout: <span class="java&#45;quote">"StackTrace"</span></pre></div><p class="paragraph"/>This won't stop Grails from attempting to create the stacktrace.log file - it just redirects where stack traces are written to. An alternative approach is to change the location of the 'stacktrace' appender's file:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        rollingFile name: <span class="java&#45;quote">"stacktrace"</span>, maxFileSize: 1024,
                    file: <span class="java&#45;quote">"/<span class="java&#45;keyword">var</span>/tmp/logs/myApp&#45;stacktrace.log"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>or, if you don't want to the 'stacktrace' appender at all, configure it as a 'null' appender:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        '<span class="java&#45;keyword">null</span>' name: <span class="java&#45;quote">"stacktrace"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>You can of course combine this with attaching the 'stdout' appender to the 'StackTrace' logger if you want all the output in the console.<p class="paragraph"/>Finally, you can completely disable stacktrace filtering by setting the <code>grails.full.stacktrace</code> VM property to <code>true</code>:<p class="paragraph"/><div class="code"><pre>grails &#45;Dgrails.full.stacktrace=<span class="java&#45;keyword">true</span> run&#45;app</pre></div>
</div><p class="paragraph"/><h3>完整的栈跟踪</h3><p class="paragraph"/>当一个异常发生时，可能有大量的来自Java和Groovy内部栈跟踪信息，这其实是很恼人的。Grails的过滤器将这些不相干的细节屏蔽了，并且将栈的跟踪信息限制非Grails/Groovy的类包范围。<p class="paragraph"/>当异常发生时，完整的跟踪信息总是被记录到<code>StackTrace</code>记录器中，此记录器缺省将内容输出到一个名为<code>stacktrace.log</code>的文件中。跟其他的记录器配合，你还可以改变其在配置中的行为，比如你可以将栈跟踪信息输出到字符终端：<p class="paragraph"/><div class="code"><pre>error stdout: <span class="java&#45;quote">"StackTrace"</span></pre></div><p class="paragraph"/>此动作不会阻止Grails创建stacktrace.log文件－它只是将栈跟踪重定向了而已。此外你还可以修改'stacktrace'输出器的位置信息，比如：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        rollingFile name: <span class="java&#45;quote">"stacktrace"</span>, maxFileSize: 1024,
                    file: <span class="java&#45;quote">"/<span class="java&#45;keyword">var</span>/tmp/logs/myApp&#45;stacktrace.log"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>或者，你根本就不想输出'stacktrace'，只需要将其输出器配置为'null'即可：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        '<span class="java&#45;keyword">null</span>' name: <span class="java&#45;quote">"stacktrace"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>你如果想在字符终端看到所有的输出，你可以通过将'StackTrace'记录器和'stdout'输出器关联合并来实现。<p class="paragraph"/>最后，你如果想完全禁止栈跟踪的过滤，可以通过设置VM属性：<code>grails.full.stacktrace</code>为<code>true</code>来实现，比如：<p class="paragraph"/><div class="code"><pre>grails &#45;Dgrails.full.stacktrace=<span class="java&#45;keyword">true</span> run&#45;app</pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Masking Request Parameters From Stacktrace Logs</h3><p class="paragraph"/>When Grails logs a stacktrace, the log message may include the names and values of all of the request parameters for the current request.  To mask out the values of secure request parameters, specify the parameter names in the <code>grails.exceptionresolver.params.exclude</code> config property:<p class="paragraph"/><div class="code"><pre>grails.exceptionresolver.params.exclude = &#91;'password', 'creditCard'&#93;</pre></div><p class="paragraph"/>Request parameter logging may be turned off altogether by setting the <code>grails.exceptionresolver.logRequestParameters</code> config property to <code>false</code>.  The default value is <code>true</code> when the application is running in DEVELOPMENT mode and <code>false</code> for all other modes.<p class="paragraph"/><div class="code"><pre>grails.exceptionresolver.logRequestParameters=<span class="java&#45;keyword">false</span></pre></div>
</div><p class="paragraph"/><h3>屏蔽栈跟踪日志中的请求参数</h3><p class="paragraph"/>当Grails记录栈跟踪信息的时候，有可能将当前请求参数的名称和值一并包含了。为了避免隐私信息被记录，可以通过设置<code>grails.exceptionresolver.params.exclude</code>来屏蔽那些有关隐私字段的名称，比如：<p class="paragraph"/><div class="code"><pre>grails.exceptionresolver.params.exclude = &#91;'password', 'creditCard'&#93;</pre></div><p class="paragraph"/>请求参数也可以通过设置<code>grails.exceptionresolver.logRequestParameters</code>为<code>false</code>的方式来禁止掉。其运行于“开发”模式下，缺省值是<code>true</code>，除此之外的其他模式为<code>false</code>。<p class="paragraph"/><div class="code"><pre>grails.exceptionresolver.logRequestParameters=<span class="java&#45;keyword">false</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Logger inheritance</h3><p class="paragraph"/>Earlier, we mentioned that all loggers inherit from the root logger and that loggers are hierarchical based on '.'-separated terms. What this means is that unless you override a parent setting, a logger retains the level and the appenders configured for that parent. So with this configuration:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        file name:'file', file:'/<span class="java&#45;keyword">var</span>/logs/mylog.log'
    &#125;
    root &#123;
        debug 'stdout', 'file'
    &#125;
&#125;</pre></div><p class="paragraph"/>all loggers in the application will have a level of 'debug' and will log to both the 'stdout' and 'file' appenders. What if you only want to log to 'stdout' for a particular logger? Change the 'additivity' for a logger in that case.<p class="paragraph"/>Additivity simply determines whether a logger inherits the configuration from its parent. If additivity is false, then its not inherited. The default for all loggers is true, i.e. they inherit the configuration. So how do you change this setting? Here's an example:<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        &#8230;
    &#125;
    root &#123;
        &#8230;
    &#125;<p class="paragraph"/>    info additivity: <span class="java&#45;keyword">false</span>
         stdout: &#91;<span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
                  <span class="java&#45;quote">"grails.app.services.BookService"</span>&#93;
&#125;</pre></div><p class="paragraph"/>So when you specify a log level, add an 'additivity' named argument. Note that you when you specify the additivity, you must configure the loggers for a named appender. The following syntax will  <em class="italic">not</em>  work:<p class="paragraph"/><div class="code"><pre>info additivity: <span class="java&#45;keyword">false</span>, &#91;<span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
                         <span class="java&#45;quote">"grails.app.services.BookService"</span>&#93;</pre></div>
</div><p class="paragraph"/><h3>记录器的继承</h3><p class="paragraph"/>早期，我们提到过所有的记录器都是从跟记录器继承而来的，其继承的层次是通过'.'来分割的。这意味着一个记录器将一直使用其上一级的级别和输出器配置，当然了你覆盖除外。以如下配置为例：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        file name:'file', file:'/<span class="java&#45;keyword">var</span>/logs/mylog.log'
    &#125;
    root &#123;
        debug 'stdout', 'file'
    &#125;
&#125;</pre></div><p class="paragraph"/>此应用的所有记录器都是'debug'级别和'file'输出。拿如果我想给'stdout'使用特定类型的记录器，该如何做呢？修改记录器的'additivity'。<p class="paragraph"/>记录器使用'additivity'来检查是否要继承其父级配置，如果其值是false，就不再继承。缺省情况下，所有记录器都是true，即他们都继承自父级配置。那么我们该如何修改此配置呢？请看下例：<p class="paragraph"/><div class="code"><pre>log4j = &#123;
    appenders &#123;
        &#8230;
    &#125;
    root &#123;
        &#8230;
    &#125;<p class="paragraph"/>    info additivity: <span class="java&#45;keyword">false</span>
         stdout: &#91;<span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
                  <span class="java&#45;quote">"grails.app.services.BookService"</span>&#93;
&#125;</pre></div><p class="paragraph"/>当你指定记录级别的时候，增加一个名为'additivity'的参数。需要注意的是，当使用此参数时，你必须要为其分配一个输出器。如下的配置将_不会_工作：<p class="paragraph"/><div class="code"><pre>info additivity: <span class="java&#45;keyword">false</span>, &#91;<span class="java&#45;quote">"grails.app.controllers.BookController"</span>,
                         <span class="java&#45;quote">"grails.app.services.BookService"</span>&#93;</pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Customizing stack trace printing and filtering</h3><p class="paragraph"/>Stacktraces in general and those generated when using Groovy in particular are quite verbose and contain many stack frames that aren't interesting when diagnosing problems. So Grails uses a implementation of the <code>org.codehaus.groovy.grails.exceptions.StackTraceFilterer</code> interface to filter out irrelevant stack frames. To customize the approach used for filtering, implement that interface in a class in src/groovy or src/java and register it in <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.logging.stackTraceFiltererClass =
         'com.yourcompany.yourapp.MyStackTraceFilterer'</pre></div><p class="paragraph"/>In addition, Grails customizes the display of the filtered stacktrace to make the information more readable. To customize this, implement the <code>org.codehaus.groovy.grails.exceptions.StackTracePrinter</code> interface in a class in src/groovy or src/java and register it in <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.logging.stackTracePrinterClass =
         'com.yourcompany.yourapp.MyStackTracePrinter'</pre></div><p class="paragraph"/>Finally, to render error information in the error GSP, an HTML-generating printer implementation is needed. The default implementation is <code>org.codehaus.groovy.grails.web.errors.ErrorsViewStackTracePrinter</code> and it's registered as a Spring bean. To use your own implementation, either implement the <code>org.codehaus.groovy.grails.exceptions.StackTraceFilterer</code> directly or subclass <code>ErrorsViewStackTracePrinter</code> and register it in <code>grails-app/conf/spring/resources.groovy</code> as:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.yourcompany.yourapp.MyErrorsViewStackTracePrinter<p class="paragraph"/>beans = &#123;<p class="paragraph"/>    errorsViewStackTracePrinter(MyErrorsViewStackTracePrinter,
                                ref('grailsResourceLocator'))
&#125;</pre></div>
</div><p class="paragraph"/><h3>自定义栈跟踪的输出和过滤</h3><p class="paragraph"/>总的来说，Groovy生成的那些特定栈跟踪信息是比较冗余的，并且对于诊断问题也造成不少的干扰。因此Grails使用<code>org.codehaus.groovy.grails.exceptions.StackTraceFilterer</code>接口来完成对不相关信息的过滤。要完成对特定信息的过滤，只需要再src/groovy或者src/java中实现上述接口，并且在<code>Config.groovy</code>注册一下即可：<p class="paragraph"/><div class="code"><pre>grails.logging.stackTraceFiltererClass =
         'com.yourcompany.yourapp.MyStackTraceFilterer'</pre></div><p class="paragraph"/>此外，Grails也可以让这些被过滤的栈信息更具有可读性，你只需要在src/groovy或者src/java下边实现<code>org.codehaus.groovy.grails.exceptions.StackTracePrinter</code>接口，并且在<code>Config.groovy</code>中注册即可：<p class="paragraph"/><div class="code"><pre>grails.logging.stackTracePrinterClass =
         'com.yourcompany.yourapp.MyStackTracePrinter'</pre></div><p class="paragraph"/>最后，为了能够在错误GSP页面中渲染出错信息，需要一个生成HTML的打印输出，其缺省的实现是<code>org.codehaus.groovy.grails.web.errors.ErrorsViewStackTracePrinter</code>，并且被注册为一个Spring服务。你也可以通过实现<code>org.codehaus.groovy.grails.exceptions.StackTraceFilterer</code>接口或者定义<code>ErrorsViewStackTracePrinter</code>的子类来实现属于自己的渲染器，并且将其在<code>grails-app/conf/spring/resources.groovy</code>中注册，如下：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.yourcompany.yourapp.MyErrorsViewStackTracePrinter<p class="paragraph"/>beans = &#123;<p class="paragraph"/>    errorsViewStackTracePrinter(MyErrorsViewStackTracePrinter,
                                ref('grailsResourceLocator'))
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Alternative logging libraries</h3><p class="paragraph"/>By default, Grails uses Log4J to do its logging. For most people this is absolutely fine, and many users don't even care what logging library is used. But if you're not one of those and want to use an alternative, such as the <a href="http://download.oracle.com/javase/6/docs/api/index.html?java/util/logging/package-summary.html" target="blank">JDK logging package</a> or <a href="http://logback.qos.ch/" target="blank">logback</a>, you can do so by simply excluding a couple of dependencies from the global set and adding your own:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    inherits(<span class="java&#45;quote">"global"</span>) &#123;
        excludes <span class="java&#45;quote">"grails&#45;plugin&#45;logging"</span>, <span class="java&#45;quote">"log4j"</span>
    &#125;
    &#8230;
    dependencies &#123;
        runtime <span class="java&#45;quote">"ch.qos.logback:logback&#45;core:0.9.29"</span>
        &#8230;
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>If you do this, you will get unfiltered, standard Java stacktraces in your log files and you won't be able to use the logging configuration DSL that's just been described. Instead, you will have to use the standard configuration mechanism for the library you choose.
</div><p class="paragraph"/><h3>替换日志框架</h3><p class="paragraph"/>缺省情况下，Grails使用Log4J来完成日志操作。对大多数的人来说，这绝对绰绰有余，而且很多的用户也根本就不关心使用那个日志框架。但是，如果你不是那些大多数，并且确实很想使用另外一个替代品，比如<a href="http://download.oracle.com/javase/6/docs/api/index.html?java/util/logging/package-summary.html" target="blank">JDK自带的日志包</a>或者<a href="http://logback.qos.ch/" target="blank">logback</a>。这时候，你只需要简单地全局设置中排除一些依赖，并且添加你自己地依赖即可，比如：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    inherits(<span class="java&#45;quote">"global"</span>) &#123;
        excludes <span class="java&#45;quote">"grails&#45;plugin&#45;logging"</span>, <span class="java&#45;quote">"log4j"</span>
    &#125;
    &#8230;
    dependencies &#123;
        runtime <span class="java&#45;quote">"ch.qos.logback:logback&#45;core:0.9.29"</span>
        &#8230;
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>如果你这么做了，那么你将在你的日志文件中记录未过滤的、标准的Java跟踪栈，此外你也不能使用先前介绍的DSL来进行日志配置，你只能使用你选择的日志框架所提供的配置机制。

<a name="3.1.3 GORM"><!-- Legacy link --></a>
<h2 id="configGORM">3.1.3 配置GORM</h2>
<div class="hidden-block">
Grails provides the following GORM configuration options:
<ul class="star">
<li><code>grails.gorm.failOnError</code>  - If set to <code>true</code>, causes the <code>save()</code> method on domain classes to throw a <code>grails.validation.ValidationException</code> if <a href="../guide/single.html#validation" class="guide">validation</a> fails during a save.  This option may also be assigned a list of Strings representing package names.  If the value is a list of Strings then the failOnError behavior will only be applied to domain classes in those packages (including sub-packages).  See the <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> method docs for more information.</li>
</ul><p class="paragraph"/>For example, to enable failOnError for all domain classes:
<div class="code"><pre>grails.gorm.failOnError=<span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>and to enable failOnError for domain classes by package:
<div class="code"><pre>grails.gorm.failOnError = &#91;'com.companyname.somepackage',
                           'com.companyname.someotherpackage'&#93;</pre></div>
<ul class="star">
<li><code>grails.gorm.autoFlush</code> = If set to <code>true</code>, causes the <a href="../ref/Domain Classes/merge.html" class="domainClasses">merge</a>, <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> and <a href="../ref/Domain Classes/delete.html" class="domainClasses">delete</a> methods to flush the session, replacing the need to explicitly flush using <code>save(flush: true)</code>.</li>
</ul><p class="paragraph"/></div><p class="paragraph"/>Grails提供了如下的GORM配置选项：
<ul class="star">
<li><code>grails.gorm.failOnError</code>  - 如果此选项值为 <code>true</code> 并且在保存的时候 <a href="../guide/single.html#validation" class="guide">校验</a> 失败，那么此领域类的 <code>save()</code> 方法将抛出一个  <code>grails.validation.ValidationException</code> 异常。此选项的值还可以是代表包名的字符串列表。如果是字符串列表的话，那么failOnError仅仅作用于属于这些包名（包括子包名）的领域类。更多详细信息请参考 <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> 方法</li>
</ul><p class="paragraph"/>例如要使所有的领域类都能够failOnError，配置如下：
<div class="code"><pre>grails.gorm.failOnError=<span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>要使特定包名的领域类能够failOnError，代码如下：
<div class="code"><pre>grails.gorm.failOnError = &#91;'com.companyname.somepackage',
                           'com.companyname.someotherpackage'&#93;</pre></div>
<ul class="star">
<li><code>grails.gorm.autoFlush</code> = 如果此选项值为 <code>true</code>，那么将导致 <a href="../ref/Domain Classes/merge.html" class="domainClasses">merge</a>、 <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> 和 <a href="../ref/Domain Classes/delete.html" class="domainClasses">delete</a> 方法不需要明确地指定flush参数（比如 <code>save(flush: true)</code> ）而清除会话的行为。</li>
</ul><p class="paragraph"/>

<a name="3.2 Environments"><!-- Legacy link --></a>
<h2 id="environments">3.2 环境</h2>
<div class="hidden-block">
<h4>Per Environment Configuration</h4><p class="paragraph"/>Grails supports the concept of per environment configuration. The <code>Config.groovy</code>, <code>DataSource.groovy</code>, and <code>BootStrap.groovy</code> files in the <code>grails-app/conf</code> directory can use per-environment configuration using the syntax provided by <a href="http://groovy.codehaus.org/ConfigSlurper." target="blank">ConfigSlurper</a> As an example consider the following default <code>DataSource</code> definition provided by Grails:<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">false</span>
    driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
    username = <span class="java&#45;quote">"sa"</span>
    password = <span class="java&#45;quote">""</span>
&#125;
environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Notice how the common configuration is provided at the top level and then an <code>environments</code> block specifies per environment settings for the <code>dbCreate</code> and <code>url</code> properties of the <code>DataSource</code>.
</div><p class="paragraph"/><h4>不同环境（Per Environment）配置</h4><p class="paragraph"/>Grails支持不同环境配置的概念。<code>grails-app/conf</code>目录下的<code>Config.groovy</code>、<code>DataSource.groovy</code>和<code>BootStrap.groovy</code>文件都支持 <a href="http://groovy.codehaus.org/ConfigSlurper" target="blank">ConfigSlurper</a> 语法的不同环境配置。Grails自带的缺省<code>DataSource</code>定义，就是一个很好的示例：<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">false</span>
    driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
    username = <span class="java&#45;quote">"sa"</span>
    password = <span class="java&#45;quote">""</span>
&#125;
environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>请留意上述示例中顶层部分公共配置，以及不同环境下<code>environments</code>代码块中<code>DataSource</code>的<code>dbCreate</code>和<code>url</code>属性。<p class="paragraph"/><div class="hidden-block">
<h4>Packaging and Running for Different Environments</h4><p class="paragraph"/>Grails' <a href="../guide/single.html#commandLine" class="guide">command line</a> has built in capabilities to execute any command within the context of a specific environment. The format is:<p class="paragraph"/><div class="code"><pre>grails &#91;environment&#93; &#91;command name&#93;</pre></div><p class="paragraph"/>In addition, there are 3 preset environments known to Grails: <code>dev</code>, <code>prod</code>, and <code>test</code> for <code>development</code>, <code>production</code> and <code>test</code>. For example to create a WAR for the <code>test</code> environment you wound run:<p class="paragraph"/><div class="code"><pre>grails test war</pre></div><p class="paragraph"/>To target other environments you can pass a <code>grails.env</code> variable to any command:<p class="paragraph"/><div class="code"><pre>grails &#45;Dgrails.env=UAT run&#45;app</pre></div>
</div><p class="paragraph"/><h4>不同环境下的运行和打包</h4><p class="paragraph"/>Grails的<a href="../guide/single.html#commandLine" class="guide">命令行</a>中内置了特定环境下执行命令的能力，其格式为：<p class="paragraph"/><div class="code"><pre>grails &#91;environment&#93; &#91;command name&#93;</pre></div><p class="paragraph"/>此外，Grails预置了三种开发环境：<code>dev</code>、<code>prod</code>和<code>test</code>，分别代表了<code>开发</code>、<code>生产</code>和<code>测试</code>环境。比如，要创建<code>test</code>环境的WAR，可以运行如下命令：<p class="paragraph"/><div class="code"><pre>grails test war</pre></div><p class="paragraph"/>要设置其他的环境，请使用<code>grails.env</code>变量：<p class="paragraph"/><div class="code"><pre>grails &#45;Dgrails.env=UAT run&#45;app</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Programmatic Environment Detection</h4><p class="paragraph"/>Within your code, such as in a Gant script or a bootstrap class you can detect the environment using the <a href="../../api/grails/util/Environment.html" class="api">Environment</a> class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.util.Environment<p class="paragraph"/>...<p class="paragraph"/><span class="java&#45;keyword">switch</span> (Environment.current) &#123;
    <span class="java&#45;keyword">case</span> Environment.DEVELOPMENT:
        configureForDevelopment()
        <span class="java&#45;keyword">break</span>
    <span class="java&#45;keyword">case</span> Environment.PRODUCTION:
        configureForProduction()
        <span class="java&#45;keyword">break</span>
&#125;</pre></div>
</div><p class="paragraph"/><h4>可编程的环境检测</h4><p class="paragraph"/>在你的代码中，比如Gant脚本或者启动类，你通过<a href="../../api/grails/util/Environment.html" class="api">Environment</a>类可以检测到当前的环境，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.util.Environment<p class="paragraph"/>...<p class="paragraph"/><span class="java&#45;keyword">switch</span> (Environment.current) &#123;
    <span class="java&#45;keyword">case</span> Environment.DEVELOPMENT:
        configureForDevelopment()
        <span class="java&#45;keyword">break</span>
    <span class="java&#45;keyword">case</span> Environment.PRODUCTION:
        configureForProduction()
        <span class="java&#45;keyword">break</span>
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Per Environment Bootstrapping</h4><p class="paragraph"/>Its often desirable to run code when your application starts up on a per-environment basis. To do so you can use the <code>grails-app/conf/BootStrap.groovy</code> file's support for per-environment execution:<p class="paragraph"/><div class="code"><pre>def init = &#123; ServletContext ctx &#45;&#62;
    environments &#123;
        production &#123;
            ctx.setAttribute(<span class="java&#45;quote">"env"</span>, <span class="java&#45;quote">"prod"</span>)
        &#125;
        development &#123;
            ctx.setAttribute(<span class="java&#45;quote">"env"</span>, <span class="java&#45;quote">"dev"</span>)
        &#125;
    &#125;
    ctx.setAttribute(<span class="java&#45;quote">"foo"</span>, <span class="java&#45;quote">"bar"</span>)
&#125;</pre></div>
</div><p class="paragraph"/><h4>不同环境下的启动</h4><p class="paragraph"/>通常你的应用启动时，需要根据不同的环境运行相应的代码，为此你可以使用<code>grails-app/conf/BootStrap.groovy</code>文件来执行不同环境下的处理：<p class="paragraph"/><div class="code"><pre>def init = &#123; ServletContext ctx &#45;&#62;
    environments &#123;
        production &#123;
            ctx.setAttribute(<span class="java&#45;quote">"env"</span>, <span class="java&#45;quote">"prod"</span>)
        &#125;
        development &#123;
            ctx.setAttribute(<span class="java&#45;quote">"env"</span>, <span class="java&#45;quote">"dev"</span>)
        &#125;
    &#125;
    ctx.setAttribute(<span class="java&#45;quote">"foo"</span>, <span class="java&#45;quote">"bar"</span>)
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Generic Per Environment Execution</h4><p class="paragraph"/>The previous <code>BootStrap</code> example uses the <code>grails.util.Environment</code> class internally to execute. You can also use this class yourself to execute your own environment specific logic:<p class="paragraph"/><div class="code"><pre>Environment.executeForCurrentEnvironment &#123;
    production &#123;
        // <span class="java&#45;keyword">do</span> something in production
    &#125;
    development &#123;
        // <span class="java&#45;keyword">do</span> something only in development
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>不同环境下的通用处理</h4><p class="paragraph"/>在以前的<code>BootStrap</code>示例中，我们使用<code>grails.util.Environment</code>类做了内部处理。你也可以通过此类来执行特定环境中的逻辑，比如：<p class="paragraph"/><div class="code"><pre>Environment.executeForCurrentEnvironment &#123;
    production &#123;
        // <span class="java&#45;keyword">do</span> something in production
    &#125;
    development &#123;
        // <span class="java&#45;keyword">do</span> something only in development
    &#125;
&#125;</pre></div>


<a name="3.3 The DataSource"><!-- Legacy link --></a>
<h2 id="dataSource">3.3 数据源</h2>
<div class="hidden-block">
Since Grails is built on Java technology setting up a data source requires some knowledge of JDBC (the technology that doesn't stand for Java Database Connectivity).<p class="paragraph"/>If you use a database other than H2 you need a JDBC driver. For example for MySQL you would need <a href="http://www.mysql.com/downloads/connector/j/" target="blank">Connector/J</a><p class="paragraph"/>Drivers typically come in the form of a JAR archive. It's best to use Ivy to resolve the jar if it's available in a Maven repository, for example you could add a dependency for the MySQL driver like this:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    inherits(<span class="java&#45;quote">"global"</span>)
    log <span class="java&#45;quote">"warn"</span>
    repositories &#123;
        grailsPlugins()
        grailsHome()
        grailsCentral()
        mavenCentral()
    &#125;
    dependencies &#123;
        runtime 'mysql:mysql&#45;connector&#45;java:5.1.16'
    &#125;
&#125;</pre></div><p class="paragraph"/>Note that the built-in <code>mavenCentral()</code> repository is included here since that's a reliable location for this library.<p class="paragraph"/>If you can't use Ivy then just put the JAR in your project's <code>lib</code> directory.<p class="paragraph"/>Once you have the JAR resolved you need to get familiar Grails' DataSource descriptor file located at <code>grails-app/conf/DataSource.groovy</code>. This file contains the dataSource definition which includes the following settings:
<ul class="star">
<li><code>driverClassName</code> - The class name of the JDBC driver</li>
<li><code>username</code> - The username used to establish a JDBC connection</li>
<li><code>password</code> - The password used to establish a JDBC connection</li>
<li><code>url</code> - The JDBC URL of the database</li>
<li><code>dbCreate</code> - Whether to auto-generate the database from the domain model - one of 'create-drop', 'create', 'update' or 'validate'</li>
<li><code>pooled</code> - Whether to use a pool of connections (defaults to true)</li>
<li><code>logSql</code> - Enable SQL logging to stdout</li>
<li><code>formatSql</code> - Format logged SQL</li>
<li><code>dialect</code> - A String or Class that represents the Hibernate dialect used to communicate with the database. See the <a href="http://docs.jboss.org/hibernate/stable/core/javadocs/org/hibernate/dialect/package-summary.html" target="blank">org.hibernate.dialect</a> package for available dialects.</li>
<li><code>readOnly</code> - If <code>true</code> makes the DataSource read-only, which results in the connection pool calling <code>setReadOnly(true)</code> on each <code>Connection</code></li>
<li><code>properties</code> - Extra properties to set on the DataSource bean. See the <a href="http://commons.apache.org/dbcp/api-1.2.2/org/apache/commons/dbcp/BasicDataSource.html" target="blank">Commons DBCP BasicDataSource</a> documentation.</li>
</ul><p class="paragraph"/>A typical configuration for MySQL may be something like:<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    dbCreate = <span class="java&#45;quote">"update"</span>
    url = <span class="java&#45;quote">"jdbc:mysql://localhost/yourDB"</span>
    driverClassName = <span class="java&#45;quote">"com.mysql.jdbc.Driver"</span>
    dialect = org.hibernate.dialect.MySQL5InnoDBDialect
    username = <span class="java&#45;quote">"yourUser"</span>
    password = <span class="java&#45;quote">"yourPassword"</span>
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
When configuring the DataSource do not include the type or the def keyword before any of the configuration settings as Groovy will treat these as local variable definitions and they will not be processed. For example the following is invalid:
</blockquote><p class="paragraph"/><div class="code"><pre>dataSource &#123;
    <span class="java&#45;object">boolean</span> pooled = <span class="java&#45;keyword">true</span> // type declaration results in ignored local variable
    &#8230;
&#125;</pre></div><p class="paragraph"/>Example of advanced configuration using extra properties:
<div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    dbCreate = <span class="java&#45;quote">"update"</span>
    url = <span class="java&#45;quote">"jdbc:mysql://localhost/yourDB"</span>
    driverClassName = <span class="java&#45;quote">"com.mysql.jdbc.Driver"</span>
    dialect = org.hibernate.dialect.MySQL5InnoDBDialect
    username = <span class="java&#45;quote">"yourUser"</span>
    password = <span class="java&#45;quote">"yourPassword"</span>
    properties &#123;
        maxActive = 50
        maxIdle = 25
        minIdle = 5
        initialSize = 5
        minEvictableIdleTimeMillis = 60000
        timeBetweenEvictionRunsMillis = 60000
        maxWait = 10000
        validationQuery = <span class="java&#45;quote">"/&#42; ping &#42;/"</span>
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/>既然Grails是基于Java技术来设置数据源的，那么一些JDBC的知识是必不可少的。<p class="paragraph"/>如果你的数据库并非H2，那么你至少还需要一个JDBC驱动。以MySQL为例，你需要下载<a href="http://www.mysql.com/downloads/connector/j/" target="blank">Connector/J</a><p class="paragraph"/>驱动通常打包成JAR。如果你需要的jar在Maven的存储库中存在，那么最好是通过Ivy来解析它们，比如下面是对MySQL驱动的依赖：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    inherits(<span class="java&#45;quote">"global"</span>)
    log <span class="java&#45;quote">"warn"</span>
    repositories &#123;
        grailsPlugins()
        grailsHome()
        grailsCentral()
        mavenCentral()
    &#125;
    dependencies &#123;
        runtime 'mysql:mysql&#45;connector&#45;java:5.1.16'
    &#125;
&#125;</pre></div><p class="paragraph"/>注意，此处引入了内置的<code>mavenCentral()</code>存储库，因为此jar包位于其中。<p class="paragraph"/>如果Ivy找不到，那么只需要将JAR放到你工程的<code>lib</code>目录即可。<p class="paragraph"/>一旦解决了JAR的问题，你需要来熟悉一下位于<code>grails-app/conf/DataSource.groovy</code>中的Grails数据源描述了。此文件包含如下所述的一些数据源的定义：
<ul class="star">
<li><code>driverClassName</code> - JDBC驱动的类名</li>
<li><code>username</code> - 建立JDBC连接的用户名</li>
<li><code>password</code> - 建立JDBC连接的密码</li>
<li><code>url</code> - JDBC数据库的URL</li>
<li><code>dbCreate</code> - 是否根据领域类自动生成数据库-可以是'create-drop'、'create'、'update'或者'validate'</li>
<li><code>pooled</code> - 是否使用连接池（缺省是true)</li>
<li><code>logSql</code> - 是否将SQL输出到字符终端</li>
<li><code>formatSql</code> - 格式化SQL</li>
<li><code>dialect</code> - Hibernate用于跟数据库通讯的方言（dialect），可以是字符串或者类名。可以通过<a href="http://docs.jboss.org/hibernate/stable/core/javadocs/org/hibernate/dialect/package-summary.html" target="blank">org.hibernate.dialect</a>来查看所支撑的方言。</li>
<li><code>readOnly</code> - 如果是<code>true</code>那么此数据源就是只读的，这是通过调用连接池的<code>Connection</code>的<code>setReadOnly(true)</code>来实现的。</li>
<li><code>properties</code> - 设置数据源的额外属性。更多请参考<a href="http://commons.apache.org/dbcp/api-1.2.2/org/apache/commons/dbcp/BasicDataSource.html" target="blank">Commons DBCP的 BasicDataSource</a>文档。</li>
</ul><p class="paragraph"/>一个MySQL的典型配置可能如下：<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    dbCreate = <span class="java&#45;quote">"update"</span>
    url = <span class="java&#45;quote">"jdbc:mysql://localhost/yourDB"</span>
    driverClassName = <span class="java&#45;quote">"com.mysql.jdbc.Driver"</span>
    dialect = org.hibernate.dialect.MySQL5InnoDBDialect
    username = <span class="java&#45;quote">"yourUser"</span>
    password = <span class="java&#45;quote">"yourPassword"</span>
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
在配置数据源的时候，不要在配置名前加入任何类型或者def关键字，因为Groovy将其视为一个本地变量定义而将其忽略。比如：
</blockquote><p class="paragraph"/><div class="code"><pre>dataSource &#123;
    <span class="java&#45;object">boolean</span> pooled = <span class="java&#45;keyword">true</span> // type declaration results in ignored local variable
    &#8230;
&#125;</pre></div><p class="paragraph"/>一个使用额外属性配置的高级示例如下：
<div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    dbCreate = <span class="java&#45;quote">"update"</span>
    url = <span class="java&#45;quote">"jdbc:mysql://localhost/yourDB"</span>
    driverClassName = <span class="java&#45;quote">"com.mysql.jdbc.Driver"</span>
    dialect = org.hibernate.dialect.MySQL5InnoDBDialect
    username = <span class="java&#45;quote">"yourUser"</span>
    password = <span class="java&#45;quote">"yourPassword"</span>
    properties &#123;
        maxActive = 50
        maxIdle = 25
        minIdle = 5
        initialSize = 5
        minEvictableIdleTimeMillis = 60000
        timeBetweenEvictionRunsMillis = 60000
        maxWait = 10000
        validationQuery = <span class="java&#45;quote">"/&#42; ping &#42;/"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>More on dbCreate</h4><p class="paragraph"/>Hibernate can automatically create the database tables required for your domain model. You have some control over when and how it does this through the <code>dbCreate</code> property, which can take these values:
<ul class="star">
<li><strong class="bold">create</strong> - Drops the existing schemaCreates the schema on startup, dropping existing tables, indexes, etc. first.</li>
<li><strong class="bold">create-drop</strong> - Same as <strong class="bold">create</strong>, but also drops the tables when the application shuts down cleanly.</li>
<li><strong class="bold">update</strong> - Creates missing tables and indexes, and updates the current schema without dropping any tables or data. Note that this can't properly handle many schema changes like column renames (you're left with the old column containing the existing data).</li>
<li><strong class="bold">validate</strong> - Makes no changes to your database. Compares the configuration with the existing database schema and reports warnings.</li>
<li>any other value - does nothing</li>
</ul><p class="paragraph"/>You can also remove the <code>dbCreate</code> setting completely, which is recommended once your schema is relatively stable and definitely when your application and database are deployed in production. Database changes are then managed through proper migrations, either with SQL scripts or a migration tool like <a href="http://www.liquibase.org/" target="blank">Liquibase</a> (the <a href="http://grails.org/plugin/database-migration" target="blank">Database Migration</a> plugin uses Liquibase and is tightly integrated with Grails and GORM).
</div><p class="paragraph"/><h4>关于dbCreate</h4><p class="paragraph"/>Hibernate能够根据你的领域类来自动创建数据库表。你可以通过<code>dbCreate</code>属性来进行一些控制，其可选值如下：
<ul class="star">
<li><strong class="bold">create</strong> - 在启动时候，先删除已存在的，包括表、索引等，然后创建。</li>
<li><strong class="bold">create-drop</strong> - 同 <strong class="bold">create</strong>，不过在应用关闭的时候，也进行表删除。</li>
<li><strong class="bold">update</strong> - 创建不存在的表和索引，并且在不删除表和数据的情况下更新表结构。注意此种情况于很多限制，比如你不能很好地处理重命名字段（旧有地字段依然保留）</li>
<li><strong class="bold">validate</strong> - 不改变你数据库地任何信息，只是跟现有地数据库配置脚本进行比较，并且报告一个警告。</li>
<li>其他 - 什么都不做</li>
</ul><p class="paragraph"/>如果你的数据库变化相对稳定或者你的应用部署于生产环境，推荐你将<code>dbCreate</code>完全移除。数据库的变更迁移可以通过SQL脚本或者迁移工具，比如<a href="http://www.liquibase.org/" target="blank">Liquibase</a>（<a href="http://grails.org/plugin/database-migration" target="blank">数据库迁移</a> 插件就是通过Liquibase来跟Grails和GORM紧密集成的)来完成。


<a name="3.3.1 DataSources and Environments"><!-- Legacy link --></a>
<h2 id="dataSourcesAndEnvironments">3.3.1 数据源和环境</h2>
<div class="hidden-block">
The previous example configuration assumes you want the same config for all environments: production, test, development etc.<p class="paragraph"/>Grails' DataSource definition is "environment aware", however, so you can do:<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    driverClassName = <span class="java&#45;quote">"com.mysql.jdbc.Driver"</span>
    dialect = org.hibernate.dialect.MySQL5InnoDBDialect
    // other common settings here
&#125;<p class="paragraph"/>environments &#123;
    production &#123;
        dataSource &#123;
            url = <span class="java&#45;quote">"jdbc:mysql://liveip.com/liveDb"</span>
            // other environment&#45;specific settings here
        &#125;
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/>在前面的配置示例中，不管是在生产、测试还是开发环境中，我们假设所有的配置都是一样的，<p class="paragraph"/>但是Grails的数据源定义是可以跟环境相关的，因此，你可以象下面的示例那样进行处理：<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    driverClassName = <span class="java&#45;quote">"com.mysql.jdbc.Driver"</span>
    dialect = org.hibernate.dialect.MySQL5InnoDBDialect
    // other common settings here
&#125;<p class="paragraph"/>environments &#123;
    production &#123;
        dataSource &#123;
            url = <span class="java&#45;quote">"jdbc:mysql://liveip.com/liveDb"</span>
            // other environment&#45;specific settings here
        &#125;
    &#125;
&#125;</pre></div>


<a name="3.3.2 JNDI DataSources"><!-- Legacy link --></a>
<h2 id="JNDIDataSources">3.3.2 JNDI数据源</h2>
<div class="hidden-block">
<h4>Referring to a JNDI DataSource</h4><p class="paragraph"/>Most Java EE containers supply <code>DataSource</code> instances via <a href="http://www.oracle.com/technetwork/java/jndi/index.html" target="blank">Java Naming and Directory Interface</a> (JNDI). Grails supports the definition of JNDI data sources as follows:<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    jndiName = <span class="java&#45;quote">"java:comp/env/myDataSource"</span>
&#125;</pre></div><p class="paragraph"/>The format on the JNDI name may vary from container to container, but the way you define the <code>DataSource</code> in Grails remains the same.
</div><p class="paragraph"/><h4>引用JNDI数据源</h4><p class="paragraph"/>大部分的Java EE容器支持 <a href="http://www.oracle.com/technetwork/java/jndi/index.html" target="blank">Java命名服务接口</a> (JNDI)的<code>DataSource</code>，Grails也支持如下格式的JNDI数据源定义：<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    jndiName = <span class="java&#45;quote">"java:comp/env/myDataSource"</span>
&#125;</pre></div><p class="paragraph"/>虽然不同的容器之间定义JNDI名字的格式有很大的差异，但是Grails中<code>DataSource</code>的定义却是保持一致的。<p class="paragraph"/><div class="hidden-block">
<h4>Configuring a Development time JNDI resource</h4><p class="paragraph"/>The way in which you configure JNDI data sources at development time is plugin dependent. Using the <a href="http://grails.org/plugin/tomcat" target="blank">Tomcat</a> plugin you can define JNDI resources using the <code>grails.naming.entries</code> setting in <code>grails-app/conf/Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.naming.entries = &#91;
    <span class="java&#45;quote">"bean/MyBeanFactory"</span>: &#91;
        auth: <span class="java&#45;quote">"Container"</span>,
        type: <span class="java&#45;quote">"com.mycompany.MyBean"</span>,
        factory: <span class="java&#45;quote">"org.apache.naming.factory.BeanFactory"</span>,
        bar: <span class="java&#45;quote">"23"</span>
    &#93;,
    <span class="java&#45;quote">"jdbc/EmployeeDB"</span>: &#91;
        type: <span class="java&#45;quote">"javax.sql.DataSource"</span>, //required
        auth: <span class="java&#45;quote">"Container"</span>, // optional
        description: <span class="java&#45;quote">"Data source <span class="java&#45;keyword">for</span> Foo"</span>, //optional
        driverClassName: <span class="java&#45;quote">"org.h2.Driver"</span>,
        url: <span class="java&#45;quote">"jdbc:h2:mem:database"</span>,
        username: <span class="java&#45;quote">"dbusername"</span>,
        password: <span class="java&#45;quote">"dbpassword"</span>,
        maxActive: <span class="java&#45;quote">"8"</span>,
        maxIdle: <span class="java&#45;quote">"4"</span>
    &#93;,
    <span class="java&#45;quote">"mail/session"</span>: &#91;
        type: <span class="java&#45;quote">"javax.mail.Session,
        auth: "</span>Container<span class="java&#45;quote">",
        "</span>mail.smtp.host<span class="java&#45;quote">": "</span>localhost"
    &#93;
&#93;</pre></div>
</div><p class="paragraph"/><h4>开发环境中配置JNDI资源</h4><p class="paragraph"/>在开发环境中，配置JNDI数据源的方式是跟插件相关的。如果你是在用 <a href="http://grails.org/plugin/tomcat" target="blank">Tomcat</a> 插件的话，可以通过<code>grails-app/conf/Config.groovy</code>中的<code>grails.naming.entries</code>来配置JNDI资源，比如：<p class="paragraph"/><div class="code"><pre>grails.naming.entries = &#91;
    <span class="java&#45;quote">"bean/MyBeanFactory"</span>: &#91;
        auth: <span class="java&#45;quote">"Container"</span>,
        type: <span class="java&#45;quote">"com.mycompany.MyBean"</span>,
        factory: <span class="java&#45;quote">"org.apache.naming.factory.BeanFactory"</span>,
        bar: <span class="java&#45;quote">"23"</span>
    &#93;,
    <span class="java&#45;quote">"jdbc/EmployeeDB"</span>: &#91;
        type: <span class="java&#45;quote">"javax.sql.DataSource"</span>, //required
        auth: <span class="java&#45;quote">"Container"</span>, // optional
        description: <span class="java&#45;quote">"Data source <span class="java&#45;keyword">for</span> Foo"</span>, //optional
        driverClassName: <span class="java&#45;quote">"org.h2.Driver"</span>,
        url: <span class="java&#45;quote">"jdbc:h2:mem:database"</span>,
        username: <span class="java&#45;quote">"dbusername"</span>,
        password: <span class="java&#45;quote">"dbpassword"</span>,
        maxActive: <span class="java&#45;quote">"8"</span>,
        maxIdle: <span class="java&#45;quote">"4"</span>
    &#93;,
    <span class="java&#45;quote">"mail/session"</span>: &#91;
        type: <span class="java&#45;quote">"javax.mail.Session,
        auth: "</span>Container<span class="java&#45;quote">",
        "</span>mail.smtp.host<span class="java&#45;quote">": "</span>localhost"
    &#93;
&#93;</pre></div>


<a name="3.3.3 Automatic Database Migration"><!-- Legacy link --></a>
<h2 id="automaticDatabaseMigration">3.3.3 自动数据库迁移</h2>
<div class="hidden-block">
The <code>dbCreate</code> property of the <code>DataSource</code> definition is important as it dictates what Grails should do at runtime with regards to automatically generating the database tables from <a href="../guide/single.html#GORM" class="guide">GORM</a> classes. The options are described in the <a href="../guide/single.html#dataSource" class="guide">DataSource</a> section:
<ul class="star">
<li><code>create</code></li>
<li><code>create-drop</code></li>
<li><code>update</code></li>
<li><code>validate</code></li>
<li>no value</li>
</ul><p class="paragraph"/>In <a href="../guide/single.html#environments" class="guide">development</a> mode <code>dbCreate</code> is by default set to "create-drop", but at some point in development (and certainly once you go to production) you'll need to stop dropping and re-creating the database every time you start up your server.<p class="paragraph"/>It's tempting to switch to <code>update</code> so you retain existing data and only update the schema when your code changes, but Hibernate's update support is very conservative. It won't make any changes that could result in data loss, and doesn't detect renamed columns or tables, so you'll be left with the old one and will also have the new one.<p class="paragraph"/>Grails supports Rails-style migrations via the <a href="http://grails.org/plugin/database-migration" target="blank">Database Migration</a> plugin which can be installed by running<p class="paragraph"/><pre class="bq"><code>
grails install-plugin database-migration</code></pre><p class="paragraph"/>The plugin uses <a href="http://www.liquibase.org/" target="blank">Liquibase</a> and and provides access to all of its functionality, and also has support for GORM (for example generating a change set by comparing your domain classes to a database).
</div><p class="paragraph"/><code>DataSource</code>中的<code>dbCreate</code>属性是很重要的，正如其所暗示，Grails将根据此值和<a href="../guide/single.html#GORM" class="guide">GORM</a>类在运行时来自动生成数据库表。可选项已经在<a href="../guide/single.html#dataSource" class="guide">数据源</a>章节中介绍：
<ul class="star">
<li><code>create</code></li>
<li><code>create-drop</code></li>
<li><code>update</code></li>
<li><code>validate</code></li>
<li>空</li>
</ul><p class="paragraph"/>在<a href="../guide/single.html#environments" class="guide">开发模式</a>下，<code>dbCreate</code>通常设置为"create-drop"，但是当开发到一定程度（更进一步要运行于生产环境），你将不会再采用这种每次启动先删除再创建的方式。<p class="paragraph"/>当你想保留数据并且只想更新所变化的代码时，可以尝试使用<code>update</code>。不过Hibernate对更新的支撑是非常保守的。其在数据安全方面不能给你任何保证，此外它也不能自动检测到字段或者表的重命名，因此在新增的同时旧有的依然保留。<p class="paragraph"/>Grails现在支撑Rails风格的数据库迁移了，这是通过安装和运行 <a href="http://grails.org/plugin/database-migration" target="blank">Database Migration</a> 插件来实现的。<p class="paragraph"/><pre class="bq"><code>
grails install-plugin database-migration</code></pre><p class="paragraph"/>此插件以 <a href="http://www.liquibase.org/" target="blank">Liquibase</a> 为基础，除了具有原来的强大功能外，其还对GORM提供了支持(比如通过领域类和数据库的比较来自动生成变化内容）。


<a name="3.3.4 Transaction-aware DataSource Proxy"><!-- Legacy link --></a>
<h2 id="transactionAwareDataSourceProxy">3.3.4 事务感知的数据源代理</h2>
<div class="hidden-block">
The actual <code>dataSource</code> bean is wrapped in a transaction-aware proxy so you will be given the connection that's being used by the current transaction or Hibernate <code>Session</code> if one is active.<p class="paragraph"/>If this were not the case, then retrieving a connection from the <code>dataSource</code> would be a new connection, and you wouldn't be able to see changes that haven't been committed yet (assuming you have a sensible transaction isolation setting, e.g. <code>READ_COMMITTED</code> or better).<p class="paragraph"/>The "real" unproxied <code>dataSource</code> is still available to you if you need access to it; its bean name is <code>dataSourceUnproxied</code>.<p class="paragraph"/>You can access this bean like any other Spring bean, i.e. using dependency injection:<p class="paragraph"/><div class="code"><pre>class MyService &#123;<p class="paragraph"/>   def dataSourceUnproxied
   &#8230;
&#125;</pre></div><p class="paragraph"/>or by pulling it from the <code>ApplicationContext</code>:<p class="paragraph"/><div class="code"><pre>def dataSourceUnproxied = ctx.dataSourceUnproxied</pre></div>
</div><p class="paragraph"/><code>dataSource</code> 实际上只是事务感知代理的封装，因此你得到的数据库连接是来自于当前事务或者当前活动的Hibernate的<code>Session</code>。<p class="paragraph"/>除此之外，直接从<code>dataSource</code>获取的连接将是一个新连接，你将看不到任何没有提交的变化（假设你设置了事务隔离敏感度，比如<code>READ_COMMITTED</code>或者更高）。<p class="paragraph"/>那个"真实的"未被代理的<code>dataSource</code>对你来说，依然可用，只不过其bean名称是<code>dataSourceUnproxied</code>。<p class="paragraph"/>你可用想其他Spring bean那样来访问此bean，比如使用依赖注入：<p class="paragraph"/><div class="code"><pre>class MyService &#123;<p class="paragraph"/>   def dataSourceUnproxied
   &#8230;
&#125;</pre></div><p class="paragraph"/>或者直接从<code>ApplicationContext</code>中获取：<p class="paragraph"/><div class="code"><pre>def dataSourceUnproxied = ctx.dataSourceUnproxied</pre></div>


<a name="3.3.5 Database Console"><!-- Legacy link --></a>
<h2 id="databaseConsole">3.3.5 数据库管理界面</h2>
<div class="hidden-block">
The <a href="http://h2database.com/html/quickstart.html#h2_console" target="blank">H2 database console</a> is a convenient feature of H2 that provides a web-based interface to any database that you have a JDBC driver for, and it's very useful to view the database you're developing against. It's especially useful when running against an in-memory database.<p class="paragraph"/>You can access the console by navigating to <strong class="bold">http://localhost:8080/appname/dbconsole</strong> in a browser. The URI can be configured using the <code>grails.dbconsole.urlRoot</code> attribute in Config.groovy and defaults to <code>'/dbconsole'</code>.<p class="paragraph"/>The console is enabled by default in development mode and can be disabled or enabled in other environments by using the <code>grails.dbconsole.enabled</code> attribute in Config.groovy. For example you could enable the console in production using<p class="paragraph"/><div class="code"><pre>environments &#123;
    production &#123;
        grails.serverURL = <span class="java&#45;quote">"http://www.changeme.com"</span>
        grails.dbconsole.enabled = <span class="java&#45;keyword">true</span>
        grails.dbconsole.urlRoot = '/admin/dbconsole'
    &#125;
    development &#123;
        grails.serverURL = <span class="java&#45;quote">"http://localhost:8080/&#36;&#123;appName&#125;"</span>
    &#125;
    test &#123;
        grails.serverURL = <span class="java&#45;quote">"http://localhost:8080/&#36;&#123;appName&#125;"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
If you enable the console in production be sure to guard access to it using a trusted security framework.
</blockquote>
</div><p class="paragraph"/><a href="http://h2database.com/html/quickstart.html#h2_console" target="blank">H2数据库管理界面</a>是在H2特性的基础上提供的一个基于WEB界面的数据库管理，用以管理任何基于JDBC的数据库，在开发阶段用来查看数据库非常有用，尤其在你的应用运行于数据库的内存模式时。<p class="paragraph"/>你可以在浏览器中通过 <strong class="bold">http://localhost:8080/appname/dbconsole</strong> 来使用访问。此URI可以通过配置Config.groovy中的<code>grails.dbconsole.urlRoot</code>属性来改变，缺省是<code>'/dbconsole'</code>。<p class="paragraph"/>此界面在开发模式下缺省是有效的，你也可以通过修改Config.groovy中的<code>grails.dbconsole.enabled</code>属性来使其在其他环境模式下失效或者生效。比如，你可以在生产环境中使其生效：<p class="paragraph"/><div class="code"><pre>environments &#123;
    production &#123;
        grails.serverURL = <span class="java&#45;quote">"http://www.changeme.com"</span>
        grails.dbconsole.enabled = <span class="java&#45;keyword">true</span>
        grails.dbconsole.urlRoot = '/admin/dbconsole'
    &#125;
    development &#123;
        grails.serverURL = <span class="java&#45;quote">"http://localhost:8080/&#36;&#123;appName&#125;"</span>
    &#125;
    test &#123;
        grails.serverURL = <span class="java&#45;quote">"http://localhost:8080/&#36;&#123;appName&#125;"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
如果你要在生产环境中使用此功能，请确保使用安全可信的框架来保护。
</blockquote><p class="paragraph"/><div class="hidden-block">
<h4>Configuration</h4><p class="paragraph"/>By default the console is configured for an H2 database which will work with the default settings if you haven't configured an external database - you just need to change the JDBC URL to <code>jdbc:h2:mem:devDB</code>. If you've configured an external database (e.g. MySQL, Oracle, etc.) then you can use the Saved Settings dropdown to choose a settings template and fill in the url and username/password information from your DataSource.groovy.
</div><p class="paragraph"/><h4>配置</h4><p class="paragraph"/>缺省情况下，如果你没有使用外部数据库，那么数据库管理界面是使用H2数据库的，其JDBC的URL配置成<code>jdbc:h2:mem:devDB</code>即可。但是如果你使用的是一个外部数据库（比如MySQL、 Oracle等），那你需要从下拉框中选择合适的JDBC配置模板，并且配置合适的url、用户名／密码，要确保跟DataSource.groovy的配置是一致的。


<a name="3.3.6 Multiple Datasources"><!-- Legacy link --></a>
<h2 id="multipleDatasources">3.3.6 多数据源</h2>
<div class="hidden-block">
By default all domain classes share a single <code>DataSource</code> and a single database, but you have the option to partition your domain classes into two or more <code>DataSource</code>s.
</div><p class="paragraph"/>缺省情况下，所有的领域类共享同一个<code>DataSource</code>和数据库，但是你还是有将领域类拆分到两个甚至更多个<code>DataSource</code>的选择的。<p class="paragraph"/><div class="hidden-block">
<h4>Configuring Additional DataSources</h4><p class="paragraph"/>The default <code>DataSource</code> configuration in <code>grails-app/conf/DataSource.groovy</code> looks something like this:<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
    username = <span class="java&#45;quote">"sa"</span>
    password = <span class="java&#45;quote">""</span>
&#125;
hibernate &#123;
    cache.use_second_level_cache = <span class="java&#45;keyword">true</span>
    cache.use_query_cache = <span class="java&#45;keyword">true</span>
    cache.provider_class = 'net.sf.ehcache.hibernate.EhCacheProvider'
&#125;<p class="paragraph"/>environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>This configures a single <code>DataSource</code> with the Spring bean named <code>dataSource</code>. To configure extra <code>DataSource</code>s, add another <code>dataSource</code> block (at the top level, in an environment block, or both, just like the standard <code>DataSource</code> definition) with a custom name, separated by an underscore. For example, this configuration adds a second <code>DataSource</code>, using MySQL in the development environment and Oracle in production:<p class="paragraph"/><div class="code"><pre>environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
        dataSource_lookup &#123;
            dialect = org.hibernate.dialect.MySQLInnoDBDialect
            driverClassName = 'com.mysql.jdbc.Driver'
            username = 'lookup'
            password = 'secret'
            url = 'jdbc:mysql://localhost/lookup'
            dbCreate = 'update'
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
        dataSource_lookup &#123;
            dialect = org.hibernate.dialect.Oracle10gDialect
            driverClassName = 'oracle.jdbc.driver.OracleDriver'
            username = 'lookup'
            password = 'secret'
            url = 'jdbc:oracle:thin:@localhost:1521:lookup'
            dbCreate = 'update'
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>You can use the same or different databases as long as they're supported by Hibernate.
</div><p class="paragraph"/><h4>配置额外的数据源</h4><p class="paragraph"/>缺省的<code>DataSource</code>配置是位于<code>grails-app/conf/DataSource.groovy</code>中的，大体样子如下：<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
    username = <span class="java&#45;quote">"sa"</span>
    password = <span class="java&#45;quote">""</span>
&#125;
hibernate &#123;
    cache.use_second_level_cache = <span class="java&#45;keyword">true</span>
    cache.use_query_cache = <span class="java&#45;keyword">true</span>
    cache.provider_class = 'net.sf.ehcache.hibernate.EhCacheProvider'
&#125;<p class="paragraph"/>environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>上述示例配置了一个Spring bean名称为<code>dataSource</code>的<code>DataSource</code>。要配置额外的<code>DataSource</code>，需要增加另外一个自定义名称（以下划线分割）的<code>dataSource</code>（跟标准的<code>DataSource</code>类似，只不过要定义在在最外层、环境代码块或者同时两个地方）代码块即可。例如，以下代码的配置新增了第二个<code>DataSource</code>，其在开发环境下是MySQL数据库，在生产环境下是Oracle：<p class="paragraph"/><div class="code"><pre>environments &#123;
    development &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"create&#45;drop"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:devDb"</span>
        &#125;
        dataSource_lookup &#123;
            dialect = org.hibernate.dialect.MySQLInnoDBDialect
            driverClassName = 'com.mysql.jdbc.Driver'
            username = 'lookup'
            password = 'secret'
            url = 'jdbc:mysql://localhost/lookup'
            dbCreate = 'update'
        &#125;
    &#125;
    test &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:mem:testDb"</span>
        &#125;
    &#125;
    production &#123;
        dataSource &#123;
            dbCreate = <span class="java&#45;quote">"update"</span>
            url = <span class="java&#45;quote">"jdbc:h2:prodDb"</span>
        &#125;
        dataSource_lookup &#123;
            dialect = org.hibernate.dialect.Oracle10gDialect
            driverClassName = 'oracle.jdbc.driver.OracleDriver'
            username = 'lookup'
            password = 'secret'
            url = 'jdbc:oracle:thin:@localhost:1521:lookup'
            dbCreate = 'update'
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>你可以使用Hibernate所支持的相同和或者相异的数据库。<p class="paragraph"/><div class="hidden-block">
<h4>Configuring Domain Classes</h4><p class="paragraph"/>If a domain class has no <code>DataSource</code> configuration, it defaults to the standard <code>'dataSource'</code>. Set the <code>datasource</code> property in the <code>mapping</code> block to configure a non-default <code>DataSource</code>. For example, if you want to use the <code>ZipCode</code> domain to use the <code>'lookup'</code> <code>DataSource</code>, configure it like this;<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasource 'lookup'
   &#125;
&#125;</pre></div><p class="paragraph"/>A domain class can also use two or more <code>DataSource</code>s. Use the <code>datasources</code> property with a list of names to configure more than one, for example:<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasources(&#91;'lookup', 'auditing'&#93;)
   &#125;
&#125;</pre></div><p class="paragraph"/>If a domain class uses the default <code>DataSource</code> and one or more others, use the special name <code>'DEFAULT'</code> to indicate the default <code>DataSource</code>:<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasources(&#91;'lookup', 'DEFAULT'&#93;)
   &#125;
&#125;</pre></div><p class="paragraph"/>If a domain class uses all configured <code>DataSource</code>s use the special value <code>'ALL'</code>:<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasource 'ALL'
   &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>配置领域类</h4><p class="paragraph"/>如果一个领域类没有配置<code>DataSource</code>，那么其缺省使用标准的<code>'dataSource'</code>。你可以在<code>mapping</code>代码块中设置<code>datasource</code>属性来配置一个非标准的<code>DataSource</code>。例如，你希望<code>ZipCode</code>使用名为<code>'lookup'</code>的<code>DataSource</code>，其配置如下：<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasource 'lookup'
   &#125;
&#125;</pre></div><p class="paragraph"/>一个领域类还可以有两个甚至更多个<code>DataSource</code>s。这时候，只需要将<code>datasources</code>设置为一个名称的列表即可，比如：<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasources(&#91;'lookup', 'auditing'&#93;)
   &#125;
&#125;</pre></div><p class="paragraph"/>如果一个领域类既使用缺省的又使用多于一个的<code>DataSource</code>，可以使用名称为<code>'DEFAULT'</code>来代表缺省的<code>DataSource</code>：<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasources(&#91;'lookup', 'DEFAULT'&#93;)
   &#125;
&#125;</pre></div><p class="paragraph"/>如果一个领域类要使用所有已经配置的<code>DataSource</code>，请使用特定名称<code>'ALL'</code>：<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasource 'ALL'
   &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Namespaces and GORM Methods</h4><p class="paragraph"/>If a domain class uses more than one <code>DataSource</code> then you can use the namespace implied by each <code>DataSource</code> name to make GORM calls for a particular <code>DataSource</code>. For example, consider this class which uses two <code>DataSource</code>s:<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasources(&#91;'lookup', 'auditing'&#93;)
   &#125;
&#125;</pre></div><p class="paragraph"/>The first <code>DataSource</code> specified is the default when not using an explicit namespace, so in this case we default to 'lookup'. But you can call GORM methods on the 'auditing' <code>DataSource</code> with the <code>DataSource</code> name, for example:<p class="paragraph"/><div class="code"><pre>def zipCode = ZipCode.auditing.get(42)
&#8230;
zipCode.auditing.save()</pre></div><p class="paragraph"/>As you can see, you add the <code>DataSource</code> to the method call in both the static case and the instance case.
</div><p class="paragraph"/><h4>命名空间和GORM方法</h4><p class="paragraph"/>如果一个领域类使用了多于一个的<code>DataSource</code>，你可以将其每个<code>DataSource</code>名称作为命名空间，并且以此命名来执行GORM的方法调用。例如，下面示例的类有两个<code>DataSource</code>：<p class="paragraph"/><div class="code"><pre>class ZipCode &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> code<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      datasources(&#91;'lookup', 'auditing'&#93;)
   &#125;
&#125;</pre></div><p class="paragraph"/>当没有明确指定命名空间的时候，其指定的第一个<code>DataSource</code>被视为缺省，上例中其缺省命名空间是'lookup'。但是你也可以在'auditing'的<code>DataSource</code>上执行GORM方法，比如：<p class="paragraph"/><div class="code"><pre>def zipCode = ZipCode.auditing.get(42)
&#8230;
zipCode.auditing.save()</pre></div><p class="paragraph"/>如你所见，你可以在<code>DataSource</code>上进行静态和实例类型的方法调用。<p class="paragraph"/><div class="hidden-block">
<h4>Services</h4><p class="paragraph"/>Like Domain classes, by default Services use the default <code>DataSource</code> and <code>PlatformTransactionManager</code>. To configure a Service to use a different <code>DataSource</code>, use the static <code>datasource</code> property, for example:<p class="paragraph"/><div class="code"><pre>class DataService &#123;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> datasource = 'lookup'<p class="paragraph"/>   void someMethod(...) &#123;
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>A transactional service can only use a single <code>DataSource</code>, so be sure to only make changes for domain classes whose <code>DataSource</code> is the same as the Service.<p class="paragraph"/>Note that the datasource specified in a service has no bearing on which datasources are used for domain classes; that's determined by their declared datasources in the domain classes themselves. It's used to declare which transaction manager to use.<p class="paragraph"/>What you'll see is that if you have a Foo domain class in dataSource1 and a Bar domain class in dataSource2, and WahooService uses dataSource1, a service method that saves a new Foo and a new Bar will only be transactional for Foo since they share the datasource. The transaction won't affect the Bar instance. If you want both to be transactional you'd need to use two services and XA datasources for two-phase commit, e.g. with the Atomikos plugin.
</div><p class="paragraph"/><h4>服务类</h4><p class="paragraph"/>跟领域类相似，服务类也是使用缺省的<code>DataSource</code>和<code>PlatformTransactionManager</code>。要配置服务使用另外一个不同的<code>DataSource</code>，请使用静态的（static）<code>datasource</code>属性，比如：<p class="paragraph"/><div class="code"><pre>class DataService &#123;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> datasource = 'lookup'<p class="paragraph"/>   void someMethod(...) &#123;
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>一个支持事务的服务只能使用一个<code>DataSource</code>，因此请确保领域类的<code>DataSource</code>的名字要跟服务类中定义的一致。<p class="paragraph"/>注意，一个服务类的datasource不对领域类的datasources产生影响，后者由其自身的声明决定。服务类的datasource多用来声明要使用哪一个事务管理器。<p class="paragraph"/>假设你有两个数据源，领域类Foo属于dataSource1，Bar属于dataSource2，而WahooService使用dataSource1，此外还有一个方法来实现Foo和Bar的新增保存，那么只有Foo是支持事务的，因为他们共享dataSource1数据源。而Bar实例并不受事务影响。如果你想两者都支持事务，那么你需要两个服务类和支持两阶段提交的XA数据源，比如使用Atomikos插件。<p class="paragraph"/><div class="hidden-block">
<h4>XA and Two-phase Commit</h4><p class="paragraph"/>Grails has no native support for <a href="../ref/Httpssecurewikimediaorgwikipediaenwiki XO pen XA/XA.html" class="https://secure.wikimedia.org/wikipedia/en/wiki/X/Open_XA">XA</a> <code>DataSource</code>s or <a href="../ref/Httpssecurewikimediaorgwikipediaenwiki Twophasecommit/two-phase commit.html" class="https://secure.wikimedia.org/wikipedia/en/wiki/Two-phase_commit">two-phase commit</a>, but the <a href="http://grails.org/plugin/atomikos" target="blank">Atomikos plugin</a> makes it easy. See the plugin documentation for the simple changes needed in your <code>DataSource</code> definitions to reconfigure them as XA <code>DataSource</code>s.
</div><p class="paragraph"/><h4>XA和两阶段（Two-phase）提交</h4><p class="paragraph"/>Grails并没有直接支持<a href="../ref/Httpssecurewikimediaorgwikipediaenwiki XO pen XA/XA.html" class="https://secure.wikimedia.org/wikipedia/en/wiki/X/Open_XA">XA</a> <code>DataSource</code>s 或者 <a href="../ref/Httpssecurewikimediaorgwikipediaenwiki Twophasecommit/两阶段提交.html" class="https://secure.wikimedia.org/wikipedia/en/wiki/Two-phase_commit">两阶段提交</a>，但是<a href="http://grails.org/plugin/atomikos" target="blank">Atomikos 插件</a>使两者变得容易。此插件的文档有介绍如何比较容易的将现有的<code>DataSource</code>定义重新配置为XA <code>DataSource</code>s。


<a name="3.4 Externalized Configuration"><!-- Legacy link --></a>
<h2 id="configExternalized">3.4 外部配置</h2>
<div class="hidden-block">
Some deployments require that configuration be sourced from more than one place and be changeable without requiring a rebuild of the application. In order to support deployment scenarios such as these the configuration can be externalized. To do so, point Grails at the locations of the configuration files that should be used by adding a <code>grails.config.locations</code> setting in <code>Config.groovy</code>, for example:<p class="paragraph"/><div class="code"><pre>grails.config.locations = &#91;
    <span class="java&#45;quote">"classpath:$&#123;appName&#125;&#45;config.properties"</span>,
    <span class="java&#45;quote">"classpath:$&#123;appName&#125;&#45;config.groovy"</span>,
    <span class="java&#45;quote">"file:$&#123;userHome&#125;/.grails/$&#123;appName&#125;&#45;config.properties"</span>,
    <span class="java&#45;quote">"file:$&#123;userHome&#125;/.grails/$&#123;appName&#125;&#45;config.groovy"</span> &#93;</pre></div><p class="paragraph"/>In the above example we're loading configuration files (both Java Properties files and <a href="http://groovy.codehaus.org/ConfigSlurper" target="blank">ConfigSlurper</a> configurations) from different places on the classpath and files located in <code>USER_HOME</code>.<p class="paragraph"/>It is also possible to load config by specifying a class that is a config script.<p class="paragraph"/><div class="code"><pre>grails.config.locations = &#91;com.my.app.MyConfig&#93;</pre></div><p class="paragraph"/>This can be useful in situations where the config is either coming from a plugin or some other part of your application. A typical use for this is re-using configuration provided by plugins across multiple applications.<p class="paragraph"/>Ultimately all configuration files get merged into the <code>config</code> property of the <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> object and are hence obtainable from there.<p class="paragraph"/>Values that have the same name as previously defined values will overwrite the existing values, and the pointed to configuration sources are loaded in the order in which they are defined.
</div><p class="paragraph"/>某些部署要求配置信息可以放在多个源文件中，并且在不需要重现编译打包的情况下可被修改。为了能够支撑这些特定的部署场景，Grails的配置信息可以在外部进行配置。要完成此功能，只需要设置<code>Config.groovy</code>中的<code>grails.config.locations</code>的值来指向配置文件的位置即可，比如：<p class="paragraph"/><div class="code"><pre>grails.config.locations = &#91;
    <span class="java&#45;quote">"classpath:$&#123;appName&#125;&#45;config.properties"</span>,
    <span class="java&#45;quote">"classpath:$&#123;appName&#125;&#45;config.groovy"</span>,
    <span class="java&#45;quote">"file:$&#123;userHome&#125;/.grails/$&#123;appName&#125;&#45;config.properties"</span>,
    <span class="java&#45;quote">"file:$&#123;userHome&#125;/.grails/$&#123;appName&#125;&#45;config.groovy"</span> &#93;</pre></div><p class="paragraph"/>在上述示例中，我们从类路径（classpath）和<code>USER_HOME</code>下加载不同的配置文件（包括Java属性文件和Groovy的<a href="http://groovy.codehaus.org/ConfigSlurper配置）。" target="blank">ConfigSlurper</a><p class="paragraph"/>也可以通过配置脚本的类名来加载，比如：<p class="paragraph"/><div class="code"><pre>grails.config.locations = &#91;com.my.app.MyConfig&#93;</pre></div><p class="paragraph"/>此种情况特别适合于你从插件或者应用的其他部分来加载配置，其典型的应用就是一个插件所提供的配置可以在多个应用中复用。<p class="paragraph"/>最后，所有的这些配置文件的内容将合并于<a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a>的<code>config</code>属性中，因此，要获取使用也是通过它来实现的。<p class="paragraph"/>配置中如果一个名字有多个值，那么新值将覆盖旧的，其顺序是根据源文件的加载顺序来定义的。<p class="paragraph"/><div class="hidden-block">
<h4>Config Defaults</h4><p class="paragraph"/>The configuration values contained in the locations described by the <code>grails.config.locations</code> property will <strong class="bold">override</strong> any values defined in your application <code>Config.groovy</code> file which may not be what you want. You may want to have a set of  <em class="italic">default</em>  values be be loaded that can be overridden in either your application's <code>Config.groovy</code> file or in a named config location. For this you can use the <code>grails.config.defaults.locations</code> property.<p class="paragraph"/>This property supports the same values as the <code>grails.config.locations</code> property (i.e. paths to config scripts, property files or classes), but the config described by <code>grails.config.defaults.locations</code> will be loaded  <em class="italic">before</em>  all other values and can therefore be overridden. Some plugins use this mechanism to supply one or more sets of default configuration that you can choose to include in your application config.<p class="paragraph"/><blockquote class="note">
Grails also supports the concept of property place holders and property override configurers as defined in <a href="http://www.springframework.org." target="blank">Spring</a> For more information on these see the section on <a href="../guide/single.html#spring" class="guide">Grails and Spring</a>
</blockquote>
</div><p class="paragraph"/><h4>缺省配置</h4><p class="paragraph"/>通过<code>grails.config.locations</code>定义的配置将 <strong class="bold">优先于</strong> 你在<code>Config.groovy</code>文件中的任意值，这也许并非你所需要的。你希望<code>Config.groovy</code>或者特定位置的文件才能加载并且重载特定的  <em class="italic">缺省值</em>  ，这种情况，你可以通过配置<code>grails.config.defaults.locations</code>属性来实现。<p class="paragraph"/>此属性的值跟<code>grails.config.locations</code>一样（可以是特定路径下的配置脚本、属性文件或者类名），但与之不同的是通过<code>grails.config.defaults.locations</code>来配置的值比其他方式加载的  <em class="italic">更早</em>  ，因此也就可有被重载。有些插件就是通过此机制来实现一个或者多个缺省配置的。<p class="paragraph"/><blockquote class="note">
Grails还支撑<a href="http://www.springframework.org" target="blank">Spring</a> 配置中属性占位符和覆盖的概念。更多信息请参考<a href="../guide/single.html#spring" class="guide">Grails和Spring</a>章节
</blockquote>


<a name="3.5 Versioning"><!-- Legacy link --></a>
<h2 id="versioning">3.5 版本</h2>
<div class="hidden-block">
<h4>Versioning Basics</h4><p class="paragraph"/>Grails has built in support for application versioning. The version of the application is set to <code>0.1</code> when you first create an application with the <a href="../ref/Command Line/create-app.html" class="commandLine">create-app</a> command. The version is stored in the application meta data file <code>application.properties</code> in the root of the project.<p class="paragraph"/>To change the version of your application you can edit the file manually, or run the <a href="../ref/Command Line/set-version.html" class="commandLine">set-version</a> command:<p class="paragraph"/><div class="code"><pre>grails set&#45;version 0.2</pre></div><p class="paragraph"/>The version is used in various commands including the <a href="../ref/Command Line/war.html" class="commandLine">war</a> command which will append the application version to the end of the created WAR file.
</div><p class="paragraph"/><h4>版本基础</h4><p class="paragraph"/>Grails内置了对应用版本的支持。当你第一次通过<a href="../ref/Command Line/create-app.html" class="commandLine">create-app</a>来创建应用的时候，其版本设置为<code>0.1</code>。版本信息被存储在工程根目录下的<code>application.properties</code>文件种。<p class="paragraph"/>要改变应用的版本，你可以手工修改此文件，或者运行<a href="../ref/Command Line/set-version.html" class="commandLine">set-version</a>命令，比如：<p class="paragraph"/><div class="code"><pre>grails set&#45;version 0.2</pre></div><p class="paragraph"/>版本信息被使用在在不同的命令中，比如<a href="../ref/Command Line/war.html" class="commandLine">war</a>命令就会在创建的WAR文件中追加应用的版本信息。<p class="paragraph"/><div class="hidden-block">
<h4>Detecting Versions at Runtime</h4><p class="paragraph"/>You can detect the application version using Grails' support for application metadata using the <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> class. For example within <a href="../guide/single.html#controllers" class="guide">controllers</a> there is an implicit <a href="../ref/Controllers/grailsApplication.html" class="controllers">grailsApplication</a> variable that can be used:<p class="paragraph"/><div class="code"><pre>def version = grailsApplication.metadata&#91;'app.version'&#93;</pre></div><p class="paragraph"/>You can retrieve the the version of Grails that is running with:<p class="paragraph"/><div class="code"><pre>def grailsVersion = grailsApplication.metadata&#91;'app.grails.version'&#93;</pre></div><p class="paragraph"/>or the <code>GrailsUtil</code> class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.util.GrailsUtil
&#8230;
def grailsVersion = GrailsUtil.grailsVersion</pre></div>
</div><p class="paragraph"/><h4>运行期间检测版本</h4><p class="paragraph"/>你可以使用<a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a>类来检测应用的版本信息，比如在<a href="../guide/single.html#controllers" class="guide">控制器</a>中，就有一个隐含的<a href="../ref/Controllers/grailsApplication.html" class="controllers">grailsApplication</a>变量可用：<p class="paragraph"/><div class="code"><pre>def version = grailsApplication.metadata&#91;'app.version'&#93;</pre></div><p class="paragraph"/>你还可用获取到Grails的版本信息：<p class="paragraph"/><div class="code"><pre>def grailsVersion = grailsApplication.metadata&#91;'app.grails.version'&#93;</pre></div><p class="paragraph"/>或者通过<code>GrailsUtil</code>类来获取Grails的版本：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.util.GrailsUtil
&#8230;
def grailsVersion = GrailsUtil.grailsVersion</pre></div>


<a name="3.6 Project Documentation"><!-- Legacy link --></a>
<h2 id="docengine">3.6 文档引擎</h2>
<div class="hidden-block">
Since Grails 1.2, the documentation engine that powers the creation of this documentation has been available for your own Grails projects.<p class="paragraph"/>The documentation engine uses a variation on the <a href="http://textile.sitemonks.com/" target="blank">Textile</a> syntax to automatically create project documentation with smart linking, formatting etc.
</div><p class="paragraph"/>从Grails 1.2以来，本文的文档就是通过文档引擎来创建的，并且对你的Grails项目文档也是有效的。<p class="paragraph"/>文档引擎在<a href="http://textile.sitemonks.com/" target="blank">Textile</a>语法基础上，进行了一些改动，以适应自动创建工程文档的需要，此文档支持灵活链接、格式化等功能。<p class="paragraph"/><div class="hidden-block">
<h4>Creating project documentation</h4><p class="paragraph"/>To use the engine you need to follow a few conventions. First, you need to create a <code>src/docs/guide</code> directory where your documentation source files will go. Then, you need to create the source docs themselves. Each chapter should have its own gdoc file as should all numbered sub-sections. You will end up with something like:<p class="paragraph"/><div class="code"><pre>+ src/docs/guide/introduction.gdoc
+ src/docs/guide/introduction/changes.gdoc
+ src/docs/guide/gettingStarted.gdoc
+ src/docs/guide/configuration.gdoc
+ src/docs/guide/configuration/build.gdoc
+ src/docs/guide/configuration/build/controllers.gdoc</pre></div><p class="paragraph"/>Note that you can have all your gdoc files in the top-level directory if you want, but you can also put sub-sections in sub-directories named after the parent section - as the above example shows.<p class="paragraph"/>Once you have your source files, you still need to tell the documentation engine what the structure of your user guide is going to be. To do that, you add a <code>src/docs/guide/toc.yml</code> file that contains the structure and titles for each section. This file is in <a href="http://www.yaml.org/" target="blank">YAML</a> format and basically represents the structure of the user guide in tree form. For example, the above files could be represented as:<p class="paragraph"/><div class="code"><pre>introduction:
  title: Introduction
  changes: Change Log
gettingStarted: Getting Started
configuration:
  title: Configuration
  build:
    title: Build Config
    controllers: Specifying Controllers</pre></div><p class="paragraph"/>The format is pretty straightforward. Any section that has sub-sections is represented with the corresponding filename (minus the .gdoc extension) followed by a colon. The next line should contain <code>title:</code> plus the title of the section as seen by the end user. Every sub-section then has its own line after the title. Leaf nodes, i.e. those without any sub-sections, declare their title on the same line as the section name but after the colon.<p class="paragraph"/>That's it. You can easily add, remove, and move sections within the <code>toc.yml</code> to restructure the generated user guide. You should also make sure that all section names, i.e. the gdoc filenames, should be unique since they are used for creating internal links and for the HTML filenames. Don't worry though, the documentation engine will warn you of duplicate section names.
</div><p class="paragraph"/><h4>创建工程文档</h4><p class="paragraph"/>为了使用此引擎，你需要遵循一些约定。首先，你需要创建<code>src/docs/guide</code>目录用来存放文档的源文件。其次，需要创建文档文件，每一章节应该是独立的一个gdoc文件，并且还应该按照子章节的序号排列。比如下面示例：<p class="paragraph"/><div class="code"><pre>+ src/docs/guide/introduction.gdoc
+ src/docs/guide/introduction/changes.gdoc
+ src/docs/guide/gettingStarted.gdoc
+ src/docs/guide/configuration.gdoc
+ src/docs/guide/configuration/build.gdoc
+ src/docs/guide/configuration/build/controllers.gdoc</pre></div><p class="paragraph"/>注意，如果你喜欢，你可以将所有的gdoc文件都放在顶层的目录下。但是你也可以将子章节放到相应名称的子目录中，正如上例所示。<p class="paragraph"/>一旦你的源文件已经完成，你还是需要让文档引擎了知你文档的结构。为此你需要增加一个<code>src/docs/guide/toc.yml</code>文件，用以描述章节的结构和标题。 此<a href="http://www.yaml.org/" target="blank">YAML</a>格式的文件用以表述手册的树形格式的结构。比如上述的文件可以用如下的描述：<p class="paragraph"/><div class="code"><pre>introduction:
  title: Introduction
  changes: Change Log
gettingStarted: Getting Started
configuration:
  title: Configuration
  build:
    title: Build Config
    controllers: Specifying Controllers</pre></div><p class="paragraph"/>此种格式是相当简洁易懂的，一个章节如果含有子章节的话，要在其对应的文件名（当然是去掉.gdoc后缀）后边添加一个冒号（：），紧随其后的一行必须是<code>title:</code>加对此章节的标题描述，在标题后边是每一个子章节的信息。如果子章节是一个叶子节点（不包含子章节的章节）其标题跟章节名称在同一行就好了，但要以冒号分割（可以参考上述示例－－译者注）。<p class="paragraph"/>搞定！你可以轻松地添加、删除和移动<code>toc.yml</code>中的章节，这样就可以重新排版用户手册了。此外你也需要确认所有的章节名称（gdoc文件名称）是全局唯一的，因为那些内部超链接和HTML名称也要用到它们。不过也无需太担心，文档引擎将提示你那些重复的章节名称。<p class="paragraph"/><div class="hidden-block">
<h4>Creating reference items</h4><p class="paragraph"/>Reference items appear in the Quick Reference section of the documentation. Each reference item belongs to a category and a category is a directory located in the <code>src/docs/ref</code> directory. For example, suppose you have defined a new controller method called <code>renderPDF</code>. That belongs to the <code>Controllers</code> category so you would create a gdoc text file at the following location:<p class="paragraph"/><div class="code"><pre>+ src/docs/ref/Controllers/renderPDF.gdoc</pre></div>
</div><p class="paragraph"/><h4>创建条目(Item)引用</h4><p class="paragraph"/>条目引用出现在文档的快速引用章节。每一个引用都属于一个类别，此类别位于<code>src/docs/ref</code>中。举例来说，假设你定义了一个新的控制器方法<code>renderPDF</code>，此方法属于<code>Controllers</code>类别，那么你应该在如下所示的位置创建一个gdoc文本文件：<p class="paragraph"/><div class="code"><pre>+ src/docs/ref/Controllers/renderPDF.gdoc</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Configuring Output Properties</h4><p class="paragraph"/>There are various properties you can set within your <code>grails-app/conf/Config.groovy</code> file that customize the output of the documentation such as:
<ul class="star">
<li><strong class="bold">grails.doc.title</strong> - The title of the documentation</li>
<li><strong class="bold">grails.doc.subtitle</strong> - The subtitle of the documentation</li>
<li><strong class="bold">grails.doc.authors</strong> - The authors of the documentation</li>
<li><strong class="bold">grails.doc.license</strong> - The license of the software</li>
<li><strong class="bold">grails.doc.copyright</strong> - The copyright message to display</li>
<li><strong class="bold">grails.doc.footer</strong> - The footer to use</li>
</ul><p class="paragraph"/>Other properties such as the version are pulled from your project itself.  If a title is not specified, the application name is used.
</div><p class="paragraph"/><h4>配置输出属性</h4><p class="paragraph"/>在<code>grails-app/conf/Config.groovy</code>文件中，你有很多不同的属性可以设置，用以自定义文档的输出，比如：
<ul class="star">
<li><strong class="bold">grails.doc.title</strong> - 文档的标题</li>
<li><strong class="bold">grails.doc.subtitle</strong> - 文档的子标题</li>
<li><strong class="bold">grails.doc.authors</strong> - 文档的作者</li>
<li><strong class="bold">grails.doc.license</strong> - 软件的许可证</li>
<li><strong class="bold">grails.doc.copyright</strong> - 要显示的版权信息</li>
<li><strong class="bold">grails.doc.footer</strong> - 脚注</li>
</ul><p class="paragraph"/>其他的一些，比如版本直接从你的项目中获取。如果标题没有设定，将缺省使用你的应用名称。<p class="paragraph"/><div class="hidden-block">
<h4>Generating Documentation</h4><p class="paragraph"/>Once you have created some documentation (refer to the syntax guide in the next chapter) you can generate an HTML version of the documentation using the command:<p class="paragraph"/><div class="code"><pre>grails doc</pre></div><p class="paragraph"/>This command will output an <code>docs/manual/index.html</code> which can be opened in a browser to view your documentation.
</div><p class="paragraph"/><h4>生成文档</h4><p class="paragraph"/>一旦你创建了文档（语法请参考下一节），你就可以生成HTML版本的文档了，命令如下：<p class="paragraph"/><div class="code"><pre>grails doc</pre></div><p class="paragraph"/>此命令将输出到<code>docs/manual/index.html</code>，这样你就可以在浏览器中查看文档了。<p class="paragraph"/><div class="hidden-block">
<h4>Documentation Syntax</h4><p class="paragraph"/>As mentioned the syntax is largely similar to Textile or Confluence style wiki markup. The following sections walk you through the syntax basics.
</div><p class="paragraph"/><h4>文档语法</h4><p class="paragraph"/>正如以前所述，文档语法跟Textile或者Confluence风格的wiki标签。下述章节将对基本的语法做个简单地介绍。<p class="paragraph"/><div class="hidden-block">
<h5>Basic Formatting</h5><p class="paragraph"/>Monospace: <code>monospace</code>
<div class="code"><pre>&#64;monospace&#64;</pre></div><p class="paragraph"/>Italic:  <em class="italic">italic</em> 
<div class="code"><pre>&#95;italic&#95;</pre></div><p class="paragraph"/>Bold: <strong class="bold">bold</strong>
<div class="code"><pre>&#42;bold&#42;</pre></div><p class="paragraph"/>Image:
<img border="0" class="center" src="http://grails.org/images/new/grailslogo_topNav.png"></img><p class="paragraph"/><div class="code"><pre>&#33;http://grails.org/images/new/grailslogo_topNav.png&#33;</pre></div>
</div><p class="paragraph"/><h5>基本格式</h5><p class="paragraph"/>等宽字体: <code>monospace</code>
<div class="code"><pre>&#64;monospace&#64;</pre></div><p class="paragraph"/>斜体:  <em class="italic">italic</em> 
<div class="code"><pre>&#95;italic&#95;</pre></div><p class="paragraph"/>黑体: <strong class="bold">bold</strong>
<div class="code"><pre>&#42;bold&#42;</pre></div><p class="paragraph"/>图像:
<img border="0" class="center" src="http://grails.org/images/new/grailslogo_topNav.png"></img><p class="paragraph"/><div class="code"><pre>&#33;http://grails.org/images/new/grailslogo_topNav.png&#33;</pre></div><p class="paragraph"/><div class="hidden-block">
<h5>Linking</h5><p class="paragraph"/>There are several ways to create links with the documentation generator. A basic external link can either be defined using confluence or textile style markup:<p class="paragraph"/><div class="code"><pre>&#91;SpringSource|http://www.springsource.com/&#93;</pre></div><p class="paragraph"/>or<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"SpringSource"</span>:http://www.springsource.com/</pre></div><p class="paragraph"/>For links to other sections inside the user guide you can use the <code>guide:</code> prefix with the name of the section you want to link to:<p class="paragraph"/><div class="code"><pre>&#91;Intro|guide:introduction&#93;</pre></div><p class="paragraph"/>The section name comes from the corresponding gdoc filename. The documentation engine will warn you if any links to sections in your guide break.<p class="paragraph"/>To link to reference items you can use a special syntax:<p class="paragraph"/><div class="code"><pre>&#91;controllers|renderPDF&#93;</pre></div><p class="paragraph"/>In this case the category of the reference item is on the left hand side of the | and the name of the reference item on the right.<p class="paragraph"/>Finally, to link to external APIs you can use the <code>api:</code> prefix. For example:<p class="paragraph"/><div class="code"><pre>&#91;<span class="java&#45;object">String</span>|api:java.lang.<span class="java&#45;object">String</span>&#93;</pre></div><p class="paragraph"/>The documentation engine will automatically create the appropriate javadoc link in this case. To add additional APIs to the engine you can configure them in <code>grails-app/conf/Config.groovy</code>. For example:<p class="paragraph"/><div class="code"><pre>grails.doc.api.org.hibernate=
            <span class="java&#45;quote">"http://docs.jboss.org/hibernate/stable/core/javadocs"</span></pre></div><p class="paragraph"/>The above example configures classes within the <code>org.hibernate</code> package to link to the Hibernate website's API docs.
</div><p class="paragraph"/><h5>超链接</h5><p class="paragraph"/>文档生成链接的方式有几种，基本的外部链接（指向本文档之外的超链接－－译者注）可以使用confluence或者textile风格的标签：<p class="paragraph"/><div class="code"><pre>&#91;SpringSource|http://www.springsource.com/&#93;</pre></div><p class="paragraph"/>或者<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"SpringSource"</span>:http://www.springsource.com/</pre></div><p class="paragraph"/>对于指向本文档其他章节的链接，可以使用<code>guide:</code>前缀和你要指向的章节名称：<p class="paragraph"/><div class="code"><pre>&#91;Intro|guide:introduction&#93;</pre></div><p class="paragraph"/>章节的名称要跟gdoc文件名称相对应。如果你指向的章节不存在，文档引擎会给你一个警告提示。<p class="paragraph"/>要指向条目引用，你可以使用如下特殊语法：<p class="paragraph"/><div class="code"><pre>&#91;controllers|renderPDF&#93;</pre></div><p class="paragraph"/>此种情况，要引用的类别名称在|左边，而要引用的条目名称位于右边。<p class="paragraph"/>最后，要指向外部API，你可以使用<code>api:</code>前缀。比如：<p class="paragraph"/><div class="code"><pre>&#91;<span class="java&#45;object">String</span>|api:java.lang.<span class="java&#45;object">String</span>&#93;</pre></div><p class="paragraph"/>文档引擎将自动生成合适的javadoc链接。对于额外的API，你可以通过<code>grails-app/conf/Config.groovy</code>来进行配置，比如：<p class="paragraph"/><div class="code"><pre>grails.doc.api.org.hibernate=
            <span class="java&#45;quote">"http://docs.jboss.org/hibernate/stable/core/javadocs"</span></pre></div><p class="paragraph"/>上述示例中，配置<code>org.hibernate</code>包指向Hibernate的官方API文档。<p class="paragraph"/><div class="hidden-block">
<h5>Lists and Headings</h5><p class="paragraph"/>Headings can be created by specifying the letter 'h' followed by a number and then a dot:<p class="paragraph"/><div class="code"><pre>h3.&#60;space&#62;Heading3
h4.&#60;space&#62;Heading4</pre></div><p class="paragraph"/>Unordered lists are defined with the use of the * character:<p class="paragraph"/><div class="code"><pre>&#42; item 1
&#42;&#42; subitem 1
&#42;&#42; subitem 2
&#42; item 2</pre></div><p class="paragraph"/>Numbered lists can be defined with the # character:<p class="paragraph"/><div class="code"><pre>&#35; item 1</pre></div><p class="paragraph"/>Tables can be created using the <code>table</code> macro:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Name</strong></th><th><strong class="bold">Number</strong></th></tr><tr class="table-odd"><td>Albert</td><td>46</td></tr><tr class="table-even"><td>Wilma</td><td>1348</td></tr><tr class="table-odd"><td>James</td><td>12</td></tr></table><p class="paragraph"/><div class="code"><pre>&#123;table&#125;
 &#42;Name&#42; | &#42;<span class="java&#45;object">Number</span>&#42;
 Albert | 46
 Wilma | 1348
 James | 12
&#123;table&#125;</pre></div>
</div><p class="paragraph"/><h5>列表和标头</h5><p class="paragraph"/>标头可以通过字母'h'加数字再加一个点来表示，比如：<p class="paragraph"/><div class="code"><pre>h3.&#60;space&#62;Heading3
h4.&#60;space&#62;Heading4</pre></div><p class="paragraph"/>无序的列表可以通过*字符来定义：<p class="paragraph"/><div class="code"><pre>&#42; item 1
&#42;&#42; subitem 1
&#42;&#42; subitem 2
&#42; item 2</pre></div><p class="paragraph"/>有序的列表可以通过#来定义：<p class="paragraph"/><div class="code"><pre>&#35; item 1</pre></div><p class="paragraph"/>表格可以通过宏<code>table</code>来实现：<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Name</strong></th><th><strong class="bold">Number</strong></th></tr><tr class="table-odd"><td>Albert</td><td>46</td></tr><tr class="table-even"><td>Wilma</td><td>1348</td></tr><tr class="table-odd"><td>James</td><td>12</td></tr></table><p class="paragraph"/><div class="code"><pre>&#123;table&#125;
 &#42;Name&#42; | &#42;<span class="java&#45;object">Number</span>&#42;
 Albert | 46
 Wilma | 1348
 James | 12
&#123;table&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h5>Code and Notes</h5><p class="paragraph"/>You can define code blocks with the <code>code</code> macro:<p class="paragraph"/><div class="code"><pre>class Book &#123;
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>&#123;code&#125;
class Book &#123;
    <span class="java&#45;object">String</span> title
&#125;
&#123;code&#125;</pre></div><p class="paragraph"/>The example above provides syntax highlighting for Java and Groovy code, but you can also highlight XML markup:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;hello&#62;</span>world<span class="xml&#45;tag">&#60;/hello&#62;</span></pre></div><p class="paragraph"/><div class="code"><pre>&#123;code:xml&#125;
&#60;hello&#62;world&#60;/hello&#62;
&#123;code&#125;</pre></div><p class="paragraph"/>There are also a couple of macros for displaying notes and warnings:<p class="paragraph"/>Note:
<blockquote class="note">
This is a note!
</blockquote><p class="paragraph"/><div class="code"><pre>&#123;note&#125;
This is a note!
&#123;note&#125;</pre></div><p class="paragraph"/>Warning:<p class="paragraph"/><blockquote class="warning">
This is a warning!
</blockquote><p class="paragraph"/><div class="code"><pre>&#123;warning&#125;
This is a warning!
&#123;warning&#125;</pre></div>
</div><p class="paragraph"/><h5>代码和提示</h5><p class="paragraph"/>你可以通过宏<code>code</code>来定义代码块，比如：<p class="paragraph"/><div class="code"><pre>class Book &#123;
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>&#123;code&#125;
class Book &#123;
    <span class="java&#45;object">String</span> title
&#125;
&#123;code&#125;</pre></div><p class="paragraph"/>上述示例展示了Java和Groovy代码的高亮语法显示，但是你也可以高亮XML标签，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;hello&#62;</span>world<span class="xml&#45;tag">&#60;/hello&#62;</span></pre></div><p class="paragraph"/><div class="code"><pre>&#123;code:xml&#125;
&#60;hello&#62;world&#60;/hello&#62;
&#123;code&#125;</pre></div><p class="paragraph"/>还有一些用于提示和警告的宏：<p class="paragraph"/>Note:
<blockquote class="note">
This is a note!
</blockquote><p class="paragraph"/><div class="code"><pre>&#123;note&#125;
This is a note!
&#123;note&#125;</pre></div><p class="paragraph"/>Warning:<p class="paragraph"/><blockquote class="warning">
This is a warning!
</blockquote><p class="paragraph"/><div class="code"><pre>&#123;warning&#125;
This is a warning!
&#123;warning&#125;</pre></div>


<a name="3.7 Dependency Resolution"><!-- Legacy link --></a>
<h2 id="ivy">3.7 依赖解析</h2>
<div class="hidden-block">
Grails features a dependency resolution DSL that lets you control how plugins and JAR dependencies are resolved.<p class="paragraph"/>You specify a <code>grails.project.dependency.resolution</code> property inside the <code>grails-app/conf/BuildConfig.groovy</code> file that configures how dependencies are resolved:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
   // config here
&#125;</pre></div><p class="paragraph"/>The default configuration looks like the following:<p class="paragraph"/><div class="code"><pre>grails.project.class.dir = <span class="java&#45;quote">"target/classes"</span>
grails.project.test.class.dir = <span class="java&#45;quote">"target/test&#45;classes"</span>
grails.project.test.reports.dir = <span class="java&#45;quote">"target/test&#45;reports"</span>
//grails.project.war.file = <span class="java&#45;quote">"target/&#36;&#123;appName&#125;&#45;&#36;&#123;appVersion&#125;.war"</span><p class="paragraph"/>grails.project.dependency.resolution = &#123;
    // inherit Grails' <span class="java&#45;keyword">default</span> dependencies
    inherits(<span class="java&#45;quote">"global"</span>) &#123;
        // uncomment to disable ehcache
        // excludes 'ehcache'
    &#125;
    log <span class="java&#45;quote">"warn"</span>
    repositories &#123;
        grailsPlugins()
        grailsHome()
        grailsCentral()<p class="paragraph"/>        // uncomment these to enable remote dependency resolution
        // from <span class="java&#45;keyword">public</span> Maven repositories
        //mavenCentral()
        //mavenLocal()
        //mavenRepo <span class="java&#45;quote">"http://snapshots.repository.codehaus.org"</span>
        //mavenRepo <span class="java&#45;quote">"http://repository.codehaus.org"</span>
        //mavenRepo <span class="java&#45;quote">"http://download.java.net/maven/2/"</span>
        //mavenRepo <span class="java&#45;quote">"http://repository.jboss.com/maven2/"</span>
    &#125;
    dependencies &#123;
        // specify dependencies here under either 'build', 'compile',
        // 'runtime', 'test' or 'provided' scopes eg.<p class="paragraph"/>        // runtime 'mysql:mysql&#45;connector&#45;java:5.1.16'
    &#125;<p class="paragraph"/>    plugins &#123;
        compile <span class="java&#45;quote">"&#58;hibernate:&#36;grailsVersion"</span>
        compile <span class="java&#45;quote">"&#58;jquery:1.6.1.1"</span>
        compile <span class="java&#45;quote">"&#58;resources:1.0"</span><p class="paragraph"/>        build <span class="java&#45;quote">"&#58;tomcat:&#36;grailsVersion"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The details of the above will be explained in the next few sections.
</div><p class="paragraph"/>Grails提供了依赖解析的DSL来处理插件和JAR的依赖处理。<p class="paragraph"/>你可以在<code>grails-app/conf/BuildConfig.groovy</code>中设置<code>grails.project.dependency.resolution</code>属性来配置依赖是如何解析的，模板如下：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
   // config here
&#125;</pre></div><p class="paragraph"/>其缺省的配置如下所示：<p class="paragraph"/><div class="code"><pre>grails.project.class.dir = <span class="java&#45;quote">"target/classes"</span>
grails.project.test.class.dir = <span class="java&#45;quote">"target/test&#45;classes"</span>
grails.project.test.reports.dir = <span class="java&#45;quote">"target/test&#45;reports"</span>
//grails.project.war.file = <span class="java&#45;quote">"target/&#36;&#123;appName&#125;&#45;&#36;&#123;appVersion&#125;.war"</span><p class="paragraph"/>grails.project.dependency.resolution = &#123;
    // inherit Grails' <span class="java&#45;keyword">default</span> dependencies
    inherits(<span class="java&#45;quote">"global"</span>) &#123;
        // uncomment to disable ehcache
        // excludes 'ehcache'
    &#125;
    log <span class="java&#45;quote">"warn"</span>
    repositories &#123;
        grailsPlugins()
        grailsHome()
        grailsCentral()<p class="paragraph"/>        // uncomment these to enable remote dependency resolution
        // from <span class="java&#45;keyword">public</span> Maven repositories
        //mavenCentral()
        //mavenLocal()
        //mavenRepo <span class="java&#45;quote">"http://snapshots.repository.codehaus.org"</span>
        //mavenRepo <span class="java&#45;quote">"http://repository.codehaus.org"</span>
        //mavenRepo <span class="java&#45;quote">"http://download.java.net/maven/2/"</span>
        //mavenRepo <span class="java&#45;quote">"http://repository.jboss.com/maven2/"</span>
    &#125;
    dependencies &#123;
        // specify dependencies here under either 'build', 'compile',
        // 'runtime', 'test' or 'provided' scopes eg.<p class="paragraph"/>        // runtime 'mysql:mysql&#45;connector&#45;java:5.1.16'
    &#125;<p class="paragraph"/>    plugins &#123;
        compile <span class="java&#45;quote">"&#58;hibernate:&#36;grailsVersion"</span>
        compile <span class="java&#45;quote">"&#58;jquery:1.6.1.1"</span>
        compile <span class="java&#45;quote">"&#58;resources:1.0"</span><p class="paragraph"/>        build <span class="java&#45;quote">"&#58;tomcat:&#36;grailsVersion"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>上述示例的详细描述将会在下来的几个章节中解释。


<a name="3.7.1 Configurations and Dependencies"><!-- Legacy link --></a>
<h2 id="configurationsAndDependencies">3.7.1 配置和依赖</h2>
<div class="hidden-block">
Grails features five dependency resolution configurations (or 'scopes'):
<ul class="star">
<li> <code>build</code>: Dependencies for the build system only</li>
<li> <code>compile</code>: Dependencies for the compile step</li>
<li> <code>runtime</code>: Dependencies needed at runtime but not for compilation (see above)</li>
<li> <code>test</code>: Dependencies needed for testing but not at runtime (see above)</li>
<li> <code>provided</code>: Dependencies needed at development time, but not during WAR deployment</li>
</ul><p class="paragraph"/>Within the <code>dependencies</code> block you can specify a dependency that falls into one of these configurations by calling the equivalent method. For example if your application requires the MySQL driver to function at <code>runtime</code> you can specify that like this:<p class="paragraph"/><div class="code"><pre>runtime 'com.mysql:mysql&#45;connector&#45;java:5.1.16'</pre></div><p class="paragraph"/>This uses the string syntax: <code>group:name:version</code>. You can also use a Map-based syntax:<p class="paragraph"/><div class="code"><pre>runtime group: 'com.mysql',
        name: 'mysql&#45;connector&#45;java',
        version: '5.1.16'</pre></div><p class="paragraph"/>In Maven terminology, <code>group</code> corresponds to an artifact's <code>groupId</code> and <code>name</code> corresponds to its <code>artifactId</code>.<p class="paragraph"/>Multiple dependencies can be specified by passing multiple arguments:<p class="paragraph"/><div class="code"><pre>runtime 'com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1'<p class="paragraph"/>// Or<p class="paragraph"/>runtime(
    &#91;group:'com.mysql', name:'mysql&#45;connector&#45;java', version:'5.1.16'&#93;,
    &#91;group:'net.sf.ehcache', name:'ehcache', version:'1.6.1'&#93;
)</pre></div>
</div><p class="paragraph"/>Grails提供了如下5种依赖解析配置（或者是‘范围’）：
<ul class="star">
<li> <code>build</code>: 只在系统构建时的依赖</li>
<li> <code>compile</code>: 编译阶段时的依赖</li>
<li> <code>runtime</code>: 运行阶段的依赖，不包括编译阶段（见上解释）</li>
<li> <code>test</code>: 测试阶段的依赖，不包括运行阶段</li>
<li> <code>provided</code>: 开发阶段的依赖，不包括WAR部署阶段</li>
</ul><p class="paragraph"/>在<code>dependencies</code>代码块中，你可以通过同等的方法调用方式来指定一个依赖。比如你的应用中需要<code>runtime</code>的MySQL驱动，你可以这样处理：<p class="paragraph"/><div class="code"><pre>runtime 'com.mysql:mysql&#45;connector&#45;java:5.1.16'</pre></div><p class="paragraph"/>此处使用了字符串语法，其格式是：<code>group:name:version</code>，你也可以使用Map格式的语法：<p class="paragraph"/><div class="code"><pre>runtime group: 'com.mysql',
        name: 'mysql&#45;connector&#45;java',
        version: '5.1.16'</pre></div><p class="paragraph"/>对应于Maven术语，<code>group</code>跟工件（artifact）的<code>groupId</code>相对应，<code>name</code>跟<code>artifactId</code>相对应。<p class="paragraph"/>多个依赖可以通过多参数方式来处理：<p class="paragraph"/><div class="code"><pre>runtime 'com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1'<p class="paragraph"/>// Or<p class="paragraph"/>runtime(
    &#91;group:'com.mysql', name:'mysql&#45;connector&#45;java', version:'5.1.16'&#93;,
    &#91;group:'net.sf.ehcache', name:'ehcache', version:'1.6.1'&#93;
)</pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Disabling transitive dependency resolution</h3><p class="paragraph"/>By default, Grails will not only get the JARs and plugins that you declare, but it will also get their transitive dependencies. This is usually what you want, but there are occasions where you want a dependency without all its baggage. In such cases, you can disable transitive dependency resolution on a case-by-case basis:<p class="paragraph"/><div class="code"><pre>runtime('com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1') &#123;
    transitive = <span class="java&#45;keyword">false</span>
&#125;<p class="paragraph"/>// Or
runtime group:'com.mysql',
        name:'mysql&#45;connector&#45;java',
        version:'5.1.16',
        transitive:<span class="java&#45;keyword">false</span></pre></div>
</div><p class="paragraph"/><h3>禁用依赖解析的传递性</h3><p class="paragraph"/>缺省情况下，Grails不仅仅获取你直接声明的JAR和插件，还包含其间接所依赖的。多数情况下，这正是你所需要的，不过在个别情况下，你并不需要这种传递性的依赖。这时，你可以有针对地禁止传递依赖，比如：<p class="paragraph"/><div class="code"><pre>runtime('com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1') &#123;
    transitive = <span class="java&#45;keyword">false</span>
&#125;<p class="paragraph"/>// Or
runtime group:'com.mysql',
        name:'mysql&#45;connector&#45;java',
        version:'5.1.16',
        transitive:<span class="java&#45;keyword">false</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Excluding specific transitive dependencies</h3><p class="paragraph"/>A far more common scenario is where you want the transitive dependencies, but some of them cause issues with your own dependencies or are unnecessary. For example, many Apache projects have 'commons-logging' as a transitive dependency, but it shouldn't be included in a Grails project (we use SLF4J). That's where the <code>excludes</code> option comes in:<p class="paragraph"/><div class="code"><pre>runtime('com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1') &#123;
    excludes <span class="java&#45;quote">"xml&#45;apis"</span>, <span class="java&#45;quote">"commons&#45;logging"</span>
&#125;<p class="paragraph"/>// Or
runtime(group:'com.mysql', name:'mysql&#45;connector&#45;java', version:'5.1.16') &#123;
    excludes(&#91; group: 'xml&#45;apis', name: 'xml&#45;apis'&#93;,
             &#91; group: 'org.apache.httpcomponents' &#93;,
             &#91; name: 'commons&#45;logging' &#93;)</pre></div><p class="paragraph"/>As you can see, you can either exclude dependencies by their artifact ID (also known as a module name) or any combination of group and artifact IDs (if you use the Map notation). You may also come across <code>exclude</code> as well, but that can only accept a single string or Map:<p class="paragraph"/><div class="code"><pre>runtime('com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1') &#123;
    exclude <span class="java&#45;quote">"xml&#45;apis"</span>
&#125;</pre></div>
</div><p class="paragraph"/><h3>排除特定的依赖</h3><p class="paragraph"/>传递依赖对你来说是如此的常用，但也有会跟你自己的依赖冲突或者重复的情况，比如很多的Apache项目都有依赖于'commons-logging'，但是它不能被包含于Grails工程（其使用的是SLF4J）。因此就产生了<code>excludes</code>选项，比如：<p class="paragraph"/><div class="code"><pre>runtime('com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1') &#123;
    excludes <span class="java&#45;quote">"xml&#45;apis"</span>, <span class="java&#45;quote">"commons&#45;logging"</span>
&#125;<p class="paragraph"/>// Or
runtime(group:'com.mysql', name:'mysql&#45;connector&#45;java', version:'5.1.16') &#123;
    excludes(&#91; group: 'xml&#45;apis', name: 'xml&#45;apis'&#93;,
             &#91; group: 'org.apache.httpcomponents' &#93;,
             &#91; name: 'commons&#45;logging' &#93;)</pre></div><p class="paragraph"/>如你所见，你可以通过工件ID（又名模块名称）或者组名加工件ID的方式来排除特定的依赖。你也可以通过<code>exclude</code>来排除，不过此处只能接收一个字符串或者Map：<p class="paragraph"/><div class="code"><pre>runtime('com.mysql:mysql&#45;connector&#45;java:5.1.16',
        'net.sf.ehcache:ehcache:1.6.1') &#123;
    exclude <span class="java&#45;quote">"xml&#45;apis"</span>
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h3>Using Ivy module configurations</h3><p class="paragraph"/>If you use Ivy module configurations and wish to depend on a specific configuration of a module, you can use the <code>dependencyConfiguration</code> method to specify the configuration to use.<p class="paragraph"/><div class="code"><pre>provided(<span class="java&#45;quote">"my.org:web&#45;service:1.0"</span>) &#123;
    dependencyConfiguration <span class="java&#45;quote">"api"</span>
&#125;</pre></div><p class="paragraph"/>If the dependency configuration is not explicitly set, the configuration named <code>"default"</code> will be used (which is also the correct value for dependencies coming from Maven style repositories).
</div><p class="paragraph"/><h3>使用Ivy模块配置</h3><p class="paragraph"/>如果你是使用Ivy的模块配置，并且希望依赖于某一特定模块，你可以使用<code>dependencyConfiguration</code>方法来指定：<p class="paragraph"/><div class="code"><pre>provided(<span class="java&#45;quote">"my.org:web&#45;service:1.0"</span>) &#123;
    dependencyConfiguration <span class="java&#45;quote">"api"</span>
&#125;</pre></div><p class="paragraph"/>如果依赖配置没有明确指定，那么将被使用名为<code>"default"</code>缺省配置（其也可以兼容来自Maven风格的存储仓库）。<p class="paragraph"/><div class="hidden-block">
<h3>Where are the JARs?</h3><p class="paragraph"/>With all these declarative dependencies, you may wonder where all the JARs end up. They have to go somewhere after all. By default Grails puts them into a directory, called the dependency cache, that resides on your local file system at <code>user.home</code>/.grails/ivy-cache. You can change this either via the <code>settings.groovy</code> file:<p class="paragraph"/><div class="code"><pre>grails.dependency.cache.dir = <span class="java&#45;quote">"$&#123;userHome&#125;/.my&#45;dependency&#45;cache"</span></pre></div><p class="paragraph"/>or in the dependency DSL:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    &#8230;
    cacheDir <span class="java&#45;quote">"target/ivy&#45;cache"</span>
    &#8230;
&#125;</pre></div><p class="paragraph"/>The <code>settings.groovy</code> option applies to all projects, so it's the preferred approach.
</div><p class="paragraph"/><h3>JAR在哪里？</h3><p class="paragraph"/>对于所有声明的依赖，你可能好奇，这些JAR都到哪里去了？它们总要有个地方来保存的。缺省情况下，Grails将它们放到依赖缓存的目录，其位于你本地文件系统中<code>user.home</code>/.grails/ivy-cache。你也可以通过<code>settings.groovy</code>来修改，比如：<p class="paragraph"/><div class="code"><pre>grails.dependency.cache.dir = <span class="java&#45;quote">"$&#123;userHome&#125;/.my&#45;dependency&#45;cache"</span></pre></div><p class="paragraph"/>或者使用依赖DSL：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    &#8230;
    cacheDir <span class="java&#45;quote">"target/ivy&#45;cache"</span>
    &#8230;
&#125;</pre></div><p class="paragraph"/><code>settings.groovy</code>的选项将应用于所有的工程，因为它是最优先使用的。


<a name="3.7.2 Dependency Repositories"><!-- Legacy link --></a>
<h2 id="dependencyRepositories">3.7.2 依赖存储库</h2>
<div class="hidden-block">
<h4>Remote Repositories</h4><p class="paragraph"/>Initially your BuildConfig.groovy does not use any remote public Maven repositories. There is a default <code>grailsHome()</code> repository that will locate the JAR files Grails needs from your Grails installation. To use a public repository, specify it in the <code>repositories</code> block:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenCentral()
&#125;</pre></div><p class="paragraph"/>In this case the default public Maven repository is specified. To use the SpringSource Enterprise Bundle Repository you can use the <code>ebr()</code> method:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    ebr()
&#125;</pre></div><p class="paragraph"/>You can also specify a specific Maven repository to use by URL:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenRepo <span class="java&#45;quote">"http://repository.codehaus.org"</span>
&#125;</pre></div><p class="paragraph"/>and even give it a name:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenRepo name: <span class="java&#45;quote">"Codehaus"</span>, root: <span class="java&#45;quote">"http://repository.codehaus.org"</span>
&#125;</pre></div><p class="paragraph"/>so that you can easily identify it in logs.
</div><p class="paragraph"/><h4>远程存储仓库</h4><p class="paragraph"/>刚创建的BuildConfig.groovy文件并没有使用任何远程的公共Maven存储库，在那里只有一个缺省的 <code>grailsHome()</code>用以从Grails安装目录定位所需要的JAR文件。要使用远程的公共存储库，请使用 <code>repositories</code>代码块，比如：<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenCentral()
&#125;</pre></div><p class="paragraph"/>在上述示例中，指定的是Maven缺省的公共存储库。要使用SpringSource的企业包存储库，你可以使用<code>ebr()</code>方法：<p class="paragraph"/><div class="code"><pre>repositories &#123;
    ebr()
&#125;</pre></div><p class="paragraph"/>你还可以使用URL的方式来指定Maven存储库：<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenRepo <span class="java&#45;quote">"http://repository.codehaus.org"</span>
&#125;</pre></div><p class="paragraph"/>并且可以给其命名：<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenRepo name: <span class="java&#45;quote">"Codehaus"</span>, root: <span class="java&#45;quote">"http://repository.codehaus.org"</span>
&#125;</pre></div><p class="paragraph"/>这样你就可以在日志中轻易地辨别它们。<p class="paragraph"/><div class="hidden-block">
<h4>Controlling Repositories Inherited from Plugins</h4><p class="paragraph"/>A plugin you have installed may define a reference to a remote repository just as an application can. By default your application will inherit this repository definition when you install the plugin.<p class="paragraph"/>If you do not wish to inherit repository definitions from plugins then you can disable repository inheritance:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    inherit <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>In this case your application will not inherit any repository definitions from plugins and it is down to you to provide appropriate (possibly internal) repository definitions.
</div><p class="paragraph"/><h4>控制插件存储库地继承</h4><p class="paragraph"/>通常，你安装的插件会定义一个远程的存储库，缺省情况下，而你的应用将继承你安装插件中的存储库的定义。<p class="paragraph"/>如果你不希望继承来自插件的存储库定义，你可以禁止这种存储库的继承：<p class="paragraph"/><div class="code"><pre>repositories &#123;
    inherit <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>上述示例中，应用将不继承任何插件的存储库的定义，而是仅仅依赖于你定义的存储库。<p class="paragraph"/><div class="hidden-block">
<h4>Offline Mode</h4><p class="paragraph"/>There are times when it is not desirable to connect to any remote repositories (whilst working on the train for example!). In this case you can use the <code>offline</code> flag to execute Grails commands and Grails will not connect to any remote repositories:<p class="paragraph"/><div class="code"><pre>grails &#45;&#45;offline run&#45;app</pre></div><p class="paragraph"/><blockquote class="note">
Note that this command will fail if you do not have the necessary dependencies in your local Ivy cache
</blockquote><p class="paragraph"/>You can also globally configure offline mode by setting <code>grails.offline.mode</code> to <code>true</code> in <code>~/.grails/settings.groovy</code> or in your project's <code>BuildConfig.groovy</code> file:<p class="paragraph"/><div class="code"><pre>grails.offline.mode=<span class="java&#45;keyword">true</span></pre></div>
</div><p class="paragraph"/><h4>离线模式</h4><p class="paragraph"/>偶尔的时候，你将不能访问任何远程的存储库（比如在火车上工作时）。此种情况下，你可以使用<code>offline</code>标志来执行Grails命令，这样Grails将不会连接任何远程存储库，比如：<p class="paragraph"/><div class="code"><pre>grails &#45;&#45;offline run&#45;app</pre></div><p class="paragraph"/><blockquote class="note">
注意：如果你本地Ivy缓存中没有所需的依赖，上述命令将会出错。
</blockquote><p class="paragraph"/>你还可以通过设置<code>~/.grails/settings.groovy</code>或者工程中<code>BuildConfig.groovy</code>文件中的<code>grails.offline.mode</code>为<code>true</code>的方式，将其配置为全局离线模式：<p class="paragraph"/><div class="code"><pre>grails.offline.mode=<span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Local Resolvers</h4><p class="paragraph"/>If you do not wish to use a public Maven repository you can specify a flat file repository:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    flatDir name:'myRepo', dirs:'/path/to/repo'
&#125;</pre></div><p class="paragraph"/>To specify your local Maven cache (<code>~/.m2/repository</code>) as a repository:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenLocal()
&#125;</pre></div>
</div><p class="paragraph"/><h4>本地解析器</h4><p class="paragraph"/>如果你不希望使用远程的Maven存储库，你可以指定一个平面文件（flat file）存储器：<p class="paragraph"/><div class="code"><pre>repositories &#123;
    flatDir name:'myRepo', dirs:'/path/to/repo'
&#125;</pre></div><p class="paragraph"/>将你本地的Maven缓存作为（<code>~/.m2/repository</code>）作为存储器，可以用下面的处理：<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenLocal()
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Custom Resolvers</h4><p class="paragraph"/>If all else fails since Grails builds on Apache Ivy you can specify an Ivy resolver:<p class="paragraph"/><div class="code"><pre>/&#42;
 &#42; Configure our resolver.
 &#42;/
def libResolver = <span class="java&#45;keyword">new</span> org.apache.ivy.plugins.resolver.URLResolver()
&#91;'libraries', 'builds'&#93;.each &#123;<p class="paragraph"/>    libResolver.addArtifactPattern(
            <span class="java&#45;quote">"http://my.repository/&#36;&#123;it&#125;/"</span> +
            <span class="java&#45;quote">"&#91;organisation&#93;/&#91;module&#93;/&#91;revision&#93;/&#91;type&#93;s/&#91;artifact&#93;.&#91;ext&#93;"</span>)<p class="paragraph"/>    libResolver.addIvyPattern(
            <span class="java&#45;quote">"http://my.repository/&#36;&#123;it&#125;/"</span> +
            <span class="java&#45;quote">"&#91;organisation&#93;/&#91;module&#93;/&#91;revision&#93;/&#91;type&#93;s/&#91;artifact&#93;.&#91;ext&#93;"</span>)
&#125;<p class="paragraph"/>libResolver.name = <span class="java&#45;quote">"my&#45;repository"</span>
libResolver.settings = ivySettings<p class="paragraph"/>resolver libResolver</pre></div><p class="paragraph"/>It's also possible to pull dependencies from a repository using SSH. Ivy comes with a dedicated resolver that you can configure and include in your project like so:
<div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.ivy.plugins.resolver.SshResolver
&#8230;
repositories &#123;
    ...<p class="paragraph"/>    def sshResolver = <span class="java&#45;keyword">new</span> SshResolver(
            name: <span class="java&#45;quote">"myRepo"</span>,
            user: <span class="java&#45;quote">"username"</span>,
            host: <span class="java&#45;quote">"dev.x.com"</span>,
            keyFile: <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/home/username/.ssh/id_rsa"</span>),
            m2compatible: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>    sshResolver.addArtifactPattern(
            <span class="java&#45;quote">"/home/grails/repo/&#91;organisation&#93;/&#91;artifact&#93;/"</span> +
            <span class="java&#45;quote">"&#91;revision&#93;/&#91;artifact&#93;&#45;&#91;revision&#93;.&#91;ext&#93;"</span>)<p class="paragraph"/>    sshResolver.latestStrategy =
            <span class="java&#45;keyword">new</span> org.apache.ivy.plugins.latest.LatestTimeStrategy()<p class="paragraph"/>    sshResolver.changingPattern = <span class="java&#45;quote">".&#42;SNAPSHOT"</span><p class="paragraph"/>    sshResolver.setCheckmodified(<span class="java&#45;keyword">true</span>)<p class="paragraph"/>    resolver sshResolver
&#125;</pre></div><p class="paragraph"/>Download the <a href="http://www.jcraft.com/jsch/" target="blank">JSch</a> JAR and add it to Grails' classpath to use the SSH resolver. You can do this by passing the path in the Grails command line:
<div class="code"><pre>grails &#45;classpath /path/to/jsch compile|run&#45;app|etc.</pre></div><p class="paragraph"/>You can also add its path to the <code>CLASSPATH</code> environment variable but be aware this it affects many Java applications. An alternative on Unix is to create an alias for <code>grails -classpath ...</code> so that you don't have to type the extra arguments each time.
</div><p class="paragraph"/><h4>自定义解析器</h4><p class="paragraph"/>如果上述的都失败了，你还可以自定义一个Ivy解析器，因为Grails是基于Apache Ivy构建的：<p class="paragraph"/><div class="code"><pre>/&#42;
 &#42; Configure our resolver.
 &#42;/
def libResolver = <span class="java&#45;keyword">new</span> org.apache.ivy.plugins.resolver.URLResolver()
&#91;'libraries', 'builds'&#93;.each &#123;<p class="paragraph"/>    libResolver.addArtifactPattern(
            <span class="java&#45;quote">"http://my.repository/&#36;&#123;it&#125;/"</span> +
            <span class="java&#45;quote">"&#91;organisation&#93;/&#91;module&#93;/&#91;revision&#93;/&#91;type&#93;s/&#91;artifact&#93;.&#91;ext&#93;"</span>)<p class="paragraph"/>    libResolver.addIvyPattern(
            <span class="java&#45;quote">"http://my.repository/&#36;&#123;it&#125;/"</span> +
            <span class="java&#45;quote">"&#91;organisation&#93;/&#91;module&#93;/&#91;revision&#93;/&#91;type&#93;s/&#91;artifact&#93;.&#91;ext&#93;"</span>)
&#125;<p class="paragraph"/>libResolver.name = <span class="java&#45;quote">"my&#45;repository"</span>
libResolver.settings = ivySettings<p class="paragraph"/>resolver libResolver</pre></div><p class="paragraph"/>此外还可以通过SSH的方式从存储库中获取依赖。为此Ivy提供了一个专门的用于配置的解析器，在你的工程看起来可能如下：
<div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.ivy.plugins.resolver.SshResolver
&#8230;
repositories &#123;
    ...<p class="paragraph"/>    def sshResolver = <span class="java&#45;keyword">new</span> SshResolver(
            name: <span class="java&#45;quote">"myRepo"</span>,
            user: <span class="java&#45;quote">"username"</span>,
            host: <span class="java&#45;quote">"dev.x.com"</span>,
            keyFile: <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/home/username/.ssh/id_rsa"</span>),
            m2compatible: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>    sshResolver.addArtifactPattern(
            <span class="java&#45;quote">"/home/grails/repo/&#91;organisation&#93;/&#91;artifact&#93;/"</span> +
            <span class="java&#45;quote">"&#91;revision&#93;/&#91;artifact&#93;&#45;&#91;revision&#93;.&#91;ext&#93;"</span>)<p class="paragraph"/>    sshResolver.latestStrategy =
            <span class="java&#45;keyword">new</span> org.apache.ivy.plugins.latest.LatestTimeStrategy()<p class="paragraph"/>    sshResolver.changingPattern = <span class="java&#45;quote">".&#42;SNAPSHOT"</span><p class="paragraph"/>    sshResolver.setCheckmodified(<span class="java&#45;keyword">true</span>)<p class="paragraph"/>    resolver sshResolver
&#125;</pre></div><p class="paragraph"/>要使用SSH解析器，先要下载<a href="http://www.jcraft.com/jsch/" target="blank">JSch</a>的JAR到你Grails的类路径（classpath）中，你可以通过命令行的方式来设置，比如：
<div class="code"><pre>grails &#45;classpath /path/to/jsch compile|run&#45;app|etc.</pre></div><p class="paragraph"/>你也可以将路径添加到<code>CLASSPATH</code>环境变量中，不要要注意，这可能会影响很多的Java应用。在Unix下，你可以为<code>grails -classpath ...</code>创建一个别名，这样就可以不需要每次都敲额外的参数了。<p class="paragraph"/><div class="hidden-block">
<h4>Authentication</h4><p class="paragraph"/>If your repository requires authentication you can configure this using a <code>credentials</code> block:<p class="paragraph"/><div class="code"><pre>credentials &#123;
    realm = <span class="java&#45;quote">".."</span>
    host = <span class="java&#45;quote">"localhost"</span>
    username = <span class="java&#45;quote">"myuser"</span>
    password = <span class="java&#45;quote">"mypass"</span>
&#125;</pre></div><p class="paragraph"/>This can be placed in your <code>USER_HOME/.grails/settings.groovy</code> file using the <code>grails.project.ivy.authentication</code> setting:<p class="paragraph"/><div class="code"><pre>grails.project.ivy.authentication = &#123;
    credentials &#123;
        realm = <span class="java&#45;quote">".."</span>
        host = <span class="java&#45;quote">"localhost"</span>
        username = <span class="java&#45;quote">"myuser"</span>
        password = <span class="java&#45;quote">"mypass"</span>
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>验证</h4><p class="paragraph"/>如果你的存储仓库需要验证，那么你可以通过<code>credentials</code>代码块来进行配置，比如：<p class="paragraph"/><div class="code"><pre>credentials &#123;
    realm = <span class="java&#45;quote">".."</span>
    host = <span class="java&#45;quote">"localhost"</span>
    username = <span class="java&#45;quote">"myuser"</span>
    password = <span class="java&#45;quote">"mypass"</span>
&#125;</pre></div><p class="paragraph"/>你也可以通过设置<code>USER_HOME/.grails/settings.groovy</code>文件中的<code>grails.project.ivy.authentication</code>来实现：<p class="paragraph"/><div class="code"><pre>grails.project.ivy.authentication = &#123;
    credentials &#123;
        realm = <span class="java&#45;quote">".."</span>
        host = <span class="java&#45;quote">"localhost"</span>
        username = <span class="java&#45;quote">"myuser"</span>
        password = <span class="java&#45;quote">"mypass"</span>
    &#125;
&#125;</pre></div>


<a name="3.7.3 Debugging Resolution"><!-- Legacy link --></a>
<h2 id="debuggingResolution">3.7.3 调试解析</h2>
<div class="hidden-block">
If you are having trouble getting a dependency to resolve you can enable more verbose debugging from the underlying engine using the <code>log</code> method:<p class="paragraph"/><div class="code"><pre>// log level of Ivy resolver, either 'error', 'warn',
// 'info', 'debug' or 'verbose'
log <span class="java&#45;quote">"warn"</span></pre></div><p class="paragraph"/>A common issue is that the checksums for a dependency don't match the associated JAR file, and so Ivy rejects the dependency. This helps ensure that the dependencies are valid. But for a variety of reasons some dependencies simply don't have valid checksums in the repositories, even if they are valid JARs. To get round this, you can disable Ivy's dependency checks like so:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    &#8230;
    log <span class="java&#45;quote">"warn"</span>
    checksums <span class="java&#45;keyword">false</span>
    &#8230;
&#125;</pre></div><p class="paragraph"/>This is a global setting, so only use it if you have to.
</div><p class="paragraph"/>如果你解析依赖遇到了问题的话，你可以使用基本的<code>log</code>方法来显示更多的调试信息：<p class="paragraph"/><div class="code"><pre>// log level of Ivy resolver, either 'error', 'warn',
// 'info', 'debug' or 'verbose'
log <span class="java&#45;quote">"warn"</span></pre></div><p class="paragraph"/>一个常见的问题是依赖的校验码跟其相应的JAR文件不匹配，这将导致Ivy不接收此依赖。此举用以保证依赖的有效性，但是由于不确定的原因，导致有些依赖在存储仓库中即使存在有效的JAR，也还是没有有效的校验码。要解决此问题，你可以禁用Ivy的依赖检测，比如：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    &#8230;
    log <span class="java&#45;quote">"warn"</span>
    checksums <span class="java&#45;keyword">false</span>
    &#8230;
&#125;</pre></div><p class="paragraph"/>这是个全局设置，因此请在不得已的时候才使用。


<a name="3.7.4 Inherited Dependencies"><!-- Legacy link --></a>
<h2 id="inheritedDependencies">3.7.4 依赖继承</h2>
<div class="hidden-block">
By default every Grails application inherits several framework dependencies. This is done through the line:<p class="paragraph"/><div class="code"><pre>inherits <span class="java&#45;quote">"global"</span></pre></div><p class="paragraph"/>Inside the <code>BuildConfig.groovy</code> file. To exclude specific inherited dependencies you use the <code>excludes</code> method:<p class="paragraph"/><div class="code"><pre>inherits(<span class="java&#45;quote">"global"</span>) &#123;
    excludes <span class="java&#45;quote">"oscache"</span>, <span class="java&#45;quote">"ehcache"</span>
&#125;</pre></div>
</div><p class="paragraph"/>缺省情况下，每一个Grails应用都继承多个框架依赖，配置如下：<p class="paragraph"/><div class="code"><pre>inherits <span class="java&#45;quote">"global"</span></pre></div><p class="paragraph"/>在<code>BuildConfig.groovy</code>文件中，你可以通过<code>excludes</code>方法来排除掉指定的依赖，比如：<p class="paragraph"/><div class="code"><pre>inherits(<span class="java&#45;quote">"global"</span>) &#123;
    excludes <span class="java&#45;quote">"oscache"</span>, <span class="java&#45;quote">"ehcache"</span>
&#125;</pre></div>


<a name="3.7.5 Providing Default Dependencies"><!-- Legacy link --></a>
<h2 id="providingDefaultDependencies">3.7.5 缺省的依赖</h2>
<div class="hidden-block">
Most Grails applications have runtime dependencies on several jar files that are provided by the Grails framework.  These include libraries like Spring, Sitemesh, Hibernate etc.  When a war file is created, all of these dependencies will be included in it.  But, an application may choose to exclude these jar files from the war.  This is useful when the jar files will be provided by the container, as would normally be the case if multiple Grails applications are deployed to the same container.<p class="paragraph"/>The dependency resolution DSL provides a mechanism to express that all of the default dependencies will be provided by the container. This is done by invoking the <code>defaultDependenciesProvided</code> method and passing <code>true</code> as an argument:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;<p class="paragraph"/>    defaultDependenciesProvided <span class="java&#45;keyword">true</span> // all of the <span class="java&#45;keyword">default</span> dependencies will
                                     // be <span class="java&#45;quote">"provided"</span> by the container<p class="paragraph"/>    inherits <span class="java&#45;quote">"global"</span> // inherit Grails' <span class="java&#45;keyword">default</span> dependencies<p class="paragraph"/>    repositories &#123;
        grailsHome()
        &#8230;
    &#125;
    dependencies &#123;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
<code>defaultDependenciesProvided</code> must come before <code>inherits</code>, otherwise the Grails dependencies will be included in the war.
</blockquote>
</div><p class="paragraph"/>大部分的Grails应用依赖于Grails框架自带的一些jar文件，比如Spring、Sitemesh和Hibernate等等。当创建一个war文件的时候。但是应用还是可以选择从war中排除这些jar文件的。这非常适合于本身容器已经包含这些jar文件的情况，尤其多个Grails应用部署于这样同一容器中。<p class="paragraph"/>解析依赖的DSL就有让容器提供缺省依赖的选项，这可以通过传递<code>true</code>给<code>defaultDependenciesProvided</code>方法来实现：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;<p class="paragraph"/>    defaultDependenciesProvided <span class="java&#45;keyword">true</span> // all of the <span class="java&#45;keyword">default</span> dependencies will
                                     // be <span class="java&#45;quote">"provided"</span> by the container<p class="paragraph"/>    inherits <span class="java&#45;quote">"global"</span> // inherit Grails' <span class="java&#45;keyword">default</span> dependencies<p class="paragraph"/>    repositories &#123;
        grailsHome()
        &#8230;
    &#125;
    dependencies &#123;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
<code>defaultDependenciesProvided</code>必须位于<code>inherits</code>之前，否则Grails的依赖还是会被包含到war中。
</blockquote>



<h2 id="changingDependencies">3.7.6 快照和其他变化的依赖</h2>
<div class="hidden-block">
Typically, dependencies are constant. That is, for a given combination of <code>group</code>, <code>name</code> and <code>version</code> the jar (or plugin) that it refers to will never change. The Grails dependency management system uses this fact to cache dependencies in order to avoid having to download them from the source repository each time. Sometimes this is not desirable. For example, many developers use the convention of a  <em class="italic">snapshot</em>  (i.e. a dependency with a version number ending in “-SNAPSHOT”) that can change from time to time while still retaining the same version number. We call this a "changing dependency".<p class="paragraph"/>Whenever you have a changing dependency, Grails will always check the remote repository for a new version. More specifically, when a changing dependency is encountered during dependency resolution its last modified timestamp in the local cache is compared against the last modified timestamp in the dependency repositories. If the version on the remote server is deemed to be newer than the version in the local cache, the new version will be downloaded and used.<p class="paragraph"/>{info}
Be sure to read the next section on “Dependency Resolution Caching” in addition to this one as it affects changing dependencies.
{info}<p class="paragraph"/>All dependencies (jars and plugins) with a version number ending in <code>-SNAPSHOT</code> are <strong class="bold">implicitly</strong> considered to be changing by Grails. You can also explicitly specify that a dependency is changing by setting the changing flag in the dependency DSL:<p class="paragraph"/><div class="code"><pre>runtime ('org.my:lib:1.2.3') &#123;
    changing = <span class="java&#45;keyword">true</span>
&#125;</pre></div><p class="paragraph"/>There is a caveat to the support for changing dependencies that you should be aware of. Grails will stop looking for newer versions of a dependency once it finds a remote repository that has the dependency.<p class="paragraph"/>Consider the following setup:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    repositories &#123;
        mavenLocal()
        mavenRepo <span class="java&#45;quote">"http://my.org/repo"</span>
    &#125;
    dependencies &#123;
        compile <span class="java&#45;quote">"myorg:mylib:1.0&#45;SNAPSHOT"</span>
    &#125;</pre></div><p class="paragraph"/>In this example we are using the local maven repository and a remote network maven repository. Assuming that the local Grails dependency and the local Maven cache do not contain the dependency but the remote repository does, when we perform dependency resolution the following actions will occur:
<ul class="star">
<li>maven local repository is searched, dependency not found</li>
<li>maven network repository is searched, dependency is downloaded to the cache and used</li>
</ul><p class="paragraph"/>Note that the repositories are checked in the order they are defined in the <code>BuildConfig.groovy</code> file.<p class="paragraph"/>If we perform dependency resolution again without the dependency changing on the remote server, the following will happen:
<ul class="star">
<li>maven local repository is searched, dependency not found</li>
<li>maven network repository is searched, dependency is found to be the same “age” as the version in the cache so will not be updated (i.e. downloaded)</li>
</ul><p class="paragraph"/>Later on, a new version of <code>mylib 1.0-SNAPSHOT</code> is published changing the version on the server. The next time we perform dependency resolution, the following will happen:
<ul class="star">
<li>maven local repository is searched, dependency not found</li>
<li>maven network repository is searched, dependency is found to newer than version in the cache so will be updated (i.e. downloaded to the cache)</li>
</ul><p class="paragraph"/>So far everything is working well.<p class="paragraph"/>Now we want to test some local changes to the <code>mylib</code> library. To do this we build it locally and install it to the local Maven cache (how doesn't particularly matter). The next time we perform a dependency resolution, the following will occur:
<ul class="star">
<li>maven local repository is searched, dependency is found to newer than version in the cache so will be updated (i.e. downloaded to the cache)</li>
<li>maven network repository is NOT searched as we've already found the dependency</li>
</ul><p class="paragraph"/>This is what we wanted to occur.<p class="paragraph"/>Later on, a new version of <code>mylib 1.0-SNAPSHOT</code> is published changing the version on the server. The next time we perform dependency resolution, the following will happen:
<ul class="star">
<li>maven local repository is searched, dependency is found to be the same “age” as the version in the cache so will not be updated (i.e. downloaded)</li>
<li>maven network repository is NOT searched as we've already found the dependency</li>
</ul><p class="paragraph"/>This is likely to not be the desired outcome. We are now out of sync with the latest published snapshot and will continue to keep using the version from the local maven repository.<p class="paragraph"/>The rule to remember is this: when resolving a dependency, Grails will stop searching as soon as it finds a repository that has the dependency at the specified version number. It will <strong class="bold">not</strong> continue searching all repositories trying to find a more recently modified instance.<p class="paragraph"/>To remedy this situation (i.e. build against the  <em class="italic">newer</em>  version of <code>mylib 1.0-SNAPSHOT</code> in the remote repository), you can either:
<ul class="star">
<li>Delete the version from the local maven repository, or</li>
<li>Reorder the repositories in the <code>BuildConfig.groovy</code> file</li>
</ul><p class="paragraph"/>Where possible, prefer deleting the version from the local maven repository. In general, when you have finished building against a locally built SNAPSHOT always try to clear it from the local maven repository.<p class="paragraph"/><blockquote class="note">
This changing dependency behaviour is an unmodifiable characteristic of the underlying dependency management system that Grails uses, Apache Ivy. It is currently not possible to have Ivy search all repositories to look for newer versions (in terms of modification date) of the same dependency (i.e. the same combination of <code>group</code>, <code>name</code> and <code>version</code>).
</blockquote>
</div><p class="paragraph"/>通常情况下，依赖是不变的。或者说，对于给定了<code>group</code>、<code>name</code>和<code>version</code>组合的jar（或者插件）来说，就意味着将永远不变。Grails的依赖管理系统就是利用这点来缓存依赖以避免每次从远程存储库中下载。但有时候这并不是可取的。比如很多开发者使用的是  <em class="italic">快照</em> （例如依赖一个以“-SNAPSHOT”结尾的版本号）规约，这样就是在同一个版本下，也可以一次一次的更新变化。我们称之为“变化的依赖”。<p class="paragraph"/>每当你有一个变化依赖的时候，Grails将总是从远程存储库中检查新版本。更确切地说，当依赖解析处理一个变化依赖时，其本地缓存的最新时间戳将跟依赖存储库中的最新时间戳比较。如果远程服务器的版本比本地缓存的新，那么新的版本将被下载和使用。<p class="paragraph"/>{info}
除此之外，请务必阅读下一节的“依赖解析缓存”，因为它将影响变化的依赖。
{info}<p class="paragraph"/>所有版本号以<code>-SNAPSHOT</code>结尾的依赖（jar和插件），Grails将 <strong class="bold">隐含地</strong> 将其视为变化的。你也可以通过changing标记来显式的在依赖DSL中指定变化的依赖：<p class="paragraph"/><div class="code"><pre>runtime ('org.my:lib:1.2.3') &#123;
    changing = <span class="java&#45;keyword">true</span>
&#125;</pre></div><p class="paragraph"/>对变化依赖的支持，有一个点你需要知道，那就是一旦在依赖的远程存储库中存在了，那么Grails将会停止查找依赖的新版本。<p class="paragraph"/>以如下的设置为例：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    repositories &#123;
        mavenLocal()
        mavenRepo <span class="java&#45;quote">"http://my.org/repo"</span>
    &#125;
    dependencies &#123;
        compile <span class="java&#45;quote">"myorg:mylib:1.0&#45;SNAPSHOT"</span>
    &#125;</pre></div><p class="paragraph"/>在此示例中，我们将使用maven的本地存储库和一个远程网络存储库。假设一个依赖不在Grails的本地依赖和Maven的本地缓存中，而是在其远程存储库中，那么当我们执行依赖解析的时候，将会发生如下的动作：
<ul class="star">
<li>在maven的本地存储库中查找，依赖没有找到</li>
<li>在maven的网络存储库中查找，依赖将被下载到本地缓存中并且使用它</li>
</ul><p class="paragraph"/>要提醒的是，存储库的检查顺序是定义在<code>BuildConfig.groovy</code>文件中的。<p class="paragraph"/>如果远程服务器依赖没有变化，我们再执行依赖解析的话，将发生如下情况：
<ul class="star">
<li>在maven的本地存储库中查找，依赖没有找到</li>
<li>在maven的网络存储库中查找，依赖被发现跟本地缓存是同一个版本，因此也就不会更新（比如下载）</li>
</ul><p class="paragraph"/>再后来，一个新版本的<code>mylib 1.0-SNAPSHOT</code>被发布到服务器上。接下来我们再执行依赖解析，将会发生如下情况：
<ul class="star">
<li>在maven的本地存储库中查找，依赖没有找到</li>
<li>在maven的网络存储库中查找，依赖被发现比本地缓存的版本新，因此执行更新操作（比如将其下载到本地缓存中）</li>
</ul><p class="paragraph"/>到目前为止，一切都很顺利。<p class="paragraph"/>现在我们想测试<code>mylib</code>库的一些本地变动。要完成此事，我们需要在本地构建并且将其安装到Maven的本地缓存中（如果没有什么特别问题的话）。接下来，我们执行依赖解析，将发生如下情况：
<ul class="star">
<li>在maven的本地存储库中查找，依赖被发现比本地缓存的版本新，因此执行更新操作（比如将其下载到本地缓存中）</li>
<li>不再查找maven的网络存储库，因为我们已经找到了依赖</li>
</ul><p class="paragraph"/>这正是我们期望发生的。<p class="paragraph"/>再继续，在服务器上发布一个变化的新版本<code>mylib 1.0-SNAPSHOT</code>。然后，我们执行依赖解析，将发生如下情况：
<ul class="star">
<li>在maven的本地存储库中查找，依赖被发现跟本地缓存是同一个版本，因此也就不会更新（比如下载）</li>
<li>不再查找maven的网络存储库，因为我们已经找到了依赖</li>
</ul><p class="paragraph"/>这可能就不是一个理想的结果了。我们现在不再同步已经最新发布的快照了，并且将继续使用maven的本地存储库中的版本。<p class="paragraph"/>因此要记住这条规则：在解析一个依赖的时候，如果在一个存储库中找到了一个给定版本的依赖，那么Grails将会停止其搜索。因此也就 <strong class="bold">不会</strong> 继续搜索全部的存储库以查找一个最新修改的依赖实例。<p class="paragraph"/>要补救这个问题（比如远程存储库中<code>mylib 1.0-SNAPSHOT</code>  <em class="italic">新</em>  版本构建问题），你可以有下边两个选择：
<ul class="star">
<li>删除maven的本地存储库中的版本，或者</li>
<li>给<code>BuildConfig.groovy</code>文件中的repositories重新排序</li>
</ul><p class="paragraph"/>如果可能，推荐采用删除maven的本地存储库中的版本的方式。总的来说，当你结束基于SNAPSHOT的本地构建时，应该尽量将其从maven的本地存储库中清除。<p class="paragraph"/><blockquote class="note">
此变化依赖的行为是Apache Ivy（是Grails的依赖管理系统基础）一个不可变特性。目前，Ivy是不可能搜索全部的存储库来寻找同一个依赖（比如相同<code>group</code>、<code>name</code>和<code>version</code>的组合）的最新版本（修改时间的同名词）。
</blockquote>


<a name="3.7.6 Dependency Reports"><!-- Legacy link --></a>
<h2 id="dependencyReports">3.7.7 依赖报告</h2>
<div class="hidden-block">
As mentioned in the previous section a Grails application consists of dependencies inherited from the framework, the plugins installed and the application dependencies itself.<p class="paragraph"/>To obtain a report of an application's dependencies you can run the <a href="../ref/Command Line/dependency-report.html" class="commandLine">dependency-report</a> command:<p class="paragraph"/><div class="code"><pre>grails dependency&#45;report</pre></div><p class="paragraph"/>By default this will generate reports in the <code>target/dependency-report</code> directory. You can specify which configuration (scope) you want a report for by passing an argument containing the configuration name:<p class="paragraph"/><div class="code"><pre>grails dependency&#45;report runtime</pre></div>
</div><p class="paragraph"/>正如前面提到的，Grails应用所依赖的主要来自系统框架，已经安装的插件和应用自身的依赖。<p class="paragraph"/>要获取应用的依赖情况报告，可以运行<a href="../ref/Command Line/dependency-report.html" class="commandLine">dependency-report</a>命令：<p class="paragraph"/><div class="code"><pre>grails dependency&#45;report</pre></div><p class="paragraph"/>缺省情况下，生成的报告位于<code>target/dependency-report</code>目录下。你也可以通过传递一个配置（又称范围）名称来生成特定的报告，比如：<p class="paragraph"/><div class="code"><pre>grails dependency&#45;report runtime</pre></div>


<a name="3.7.7 Plugin JAR Dependencies"><!-- Legacy link --></a>
<h2 id="pluginJARDependencies">3.7.8 插件的JAR依赖</h2>
<div class="hidden-block">
<h4>Specifying Plugin JAR dependencies</h4><p class="paragraph"/>The way in which you specify dependencies for a <a href="../guide/single.html#plugins" class="guide">plugin</a> is identical to how you specify dependencies in an application. When a plugin is installed into an application the application automatically inherits the dependencies of the plugin.<p class="paragraph"/>To define a dependency that is resolved for use with the plugin but not  <em class="italic">exported</em>  to the application then you can set the <code>export</code> property of the dependency:<p class="paragraph"/><div class="code"><pre>test('org.spockframework:spock&#45;core:0.5&#45;groovy&#45;1.8') &#123;
    export = <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>In this case the Spock dependency will be available only to the plugin and not resolved as an application dependency. Alternatively, if you're using the Map syntax:<p class="paragraph"/><div class="code"><pre>test group: 'org.spockframework', name: 'spock&#45;core',
     version: '0.5&#45;groovy&#45;1.8', export: <span class="java&#45;keyword">false</span></pre></div><p class="paragraph"/><blockquote class="note">
You can use <code>exported = false</code> instead of <code>export = false</code>, but we recommend the latter because it's consistent with the Map argument.
</blockquote>
</div><p class="paragraph"/><h4>指定插件的JAR依赖</h4><p class="paragraph"/>为一个<a href="../guide/single.html#plugins" class="guide">插件</a>指定依赖的方式跟你为一个应用的方式一致。当一个插件被安装以后，此应用将自动继承插件的依赖。<p class="paragraph"/>如果希望插件的依赖  <em class="italic">不要导出</em>  到应用中，可以通过设置<code>export</code>属性来完成：<p class="paragraph"/><div class="code"><pre>test('org.spockframework:spock&#45;core:0.5&#45;groovy&#45;1.8') &#123;
    export = <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>上述示例，所依赖的Spock只在插件中有效，在应用中将不会被解析。你也可以使用Map的语法来设置：<p class="paragraph"/><div class="code"><pre>test group: 'org.spockframework', name: 'spock&#45;core',
     version: '0.5&#45;groovy&#45;1.8', export: <span class="java&#45;keyword">false</span></pre></div><p class="paragraph"/><blockquote class="note">
你也可以使用<code>exported = false</code>来替代<code>export = false</code>，但是我们推荐你使用后者，因为这样可以跟Map参数保持一致。
</blockquote><p class="paragraph"/><div class="hidden-block">
<h4>Overriding Plugin JAR Dependencies in Your Application</h4><p class="paragraph"/>If a plugin is using a JAR which conflicts with another plugin, or an application dependency then you can override how a plugin resolves its dependencies inside an application using exclusions. For example:<p class="paragraph"/><div class="code"><pre>plugins &#123;
    compile(<span class="java&#45;quote">"&#58;hibernate&#58;&#36;grailsVersion"</span>) &#123;
        excludes <span class="java&#45;quote">"javassist"</span>
    &#125;
&#125;<p class="paragraph"/>dependencies &#123;
    runtime <span class="java&#45;quote">"javassist:javassist:3.4.GA"</span>
&#125;</pre></div><p class="paragraph"/>In this case the application explicitly declares a dependency on the "hibernate" plugin and specifies an exclusion using the <code>excludes</code> method, effectively excluding the javassist library as a dependency.
</div><p class="paragraph"/><h4>在应用中覆盖插件依赖</h4><p class="paragraph"/>如果一个插件使用到的JAR依赖跟另外一个插件或者应用的依赖相冲突，你可以使用排除加覆盖的方式来解决，比如：<p class="paragraph"/><div class="code"><pre>plugins &#123;
    compile(<span class="java&#45;quote">"&#58;hibernate&#58;&#36;grailsVersion"</span>) &#123;
        excludes <span class="java&#45;quote">"javassist"</span>
    &#125;
&#125;<p class="paragraph"/>dependencies &#123;
    runtime <span class="java&#45;quote">"javassist:javassist:3.4.GA"</span>
&#125;</pre></div><p class="paragraph"/>在上述依赖"hibernate"插件的应用中，你可以通过<code>excludes</code>方法排除掉javassist框架，而后另外声明其依赖。


<a name="3.7.8 Maven Integration"><!-- Legacy link --></a>
<h2 id="mavenIntegration">3.7.9 Maven集成</h2>
<div class="hidden-block">
When using the Grails Maven plugin, Grails' dependency resolution mechanics are disabled as it is assumed that you will manage dependencies with Maven's <code>pom.xml</code> file.<p class="paragraph"/>However, if you would like to continue using Grails regular commands like <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>, <a href="../ref/Command Line/test-app.html" class="commandLine">test-app</a> and so on then you can tell Grails' command line to load dependencies from the Maven <code>pom.xml</code> file instead.<p class="paragraph"/>To do so simply add the following line to your <code>BuildConfig.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    pom <span class="java&#45;keyword">true</span>
    ..
&#125;</pre></div><p class="paragraph"/>The line <code>pom true</code> tells Grails to parse Maven's <code>pom.xml</code> and load dependencies from there.
</div><p class="paragraph"/>当使用Grails的Maven插件时，Grails自带的依赖解析机制将被禁止，因为其假设你已经使用Maven的<code>pom.xml</code>来管理依赖了。<p class="paragraph"/>即使这样，你如果想继续使用Grails的常规命令比如<a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a>、<a href="../ref/Command Line/test-app.html" class="commandLine">test-app</a>等等，你还是可以通过其命令行从Maven的<code>pom.xml</code>加载依赖的。<p class="paragraph"/>你只需要在<code>BuildConfig.groovy</code>文件中简单加入如下即可：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    pom <span class="java&#45;keyword">true</span>
    ..
&#125;</pre></div><p class="paragraph"/><code>pom true</code>就是用来告诉Grails要使用Maven的<code>pom.xml</code>来加载依赖。


<a name="3.7.9 Deploying to a Maven Repository"><!-- Legacy link --></a>
<h2 id="mavendeploy">3.7.10 部署到Maven存储库</h2>
<div class="hidden-block">
If you use Maven to build your Grails project, you can use the standard Maven targets <code>mvn install</code> and <code>mvn deploy</code>.
If not, you can deploy a Grails project or plugin to a Maven repository using the <a href="http://grails.org/plugin/maven-publisher" target="blank">maven-publisher</a> plugin.<p class="paragraph"/>The plugin provides the ability to publish Grails projects and plugins to local and remote Maven repositories. There are two key additional targets added by the plugin:
<ul class="star">
<li><strong class="bold">maven-install</strong> - Installs a Grails project or plugin into your local Maven cache</li>
<li><strong class="bold">maven-deploy</strong> - Deploys a Grails project or plugin to a remote Maven repository</li>
</ul><p class="paragraph"/>By default this plugin will automatically generate a valid <code>pom.xml</code> for you unless a <code>pom.xml</code> is already present in the root of the project, in which case this <code>pom.xml</code> file will be used.
</div><p class="paragraph"/>如果你是使用Maven来构建你的Grails工程，那么你可以使用标准的Maven目标命令（target）<code>mvn install</code>和<code>mvn deploy</code>来安装部署。
如果不是，你可以通过<a href="http://grails.org/plugin/maven-publisher" target="blank">maven-publisher</a>插件来将Grails工程或者插件部署到Maven存储库。<p class="paragraph"/>此插件能够将Grails工程和插件发布到本地和远程的Maven存储库，下面是此插件额外的目标命令：
<ul class="star">
<li><strong class="bold">maven-install</strong> - 安装Grails工程或者插件到你本地的Maven缓存中</li>
<li><strong class="bold">maven-deploy</strong> - 部署Grails工程或者插件到远程的Maven存储库中</li>
</ul><p class="paragraph"/>如果你工程的根目录下边没有<code>pom.xml</code>，此插件将为你自动生成此文件，否则系统将直接使用已经存在的<code>pom.xml</code>文件。<p class="paragraph"/><div class="hidden-block">
<h4>maven-install</h4><p class="paragraph"/>The <code>maven-install</code> command will install the Grails project or plugin artifact into your local Maven cache:<p class="paragraph"/><div class="code"><pre>grails maven&#45;install</pre></div><p class="paragraph"/>In the case of plugins, the plugin zip file will be installed, whilst for application the application WAR file will be installed.
</div><p class="paragraph"/><h4>maven-install</h4><p class="paragraph"/><code>maven-install</code>命令将安装Grails工程或者插件到你本地的Maven缓存：<p class="paragraph"/><div class="code"><pre>grails maven&#45;install</pre></div><p class="paragraph"/>当工程是插件时，将安装成zip文件；当是应用时，将安装成WAR文件。<p class="paragraph"/><div class="hidden-block">
<h4>maven-deploy</h4><p class="paragraph"/>The <code>maven-deploy</code> command will deploy a Grails project or plugin into a remote Maven repository:<p class="paragraph"/><div class="code"><pre>grails maven&#45;deploy</pre></div><p class="paragraph"/>It is assumed that you have specified the necessary <code>&#60;distributionManagement&#62;</code> configuration within a <code>pom.xml</code> or that you specify the <code>id</code> of the remote repository to deploy to:<p class="paragraph"/><div class="code"><pre>grails maven&#45;deploy &#45;&#45;repository=myRepo</pre></div><p class="paragraph"/>The <code>repository</code> argument specifies the 'id' for the repository. Configure the details of the repository specified by this 'id' within your <code>grails-app/conf/BuildConfig.groovy</code> file or in your <code>$USER_HOME/.grails/settings.groovy</code> file:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.distribution = &#123;
    localRepository = <span class="java&#45;quote">"/path/to/my/local"</span>
    remoteRepository(id: <span class="java&#45;quote">"myRepo"</span>, url: <span class="java&#45;quote">"http://myserver/path/to/repo"</span>)
&#125;</pre></div><p class="paragraph"/>The syntax for configuring remote repositories matches the syntax from the <a href="http://maven.apache.org/ant-tasks/reference.html#remoteRepository" target="blank">remoteRepository</a> element in the Ant Maven tasks. For example the following XML:<p class="paragraph"/><div class="code"><pre>&#60;remoteRepository id=<span class="java&#45;quote">"myRepo"</span> url=<span class="java&#45;quote">"scp://localhost/www/repository"</span>&#62;
    &#60;authentication username=<span class="java&#45;quote">"..."</span> privateKey=<span class="java&#45;quote">"&#36;&#123;user.home&#125;/.ssh/id_dsa"</span>/&#62;
&#60;/remoteRepository&#62;</pre></div><p class="paragraph"/>Can be expressed as:<p class="paragraph"/><div class="code"><pre>remoteRepository(id: <span class="java&#45;quote">"myRepo"</span>, url: <span class="java&#45;quote">"scp://localhost/www/repository"</span>) &#123;
    authentication username: <span class="java&#45;quote">"..."</span>, privateKey: <span class="java&#45;quote">"&#36;&#123;userHome&#125;/.ssh/id_dsa"</span>
&#125;</pre></div><p class="paragraph"/>By default the plugin will try to detect the protocol to use from the URL of the repository (ie "http" from "http://.." etc.), however to specify a different protocol you can do:<p class="paragraph"/><div class="code"><pre>grails maven&#45;deploy &#45;&#45;repository=myRepo &#45;&#45;protocol=webdav</pre></div><p class="paragraph"/>The available protocols are:
<ul class="star">
<li>http</li>
<li>scp</li>
<li>scpexe</li>
<li>ftp</li>
<li>webdav</li>
</ul><p class="paragraph"/></div><p class="paragraph"/><h4>maven-deploy</h4><p class="paragraph"/><code>maven-deploy</code>命令将Grails工程或者插件发布到远程的Maven存储库：<p class="paragraph"/><div class="code"><pre>grails maven&#45;deploy</pre></div><p class="paragraph"/>上述示例的前提是你已经配置了<code>pom.xml</code>文件的<code>&#60;distributionManagement&#62;</code>，或者你可以通过指定远程存储库<code>id</code>的方式，比如：<p class="paragraph"/><div class="code"><pre>grails maven&#45;deploy &#45;&#45;repository=myRepo</pre></div><p class="paragraph"/><code>repository</code>参数是存储库的'id'，此'id'的详细配置位于<code>grails-app/conf/BuildConfig.groovy</code>或者<code>$USER_HOME/.grails/settings.groovy</code>文件中：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.distribution = &#123;
    localRepository = <span class="java&#45;quote">"/path/to/my/local"</span>
    remoteRepository(id: <span class="java&#45;quote">"myRepo"</span>, url: <span class="java&#45;quote">"http://myserver/path/to/repo"</span>)
&#125;</pre></div><p class="paragraph"/>配置远程存储库的语法跟Ant Maven任务的<a href="http://maven.apache.org/ant-tasks/reference.html#remoteRepository" target="blank">remoteRepository</a>元素相对应，如下XML所示：<p class="paragraph"/><div class="code"><pre>&#60;remoteRepository id=<span class="java&#45;quote">"myRepo"</span> url=<span class="java&#45;quote">"scp://localhost/www/repository"</span>&#62;
    &#60;authentication username=<span class="java&#45;quote">"..."</span> privateKey=<span class="java&#45;quote">"&#36;&#123;user.home&#125;/.ssh/id_dsa"</span>/&#62;
&#60;/remoteRepository&#62;</pre></div><p class="paragraph"/>可以对应为：<p class="paragraph"/><div class="code"><pre>remoteRepository(id: <span class="java&#45;quote">"myRepo"</span>, url: <span class="java&#45;quote">"scp://localhost/www/repository"</span>) &#123;
    authentication username: <span class="java&#45;quote">"..."</span>, privateKey: <span class="java&#45;quote">"&#36;&#123;userHome&#125;/.ssh/id_dsa"</span>
&#125;</pre></div><p class="paragraph"/>缺省条件下，此插件通过存储库的URL来自动检测协议的（比如"http://.."是"http"），不过你还是可以指定另外一个不同的协议的：<p class="paragraph"/><div class="code"><pre>grails maven&#45;deploy &#45;&#45;repository=myRepo &#45;&#45;protocol=webdav</pre></div><p class="paragraph"/>支持的有效协议如下：
<ul class="star">
<li>http</li>
<li>scp</li>
<li>scpexe</li>
<li>ftp</li>
<li>webdav</li>
</ul><p class="paragraph"/><div class="hidden-block">
<h4>Groups, Artifacts and Versions</h4><p class="paragraph"/>Maven defines the notion of a 'groupId', 'artifactId' and a 'version'. This plugin pulls this information from the Grails project conventions or plugin descriptor.<p class="paragraph"/><h5>Projects</h5><p class="paragraph"/>For applications this plugin will use the Grails application name and version provided by Grails when generating the <code>pom.xml</code> file. To change the version you can run the <code>set-version</code> command:<p class="paragraph"/><div class="code"><pre>grails set&#45;version 0.2</pre></div><p class="paragraph"/>The Maven <code>groupId</code> will be the same as the project name, unless you specify a different one in Config.groovy:<p class="paragraph"/><div class="code"><pre>grails.project.groupId=<span class="java&#45;quote">"com.mycompany"</span></pre></div>
</div><p class="paragraph"/><h4>组，工件和版本</h4><p class="paragraph"/>在Maven中，定义了'groupId'，'artifactId'和'version'概念，Maven插件会将Grails工程或者插件的描述转换为这些相应的定义。<p class="paragraph"/><h5>工程</h5><p class="paragraph"/>对于一个应用来说，当要生成<code>pom.xml</code>文件的时候，此插件会根据Grails应用提供的名称和版本进行生成。要修改版本信息，可以运行<code>set-version</code>命令来完成：<p class="paragraph"/><div class="code"><pre>grails set&#45;version 0.2</pre></div><p class="paragraph"/>缺省情况下，Maven的<code>groupId</code>跟其工程名称一样，不过你可以在Config.groovy中指定，比如：<p class="paragraph"/><div class="code"><pre>grails.project.groupId=<span class="java&#45;quote">"com.mycompany"</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h5>Plugins</h5><p class="paragraph"/>With a Grails plugin the <code>groupId</code> and <code>version</code> are taken from the following properties in the *GrailsPlugin.groovy descriptor:<p class="paragraph"/><div class="code"><pre><span class="java&#45;object">String</span> groupId = 'myOrg'
<span class="java&#45;object">String</span> version = '0.1'</pre></div><p class="paragraph"/>The 'artifactId' is taken from the plugin name. For example if you have a plugin called <code>FeedsGrailsPlugin</code> the <code>artifactId</code> will be "feeds". If your plugin does not specify a <code>groupId</code> then this defaults to "org.grails.plugins".
</div><p class="paragraph"/><h5>插件</h5><p class="paragraph"/>对于一个Grails插件来说，其<code>groupId</code>和<code>version</code>来自于*GrailsPlugin.groovy文件的描述属性：<p class="paragraph"/><div class="code"><pre><span class="java&#45;object">String</span> groupId = 'myOrg'
<span class="java&#45;object">String</span> version = '0.1'</pre></div><p class="paragraph"/>'artifactId'来自于插件的名称。比如你有一个插件是<code>FeedsGrailsPlugin</code>那么其<code>artifactId</code>是"feeds"。如果你的插件没有指定<code>groupId</code>那么其缺省值为"org.grails.plugins"。


<a name="3.7.10 Plugin Dependencies"><!-- Legacy link --></a>
<h2 id="pluginDependencies">3.7.11 插件依赖</h2>
<div class="hidden-block">
As of Grails 1.3 you can declaratively specify plugins as dependencies via the dependency DSL instead of using the <a href="../ref/Command Line/install-plugin.html" class="commandLine">install-plugin</a> command:<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    &#8230;
    repositories &#123;
        &#8230;
    &#125;<p class="paragraph"/>    plugins &#123;
        runtime ':hibernate:1.2.1'
    &#125;<p class="paragraph"/>    dependencies &#123;
        &#8230;
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>If you don't specify a group id the default plugin group id of <code>org.grails.plugins</code> is used. You can specify to use the latest version of a particular plugin by using "latest.integration" as the version number:<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime ':hibernate:latest.integration'
&#125;</pre></div>
</div><p class="paragraph"/>从Grails 1.3以来，你就可以通过依赖DSL的方式来声明插件的依赖了，而非只用<a href="../ref/Command Line/install-plugin.html" class="commandLine">install-plugin</a>命令：<p class="paragraph"/><div class="code"><pre>grails.project.dependency.resolution = &#123;
    &#8230;
    repositories &#123;
        &#8230;
    &#125;<p class="paragraph"/>    plugins &#123;
        runtime ':hibernate:1.2.1'
    &#125;<p class="paragraph"/>    dependencies &#123;
        &#8230;
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>如果你没有指定插件的组ID，其缺省值是<code>org.grails.plugins</code>。你还可以将"latest.integration"作为版本号，这样就会自动获取最新的版本，例如：<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime ':hibernate:latest.integration'
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Integration vs. Release</h4><p class="paragraph"/>The "latest.integration" version label will also include resolving snapshot versions. To not include snapshot versions then use the "latest.release" label:<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime ':hibernate:latest.release'
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
The "latest.release" label only works with Maven compatible repositories. If you have a regular SVN-based Grails repository then you should use "latest.integration".
</blockquote><p class="paragraph"/>And of course if you use a Maven repository with an alternative group id you can specify a group id:<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime 'mycompany:hibernate:latest.integration'
&#125;</pre></div>
</div><p class="paragraph"/><h4>集成（Integration）和正式（Release）版本</h4><p class="paragraph"/>"latest.integration"的版本标签将会解析包含快照的版本，如果不想，可以使用"latest.release"标签：<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime ':hibernate:latest.release'
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
"latest.release"标签仅仅用于兼容Maven的存储库。如果你使用基于SVN的Grails存储库，你应该使用"latest.integration"。
</blockquote><p class="paragraph"/>当然如果你使用非缺省组ID的Maven存储库，你可以为其指定一个：<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime 'mycompany:hibernate:latest.integration'
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Plugin Exclusions</h4><p class="paragraph"/>You can control how plugins transitively resolves both plugin and JAR dependencies using exclusions. For example:<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime(':weceem:0.8') &#123;
        excludes <span class="java&#45;quote">"searchable"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Here we have defined a dependency on the "weceem" plugin which transitively depends on the "searchable" plugin. By using the <code>excludes</code> method you can tell Grails  <em class="italic">not</em>  to transitively install the searchable plugin. You can combine this technique to specify an alternative version of a plugin:<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime(':weceem:0.8') &#123;
        excludes <span class="java&#45;quote">"searchable"</span> // excludes most recent version
    &#125;
    runtime ':searchable:0.5.4' // specifies a fixed searchable version
&#125;</pre></div><p class="paragraph"/>You can also completely disable transitive plugin installs, in which case no transitive dependencies will be resolved:<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime(':weceem:0.8') &#123;
        transitive = <span class="java&#45;keyword">false</span>
    &#125;
    runtime ':searchable:0.5.4' // specifies a fixed searchable version
&#125;</pre></div>
</div><p class="paragraph"/><h4>插件的排除</h4><p class="paragraph"/>通过使用排除，你可以控制插件如何传递地解析JAR和插件的依赖，比如：<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime(':weceem:0.8') &#123;
        excludes <span class="java&#45;quote">"searchable"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>此处我们定义了一个名为"weceem"的插件，其又依赖于"searchable"插件。通过使用<code>excludes</code>方法，你可以告诉Grails  <em class="italic">不以</em>  传递的方式安装searchable插件。你可以在此种方式的基础上，另外单独安装另一个版本的插件：<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime(':weceem:0.8') &#123;
        excludes <span class="java&#45;quote">"searchable"</span> // excludes most recent version
    &#125;
    runtime ':searchable:0.5.4' // specifies a fixed searchable version
&#125;</pre></div><p class="paragraph"/>你也可以完全禁用插件的传递安装，此时那些传递的依赖将不再解析，比如：<p class="paragraph"/><div class="code"><pre>plugins &#123;
    runtime(':weceem:0.8') &#123;
        transitive = <span class="java&#45;keyword">false</span>
    &#125;
    runtime ':searchable:0.5.4' // specifies a fixed searchable version
&#125;</pre></div>

<a name="4. The Command Line"><!-- Legacy link --></a>
<h1 id="commandLine">4 命令行</h1>
<div class="hidden-block">
Grails' command line system is built on <a href="http://gant.codehaus.org/" target="blank">Gant</a> - a simple Groovy wrapper around <a href="http://ant.apache.org" target="blank">Apache Ant</a>.<p class="paragraph"/>However, Grails takes it further through the use of convention and the <code>grails</code> command. When you type:<p class="paragraph"/><div class="code"><pre>grails &#91;command name&#93;</pre></div><p class="paragraph"/>Grails searches in the following directories for Gant scripts to execute:
<ul class="star">
<li><code>USER_HOME/.grails/scripts</code></li>
<li><code>PROJECT_HOME/scripts</code></li>
<li><code>PROJECT_HOME/plugins/*/scripts</code></li>
<li><code>GRAILS_HOME/scripts</code></li>
</ul><p class="paragraph"/>Grails will also convert command names that are in lower case form such as run-app into camel case. So typing<p class="paragraph"/><div class="code"><pre>grails run&#45;app</pre></div><p class="paragraph"/>Results in a search for the following files:
<ul class="star">
<li><code>USER_HOME/.grails/scripts/RunApp.groovy</code></li>
<li><code>PROJECT_HOME/scripts/RunApp.groovy</code></li>
<li><code>PLUGINS_HOME/*/scripts/RunApp.groovy</code></li>
<li><code>GLOBAL_PLUGINS_HOME/*/scripts/RunApp.groovy</code></li>
<li><code>GRAILS_HOME/scripts/RunApp.groovy</code></li>
</ul><p class="paragraph"/>If multiple matches are found Grails will give you a choice of which one to execute.<p class="paragraph"/>When Grails executes a Gant script, it invokes the "default" target defined in that script. If there is no default, Grails will quit with an error.<p class="paragraph"/>To get a list of all commands and some help about the available commands type:<p class="paragraph"/><div class="code"><pre>grails help</pre></div><p class="paragraph"/>which outputs usage instructions and the list of commands Grails is aware of:<p class="paragraph"/><div class="code"><pre>Usage (optionals marked with &#42;):
grails &#91;environment&#93;&#42; &#91;target&#93; &#91;arguments&#93;&#42;<p class="paragraph"/>Examples:
grails dev run&#45;app
grails create&#45;app books<p class="paragraph"/>Available Targets (type grails help 'target&#45;name' <span class="java&#45;keyword">for</span> more info):
grails bootstrap
grails bug&#45;report
grails clean
grails compile
...</pre></div><p class="paragraph"/><blockquote class="note">
Refer to the Command Line reference in the Quick Reference menu of the reference guide for more information about individual commands
</blockquote><p class="paragraph"/>It's often useful to provide custom arguments to the JVM when running Grails commands, in particular with <code>run-app</code> where you may for example want to set a higher maximum heap size. The Grails command will use any JVM options provided in the general <code>JAVA_OPTS</code> environment variable, but you can also specify a Grails-specific environment variable too:<p class="paragraph"/><div class="code"><pre>export GRAILS_OPTS=<span class="java&#45;quote">"&#45;Xmx1G &#45;Xms256m &#45;XX:MaxPermSize=256m"</span>
grails run&#45;app</pre></div>
</div>
Grails的命令行系统建立在<a href="http://gant.codehaus.org/" target="blank">Gant</a>之上 - 对<a href="http://ant.apache.org" target="blank">Apache Ant</a>进行了简单的包装.<p class="paragraph"/>然而，Grails通过约定规则以及grails命令的使用带来了一些改进。 当你键入如下内容时:<p class="paragraph"/><div class="code"><pre>grails &#91;命令名&#93;</pre></div><p class="paragraph"/>为了Gant脚本的执行，Grails会在下列目录中做一次搜索：:
<ul class="star">
<li><code>USER_HOME/.grails/scripts</code></li>
<li><code>PROJECT_HOME/scripts</code></li>
<li><code>PROJECT_HOME/plugins/*/scripts</code></li>
<li><code>GRAILS_HOME/scripts</code></li>
</ul><p class="paragraph"/>Grails将把小写的命令名称（如run-app）转换为单词连写的格式。因此如果键入的是<p class="paragraph"/><div class="code"><pre>grails run&#45;app</pre></div><p class="paragraph"/>Results in a search for the following files:
<ul class="star">
<li><code>USER_HOME/.grails/scripts/RunApp.groovy</code></li>
<li><code>PROJECT_HOME/scripts/RunApp.groovy</code></li>
<li><code>PLUGINS_HOME/*/scripts/RunApp.groovy</code></li>
<li><code>GLOBAL_PLUGINS_HOME/*/scripts/RunApp.groovy</code></li>
<li><code>GRAILS_HOME/scripts/RunApp.groovy</code></li>
</ul><p class="paragraph"/>如果找到多个同名的文件，Grails将要求你选择执行其中的一个。当Grails执行一个Gant脚本的时候，它会首先调用定义在脚本文件中的“default”任务。如果找不到“default”任务，Grails将退出并报错。<p class="paragraph"/>获得可用的命令及其帮助信息：<p class="paragraph"/><div class="code"><pre>grails help</pre></div><p class="paragraph"/>这个命令将输出Grails当前所知的命令列表和使用说明：<p class="paragraph"/><div class="code"><pre>Usage (optionals marked with &#42;):
grails &#91;environment&#93;&#42; &#91;target&#93; &#91;arguments&#93;&#42;<p class="paragraph"/>Examples:
grails dev run&#45;app
grails create&#45;app books<p class="paragraph"/>Available Targets (type grails help 'target&#45;name' <span class="java&#45;keyword">for</span> more info):
grails bootstrap
grails bug&#45;report
grails clean
grails compile
...</pre></div><p class="paragraph"/><blockquote class="note">
在快速参考菜单中，可以获得更多的命令行的信息。
</blockquote><p class="paragraph"/>当运行grails 命令的时候，提供自定义JVM的参数非常有用，尤其是<code>run-app</code>命令，例如，你可能想设置更大的JVM堆大小。Grails命令会使用环境变量<code>JAVA_OPTS</code>配置的所有JVM options，但你也可以指定一个Grails特定的环境变量：<p class="paragraph"/><div class="code"><pre>export GRAILS_OPTS=<span class="java&#45;quote">"&#45;Xmx1G &#45;Xms256m &#45;XX:MaxPermSize=256m"</span>
grails run&#45;app</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>non-interactive mode</h4><p class="paragraph"/>When you run a script manually and it prompts you for information, you can answer the questions and continue running the script. But when you run a script as part of an automated process, for example a continuous integration build server, there's no way to "answer" the questions. So you can pass the <code>&#45;&#45;non-interactive</code> switch to the script command to tell Grails to accept the default answer for any questions, for example whether to install a missing plugin.<p class="paragraph"/>For example:<p class="paragraph"/><div class="code"><pre>grails war &#45;&#45;non&#45;interactive</pre></div>
</div><p class="paragraph"/><h4>非交互模式</h4><p class="paragraph"/>当你手动执行一个脚本并提示你输入信息，你可以回答问题并接续执行脚本。但是当作为一个自动化过程中的一部分运行脚本，例如持续集成构建服务器，就没有办法手动"回答"的问题了。这个时候，你可以通过<code>&#45;&#45;non-interactive</code>开关来告诉Grails采用所有问题的默认回答，例如，是否要安装缺少的插件。<p class="paragraph"/>例如:<p class="paragraph"/><div class="code"><pre>grails war &#45;&#45;non&#45;interactive</pre></div>



<h2 id="interactiveMode">4.1 交互模式</h2>
交互模式是保持在JVM上运行，并允许更快地执行命令的Grails命令的功能。要激活交互模式可以再命令行中键入'Grails'，然后使用Tab键补全获取命令列表：<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-output.png"></img><p class="paragraph"/>如果你需要在交互模式中打开一个文件，你可以使用<code>open</code>命令和用TAB键完成文件路径：<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-open-cmd.png"></img><p class="paragraph"/>更妙的是，<code>open</code>命令会识别'test-report' 和 'dep-report'这个两个逻辑别名，这将打开近期的测试和依赖报告。换句话说，在浏览器中打开测试报告仅需简单地执行<code>open test-report</code>命令。您甚至可以一次打开多个文件：<code>open test-report test/unit/MyTests.groovy</code> 将在您的浏览器打开的HTML测试报告和在你的文本编辑器中打开<code>MyTests.groovy</code>源文件。<p class="paragraph"/>在<code>create-*</code>命令后面按TAB键补全完成类名同样是起作用的：<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-complete-class.png"></img><p class="paragraph"/>在交互模式中如果你需要运行一个外部进程，你可以用命令a !:<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-run-external.png"></img><p class="paragraph"/>请注意你可以用&#33; (bang)命令让文件路径自动完成 - 非常适合像'ls', 'cat', 'git'等操作文件系统的外部命令。<p class="paragraph"/><div class="hidden-block">
Interactive mode is the a feature of the Grails command line which keeps the JVM running and allows for quicker execution of commands. To activate interactive mode type 'grails' at the command line and then use TAB completion to get a list of commands:<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-output.png"></img><p class="paragraph"/>If you need to open a file whilst within interactive mode you can use the <code>open</code> command which will TAB complete file paths:<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-open-cmd.png"></img><p class="paragraph"/>Even better, the <code>open</code> command understands the logical aliases 'test-report' and 'dep-report', which will open the most recent test and dependency reports respectively. In other words, to open the test report in a browser simply execute <code>open test-report</code>. You can event open multiple files at once: <code>open test-report test/unit/MyTests.groovy</code> will open the HTML test report in your browser and the <code>MyTests.groovy</code> source file in your text editor.<p class="paragraph"/>TAB completion also works for class names after the <code>create-*</code> commands:<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-complete-class.png"></img><p class="paragraph"/>If you need to run an external process whilst interactive mode is running you can do so by starting the command with a !:<p class="paragraph"/><img border="0" class="center" src="../../img/interactive-run-external.png"></img><p class="paragraph"/>Note that with &#33; (bang) commands, you get file path auto completion - ideal for external commands that operate on the file system such as 'ls', 'cat', 'git', etc.
</div>

<a name="4.1 Creating Gant Scripts"><!-- Legacy link --></a>
<h2 id="creatingGantScripts">4.2 创建Gant脚本</h2>
你可以在项目的根目录下运行 <a href="../ref/Command Line/create-script.html" class="commandLine">create-script</a> 命令来创建你自己的Gant脚本。例如如下命令：<p class="paragraph"/><div class="code"><pre>grails create&#45;script compile&#45;sources</pre></div><p class="paragraph"/>这将创建一个叫做 <code>scripts/CompileSources.groovy</code> 的脚本。Gant脚本本身与规范的Groovy脚本非常相似，除了它支持“targets”的概念以及它们之间的依赖关系：<p class="paragraph"/><div class="code"><pre>target(<span class="java&#45;keyword">default</span>:<span class="java&#45;quote">"The <span class="java&#45;keyword">default</span> target is the one that gets executed by Grails"</span>) &#123;
    depends(clean, compile)
&#125;<p class="paragraph"/>target(clean:<span class="java&#45;quote">"Clean out things"</span>) &#123;
    ant.delete(dir:<span class="java&#45;quote">"output"</span>)
&#125;<p class="paragraph"/>target(compile:<span class="java&#45;quote">"Compile some sources"</span>) &#123;
    ant.mkdir(dir:<span class="java&#45;quote">"mkdir"</span>)
    ant.javac(srcdir:<span class="java&#45;quote">"src/java"</span>, destdir:<span class="java&#45;quote">"output"</span>)
&#125;</pre></div><p class="paragraph"/>如上面的脚本所说明的，这个内置的 <code>ant</code> 变量(一个 <code>groovy.util.AntBuilder</code> 实例)可以访问 <a href="http://ant.apache.org/manual/index.html" target="blank">Apache Ant API</a> 。
<blockquote class="note">
在以前的Grails中（1.0.3和以下），这个变量是 <code>Ant</code>，即第一个字母是大写的。
</blockquote><p class="paragraph"/>你也可以依赖其他的任务，只要在 <code>default</code> 任务中使用 <code>depends</code>  方法说明。<p class="paragraph"/><h3>默认任务（default）</h3><p class="paragraph"/>在上边的例子中，我们使用明确的名称“default”来指明一个任务。这是为一个脚本文件定义默认任务的一种方式。可选的另一种方式是使用 <code>setDefaultTarget()</code> 方法：<p class="paragraph"/><div class="code"><pre>target(<span class="java&#45;quote">"clean&#45;compile"</span>: <span class="java&#45;quote">"Performs a clean compilation on the app source"</span>) &#123;
    depends(clean, compile)
&#125;<p class="paragraph"/>target(clean:<span class="java&#45;quote">"Clean out things"</span>) &#123;
    ant.delete(dir:<span class="java&#45;quote">"output"</span>)
&#125;<p class="paragraph"/>target(compile:<span class="java&#45;quote">"Compile some sources"</span>) &#123;
    ant.mkdir(dir:<span class="java&#45;quote">"mkdir"</span>)
    ant.javac(srcdir:<span class="java&#45;quote">"src/java"</span>, destdir:<span class="java&#45;quote">"output"</span>)
&#125;<p class="paragraph"/>setDefaultTarget(<span class="java&#45;quote">"clean&#45;compile"</span>)</pre></div><p class="paragraph"/>这样将允许你从其他脚本中直接调用默认的任务。另外，尽管在这个例子中我们把调用 <code>setDefaultTarget()</code> 这一行放在了脚本文件的最后，但你可以把它放在任何位置，只要它位于它要引用的那个任务_之后_（在这个例子中这个任务就是“clean-compile”）。<p class="paragraph"/>哪种方式更好？坦率地说，你可以使用你喜欢的那种方式——看起来这两种方式都没有什么突出的优势。我们应该讨论的一个问题是，如果你想要允许任何其他脚本都能调用你的“default”任务，那么你应该把它移动到一个没有默认任务的共享脚本文件中。关于这些内容，我们将在下一章节进行更多讨论。<p class="paragraph"/><div class="hidden-block">
You can create your own Gant scripts by running the <a href="../ref/Command Line/create-script.html" class="commandLine">create-script</a> command from the root of your project. For example the following command:<p class="paragraph"/><div class="code"><pre>grails create&#45;script compile&#45;sources</pre></div><p class="paragraph"/>Will create a script called <code>scripts/CompileSources.groovy</code>. A Gant script itself is similar to a regular Groovy script except that it supports the concept of "targets" and dependencies between them:<p class="paragraph"/><div class="code"><pre>target(<span class="java&#45;keyword">default</span>:<span class="java&#45;quote">"The <span class="java&#45;keyword">default</span> target is the one that gets executed by Grails"</span>) &#123;
    depends(clean, compile)
&#125;<p class="paragraph"/>target(clean:<span class="java&#45;quote">"Clean out things"</span>) &#123;
    ant.delete(dir:<span class="java&#45;quote">"output"</span>)
&#125;<p class="paragraph"/>target(compile:<span class="java&#45;quote">"Compile some sources"</span>) &#123;
    ant.mkdir(dir:<span class="java&#45;quote">"mkdir"</span>)
    ant.javac(srcdir:<span class="java&#45;quote">"src/java"</span>, destdir:<span class="java&#45;quote">"output"</span>)
&#125;</pre></div><p class="paragraph"/>As demonstrated in the script above, there is an implicit <code>ant</code> variable (an instance of <code>groovy.util.AntBuilder</code>) that allows access to the <a href="http://ant.apache.org/manual/index.html" target="blank">Apache Ant API</a>.
<blockquote class="note">
In previous versions of Grails (1.0.3 and below), the variable was <code>Ant</code>, i.e. with a capital first letter.
</blockquote><p class="paragraph"/>You can also "depend" on other targets using the <code>depends</code> method demonstrated in the <code>default</code> target above.<p class="paragraph"/><h3>The default target</h3><p class="paragraph"/>In the example above, we specified a target with the explicit name "default". This is one way of defining the default target for a script. An alternative approach is to use the <code>setDefaultTarget()</code> method:<p class="paragraph"/><div class="code"><pre>target(<span class="java&#45;quote">"clean&#45;compile"</span>: <span class="java&#45;quote">"Performs a clean compilation on the app source"</span>) &#123;
    depends(clean, compile)
&#125;<p class="paragraph"/>target(clean:<span class="java&#45;quote">"Clean out things"</span>) &#123;
    ant.delete(dir:<span class="java&#45;quote">"output"</span>)
&#125;<p class="paragraph"/>target(compile:<span class="java&#45;quote">"Compile some sources"</span>) &#123;
    ant.mkdir(dir:<span class="java&#45;quote">"mkdir"</span>)
    ant.javac(srcdir:<span class="java&#45;quote">"src/java"</span>, destdir:<span class="java&#45;quote">"output"</span>)
&#125;<p class="paragraph"/>setDefaultTarget(<span class="java&#45;quote">"clean&#45;compile"</span>)</pre></div><p class="paragraph"/>This lets you call the default target directly from other scripts if you wish. Also, although we have put the call to <code>setDefaultTarget()</code> at the end of the script in this example, it can go anywhere as long as it comes  <em class="italic">after</em>  the target it refers to ("clean-compile" in this case).<p class="paragraph"/>Which approach is better? To be honest, you can use whichever you prefer - there don't seem to be any major advantages in either case. One thing we would say is that if you want to allow other scripts to call your "default" target, you should move it into a shared script that doesn't have a default target at all. We'll talk some more about this in the next section.
</div>

<a name="4.2 Re-using Grails scripts"><!-- Legacy link --></a>
<h2 id="reusingGrailsScripts">4.3 重用Grails脚本</h2>
Grails带了许多开箱即用的命令行功能，你会发现这在你自己的脚本中那个会很有用（查看参考指南的命令行指南部分可以获得所有命令的详细信息）。尤其是使用 <a href="../ref/Command Line/compile.html" class="commandLine">compile</a>, <a href="../ref/Command Line/package.html" class="commandLine">package</a> 和 <a href="../ref/Command Line/bootstrap.html" class="commandLine">bootstrap</a> 脚本。<p class="paragraph"/>下边的<a href="../ref/Command Line/bootstrap.html" class="commandLine">bootstrap</a>脚本例子允许你启动一个Spring的 <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">ApplicationContext</a> 实例，通过它来访问数据源等(集成测试时可以这样用）：<p class="paragraph"/><div class="code"><pre>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsBootstrap"</span>)<p class="paragraph"/>target ('<span class="java&#45;keyword">default</span>': <span class="java&#45;quote">"Database stuff"</span>) &#123;
    depends(configureProxy, packageApp, classpath, loadApp, configureApp)<p class="paragraph"/>    Connection c
    <span class="java&#45;keyword">try</span> &#123;
        c = appCtx.getBean('dataSource').getConnection()
        // <span class="java&#45;keyword">do</span> something with connection
    &#125;
    <span class="java&#45;keyword">finally</span> &#123;
        c?.close()
    &#125;
&#125;</pre></div><p class="paragraph"/><h3>从其他脚本文件引入任务</h3>
Gant允许你从另一个Gant脚本文件中引入所有任务（除了“default”）。然后你就可以depend或调用这些已经被定义在当前脚本文件中的任务了。实现的途径是<code>includeTargets</code>属性。使用左移操作符来简单的“附加”一个文件或类：
<div class="code"><pre>includeTargets &#60;&#60; <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/path/to/my/script.groovy"</span>)
includeTargets &#60;&#60; gant.tools.Ivy</pre></div>
不用太担心关于使用一个类的语法，它是相当特殊的。要是你感兴趣，可以看看Gant的文档。<p class="paragraph"/><h3>核心的Grails任务</h3><p class="paragraph"/>如你在本章开头部分所看到的例子，当使用<code>includeTargets</code>来包含核心的Grails任务时，既没有使用基于文件的语法也没有使用基于类的语法。取而代之的，你应该使用Grails命令启动器提供的特殊的<code>grailsScript()</code>方法（注意这个方法在一般的Gant脚本中是不可用的，只有在Grails环境中才行）。<p class="paragraph"/><code>grailsScript()</code> 方法的语法是非常简单易读的：简单的把你想要包含的Grails脚本文件的名称传入，不需要任何路径信息。以下是一个你可能想要重用的Grails脚本列表：
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">脚本</strong></th><th><strong class="bold">描述</strong></th></tr><tr class="table-odd"><td>&#95;GrailsSettings</td><td>你确实应该包括这个！幸运的是，它已经被所有其他Grails脚本文件自动包括了（除了&#95;GrailsProxy），因此你通常不必明确的包括它。</td></tr><tr class="table-even"><td>&#95;GrailsEvents</td><td>如果你想要触发事件，你应该包括这个。添加一个<code>event(String eventName, List args)</code>方法。另外，这也被几乎所有其他Grails脚本文件包括。</td></tr><tr class="table-odd"><td>&#95;GrailsClasspath</td><td>安装编译、测试和运行用的classpath。如果你想使用它们，就包含这个脚本。另外，这也由几乎所有其他Grails脚本包含。</td></tr><tr class="table-even"><td>&#95;GrailsProxy</td><td>如果你不直接接入互联网，而是使用代理，包含这个脚本，配置代理参数。</td></tr><tr class="table-odd"><td>&#95;GrailsArgParsing</td><td>提供一个<code>parseArguments</code>任务，就像字面上的意思：当运行你的脚本的时候解析用户提供的参数。把参数添加到<code>argsMap</code>属性中。</td></tr><tr class="table-even"><td>&#95;GrailsTest</td><td>包含所有共享的测试代码。如果你要添加额外的测试这将非常有用。</td></tr><tr class="table-odd"><td>&#95;GrailsRun</td><td>为你提供在配置好的servlet容器中运行应用程序时需要的一切，可以是正常的运行(<code>runApp</code>/<code>runAppHttps</code>) ，也可以是来自于一个WAR文件(<code>runWar</code>/<code>runWarHttps</code>)。</td></tr></table><p class="paragraph"/>这些由Grails提供的脚本很值得对它们进行深入的分析，从而找出哪些类型的任务是可以使用的。任何脚本文件都是以"&#95;"作为前缀以便进行重用。<p class="paragraph"/><h3>脚本结构</h3><p class="paragraph"/>你可能对这些下划线词语作为Grails脚本的名称感到疑惑。用_internal_作为一个脚本或者用没有对应的“command”的其他单词，这些就是Grails的决定方式。因此无法运行例如"grails &#95;grails-settings"这样的命令。这也就是为什么它们没有个默认的任务。<p class="paragraph"/>内部脚本是和代码共享重用相关的。实际上，我们建议在自己的脚本中使用类似的方式：把你的所有任务放入一个内部脚本中可以更容易的共享，然后提供简单的命令脚本来解析任何命令行参数并委托给内部脚本中的任务。假如你有一个脚本要运行一些功能测试——你可以将它们像这样分离：
<div class="code"><pre>./scripts/FunctionalTests.groovy:<p class="paragraph"/>includeTargets &#60;&#60; <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"$&#123;basedir&#125;/scripts/_FunctionalTests.groovy"</span>)<p class="paragraph"/>target(<span class="java&#45;keyword">default</span>: <span class="java&#45;quote">"Runs the functional tests <span class="java&#45;keyword">for</span> <span class="java&#45;keyword">this</span> project."</span>) &#123;
    depends(runFunctionalTests)
&#125;<p class="paragraph"/>./scripts/_FunctionalTests.groovy:<p class="paragraph"/>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsTest"</span>)<p class="paragraph"/>target(runFunctionalTests: <span class="java&#45;quote">"Run functional tests."</span>) &#123;
    depends(...)
    &#8230;
&#125;</pre></div><p class="paragraph"/>以下是在编写脚本时常用的一些指导方案：
<ul class="star">
<li>将脚本分为“command”脚本和内部脚本。</li>
<li>将大部分执行脚本放入内部脚本。</li>
<li>将参数解析放入“command”脚本。</li>
<li>要把参数传入一个任务，先创建一些脚本变量并在调用任务前将它们初始化。</li>
<li>为了避免名称冲突，可以为脚本变量分配闭包以替代任务。之后你可以直接将参数传入闭包。</li>
</ul><p class="paragraph"/><div class="hidden-block">
Grails ships with a lot of command line functionality out of the box that you may find useful in your own scripts (See the command line reference in the reference guide for info on all the commands). Of particular use are the <a href="../ref/Command Line/compile.html" class="commandLine">compile</a>, <a href="../ref/Command Line/package.html" class="commandLine">package</a> and <a href="../ref/Command Line/bootstrap.html" class="commandLine">bootstrap</a> scripts.<p class="paragraph"/>The <a href="../ref/Command Line/bootstrap.html" class="commandLine">bootstrap</a> script for example lets you bootstrap a Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">ApplicationContext</a> instance to get access to the data source and so on (the integration tests use this):<p class="paragraph"/><div class="code"><pre>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsBootstrap"</span>)<p class="paragraph"/>target ('<span class="java&#45;keyword">default</span>': <span class="java&#45;quote">"Database stuff"</span>) &#123;
    depends(configureProxy, packageApp, classpath, loadApp, configureApp)<p class="paragraph"/>    Connection c
    <span class="java&#45;keyword">try</span> &#123;
        c = appCtx.getBean('dataSource').getConnection()
        // <span class="java&#45;keyword">do</span> something with connection
    &#125;
    <span class="java&#45;keyword">finally</span> &#123;
        c?.close()
    &#125;
&#125;</pre></div><p class="paragraph"/><h3>Pulling in targets from other scripts</h3><p class="paragraph"/>Gant lets you pull in all targets (except "default") from another Gant script. You can then depend upon or invoke those targets as if they had been defined in the current script. The mechanism for doing this is the <code>includeTargets</code> property. Simply "append" a file or class to it using the left-shift operator:
<div class="code"><pre>includeTargets &#60;&#60; <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/path/to/my/script.groovy"</span>)
includeTargets &#60;&#60; gant.tools.Ivy</pre></div>
Don't worry too much about the syntax using a class, it's quite specialised. If you're interested, look into the Gant documentation.<p class="paragraph"/><h3>Core Grails targets</h3><p class="paragraph"/>As you saw in the example at the beginning of this section, you use neither the File- nor the class-based syntax for <code>includeTargets</code> when including core Grails targets. Instead, you should use the special <code>grailsScript()</code> method that is provided by the Grails command launcher (note that this is not available in normal Gant scripts, just Grails ones).<p class="paragraph"/>The syntax for the <code>grailsScript()</code> method is pretty straightforward: simply pass it the name of the Grails script to include, without any path information. Here is a list of Grails scripts that you could reuse:
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Script</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>&#95;GrailsSettings</td><td>You really should include this! Fortunately, it is included automatically by all other Grails scripts except &#95;GrailsProxy, so you usually don't have to include it explicitly.</td></tr><tr class="table-even"><td>&#95;GrailsEvents</td><td>Include this to fire events. Adds an <code>event(String eventName, List args)</code> method. Again, included by almost all other Grails scripts.</td></tr><tr class="table-odd"><td>&#95;GrailsClasspath</td><td>Configures compilation, test, and runtime classpaths. If you want to use or play with them, include this script. Again, included by almost all other Grails scripts.</td></tr><tr class="table-even"><td>&#95;GrailsProxy</td><td>If you don't have direct access to the internet and use a proxy, include this script to configure access through your proxy.</td></tr><tr class="table-odd"><td>&#95;GrailsArgParsing</td><td>Provides a <code>parseArguments</code> target that does what it says on the tin: parses the arguments provided by the user when they run your script. Adds them to the <code>argsMap</code> property.</td></tr><tr class="table-even"><td>&#95;GrailsTest</td><td>Contains all the shared test code. Useful if you want to add any extra tests.</td></tr><tr class="table-odd"><td>&#95;GrailsRun</td><td>Provides all you need to run the application in the configured servlet container, either normally (<code>runApp</code>/<code>runAppHttps</code>) or from a WAR file (<code>runWar</code>/<code>runWarHttps</code>).</td></tr></table><p class="paragraph"/>There are many more scripts provided by Grails, so it is worth digging into the scripts themselves to find out what kind of targets are available. Anything that starts with an "&#95;" is designed for reuse.<p class="paragraph"/><h3>Script architecture</h3><p class="paragraph"/>You maybe wondering what those underscores are doing in the names of the Grails scripts. That is Grails' way of determining that a script is  <em class="italic">internal</em> , or in other words that it has not corresponding "command". So you can't run "grails &#95;grails-settings" for example. That is also why they don't have a default target.<p class="paragraph"/>Internal scripts are all about code sharing and reuse. In fact, we recommend you take a similar approach in your own scripts: put all your targets into an internal script that can be easily shared, and provide simple command scripts that parse any command line arguments and delegate to the targets in the internal script. For example if you have a script that runs some functional tests, you can split it like this:
<div class="code"><pre>./scripts/FunctionalTests.groovy:<p class="paragraph"/>includeTargets &#60;&#60; <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"$&#123;basedir&#125;/scripts/_FunctionalTests.groovy"</span>)<p class="paragraph"/>target(<span class="java&#45;keyword">default</span>: <span class="java&#45;quote">"Runs the functional tests <span class="java&#45;keyword">for</span> <span class="java&#45;keyword">this</span> project."</span>) &#123;
    depends(runFunctionalTests)
&#125;<p class="paragraph"/>./scripts/_FunctionalTests.groovy:<p class="paragraph"/>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsTest"</span>)<p class="paragraph"/>target(runFunctionalTests: <span class="java&#45;quote">"Run functional tests."</span>) &#123;
    depends(...)
    &#8230;
&#125;</pre></div><p class="paragraph"/>Here are a few general guidelines on writing scripts:
<ul class="star">
<li>Split scripts into a "command" script and an internal one.</li>
<li>Put the bulk of the implementation in the internal script.</li>
<li>Put argument parsing into the "command" script.</li>
<li>To pass arguments to a target, create some script variables and initialise them before calling the target.</li>
<li>Avoid name clashes by using closures assigned to script variables instead of targets. You can then pass arguments direct to the closures.</li>
</ul><p class="paragraph"/></div>

<a name="4.3 Hooking into Events"><!-- Legacy link --></a>
<h2 id="events">4.4 钩子事件</h2>
Grails提供了钩住脚本事件的能力。这里指的是当Grails的任务和插件脚本执行的时候能触发的一些事件。<p class="paragraph"/>这个机制是故意简单化和松散的规定的。可能的事件列表是不会以任何方式固定的，所以可以钩住那些被插件脚本触发的事件，在核心目标脚本中没有类似的事件。<p class="paragraph"/><h4>定义事件处理器</h4><p class="paragraph"/>事件处理器是定义在称为 <code>_Events.groovy</code> 的脚本文件中。Grails会在以下位置搜索这些脚本：
<ul class="star">
<li><code>USER_HOME/.grails/scripts</code> - 用户特定的事件处理器</li>
<li><code>PROJECT_HOME/scripts</code> - 应用程序特定的事件处理器</li>
<li><code>PLUGINS_HOME/*/scripts</code> - 插件特定的事件处理器</li>
<li><code>GLOBAL_PLUGINS_HOME/*/scripts</code> - 由全局插件提供的事件处理器</li>
</ul><p class="paragraph"/>无论事件在何时被激发，  <em class="italic">所有</em>  已经注册到该事件的处理器都会被执行。需要注意的是处理器的注册工作会由Grails自动进行，你只需要在相关的 <code>_Events.groovy</code> 文件中声明即可。<p class="paragraph"/>事件处理器是分块定义在 <code>_Events.groovy</code> 文件中，使用“event”作为名称的开头部分。下边的例子可以被放在你的 /scripts 目录中来展示这个特性：<p class="paragraph"/><div class="code"><pre>eventCreatedArtefact = &#123; type, name &#45;&#62;
   println <span class="java&#45;quote">"Created $type $name"</span>
&#125;<p class="paragraph"/>eventStatusUpdate = &#123; msg &#45;&#62;
   println msg
&#125;<p class="paragraph"/>eventStatusFinal = &#123; msg &#45;&#62;
   println msg
&#125;</pre></div><p class="paragraph"/>你可以看到这儿有三个处理器分别是：<code>eventCreatedArtefact</code>, <code>eventStatusUpdate</code>, <code>eventStatusFinal</code>。Grails提供了一些标准的事件，它们在命令行参考指南中有描述。例如<a href="../ref/Command Line/compile.html" class="commandLine">compile</a>命令会激发下列事件：
<ul class="star">
<li><code>CompileStart</code>  - 当编译过程开始时，针对这几种类型的编译——源文件和测试文件</li>
<li><code>CompileEnd</code> - 当编译过程完成时，针对这几种类型的编译——源文件和测试文件</li>
</ul><p class="paragraph"/><h4>触发事件</h4><p class="paragraph"/>要简单地触发一个包含Init.groovy脚本的事件并调用event()闭包：<p class="paragraph"/><div class="code"><pre>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsEvents"</span>)<p class="paragraph"/>event(<span class="java&#45;quote">"StatusFinal"</span>, &#91;<span class="java&#45;quote">"Super duper plugin action complete!"</span>&#93;)</pre></div><p class="paragraph"/><h4>公共事件</h4><p class="paragraph"/>下表是一些可以被利用的公共事件：<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>事件</th><th>参数</th><th>描述</th></tr><tr class="table-odd"><td>StatusUpdate</td><td>message</td><td>传入一个标志当前脚本状态或进展的字符串</td></tr><tr class="table-even"><td>StatusError</td><td>message</td><td>传入一个标志来自当前脚本的错误信息的字符串</td></tr><tr class="table-odd"><td>StatusFinal</td><td>message</td><td>传入一个标志最终脚本状态消息的字符串，例如：当编译一个任务时，即使任务还没有退出脚本环境</td></tr><tr class="table-even"><td>CreatedArtefact</td><td>artefactType,artefactName</td><td>当一个 create-xxxx 脚本已执行完成并创建了一个工件时调用</td></tr><tr class="table-odd"><td>CreatedFile</td><td>fileName</td><td>当一个项目的源码文件被创建时调用，但不包括那些由Grails管理的固定文件</td></tr><tr class="table-even"><td>Exiting</td><td>returnCode</td><td>当脚本环境即将正常的退出时调用</td></tr><tr class="table-odd"><td>PluginInstalled</td><td>pluginName</td><td>在一个插件被安装之后调用</td></tr><tr class="table-even"><td>CompileStart</td><td>kind</td><td>当编译过程开始时调用，针对这几种类型的编译——源文件和测试文件</td></tr><tr class="table-odd"><td>CompileEnd</td><td>kind</td><td>当编译过程完成时调用，针对这几种类型的编译——源文件和测试文件</td></tr><tr class="table-even"><td>DocStart</td><td>kind</td><td>当生成文档过程即将开始时调用——生成javadoc或groovydoc时</td></tr><tr class="table-odd"><td>DocEnd</td><td>kind</td><td>当生成文档过程已经结束时调用——生成javadoc或groovydoc时</td></tr><tr class="table-even"><td>SetClasspath</td><td>rootLoader</td><td>在classpath初始化时调用以便插件可以通过 rootLoader.addURL(...)来扩大classpath。注意这种扩大classpath是在事件脚本被加载<strong class="bold">之后</strong>进行的，因此你不能使用这种方式来加载你的事件脚本需要导入的类，即使你可以通过名称来加载类。</td></tr><tr class="table-odd"><td>PackagingEnd</td><td>none</td><td>当打包结束时调用（这个调用是在Tomcat服务器被启动之前并在web.xml文件被生成之后）</td></tr></table><p class="paragraph"/><div class="hidden-block">
Grails provides the ability to hook into scripting events. These are events triggered during execution of Grails target and plugin scripts.<p class="paragraph"/>The mechanism is deliberately simple and loosely specified. The list of possible events is not fixed in any way, so it is possible to hook into events triggered by plugin scripts, for which there is no equivalent event in the core target scripts.<p class="paragraph"/><h4>Defining event handlers</h4><p class="paragraph"/>Event handlers are defined in scripts called <code>_Events.groovy</code>. Grails searches for these scripts in the following locations:
<ul class="star">
<li><code>USER_HOME/.grails/scripts</code> - user-specific event handlers</li>
<li><code>PROJECT_HOME/scripts</code> - applicaton-specific event handlers</li>
<li><code>PLUGINS_HOME/*/scripts</code> - plugin-specific event handlers</li>
<li><code>GLOBAL_PLUGINS_HOME/*/scripts</code> - event handlers provided by global plugins</li>
</ul><p class="paragraph"/>Whenever an event is fired,  <em class="italic">all</em>  the registered handlers for that event are executed. Note that the registration of handlers is performed automatically by Grails, so you just need to declare them in the relevant <code>_Events.groovy</code> file.<p class="paragraph"/>Event handlers are blocks defined in <code>_Events.groovy</code>, with a name beginning with "event". The following example can be put in your /scripts directory to demonstrate the feature:<p class="paragraph"/><div class="code"><pre>eventCreatedArtefact = &#123; type, name &#45;&#62;
   println <span class="java&#45;quote">"Created $type $name"</span>
&#125;<p class="paragraph"/>eventStatusUpdate = &#123; msg &#45;&#62;
   println msg
&#125;<p class="paragraph"/>eventStatusFinal = &#123; msg &#45;&#62;
   println msg
&#125;</pre></div><p class="paragraph"/>You can see here the three handlers <code>eventCreatedArtefact</code>, <code>eventStatusUpdate</code>, <code>eventStatusFinal</code>. Grails provides some standard events, which are documented in the command line reference guide. For example the <a href="../ref/Command Line/compile.html" class="commandLine">compile</a> command fires the following events:
<ul class="star">
<li><code>CompileStart</code>  - Called when compilation starts, passing the kind of compile - source or tests</li>
<li><code>CompileEnd</code> - Called when compilation is finished, passing the kind of compile - source or tests</li>
</ul><p class="paragraph"/><h4>Triggering events</h4><p class="paragraph"/>To trigger an event simply include the Init.groovy script and call the event() closure:<p class="paragraph"/><div class="code"><pre>includeTargets &#60;&#60; grailsScript(<span class="java&#45;quote">"_GrailsEvents"</span>)<p class="paragraph"/>event(<span class="java&#45;quote">"StatusFinal"</span>, &#91;<span class="java&#45;quote">"Super duper plugin action complete!"</span>&#93;)</pre></div><p class="paragraph"/><h4>Common Events</h4><p class="paragraph"/>Below is a table of some of the common events that can be leveraged:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Event</th><th>Parameters</th><th>Description</th></tr><tr class="table-odd"><td>StatusUpdate</td><td>message</td><td>Passed a string indicating current script status/progress</td></tr><tr class="table-even"><td>StatusError</td><td>message</td><td>Passed a string indicating an error message from the current script</td></tr><tr class="table-odd"><td>StatusFinal</td><td>message</td><td>Passed a string indicating the final script status message, i.e. when completing a target, even if the target does not exit the scripting environment</td></tr><tr class="table-even"><td>CreatedArtefact</td><td>artefactType,artefactName</td><td>Called when a create-xxxx script has completed and created an artefact</td></tr><tr class="table-odd"><td>CreatedFile</td><td>fileName</td><td>Called whenever a project source filed is created, not including files constantly managed by Grails</td></tr><tr class="table-even"><td>Exiting</td><td>returnCode</td><td>Called when the scripting environment is about to exit cleanly</td></tr><tr class="table-odd"><td>PluginInstalled</td><td>pluginName</td><td>Called after a plugin has been installed</td></tr><tr class="table-even"><td>CompileStart</td><td>kind</td><td>Called when compilation starts, passing the kind of compile - source or tests</td></tr><tr class="table-odd"><td>CompileEnd</td><td>kind</td><td>Called when compilation is finished, passing the kind of compile - source or tests</td></tr><tr class="table-even"><td>DocStart</td><td>kind</td><td>Called when documentation generation is about to start - javadoc or groovydoc</td></tr><tr class="table-odd"><td>DocEnd</td><td>kind</td><td>Called when documentation generation has ended - javadoc or groovydoc</td></tr><tr class="table-even"><td>SetClasspath</td><td>rootLoader</td><td>Called during classpath initialization so plugins can augment the classpath with rootLoader.addURL(...). Note that this augments the classpath <strong class="bold">after</strong> event scripts are loaded so you cannot use this to load a class that your event script needs to import, although you can do this if you load the class by name.</td></tr><tr class="table-odd"><td>PackagingEnd</td><td>none</td><td>Called at the end of packaging (which is called prior to the Tomcat server being started and after web.xml is generated)</td></tr></table>
</div>

<a name="4.4 Customising the build"><!-- Legacy link --></a>
<h2 id="buildCustomising">4.5 自定义构建</h2>
Grails无疑是一个固执己见框架，并且它喜欢按照约定来进行配置，但这并不意味着你 不能 去配置它。在本章，我们将看到你可以如何去影响和修改标准的Grails构建。
<div class="hidden-block">
Grails is most definitely an opinionated framework and it prefers convention to configuration, but this doesn't mean you  <em class="italic">can't</em>  configure it. In this section, we look at how you can influence and modify the standard Grails build.
</div><p class="paragraph"/><h3>默认</h3><p class="paragraph"/>Grails构建配置的核心就是 <code>grails.util.BuildSettings</code> 类，它包含了大量有用的信息。它控制了哪些类被编译、应用程序依赖什么以及其他类似的设置。<p class="paragraph"/>以下是一个配置选项和它们的默认值的集录：
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">属性</strong></th><th><strong class="bold">配置选项</strong></th><th><strong class="bold">默认值</strong></th></tr><tr class="table-odd"><td>grailsWorkDir</td><td>grails.work.dir</td><td>$USER_HOME/.grails/&#60;grailsVersion&#62;</td></tr><tr class="table-even"><td>projectWorkDir</td><td>grails.project.work.dir</td><td>&#60;grailsWorkDir&#62;/projects/&#60;baseDirName&#62;</td></tr><tr class="table-odd"><td>classesDir</td><td>grails.project.class.dir</td><td>&#60;projectWorkDir&#62;/classes</td></tr><tr class="table-even"><td>testClassesDir</td><td>grails.project.test.class.dir</td><td>&#60;projectWorkDir&#62;/test-classes</td></tr><tr class="table-odd"><td>testReportsDir</td><td>grails.project.test.reports.dir</td><td>&#60;projectWorkDir&#62;/test/reports</td></tr><tr class="table-even"><td>resourcesDir</td><td>grails.project.resource.dir</td><td>&#60;projectWorkDir&#62;/resources</td></tr><tr class="table-odd"><td>projectPluginsDir</td><td>grails.project.plugins.dir</td><td>&#60;projectWorkDir&#62;/plugins</td></tr><tr class="table-even"><td>globalPluginsDir</td><td>grails.global.plugins.dir</td><td>&#60;grailsWorkDir&#62;/global-plugins</td></tr><tr class="table-odd"><td>verboseCompile</td><td>grails.project.compile.verbose</td><td><code>false</code></td></tr></table><p class="paragraph"/><code>BuildSettings</code> 类也有一些其他属性，但是它们应该被只读处理：
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">属性</strong></th><th><strong class="bold">描述</strong></th></tr><tr class="table-odd"><td>baseDir</td><td>项目的位置。</td></tr><tr class="table-even"><td>userHome</td><td>用户的主目录。</td></tr><tr class="table-odd"><td>grailsHome</td><td>正在使用的Grails的安装位置（也许为<code>null</code>）。</td></tr><tr class="table-even"><td>grailsVersion</td><td>被项目使用的Grails的版本。</td></tr><tr class="table-odd"><td>grailsEnv</td><td>当前的Grails环境。</td></tr><tr class="table-even"><td>compileDependencies</td><td>编译时项目依赖的<code>文件</code>实例列表。</td></tr><tr class="table-odd"><td>testDependencies</td><td>测试时项目依赖的<code>文件</code>实例列表。</td></tr><tr class="table-even"><td>runtimeDependencies</td><td>运行时项目依赖的<code>文件</code>实例列表。</td></tr></table><p class="paragraph"/>当然，如果你不能获得这些属性那么它们并没有多好。幸运的是这很容易实现：通过<code>grailsSettings</code>脚本变量可以得到一个<code>BuildSettings</code>实例用于你的脚本。你也可以在你的代码中通过使用<code>grails.util.BuildSettingsHolder</code>类来访问它，但是并不推荐这样做。
<div class="hidden-block">
<h3>The defaults</h3><p class="paragraph"/>The core of the Grails build configuration is the <code>grails.util.BuildSettings</code> class, which contains quite a bit of useful information. It controls where classes are compiled to, what dependencies the application has, and other such settings.<p class="paragraph"/>Here is a selection of the configuration options and their default values:
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Config option</strong></th><th><strong class="bold">Default value</strong></th></tr><tr class="table-odd"><td>grailsWorkDir</td><td>grails.work.dir</td><td>$USER_HOME/.grails/&#60;grailsVersion&#62;</td></tr><tr class="table-even"><td>projectWorkDir</td><td>grails.project.work.dir</td><td>&#60;grailsWorkDir&#62;/projects/&#60;baseDirName&#62;</td></tr><tr class="table-odd"><td>classesDir</td><td>grails.project.class.dir</td><td>&#60;projectWorkDir&#62;/classes</td></tr><tr class="table-even"><td>testClassesDir</td><td>grails.project.test.class.dir</td><td>&#60;projectWorkDir&#62;/test-classes</td></tr><tr class="table-odd"><td>testReportsDir</td><td>grails.project.test.reports.dir</td><td>&#60;projectWorkDir&#62;/test/reports</td></tr><tr class="table-even"><td>resourcesDir</td><td>grails.project.resource.dir</td><td>&#60;projectWorkDir&#62;/resources</td></tr><tr class="table-odd"><td>projectPluginsDir</td><td>grails.project.plugins.dir</td><td>&#60;projectWorkDir&#62;/plugins</td></tr><tr class="table-even"><td>globalPluginsDir</td><td>grails.global.plugins.dir</td><td>&#60;grailsWorkDir&#62;/global-plugins</td></tr><tr class="table-odd"><td>verboseCompile</td><td>grails.project.compile.verbose</td><td><code>false</code></td></tr></table><p class="paragraph"/>The <code>BuildSettings</code> class has some other properties too, but they should be treated as read-only:
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>baseDir</td><td>The location of the project.</td></tr><tr class="table-even"><td>userHome</td><td>The user's home directory.</td></tr><tr class="table-odd"><td>grailsHome</td><td>The location of the Grails installation in use (may be <code>null</code>).</td></tr><tr class="table-even"><td>grailsVersion</td><td>The version of Grails being used by the project.</td></tr><tr class="table-odd"><td>grailsEnv</td><td>The current Grails environment.</td></tr><tr class="table-even"><td>compileDependencies</td><td>A list of compile-time project dependencies as <code>File</code> instances.</td></tr><tr class="table-odd"><td>testDependencies</td><td>A list of test-time project dependencies as <code>File</code> instances.</td></tr><tr class="table-even"><td>runtimeDependencies</td><td>A list of runtime-time project dependencies as <code>File</code> instances.</td></tr></table><p class="paragraph"/>Of course, these properties aren't much good if you can't get hold of them. Fortunately that's easy to do: an instance of <code>BuildSettings</code> is available to your scripts as the <code>grailsSettings</code> script variable. You can also access it from your code by using the <code>grails.util.BuildSettingsHolder</code> class, but this isn't recommended.
</div><p class="paragraph"/><h3>覆盖默认值</h3><p class="paragraph"/>所有在第一个表中的属性都可以被一个系统属性或配置选项所覆盖——简单地使用“config option”名称。例如，要改变项目工作目录，你可以运行这个命令：
<div class="code"><pre>grails &#45;Dgrails.project.work.dir=work compile</pre></div>
或者将这个选项添加到你的 <code>grails-app/conf/BuildConfig.groovy</code> 文件中：
<div class="code"><pre>grails.project.work.dir = <span class="java&#45;quote">"work"</span></pre></div>
注意默认值带有许多它们依赖的属性值，因此像这样设置项目工作目录也将迁移编译好的类、测试类、资源和插件。<p class="paragraph"/>如果你同时使用系统属性和配置选项将发生什么？当然是系统属性被采用了，因为它优先于<code>BuildConfig.groovy</code> 文件，而后者优先于默认值。<p class="paragraph"/><code>BuildConfig.groovy</code> 文件是 <code>grails-app/conf/Config.groovy</code> 的姐妹文件，——过去包含的选项仅仅影响构建，但是之后包含的就影响正在运行的应用程序了。这并不局限于第一个表中的选项：你会发现构建配置选项在文档中到处都是，比如其中一些就用来指定内嵌的servlet容器应该运行在哪个端口上或者决定哪些文件应该被打包到WAR文件中。<p class="paragraph"/><h3>可用的构建设置</h3><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>名称</th><th>描述</th></tr><tr class="table-odd"><td>grails.server.port.http</td><td>指定内嵌的servlet容器应该运行的端口（“run-app”和“run-war”命令使用）。整型。</td></tr><tr class="table-even"><td>grails.server.port.https</td><td>指定内嵌的servlet容器用于HTTPS的运行端口 ("run-app &#45;&#45;https" and "run-war &#45;&#45;https"). 整型.</td></tr><tr class="table-odd"><td>grails.config.base.webXml</td><td>指定用于应用程序的自定义web.xml文件的路径（取代使用web.xml模板）。</td></tr><tr class="table-even"><td>grails.compiler.dependencies</td><td>将额外的依赖添加到编译器classpath的传统方式。设置它到一个包含“fileset()”入口的闭包。 这些入口将被一个<code>AntBuilder</code>处理，所以这些入口的语法是以Groovy的形式出现，对应着Ant构建文件的XML元素，例如： <code>fileset(dir: "$basedir/lib", include: "&#42;&#42;/&#42;.class)</code>.</td></tr><tr class="table-odd"><td>grails.testing.patterns</td><td>一个Ant路径格式的列表，允许你控制哪些文件可以被包含在测试中。这些格式不应该包括测试用例后缀，它们将在下一个属性中设置。</td></tr><tr class="table-even"><td>grails.testing.nameSuffix</td><td>默认的，测试类都假定有一个“Tests”的后缀。你可以设置这个选项来改变它为你想要的任何内容。例如：另一个公共后缀是“Test”。</td></tr><tr class="table-odd"><td>grails.project.war.file</td><td>一个包含了生成的WAR文件的文件路径的字符串，除了它的全名意外（包括扩展名）。例如，“target/my-app.war”。</td></tr><tr class="table-even"><td>grails.war.dependencies</td><td>一个包含“fileset()”入口的闭包，它允许你完全控制什么内容可以被放入WAR文件的“WEB-INF/lib”目录中。</td></tr><tr class="table-odd"><td>grails.war.copyToWebApp</td><td>一个包含“fileset()”入口的闭包，它允许你完全控制什么内容可以被放入WAR文件的根目录中。它覆盖了包含“web-app”目录下所有内容的那种默认习惯。</td></tr><tr class="table-even"><td>grails.war.resources</td><td>一个闭包，用临时目录的地址作为它的第一个参数。你可以使用任何Ant任务来做你想做的任何事。这通常用来在临时目录被打包成WAR之前从中删除文件。</td></tr><tr class="table-odd"><td>grails.project.web.xml</td><td>生成Grails的web.xml的位置</td></tr></table><p class="paragraph"/><div class="hidden-block">
<h3>Overriding the defaults</h3><p class="paragraph"/>All of the properties in the first table can be overridden by a system property or a configuration option - simply use the "config option" name. For example, to change the project working directory, you could either run this command:
<div class="code"><pre>grails &#45;Dgrails.project.work.dir=work compile</pre></div>
or add this option to your <code>grails-app/conf/BuildConfig.groovy</code> file:
<div class="code"><pre>grails.project.work.dir = <span class="java&#45;quote">"work"</span></pre></div>
Note that the default values take account of the property values they depend on, so setting the project working directory like this would also relocate the compiled classes, test classes, resources, and plugins.<p class="paragraph"/>What happens if you use both a system property and a configuration option? Then the system property wins because it takes precedence over the <code>BuildConfig.groovy</code> file, which in turn takes precedence over the default values.<p class="paragraph"/>The <code>BuildConfig.groovy</code> file is a sibling of <code>grails-app/conf/Config.groovy</code> - the former contains options that only affect the build, whereas the latter contains those that affect the application at runtime. It's not limited to the options in the first table either: you will find build configuration options dotted around the documentation, such as ones for specifying the port that the embedded servlet container runs on or for determining what files get packaged in the WAR file.<p class="paragraph"/><h3>Available build settings</h3><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Name</th><th>Description</th></tr><tr class="table-odd"><td>grails.server.port.http</td><td>Port to run the embedded servlet container on ("run-app" and "run-war"). Integer.</td></tr><tr class="table-even"><td>grails.server.port.https</td><td>Port to run the embedded servlet container on for HTTPS ("run-app &#45;&#45;https" and "run-war &#45;&#45;https"). Integer.</td></tr><tr class="table-odd"><td>grails.config.base.webXml</td><td>Path to a custom web.xml file to use for the application (alternative to using the web.xml template).</td></tr><tr class="table-even"><td>grails.compiler.dependencies</td><td>Legacy approach to adding extra dependencies to the compiler classpath. Set it to a closure containing "fileset()" entries. These entries will be processed by an <code>AntBuilder</code> so the syntax is the Groovy form of the corresponding XML elements in an Ant build file, e.g. <code>fileset(dir: "$basedir/lib", include: "&#42;&#42;/&#42;.class)</code>.</td></tr><tr class="table-odd"><td>grails.testing.patterns</td><td>A list of Ant path patterns that let you control which files are included in the tests. The patterns should not include the test case suffix, which is set by the next property.</td></tr><tr class="table-even"><td>grails.testing.nameSuffix</td><td>By default, tests are assumed to have a suffix of "Tests". You can change it to anything you like but setting this option. For example, another common suffix is "Test".</td></tr><tr class="table-odd"><td>grails.project.war.file</td><td>A string containing the file path of the generated WAR file, along with its full name (include extension). For example, "target/my-app.war".</td></tr><tr class="table-even"><td>grails.war.dependencies</td><td>A closure containing "fileset()" entries that allows you complete control over what goes in the WAR's "WEB-INF/lib" directory.</td></tr><tr class="table-odd"><td>grails.war.copyToWebApp</td><td>A closure containing "fileset()" entries that allows you complete control over what goes in the root of the WAR. It overrides the default behaviour of including everything under "web-app".</td></tr><tr class="table-even"><td>grails.war.resources</td><td>A closure that takes the location of the staging directory as its first argument. You can use any Ant tasks to do anything you like. It is typically used to remove files from the staging directory before that directory is jar'd up into a WAR.</td></tr><tr class="table-odd"><td>grails.project.web.xml</td><td>The location to generate Grails' web.xml to</td></tr></table>
</div>

<a name="4.5 Ant and Maven"><!-- Legacy link --></a>
<h2 id="antAndMaven">4.6 Ant和Maven</h2>
如果你的团队或公司的所有其他项目都在使用像Ant或Maven这样的标准的构建工具进行构建的，而你使用Grails命令行来构建你的应用程序时你就可能成为团队或者公司这个大家庭的害群之马。幸运的是，今天你可以很容易的将Grails构建系统集成到当今主流的构建工具中（嗯，至少是在Java项目中使用的那种构建工具）。<p class="paragraph"/><h3>Ant 整合</h3><p class="paragraph"/>当你通过 <a href="../ref/Command Line/create-app.html" class="commandLine">create-app</a> 命令来创建一个Grails应用程序时，Grails不会自动创建Apache Ant 工具使用的<code>build.xml</code>文件，但是你可以通过<a href="../ref/Command Line/integrate-with.html" class="commandLine">integrate-with</a> 命令来生成一个：<p class="paragraph"/><div class="code"><pre>grails integrate&#45;with &#45;&#45;ant</pre></div><p class="paragraph"/>这个命令会创建一个 <code>build.xml</code> 文件，这个文件包含了下列的任务：
<ul class="star">
<li><code>clean</code> - 清理Grails应用程序</li>
<li><code>compile</code> - -编译你的应用程序的源码</li>
<li><code>test</code> - 运行单元测试</li>
<li><code>run</code> - 等同于“grails run-app”的功能</li>
<li><code>war</code> - 创建一个WAR文件</li>
<li><code>deploy</code> - 默认为空，但可以用它实现自动部署</li>
</ul><p class="paragraph"/>这些任务都可以被Ant运行，例如：<p class="paragraph"/><div class="code"><pre>ant war</pre></div><p class="paragraph"/>为了实现依赖管理，构建文件已经被全面改进为使用 <a href="http://ant.apache.org/ivy/" target="blank">Apache Ivy</a> for dependency management，这意味着它可以自动下载所有需要的Grails JAR文件和其他以来的文件。你甚至不必在本地安装Grails就可以使用它了！这对于需要使用像<a href="http://cruisecontrol.sourceforge.net/" target="blank">CruiseControl</a> 或者 <a href="http://jenkins-ci.org/" target="blank">Jenkins</a>这样的持续集成系统进行自动构建时特别有用。<p class="paragraph"/>这里使用了Grails的Ant task来对现有的Grails构建系统进行钩子操作。这个任务允许你运行任何可用的Grails脚本，不只是由生成的构建文件所使用的那些。要使用某个任务，你必须先声明它：
<div class="code"><pre>&#60;taskdef name=<span class="java&#45;quote">"grailsTask"</span>
         classname=<span class="java&#45;quote">"grails.ant.GrailsTask"</span>
         classpathref=<span class="java&#45;quote">"grails.classpath"</span>/&#62;</pre></div><p class="paragraph"/>这也引出了另外的问题：“grails.classpath”中应该是什么内容？这个任务本身是在“grails-bootstrap”这个JAR工件中的，因此至少grails-bootstrap-xxx.jar需要在classpath中。同时也应该包含“groovy-all”这个JAR。对于这个任务定义，你只需要使用它！下表列出了可用的属性：
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>属性</th><th>描述</th><th>是否必填</th></tr><tr class="table-odd"><td>home</td><td>构建时需要用到的Grails安装目录的位置。</td><td>除非classpath被指定否则必填。</td></tr><tr class="table-even"><td>classpathref</td><td>载入Grails的Classpath。必须包含“grails-bootstrap”工件并且应该包含“grails-scripts”。</td><td>除非<code>home</code>被设置或者你使用<code>classpath</code>元素否则必填。</td></tr><tr class="table-odd"><td>script</td><td>要运行的Grails脚本的名称，例如：“TestApp”。</td><td>必填。</td></tr><tr class="table-even"><td>args</td><td>要加入脚本中的参数，例如：“-unit -xml”。</td><td>不是必填。默认为“”。</td></tr><tr class="table-odd"><td>environment</td><td>运行脚本时的Grails环境。</td><td>不是必填。默认为脚本的default。</td></tr><tr class="table-even"><td>includeRuntimeClasspath</td><td>高级设置：如果设为true则将应用程序的运行时classpath添加到构建classpath中。</td><td>不是必填。默认为<code>true</code>。</td></tr></table><p class="paragraph"/>这个任务也支持下列内嵌元素，这些全都是标准的Ant路径结构：
<ul class="star">
<li><code>classpath</code> - 构建classpath（用来载入Gant和Grails脚本）。</li>
<li><code>compileClasspath</code> - 用来编译应用程序的类的Classpath。</li>
<li><code>runtimeClasspath</code> - 用来运行应用程序并将程序打成WAR包的Classpath。通常包含了<code>compileClasspath</code>中的一切。</li>
<li><code>testClasspath</code> - 用来编译和运行测试的Classpath。通常包含了<code>runtimeClasspath</code>中的一切。.</li>
</ul><p class="paragraph"/>要如何填写这些路径信息完全取决于你。如果你正在使用 <code>home</code> 属性并且把你自己的依赖内容放在了 <code>lib</code> 目录中，那么你不需要使用以上任何一个路径。如果想看看使用它们的例子，那么就查看为一个新应用而生成的Ant构建文件吧。<p class="paragraph"/><h3>Maven集成</h3><p class="paragraph"/>Grails通过一个Maven插件提供了与 <a href="http://maven.apache.org" target="blank">Maven 2</a> 的集成 .当前作为基础的Maven插件，特别是由 <a href="http://forge.octo.com/" target="blank">Octo</a> 创建的这个版本是非常有效的，它做得非常出色。<p class="paragraph"/><h4>准备</h4><p class="paragraph"/>In order to use the new plugin, all you need is Maven 2 installed and set up. This is because <strong class="bold">you no longer need to install Grails separately to use it with Maven!</strong>
为了使用这个新的插件，你只需要安装和设置Maven 2。<strong class="bold">你不再需要单独的安装Grails!</strong><p class="paragraph"/><blockquote class="note">
Grails集成Maven 2已经针对Maven 2.0.9及以上版本进行了设计和测试。它将无法工作在更早期的版本中。
</blockquote><p class="paragraph"/><blockquote class="note">
The default mvn setup DOES NOT supply sufficient memory to run the Grails environment. We recommend that you add the following environment variable setting to prevent poor performance:
默认的mvn设置没有配置充足的内存来运行grails环境。我们推荐你添加下面的环境变量防止系统表现不佳。<p class="paragraph"/><code>export MAVEN_OPTS="-Xmx512m -XX:MaxPermSize=256"</code>
</blockquote><p class="paragraph"/><h4>创建一个 Grails Maven 项目</h4><p class="paragraph"/>要简单地创建一个支持Maven的Grails项目只要运行下边的命令：<p class="paragraph"/><div class="code"><pre>mvn archetype:generate &#45;DarchetypeGroupId=org.grails &#92;
    &#45;DarchetypeArtifactId=grails&#45;maven&#45;archetype &#92;
    &#45;DarchetypeVersion=1.3.2 &#92;
    &#45;DgroupId=example &#45;DartifactId=my&#45;app</pre></div><p class="paragraph"/>无论你想为你的应用选择哪个grails version，group ID和artifact ID，一切内容格式都必须像上面写的那样。这将创建一个新的Maven项目以及一个POM文件和一系列其他文件。你不会看到有什么是像一个Grails应用。因此，下一步就要创建一个你要使用的项目结构了。
但首先, 为了配置目标 JDK 为 Java 6， 打开 my-app/pom.xml 并且更新
<div class="code"><pre>&#60;plugin&#62;
  &#60;artifactId&#62;maven&#45;compiler&#45;plugin&#60;/artifactId&#62;
  &#60;configuration&#62;
    &#60;source&#62;1.5&#60;/source&#62;
    &#60;target&#62;1.5&#60;/target&#62;
  &#60;/configuration&#62;
&#60;/plugin&#62;</pre></div>
为
<div class="code"><pre>&#60;plugin&#62;
  &#60;artifactId&#62;maven&#45;compiler&#45;plugin&#60;/artifactId&#62;
  &#60;configuration&#62;
    &#60;source&#62;1.6&#60;/source&#62;
    &#60;target&#62;1.6&#60;/target&#62;
  &#60;/configuration&#62;
&#60;/plugin&#62;</pre></div><p class="paragraph"/>然后您就可以创建项目结构：<p class="paragraph"/><div class="code"><pre>cd my&#45;app
mvn initialize</pre></div><p class="paragraph"/><blockquote class="note">
如果你遇到下面类似的消息:<p class="paragraph"/><div class="code"><pre>Resolving plugin JAR dependencies &#8230;
:: problems summary ::
:::: WARNINGS
        module not found: org.hibernate&#35;hibernate&#45;core;3.3.1.GA</pre></div><p class="paragraph"/>你需要手动增加这个插件到 application.properties：<p class="paragraph"/><div class="code"><pre>plugins.hibernate=2.0.0
plugins.tomcat=2.0.0</pre></div><p class="paragraph"/>then run<p class="paragraph"/><div class="code"><pre>mvn compile</pre></div><p class="paragraph"/>最后  hibernate 和 tomcat 插件 会被安装。
</blockquote><p class="paragraph"/>现在你已经有一个可以使用的Grails应用了。插件已经集成到了标准的构建周期，因此你可以使用标准的Maven语法来构建和打包你的应用程序了： <code>mvn clean</code> ,  <code>mvn compile</code> ,  <code>mvn test</code> ,  <code>mvn package</code> , <code>mvn install</code>。<p class="paragraph"/>你也可以利用许多已经被包装成Maven目标的Grails命令：
<ul class="star">
<li><code>grails:create-controller</code> - 调用 <a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a> 命令</li>
<li><code>grails:create-domain-class</code> - 调用 <a href="../ref/Command Line/create-domain-class.html" class="commandLine">create-domain-class</a>  命令</li>
<li><code>grails:create-integration-test</code> - 调用 <a href="../ref/Command Line/create-integration-test.html" class="commandLine">create-integration-test</a> 命令</li>
<li><code>grails:create-pom</code> - 为现有的Grails项目创建一个新的Maven POM文件</li>
<li><code>grails:create-script</code> - 调用 <a href="../ref/Command Line/create-script.html" class="commandLine">create-script</a> 命令</li>
<li><code>grails:create-service</code> - 调用 <a href="../ref/Command Line/create-service.html" class="commandLine">create-service</a> 命令</li>
<li><code>grails:create-taglib</code> - 调用 <a href="../ref/Command Line/create-tag-lib.html" class="commandLine">create-tag-lib</a>命令</li>
<li><code>grails:create-unit-test</code> - 调用 <a href="../ref/Command Line/create-unit-test.html" class="commandLine">create-unit-test</a> 命令</li>
<li><code>grails:exec</code> - 执行一个任意的Grails命令行脚本</li>
<li><code>grails:generate-all</code> - 调用 generate-all 命令</li>
<li><code>grails:generate-controller</code>  - 调用 <a href="../ref/Command Line/generate-controller.html" class="commandLine">generate-controller</a> 命令</li>
<li><code>grails:generate-views</code> - 调用 <a href="../ref/Command Line/generate-views.html" class="commandLine">generate-views</a> 命令</li>
<li><code>grails:install-plugin</code> - 调用 <a href="../ref/Command Line/install-plugin.html" class="commandLine">install-plugin</a> 命令</li>
<li><code>grails:install-templates</code> - 调用 <a href="../ref/Command Line/install-templates.html" class="commandLine">install-templates</a>  命令</li>
<li><code>grails:list-plugins</code> - 调用 <a href="../ref/Command Line/list-plugins.html" class="commandLine">list-plugins</a> 命令</li>
<li><code>grails:package</code> - 调用 <a href="../ref/Command Line/package.html" class="commandLine">package</a> 命令</li>
<li><code>grails:run-app</code> - command调用 <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a> 命令</li>
<li><code>grails:uninstall-plugin</code> - 调用 <a href="../ref/Command Line/uninstall-plugin.html" class="commandLine">uninstall-plugin</a> 命令</li>
</ul><p class="paragraph"/>你可以调用 <code>mvn grails:help</code> 来获取一个完整的，最新的命令列表<p class="paragraph"/><h4>给现有项目加入Maven支持</h4><p class="paragraph"/>创建一个全新的项目当然是一个很好的途径，但如果已经有一个项目了该怎么办呢？你应该不会愿意先创建一个新项目然后再把旧项目的内容拷贝进去的。解决方法是使用下列命令为现有项目创建一个POM文件(以现有项目的Grails版本号代替下面的版本号)：
<div class="code"><pre>mvn org.grails:grails&#45;maven&#45;plugin:1.3.2:create&#45;pom &#45;DgroupId=com.mycompany</pre></div>
当这个命令完成时，你就可以立即使用标准的语法了，如 <code>mvn package</code> 。需要注意的是当创建POM文件时你必须指定一个group ID。<p class="paragraph"/>你也可能想要设置目标JDK为Java 6，请看上面<p class="paragraph"/><h4>添加Grails命令到 phase 中</h4><p class="paragraph"/>标准的POM文件被创建是为了让Grails将合适的核心Grails命令附加到它们对应的构建语法上，因此“compile”对应“compile”语法，“war”对应“package”语法。当你想要将一个插件的命令附加到一个特定的phase上时，这可能没有什么帮助。典型的例子是功能测试。你如何确保你的功能测试（无论正在使用你决定的哪个插件）是使用“integration-test” phase来运行的？<p class="paragraph"/>恐怕不是：所有事情都是可能的。在这个例子中，你可以使用额外的“execution”块来将命令联合到一个 phase 上：
<div class="code"><pre><span class="xml&#45;tag">&#60;plugin&#62;</span>
    <span class="xml&#45;tag">&#60;groupId&#62;</span>org.grails<span class="xml&#45;tag">&#60;/groupId&#62;</span>
    <span class="xml&#45;tag">&#60;artifactId&#62;</span>grails&#45;maven&#45;plugin<span class="xml&#45;tag">&#60;/artifactId&#62;</span>
    <span class="xml&#45;tag">&#60;version&#62;</span>1.3.2<span class="xml&#45;tag">&#60;/version&#62;</span>
    <span class="xml&#45;tag">&#60;extensions&#62;</span>true<span class="xml&#45;tag">&#60;/extensions&#62;</span>
    <span class="xml&#45;tag">&#60;executions&#62;</span>
        <span class="xml&#45;tag">&#60;execution&#62;</span>
            <span class="xml&#45;tag">&#60;goals&#62;</span>
            &#8230;
            <span class="xml&#45;tag">&#60;/goals&#62;</span>
        <span class="xml&#45;tag">&#60;/execution&#62;</span>
        <span class="xml&#45;comment">&#60;!&#45;&#45; 添加 <span class="xml&#45;quote">"functional&#45;tests"</span> 命令到 <span class="xml&#45;quote">"integration&#45;test"</span> phase &#45;&#45;&#62;</span>
        <span class="xml&#45;tag">&#60;execution&#62;</span>
            <span class="xml&#45;tag">&#60;id&#62;</span>functional&#45;tests<span class="xml&#45;tag">&#60;/id&#62;</span>
            <span class="xml&#45;tag">&#60;phase&#62;</span>integration&#45;test<span class="xml&#45;tag">&#60;/phase&#62;</span>
            <span class="xml&#45;tag">&#60;goals&#62;</span>
                <span class="xml&#45;tag">&#60;goal&#62;</span>exec<span class="xml&#45;tag">&#60;/goal&#62;</span>
            <span class="xml&#45;tag">&#60;/goals&#62;</span>
            <span class="xml&#45;tag">&#60;configuration&#62;</span>
                <span class="xml&#45;tag">&#60;command&#62;</span>functional&#45;tests<span class="xml&#45;tag">&#60;/command&#62;</span>
            <span class="xml&#45;tag">&#60;/configuration&#62;</span>
        <span class="xml&#45;tag">&#60;/execution&#62;</span>
    <span class="xml&#45;tag">&#60;/executions&#62;</span>
<span class="xml&#45;tag">&#60;/plugin&#62;</span></pre></div><p class="paragraph"/>这也展示了 <code>grails:exec</code> 目标，它可以用来运行任何Grails命令。简单的将命令的名字作为 <code>command</code> 系统特性，还可以通过 <code>args</code> 特性来选择性地指定参数：
<div class="code"><pre>mvn grails:exec &#45;Dcommand=create&#45;webtest &#45;Dargs=Book</pre></div><p class="paragraph"/><h4>调试一个 Grails Maven 工程</h4><p class="paragraph"/>Maven可以使用“mvnDebug”命令在调试模式下启动。要启动调试你的Grails应用程序，只需运行：<p class="paragraph"/><div class="code"><pre>mvnDebug grails:run&#45;app</pre></div><p class="paragraph"/>这一过程在启动的时候将被暂停和监听8000端口的调试器
The process will be suspended on startup and listening for a debugger on port 8000.<p class="paragraph"/>如果您需要更多的控制调试器，这可以使用的MAVEN_OPTS环境变量指定，并用默认的“MVN”命令来启动Maven：<p class="paragraph"/><div class="code"><pre>MAVEN_OPTS=<span class="java&#45;quote">"&#45;Xdebug &#45;Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"</span>
mvn grails:run&#45;app</pre></div><p class="paragraph"/><h4>提出问题</h4><p class="paragraph"/>如果你遇到任何与Maven的集成的问题，请作为一个子任务提出一个JIRA问题<a href="http://jira.codehaus.org/browse/GRAILS-3547" target="blank">GRAILS-3547</a>.<p class="paragraph"/><div class="hidden-block">
If all the other projects in your team or company are built using a standard build tool such as Ant or Maven, you become the black sheep of the family when you use the Grails command line to build your application. Fortunately, you can easily integrate the Grails build system into the main build tools in use today (well, the ones in use in Java projects at least).<p class="paragraph"/><h3>Ant Integration</h3><p class="paragraph"/>When you create a Grails application with the <a href="../ref/Command Line/create-app.html" class="commandLine">create-app</a> command, Grails doesn't automatically create an Ant <code>build.xml</code> file but you can generate one with the <a href="../ref/Command Line/integrate-with.html" class="commandLine">integrate-with</a> command:<p class="paragraph"/><pre class="bq"><code>
grails integrate-with --ant</code></pre><p class="paragraph"/>This creates a <code>build.xml</code> file containing the following targets:
<ul class="star">
<li><code>clean</code> - Cleans the Grails application</li>
<li><code>compile</code> - Compiles your application's source code</li>
<li><code>test</code> - Runs the unit tests</li>
<li><code>run</code> - Equivalent to "grails run-app"</li>
<li><code>war</code> - Creates a WAR file</li>
<li><code>deploy</code> - Empty by default, but can be used to implement automatic deployment</li>
</ul><p class="paragraph"/>Each of these can be run by Ant, for example:<p class="paragraph"/><div class="code"><pre>ant war</pre></div><p class="paragraph"/>The build file is configured to use <a href="http://ant.apache.org/ivy/" target="blank">Apache Ivy</a> for dependency management, which means that it will automatically download all the requisite Grails JAR files and other dependencies on demand. You don't even have to install Grails locally to use it! That makes it particularly useful for continuous integration systems such as <a href="http://cruisecontrol.sourceforge.net/" target="blank">CruiseControl</a> or <a href="http://jenkins-ci.org/" target="blank">Jenkins</a>.<p class="paragraph"/>It uses the Grails <a href="../../api/grails/ant/GrailsTask.html" class="api">Ant task</a> to hook into the existing Grails build system. The task lets you run any Grails script that's available, not just the ones used by the generated build file. To use the task, you must first declare it:
<div class="code"><pre>&#60;taskdef name=<span class="java&#45;quote">"grailsTask"</span>
         classname=<span class="java&#45;quote">"grails.ant.GrailsTask"</span>
         classpathref=<span class="java&#45;quote">"grails.classpath"</span>/&#62;</pre></div><p class="paragraph"/>This raises the question: what should be in "grails.classpath"? The task itself is in the "grails-bootstrap" JAR artifact, so that needs to be on the classpath at least. You should also include the "groovy-all" JAR. With the task defined, you just need to use it! The following table shows you what attributes are available:
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Attribute</th><th>Description</th><th>Required</th></tr><tr class="table-odd"><td>home</td><td>The location of the Grails installation directory to use for the build.</td><td>Yes, unless classpath is specified.</td></tr><tr class="table-even"><td>classpathref</td><td>Classpath to load Grails from. Must include the "grails-bootstrap" artifact and should include "grails-scripts".</td><td>Yes, unless <code>home</code> is set or you use a <code>classpath</code> element.</td></tr><tr class="table-odd"><td>script</td><td>The name of the Grails script to run, e.g. "TestApp".</td><td>Yes.</td></tr><tr class="table-even"><td>args</td><td>The arguments to pass to the script, e.g. "-unit -xml".</td><td>No. Defaults to "".</td></tr><tr class="table-odd"><td>environment</td><td>The Grails environment to run the script in.</td><td>No. Defaults to the script default.</td></tr><tr class="table-even"><td>includeRuntimeClasspath</td><td>Advanced setting: adds the application's runtime classpath to the build classpath if true.</td><td>No. Defaults to <code>true</code>.</td></tr></table><p class="paragraph"/>The task also supports the following nested elements, all of which are standard Ant path structures:
<ul class="star">
<li><code>classpath</code> - The build classpath (used to load Gant and the Grails scripts).</li>
<li><code>compileClasspath</code> - Classpath used to compile the application's classes.</li>
<li><code>runtimeClasspath</code> - Classpath used to run the application and package the WAR. Typically includes everything in @compileClasspath.</li>
<li><code>testClasspath</code> - Classpath used to compile and run the tests. Typically includes everything in <code>runtimeClasspath</code>.</li>
</ul><p class="paragraph"/>How you populate these paths is up to you. If you use the <code>home</code> attribute and put your own dependencies in the <code>lib</code> directory, then you don't even need to use any of them. For an example of their use, take a look at the generated Ant build file for new apps.<p class="paragraph"/><h3>Maven Integration</h3><p class="paragraph"/>Grails provides integration with <a href="http://maven.apache.org" target="blank">Maven 2</a> with a Maven plugin. The current Maven plugin is based on but supersedes the version created by <a href="http://forge.octo.com/" target="blank">Octo</a>, who did a great job with the original.<p class="paragraph"/><h4>Preparation</h4><p class="paragraph"/>In order to use the new plugin, all you need is Maven 2 installed and set up. This is because <strong class="bold">you no longer need to install Grails separately to use it with Maven!</strong><p class="paragraph"/><blockquote class="note">
The Maven 2 integration for Grails has been designed and tested for Maven 2.0.9 and above. It will not work with earlier versions.
</blockquote><p class="paragraph"/><blockquote class="note">
The default mvn setup DOES NOT supply sufficient memory to run the Grails environment. We recommend that you add the following environment variable setting to prevent poor performance:<p class="paragraph"/><code>export MAVEN_OPTS="-Xmx512m -XX:MaxPermSize=256"</code>
</blockquote><p class="paragraph"/><h4>Creating a Grails Maven Project</h4><p class="paragraph"/>To create a Mavenized Grails project simply run the following command:<p class="paragraph"/><div class="code"><pre>mvn archetype:generate &#45;DarchetypeGroupId=org.grails &#92;
    &#45;DarchetypeArtifactId=grails&#45;maven&#45;archetype &#92;
    &#45;DarchetypeVersion=1.3.2 &#92;
    &#45;DgroupId=example &#45;DartifactId=my&#45;app</pre></div><p class="paragraph"/>Choose whichever grails version, group ID and artifact ID you want for your application, but everything else must be as written. This will create a new Maven project with a POM and a couple of other files. What you won't see is anything that looks like a Grails application. So, the next step is to create the project structure that you're used to.
But first, to set target JDK to Java 6, do that now. Open my-app/pom.xml and change
<div class="code"><pre>&#60;plugin&#62;
  &#60;artifactId&#62;maven&#45;compiler&#45;plugin&#60;/artifactId&#62;
  &#60;configuration&#62;
    &#60;source&#62;1.5&#60;/source&#62;
    &#60;target&#62;1.5&#60;/target&#62;
  &#60;/configuration&#62;
&#60;/plugin&#62;</pre></div>
to
<div class="code"><pre>&#60;plugin&#62;
  &#60;artifactId&#62;maven&#45;compiler&#45;plugin&#60;/artifactId&#62;
  &#60;configuration&#62;
    &#60;source&#62;1.6&#60;/source&#62;
    &#60;target&#62;1.6&#60;/target&#62;
  &#60;/configuration&#62;
&#60;/plugin&#62;</pre></div><p class="paragraph"/>Then you're ready to create the project structure:<p class="paragraph"/><div class="code"><pre>cd my&#45;app
mvn initialize</pre></div><p class="paragraph"/><blockquote class="note">
if you see a message similar to this:<p class="paragraph"/><div class="code"><pre>Resolving plugin JAR dependencies &#8230;
:: problems summary ::
:::: WARNINGS
        module not found: org.hibernate&#35;hibernate&#45;core;3.3.1.GA</pre></div><p class="paragraph"/>you need to add the plugins manually to application.properties:<p class="paragraph"/><div class="code"><pre>plugins.hibernate=2.0.0
plugins.tomcat=2.0.0</pre></div><p class="paragraph"/>then run<p class="paragraph"/><div class="code"><pre>mvn compile</pre></div><p class="paragraph"/>and the hibernate and tomcat plugins will be installed.
</blockquote><p class="paragraph"/>Now you have a Grails application all ready to go. The plugin integrates into the standard build cycle, so you can use the standard Maven phases to build and package your app:  <code>mvn clean</code> ,  <code>mvn compile</code> ,  <code>mvn test</code> ,  <code>mvn package</code> , <code>mvn install</code> .<p class="paragraph"/>You can also use some of the Grails commands that have been wrapped as Maven goals:
<ul class="star">
<li><code>grails:create-controller</code> - Calls the <a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a> command</li>
<li><code>grails:create-domain-class</code> - Calls the <a href="../ref/Command Line/create-domain-class.html" class="commandLine">create-domain-class</a> command</li>
<li><code>grails:create-integration-test</code> - Calls the <a href="../ref/Command Line/create-integration-test.html" class="commandLine">create-integration-test</a> command</li>
<li><code>grails:create-pom</code> - Creates a new Maven POM for an existing Grails project</li>
<li><code>grails:create-script</code> - Calls the <a href="../ref/Command Line/create-script.html" class="commandLine">create-script</a> command</li>
<li><code>grails:create-service</code> - Calls the <a href="../ref/Command Line/create-service.html" class="commandLine">create-service</a> command</li>
<li><code>grails:create-taglib</code> - Calls the <a href="../ref/Command Line/create-tag-lib.html" class="commandLine">create-tag-lib</a> command</li>
<li><code>grails:create-unit-test</code> - Calls the <a href="../ref/Command Line/create-unit-test.html" class="commandLine">create-unit-test</a> command</li>
<li><code>grails:exec</code> - Executes an arbitrary Grails command line script</li>
<li><code>grails:generate-all</code> - Calls the <a href="../ref/Command Line/generate-all.html" class="commandLine">generate-all</a> command</li>
<li><code>grails:generate-controller</code>  - Calls the <a href="../ref/Command Line/generate-controller.html" class="commandLine">generate-controller</a> command</li>
<li><code>grails:generate-views</code> - Calls the <a href="../ref/Command Line/generate-views.html" class="commandLine">generate-views</a> command</li>
<li><code>grails:install-plugin</code> - Calls the <a href="../ref/Command Line/install-plugin.html" class="commandLine">install-plugin</a> command</li>
<li><code>grails:install-templates</code> - Calls the <a href="../ref/Command Line/install-templates.html" class="commandLine">install-templates</a> command</li>
<li><code>grails:list-plugins</code> - Calls the <a href="../ref/Command Line/list-plugins.html" class="commandLine">list-plugins</a> command</li>
<li><code>grails:package</code> - Calls the <a href="../ref/Command Line/package.html" class="commandLine">package</a> command</li>
<li><code>grails:run-app</code> - Calls the <a href="../ref/Command Line/run-app.html" class="commandLine">run-app</a> command</li>
<li><code>grails:uninstall-plugin</code> - Calls the <a href="../ref/Command Line/uninstall-plugin.html" class="commandLine">uninstall-plugin</a> command</li>
</ul><p class="paragraph"/>For a complete, up to date list, run <code>mvn grails:help</code><p class="paragraph"/><h4>Mavenizing an existing project</h4><p class="paragraph"/>Creating a new project is great way to start, but what if you already have one? You don't want to create a new project and then copy the contents of the old one over. The solution is to create a POM for the existing project using this Maven command (substitute the version number with the grails version of your existing project):
<div class="code"><pre>mvn org.grails:grails&#45;maven&#45;plugin:1.3.2:create&#45;pom &#45;DgroupId=com.mycompany</pre></div>
When this command has finished, you can immediately start using the standard phases, such as <code>mvn package</code>. Note that you have to specify a group ID when creating the POM.<p class="paragraph"/>You may also want to set target JDK to Java 6; see above.<p class="paragraph"/><h4>Adding Grails commands to phases</h4><p class="paragraph"/>The standard POM created for you by Grails already attaches the appropriate core Grails commands to their corresponding build phases, so "compile" goes in the "compile" phase and "war" goes in the "package" phase. That doesn't help though when you want to attach a plugin's command to a particular phase. The classic example is functional tests. How do you make sure that your functional tests (using which ever plugin you have decided on) are run during the "integration-test" phase?<p class="paragraph"/>Fear not: all things are possible. In this case, you can associate the command to a phase using an extra "execution" block:
<div class="code"><pre><span class="xml&#45;tag">&#60;plugin&#62;</span>
    <span class="xml&#45;tag">&#60;groupId&#62;</span>org.grails<span class="xml&#45;tag">&#60;/groupId&#62;</span>
    <span class="xml&#45;tag">&#60;artifactId&#62;</span>grails&#45;maven&#45;plugin<span class="xml&#45;tag">&#60;/artifactId&#62;</span>
    <span class="xml&#45;tag">&#60;version&#62;</span>1.3.2<span class="xml&#45;tag">&#60;/version&#62;</span>
    <span class="xml&#45;tag">&#60;extensions&#62;</span>true<span class="xml&#45;tag">&#60;/extensions&#62;</span>
    <span class="xml&#45;tag">&#60;executions&#62;</span>
        <span class="xml&#45;tag">&#60;execution&#62;</span>
            <span class="xml&#45;tag">&#60;goals&#62;</span>
            &#8230;
            <span class="xml&#45;tag">&#60;/goals&#62;</span>
        <span class="xml&#45;tag">&#60;/execution&#62;</span>
        <span class="xml&#45;comment">&#60;!&#45;&#45; Add the <span class="xml&#45;quote">"functional&#45;tests"</span> command to the <span class="xml&#45;quote">"integration&#45;test"</span> phase &#45;&#45;&#62;</span>
        <span class="xml&#45;tag">&#60;execution&#62;</span>
            <span class="xml&#45;tag">&#60;id&#62;</span>functional&#45;tests<span class="xml&#45;tag">&#60;/id&#62;</span>
            <span class="xml&#45;tag">&#60;phase&#62;</span>integration&#45;test<span class="xml&#45;tag">&#60;/phase&#62;</span>
            <span class="xml&#45;tag">&#60;goals&#62;</span>
                <span class="xml&#45;tag">&#60;goal&#62;</span>exec<span class="xml&#45;tag">&#60;/goal&#62;</span>
            <span class="xml&#45;tag">&#60;/goals&#62;</span>
            <span class="xml&#45;tag">&#60;configuration&#62;</span>
                <span class="xml&#45;tag">&#60;command&#62;</span>functional&#45;tests<span class="xml&#45;tag">&#60;/command&#62;</span>
            <span class="xml&#45;tag">&#60;/configuration&#62;</span>
        <span class="xml&#45;tag">&#60;/execution&#62;</span>
    <span class="xml&#45;tag">&#60;/executions&#62;</span>
<span class="xml&#45;tag">&#60;/plugin&#62;</span></pre></div><p class="paragraph"/>This also demonstrates the <code>grails:exec</code> goal, which can be used to run any Grails command. Simply pass the name of the command as the <code>command</code> system property, and optionally specify the arguments with the <code>args</code> property:
<div class="code"><pre>mvn grails:exec &#45;Dcommand=create&#45;webtest &#45;Dargs=Book</pre></div><p class="paragraph"/><h4>Debugging a Grails Maven Project</h4><p class="paragraph"/>Maven can be launched in debug mode using the "mvnDebug" command. To launch your Grails application in debug, simply run:<p class="paragraph"/><div class="code"><pre>mvnDebug grails:run&#45;app</pre></div><p class="paragraph"/>The process will be suspended on startup and listening for a debugger on port 8000.<p class="paragraph"/>If you need more control of the debugger, this can be specified using the MAVEN_OPTS environment variable, and launch Maven with the default "mvn" command:<p class="paragraph"/><div class="code"><pre>MAVEN_OPTS=<span class="java&#45;quote">"&#45;Xdebug &#45;Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"</span>
mvn grails:run&#45;app</pre></div><p class="paragraph"/><h4>Raising issues</h4><p class="paragraph"/>If you come across any problems with the Maven integration, please raise a JIRA issue as a sub-task of <a href="http://jira.codehaus.org/browse/GRAILS-3547" target="blank">GRAILS-3547</a>.
</div>

<a name="5. Object Relational Mapping (GORM)"><!-- Legacy link --></a>
<h1 id="GORM">5 对象关系映射（GORM）</h1>
Domain classes are core to any business application. They hold state about business processes and hopefully also implement behavior. They are linked together through relationships; one-to-one, one-to-many, or many-to-many.<p class="paragraph"/>GORM is Grails' object relational mapping (ORM) implementation. Under the hood it uses Hibernate 3 (a very popular and flexible open source ORM solution) and thanks to the dynamic nature of Groovy with its static and dynamic typing, along with the convention of Grails, there is far less configuration involved in creating Grails domain classes.<p class="paragraph"/>You can also write Grails domain classes in Java. See the section on Hibernate Integration for how to write domain classes in Java but still use dynamic persistent methods. Below is a preview of GORM in action:<p class="paragraph"/><div class="code"><pre>def book = Book.findByTitle(<span class="java&#45;quote">"Groovy in Action"</span>)<p class="paragraph"/>book
  .addToAuthors(name:<span class="java&#45;quote">"Dierk Koenig"</span>)
  .addToAuthors(name:<span class="java&#45;quote">"Guillaume LaForge"</span>)
  .save()</pre></div>


<a name="5.1 Quick Start Guide"><!-- Legacy link --></a>
<h2 id="quickStartGuide">5.1 快速入门指南</h2>
A domain class can be created with the <a href="../ref/Command Line/create-domain-class.html" class="commandLine">create-domain-class</a> command:<p class="paragraph"/><div class="code"><pre>grails create&#45;domain&#45;class helloworld.Person</pre></div><p class="paragraph"/><blockquote class="note">
If no package is specified with the create-domain-class script, Grails automatically uses the application name as the package name.
</blockquote><p class="paragraph"/>This will create a class at the location <code>grails-app/domain/helloworld/Person.groovy</code> such as the one below:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> helloworld<p class="paragraph"/>class Person &#123;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
If you have the <code>dbCreate</code> property set to "update", "create" or "create-drop" on your <a href="../guide/single.html#dataSource" class="guide">DataSource</a>, Grails will automatically generate/modify the database tables for you.
</blockquote><p class="paragraph"/>You can customize the class by adding properties:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">Integer</span> age
    Date lastVisit
&#125;</pre></div><p class="paragraph"/>Once you have a domain class try and manipulate it with the <a href="../ref/Command Line/shell.html" class="commandLine">shell</a> or <a href="../ref/Command Line/console.html" class="commandLine">console</a> by typing:<p class="paragraph"/><div class="code"><pre>grails console</pre></div><p class="paragraph"/>This loads an interactive GUI where you can run Groovy commands with access to the Spring ApplicationContext, GORM, etc.


<a name="5.1.1 Basic CRUD"><!-- Legacy link --></a>
<h2 id="basicCRUD">5.1.1 基本的增删改查（CRUD）</h2>
Try performing some basic CRUD (Create/Read/Update/Delete) operations.<p class="paragraph"/><h4>Create</h4><p class="paragraph"/>To create a domain class use Map constructor to set its properties and call <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a>:<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person(name: <span class="java&#45;quote">"Fred"</span>, age: 40, lastVisit: <span class="java&#45;keyword">new</span> Date())
p.save()</pre></div><p class="paragraph"/>The <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> method will persist your class to the database using the underlying Hibernate ORM layer.<p class="paragraph"/><h4>Read</h4><p class="paragraph"/>Grails transparently adds an implicit <code>id</code> property to your domain class which you can use for retrieval:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
assert 1 == p.id</pre></div><p class="paragraph"/>This uses the <a href="../ref/Domain Classes/get.html" class="domainClasses">get</a> method that expects a database identifier to read the <code>Person</code> object back from the database.
You can also load an object in a read-only state by using the <a href="../ref/Domain Classes/read.html" class="domainClasses">read</a> method:<p class="paragraph"/><div class="code"><pre>def p = Person.read(1)</pre></div><p class="paragraph"/>In this case the underlying Hibernate engine will not do any dirty checking and the object will not be persisted. Note that
if you explicitly call the <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> method then the object is placed back into a read-write state.<p class="paragraph"/>In addition, you can also load a proxy for an instance by using the <a href="../ref/Domain Classes/load.html" class="domainClasses">load</a> method:<p class="paragraph"/><div class="code"><pre>def p = Person.load(1)</pre></div><p class="paragraph"/>This incurs no database access until a method other than getId() is called. Hibernate then initializes the proxied instance, or
throws an exception if no record is found for the specified id.<p class="paragraph"/><h4>Update</h4><p class="paragraph"/>To update an instance, change some properties and then call <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> again:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
p.name = <span class="java&#45;quote">"Bob"</span>
p.save()</pre></div><p class="paragraph"/><h4>Delete</h4><p class="paragraph"/>To delete an instance use the <a href="../ref/Domain Classes/delete.html" class="domainClasses">delete</a> method:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
p.delete()</pre></div>


<a name="5.2 Domain Modelling in GORM"><!-- Legacy link --></a>
<h2 id="domainClasses">5.2 领域（Domain）建模</h2>
When building Grails applications you have to consider the problem domain you are trying to solve. For example if you were building an <a href="http://www.amazon.com/" target="blank">Amazon</a>-style bookstore you would be thinking about books, authors, customers and publishers to name a few.<p class="paragraph"/>These are modeled in GORM as Groovy classes, so a <code>Book</code> class may have a title, a release date, an ISBN number and so on. The next few sections show how to model the domain in GORM.<p class="paragraph"/>To create a domain class you run the <a href="../ref/Command Line/create-domain-class.html" class="commandLine">create-domain-class</a> command as follows:<p class="paragraph"/><div class="code"><pre>grails create&#45;domain&#45;class org.bookstore.Book</pre></div><p class="paragraph"/>The result will be a class at <code>grails-app/domain/org/bookstore/Book.groovy</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.bookstore<p class="paragraph"/>class Book &#123;
&#125;</pre></div><p class="paragraph"/>This class will map automatically to a table in the database called <code>book</code> (the same name as the class). This behaviour is customizable through the <a href="../guide/single.html#ormdsl" class="guide">ORM Domain Specific Language</a><p class="paragraph"/>Now that you have a domain class you can define its properties as Java types. For example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.bookstore<p class="paragraph"/>class Book &#123;
    <span class="java&#45;object">String</span> title
    Date releaseDate
    <span class="java&#45;object">String</span> ISBN
&#125;</pre></div><p class="paragraph"/>Each property is mapped to a column in the database, where the convention for column names is all lower case separated by underscores. For example <code>releaseDate</code> maps onto a column <code>release_date</code>. The SQL types are auto-detected from the Java types, but can be customized with <a href="../guide/single.html#constraints" class="guide">Constraints</a> or the <a href="../guide/single.html#ormdsl" class="guide">ORM DSL</a>.


<a name="5.2.1 Association in GORM"><!-- Legacy link --></a>
<h2 id="gormAssociation">5.2.1 GORM中的关联</h2>
Relationships define how domain classes interact with each other. Unless specified explicitly at both ends, a relationship exists only in the direction it is defined.<p class="paragraph"/>

<a name="5.2.1.1 Many-to-one and one-to-one"><!-- Legacy link --></a>
<h2 id="manyToOneAndOneToOne">5.2.1.1 Many-to-one和one-to-one</h2>
A many-to-one relationship is the simplest kind, and is defined with a property of the type of another domain class. Consider this example:<p class="paragraph"/><h5>Example A</h5><p class="paragraph"/><div class="code"><pre>class Face &#123;
    Nose nose
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Nose &#123;
&#125;</pre></div><p class="paragraph"/>In this case we have a unidirectional many-to-one relationship from <code>Face</code> to <code>Nose</code>. To make this relationship bidirectional define the other side as follows:<p class="paragraph"/><h5>Example B</h5><p class="paragraph"/><div class="code"><pre>class Face &#123;
    Nose nose
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Nose &#123;
    <span class="java&#45;keyword">static</span> belongsTo = &#91;face:Face&#93;
&#125;</pre></div><p class="paragraph"/>In this case we use the <code>belongsTo</code> setting to say that <code>Nose</code> "belongs to" <code>Face</code>. The result of this is that we can create a <code>Face</code>, attach a <code>Nose</code> instance to it and when we save or delete the <code>Face</code> instance, GORM will save or delete the <code>Nose</code>. In other words, saves and deletes will cascade from <code>Face</code> to the associated <code>Nose</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Face(nose:<span class="java&#45;keyword">new</span> Nose()).save()</pre></div><p class="paragraph"/>The example above will save both face and nose. Note that the inverse  <em class="italic">is not</em>  true and will result in an error due to a transient <code>Face</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Nose(face:<span class="java&#45;keyword">new</span> Face()).save() // will cause an error</pre></div><p class="paragraph"/>Now if we delete the <code>Face</code> instance, the <code>Nose</code> will go too:<p class="paragraph"/><div class="code"><pre>def f = Face.get(1)
f.delete() // both Face and Nose deleted</pre></div><p class="paragraph"/>To make the relationship a true one-to-one, use the <code>hasOne</code> property on the owning side, e.g. <code>Face</code>:<p class="paragraph"/><h5>Example C</h5><p class="paragraph"/><div class="code"><pre>class Face &#123;
    <span class="java&#45;keyword">static</span> hasOne = &#91;nose:Nose&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Nose &#123;
    Face face
&#125;</pre></div><p class="paragraph"/>Note that using this property puts the foreign key on the inverse table to the previous example, so in this case the foreign key column is stored in the <code>nose</code> table inside a column called <code>face_id</code>. Also, <code>hasOne</code> only works with bidirectional relationships.<p class="paragraph"/>Finally, it's a good idea to add a unique constraint on one side of the one-to-one relationship:<p class="paragraph"/><div class="code"><pre>class Face &#123;
    <span class="java&#45;keyword">static</span> hasOne = &#91;nose:Nose&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        nose unique: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Nose &#123;
    Face face
&#125;</pre></div>


<a name="5.2.1.2 One-to-many"><!-- Legacy link --></a>
<h2 id="oneToMany">5.2.1.2 One-to-many</h2>
A one-to-many relationship is when one class, example <code>Author</code>, has many instances of a another class, example <code>Book</code>. With Grails you define such a relationship with the <code>hasMany</code> setting:<p class="paragraph"/><div class="code"><pre>class Author &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;books: Book&#93;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Book &#123;
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/>In this case we have a unidirectional one-to-many. Grails will, by default, map this kind of relationship with a join table.<p class="paragraph"/><blockquote class="note">
The <a href="../guide/single.html#ormdsl" class="guide">ORM DSL</a> allows mapping unidirectional relationships using a foreign key association instead
</blockquote><p class="paragraph"/>Grails will automatically inject a property of type <code>java.util.Set</code> into the domain class based on the <code>hasMany</code> setting. This can be used to iterate over the collection:<p class="paragraph"/><div class="code"><pre>def a = Author.get(1)<p class="paragraph"/><span class="java&#45;keyword">for</span> (book in a.books) &#123;
    println book.title
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
The default fetch strategy used by Grails is "lazy", which means that the collection will be lazily initialized on first access. This can lead to the <a href="http://www.javalobby.org/java/forums/t20533.html" target="blank">n+1 problem</a> if you are not careful.<p class="paragraph"/>If you need "eager" fetching you can use the <a href="../guide/single.html#ormdsl" class="guide">ORM DSL</a> or specify eager fetching as part of a <a href="../guide/single.html#querying" class="guide">query</a>
</blockquote><p class="paragraph"/>The default cascading behaviour is to cascade saves and updates, but not deletes unless a <code>belongsTo</code> is also specified:<p class="paragraph"/><div class="code"><pre>class Author &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;books: Book&#93;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Book &#123;
    <span class="java&#45;keyword">static</span> belongsTo = &#91;author: Author&#93;
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/>If you have two properties of the same type on the many side of a one-to-many you have to use <code>mappedBy</code> to specify which the collection is mapped:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;flights: Flight&#93;
    <span class="java&#45;keyword">static</span> mappedBy = &#91;flights: <span class="java&#45;quote">"departureAirport"</span>&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Flight &#123;
    Airport departureAirport
    Airport destinationAirport
&#125;</pre></div><p class="paragraph"/>This is also true if you have multiple collections that map to different properties on the many side:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;outboundFlights: Flight, inboundFlights: Flight&#93;
    <span class="java&#45;keyword">static</span> mappedBy = &#91;outboundFlights: <span class="java&#45;quote">"departureAirport"</span>,
                       inboundFlights: <span class="java&#45;quote">"destinationAirport"</span>&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Flight &#123;
    Airport departureAirport
    Airport destinationAirport
&#125;</pre></div><p class="paragraph"/>

<a name="5.2.1.3 Many-to-many"><!-- Legacy link --></a>
<h2 id="manyToMany">5.2.1.3 Many-to-many</h2>
Grails supports many-to-many relationships by defining a <code>hasMany</code> on both sides of the relationship and having a <code>belongsTo</code> on the owned side of the relationship:<p class="paragraph"/><div class="code"><pre>class Book &#123;
    <span class="java&#45;keyword">static</span> belongsTo = Author
    <span class="java&#45;keyword">static</span> hasMany = &#91;authors:Author&#93;
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Author &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;books:Book&#93;
    <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/>Grails maps a many-to-many using a join table at the database level. The owning side of the relationship, in this case <code>Author</code>, takes responsibility for persisting the relationship and is the only side that can cascade saves across.<p class="paragraph"/>For example this will work and cascade saves:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Author(name:<span class="java&#45;quote">"Stephen King"</span>)
        .addToBooks(<span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Stand"</span>))
        .addToBooks(<span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Shining"</span>))
        .save()</pre></div><p class="paragraph"/>However this will only save the <code>Book</code> and not the authors!<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Book(name:<span class="java&#45;quote">"Groovy in Action"</span>)
        .addToAuthors(<span class="java&#45;keyword">new</span> Author(name:<span class="java&#45;quote">"Dierk Koenig"</span>))
        .addToAuthors(<span class="java&#45;keyword">new</span> Author(name:<span class="java&#45;quote">"Guillaume Laforge"</span>))
        .save()</pre></div><p class="paragraph"/>This is the expected behaviour as, just like Hibernate, only one side of a many-to-many can take responsibility for managing the relationship.<p class="paragraph"/><blockquote class="warning">
Grails' <a href="../guide/single.html#scaffolding" class="guide">Scaffolding</a> feature <strong class="bold">does not</strong> currently support many-to-many relationship and hence you must write the code to manage the relationship yourself
</blockquote>


<a name="5.2.1.4 Basic Collection Types"><!-- Legacy link --></a>
<h2 id="basicCollectionTypes">5.2.1.4 基本的集合类型</h2>
As well as associations between different domain classes, GORM also supports mapping of basic collection types.
For example, the following class creates a <code>nicknames</code> association that is a <code>Set</code> of <code>String</code> instances:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;nicknames: <span class="java&#45;object">String</span>&#93;
&#125;</pre></div><p class="paragraph"/>GORM will map an association like the above using a join table. You can alter various aspects of how the join table is mapped using the <code>joinTable</code> argument:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;nicknames: <span class="java&#45;object">String</span>&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
       hasMany joinTable: &#91;name: 'bunch_o_nicknames',
                           key: 'person_id',
                           column: 'nickname',
                           type: <span class="java&#45;quote">"text"</span>&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>The example above will map to a table that looks like the following:<p class="paragraph"/><strong class="bold">bunch_o_nicknames Table</strong>
<div class="code"><pre>&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;
| person_id         |     nickname          |
&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;
|   1               |      Fred             |
&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;</pre></div>

<a name="5.2.2 Composition in GORM"><!-- Legacy link --></a>
<h2 id="gormComposition">5.2.2 GORM中的组合</h2>
As well as <a href="../guide/single.html#gormAssociation" class="guide">association</a>, Grails supports the notion of composition. In this case instead of mapping classes onto separate tables a class can be "embedded" within the current table. For example:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    Address homeAddress
    Address workAddress
    <span class="java&#45;keyword">static</span> embedded = &#91;'homeAddress', 'workAddress'&#93;
&#125;<p class="paragraph"/>class Address &#123;
    <span class="java&#45;object">String</span> number
    <span class="java&#45;object">String</span> code
&#125;</pre></div><p class="paragraph"/>The resulting mapping would looking like this:<p class="paragraph"/><img border="0" class="center" src="../../img/5.2.2-composition.jpg"></img><p class="paragraph"/><blockquote class="note">
If you define the <code>Address</code> class in a separate Groovy file in the <code>grails-app/domain</code> directory you will also get an <code>address</code> table. If you don't want this to happen use Groovy's ability to define multiple classes per file and include the <code>Address</code> class below the <code>Person</code> class in the <code>grails-app/domain/Person.groovy</code> file
</blockquote>


<a name="5.2.3 Inheritance in GORM"><!-- Legacy link --></a>
<h2 id="inheritanceInGORM">5.2.3 GORM中的继承</h2>
GORM supports inheritance both from abstract base classes and concrete persistent GORM entities. For example:<p class="paragraph"/><div class="code"><pre>class Content &#123;
     <span class="java&#45;object">String</span> author
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class BlogEntry <span class="java&#45;keyword">extends</span> Content &#123;
    URL url
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Book <span class="java&#45;keyword">extends</span> Content &#123;
    <span class="java&#45;object">String</span> ISBN
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class PodCast <span class="java&#45;keyword">extends</span> Content &#123;
    <span class="java&#45;object">byte</span>&#91;&#93; audioStream
&#125;</pre></div><p class="paragraph"/>In the above example we have a parent <code>Content</code> class and then various child classes with more specific behaviour.<p class="paragraph"/><h4>Considerations</h4><p class="paragraph"/>At the database level Grails by default uses table-per-hierarchy mapping with a discriminator column called <code>class</code> so the parent class (<code>Content</code>) and its subclasses (<code>BlogEntry</code>, <code>Book</code> etc.), share the <strong class="bold">same</strong> table.<p class="paragraph"/>Table-per-hierarchy mapping has a down side in that you <strong class="bold">cannot</strong> have non-nullable properties with inheritance mapping. An alternative is to use table-per-subclass which can be enabled with the <a href="../guide/single.html#ormdsl" class="guide">ORM DSL</a><p class="paragraph"/>However, excessive use of inheritance and table-per-subclass can result in poor query performance due to the use of outer join queries. In general our advice is if you're going to use inheritance, don't abuse it and don't make your inheritance hierarchy too deep.<p class="paragraph"/><h4>Polymorphic Queries</h4><p class="paragraph"/>The upshot of inheritance is that you get the ability to polymorphically query. For example using the <a href="../ref/Domain Classes/list.html" class="domainClasses">list</a> method on the <code>Content</code> super class will return all subclasses of <code>Content</code>:<p class="paragraph"/><div class="code"><pre>def content = Content.list() // list all blog entries, books and podcasts
content = Content.findAllByAuthor('Joe Bloggs') // find all by author<p class="paragraph"/>def podCasts = PodCast.list() // list only podcasts</pre></div>

<a name="5.2.4 Sets, Lists and Maps"><!-- Legacy link --></a>
<h2 id="sets,ListsAndMaps">5.2.4 集合、列表和映射</h2>
<h4>Sets of Objects</h4><p class="paragraph"/>By default when you define a relationship with GORM it is a <code>java.util.Set</code> which is an unordered collection that cannot contain duplicates. In other words when you have:<p class="paragraph"/><div class="code"><pre>class Author &#123;
    <span class="java&#45;keyword">static</span> hasMany = &#91;books: Book&#93;
&#125;</pre></div><p class="paragraph"/>The books property that GORM injects is a <code>java.util.Set</code>. Sets guarantee uniquenes but not order, which may not be what you want. To have custom ordering you configure the Set as a <code>SortedSet</code>:<p class="paragraph"/><div class="code"><pre>class Author &#123;<p class="paragraph"/>    SortedSet books<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;books: Book&#93;
&#125;</pre></div><p class="paragraph"/>In this case a <code>java.util.SortedSet</code> implementation is used which means you must implement <code>java.lang.Comparable</code> in your Book class:<p class="paragraph"/><div class="code"><pre>class Book <span class="java&#45;keyword">implements</span> Comparable &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title
    Date releaseDate = <span class="java&#45;keyword">new</span> Date()<p class="paragraph"/>    <span class="java&#45;object">int</span> compareTo(obj) &#123;
        releaseDate.compareTo(obj.releaseDate)
    &#125;
&#125;</pre></div><p class="paragraph"/>The result of the above class is that the Book instances in the books collection of the Author class will be ordered by their release date.<p class="paragraph"/><h4>Lists of Objects</h4><p class="paragraph"/>To keep objects in the order which they were added and to be able to reference them by index like an array you can define your collection type as a <code>List</code>:<p class="paragraph"/><div class="code"><pre>class Author &#123;<p class="paragraph"/>    List books<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;books: Book&#93;
&#125;</pre></div><p class="paragraph"/>In this case when you add new elements to the books collection the order is retained in a sequential list indexed from 0 so you can do:<p class="paragraph"/><div class="code"><pre>author.books&#91;0&#93; // get the first book</pre></div><p class="paragraph"/>The way this works at the database level is Hibernate creates a <code>books_idx</code> column where it saves the index of the elements in the collection to retain this order at the database level.<p class="paragraph"/>When using a <code>List</code>, elements must be added to the collection before being saved, otherwise Hibernate will throw an exception (<code>org.hibernate.HibernateException</code>: null index column for collection):<p class="paragraph"/><div class="code"><pre>// This won't work!
def book = <span class="java&#45;keyword">new</span> Book(title: 'The Shining')
book.save()
author.addToBooks(book)<p class="paragraph"/>// Do it <span class="java&#45;keyword">this</span> way instead.
def book = <span class="java&#45;keyword">new</span> Book(title: 'Misery')
author.addToBooks(book)
author.save()</pre></div><p class="paragraph"/><h4>Bags of Objects</h4><p class="paragraph"/>If ordering and uniqueness aren't a concern (or if you manage these explicitly) then you can use the Hibernate <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/collections.html" target="blank">Bag</a> type to represent mapped collections.<p class="paragraph"/>The only change required for this is to define the collection type as a <code>Collection</code>:<p class="paragraph"/><div class="code"><pre>class Author &#123;<p class="paragraph"/>   Collection books<p class="paragraph"/>   <span class="java&#45;keyword">static</span> hasMany = &#91;books: Book&#93;
&#125;</pre></div><p class="paragraph"/>Since uniqueness and order aren't managed by Hibernate, adding to or removing from collections mapped as a Bag don't trigger a load of all existing instances from the database, so this approach will perform better and require less memory than using a <code>Set</code> or a <code>List</code>.<p class="paragraph"/><h4>Maps of Objects</h4><p class="paragraph"/>If you want a simple map of string/value pairs GORM can map this with the following:<p class="paragraph"/><div class="code"><pre>class Author &#123;
    Map books // map of ISBN:book names
&#125;<p class="paragraph"/>def a = <span class="java&#45;keyword">new</span> Author()
a.books = &#91;<span class="java&#45;quote">"1590597583"</span>:<span class="java&#45;quote">"Grails Book"</span>&#93;
a.save()</pre></div>
In this case the key and value of the map MUST be strings.<p class="paragraph"/>If you want a Map of objects then you can do this:<p class="paragraph"/><div class="code"><pre>class Book &#123;<p class="paragraph"/>    Map authors<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;authors: Author&#93;
&#125;<p class="paragraph"/>def a = <span class="java&#45;keyword">new</span> Author(name:<span class="java&#45;quote">"Stephen King"</span>)<p class="paragraph"/>def book = <span class="java&#45;keyword">new</span> Book()
book.authors = &#91;stephen:a&#93;
book.save()</pre></div><p class="paragraph"/>The static <code>hasMany</code> property defines the type of the elements within the Map. The keys for the map <strong class="bold">must</strong> be strings.<p class="paragraph"/><h4>A Note on Collection Types and Performance</h4><p class="paragraph"/>The Java <code>Set</code> type doesn't allow duplicates. To ensure uniqueness when adding an entry to a <code>Set</code> association Hibernate has to load the entire associations from the database. If you have a large numbers of entries in the association this can be costly in terms of performance.<p class="paragraph"/>The same behavior is required for <code>List</code> types, since Hibernate needs to load the entire association to maintain order. Therefore it is recommended that if you anticipate a large numbers of records in the association that you make the association bidirectional so that the link can be created on the inverse side. For example consider the following code:<p class="paragraph"/><div class="code"><pre>def book = <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"New Grails Book"</span>)
def author = Author.get(1)
book.author = author
book.save()</pre></div><p class="paragraph"/>In this example the association link is being created by the child (Book) and hence it is not necessary to manipulate the collection directly resulting in fewer queries and more efficient code. Given an <code>Author</code> with a large number of associated <code>Book</code> instances if you were to write code like the following you would see an impact on performance:<p class="paragraph"/><div class="code"><pre>def book = <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"New Grails Book"</span>)
def author = Author.get(1)
author.addToBooks(book)
author.save()</pre></div><p class="paragraph"/>You could also model the collection as a Hibernate Bag as described above.


<a name="5.3 Persistence Basics"><!-- Legacy link --></a>
<h2 id="persistenceBasics">5.3 持久化基础</h2>
A key thing to remember about Grails is that under the surface Grails is using <a href="http://www.hibernate.org/" target="blank">Hibernate</a> for persistence. If you are coming from a background of using <a href="http://wiki.rubyonrails.org/rails/pages/ActiveRecord" target="blank">ActiveRecord</a> or <a href="http://ibatis.apache.org/," target="blank">iBatis</a> Hibernate's "session" model may feel a little strange.<p class="paragraph"/>Grails automatically binds a Hibernate session to the currently executing request. This lets you use the <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> and <a href="../ref/Domain Classes/delete.html" class="domainClasses">delete</a> methods as well as other GORM methods transparently.<p class="paragraph"/><h4>Transactional Write-Behind</h4><p class="paragraph"/>A useful feature of Hibernate over direct JDBC calls and even other frameworks is that when you call <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> or <a href="../ref/Domain Classes/delete.html" class="domainClasses">delete</a> it does not necessarily perform any SQL operations <strong class="bold">at that point</strong>. Hibernate batches up SQL statements and executes them as late as possible, often at the end of the request when flushing and closing the session. This is typically done for you automatically by Grails, which manages your Hibernate session.<p class="paragraph"/>Hibernate caches database updates where possible, only actually pushing the changes when it knows that a flush is required, or when a flush is triggered programmatically. One common case where Hibernate will flush cached updates is when performing queries since the cached information might be included in the query results. But as long as you're doing non-conflicting saves, updates, and deletes, they'll be batched until the session is flushed. This can be a significant performance boost for applications that do a lot of database writes.<p class="paragraph"/>Note that flushing is not the same as committing a transaction. If your actions are performed in the context of a transaction, flushing will execute SQL updates but the database will save the changes in its transaction queue and only finalize the updates when the transaction commits.


<a name="5.3.1 Saving and Updating"><!-- Legacy link --></a>
<h2 id="savingAndUpdating">5.3.1 保存和更新</h2>
An example of using the <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> method can be seen below:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
p.save()</pre></div><p class="paragraph"/>This save will be not be pushed to the database immediately - it will be pushed when the next flush occurs. But there are occasions when you want to control when those statements are executed or, in Hibernate terminology, when the session is "flushed". To do so you can use the flush argument to the save method:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
p.save(flush: <span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>Note that in this case  <em class="italic">all</em>  pending SQL statements including previous saves, deletes, etc. will be synchronized with the database. This also lets you catch any exceptions, which is typically useful in highly concurrent scenarios involving <a href="../guide/single.html#locking" class="guide">optimistic locking</a>:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
<span class="java&#45;keyword">try</span> &#123;
    p.save(flush: <span class="java&#45;keyword">true</span>)
&#125;
<span class="java&#45;keyword">catch</span> (org.springframework.dao.DataIntegrityViolationException e) &#123;
    // deal with exception
&#125;</pre></div><p class="paragraph"/>Another thing to bear in mind is that Grails <a href="../guide/single.html#validation" class="guide">validates</a> a domain instance every time you save it. If that validation fails the domain instance will  <em class="italic">not</em>  be persisted to the database. By default, <code>save()</code> will simply return <code>null</code> in this case, but if you would prefer it to throw an exception you can use the <code>failOnError</code> argument:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
<span class="java&#45;keyword">try</span> &#123;
    p.save(failOnError: <span class="java&#45;keyword">true</span>)
&#125;
<span class="java&#45;keyword">catch</span> (ValidationException e) &#123;
    // deal with exception
&#125;</pre></div><p class="paragraph"/>You can even change the default behaviour with a setting in <code>Config.groovy</code>, as described in the <a href="../guide/single.html#configGORM" class="guide">section on configuration</a>. Just remember that when you are saving domain instances that have been bound with data provided by the user, the likelihood of validation exceptions is quite high and you won't want those exceptions propagating to the end user.<p class="paragraph"/>You can find out more about the subtleties of saving data in <a href="http://blog.springsource.com/2010/06/23/gorm-gotchas-part-1/" target="blank">this article</a> - a must read!


<a name="5.3.2 Deleting Objects"><!-- Legacy link --></a>
<h2 id="deletingObjects">5.3.2 删除对象</h2>
An example of the <a href="../ref/Domain Classes/delete.html" class="domainClasses">delete</a> method can be seen below:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
p.delete()</pre></div><p class="paragraph"/>As with saves, Hibernate will use transactional write-behind to perform the delete; to perform the delete in-place you can use the <code>flush</code> argument:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)
p.delete(flush: <span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>Using the <code>flush</code> argument lets you catch any errors that occur during a delete. A common error that may occur is if you violate a database constraint, although this is normally down to a programming or schema error. The following example shows how to catch a <code>DataIntegrityViolationException</code> that is thrown when you violate the database constraints:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)<p class="paragraph"/><span class="java&#45;keyword">try</span> &#123;
    p.delete(flush: <span class="java&#45;keyword">true</span>)
&#125;
<span class="java&#45;keyword">catch</span> (org.springframework.dao.DataIntegrityViolationException e) &#123;
    flash.message = <span class="java&#45;quote">"Could not delete person $&#123;p.name&#125;"</span>
    redirect(action: <span class="java&#45;quote">"show"</span>, id: p.id)
&#125;</pre></div><p class="paragraph"/>Note that Grails does not supply a <code>deleteAll</code> method as deleting data is discouraged and can often be avoided through boolean flags/logic.<p class="paragraph"/>If you really need to batch delete data you can use the <a href="../ref/Domain Classes/executeUpdate.html" class="domainClasses">executeUpdate</a> method to do batch DML statements:<p class="paragraph"/><div class="code"><pre>Customer.executeUpdate(<span class="java&#45;quote">"delete Customer c where c.name = :oldName"</span>,
                       &#91;oldName: <span class="java&#45;quote">"Fred"</span>&#93;)</pre></div><p class="paragraph"/>

<a name="5.3.3 Understanding Cascading Updates and Deletes"><!-- Legacy link --></a>
<h2 id="cascades">5.3.3 理解级联更新和删除</h2>
It is critical that you understand how cascading updates and deletes work when using GORM. The key part to remember is the <code>belongsTo</code> setting which controls which class "owns" a relationship.<p class="paragraph"/>Whether it is a one-to-one, one-to-many or many-to-many, defining <code>belongsTo</code> will result in updates cascading from the owning class to its dependant (the other side of the relationship), and for many-/one-to-one and one-to-many relationships deletes will also cascade.<p class="paragraph"/>If you  <em class="italic">do not</em>  define <code>belongsTo</code> then no cascades will happen and you will have to manually save each object (except in the case of the one-to-many, in which case saves will cascade automatically if a new instance is in a <code>hasMany</code> collection).<p class="paragraph"/>Here is an example:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> hasMany = &#91;flights: Flight&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Flight &#123;
    <span class="java&#45;object">String</span> number
    <span class="java&#45;keyword">static</span> belongsTo = &#91;airport: Airport&#93;
&#125;</pre></div><p class="paragraph"/>If I now create an <code>Airport</code> and add some <code>Flight</code>s to it I can save the <code>Airport</code> and have the updates cascaded down to each flight, hence saving the whole object graph:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Airport(name: <span class="java&#45;quote">"Gatwick"</span>)
        .addToFlights(<span class="java&#45;keyword">new</span> Flight(number: <span class="java&#45;quote">"BA3430"</span>))
        .addToFlights(<span class="java&#45;keyword">new</span> Flight(number: <span class="java&#45;quote">"EZ0938"</span>))
        .save()</pre></div><p class="paragraph"/>Conversely if I later delete the <code>Airport</code> all <code>Flight</code>s associated with it will also be deleted:<p class="paragraph"/><div class="code"><pre>def airport = Airport.findByName(<span class="java&#45;quote">"Gatwick"</span>)
airport.delete()</pre></div><p class="paragraph"/>However, if I were to remove <code>belongsTo</code> then the above cascading deletion code <strong class="bold">would not work</strong>. To understand this better take a look at the summaries below that describe the default behaviour of GORM with regards to specific associations. Also read <a href="http://blog.springsource.com/2010/07/02/gorm-gotchas-part-2/" target="blank">part 2</a> of the GORM Gotchas series of articles to get a deeper understanding of relationships and cascading.<p class="paragraph"/><h5>Bidirectional one-to-many with belongsTo</h5><p class="paragraph"/><div class="code"><pre>class A &#123; <span class="java&#45;keyword">static</span> hasMany = &#91;bees: B&#93; &#125;</pre></div><p class="paragraph"/><div class="code"><pre>class B &#123; <span class="java&#45;keyword">static</span> belongsTo = &#91;a: A&#93; &#125;</pre></div><p class="paragraph"/>In the case of a bidirectional one-to-many where the many side defines a <code>belongsTo</code> then the cascade strategy is set to "ALL" for the one side and "NONE" for the many side.<p class="paragraph"/><h5>Unidirectional one-to-many</h5><p class="paragraph"/><div class="code"><pre>class A &#123; <span class="java&#45;keyword">static</span> hasMany = &#91;bees: B&#93; &#125;</pre></div><p class="paragraph"/><div class="code"><pre>class B &#123;  &#125;</pre></div><p class="paragraph"/>In the case of a unidirectional one-to-many where the many side defines no belongsTo then the cascade strategy is set to "SAVE-UPDATE".<p class="paragraph"/><h5>Bidirectional one-to-many, no belongsTo</h5><p class="paragraph"/><div class="code"><pre>class A &#123; <span class="java&#45;keyword">static</span> hasMany = &#91;bees: B&#93; &#125;</pre></div><p class="paragraph"/><div class="code"><pre>class B &#123; A a &#125;</pre></div><p class="paragraph"/>In the case of a bidirectional one-to-many where the many side does not define a <code>belongsTo</code> then the cascade strategy is set to "SAVE-UPDATE" for the one side and "NONE" for the many side.<p class="paragraph"/><h5>Unidirectional one-to-one with belongsTo</h5><p class="paragraph"/><div class="code"><pre>class A &#123;  &#125;</pre></div><p class="paragraph"/><div class="code"><pre>class B &#123; <span class="java&#45;keyword">static</span> belongsTo = &#91;a: A&#93; &#125;</pre></div><p class="paragraph"/>In the case of a unidirectional one-to-one association that defines a <code>belongsTo</code> then the cascade strategy is set to "ALL" for the owning side of the relationship (A-&#62;B) and "NONE" from the side that defines the <code>belongsTo</code> (B-&#62;A)<p class="paragraph"/>Note that if you need further control over cascading behaviour, you can use the <a href="../guide/single.html#ormdsl" class="guide">ORM DSL</a>.


<a name="5.3.4 Eager and Lazy Fetching"><!-- Legacy link --></a>
<h2 id="fetching">5.3.4 立即加载和延迟加载</h2>
Associations in GORM are by default lazy. This is best explained by example:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> hasMany = &#91;flights: Flight&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Flight &#123;
    <span class="java&#45;object">String</span> number
    Location destination
    <span class="java&#45;keyword">static</span> belongsTo = &#91;airport: Airport&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Location &#123;
    <span class="java&#45;object">String</span> city
    <span class="java&#45;object">String</span> country
&#125;</pre></div><p class="paragraph"/>Given the above domain classes and the following code:<p class="paragraph"/><div class="code"><pre>def airport = Airport.findByName(<span class="java&#45;quote">"Gatwick"</span>)
<span class="java&#45;keyword">for</span> (flight in airport.flights) &#123;
    println flight.destination.city
&#125;</pre></div><p class="paragraph"/>GORM will execute a single SQL query to fetch the <code>Airport</code> instance, another to get its flights, and then 1 extra query for  <em class="italic">each iteration</em>  over the <code>flights</code> association to get the current flight's destination. In other words you get N+1 queries (if you exclude the original one to get the airport).<p class="paragraph"/><h3>Configuring Eager Fetching</h3><p class="paragraph"/>An alternative approach that avoids the N+1 queries is to use eager fetching, which can be specified as follows:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> hasMany = &#91;flights: Flight&#93;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        flights lazy: <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case the <code>flights</code> association will be loaded at the same time as its <code>Airport</code> instance, although a second query will be executed to fetch the collection. You can also use <code>fetch: 'join'</code> instead of <code>lazy: false</code> , in which case GORM will only execute a single query to get the airports and their flights. This works well for single-ended associations, but you need to be careful with one-to-manys. Queries will work as you'd expect right up to the moment you add a limit to the number of results you want. At that point, you will likely end up with fewer results than you were expecting. The reason for this is quite technical but ultimately the problem arises from GORM using a left outer join.<p class="paragraph"/>So, the recommendation is currently to use <code>fetch: 'join'</code> for single-ended associations and <code>lazy: false</code> for one-to-manys.<p class="paragraph"/>Be careful how and where you use eager loading because you could load your entire database into memory with too many eager associations. You can find more information on the mapping options in the <a href="../guide/single.html#fetchingDSL" class="guide">section on the ORM DSL</a>.<p class="paragraph"/><h3>Using Batch Fetching</h3><p class="paragraph"/>Although eager fetching is appropriate for some cases, it is not always desirable. If you made everything eager you could quite possibly load your entire database into memory resulting in performance and memory problems. An alternative to eager fetching is to use batch fetching. You can configure Hibernate to lazily fetch results in "batches". For example:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> hasMany = &#91;flights: Flight&#93;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        flights batchSize: 10
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case, due to the <code>batchSize</code> argument, when you iterate over the <code>flights</code> association, Hibernate will fetch results in batches of 10. For example if you had an <code>Airport</code> that had 30 flights, if you didn't configure batch fetching you would get 1 query to fetch the <code>Airport</code> and then <code>30</code> queries to fetch each flight. With batch fetching you get 1 query to fetch the <code>Airport</code> and 3 queries to fetch each <code>Flight</code> in batches of 10. In other words, batch fetching is an optimization of the lazy fetching strategy. Batch fetching can also be configured at the class level as follows:<p class="paragraph"/><div class="code"><pre>class Flight &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        batchSize 10
    &#125;
&#125;</pre></div><p class="paragraph"/>Check out <a href="http://blog.springsource.com/2010/07/28/gorm-gotchas-part-3/" target="blank">part 3</a> of the GORM Gotchas series for more in-depth coverage of this tricky topic.


<a name="5.3.5 Pessimistic and Optimistic Locking"><!-- Legacy link --></a>
<h2 id="locking">5.3.5 悲观锁和乐观锁</h2>
<h4>Optimistic Locking</h4><p class="paragraph"/>By default GORM classes are configured for optimistic locking. Optimistic locking is a feature of Hibernate which involves storing a version value in a special <code>version</code> column in the database that is incremented after each update.<p class="paragraph"/>The <code>version</code> column gets read into a <code>version</code> property that contains the current versioned state of persistent instance which you can access:<p class="paragraph"/><div class="code"><pre>def airport = Airport.get(10)<p class="paragraph"/>println airport.version</pre></div><p class="paragraph"/>When you perform updates Hibernate will automatically check the version property against the  version column in the database and if they differ will throw a <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/StaleObjectStateException.html" class="api">StaleObjectException</a>. This will roll back the transaction if one is active.<p class="paragraph"/>This is useful as it allows a certain level of atomicity without resorting to pessimistic locking that has an inherit performance penalty. The downside is that you have to deal with this exception if you have highly concurrent writes. This requires flushing the session:<p class="paragraph"/><div class="code"><pre>def airport = Airport.get(10)<p class="paragraph"/><span class="java&#45;keyword">try</span> &#123;
    airport.name = <span class="java&#45;quote">"Heathrow"</span>
    airport.save(flush: <span class="java&#45;keyword">true</span>)
&#125;
<span class="java&#45;keyword">catch</span> (org.springframework.dao.OptimisticLockingFailureException e) &#123;
    // deal with exception
&#125;</pre></div><p class="paragraph"/>The way you deal with the exception depends on the application. You could attempt a programmatic merge of the data or go back to the user and ask them to resolve the conflict.<p class="paragraph"/>Alternatively, if it becomes a problem you can resort to pessimistic locking.<p class="paragraph"/><blockquote class="note">
The <code>version</code> will only be updated after flushing the session.
</blockquote><p class="paragraph"/><h4>Pessimistic Locking</h4><p class="paragraph"/>Pessimistic locking is equivalent to doing a SQL "SELECT * FOR UPDATE" statement and locking a row in the database. This has the implication that other read operations will be blocking until the lock is released.<p class="paragraph"/>In Grails pessimistic locking is performed on an existing instance with the <a href="../ref/Domain Classes/lock.html" class="domainClasses">lock</a> method:<p class="paragraph"/><div class="code"><pre>def airport = Airport.get(10)
airport.lock() // lock <span class="java&#45;keyword">for</span> update
airport.name = <span class="java&#45;quote">"Heathrow"</span>
airport.save()</pre></div><p class="paragraph"/>Grails will automatically deal with releasing the lock for you once the transaction has been committed. However, in the above case what we are doing is "upgrading" from a regular SELECT to a SELECT..FOR UPDATE and another thread could still have updated the record in between the call to <code>get()</code> and the call to <code>lock()</code>.<p class="paragraph"/>To get around this problem you can use the static <a href="../ref/Domain Classes/lock.html" class="domainClasses">lock</a> method that takes an id just like <a href="../ref/Domain Classes/get.html" class="domainClasses">get</a>:<p class="paragraph"/><div class="code"><pre>def airport = Airport.lock(10) // lock <span class="java&#45;keyword">for</span> update
airport.name = <span class="java&#45;quote">"Heathrow"</span>
airport.save()</pre></div><p class="paragraph"/>In this case only SELECT..FOR UPDATE is issued.<p class="paragraph"/>As well as the <a href="../ref/Domain Classes/lock.html" class="domainClasses">lock</a> method you can also obtain a pessimistic locking using queries. For example using a dynamic finder:<p class="paragraph"/><div class="code"><pre>def airport = Airport.findByName(<span class="java&#45;quote">"Heathrow"</span>, &#91;lock: <span class="java&#45;keyword">true</span>&#93;)</pre></div><p class="paragraph"/>Or using criteria:<p class="paragraph"/><div class="code"><pre>def airport = Airport.createCriteria().get &#123;
    eq('name', 'Heathrow')
    lock <span class="java&#45;keyword">true</span>
&#125;</pre></div><p class="paragraph"/>

<a name="5.3.6 Modification Checking"><!-- Legacy link --></a>
<h2 id="modificationChecking">5.3.6 修改检查</h2>
Once you have loaded and possibly modified a persistent domain class instance, it isn't straightforward to retrieve the original values. If you try to reload the instance using <a href="../ref/Domain Classes/get.html" class="domainClasses">get</a> Hibernate will return the current modified instance from its Session cache. Reloading using another query would trigger a flush which could cause problems if your data isn't ready to be flushed yet. So GORM provides some methods to retrieve the original values that Hibernate caches when it loads the instance (which it uses for dirty checking).<p class="paragraph"/><h4>isDirty</h4><p class="paragraph"/>You can use the <a href="../ref/Domain Classes/isDirty.html" class="domainClasses">isDirty</a> method to check if any field has been modified:<p class="paragraph"/><div class="code"><pre>def airport = Airport.get(10)
assert !airport.isDirty()<p class="paragraph"/>airport.properties = params
<span class="java&#45;keyword">if</span> (airport.isDirty()) &#123;
   // <span class="java&#45;keyword">do</span> something based on changed state
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
<code>isDirty()</code> does not currently check collection associations, but it does check all other persistent properties and associations.
</blockquote><p class="paragraph"/>You can also check if individual fields have been modified:<p class="paragraph"/><div class="code"><pre>def airport = Airport.get(10)
assert !airport.isDirty()<p class="paragraph"/>airport.properties = params
<span class="java&#45;keyword">if</span> (airport.isDirty('name')) &#123;
   // <span class="java&#45;keyword">do</span> something based on changed name
&#125;</pre></div><p class="paragraph"/><h4>getDirtyPropertyNames</h4><p class="paragraph"/>You can use the <a href="../ref/Domain Classes/getDirtyPropertyNames.html" class="domainClasses">getDirtyPropertyNames</a> method to retrieve the names of modified fields; this may be empty but will not be null:<p class="paragraph"/><div class="code"><pre>def airport = Airport.get(10)
assert !airport.isDirty()<p class="paragraph"/>airport.properties = params
def modifiedFieldNames = airport.getDirtyPropertyNames()
<span class="java&#45;keyword">for</span> (fieldName in modifiedFieldNames) &#123;
   // <span class="java&#45;keyword">do</span> something based on changed value
&#125;</pre></div><p class="paragraph"/><h4>getPersistentValue</h4><p class="paragraph"/>You can use the <a href="../ref/Domain Classes/getPersistentValue.html" class="domainClasses">getPersistentValue</a> method to retrieve the value of a modified field:<p class="paragraph"/><div class="code"><pre>def airport = Airport.get(10)
assert !airport.isDirty()<p class="paragraph"/>airport.properties = params
def modifiedFieldNames = airport.getDirtyPropertyNames()
<span class="java&#45;keyword">for</span> (fieldName in modifiedFieldNames) &#123;
    def currentValue = airport.<span class="java&#45;quote">"$fieldName"</span>
    def originalValue = airport.getPersistentValue(fieldName)
    <span class="java&#45;keyword">if</span> (currentValue != originalValue) &#123;
        // <span class="java&#45;keyword">do</span> something based on changed value
    &#125;
&#125;</pre></div><p class="paragraph"/>

<a name="5.4 Querying with GORM"><!-- Legacy link --></a>
<h2 id="querying">5.4 GORM查询</h2>
GORM supports a number of powerful ways to query from dynamic finders, to criteria to Hibernate's object oriented query language HQL.<p class="paragraph"/>Groovy's ability to manipulate collections with <a href="http://groovy.codehaus.org/GPath" target="blank">GPath</a> and methods like sort, findAll and so on combined with GORM results in a powerful combination.<p class="paragraph"/>However, let's start with the basics.<p class="paragraph"/><h4>Listing instances</h4><p class="paragraph"/>Use the <a href="../ref/Domain Classes/list.html" class="domainClasses">list</a> method to obtain all instances of a given class:<p class="paragraph"/><div class="code"><pre>def books = Book.list()</pre></div><p class="paragraph"/>The <a href="../ref/Domain Classes/list.html" class="domainClasses">list</a> method supports arguments to perform pagination:<p class="paragraph"/><div class="code"><pre>def books = Book.list(offset:10, max:20)</pre></div><p class="paragraph"/>as well as sorting:<p class="paragraph"/><div class="code"><pre>def books = Book.list(sort:<span class="java&#45;quote">"title"</span>, order:<span class="java&#45;quote">"asc"</span>)</pre></div><p class="paragraph"/>Here, the <code>sort</code> argument is the name of the domain class property that you wish to sort on, and the <code>order</code> argument is either <code>asc</code> for <strong class="bold">asc</strong>ending or <code>desc</code> for <strong class="bold">desc</strong>ending.<p class="paragraph"/><h4>Retrieval by Database  Identifier</h4><p class="paragraph"/>The second basic form of retrieval is by database identifier using the <a href="../ref/Domain Classes/get.html" class="domainClasses">get</a> method:<p class="paragraph"/><div class="code"><pre>def book = Book.get(23)</pre></div><p class="paragraph"/>You can also obtain a list of instances for a set of identifiers using <a href="../ref/Domain Classes/getAll.html" class="domainClasses">getAll</a>:<p class="paragraph"/><div class="code"><pre>def books = Book.getAll(23, 93, 81)</pre></div>


<a name="5.4.1 Dynamic Finders"><!-- Legacy link --></a>
<h2 id="finders">5.4.1 动态查询器</h2>
GORM supports the concept of <strong class="bold">dynamic finders</strong>. A dynamic finder looks like a static method invocation, but the methods themselves don't actually exist in any form at the code level.<p class="paragraph"/>Instead, a method is auto-magically generated using code synthesis at runtime, based on the properties of a given class. Take for example the <code>Book</code> class:<p class="paragraph"/><div class="code"><pre>class Book &#123;
    <span class="java&#45;object">String</span> title
    Date releaseDate
    Author author
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Author &#123;
    <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/>The <code>Book</code> class has properties such as <code>title</code>, <code>releaseDate</code> and <code>author</code>. These can be used by the <a href="../ref/Domain Classes/findBy.html" class="domainClasses">findBy</a> and <a href="../ref/Domain Classes/findAllBy.html" class="domainClasses">findAllBy</a> methods in the form of "method expressions":<p class="paragraph"/><div class="code"><pre>def book = Book.findByTitle(<span class="java&#45;quote">"The Stand"</span>)<p class="paragraph"/>book = Book.findByTitleLike(<span class="java&#45;quote">"Harry Pot%"</span>)<p class="paragraph"/>book = Book.findByReleaseDateBetween(firstDate, secondDate)<p class="paragraph"/>book = Book.findByReleaseDateGreaterThan(someDate)<p class="paragraph"/>book = Book.findByTitleLikeOrReleaseDateLessThan(<span class="java&#45;quote">"%Something%"</span>, someDate)</pre></div><p class="paragraph"/><h4>Method Expressions</h4><p class="paragraph"/>A method expression in GORM is made up of the prefix such as <a href="../ref/Domain Classes/findBy.html" class="domainClasses">findBy</a> followed by an expression that combines one or more properties. The basic form is:<p class="paragraph"/><div class="code"><pre>Book.findBy(&#91;Property&#93;&#91;Comparator&#93;&#91;<span class="java&#45;object">Boolean</span> Operator&#93;)?&#91;Property&#93;&#91;Comparator&#93;</pre></div><p class="paragraph"/>The tokens marked with a '?' are optional. Each comparator changes the nature of the query. For example:<p class="paragraph"/><div class="code"><pre>def book = Book.findByTitle(<span class="java&#45;quote">"The Stand"</span>)<p class="paragraph"/>book =  Book.findByTitleLike(<span class="java&#45;quote">"Harry Pot%"</span>)</pre></div><p class="paragraph"/>In the above example the first query is equivalent to equality whilst the latter, due to the <code>Like</code> comparator, is equivalent to a SQL <code>like</code> expression.<p class="paragraph"/>The possible comparators include:
<ul class="star">
<li><code>InList</code> - In the list of given values</li>
<li><code>LessThan</code> - less than a given value</li>
<li><code>LessThanEquals</code> - less than or equal a give value</li>
<li><code>GreaterThan</code> - greater than a given value</li>
<li><code>GreaterThanEquals</code> - greater than or equal a given value</li>
<li><code>Like</code> - Equivalent to a SQL like expression</li>
<li><code>Ilike</code> - Similar to a <code>Like</code>, except case insensitive</li>
<li><code>NotEqual</code> - Negates equality</li>
<li><code>Between</code> - Between two values (requires two arguments)</li>
<li><code>IsNotNull</code> - Not a null value (doesn't take an argument)</li>
<li><code>IsNull</code> - Is a null value (doesn't take an argument)</li>
</ul><p class="paragraph"/>Notice that the last three require different numbers of method arguments compared to the rest, as demonstrated in the following example:<p class="paragraph"/><div class="code"><pre>def now = <span class="java&#45;keyword">new</span> Date()
def lastWeek = now &#45; 7
def book = Book.findByReleaseDateBetween(lastWeek, now)<p class="paragraph"/>books = Book.findAllByReleaseDateIsNull()
books = Book.findAllByReleaseDateIsNotNull()</pre></div><p class="paragraph"/><h4>Boolean logic (AND/OR)</h4><p class="paragraph"/>Method expressions can also use a boolean operator to combine two or more criteria:<p class="paragraph"/><div class="code"><pre>def books = Book.findAllByTitleLikeAndReleaseDateGreaterThan(
                      <span class="java&#45;quote">"%Java%"</span>, <span class="java&#45;keyword">new</span> Date() &#45; 30)</pre></div><p class="paragraph"/>In this case we're using <code>And</code> in the middle of the query to make sure both conditions are satisfied, but you could equally use <code>Or</code>:<p class="paragraph"/><div class="code"><pre>def books = Book.findAllByTitleLikeOrReleaseDateGreaterThan(
                      <span class="java&#45;quote">"%Java%"</span>, <span class="java&#45;keyword">new</span> Date() &#45; 30)</pre></div><p class="paragraph"/>You can combine as many criteria as you like, but they must all be combined with <code>And</code> or all <code>Or</code>. If you need to combine <code>And</code> and <code>Or</code> or if the number of criteria creates a very long method name, just convert the query to a <a href="../guide/single.html#criteria" class="guide">Criteria</a> or <a href="../guide/single.html#hql" class="guide">HQL</a> query.<p class="paragraph"/><h4>Querying Associations</h4><p class="paragraph"/>Associations can also be used within queries:<p class="paragraph"/><div class="code"><pre>def author = Author.findByName(<span class="java&#45;quote">"Stephen King"</span>)<p class="paragraph"/>def books = author ? Book.findAllByAuthor(author) : &#91;&#93;</pre></div><p class="paragraph"/>In this case if the <code>Author</code> instance is not null we use it in a query to obtain all the <code>Book</code> instances for the given <code>Author</code>.<p class="paragraph"/><h4>Pagination and Sorting</h4><p class="paragraph"/>The same pagination and sorting parameters available on the <a href="../ref/Domain Classes/list.html" class="domainClasses">list</a> method can also be used with dynamic finders by supplying a map as the final parameter:<p class="paragraph"/><div class="code"><pre>def books = Book.findAllByTitleLike(<span class="java&#45;quote">"Harry Pot%"</span>,
               &#91;max: 3, offset: 2, sort: <span class="java&#45;quote">"title"</span>, order: <span class="java&#45;quote">"desc"</span>&#93;)</pre></div>



<h2 id="whereQueries">5.4.2 Where查询</h2>
The <code>where</code> method, introduced in Grails 2.0, builds on the support for <a href="../guide/single.html#detachedCriteria" class="guide">Detached Criteria</a> by providing an enhanced, compile-time checked query DSL for common queries. The <code>where</code> method is more flexible than dynamic finders, less verbose than criteria and provides a powerful mechanism to compose queries.<p class="paragraph"/><h4>Basic Querying</h4><p class="paragraph"/>The <code>where</code> method accepts a closure that looks very similar to Groovy's regular collection methods. The closure should define the logical criteria in regular Groovy syntax, for example:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
   firstName == <span class="java&#45;quote">"Bart"</span>
&#125;
Person bart = query.find()</pre></div><p class="paragraph"/>The returned object is a <code>DetachedCriteria</code> instance, which means it is not associated with any particular database connection or session. This means you can use the <code>where</code> method to define common queries at the class level:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;keyword">static</span> simpsons = where &#123;
         lastName == <span class="java&#45;quote">"Simpson"</span>
    &#125;
    &#8230;
&#125;
&#8230;
Person.simpsons.each &#123;
    println it.firstname
&#125;</pre></div><p class="paragraph"/>Query execution is lazy and only happens upon usage of the <a href="../guide/single.html#detachedCriteria" class="guide">DetachedCriteria</a> instance. If you want to execute a where-style query immediately there are variations of the <code>findAll</code> and <code>find</code> methods to accomplish this:<p class="paragraph"/><div class="code"><pre>def results = Person.findAll &#123;
     lastName == <span class="java&#45;quote">"Simpson"</span>
&#125;
def results = Person.findAll(sort:<span class="java&#45;quote">"firstName"</span>) &#123;
     lastName == <span class="java&#45;quote">"Simpson"</span>
&#125;
Person p = Person.find &#123; firstName == <span class="java&#45;quote">"Bart"</span> &#125;</pre></div><p class="paragraph"/>Each Groovy operator maps onto a regular criteria method. The following table provides a map of Groovy operators to methods:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Operator</th><th>Criteria Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">==</strong></td><td>eq</td><td>Equal to</td></tr><tr class="table-even"><td><strong class="bold">!=</strong></td><td>ne</td><td>Not equal to</td></tr><tr class="table-odd"><td><strong class="bold">&#62;</strong></td><td>gt</td><td>Greater than</td></tr><tr class="table-even"><td><strong class="bold">&#60;</strong></td><td>lt</td><td>Less than</td></tr><tr class="table-odd"><td><strong class="bold">&#62;=</strong></td><td>ge</td><td>Greater than or equal to</td></tr><tr class="table-even"><td><strong class="bold">&#60;=</strong></td><td>le</td><td>Less than or equal to</td></tr><tr class="table-odd"><td><strong class="bold">in</strong></td><td>inList</td><td>Contained within the given list</td></tr><tr class="table-even"><td><strong class="bold">==~</strong></td><td>like</td><td>Like a given string</td></tr><tr class="table-odd"><td><strong class="bold">=~</strong></td><td>ilike</td><td>Case insensitive like</td></tr></table><p class="paragraph"/>It is possible use regular Groovy comparison operators and logic to formulate complex queries:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    (lastName != <span class="java&#45;quote">"Simpson"</span> &#38;&#38; firstName != <span class="java&#45;quote">"Fred"</span>) || (firstName == <span class="java&#45;quote">"Bart"</span> &#38;&#38; age &#62; 9)
&#125;
def results = query.list(sort:<span class="java&#45;quote">"firstName"</span>)</pre></div><p class="paragraph"/>The Groovy regex matching operators map onto like and ilike queries unless the expression on the right hand side is a <code>Pattern</code> object, in which case they map onto an <code>rlike</code> query:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
     firstName ==~ ~/B.+/
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
Note that <code>rlike</code> queries are only supported if the underlying database supports regular expressions
</blockquote><p class="paragraph"/>A <code>between</code> criteria query can be done by combining the <code>in</code> keyword with a range:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
     age in 18..65
&#125;</pre></div><p class="paragraph"/>Finally, you can do <code>isNull</code> and <code>isNotNull</code> style queries by using <code>null</code> with regular comparison operators:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
     middleName == <span class="java&#45;keyword">null</span>
&#125;</pre></div><p class="paragraph"/><h4>Query Composition</h4><p class="paragraph"/>Since the return value of the <code>where</code> method is a <a href="../guide/single.html#detachedCriteria" class="guide">DetachedCriteria</a> instance you can compose new queries from the original query:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
     lastName == <span class="java&#45;quote">"Simpson"</span>
&#125;
def bartQuery = query.where &#123;
     firstName == <span class="java&#45;quote">"Bart"</span>
&#125;
Person p = bartQuery.find()</pre></div><p class="paragraph"/>Note that you cannot pass a closure defined as a variable into the <code>where</code> method unless it has been explicitly cast to a <code>DetachedCriteria</code> instance. In other words the following will produce an error:<p class="paragraph"/><div class="code"><pre>def callable = &#123;
    lastName == <span class="java&#45;quote">"Simpson"</span>
&#125;
def query = Person.where(callable)</pre></div><p class="paragraph"/>The above must be written as follows:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.gorm.DetachedCriteria<p class="paragraph"/>def callable = &#123;
    lastName == <span class="java&#45;quote">"Simpson"</span>
&#125; as DetachedCriteria&#60;Person&#62;
def query = Person.where(callable)</pre></div><p class="paragraph"/>As you can see the closure definition is cast (using the Groovy <code>as</code> keyword) to a <a href="../guide/single.html#detachedCriteria" class="guide">DetachedCriteria</a> instance targeted at the <code>Person</code> class.<p class="paragraph"/><h4>Conjunction, Disjunction and Negation</h4><p class="paragraph"/>As mentioned previously you can combine regular Groovy logical operators (<code>||</code> and <code>&#38;&#38;</code>) to form conjunctions and disjunctions:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    (lastName != <span class="java&#45;quote">"Simpson"</span> &#38;&#38; firstName != <span class="java&#45;quote">"Fred"</span>) || (firstName == <span class="java&#45;quote">"Bart"</span> &#38;&#38; age &#62; 9)
&#125;</pre></div><p class="paragraph"/>You can also negate a logical comparison using <code>!</code>:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    firstName == <span class="java&#45;quote">"Fred"</span> &#38;&#38; !(lastName == 'Simpson')
&#125;</pre></div><p class="paragraph"/><h4>Property Comparison Queries</h4><p class="paragraph"/>If you use a property name on both the left hand and right side of a comparison expression then the appropriate property comparison criteria is automatically used:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
   firstName == lastName
&#125;</pre></div><p class="paragraph"/>The following table described how each comparison operator maps onto each criteria property comparison method:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Operator</th><th>Criteria Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">==</strong></td><td>eqProperty</td><td>Equal to</td></tr><tr class="table-even"><td><strong class="bold">!=</strong></td><td>neProperty</td><td>Not equal to</td></tr><tr class="table-odd"><td><strong class="bold">&#62;</strong></td><td>gtProperty</td><td>Greater than</td></tr><tr class="table-even"><td><strong class="bold">&#60;</strong></td><td>ltProperty</td><td>Less than</td></tr><tr class="table-odd"><td><strong class="bold">&#62;=</strong></td><td>geProperty</td><td>Greater than or equal to</td></tr><tr class="table-even"><td><strong class="bold">&#60;=</strong></td><td>leProperty</td><td>Less than or equal to</td></tr></table><p class="paragraph"/><h4>Querying Associations</h4><p class="paragraph"/>Associations can be queried by using the dot operator to specify the property name of the association to be queried:<p class="paragraph"/><div class="code"><pre>def query = Pet.where &#123;
    owner.firstName == <span class="java&#45;quote">"Joe"</span> || owner.firstName == <span class="java&#45;quote">"Fred"</span>
&#125;</pre></div><p class="paragraph"/>You can group multiple criterion inside a closure method call where the name of the method matches the association name:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    pets &#123; name == <span class="java&#45;quote">"Jack"</span> || name == <span class="java&#45;quote">"Joe"</span> &#125;
&#125;</pre></div><p class="paragraph"/>This technique can be combined with other top-level criteria:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
     pets &#123; name == <span class="java&#45;quote">"Jack"</span> &#125; || firstName == <span class="java&#45;quote">"Ed"</span>
&#125;</pre></div><p class="paragraph"/>For collection associations it is possible to apply queries to the size of the collection:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
       pets.size() == 2
&#125;</pre></div><p class="paragraph"/>The following table shows which operator maps onto which criteria method for each size() comparison:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Operator</th><th>Criteria Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">==</strong></td><td>sizeEq</td><td>The collection size is equal to</td></tr><tr class="table-even"><td><strong class="bold">!=</strong></td><td>sizeNe</td><td>The collection size is not equal to</td></tr><tr class="table-odd"><td><strong class="bold">&#62;</strong></td><td>sizeGt</td><td>The collection size is greater than</td></tr><tr class="table-even"><td><strong class="bold">&#60;</strong></td><td>sizeLt</td><td>The collection size is less than</td></tr><tr class="table-odd"><td><strong class="bold">&#62;=</strong></td><td>sizeGe</td><td>The collection size is greater than or equal to</td></tr><tr class="table-even"><td><strong class="bold">&#60;=</strong></td><td>sizeLe</td><td>The collection size is less than or equal to</td></tr></table><p class="paragraph"/>
<h4>Subqueries</h4><p class="paragraph"/>It is possible to execute subqueries within where queries. For example to find all the people older than the average age the following query can be used:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">final</span> query = Person.where &#123;
  age &#62; avg(age)
&#125;</pre></div><p class="paragraph"/>The following table lists the possible subqueries:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">avg</strong></td><td>The average of all values</td></tr><tr class="table-even"><td><strong class="bold">sum</strong></td><td>The sum of all values</td></tr><tr class="table-odd"><td><strong class="bold">max</strong></td><td>The maximum value</td></tr><tr class="table-even"><td><strong class="bold">min</strong></td><td>The minimum value</td></tr><tr class="table-odd"><td><strong class="bold">count</strong></td><td>The count of all values</td></tr><tr class="table-even"><td><strong class="bold">property</strong></td><td>Retrieves a property of the resulting entities</td></tr></table><p class="paragraph"/>You can apply additional criteria to any subquery by using the <code>of</code> method and passing in a closure containing the criteria:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
  age &#62; avg(age).of &#123; lastName == <span class="java&#45;quote">"Simpson"</span> &#125; &#38;&#38; firstName == <span class="java&#45;quote">"Homer"</span>
&#125;</pre></div><p class="paragraph"/>Since the <code>property</code> subquery returns multiple results, the criterion used compares all results. For example the following query will find all people younger than people with the surname "Simpson":<p class="paragraph"/><div class="code"><pre>Person.where &#123;
    age &#60; property(age).of &#123; lastName == <span class="java&#45;quote">"Simpson"</span> &#125;
&#125;</pre></div><p class="paragraph"/>
<h4>Other Functions</h4><p class="paragraph"/>There are several functions available to you within the context of a query. These are summarized in the table below:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">second</strong></td><td>The second of a date property</td></tr><tr class="table-even"><td><strong class="bold">minute</strong></td><td>The minute of a date property</td></tr><tr class="table-odd"><td><strong class="bold">hour</strong></td><td>The hour of a date property</td></tr><tr class="table-even"><td><strong class="bold">day</strong></td><td>The day of the month of a date property</td></tr><tr class="table-odd"><td><strong class="bold">month</strong></td><td>The month of a date property</td></tr><tr class="table-even"><td><strong class="bold">year</strong></td><td>The year of a date property</td></tr><tr class="table-odd"><td><strong class="bold">lower</strong></td><td>Converts a string property to upper case</td></tr><tr class="table-even"><td><strong class="bold">upper</strong></td><td>Converts a string property to lower case</td></tr><tr class="table-odd"><td><strong class="bold">length</strong></td><td>The length of a string property</td></tr><tr class="table-even"><td><strong class="bold">trim</strong></td><td>Trims a string property</td></tr></table><p class="paragraph"/><blockquote class="note">
Currently functions can only be applied to properties or associations of domain classes. You cannot, for example, use a function on a result of a subquery. 
</blockquote><p class="paragraph"/>For example the following query can be used to find all pet's born in 2011:<p class="paragraph"/><div class="code"><pre>def query = Pet.where &#123;
    year(birthDate) == 2011
&#125;</pre></div><p class="paragraph"/>You can also apply functions to associations:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    year(pets.birthDate) == 2009
&#125;</pre></div><p class="paragraph"/>
<h4>Batch Updates and Deletes</h4><p class="paragraph"/>Since each <code>where</code> method call returns a <a href="../guide/single.html#detachedCriteria" class="guide">DetachedCriteria</a> instance, you can use <code>where</code> queries to execute batch operations such as batch updates and deletes. For example, the following query will update all people with the surname "Simpson" to have the surname "Bloggs":<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    lastName == 'Simpson'
&#125;
<span class="java&#45;object">int</span> total = query.updateAll(lastName:<span class="java&#45;quote">"Bloggs"</span>)</pre></div><p class="paragraph"/><blockquote class="note">
Note that one limitation with regards to batch operations is that join queries (queries that query associations) are not allowed.
</blockquote><p class="paragraph"/>To batch delete records you can use the <code>deleteAll</code> method:<p class="paragraph"/><div class="code"><pre>def query = Person.where &#123;
    lastName == 'Simpson'
&#125;
<span class="java&#45;object">int</span> total = query.deleteAll()</pre></div>

<a name="5.4.2 Criteria"><!-- Legacy link --></a>
<h2 id="criteria">5.4.3 条件查询</h2>
Criteria is an advanced way to query that uses a Groovy builder to construct potentially complex queries. It is a much better approach than building up query strings using a <code>StringBuffer</code>.<p class="paragraph"/>Criteria can be used either with the <a href="../ref/Domain Classes/createCriteria.html" class="domainClasses">createCriteria</a> or <a href="../ref/Domain Classes/withCriteria.html" class="domainClasses">withCriteria</a> methods. The builder uses Hibernate's Criteria API. The nodes on this builder map the static methods found in the <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/criterion/Restrictions.html" class="api">Restrictions</a> class of the Hibernate Criteria API. For example:<p class="paragraph"/><div class="code"><pre>def c = Account.createCriteria()
def results = c &#123;
    between(<span class="java&#45;quote">"balance"</span>, 500, 1000)
    eq(<span class="java&#45;quote">"branch"</span>, <span class="java&#45;quote">"London"</span>)
    or &#123;
        like(<span class="java&#45;quote">"holderFirstName"</span>, <span class="java&#45;quote">"Fred%"</span>)
        like(<span class="java&#45;quote">"holderFirstName"</span>, <span class="java&#45;quote">"Barney%"</span>)
    &#125;
    maxResults(10)
    order(<span class="java&#45;quote">"holderLastName"</span>, <span class="java&#45;quote">"desc"</span>)
&#125;</pre></div><p class="paragraph"/>This criteria will select up to 10 <code>Account</code> objects in a List matching the following criteria:
<ul class="star">
<li><code>balance</code> is between 500 and 1000</li>
<li><code>branch</code> is 'London'</li>
<li><code>holderFirstName</code> starts with 'Fred' or 'Barney'</li>
</ul><p class="paragraph"/>The results will be sorted in descending order by <code>holderLastName</code>.<p class="paragraph"/>If no records are found with the above criteria, an empty List is returned.<p class="paragraph"/><h4>Conjunctions and Disjunctions</h4><p class="paragraph"/>As demonstrated in the previous example you can group criteria in a logical OR using an <code>or { }</code> block:<p class="paragraph"/><div class="code"><pre>or &#123;
    between(<span class="java&#45;quote">"balance"</span>, 500, 1000)
    eq(<span class="java&#45;quote">"branch"</span>, <span class="java&#45;quote">"London"</span>)
&#125;</pre></div><p class="paragraph"/>This also works with logical AND:<p class="paragraph"/><div class="code"><pre>and &#123;
    between(<span class="java&#45;quote">"balance"</span>, 500, 1000)
    eq(<span class="java&#45;quote">"branch"</span>, <span class="java&#45;quote">"London"</span>)
&#125;</pre></div><p class="paragraph"/>And you can also negate using logical NOT:<p class="paragraph"/><div class="code"><pre>not &#123;
    between(<span class="java&#45;quote">"balance"</span>, 500, 1000)
    eq(<span class="java&#45;quote">"branch"</span>, <span class="java&#45;quote">"London"</span>)
&#125;</pre></div><p class="paragraph"/>All top level conditions are implied to be AND'd together.<p class="paragraph"/><h4>Querying Associations</h4><p class="paragraph"/>Associations can be queried by having a node that matches the property name. For example say the <code>Account</code> class had many <code>Transaction</code> objects:<p class="paragraph"/><div class="code"><pre>class Account &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> hasMany = &#91;transactions: Transaction&#93;
    &#8230;
&#125;</pre></div><p class="paragraph"/>We can query this association by using the property name <code>transaction</code> as a builder node:<p class="paragraph"/><div class="code"><pre>def c = Account.createCriteria()
def now = <span class="java&#45;keyword">new</span> Date()
def results = c.list &#123;
    transactions &#123;
        between('date', now &#45; 10, now)
    &#125;
&#125;</pre></div><p class="paragraph"/>The above code will find all the <code>Account</code> instances that have performed <code>transactions</code> within the last 10 days.
You can also nest such association queries within logical blocks:<p class="paragraph"/><div class="code"><pre>def c = Account.createCriteria()
def now = <span class="java&#45;keyword">new</span> Date()
def results = c.list &#123;
    or &#123;
        between('created', now &#45; 10, now)
        transactions &#123;
            between('date', now &#45; 10, now)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Here we find all accounts that have either performed transactions in the last 10 days OR have been recently created in the last 10 days.<p class="paragraph"/><h4>Querying with Projections</h4><p class="paragraph"/>Projections may be used to customise the results. Define a "projections" node within the criteria builder tree to use projections. There are equivalent methods within the projections node to the methods found in the Hibernate <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/criterion/Projections.html" class="api">Projections</a> class:<p class="paragraph"/><div class="code"><pre>def c = Account.createCriteria()<p class="paragraph"/>def numberOfBranches = c.get &#123;
    projections &#123;
        countDistinct('branch')
    &#125;
&#125;</pre></div><p class="paragraph"/>When multiple fields are specified in the projection, a List of values will be returned. A single value will be returned otherwise.<p class="paragraph"/><h4>Using SQL Restrictions</h4><p class="paragraph"/>You can access Hibernate's SQL Restrictions capabilities.<p class="paragraph"/><div class="code"><pre>def c = Person.createCriteria()<p class="paragraph"/>def peopleWithShortFirstNames = c.list &#123;
    sqlRestriction <span class="java&#45;quote">"char_length(first_name) &#60;= 4"</span>
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
Note that the parameter there is SQL. The <code>first_name</code> attribute referenced in the example refers to the persistence model, not the object model like in HQL queries. The <code>Person</code> property named <code>firstName</code> is mapped to the <code>first_name</code> column in the database and you must refer to that in the <code>sqlRestriction</code> string.<p class="paragraph"/>Also note that the SQL used here is not necessarily portable across databases.
</blockquote><p class="paragraph"/><h4>Using Scrollable Results</h4><p class="paragraph"/>You can use Hibernate's <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/ScrollableResults.html" class="api">ScrollableResults</a> feature by calling the scroll method:<p class="paragraph"/><div class="code"><pre>def results = crit.scroll &#123;
    maxResults(10)
&#125;
def f = results.first()
def l = results.last()
def n = results.next()
def p = results.previous()<p class="paragraph"/>def <span class="java&#45;keyword">future</span> = results.scroll(10)
def accountNumber = results.getLong('number')</pre></div><p class="paragraph"/>To quote the documentation of Hibernate ScrollableResults:<p class="paragraph"/><blockquote class="quote">
A result iterator that allows moving around within the results by arbitrary increments. The Query / ScrollableResults pattern is very similar to the JDBC PreparedStatement/ ResultSet pattern and the semantics of methods of this interface are similar to the similarly named methods on ResultSet.
</blockquote><p class="paragraph"/>Contrary to JDBC, columns of results are numbered from zero.<p class="paragraph"/><h4>Setting properties in the Criteria instance</h4><p class="paragraph"/>If a node within the builder tree doesn't match a particular criterion it will attempt to set a property on the Criteria object itself. This allows full access to all the properties in this class. This example calls <code>setMaxResults</code> and <code>setFirstResult</code> on the <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/Criteria.html" class="api">Criteria</a> instance:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.hibernate.FetchMode as FM
&#8230;
def results = c.list &#123;
    maxResults(10)
    firstResult(50)
    fetchMode(<span class="java&#45;quote">"aRelationship"</span>, FM.JOIN)
&#125;</pre></div><p class="paragraph"/><h4>Querying with Eager Fetching</h4><p class="paragraph"/>In the section on <a href="../guide/single.html#fetching" class="guide">Eager and Lazy Fetching</a> we discussed how to declaratively specify fetching to avoid the N+1 SELECT problem. However, this can also be achieved using a criteria query:<p class="paragraph"/><div class="code"><pre>def criteria = Task.createCriteria()
def tasks = criteria.list&#123;
    eq <span class="java&#45;quote">"assignee.id"</span>, task.assignee.id
    join 'assignee'
    join 'project'
    order 'priority', 'asc'
&#125;</pre></div><p class="paragraph"/>Notice the usage of the <code>join</code> method: it tells the criteria API to use a <code>JOIN</code> to fetch the named associations with the <code>Task</code> instances. It's probably best not to use this for one-to-many associations though, because you will most likely end up with duplicate results. Instead, use the 'select' fetch mode:
<div class="code"><pre><span class="java&#45;keyword">import</span> org.hibernate.FetchMode as FM
&#8230;
def results = Airport.withCriteria &#123;
    eq <span class="java&#45;quote">"region"</span>, <span class="java&#45;quote">"EMEA"</span>
    fetchMode <span class="java&#45;quote">"flights"</span>, FM.SELECT
&#125;</pre></div>
Although this approach triggers a second query to get the <code>flights</code> association, you will get reliable results  - even with the <code>maxResults</code> option.<p class="paragraph"/><blockquote class="note">
<code>fetchMode</code> and <code>join</code> are general settings of the query and can only be specified at the top-level, i.e. you cannot use them inside projections or association constraints.
</blockquote><p class="paragraph"/>An important point to bear in mind is that if you include associations in the query constraints, those associations will automatically be eagerly loaded. For example, in this query:
<div class="code"><pre>def results = Airport.withCriteria &#123;
    eq <span class="java&#45;quote">"region"</span>, <span class="java&#45;quote">"EMEA"</span>
    flights &#123;
        like <span class="java&#45;quote">"number"</span>, <span class="java&#45;quote">"BA%"</span>
    &#125;
&#125;</pre></div>
the <code>flights</code> collection would be loaded eagerly via a join even though the fetch mode has not been explicitly set.<p class="paragraph"/><h4>Method Reference</h4><p class="paragraph"/>If you invoke the builder with no method name such as:<p class="paragraph"/><div class="code"><pre>c &#123; &#8230; &#125;</pre></div><p class="paragraph"/>The build defaults to listing all the results and hence the above is equivalent to:<p class="paragraph"/><div class="code"><pre>c.list &#123; &#8230; &#125;</pre></div><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">list</strong></td><td>This is the default method. It returns all matching rows.</td></tr><tr class="table-even"><td><strong class="bold">get</strong></td><td>Returns a unique result set, i.e. just one row. The criteria has to be formed that way, that it only queries one row. This method is not to be confused with a limit to just the first row.</td></tr><tr class="table-odd"><td><strong class="bold">scroll</strong></td><td>Returns a scrollable result set.</td></tr><tr class="table-even"><td><strong class="bold">listDistinct</strong></td><td>If subqueries or associations are used, one may end up with the same row multiple times in the result set, this allows listing only distinct entities and is equivalent to <code>DISTINCT_ROOT_ENTITY</code> of the <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/criterion/CriteriaSpecification.html" class="api">CriteriaSpecification</a> class.</td></tr><tr class="table-odd"><td><strong class="bold">count</strong></td><td>Returns the number of matching rows.</td></tr></table>



<h2 id="detachedCriteria">5.4.4 分离的条件查询(Detached Criteria)</h2>
Detached Criteria are criteria queries that are not associated with any given database session/connection. Supported since Grails 2.0, Detached Criteria queries have many uses including allowing you to create common reusable criteria queries, execute subqueries and execute batch updates/deletes.<p class="paragraph"/>
<h4>Building Detached Criteria Queries</h4><p class="paragraph"/>The primary point of entry for using the Detached Criteria is the <code>grails.gorm.DetachedCriteria</code> class which accepts a domain class as the only argument to its constructor:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.gorm.&#42;
&#8230;
def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person)</pre></div><p class="paragraph"/>Once you have obtained a reference to a detached criteria instance you can execute <a href="../guide/single.html#whereQueries" class="guide">where</a> queries or criteria queries to build up the appropriate query. To build a normal criteria query you can use the <code>build</code> method:<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;</pre></div><p class="paragraph"/>Note that methods on the <code>DetachedCriteria</code> instance <strong class="bold">do not</strong> mutate the original object but instead return a new query. In other words, you have to use the return value of the <code>build</code> method to obtain the mutated criteria object:<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
def bartQuery = criteria.build &#123;
    eq 'firstName', 'Bart'
&#125;</pre></div><p class="paragraph"/><h4>Executing Detached Criteria Queries</h4><p class="paragraph"/>Unlike regular criteria, Detached Criteria are lazy, in that no query is executed at the point of definition. Once a Detached Criteria query has been constructed then there are a number of useful query methods which are summarized in the table below:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">list</strong></td><td>List all matching entities</td></tr><tr class="table-even"><td><strong class="bold">get</strong></td><td>Return a single matching result</td></tr><tr class="table-odd"><td><strong class="bold">count</strong></td><td>Count all matching records</td></tr><tr class="table-even"><td><strong class="bold">exists</strong></td><td>Return true if any matching records exist</td></tr><tr class="table-odd"><td><strong class="bold">deleteAll</strong></td><td>Delete all matching records</td></tr><tr class="table-even"><td><strong class="bold">updateAll(Map)</strong></td><td>Update all matching records with the given properties</td></tr></table><p class="paragraph"/>As an example the following code will list the first 4 matching records sorted by the <code>firstName</code> property:<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
def results = criteria.list(max:4, sort:<span class="java&#45;quote">"firstName"</span>)</pre></div><p class="paragraph"/>You can also supply additional criteria to the list method:<p class="paragraph"/><div class="code"><pre>def results = criteria.list(max:4, sort:<span class="java&#45;quote">"firstName"</span>) &#123;
    gt 'age', 30
&#125;</pre></div><p class="paragraph"/>To retrieve a single result you can use the <code>get</code> or <code>find</code> methods (which are synonyms):<p class="paragraph"/><div class="code"><pre>Person p = criteria.find() // or criteria.get()</pre></div><p class="paragraph"/>The <code>DetachedCriteria</code> class itself also implements the <code>Iterable</code> interface which means that it can be treated like a list:<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
criteria.each &#123;
    println it.firstName
&#125;</pre></div><p class="paragraph"/>In this case the query is only executed when the <code>each</code> method is called. The same applies to all other Groovy collection iteration methods.<p class="paragraph"/>You can also execute dynamic finders on <code>DetachedCriteria</code> just like on domain classes. For example:<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
def bart = criteria.findByFirstName(<span class="java&#45;quote">"Bart"</span>)</pre></div><p class="paragraph"/><h4>Using Detached Criteria for Subqueries</h4><p class="paragraph"/>Within the context of a regular criteria query you can use <code>DetachedCriteria</code> to execute subquery. For example if you want to find all people who are older than the average age the following query will accomplish that:<p class="paragraph"/><div class="code"><pre>def results = Person.withCriteria &#123;
     gt <span class="java&#45;quote">"age"</span>, <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
         projections &#123;
             avg <span class="java&#45;quote">"age"</span>
         &#125;
     &#125;
     order <span class="java&#45;quote">"firstName"</span>
 &#125;</pre></div><p class="paragraph"/>Notice that in this case the subquery class is the same as the original criteria query class (ie. <code>Person</code>) and hence the query can be shortened to:<p class="paragraph"/><div class="code"><pre>def results = Person.withCriteria &#123;
     gt <span class="java&#45;quote">"age"</span>, &#123;
         projections &#123;
             avg <span class="java&#45;quote">"age"</span>
         &#125;
     &#125;
     order <span class="java&#45;quote">"firstName"</span>
 &#125;</pre></div><p class="paragraph"/>If the subquery class differs from the original criteria query then you will have to use the original syntax.<p class="paragraph"/>In the previous example the projection ensured that only a single result was returned (the average age). If your subquery returns multiple results then there are different criteria methods that need to be used to compare the result. For example to find all the people older than the ages 18 to 65 a <code>gtAll</code> query can be used:<p class="paragraph"/><div class="code"><pre>def results = Person.withCriteria &#123;
    gtAll <span class="java&#45;quote">"age"</span>, &#123;
        projections &#123;
            property <span class="java&#45;quote">"age"</span>
        &#125;
        between 'age', 18, 65
    &#125;<p class="paragraph"/>    order <span class="java&#45;quote">"firstName"</span>
&#125;</pre></div><p class="paragraph"/>The following table summarizes criteria methods for operating on subqueries that return multiple results:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Method</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">gtAll</strong></td><td>greater than all subquery results</td></tr><tr class="table-even"><td><strong class="bold">geAll</strong></td><td>greater than or equal to all subquery results</td></tr><tr class="table-odd"><td><strong class="bold">ltAll</strong></td><td>less than all subquery results</td></tr><tr class="table-even"><td><strong class="bold">leAll</strong></td><td>less than or equal to all subquery results</td></tr><tr class="table-odd"><td><strong class="bold">eqAll</strong></td><td>equal to all subquery results</td></tr><tr class="table-even"><td><strong class="bold">neAll</strong></td><td>not equal to all subquery results</td></tr></table><p class="paragraph"/><h4>Batch Operations with Detached Criteria</h4><p class="paragraph"/>The <code>DetachedCriteria</code> class can be used to execute batch operations such as batch updates and deletes. For example, the following query will update all people with the surname "Simpson" to have the surname "Bloggs":<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
<span class="java&#45;object">int</span> total = criteria.updateAll(lastName:<span class="java&#45;quote">"Bloggs"</span>)</pre></div><p class="paragraph"/><blockquote class="note">
Note that one limitation with regards to batch operations is that join queries (queries that query associations) are not allowed within the <code>DetachedCriteria</code> instance. 
</blockquote><p class="paragraph"/>To batch delete records you can use the <code>deleteAll</code> method:<p class="paragraph"/><div class="code"><pre>def criteria = <span class="java&#45;keyword">new</span> DetachedCriteria(Person).build &#123;
    eq 'lastName', 'Simpson'
&#125;
<span class="java&#45;object">int</span> total = criteria.deleteAll()</pre></div>


<a name="5.4.3 Hibernate Query Language (HQL)"><!-- Legacy link --></a>
<h2 id="hql">5.4.5 Hibernate 查询语言（HQL）</h2>
GORM classes also support Hibernate's query language HQL, a very complete reference for which can be found <a href="http://docs.jboss.org/hibernate/core/3.6/reference/en-US/html/queryhql.html" target="blank">in the Hibernate documentation</a> of the Hibernate documentation.<p class="paragraph"/>GORM provides a number of methods that work with HQL including <a href="../ref/Domain Classes/find.html" class="domainClasses">find</a>, <a href="../ref/Domain Classes/findAll.html" class="domainClasses">findAll</a> and <a href="../ref/Domain Classes/executeQuery.html" class="domainClasses">executeQuery</a>. An example of a query can be seen below:<p class="paragraph"/><div class="code"><pre>def results =
      Book.findAll(<span class="java&#45;quote">"from Book as b where b.title like 'Lord of the%'"</span>)</pre></div><p class="paragraph"/><h4>Positional and Named Parameters</h4><p class="paragraph"/>In this case the value passed to the query is hard coded, however you can equally use positional parameters:<p class="paragraph"/><div class="code"><pre>def results =
      Book.findAll(<span class="java&#45;quote">"from Book as b where b.title like ?"</span>, &#91;<span class="java&#45;quote">"The Shi%"</span>&#93;)</pre></div><p class="paragraph"/><div class="code"><pre>def author = Author.findByName(<span class="java&#45;quote">"Stephen King"</span>)
def books = Book.findAll(<span class="java&#45;quote">"from Book as book where book.author = ?"</span>,
                         &#91;author&#93;)</pre></div><p class="paragraph"/>Or even named parameters:<p class="paragraph"/><div class="code"><pre>def results =
      Book.findAll(<span class="java&#45;quote">"from Book as b "</span> +
                   <span class="java&#45;quote">"where b.title like :search or b.author like :search"</span>,
                   &#91;search: <span class="java&#45;quote">"The Shi%"</span>&#93;)</pre></div><p class="paragraph"/><div class="code"><pre>def author = Author.findByName(<span class="java&#45;quote">"Stephen King"</span>)
def books = Book.findAll(<span class="java&#45;quote">"from Book as book where book.author = :author"</span>,
                         &#91;author: author&#93;)</pre></div><p class="paragraph"/><h4>Multiline Queries</h4><p class="paragraph"/>Use the line continuation character to separate the query across multiple lines:<p class="paragraph"/><div class="code"><pre>def results = Book.findAll(<span class="java&#45;quote">"&#92;
from Book as b, &#92;
     Author as a &#92;
where b.author = a and a.surname = ?"</span>, &#91;'Smith'&#93;)</pre></div><p class="paragraph"/><blockquote class="note">
Triple-quoted Groovy multiline Strings will NOT work with HQL queries.
</blockquote><p class="paragraph"/><h4>Pagination and Sorting</h4><p class="paragraph"/>You can also perform pagination and sorting whilst using HQL queries. To do so simply specify the pagination options as a Map at the end of the method call and include an "ORDER BY" clause in the HQL:<p class="paragraph"/><div class="code"><pre>def results =
      Book.findAll(<span class="java&#45;quote">"from Book as b where "</span> +
                   <span class="java&#45;quote">"b.title like 'Lord of the%' "</span> +
                   <span class="java&#45;quote">"order by b.title asc"</span>,
                   &#91;max: 10, offset: 20&#93;)</pre></div>


<a name="5.5 Advanced GORM Features"><!-- Legacy link --></a>
<h2 id="advancedGORMFeatures">5.5 高级GORM特性</h2>
The following sections cover more advanced usages of GORM including caching, custom mapping and events.

<a name="5.5.1 Events and Auto Timestamping"><!-- Legacy link --></a>
<h2 id="eventsAutoTimestamping">5.5.1 事件和自动时间戳</h2>
GORM supports the registration of events as methods that get fired when certain events occurs such as deletes, inserts and updates. The following is a list of supported events:
<ul class="star">
<li><code>beforeInsert</code> - Executed before an object is initially persisted to the database</li>
<li><code>beforeUpdate</code> - Executed before an object is updated</li>
<li><code>beforeDelete</code> - Executed before an object is deleted</li>
<li><code>beforeValidate</code> - Executed before an object is validated</li>
<li><code>afterInsert</code> - Executed after an object is persisted to the database</li>
<li><code>afterUpdate</code> - Executed after an object has been updated</li>
<li><code>afterDelete</code> - Executed after an object has been deleted</li>
<li><code>onLoad</code> - Executed when an object is loaded from the database</li>
</ul><p class="paragraph"/>To add an event simply register the relevant closure with your domain class.<p class="paragraph"/><blockquote class="warning">
Do not attempt to flush the session within an event (such as with obj.save(flush:true)). Since events are fired during flushing this will cause a StackOverflowError.
</blockquote><p class="paragraph"/><h3>Event types</h3><p class="paragraph"/><h4>The beforeInsert event</h4><p class="paragraph"/>Fired before an object is saved to the database<p class="paragraph"/><div class="code"><pre>class Person &#123;
   Date dateCreated<p class="paragraph"/>   def beforeInsert() &#123;
       dateCreated = <span class="java&#45;keyword">new</span> Date()
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>The beforeUpdate event</h4><p class="paragraph"/>Fired before an existing object is updated<p class="paragraph"/><div class="code"><pre>class Person &#123;
   Date dateCreated
   Date lastUpdated<p class="paragraph"/>   def beforeInsert() &#123;
       dateCreated = <span class="java&#45;keyword">new</span> Date()
   &#125;
   def beforeUpdate() &#123;
       lastUpdated = <span class="java&#45;keyword">new</span> Date()
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>The beforeDelete event</h4><p class="paragraph"/>Fired before an object is deleted.<p class="paragraph"/><div class="code"><pre>class Person &#123;
   <span class="java&#45;object">String</span> name
   Date dateCreated
   Date lastUpdated<p class="paragraph"/>   def beforeDelete() &#123;
      ActivityTrace.withNewSession &#123;
         <span class="java&#45;keyword">new</span> ActivityTrace(eventName:<span class="java&#45;quote">"Person Deleted"</span>,data:name).save()
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>Notice the usage of <code>withNewSession</code> method above. Since events are triggered whilst Hibernate is flushing using persistence methods like <code>save()</code> and <code>delete()</code> won't result in objects being saved unless you run your operations with a new <code>Session</code>.<p class="paragraph"/>Fortunately the <code>withNewSession</code> method lets you share the same transactional JDBC connection even though you're using a different underlying <code>Session</code>.<p class="paragraph"/><h4>The beforeValidate event</h4><p class="paragraph"/>Fired before an object is validated.<p class="paragraph"/><div class="code"><pre>class Person &#123;
   <span class="java&#45;object">String</span> name<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
       name size: 5..45
   &#125;<p class="paragraph"/>   def beforeValidate() &#123;
       name = name?.trim()
   &#125;
&#125;</pre></div><p class="paragraph"/>The <code>beforeValidate</code> method is run before any validators are run.<p class="paragraph"/>GORM supports an overloaded version of <code>beforeValidate</code> which accepts a <code>List</code> parameter which may include
the names of the properties which are about to be validated.  This version of <code>beforeValidate</code> will be called
when the <code>validate</code> method has been invoked and passed a <code>List</code> of property names as an argument.<p class="paragraph"/><div class="code"><pre>class Person &#123;
   <span class="java&#45;object">String</span> name
   <span class="java&#45;object">String</span> town
   <span class="java&#45;object">Integer</span> age<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
       name size: 5..45
       age range: 4..99
   &#125;<p class="paragraph"/>   def beforeValidate(List propertiesBeingValidated) &#123;
      // <span class="java&#45;keyword">do</span> pre validation work based on propertiesBeingValidated
   &#125;
&#125;<p class="paragraph"/>def p = <span class="java&#45;keyword">new</span> Person(name: 'Jacob Brown', age: 10)
p.validate(&#91;'age', 'name'&#93;)</pre></div><p class="paragraph"/><blockquote class="note">
Note that when <code>validate</code> is triggered indirectly because of a call to the <code>save</code> method that
the <code>validate</code> method is being invoked with no arguments, not a <code>List</code> that includes all of
the property names.
</blockquote><p class="paragraph"/>Either or both versions of <code>beforeValidate</code> may be defined in a domain class.  GORM will
prefer the <code>List</code> version if a <code>List</code> is passed to <code>validate</code> but will fall back on the
no-arg version if the <code>List</code> version does not exist.  Likewise, GORM will prefer the
no-arg version if no arguments are passed to <code>validate</code> but will fall back on the
<code>List</code> version if the no-arg version does not exist.  In that case, <code>null</code> is passed to <code>beforeValidate</code>.<p class="paragraph"/><h4>The onLoad/beforeLoad event</h4><p class="paragraph"/>Fired immediately before an object is loaded from the database:<p class="paragraph"/><div class="code"><pre>class Person &#123;
   <span class="java&#45;object">String</span> name
   Date dateCreated
   Date lastUpdated<p class="paragraph"/>   def onLoad() &#123;
      log.debug <span class="java&#45;quote">"Loading $&#123;id&#125;"</span>
   &#125;
&#125;</pre></div><p class="paragraph"/><code>beforeLoad()</code> is effectively a synonym for <code>onLoad()</code>, so only declare one or the other.<p class="paragraph"/><h4>The afterLoad event</h4><p class="paragraph"/>Fired immediately after an object is loaded from the database:<p class="paragraph"/><div class="code"><pre>class Person &#123;
   <span class="java&#45;object">String</span> name
   Date dateCreated
   Date lastUpdated<p class="paragraph"/>   def afterLoad() &#123;
      name = <span class="java&#45;quote">"I'm loaded"</span>
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>Custom Event Listeners</h4><p class="paragraph"/>You can also register event handler classes in an application's <code>grails-app/conf/spring/resources.groovy</code> or in the <code>doWithSpring</code> closure in a plugin descriptor by registering a Spring bean named <code>hibernateEventListeners</code>. This bean has one property, <code>listenerMap</code> which specifies the listeners to register for various Hibernate events.<p class="paragraph"/>The values of the Map are instances of classes that implement one or more Hibernate listener interfaces. You can use one class that implements all of the required interfaces, or one concrete class per interface, or any combination. The valid Map keys and corresponding interfaces are listed here:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Name</strong></th><th><strong class="bold">Interface</strong></th></tr><tr class="table-odd"><td>auto-flush</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/AutoFlushEventListener.html" class="api">AutoFlushEventListener</a></td></tr><tr class="table-even"><td>merge</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/MergeEventListener.html" class="api">MergeEventListener</a></td></tr><tr class="table-odd"><td>create</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PersistEventListener.html" class="api">PersistEventListener</a></td></tr><tr class="table-even"><td>create-onflush</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PersistEventListener.html" class="api">PersistEventListener</a></td></tr><tr class="table-odd"><td>delete</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/DeleteEventListener.html" class="api">DeleteEventListener</a></td></tr><tr class="table-even"><td>dirty-check</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/DirtyCheckEventListener.html" class="api">DirtyCheckEventListener</a></td></tr><tr class="table-odd"><td>evict</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/EvictEventListener.html" class="api">EvictEventListener</a></td></tr><tr class="table-even"><td>flush</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/FlushEventListener.html" class="api">FlushEventListener</a></td></tr><tr class="table-odd"><td>flush-entity</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/FlushEntityEventListener.html" class="api">FlushEntityEventListener</a></td></tr><tr class="table-even"><td>load</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/LoadEventListener.html" class="api">LoadEventListener</a></td></tr><tr class="table-odd"><td>load-collection</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/InitializeCollectionEventListener.html" class="api">InitializeCollectionEventListener</a></td></tr><tr class="table-even"><td>lock</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/LockEventListener.html" class="api">LockEventListener</a></td></tr><tr class="table-odd"><td>refresh</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/RefreshEventListener.html" class="api">RefreshEventListener</a></td></tr><tr class="table-even"><td>replicate</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/ReplicateEventListener.html" class="api">ReplicateEventListener</a></td></tr><tr class="table-odd"><td>save-update</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/SaveOrUpdateEventListener.html" class="api">SaveOrUpdateEventListener</a></td></tr><tr class="table-even"><td>save</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/SaveOrUpdateEventListener.html" class="api">SaveOrUpdateEventListener</a></td></tr><tr class="table-odd"><td>update</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/SaveOrUpdateEventListener.html" class="api">SaveOrUpdateEventListener</a></td></tr><tr class="table-even"><td>pre-load</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PreLoadEventListener.html" class="api">PreLoadEventListener</a></td></tr><tr class="table-odd"><td>pre-update</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PreUpdateEventListener.html" class="api">PreUpdateEventListener</a></td></tr><tr class="table-even"><td>pre-delete</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PreDeleteEventListener.html" class="api">PreDeleteEventListener</a></td></tr><tr class="table-odd"><td>pre-insert</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PreInsertEventListener.html" class="api">PreInsertEventListener</a></td></tr><tr class="table-even"><td>pre-collection-recreate</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PreCollectionRecreateEventListener.html" class="api">PreCollectionRecreateEventListener</a></td></tr><tr class="table-odd"><td>pre-collection-remove</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PreCollectionRemoveEventListener.html" class="api">PreCollectionRemoveEventListener</a></td></tr><tr class="table-even"><td>pre-collection-update</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PreCollectionUpdateEventListener.html" class="api">PreCollectionUpdateEventListener</a></td></tr><tr class="table-odd"><td>post-load</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostLoadEventListener.html" class="api">PostLoadEventListener</a></td></tr><tr class="table-even"><td>post-update</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostUpdateEventListener.html" class="api">PostUpdateEventListener</a></td></tr><tr class="table-odd"><td>post-delete</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostDeleteEventListener.html" class="api">PostDeleteEventListener</a></td></tr><tr class="table-even"><td>post-insert</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostInsertEventListener.html" class="api">PostInsertEventListener</a></td></tr><tr class="table-odd"><td>post-commit-update</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostUpdateEventListener.html" class="api">PostUpdateEventListener</a></td></tr><tr class="table-even"><td>post-commit-delete</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostDeleteEventListener.html" class="api">PostDeleteEventListener</a></td></tr><tr class="table-odd"><td>post-commit-insert</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostInsertEventListener.html" class="api">PostInsertEventListener</a></td></tr><tr class="table-even"><td>post-collection-recreate</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostCollectionRecreateEventListener.html" class="api">PostCollectionRecreateEventListener</a></td></tr><tr class="table-odd"><td>post-collection-remove</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostCollectionRemoveEventListener.html" class="api">PostCollectionRemoveEventListener</a></td></tr><tr class="table-even"><td>post-collection-update</td><td><a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/event/PostCollectionUpdateEventListener.html" class="api">PostCollectionUpdateEventListener</a></td></tr></table><p class="paragraph"/>For example, you could register a class <code>AuditEventListener</code> which implements <code>PostInsertEventListener</code>, <code>PostUpdateEventListener</code>, and <code>PostDeleteEventListener</code> using the following in an application:<p class="paragraph"/><div class="code"><pre>beans = &#123;<p class="paragraph"/>   auditListener(AuditEventListener)<p class="paragraph"/>   hibernateEventListeners(HibernateEventListeners) &#123;
      listenerMap = &#91;'post&#45;insert': auditListener,
                     'post&#45;update': auditListener,
                     'post&#45;delete': auditListener&#93;
   &#125;
&#125;</pre></div><p class="paragraph"/>or use this in a plugin:<p class="paragraph"/><div class="code"><pre>def doWithSpring = &#123;<p class="paragraph"/>   auditListener(AuditEventListener)<p class="paragraph"/>   hibernateEventListeners(HibernateEventListeners) &#123;
      listenerMap = &#91;'post&#45;insert': auditListener,
                     'post&#45;update': auditListener,
                     'post&#45;delete': auditListener&#93;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>Automatic timestamping</h4><p class="paragraph"/>The examples above demonstrated using events to update a <code>lastUpdated</code> and <code>dateCreated</code> property to keep track of updates to objects. However, this is actually not necessary. By defining a <code>lastUpdated</code> and <code>dateCreated</code> property these will be automatically updated for you by GORM.<p class="paragraph"/>If this is not the behaviour you want you can disable this feature with:<p class="paragraph"/><div class="code"><pre>class Person &#123;
   Date dateCreated
   Date lastUpdated
   <span class="java&#45;keyword">static</span> mapping = &#123;
      autoTimestamp <span class="java&#45;keyword">false</span>
   &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
If you put <code>nullable: false</code> constraints on either <code>dateCreated</code> or <code>lastUpdated</code>, your domain instances will fail validation - probably not what you want. Leave constraints off these properties unless you have disabled automatic timestamping.
</blockquote>


<a name="5.5.2 Custom ORM Mapping"><!-- Legacy link --></a>
<h2 id="ormdsl">5.5.2 自定义ORM映射</h2>
Grails domain classes can be mapped onto many legacy schemas with an Object Relational Mapping DSL (domain specific language). The following sections takes you through what is possible with the ORM DSL.<p class="paragraph"/><blockquote class="note">
None of this is necessary if you are happy to stick to the conventions defined by GORM for table names, column names and so on. You only needs this functionality if you need to tailor the way GORM maps onto legacy schemas or configures caching
</blockquote><p class="paragraph"/>Custom mappings are defined using a  a static <code>mapping</code> block defined within your domain class:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;<p class="paragraph"/>    &#125;
&#125;</pre></div>


<a name="5.5.2.1 Table and Column Names"><!-- Legacy link --></a>
<h2 id="tableAndColumnNames">5.5.2.1 表名和列名</h2>
<h4>Table names</h4><p class="paragraph"/>The database table name which the class maps to can be customized using the <code>table</code> method:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case the class would be mapped to a table called <code>people</code> instead of the default name of <code>person</code>.<p class="paragraph"/><h4>Column names</h4><p class="paragraph"/>It is also possible to customize the mapping for individual columns onto the database. For example to change the name you can do:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        firstName column: 'First_Name'
    &#125;
&#125;</pre></div><p class="paragraph"/>Here <code>firstName</code> is a dynamic method within the <code>mapping</code> Closure that has a single Map parameter. Since its name corresponds to a domain class persistent field, the parameter values (in this case just <code>"column"</code>) are used to configure the mapping for that property.<p class="paragraph"/><h4>Column type</h4><p class="paragraph"/>GORM supports configuration of Hibernate types with the DSL using the type attribute. This includes specifing user types that implement the Hibernate <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/usertype/UserType.html" class="api">org.hibernate.usertype.UserType</a> interface, which allows complete customization of how a type is persisted. As an example if you had a <code>PostCodeType</code> you could use it as follows:<p class="paragraph"/><div class="code"><pre>class Address &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> number
    <span class="java&#45;object">String</span> postCode<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        postCode type: PostCodeType
    &#125;
&#125;</pre></div><p class="paragraph"/>Alternatively if you just wanted to map it to one of Hibernate's basic types other than the default chosen by Grails you could use:<p class="paragraph"/><div class="code"><pre>class Address &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> number
    <span class="java&#45;object">String</span> postCode<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        postCode type: 'text'
    &#125;
&#125;</pre></div><p class="paragraph"/>This would make the <code>postCode</code> column map to the default large-text type for the database you're using (for example TEXT or CLOB).<p class="paragraph"/>See the Hibernate documentation regarding <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/mapping.html#mapping-types-basictypes" target="blank">Basic Types</a> for further information.<p class="paragraph"/><h4>Many-to-One/One-to-One Mappings</h4><p class="paragraph"/>In the case of associations it is also possible to configure the foreign keys used to map associations. In the case of a many-to-one or one-to-one association this is exactly the same as any regular column. For example consider the following:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName
    Address address<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        firstName column: 'First_Name'
        address column: 'Person_Address_Id'
    &#125;
&#125;</pre></div><p class="paragraph"/>By default the <code>address</code> association would map to a foreign key column called <code>address_id</code>. By using the above mapping we have changed the name of the foreign key column to <code>Person_Adress_Id</code>.<p class="paragraph"/><h4>One-to-Many Mapping</h4><p class="paragraph"/>With a bidirectional one-to-many you can change the foreign key column used by changing the column name on the many side of the association as per the example in the previous section on one-to-one associations. However, with unidirectional associations the foreign key needs to be specified on the association itself. For example given a unidirectional one-to-many relationship between <code>Person</code> and <code>Address</code> the following code will change the foreign key in the <code>address</code> table:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;addresses: Address&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        firstName column: 'First_Name'
        addresses column: 'Person_Address_Id'
    &#125;
&#125;</pre></div><p class="paragraph"/>If you don't want the column to be in the <code>address</code> table, but instead some intermediate join table you can use the <code>joinTable</code> parameter:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;addresses: Address&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        firstName column: 'First_Name'
        addresses joinTable: &#91;name: 'Person_Addresses',
                              key: 'Person_Id',
                              column: 'Address_Id'&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Many-to-Many Mapping</h4><p class="paragraph"/>Grails, by default maps a many-to-many association using a join table. For example consider this many-to-many association:<p class="paragraph"/><div class="code"><pre>class Group &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> hasMany = &#91;people: Person&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> belongsTo = Group
    <span class="java&#45;keyword">static</span> hasMany = &#91;groups: Group&#93;
&#125;</pre></div><p class="paragraph"/>In this case Grails will create a join table called <code>group_person</code> containing foreign keys called <code>person_id</code> and <code>group_id</code> referencing the <code>person</code> and <code>group</code> tables. To change the column names you can specify a column within the mappings for each class.<p class="paragraph"/><div class="code"><pre>class Group &#123;
   &#8230;
   <span class="java&#45;keyword">static</span> mapping = &#123;
       people column: 'Group_Person_Id'
   &#125;
&#125;
class Person &#123;
   &#8230;
   <span class="java&#45;keyword">static</span> mapping = &#123;
       groups column: 'Group_Group_Id'
   &#125;
&#125;</pre></div><p class="paragraph"/>You can also specify the name of the join table to use:<p class="paragraph"/><div class="code"><pre>class Group &#123;
   &#8230;
   <span class="java&#45;keyword">static</span> mapping = &#123;
       people column: 'Group_Person_Id',
              joinTable: 'PERSON_GROUP_ASSOCIATIONS'
   &#125;
&#125;
class Person &#123;
   &#8230;
   <span class="java&#45;keyword">static</span> mapping = &#123;
       groups column: 'Group_Group_Id',
              joinTable: 'PERSON_GROUP_ASSOCIATIONS'
   &#125;
&#125;</pre></div>


<a name="5.5.2.2 Caching Strategy"><!-- Legacy link --></a>
<h2 id="caching">5.5.2.2 缓存策略</h2>
<h4>Setting up caching</h4><p class="paragraph"/><a href="http://www.hibernate.org/" target="blank">Hibernate</a> features a second-level cache with a customizable cache provider. This needs to be configured in the <code>grails-app/conf/DataSource.groovy</code> file as follows:<p class="paragraph"/><div class="code"><pre>hibernate &#123;
    cache.use_second_level_cache=<span class="java&#45;keyword">true</span>
    cache.use_query_cache=<span class="java&#45;keyword">true</span>
    cache.provider_class='org.hibernate.cache.EhCacheProvider'
&#125;</pre></div><p class="paragraph"/>You can customize any of these settings, for example to use a distributed caching mechanism.<p class="paragraph"/><blockquote class="note">
For further reading on caching and in particular Hibernate's second-level cache, refer to the <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/performance.html#performance-cache" target="blank">Hibernate documentation</a> on the subject.
</blockquote><p class="paragraph"/><h4>Caching instances</h4><p class="paragraph"/>Call the <code>cache</code> method in your mapping block to enable caching with the default settings:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        cache <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>This will configure a 'read-write' cache that includes both lazy and non-lazy properties. You can customize this further:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        cache usage: 'read&#45;only', include: 'non&#45;lazy'
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Caching associations</h4><p class="paragraph"/>As well as the ability to use Hibernate's second level cache to cache instances you can also cache collections (associations) of objects. For example:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;addresses: Address&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        version <span class="java&#45;keyword">false</span>
        addresses column: 'Address', cache: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Address &#123;
    <span class="java&#45;object">String</span> number
    <span class="java&#45;object">String</span> postCode
&#125;</pre></div><p class="paragraph"/>This will enable a 'read-write' caching mechanism on the <code>addresses</code> collection. You can also use:<p class="paragraph"/><div class="code"><pre>cache: 'read&#45;write' // or 'read&#45;only' or 'transactional'</pre></div><p class="paragraph"/>to further configure the cache usage.<p class="paragraph"/><h4>Caching Queries</h4><p class="paragraph"/>You can cache queries such as dynamic finders and criteria. To do so using a dynamic finder you can pass the <code>cache</code> argument:<p class="paragraph"/><div class="code"><pre>def person = Person.findByFirstName(<span class="java&#45;quote">"Fred"</span>, &#91;cache: <span class="java&#45;keyword">true</span>&#93;)</pre></div><p class="paragraph"/><blockquote class="note">
In order for the results of the query to be cached, you must enable caching in your mapping as discussed in the previous section.
</blockquote><p class="paragraph"/>You can also cache criteria queries:<p class="paragraph"/><div class="code"><pre>def people = Person.withCriteria &#123;
    like('firstName', 'Fr%')
    cache <span class="java&#45;keyword">true</span>
&#125;</pre></div><p class="paragraph"/><h4>Cache usages</h4><p class="paragraph"/>Below is a description of the different cache settings and their usages:
<ul class="star">
<li><code>read-only</code> - If your application needs to read but never modify instances of a persistent class, a read-only cache may be used.</li>
<li><code>read-write</code> - If the application needs to update data, a read-write cache might be appropriate.</li>
<li><code>nonstrict-read-write</code> - If the application only occasionally needs to update data (ie. if it is very unlikely that two transactions would try to update the same item simultaneously) and strict transaction isolation is not required, a <code>nonstrict-read-write</code> cache might be appropriate.</li>
<li><code>transactional</code> - The <code>transactional</code> cache strategy provides support for fully transactional cache providers such as JBoss TreeCache. Such a cache may only be used in a JTA environment and you must specify <code>hibernate.transaction.manager_lookup_class</code> in the <code>grails-app/conf/DataSource.groovy</code> file's <code>hibernate</code> config.</li>
</ul><p class="paragraph"/>

<a name="5.5.2.3 Inheritance Strategies"><!-- Legacy link --></a>
<h2 id="inheritanceStrategies">5.5.2.3 继承策略</h2>
By default GORM classes use <code>table-per-hierarchy</code> inheritance mapping. This has the disadvantage that columns cannot have a <code>NOT-NULL</code> constraint applied to them at the database level. If you would prefer to use a <code>table-per-subclass</code> inheritance strategy you can do so as follows:<p class="paragraph"/><div class="code"><pre>class Payment &#123;
    <span class="java&#45;object">Integer</span> amount<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        tablePerHierarchy <span class="java&#45;keyword">false</span>
    &#125;
&#125;<p class="paragraph"/>class CreditCardPayment <span class="java&#45;keyword">extends</span> Payment &#123;
    <span class="java&#45;object">String</span> cardNumber
&#125;</pre></div><p class="paragraph"/>The mapping of the root <code>Payment</code> class specifies that it will not be using <code>table-per-hierarchy</code> mapping for all child classes.

<a name="5.5.2.4 Custom Database Identity"><!-- Legacy link --></a>
<h2 id="identity">5.5.2.4 数据库标识符</h2>
You can customize how GORM generates identifiers for the database using the DSL. By default GORM relies on the native database mechanism for generating ids. This is by far the best approach, but there are still many schemas that have different approaches to identity.<p class="paragraph"/>To deal with this Hibernate defines the concept of an id generator. You can customize the id generator and the column it maps to as follows:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        version <span class="java&#45;keyword">false</span>
        id generator: 'hilo',
           params: &#91;table: 'hi_value',
                    column: 'next_value',
                    max_lo: 100&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case we're using one of Hibernate's built in 'hilo' generators that uses a separate table to generate ids.<p class="paragraph"/><blockquote class="note">
For more information on the different Hibernate generators refer to the <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/mapping.html#mapping-declaration-id-generator" target="blank">Hibernate reference documentation</a>
</blockquote><p class="paragraph"/>Although you don't typically specify the <code>id</code> field (Grails adds it for you) you can still configure its mapping like the other properties. For example to customise the column for the id property you can do:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        version <span class="java&#45;keyword">false</span>
        id column: 'person_id'
    &#125;
&#125;</pre></div>


<a name="5.5.2.5 Composite Primary Keys"><!-- Legacy link --></a>
<h2 id="compositePrimaryKeys">5.5.2.5 复合主键</h2>
GORM supports the concept of composite identifiers (identifiers composed from 2 or more properties). It is not an approach we recommend, but is available to you if you need it:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.commons.lang.builder.HashCodeBuilder<p class="paragraph"/>class Person <span class="java&#45;keyword">implements</span> Serializable &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> lastName<p class="paragraph"/>    <span class="java&#45;object">boolean</span> equals(other) &#123;
        <span class="java&#45;keyword">if</span> (!(other <span class="java&#45;keyword">instanceof</span> Person)) &#123;
            <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
        &#125;<p class="paragraph"/>        other.firstName == firstName &#38;&#38; other.lastName == lastName
    &#125;<p class="paragraph"/>    <span class="java&#45;object">int</span> hashCode() &#123;
        def builder = <span class="java&#45;keyword">new</span> HashCodeBuilder()
        builder.append firstName
        builder.append lastName
        builder.toHashCode()
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        id composite: &#91;'firstName', 'lastName'&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>The above will create a composite id of the <code>firstName</code> and <code>lastName</code> properties of the Person class. To retrieve an instance by id you use a prototype of the object itself:<p class="paragraph"/><div class="code"><pre>def p = Person.get(<span class="java&#45;keyword">new</span> Person(firstName: <span class="java&#45;quote">"Fred"</span>, lastName: <span class="java&#45;quote">"Flintstone"</span>))
println p.firstName</pre></div><p class="paragraph"/>Domain classes mapped with composite primary keys must implement the <code>Serializable</code> interface and override the <code>equals</code> and <code>hashCode</code> methods, using the properties in the composite key for the calculations. The example above uses a <code>HashCodeBuilder</code> for convenience but it's fine to implement it yourself.<p class="paragraph"/>Another important consideration when using composite primary keys is associations. If for example you have a many-to-one association where the foreign keys are stored in the associated table then 2 columns will be present in the associated table.<p class="paragraph"/>For example consider the following domain class:<p class="paragraph"/><div class="code"><pre>class Address &#123;
    Person person
&#125;</pre></div><p class="paragraph"/>In this case the <code>address</code> table will have an additional two columns called <code>person_first_name</code> and <code>person_last_name</code>. If you wish the change the mapping of these columns then you can do so using the following technique:<p class="paragraph"/><div class="code"><pre>class Address &#123;
    Person person
    <span class="java&#45;keyword">static</span> mapping = &#123;
        person &#123;
            column: <span class="java&#45;quote">"FirstName"</span>
            column: <span class="java&#45;quote">"LastName"</span>
        &#125;
    &#125;
&#125;</pre></div>


<a name="5.5.2.6 Database Indices"><!-- Legacy link --></a>
<h2 id="databaseIndices">5.5.2.6 数据库索引</h2>
To get the best performance out of your queries it is often necessary to tailor the table index definitions. How you tailor them is domain specific and a matter of monitoring usage patterns of your queries. With GORM's DSL you can specify which columns are used in which indexes:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> address
    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        version <span class="java&#45;keyword">false</span>
        id column: 'person_id'
        firstName column: 'First_Name', index: 'Name_Idx'
        address column: 'Address', index: 'Name_Idx,Address_Index'
    &#125;
&#125;</pre></div><p class="paragraph"/>Note that you cannot have any spaces in the value of the <code>index</code> attribute; in this example <code>index:'Name_Idx, Address_Index'</code> will cause an error.


<a name="5.5.2.7 Optimistic Locking and Versioning"><!-- Legacy link --></a>
<h2 id="optimisticLockingAndVersioning">5.5.2.7 乐观锁和版本定义</h2>
As discussed in the section on <a href="../guide/single.html#locking" class="guide">Optimistic and Pessimistic Locking</a>, by default GORM uses optimistic locking and automatically injects a <code>version</code> property into every class which is in turn mapped to a <code>version</code> column at the database level.<p class="paragraph"/>If you're mapping to a legacy schema that doesn't have version columns (or there's some other reason why you don't want/need this feature) you can disable this with the <code>version</code> method:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
        version <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
If you disable optimistic locking you are essentially on your own with regards to concurrent updates and are open to the risk of users losing data (due to data overriding) unless you use <a href="../guide/single.html#locking" class="guide">pessimistic locking</a>
</blockquote><p class="paragraph"/><h4>Version columns types</h4><p class="paragraph"/>By default Grails maps the <code>version</code> property as a <code>Long</code> that gets incremented by one each time an instance is updated. But Hibernate also supports using a <code>Timestamp</code>, for example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> java.sql.Timestamp<p class="paragraph"/>class Person &#123;<p class="paragraph"/>    &#8230;
    Timestamp version<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        table 'people'
    &#125;
&#125;</pre></div><p class="paragraph"/>There's a slight risk that two updates occurring at nearly the same time on a fast server can end up with the same timestamp value but this risk is very low. One benefit of using a <code>Timestamp</code> instead of a <code>Long</code> is that you combine the optimistic locking and last-updated semantics into a single column.


<a name="5.5.2.8 Eager and Lazy Fetching"><!-- Legacy link --></a>
<h2 id="fetchingDSL">5.5.2.8 立即加载和延迟加载</h2>
<h4>Lazy Collections</h4><p class="paragraph"/>As discussed in the section on <a href="../guide/single.html#fetching" class="guide">Eager and Lazy fetching</a>, GORM collections are lazily loaded by default but you can change this behaviour with the ORM DSL. There are several options available to you, but the most common ones are:
<ul class="star">
<li>lazy: false</li>
<li>fetch: 'join'</li>
</ul><p class="paragraph"/>and they're used like this:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName
    Pet pet<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;addresses: Address&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        addresses lazy: <span class="java&#45;keyword">false</span>
        pet fetch: 'join'
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Address &#123;
    <span class="java&#45;object">String</span> street
    <span class="java&#45;object">String</span> postCode
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Pet &#123;
    <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/>The first option, <code>lazy: false</code> , ensures that when a <code>Person</code> instance is loaded, its <code>addresses</code> collection is loaded at the same time with a second SELECT. The second option is basically the same, except the collection is loaded with a JOIN rather than another SELECT. Typically you want to reduce the number of queries, so <code>fetch: 'join'</code> is the more appropriate option. On the other hand, it could feasibly be the more expensive approach if your domain model and data result in more and larger results than would otherwise be necessary.<p class="paragraph"/>For more advanced users, the other settings available are:
<ol>
<li>batchSize: N</li>
<li>lazy: false, batchSize: N</li>
</ol><p class="paragraph"/>where N is an integer. These let you fetch results in batches, with one query per batch. As a simple example, consider this mapping for <code>Person</code>:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName
    Pet pet<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        pet batchSize: 5
    &#125;
&#125;</pre></div>
If a query returns multiple <code>Person</code> instances, then when we access the first <code>pet</code> property, Hibernate will fetch that <code>Pet</code> plus the four next ones. You can get the same behaviour with eager loading by combining <code>batchSize</code> with the <code>lazy: false</code> option. You can find out more about these options in the <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/performance.html#performance-fetching" target="blank">Hibernate user guide</a> and this <a href="http://community.jboss.org/wiki/AShortPrimerOnFetchingStrategies" target="blank">primer on fetching strategies</a>. Note that ORM DSL does not currently support the "subselect" fetching strategy.<p class="paragraph"/><h4>Lazy Single-Ended Associations</h4><p class="paragraph"/>In GORM, one-to-one and many-to-one associations are by default lazy. Non-lazy single ended associations can be problematic when you load many entities because each non-lazy association will result in an extra SELECT statement. If the associated entities also have non-lazy associations, the number of queries grows significantly!<p class="paragraph"/>Use the same technique as for lazy collections to make a one-to-one or many-to-one association non-lazy/eager:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> firstName
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Address &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> street
    <span class="java&#45;object">String</span> postCode<p class="paragraph"/>    <span class="java&#45;keyword">static</span> belongsTo = &#91;person: Person&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        person lazy: <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Here we configure GORM to load the associated <code>Person</code> instance (through the <code>person</code> property) whenever an <code>Address</code> is loaded.<p class="paragraph"/><h4>Lazy Single-Ended Associations and Proxies</h4><p class="paragraph"/>Hibernate uses runtime-generated proxies to facilitate single-ended lazy associations; Hibernate dynamically subclasses the entity class to create the proxy.<p class="paragraph"/>Consider the previous example but with a lazily-loaded <code>person</code> association: Hibernate will set the <code>person</code> property to a proxy that is a subclass of <code>Person</code>. When you call any of the getters (except for the <code>id</code> property) or setters on that proxy, Hibernate will load the entity from the database.<p class="paragraph"/>Unfortunately this technique can produce surprising results. Consider the following example classes:<p class="paragraph"/><div class="code"><pre>class Pet &#123;
    <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Dog <span class="java&#45;keyword">extends</span> Pet &#123;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> name
    Pet pet
&#125;</pre></div><p class="paragraph"/>and assume that we have a single <code>Person</code> instance with a <code>Dog</code> as the <code>pet</code>. The following code will work as you would expect:
<div class="code"><pre>def person = Person.get(1)
assert person.pet <span class="java&#45;keyword">instanceof</span> Dog
assert Pet.get(person.petId) <span class="java&#45;keyword">instanceof</span> Dog</pre></div><p class="paragraph"/>But this won't:<p class="paragraph"/><div class="code"><pre>def person = Person.get(1)
assert person.pet <span class="java&#45;keyword">instanceof</span> Dog
assert Pet.list()&#91;0&#93; <span class="java&#45;keyword">instanceof</span> Dog</pre></div><p class="paragraph"/>The second assertion fails, and to add to the confusion, this will work:<p class="paragraph"/><div class="code"><pre>assert Pet.list()&#91;0&#93; <span class="java&#45;keyword">instanceof</span> Dog</pre></div><p class="paragraph"/>What's going on here? It's down to a combination of how proxies work and the guarantees that the Hibernate session makes. When you load the <code>Person</code> instance, Hibernate creates a proxy for its <code>pet</code> relation and attaches it to the session. Once that happens, whenever you retrieve that <code>Pet</code> instance with a query, a <code>get()</code>, or the <code>pet</code> relation  <em class="italic">within the same session</em>  , Hibernate gives you the proxy.<p class="paragraph"/>Fortunately for us, GORM automatically unwraps the proxy when you use <code>get()</code> and <code>findBy&#42;()</code>, or when you directly access the relation. That means you don't have to worry at all about proxies in the majority of cases. But GORM doesn't do that for objects returned with a query that returns a list, such as <code>list()</code> and <code>findAllBy&#42;()</code>. However, if Hibernate hasn't attached the proxy to the session, those queries will return the real instances - hence why the last example works.<p class="paragraph"/>You can protect yourself to a degree from this problem by using the <code>instanceOf</code> method by GORM:<p class="paragraph"/><div class="code"><pre>def person = Person.get(1)
assert Pet.list()&#91;0&#93;.instanceOf(Dog)</pre></div><p class="paragraph"/>However, it won't help here if casting is involved. For example, the following code will throw a <code>ClassCastException</code> because the first pet in the list is a proxy instance with a class that is neither <code>Dog</code> nor a sub-class of <code>Dog</code>:<p class="paragraph"/><div class="code"><pre>def person = Person.get(1)
Dog pet = Pet.list()&#91;0&#93;</pre></div><p class="paragraph"/>Of course, it's best not to use static types in this situation. If you use an untyped variable for the pet instead, you can access any <code>Dog</code> properties or methods on the instance without any problems.<p class="paragraph"/>These days it's rare that you will come across this issue, but it's best to be aware of it just in case. At least you will know why such an error occurs and be able to work around it.


<a name="5.5.2.9 Custom Cascade Behaviour"><!-- Legacy link --></a>
<h2 id="customCascadeBehaviour">5.5.2.9 自定义级联行为</h2>
As described in the section on <a href="../guide/single.html#cascades" class="guide">cascading updates</a>, the primary mechanism to control the way updates and deletes cascade from one association to another is the static <a href="../ref/Domain Classes/belongsTo.html" class="domainClasses">belongsTo</a> property.<p class="paragraph"/>However, the ORM DSL gives you complete access to Hibernate's <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/objectstate.html#objectstate-transitive" target="blank">transitive persistence</a> capabilities using the <code>cascade</code> attribute.<p class="paragraph"/>Valid settings for the cascade attribute include:
<ul class="star">
<li><code>merge</code> - merges the state of a detached association</li>
<li><code>save-update</code> - cascades only saves and updates to an association</li>
<li><code>delete</code> - cascades only deletes to an association</li>
<li><code>lock</code> - useful if a pessimistic lock should be cascaded to its associations</li>
<li><code>refresh</code> - cascades refreshes to an association</li>
<li><code>evict</code> - cascades evictions (equivalent to <code>discard()</code> in GORM) to associations if set</li>
<li><code>all</code> - cascade  <em class="italic">all</em>  operations to associations</li>
<li><code>all-delete-orphan</code> - Applies only to one-to-many associations and indicates that when a child is removed from an association then it should be automatically deleted. Children are also deleted when the parent is.</li>
</ul><p class="paragraph"/><blockquote class="note">
It is advisable to read the section in the Hibernate documentation on <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/objectstate.html#objectstate-transitive" target="blank">transitive persistence</a> to obtain a better understanding of the different cascade styles and recommendations for their usage
</blockquote><p class="paragraph"/>To specify the cascade attribute simply define one or more (comma-separated) of the aforementioned settings as its value:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> firstName<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;addresses: Address&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        addresses cascade: <span class="java&#45;quote">"all&#45;delete&#45;orphan"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Address &#123;
    <span class="java&#45;object">String</span> street
    <span class="java&#45;object">String</span> postCode
&#125;</pre></div>


<a name="5.5.2.10 Custom Hibernate Types"><!-- Legacy link --></a>
<h2 id="customHibernateTypes">5.5.2.10 自定义Hibernate的类型</h2>
You saw in an earlier section that you can use composition (with the <code>embedded</code> property) to break a table into multiple objects. You can achieve a similar effect with Hibernate's custom user types. These are not domain classes themselves, but plain Java or Groovy classes. Each of these types also has a corresponding "meta-type" class that implements <a href="http://docs.jboss.org/hibernate/core/3.6/javadocs/org/hibernate/usertype/UserType.html" class="api">org.hibernate.usertype.UserType</a>.<p class="paragraph"/>The <a href="http://docs.jboss.org/hibernate/stable/core/reference/en-US/html/mapping.html#mapping-types-custom" target="blank">Hibernate reference manual</a> has some information on custom types, but here we will focus on how to map them in Grails. Let's start by taking a look at a simple domain class that uses an old-fashioned (pre-Java 1.5) type-safe enum class:<p class="paragraph"/><div class="code"><pre>class Book &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title
    <span class="java&#45;object">String</span> author
    Rating rating<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        rating type: RatingUserType
    &#125;
&#125;</pre></div><p class="paragraph"/>All we have done is declare the <code>rating</code> field the enum type and set the property's type in the custom mapping to the corresponding <code>UserType</code> implementation. That's all you have to do to start using your custom type. If you want, you can also use the other column settings such as "column" to change the column name and "index" to add it to an index.<p class="paragraph"/>Custom types aren't limited to just a single column - they can be mapped to as many columns as you want. In such cases you explicitly define in the mapping what columns to use, since Hibernate can only use the property name for a single column. Fortunately, Grails lets you map multiple columns to a property using this syntax:<p class="paragraph"/><div class="code"><pre>class Book &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title
    Name author
    Rating rating<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        name type: NameUserType, &#123;
            column name: <span class="java&#45;quote">"first_name"</span>
            column name: <span class="java&#45;quote">"last_name"</span>
        &#125;
        rating type: RatingUserType
    &#125;
&#125;</pre></div><p class="paragraph"/>The above example will create "first_name" and "last_name" columns for the <code>author</code> property. You'll be pleased to know that you can also use some of the normal column/property mapping attributes in the column definitions. For example:<p class="paragraph"/><div class="code"><pre>column name: <span class="java&#45;quote">"first_name"</span>, index: <span class="java&#45;quote">"my_idx"</span>, unique: <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>The column definitions do  <em class="italic">not</em>  support the following attributes: <code>type</code>, <code>cascade</code>, <code>lazy</code>, <code>cache</code>, and <code>joinTable</code>.<p class="paragraph"/>One thing to bear in mind with custom types is that they define the  <em class="italic">SQL types</em>  for the corresponding database columns. That helps take the burden of configuring them yourself, but what happens if you have a legacy database that uses a different SQL type for one of the columns? In that case, override the column's SQL type using the <code>sqlType</code> attribute:<p class="paragraph"/><div class="code"><pre>class Book &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title
    Name author
    Rating rating<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        name type: NameUserType, &#123;
            column name: <span class="java&#45;quote">"first_name"</span>, sqlType: <span class="java&#45;quote">"text"</span>
            column name: <span class="java&#45;quote">"last_name"</span>, sqlType: <span class="java&#45;quote">"text"</span>
        &#125;
        rating type: RatingUserType, sqlType: <span class="java&#45;quote">"text"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Mind you, the SQL type you specify needs to still work with the custom type. So overriding a default of "varchar" with "text" is fine, but overriding "text" with "yes_no" isn't going to work.


<a name="5.5.2.11 Derived Properties"><!-- Legacy link --></a>
<h2 id="derivedProperties">5.5.2.11 派生属性</h2>
A derived property is one that takes its value from a SQL expression, often but not necessarily based on the value of one or more other persistent properties.  Consider a Product class like this:<p class="paragraph"/><div class="code"><pre>class Product &#123;
    <span class="java&#45;object">Float</span> price
    <span class="java&#45;object">Float</span> taxRate
    <span class="java&#45;object">Float</span> tax
&#125;</pre></div><p class="paragraph"/>If the <code>tax</code> property is derived based on the value of <code>price</code> and <code>taxRate</code> properties then is probably no need to persist the <code>tax</code> property.  The SQL used to derive the value of a derived property may be expressed in the ORM DSL like this:<p class="paragraph"/><div class="code"><pre>class Product &#123;
    <span class="java&#45;object">Float</span> price
    <span class="java&#45;object">Float</span> taxRate
    <span class="java&#45;object">Float</span> tax<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        tax formula: 'PRICE &#42; TAX_RATE'
    &#125;
&#125;</pre></div><p class="paragraph"/>Note that the formula expressed in the ORM DSL is SQL so references to other properties should relate to the persistence model not the object model, which is why the example refers to <code>PRICE</code> and <code>TAX_RATE</code> instead of <code>price</code> and <code>taxRate</code>.<p class="paragraph"/>With that in place, when a Product is retrieved with something like <code>Product.get(42)</code>, the SQL that is generated to support that will look something like this:<p class="paragraph"/><div class="code"><pre>select
    product0_.id as id1_0_,
    product0_.version as version1_0_,
    product0_.price as price1_0_,
    product0_.tax_rate as tax4_1_0_,
    product0_.PRICE &#42; product0_.TAX_RATE as formula1_0_
from
    product product0_
where
    product0_.id=?</pre></div><p class="paragraph"/>Since the <code>tax</code> property is derived at runtime and not stored in the database it might seem that the same effect could be achieved by adding a method like <code>getTax()</code> to the <code>Product</code> class that simply returns the product of the <code>taxRate</code> and <code>price</code> properties.  With an approach like that you would give up the ability query the database based on the value of the <code>tax</code> property.  Using a derived property allows exactly that.  To retrieve all <code>Product</code> objects that have a <code>tax</code> value greater than 21.12 you could execute a query like this:<p class="paragraph"/><div class="code"><pre>Product.findAllByTaxGreaterThan(21.12)</pre></div><p class="paragraph"/>Derived properties may be referenced in the Criteria API:<p class="paragraph"/><div class="code"><pre>Product.withCriteria &#123;
    gt 'tax', 21.12f
&#125;</pre></div><p class="paragraph"/>The SQL that is generated to support either of those would look something like this:<p class="paragraph"/><div class="code"><pre>select
    this_.id as id1_0_,
    this_.version as version1_0_,
    this_.price as price1_0_,
    this_.tax_rate as tax4_1_0_,
    this_.PRICE &#42; this_.TAX_RATE as formula1_0_
from
    product this_
where
    this_.PRICE &#42; this_.TAX_RATE&#62;?</pre></div><p class="paragraph"/><blockquote class="note">
Because the value of a derived property is generated in the database and depends on the execution of SQL code, derived properties may not have GORM constraints applied to them.  If constraints are specified for a derived property, they will be ignored.
</blockquote>


<a name="5.5.2.12 Custom Naming Strategy"><!-- Legacy link --></a>
<h2 id="customNamingStrategy">5.5.2.12 自定义的命名策略</h2>
By default Grails uses Hibernate's <code>ImprovedNamingStrategy</code> to convert domain class Class and field names to SQL table and column names by converting from camel-cased Strings to ones that use underscores as word separators. You can customize these on a per-instance basis in the <code>mapping</code> closure but if there's a consistent pattern you can specify a different <code>NamingStrategy</code> class to use.<p class="paragraph"/>Configure the class name to be used in <code>grails-app/conf/DataSource.groovy</code> in the <code>hibernate</code> section, e.g.<p class="paragraph"/><div class="code"><pre>dataSource &#123;
    pooled = <span class="java&#45;keyword">true</span>
    dbCreate = <span class="java&#45;quote">"create&#45;drop"</span>
    &#8230;
&#125;<p class="paragraph"/>hibernate &#123;
    cache.use_second_level_cache = <span class="java&#45;keyword">true</span>
    &#8230;
    naming_strategy = com.myco.myproj.CustomNamingStrategy
&#125;</pre></div><p class="paragraph"/>You can use an existing class or write your own, for example one that prefixes table names and column names:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.myco.myproj<p class="paragraph"/><span class="java&#45;keyword">import</span> org.hibernate.cfg.ImprovedNamingStrategy
<span class="java&#45;keyword">import</span> org.hibernate.util.StringHelper<p class="paragraph"/>class CustomNamingStrategy <span class="java&#45;keyword">extends</span> ImprovedNamingStrategy &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> classToTableName(<span class="java&#45;object">String</span> className) &#123;
        <span class="java&#45;quote">"table_"</span> + StringHelper.unqualify(className)
    &#125;<p class="paragraph"/>    <span class="java&#45;object">String</span> propertyToColumnName(<span class="java&#45;object">String</span> propertyName) &#123;
        <span class="java&#45;quote">"col_"</span> + StringHelper.unqualify(propertyName)
    &#125;
&#125;</pre></div><p class="paragraph"/>

<a name="5.5.3 Default Sort Order"><!-- Legacy link --></a>
<h2 id="defaultSortOrder">5.5.3 缺省排序</h2>
You can sort objects using query arguments such as those found in the <a href="../ref/Domain Classes/list.html" class="domainClasses">list</a> method:<p class="paragraph"/><div class="code"><pre>def airports = Airport.list(sort:'name')</pre></div><p class="paragraph"/>However, you can also declare the default sort order for a collection in the mapping:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        sort <span class="java&#45;quote">"name"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The above means that all collections of <code>Airport</code>s will by default be sorted by the airport name. If you also want to change the sort  <em class="italic">order</em> , use this syntax:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> mapping = &#123;
        sort name: <span class="java&#45;quote">"desc"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Finally, you can configure sorting at the association level:<p class="paragraph"/><div class="code"><pre>class Airport &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> hasMany = &#91;flights: Flight&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        flights sort: 'number', order: 'desc'
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case, the <code>flights</code> collection will always be sorted in descending order of flight number.<p class="paragraph"/><blockquote class="warning">
These mappings will not work for default unidirectional one-to-many or many-to-many relationships because they involve a join table. See <a href="http://jira.codehaus.org/browse/GRAILS-4089" target="blank">this issue</a> for more details. Consider using a <code>SortedSet</code> or queries with sort parameters to fetch the data you need.
</blockquote>


<a name="5.6 Programmatic Transactions"><!-- Legacy link --></a>
<h2 id="programmaticTransactions">5.6 事务编程</h2>
Grails is built on Spring and uses Spring's Transaction abstraction for dealing with programmatic transactions. However, GORM classes have been enhanced to make this simpler with the <a href="../ref/Domain Classes/withTransaction.html" class="domainClasses">withTransaction</a> method. This method has a single parameter, a Closure, which has a single parameter which is a Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/TransactionStatus.html" class="api">TransactionStatus</a> instance.<p class="paragraph"/>Here's an example of using <code>withTransaction</code> in a controller methods:<p class="paragraph"/><div class="code"><pre>def transferFunds() &#123;
    Account.withTransaction &#123; status &#45;&#62;
        def source = Account.get(params.from)
        def dest = Account.get(params.to)<p class="paragraph"/>        def amount = params.amount.toInteger()
        <span class="java&#45;keyword">if</span> (source.active) &#123;
            <span class="java&#45;keyword">if</span> (dest.active) &#123;
                source.balance &#45;= amount
                dest.amount += amount
            &#125;
            <span class="java&#45;keyword">else</span> &#123;
                status.setRollbackOnly()
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example we rollback the transaction if the destination account is not active. Also, if an unchecked <code>Exception</code> or <code>Error</code> (but not a checked <code>Exception</code>, even though Groovy doesn't require that you catch checked exceptions) is thrown during the process the transaction will automatically be rolled back.<p class="paragraph"/>You can also use "save points" to rollback a transaction to a particular point in time if you don't want to rollback the entire transaction. This can be achieved through the use of Spring's <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/SavepointManager.html" class="api">SavePointManager</a> interface.<p class="paragraph"/>The <code>withTransaction</code> method deals with the begin/commit/rollback logic for you within the scope of the block.


<a name="5.7 GORM and Constraints"><!-- Legacy link --></a>
<h2 id="gormConstraints">5.7 GORM与约束</h2>
Although constraints are covered in the <a href="../guide/single.html#constraints" class="guide">Validation</a> section, it is important to mention them here as some of the constraints can affect the way in which the database schema is generated.<p class="paragraph"/>Where feasible, Grails uses a domain class's constraints to influence the database columns generated for the corresponding domain class properties.<p class="paragraph"/>Consider the following example.  Suppose we have a domain model with the following properties:<p class="paragraph"/><div class="code"><pre><span class="java&#45;object">String</span> name
<span class="java&#45;object">String</span> description</pre></div><p class="paragraph"/>By default, in MySQL, Grails would define these columns as<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Column</th><th>Data Type</th></tr><tr class="table-odd"><td>name</td><td>varchar(255)</td></tr><tr class="table-even"><td>description</td><td>varchar(255)</td></tr></table><p class="paragraph"/>But perhaps the business rules for this domain class state that a description can be up to 1000 characters in length.  If that were the case, we would likely define the column as follows  <em class="italic">if</em>  we were creating the table with an SQL script.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Column</th><th>Data Type</th></tr><tr class="table-odd"><td>description</td><td>TEXT</td></tr></table><p class="paragraph"/>Chances are we would also want to have some application-based validation to make sure we don't exceed that 1000 character limit  <em class="italic">before</em>  we persist any records.  In Grails, we achieve this validation with <a href="../guide/single.html#constraints" class="guide">constraints</a>.  We would add the following constraint declaration to the domain class.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> constraints = &#123;
    description maxSize: 1000
&#125;</pre></div><p class="paragraph"/>This constraint would provide both the application-based validation we want and it would also cause the schema to be generated as shown above.  Below is a description of the other constraints that influence schema generation.<p class="paragraph"/><h4>Constraints Affecting String Properties</h4>
<ul class="star">
<li><a href="../ref/Constraints/inList.html" class="constraints">inList</a></li>
<li><a href="../ref/Constraints/maxSize.html" class="constraints">maxSize</a></li>
<li><a href="../ref/Constraints/size.html" class="constraints">size</a></li>
</ul><p class="paragraph"/>If either the <code>maxSize</code> or the <code>size</code> constraint is defined, Grails sets the maximum column length based on the constraint value.<p class="paragraph"/>In general, it's not advisable to use both constraints on the same domain class property.  However, if both the <code>maxSize</code> constraint and the <code>size</code> constraint are defined, then Grails sets the column length to the minimum of the <code>maxSize</code> constraint and the upper bound of the size constraint.  (Grails uses the minimum of the two, because any length that exceeds that minimum will result in a validation error.)<p class="paragraph"/>If the <code>inList</code> constraint is defined (and the <code>maxSize</code> and the <code>size</code> constraints are not defined), then Grails sets the maximum column length based on the length of the longest string in the list of valid values.  For example, given a list including values "Java", "Groovy", and "C++", Grails would set the column length to 6 (i.e., the number of characters in the string "Groovy").<p class="paragraph"/><h4>Constraints Affecting Numeric Properties</h4>
<ul class="star">
<li><a href="../ref/Constraints/min.html" class="constraints">min</a></li>
<li><a href="../ref/Constraints/max.html" class="constraints">max</a></li>
<li><a href="../ref/Constraints/range.html" class="constraints">range</a></li>
</ul><p class="paragraph"/>If the <code>max</code>, <code>min</code>, or <code>range</code> constraint is defined, Grails attempts to set the column precision based on the constraint value.  (The success of this attempted influence is largely dependent on how Hibernate interacts with the underlying DBMS.)<p class="paragraph"/>In general, it's not advisable to combine the pair <code>min</code>/<code>max</code> and <code>range</code> constraints together on the same domain class property.  However, if both of these constraints is defined, then Grails uses the minimum precision value from the constraints.  (Grails uses the minimum of the two, because any length that exceeds that minimum precision will result in a validation error.)
<ul class="star">
<li><a href="../ref/Constraints/scale.html" class="constraints">scale</a></li>
</ul><p class="paragraph"/>If the scale constraint is defined, then Grails attempts to set the column <a href="../ref/Constraints/scale.html" class="constraints">scale</a> based on the constraint value.  This rule only applies to floating point numbers (i.e., <code>java.lang.Float</code>, <code>java.Lang.Double</code>, <code>java.lang.BigDecimal</code>, or subclasses of <code>java.lang.BigDecimal</code>). The success of this attempted influence is largely dependent on how Hibernate interacts with the underlying DBMS.<p class="paragraph"/>The constraints define the minimum/maximum numeric values, and Grails derives the maximum number of digits for use in the precision. Keep in mind that specifying only one of <code>min</code>/<code>max</code> constraints will not affect schema generation (since there could be large negative value of property with max:100, for example), unless the specified constraint value requires more digits than default Hibernate column precision is (19 at the moment). For example:<p class="paragraph"/><div class="code"><pre>someFloatValue max: 1000000, scale: 3</pre></div><p class="paragraph"/>would yield:<p class="paragraph"/><div class="code"><pre>someFloatValue DECIMAL(19, 3) // precision is <span class="java&#45;keyword">default</span></pre></div><p class="paragraph"/>but<p class="paragraph"/><div class="code"><pre>someFloatValue max: 12345678901234567890, scale: 5</pre></div><p class="paragraph"/>would yield:
<div class="code"><pre>someFloatValue DECIMAL(25, 5) // precision = digits in max + scale</pre></div><p class="paragraph"/>and<p class="paragraph"/><div class="code"><pre>someFloatValue max: 100, min: &#45;100000</pre></div><p class="paragraph"/>would yield:<p class="paragraph"/><div class="code"><pre>someFloatValue DECIMAL(8, 2) // precision = digits in min + <span class="java&#45;keyword">default</span> scale</pre></div>


<a name="6. The Web Layer"><!-- Legacy link --></a>
<h1 id="theWebLayer">6 Web层</h1>


<a name="6.1 Controllers"><!-- Legacy link --></a>
<h2 id="controllers">6.1 控制器</h2>
<div class="hidden-block">
A controller handles requests and creates or prepares the response. A controller can generate the response directly or delegate to a view. To create a controller, simply create a class whose name ends with <code>Controller</code> in the <code>grails-app/controllers</code> directory (in a subdirectory if it's in a package).<p class="paragraph"/>The default <a href="../guide/single.html#urlmappings" class="guide">URL Mapping</a> configuration ensures that the first part of your controller name is mapped to a URI and each action defined within your controller maps to URIs within the controller name URI.
</div><p class="paragraph"/>
一个控制器通常用以处理请求，创建或者准备响应，也能直接生成响应或者委托给一个视图。要创建一个控制器，只需要在<code>grails-app/controllers</code>目录（如果有包的话，要位于相应的子目录下）下简单创建一个名字以<code>Controller</code>结尾的类。<p class="paragraph"/>默认的<a href="../guide/single.html#urlmappings" class="guide">URL映射</a>配置能确保你的控制器名字的第一部分被映射到一个URI上，而控制器中的每个操作定义被映射到控制器命名URI中的URI中。


<a name="6.1.1 Understanding Controllers and Actions"><!-- Legacy link --></a>
<h2 id="understandingControllersAndActions">6.1.1 理解控制器和操作</h2>
<div class="hidden-block">
<h4>Creating a controller</h4><p class="paragraph"/>Controllers can be created with the <a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a> or <a href="../ref/Command Line/generate-controller.html" class="commandLine">generate-controller</a> command. For example try running the following command from the root of a Grails project:<p class="paragraph"/><div class="code"><pre>grails create&#45;controller book</pre></div><p class="paragraph"/>The command will create a controller at the location <code>grails-app/controllers/myapp/BookController.groovy</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> myapp<p class="paragraph"/>class BookController &#123;<p class="paragraph"/>    def index() &#123; &#125;
&#125;</pre></div><p class="paragraph"/>where "myapp" will be the name of your application, the default package name if one isn't specified.<p class="paragraph"/><code>BookController</code> by default maps to the /book URI (relative to your application root).<p class="paragraph"/><blockquote class="note">
The <code>create-controller</code> and <code>generate-controller</code> commands are just for convenience and you can just as easily create controllers using your favorite text editor or IDE
</blockquote>
</div><p class="paragraph"/><h4>创建控制器</h4><p class="paragraph"/>控制器可以通过<a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a>或者<a href="../ref/Command Line/generate-controller.html" class="commandLine">generate-controller</a>命令创建。比如，在Grails工程的根目录中运行如下命令：<p class="paragraph"/><div class="code"><pre>grails create&#45;controller book</pre></div><p class="paragraph"/>此命令将创建一个位于<code>grails-app/controllers/myapp/BookController.groovy</code>的控制器：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> myapp<p class="paragraph"/>class BookController &#123;<p class="paragraph"/>    def index() &#123; &#125;
&#125;</pre></div><p class="paragraph"/>此处"myapp"是你应用的名称，如果你没有指定包名的话，缺省的包名就是应用名称。<p class="paragraph"/><code>BookController</code>缺省被映射于URI /book （相对于你应用上下文的根而言）<p class="paragraph"/><blockquote class="note">
<code>create-controller</code>和<code>generate-controller</code>命令只是便利方法而已，你也可以使用你喜欢的文本编辑器或者IDE来轻松的创建控制器。
</blockquote><p class="paragraph"/><div class="hidden-block">
<h4>Creating Actions</h4><p class="paragraph"/>A controller can have multiple public action methods; each one maps to a URI:<p class="paragraph"/><div class="code"><pre>class BookController &#123;<p class="paragraph"/>    def list() &#123;<p class="paragraph"/>        // <span class="java&#45;keyword">do</span> controller logic
        // create model<p class="paragraph"/>        <span class="java&#45;keyword">return</span> model
    &#125;
&#125;</pre></div><p class="paragraph"/>This example maps to the <code>/book/list</code> URI by default thanks to the property being named <code>list</code>.
</div><p class="paragraph"/><h4>创建操作</h4><p class="paragraph"/>一个控制器可以有多个公共操作方法，每一个都映射于一个URI：<p class="paragraph"/><div class="code"><pre>class BookController &#123;<p class="paragraph"/>    def list() &#123;<p class="paragraph"/>        // <span class="java&#45;keyword">do</span> controller logic
        // create model<p class="paragraph"/>        <span class="java&#45;keyword">return</span> model
    &#125;
&#125;</pre></div><p class="paragraph"/>缺省情况下，这个示例将映射到URI <code>/book/list</code>，这要归功于<code>list</code>属性。<p class="paragraph"/><div class="hidden-block">
<h4>Public Methods as Actions</h4><p class="paragraph"/>In earlier versions of Grails actions were implemented with Closures. This is still supported, but the preferred approach is to use methods.<p class="paragraph"/>Leveraging methods instead of Closure properties has some advantages:
<ul class="star">
<li>Memory efficient</li>
<li>Allow use of stateless controllers (<code>singleton</code> scope)</li>
<li>You can override actions from subclasses and call the overridden superclass method with <code>super.actionName()</code></li>
<li>Methods can be intercepted with standard proxying mechanisms, something that is complicated to do with Closures since they're fields.</li>
</ul><p class="paragraph"/>If you prefer the Closure syntax or have older controller classes created in earlier versions of Grails and still want the advantages of using methods, you can set the <code>grails.compile.artefacts.closures.convert</code> property to true in <code>BuildConfig.groovy</code>:
<div class="code"><pre>grails.compile.artefacts.closures.convert = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>and a compile-time AST transformation will convert your Closures to methods in the generated bytecode.<p class="paragraph"/><blockquote class="note">
If a controller class extends some other class which is not defined under the <code>grails-app/controllers/</code> directory, methods inherited from that class are not converted to controller actions.  If the intent is to expose those inherited methods as controller actions the methods may be overridden in the subclass and the subclass method may invoke the method in the super class.
</blockquote>
</div><p class="paragraph"/><h4>公共方法作为操作</h4><p class="paragraph"/>在以前版本的Grails中，操作是通过闭包来实现的。现在依然是支持的，不过更推荐使用方法的方式来实现。<p class="paragraph"/>使用方法来替代闭包有如下一些优点：
<ul class="star">
<li>更高效的内存</li>
<li>允许使用状态无关的控制器（作用域是<code>singleton</code>）</li>
<li>你可以在子类中重载操作，并且可以使用<code>super.actionName()</code>调用父类的方法</li>
<li>方法可以通过标准的代理机制进行拦截，同样的事情闭包更复杂一些，因为它们是属性字段。</li>
</ul><p class="paragraph"/>如果你更喜欢闭包的语法或者现有的控制器类是以前版本的Grails所创建的，又想得到方法作为操作的好处，你可以设置<code>BuildConfig.groovy</code>中的<code>grails.compile.artefacts.closures.convert</code>属性为true：
<div class="code"><pre>grails.compile.artefacts.closures.convert = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>这时，一个编译时的AST变换会在生成字节码的时候，将你的闭包转变为方法<p class="paragraph"/><blockquote class="note">
如果一个控制器类继承于其他类，但不是被定义在<code>grails-app/controllers/</code>目录下，那么继承过来的方法将不会被转换成控制器操作的。如果目标是为了能将那些继承来的方法暴露为控制器操作，那么这些方法应该是能够被子类重载的，并且在子类中也可以调用其父类的方法。
</blockquote><p class="paragraph"/><div class="hidden-block">
<h4>The Default Action</h4><p class="paragraph"/>A controller has the concept of a default URI that maps to the root URI of the controller, for example <code>/book</code> for <code>BookController</code>. The action that is called when the default URI is requested is dictated by the following rules:
<ul class="star">
<li>If there is only one action, it's the default</li>
<li>If you have an action named <code>index</code>, it's the default</li>
<li>Alternatively you can set it explicitly with the <code>defaultAction</code> property:</li>
</ul><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> defaultAction = <span class="java&#45;quote">"list"</span></pre></div>
</div><p class="paragraph"/><h4>缺省操作</h4><p class="paragraph"/>一个控制器即映射到控制器的根URI。默认情况下缺省URI在这里的是/book。默认的URI通过以下规则来支配：
一个控制器具有默认URI的概念，其将映射到控制器的根URI。比如<code>BookController</code>映射到<code>/book</code>。当缺省URI被请求时，会根据以下规则来调用操作：
<ul class="star">
<li>如果仅有一个操作，那么它就是那个缺省操作</li>
<li>如果你有一个<code>index</code>操作，那么它就是缺省的</li>
<li>或者你可以使用<code>defaultAction</code>属性来明确指定：</li>
</ul><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> defaultAction = <span class="java&#45;quote">"list"</span></pre></div>


<a name="6.1.2 Controllers and Scopes"><!-- Legacy link --></a>
<h2 id="controllersAndScopes">6.1.2 控制器和作用域</h2>
<div class="hidden-block">
<h4>Available Scopes</h4><p class="paragraph"/>Scopes are hash-like objects where you can store variables. The following scopes are available to controllers:
<ul class="star">
<li><a href="../ref/Controllers/servletContext.html" class="controllers">servletContext</a> - Also known as application scope, this scope lets you share state across the entire web application. The servletContext is an instance of <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/ServletContext.html" class="api">ServletContext</a></li>
<li><a href="../ref/Controllers/session.html" class="controllers">session</a> - The session allows associating state with a given user and typically uses cookies to associate a session with a client. The session object is an instance of <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpSession.html" class="api">HttpSession</a></li>
<li><a href="../ref/Controllers/request.html" class="controllers">request</a> - The request object allows the storage of objects for the current request only. The request object is an instance of <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a></li>
<li><a href="../ref/Controllers/params.html" class="controllers">params</a> - Mutable map of incoming request query string or POST parameters</li>
<li><a href="../ref/Controllers/flash.html" class="controllers">flash</a> - See below</li>
</ul><p class="paragraph"/></div><p class="paragraph"/><h4>有效作用域</h4><p class="paragraph"/>作用域就像是hash对象，允许你存储变量。以下是控制器有效作用域：
<ul class="star">
<li><a href="../ref/Controllers/servletContext.html" class="controllers">servletContext</a> - 也被叫做应用级别范围，它允许你共享整个web应用的状态。 servletContext对象是<a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/ServletContext.html" class="api">ServletContext</a>的一个实例</li>
<li><a href="../ref/Controllers/session.html" class="controllers">session</a> - 会话（session）允许关联某个用户的状态，通常使用Cookie把会话与客户端关联起来。session对象是<a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpSession.html" class="api">HttpSession</a>的一个实例</li>
<li><a href="../ref/Controllers/request.html" class="controllers">request</a> - 请求对象仅为当前的请求存储对象。request对象是<a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a>的一个实例</li>
<li><a href="../ref/Controllers/params.html" class="controllers">params</a> - 带查询字串（query string）或者POST参数输入请求的可变map</li>
<li><a href="../ref/Controllers/flash.html" class="controllers">flash</a> - 见下文</li>
</ul><p class="paragraph"/><div class="hidden-block">
<h4>Accessing Scopes</h4><p class="paragraph"/>Scopes can be accessed using the variable names above in combination with Groovy's array index operator, even on classes provided by the Servlet API such as the <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a>:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def find() &#123;
        def findBy = params&#91;<span class="java&#45;quote">"findBy"</span>&#93;
        def appContext = request&#91;<span class="java&#45;quote">"foo"</span>&#93;
        def loggedUser = session&#91;<span class="java&#45;quote">"logged_user"</span>&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>You can also access values within scopes using the de-reference operator, making the syntax even more clear:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def find() &#123;
        def findBy = params.findBy
        def appContext = request.foo
        def loggedUser = session.logged_user
    &#125;
&#125;</pre></div><p class="paragraph"/>This is one of the ways that Grails unifies access to the different scopes.
</div><p class="paragraph"/><h4>访问作用域</h4><p class="paragraph"/>作用域可以通过上述提到的变量名和Groovy的数组索引操作符的方式来访问，即使这些类是Servlet API的类，例如<a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a>也可以用，比如：<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def find() &#123;
        def findBy = params&#91;<span class="java&#45;quote">"findBy"</span>&#93;
        def appContext = request&#91;<span class="java&#45;quote">"foo"</span>&#93;
        def loggedUser = session&#91;<span class="java&#45;quote">"logged_user"</span>&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>你甚至可以使用"."操作符来访问作用域的值，这样使语法更加简洁清晰：<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def find() &#123;
        def findBy = params.findBy
        def appContext = request.foo
        def loggedUser = session.logged_user
    &#125;
&#125;</pre></div><p class="paragraph"/>这是统一访问不同作用域的方式之一。<p class="paragraph"/><div class="hidden-block">
<h4>Using Flash Scope</h4><p class="paragraph"/>Grails supports the concept of <a href="../ref/Controllers/flash.html" class="controllers">flash</a> scope as a temporary store to make attributes available for this request and the next request only. Afterwards the attributes are cleared. This is useful for setting a message directly before redirecting, for example:<p class="paragraph"/><div class="code"><pre>def delete() &#123;
    def b = Book.get(params.id)
    <span class="java&#45;keyword">if</span> (!b) &#123;
        flash.message = <span class="java&#45;quote">"User not found <span class="java&#45;keyword">for</span> id $&#123;params.id&#125;"</span>
        redirect(action:list)
    &#125;
    &#8230; // remaining code
&#125;</pre></div><p class="paragraph"/>When the <code>list</code> action is requested, the <code>message</code> value will be in scope and can be used to display an information message. It will be removed from the <code>flash</code> scope after this second request.<p class="paragraph"/>Note that the attribute name can be anything you want, and the values are often strings used to display messages, but can be any object type.
</div><p class="paragraph"/><h4>使用Flash作用域</h4><p class="paragraph"/>Grails支持<a href="../ref/Controllers/flash.html" class="controllers">flash</a>作用域的概念，它只存贮本次请求和下次请求之间临时用到的属性，随后属性值将被清除。这在重定向之前，设置提示消息是非常有用的，比如：<p class="paragraph"/><div class="code"><pre>def delete() &#123;
    def b = Book.get(params.id)
    <span class="java&#45;keyword">if</span> (!b) &#123;
        flash.message = <span class="java&#45;quote">"User not found <span class="java&#45;keyword">for</span> id $&#123;params.id&#125;"</span>
        redirect(action:list)
    &#125;
    &#8230; // remaining code
&#125;</pre></div><p class="paragraph"/>当<code>list</code>操作被请求时，<code>message</code>的值在此范围内有效，可以用以显示一个提示信息。在第二次请求的时候，此值将从<code>flash</code>作用域移除。<p class="paragraph"/>注意，属性的名称可以是你期望的任何东西，其值多是用以显示信息的字符串，不过也可以是任何对象。<p class="paragraph"/><div class="hidden-block">
<h4>Scoped Controllers</h4><p class="paragraph"/>By default, a new controller instance is created for each request. In fact, because the controller is <code>prototype</code> scoped, it is thread-safe since each request happens on its own thread.<p class="paragraph"/>You can change this behaviour by placing a controller in a particular scope. The supported scopes are:
<ul class="star">
<li><code>prototype</code> (default) - A new controller will be created for each request (recommended for actions as Closure properties)</li>
<li><code>session</code> - One controller is created for the scope of a user session</li>
<li><code>singleton</code> - Only one instance of the controller ever exists (recommended for actions as methods)</li>
</ul><p class="paragraph"/>To enable one of the scopes, add a static <code>scope</code> property to your class with one of the valid scope values listed above, for example<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> scope = <span class="java&#45;quote">"singleton"</span></pre></div><p class="paragraph"/>You can define the default strategy under in <code>Config.groovy</code> with the <code>grails.controllers.defaultScope</code> key, for example:<p class="paragraph"/><div class="code"><pre>grails.controllers.defaultScope = <span class="java&#45;quote">"singleton"</span></pre></div><p class="paragraph"/><blockquote class="note">
Use scoped controllers wisely. For instance, we don't recommend having any properties in a singleton-scoped controller since they will be shared for  <em class="italic">all</em>  requests. Setting a default scope other than <code>prototype</code> may also lead to unexpected behaviors if you have controllers provided by installed plugins that expect that the scope is <code>prototype</code>.
</blockquote>
</div><p class="paragraph"/><h4>控制器的作用域</h4><p class="paragraph"/>通常，每一个请求会创建一个控制器实例。事实上，是因为控制器的作用域是<code>prototype</code>，并且每个请求都有自己的线程，所以控制器是线程安全的。<p class="paragraph"/>不过，你还是可以在控制器内放置一个特定的作用域来改变这种行为。其支持的作用域如下：
<ul class="star">
<li><code>prototype</code> （缺省） - 每一次请求创建一个新的控制器实例（当操作为必包属性时推荐使用）</li>
<li><code>session</code> - 在一个用户会话的作用域内只创建一个控制器实例</li>
<li><code>singleton</code> - 自始自终只有一个控制器实例（当操作时一个方法时推荐使用）</li>
</ul><p class="paragraph"/>要想使用上述的作用域，请在类内增加一个静态的<code>scope</code>属性，并且使用上述作用域之一为其赋值，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> scope = <span class="java&#45;quote">"singleton"</span></pre></div><p class="paragraph"/>你也可以在<code>Config.groovy</code>中改变<code>grails.controllers.defaultScope</code>的值来改变缺省策略，比如<p class="paragraph"/><div class="code"><pre>grails.controllers.defaultScope = <span class="java&#45;quote">"singleton"</span></pre></div><p class="paragraph"/><blockquote class="note">
请明智的使用控制器的作用域。比如我们不推荐singleton作用域的控制器有任何属性，因为他们将在  <em class="italic">所有</em>  的请求共享。此外，如果你安装的插件的控制器是<code>prototype</code>的，那么修改缺省的<code>prototype</code>作用域也可能导致不可预知的行为。
</blockquote>

<a name="6.1.3 Models and Views"><!-- Legacy link --></a>
<h2 id="modelsAndViews">6.1.3 模型和视图</h2>
<div class="hidden-block">
<h4>Returning the Model</h4><p class="paragraph"/>A model is a Map that the view uses when rendering. The keys within that Map correspond to variable names accessible by the view. There are a couple of ways to return a model. First, you can explicitly return a Map instance:<p class="paragraph"/><div class="code"><pre>def show() &#123;
    &#91;book: Book.get(params.id)&#93;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
The above does  <em class="italic">not</em>  reflect what you should use with the scaffolding views - see the <a href="../guide/single.html#scaffolding" class="guide">scaffolding section</a> for more details.
</blockquote><p class="paragraph"/>If no explicit model is returned the controller's properties will be used as the model, thus allowing you to write code like this:<p class="paragraph"/><div class="code"><pre>class BookController &#123;<p class="paragraph"/>    List books
    List authors<p class="paragraph"/>    def list() &#123;
        books = Book.list()
        authors = Author.list()
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
This is possible due to the fact that controllers are prototype scoped. In other words a new controller is created for each request. Otherwise code such as the above would not be thread-safe, and all users would share the same data.
</blockquote><p class="paragraph"/>In the above example the <code>books</code> and <code>authors</code> properties will be available in the view.<p class="paragraph"/>A more advanced approach is to return an instance of the Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/servlet/ModelAndView.html" class="api">ModelAndView</a> class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.web.servlet.ModelAndView<p class="paragraph"/>def index() &#123;
    // get some books just <span class="java&#45;keyword">for</span> the index page, perhaps your favorites
    def favoriteBooks = ...<p class="paragraph"/>    // forward to the list view to show them
    <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> ModelAndView(<span class="java&#45;quote">"/book/list"</span>, &#91; bookList : favoriteBooks &#93;)
&#125;</pre></div><p class="paragraph"/>One thing to bear in mind is that certain variable names can not be used in your model:
<ul class="star">
<li><code>attributes</code></li>
<li><code>application</code></li>
</ul><p class="paragraph"/>Currently, no error will be reported if you do use them, but this will hopefully change in a future version of Grails.
</div><p class="paragraph"/><h4>返回模型</h4><p class="paragraph"/>模型是在渲染的时候给视图用的一个映射（Map）。映射的键对应于视图中的命名变量。有很多方法都可以返回一个模型。首先，你可以通过明确返回映射（Map）实例的方式：<p class="paragraph"/><div class="code"><pre>def show() &#123;
    &#91;book: Book.get(params.id)&#93;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
上述示例并  <em class="italic">不会</em>  影响到脚手架的视图－更多信息请参考<a href="../guide/single.html#scaffolding" class="guide">脚手架章节</a>。
</blockquote><p class="paragraph"/>如果没有明确指定模型，那么控制器的属性将作为模型返回给视图，象如下代码所示那样：<p class="paragraph"/><div class="code"><pre>class BookController &#123;<p class="paragraph"/>    List books
    List authors<p class="paragraph"/>    def list() &#123;
        books = Book.list()
        authors = Author.list()
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
这是可行的，因为控制器的缺省作用域是prototype。换句话说，每一个请求都将创建一个新的控制器。否则的话，上述的代码就不是线程安全的了，所有的用户将共享同样的数据。
</blockquote><p class="paragraph"/>在上述示例中，<code>books</code>和<code>authors</code>属性在视图中将是有效的。<p class="paragraph"/>另外一个更高级的方式是返回一个Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/servlet/ModelAndView.html" class="api">ModelAndView</a>类的一个实例：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.web.servlet.ModelAndView<p class="paragraph"/>def index() &#123;
    // get some books just <span class="java&#45;keyword">for</span> the index page, perhaps your favorites
    def favoriteBooks = ...<p class="paragraph"/>    // forward to the list view to show them
    <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> ModelAndView(<span class="java&#45;quote">"/book/list"</span>, &#91; bookList : favoriteBooks &#93;)
&#125;</pre></div><p class="paragraph"/>只有一件事情需要担心，那就是在你的模型中可能某些变量名称是不可用的：
<ul class="star">
<li><code>attributes</code></li>
<li><code>application</code></li>
</ul><p class="paragraph"/>当前，如果你使用到了它们，也不会有任何错误提示报告出来，但是在将来的Grails版本中希望有所改善。<p class="paragraph"/><div class="hidden-block">
<h4>Selecting the View</h4><p class="paragraph"/>In both of the previous two examples there was no code that specified which <a href="../guide/single.html#gsp" class="guide">view</a> to render. So how does Grails know which one to pick? The answer lies in the conventions. Grails will look for a view at the location <code>grails-app/views/book/show.gsp</code> for this <code>list</code> action:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def show() &#123;
         &#91;book: Book.get(params.id)&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>To render a different view, use the <a href="../ref/Controllers/render.html" class="controllers">render</a> method:<p class="paragraph"/><div class="code"><pre>def show() &#123;
    def map = &#91;book: Book.get(params.id)&#93;
    render(view: <span class="java&#45;quote">"display"</span>, model: map)
&#125;</pre></div><p class="paragraph"/>In this case Grails will attempt to render a view at the location <code>grails-app/views/book/display.gsp</code>. Notice that Grails automatically qualifies the view location with the <code>book</code> directory of the <code>grails-app/views</code> directory. This is convenient, but to access shared views you need instead you can use an absolute path instead of a relative one:<p class="paragraph"/><div class="code"><pre>def show() &#123;
    def map = &#91;book: Book.get(params.id)&#93;
    render(view: <span class="java&#45;quote">"/shared/display"</span>, model: map)
&#125;</pre></div><p class="paragraph"/>In this case Grails will attempt to render a view at the location <code>grails-app/views/shared/display.gsp</code>.<p class="paragraph"/>Grails also supports JSPs as views, so if a GSP isn't found in the expected location but a JSP is, it will be used instead.
</div><p class="paragraph"/><h4>选择视图</h4><p class="paragraph"/>在前面的两个示例中，我们并没有指定要用那个视图来渲染。那么Grails是如何知道那个将被选择？答案是规约依赖。在下面的示例中，Grails将自动的寻找位于<code>grails-app/views/book/show.gsp</code>的视图：<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def show() &#123;
         &#91;book: Book.get(params.id)&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>要渲染另外不同的视图，需要使用<a href="../ref/Controllers/render.html" class="controllers">render</a>方法：<p class="paragraph"/><div class="code"><pre>def show() &#123;
    def map = &#91;book: Book.get(params.id)&#93;
    render(view: <span class="java&#45;quote">"display"</span>, model: map)
&#125;</pre></div><p class="paragraph"/>在上述示例中，Grails将尝试使用视图<code>grails-app/views/book/display.gsp</code>来渲染。注意，Grails会根据<code>grails-app/views</code>下的<code>book</code>目录来自动地限定视图的位置。常规是这样的，但是要访问那些共享的视图，你还是需要使用绝对路径来替代相对路径：<p class="paragraph"/><div class="code"><pre>def show() &#123;
    def map = &#91;book: Book.get(params.id)&#93;
    render(view: <span class="java&#45;quote">"/shared/display"</span>, model: map)
&#125;</pre></div><p class="paragraph"/>在这个示例中，Grails将尝试使用视图<code>grails-app/views/shared/display.gsp</code>来渲染。<p class="paragraph"/>Grails也支持JSP的视图，因此如果一个预期的GSP没有找到，但是有相应的JSP，那么它将使用此JSP。<p class="paragraph"/><div class="hidden-block">
<h4>Rendering a Response</h4><p class="paragraph"/>Sometimes it's easier (for example with Ajax applications) to render snippets of text or code to the response directly from the controller. For this, the highly flexible <code>render</code> method can be used:<p class="paragraph"/><div class="code"><pre>render <span class="java&#45;quote">"Hello World!"</span></pre></div><p class="paragraph"/>The above code writes the text "Hello World!" to the response. Other examples include:<p class="paragraph"/><div class="code"><pre>// write some markup
render &#123;
   <span class="java&#45;keyword">for</span> (b in books) &#123;
      div(id: b.id, b.title)
   &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>// render a specific view
render(view: 'show')</pre></div><p class="paragraph"/><div class="code"><pre>// render a template <span class="java&#45;keyword">for</span> each item in a collection
render(template: 'book_template', collection: Book.list())</pre></div><p class="paragraph"/><div class="code"><pre>// render some text with encoding and content type
render(text: <span class="java&#45;quote">"&#60;xml&#62;some xml&#60;/xml&#62;"</span>, contentType: <span class="java&#45;quote">"text/xml"</span>, encoding: <span class="java&#45;quote">"UTF&#45;8"</span>)</pre></div><p class="paragraph"/>If you plan on using Groovy's <code>MarkupBuilder</code> to generate HTML for use with the <code>render</code> method be careful of naming clashes between HTML elements and Grails tags, for example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> groovy.xml.MarkupBuilder
&#8230;
def login() &#123;
    def writer = <span class="java&#45;keyword">new</span> StringWriter()
    def builder = <span class="java&#45;keyword">new</span> MarkupBuilder(writer)
    builder.html &#123;
        head &#123;
            title 'Log in'
        &#125;
        body &#123;
            h1 'Hello'
            form &#123;
            &#125;
        &#125;
    &#125;<p class="paragraph"/>    def html = writer.toString()
    render html
&#125;</pre></div><p class="paragraph"/>This will actually <a href="../guide/single.html#tagsAsMethodCalls" class="guide">call the form tag</a> (which will return some text that will be ignored by the <code>MarkupBuilder</code>). To correctly output a <code>&#60;form&#62;</code> element, use the following:<p class="paragraph"/><div class="code"><pre>def login() &#123;
    // &#8230;
    body &#123;
        h1 'Hello'
        builder.form &#123;
        &#125;
    &#125;
    // &#8230;
&#125;</pre></div>
</div><p class="paragraph"/><h4>渲染响应</h4><p class="paragraph"/>有时候在控制器中直接渲染文本或者代码片段到响应是很容易的（比如Ajax的应用）。这时，就可以使用灵活性很高的<code>render</code>方法了：<p class="paragraph"/><div class="code"><pre>render <span class="java&#45;quote">"Hello World!"</span></pre></div><p class="paragraph"/>上述代码输出"Hello World!"文本到其响应。另外的例子还包括：<p class="paragraph"/><div class="code"><pre>// write some markup
render &#123;
   <span class="java&#45;keyword">for</span> (b in books) &#123;
      div(id: b.id, b.title)
   &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>// render a specific view
render(view: 'show')</pre></div><p class="paragraph"/><div class="code"><pre>// render a template <span class="java&#45;keyword">for</span> each item in a collection
render(template: 'book_template', collection: Book.list())</pre></div><p class="paragraph"/><div class="code"><pre>// render some text with encoding and content type
render(text: <span class="java&#45;quote">"&#60;xml&#62;some xml&#60;/xml&#62;"</span>, contentType: <span class="java&#45;quote">"text/xml"</span>, encoding: <span class="java&#45;quote">"UTF&#45;8"</span>)</pre></div><p class="paragraph"/>如果你打算使用Groovy的<code>MarkupBuilder</code>来生成HTML来供<code>render</code>方法使用，这时，你要注意HTML元素和Grails标签名字的冲突，比如：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> groovy.xml.MarkupBuilder
&#8230;
def login() &#123;
    def writer = <span class="java&#45;keyword">new</span> StringWriter()
    def builder = <span class="java&#45;keyword">new</span> MarkupBuilder(writer)
    builder.html &#123;
        head &#123;
            title 'Log in'
        &#125;
        body &#123;
            h1 'Hello'
            form &#123;
            &#125;
        &#125;
    &#125;<p class="paragraph"/>    def html = writer.toString()
    render html
&#125;</pre></div><p class="paragraph"/>这将实际调用<a href="../guide/single.html#tagsAsMethodCalls" class="guide">form标签</a>（其返回的文本将被<code>MarkupBuilder</code>忽略）。要正确地输出<code>&#60;form&#62;</code>元素，需要使用如下的例子：<p class="paragraph"/><div class="code"><pre>def login() &#123;
    // &#8230;
    body &#123;
        h1 'Hello'
        builder.form &#123;
        &#125;
    &#125;
    // &#8230;
&#125;</pre></div>


<a name="6.1.4 Redirects and Chaining"><!-- Legacy link --></a>
<h2 id="redirectsAndChaining">6.1.4 重定向和链（Chaining）</h2>
<div class="hidden-block">
<h4>Redirects</h4><p class="paragraph"/>Actions can be redirected using the <a href="../ref/Controllers/redirect.html" class="controllers">redirect</a> controller method:<p class="paragraph"/><div class="code"><pre>class OverviewController &#123;<p class="paragraph"/>    def login() &#123;&#125;<p class="paragraph"/>    def find() &#123;
        <span class="java&#45;keyword">if</span> (!session.user)
            redirect(action: 'login')
            <span class="java&#45;keyword">return</span>
        &#125;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>Internally the <a href="../ref/Controllers/redirect.html" class="controllers">redirect</a> method uses the <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html" class="api">HttpServletResponse</a> object's <code>sendRedirect</code> method.<p class="paragraph"/>The <code>redirect</code> method expects one of:
<ul class="star">
<li>Another closure within the same controller class:</li>
</ul><p class="paragraph"/><div class="code"><pre>// Call the login action within the same class
redirect(action: login)</pre></div>
<ul class="star">
<li>The name of an action (and controller name if the redirect isn't to an action in the current controller):</li>
</ul><p class="paragraph"/><div class="code"><pre>// Also redirects to the index action in the home controller
redirect(controller: 'home', action: 'index')</pre></div>
<ul class="star">
<li> A URI for a resource relative the application context path:</li>
</ul><p class="paragraph"/><div class="code"><pre>// Redirect to an explicit URI
redirect(uri: <span class="java&#45;quote">"/login.html"</span>)</pre></div>
<ul class="star">
<li>Or a full URL:</li>
</ul><p class="paragraph"/><div class="code"><pre>// Redirect to a URL
redirect(url: <span class="java&#45;quote">"http://grails.org"</span>)</pre></div><p class="paragraph"/>Parameters can optionally be passed from one action to the next using the <code>params</code> argument of the method:<p class="paragraph"/><div class="code"><pre>redirect(action: 'myaction', params: &#91;myparam: <span class="java&#45;quote">"myvalue"</span>&#93;)</pre></div><p class="paragraph"/>These parameters are made available through the <a href="../ref/Controllers/params.html" class="controllers">params</a> dynamic property that accesses request parameters. If a parameter is specified with the same name as a request parameter, the request parameter is overridden and the controller parameter is used.<p class="paragraph"/>Since the <code>params</code> object is a Map, you can use it to pass the current request parameters from one action to the next:<p class="paragraph"/><div class="code"><pre>redirect(action: <span class="java&#45;quote">"next"</span>, params: params)</pre></div><p class="paragraph"/>Finally, you can also include a fragment in the target URI:<p class="paragraph"/><div class="code"><pre>redirect(controller: <span class="java&#45;quote">"test"</span>, action: <span class="java&#45;quote">"show"</span>, fragment: <span class="java&#45;quote">"profile"</span>)</pre></div><p class="paragraph"/>which will (depending on the URL mappings) redirect to something like "/myapp/test/show#profile".
</div><p class="paragraph"/><h4>重定向</h4><p class="paragraph"/>操作可以使用控制器的<a href="../ref/Controllers/redirect.html" class="controllers">redirect</a>方法进行重定向：<p class="paragraph"/><div class="code"><pre>class OverviewController &#123;<p class="paragraph"/>    def login() &#123;&#125;<p class="paragraph"/>    def find() &#123;
        <span class="java&#45;keyword">if</span> (!session.user)
            redirect(action: 'login')
            <span class="java&#45;keyword">return</span>
        &#125;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>本质上<a href="../ref/Controllers/redirect.html" class="controllers">redirect</a>方法是使用<a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html" class="api">HttpServletResponse</a>对象的<code>sendRedirect</code>方法来工作的。<p class="paragraph"/><code>redirect</code>方法的重定向目标用法如下：
<ul class="star">
<li>同一控制器类的另外一个闭包：</li>
</ul><p class="paragraph"/><div class="code"><pre>// Call the login action within the same class
redirect(action: login)</pre></div>
<ul class="star">
<li>操作的名称（如果要重定向的操作名不在同一个控制器内，还需要制定控制器名）：</li>
</ul><p class="paragraph"/><div class="code"><pre>// Also redirects to the index action in the home controller
redirect(controller: 'home', action: 'index')</pre></div>
<ul class="star">
<li> 一个相对于应用上下文路径的URI</li>
</ul><p class="paragraph"/><div class="code"><pre>// Redirect to an explicit URI
redirect(uri: <span class="java&#45;quote">"/login.html"</span>)</pre></div>
<ul class="star">
<li>或者一个完整的URL：</li>
</ul><p class="paragraph"/><div class="code"><pre>// Redirect to a URL
redirect(url: <span class="java&#45;quote">"http://grails.org"</span>)</pre></div><p class="paragraph"/>从一个操作到下一个之间的参数是可选的，这可以使用此方法的<code>params</code>来实现：<p class="paragraph"/><div class="code"><pre>redirect(action: 'myaction', params: &#91;myparam: <span class="java&#45;quote">"myvalue"</span>&#93;)</pre></div><p class="paragraph"/>这些参数是有效的，因为它们是通过可以访问请求参数的<a href="../ref/Controllers/params.html" class="controllers">params</a>来实现的。如果一个参数跟请求参数同名，那么请求参数将被覆盖，控制器的参数将被优先使用。<p class="paragraph"/>由于这个<code>params</code>对象就是一个Map，因此你可以使用它将当前的请求参数从一个操作传递到下个操作：<p class="paragraph"/><div class="code"><pre>redirect(action: <span class="java&#45;quote">"next"</span>, params: params)</pre></div><p class="paragraph"/>最后，你还可以在目标URI中包含片段（fragment）：<p class="paragraph"/><div class="code"><pre>redirect(controller: <span class="java&#45;quote">"test"</span>, action: <span class="java&#45;quote">"show"</span>, fragment: <span class="java&#45;quote">"profile"</span>)</pre></div><p class="paragraph"/>将重定向到类似于 "/myapp/test/show#profile" 的目标（依赖于URL映射）。<p class="paragraph"/><div class="hidden-block">
<h4>Chaining</h4><p class="paragraph"/>Actions can also be chained. Chaining allows the model to be retained from one action to the next. For example calling the <code>first</code> action in this action:<p class="paragraph"/><div class="code"><pre>class ExampleChainController &#123;<p class="paragraph"/>    def first() &#123;
        chain(action: second, model: &#91;one: 1&#93;)
    &#125;<p class="paragraph"/>    def second () &#123;
        chain(action: third, model: &#91;two: 2&#93;)
    &#125;<p class="paragraph"/>    def third() &#123;
        &#91;three: 3&#93;)
    &#125;
&#125;</pre></div><p class="paragraph"/>results in the model:<p class="paragraph"/><div class="code"><pre>&#91;one: 1, two: 2, three: 3&#93;</pre></div><p class="paragraph"/>The model can be accessed in subsequent controller actions in the chain using the <code>chainModel</code> map. This dynamic property only exists in actions following the call to the <code>chain</code> method:<p class="paragraph"/><div class="code"><pre>class ChainController &#123;<p class="paragraph"/>    def nextInChain() &#123;
        def model = chainModel.myModel
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>Like the <code>redirect</code> method you can also pass parameters to the <code>chain</code> method:<p class="paragraph"/><div class="code"><pre>chain(action: <span class="java&#45;quote">"action1"</span>, model: &#91;one: 1&#93;, params: &#91;myparam: <span class="java&#45;quote">"param1"</span>&#93;)</pre></div>
</div><p class="paragraph"/><h4>链（Chaining）</h4><p class="paragraph"/>操作同样可以作为一个链。在从一个操作传递到下个操作的时候，链一直保留着其模型。比如下面调用<code>first</code>操作的示例：<p class="paragraph"/><div class="code"><pre>class ExampleChainController &#123;<p class="paragraph"/>    def first() &#123;
        chain(action: second, model: &#91;one: 1&#93;)
    &#125;<p class="paragraph"/>    def second () &#123;
        chain(action: third, model: &#91;two: 2&#93;)
    &#125;<p class="paragraph"/>    def third() &#123;
        &#91;three: 3&#93;)
    &#125;
&#125;</pre></div><p class="paragraph"/>此模型的结果是：<p class="paragraph"/><div class="code"><pre>&#91;one: 1, two: 2, three: 3&#93;</pre></div><p class="paragraph"/>此模型可以在随后控制器的操作中通过<code>chainModel</code>映射来访问。此动态属性只存在于调用<code>chain</code>方法的操作中：<p class="paragraph"/><div class="code"><pre>class ChainController &#123;<p class="paragraph"/>    def nextInChain() &#123;
        def model = chainModel.myModel
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>根<code>redirect</code>方法一样，你可以传递参数给<code>chain</code>方法：<p class="paragraph"/><div class="code"><pre>chain(action: <span class="java&#45;quote">"action1"</span>, model: &#91;one: 1&#93;, params: &#91;myparam: <span class="java&#45;quote">"param1"</span>&#93;)</pre></div>


<a name="6.1.5 Controller Interceptors"><!-- Legacy link --></a>
<h2 id="interceptors">6.1.5 控制器拦截器</h2>
<div class="hidden-block">
Often it is useful to intercept processing based on either request, session or application state. This can be achieved with action interceptors. There are currently two types of interceptors: before and after.<p class="paragraph"/><blockquote class="note">
If your interceptor is likely to apply to more than one controller, you are almost certainly better off writing a <a href="../guide/single.html#filters" class="guide">Filter</a>. Filters can be applied to multiple controllers or URIs without the need to change the logic of each controller
</blockquote>
</div><p class="paragraph"/>通常情况下，拦截处理请求、会话或者应用的状态数据是非常有用的。这个可以通过操作的拦截器来完成。当前有两种类型的拦截器:before和after。<p class="paragraph"/><blockquote class="note">
如果你的拦截可能用于一个以上控制器的话，你最好写一个<a href="../guide/single.html#filters" class="guide">过滤器</a>。过滤器可以在不需要改变每个控制器逻辑的情况下，应用于多个控制器或者URI。
</blockquote><p class="paragraph"/><div class="hidden-block">
<h4>Before Interception</h4><p class="paragraph"/>The <code>beforeInterceptor</code> intercepts processing before the action is executed. If it returns <code>false</code> then the intercepted action will not be executed. The interceptor can be defined for all actions in a controller as follows:<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#123;
    println <span class="java&#45;quote">"Tracing action $&#123;actionUri&#125;"</span>
&#125;</pre></div><p class="paragraph"/>The above is declared inside the body of the controller definition.  It will be executed before all actions and does not interfere with processing. A common use case is very simplistic authentication:<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, except: 'login'&#93;<p class="paragraph"/>// defined with <span class="java&#45;keyword">private</span> scope, so it's not considered an action
<span class="java&#45;keyword">private</span> auth() &#123;
    <span class="java&#45;keyword">if</span> (!session.user) &#123;
        redirect(action: 'login')
        <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
    &#125;
&#125;<p class="paragraph"/>def login() &#123;
    // display login page
&#125;</pre></div><p class="paragraph"/>The above code defines a method called <code>auth</code>. A private method is used so that it is not exposed as an action to the outside world. The <code>beforeInterceptor</code> then defines an interceptor that is used on all actions  <em class="italic">except</em>  the login action and it executes the <code>auth</code> method. The <code>auth</code> method is referenced using Groovy's method pointer syntax. Within the method it detects whether there is a user in the session, and if not it redirects to the <code>login</code> action and returns <code>false</code>, causing the intercepted action to not be processed.
</div><p class="paragraph"/><h4>前拦截</h4><p class="paragraph"/><code>beforeInterceptor</code>在操作被执行以前进行拦截处理。如果其返回值是<code>false</code>，那么被拦截的操作将得不到执行。拦截对控制器的所有操作进行定义，如下所示：<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#123;
    println <span class="java&#45;quote">"Tracing action $&#123;actionUri&#125;"</span>
&#125;</pre></div><p class="paragraph"/>上述代码被声明于控制器定义的主体内。它将在每一个操作执行之前被调用，在此处并不做任何干涉。一个通用的用例就是简单地身份验证：<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, except: 'login'&#93;<p class="paragraph"/>// defined with <span class="java&#45;keyword">private</span> scope, so it's not considered an action
<span class="java&#45;keyword">private</span> auth() &#123;
    <span class="java&#45;keyword">if</span> (!session.user) &#123;
        redirect(action: 'login')
        <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
    &#125;
&#125;<p class="paragraph"/>def login() &#123;
    // display login page
&#125;</pre></div><p class="paragraph"/>上述代码定义了一个<code>auth</code>方法。这个私有方法通常用于避免被暴露为一个操作，从而也就不会被从外面访问到。接着<code>beforeInterceptor</code>定义了一个应用于所有操作的拦截器，login操作除外，此拦截器将先执行<code>auth</code>方法。<code>auth</code>方法的引用是Groovy方法的指针语法。此方法检查一个用户是否存在于会话中，如果不存在，那么将重定向到<code>login</code>操作并且返回<code>false</code>，这样那些被拦截过的操作也就不会被处理。<p class="paragraph"/><div class="hidden-block">
<h4>After Interception</h4><p class="paragraph"/>Use the <code>afterInterceptor</code> property to define an interceptor that is executed after an action:<p class="paragraph"/><div class="code"><pre>def afterInterceptor = &#123; model &#45;&#62;
    println <span class="java&#45;quote">"Tracing action $&#123;actionUri&#125;"</span>
&#125;</pre></div><p class="paragraph"/>The after interceptor takes the resulting model as an argument and can hence manipulate the model or response.<p class="paragraph"/>An after interceptor may also modify the Spring MVC <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/servlet/ModelAndView.html" class="api">ModelAndView</a> object prior to rendering. In this case, the above example becomes:<p class="paragraph"/><div class="code"><pre>def afterInterceptor = &#123; model, modelAndView &#45;&#62;
    println <span class="java&#45;quote">"Current view is $&#123;modelAndView.viewName&#125;"</span>
    <span class="java&#45;keyword">if</span> (model.someVar) modelAndView.viewName = <span class="java&#45;quote">"/mycontroller/someotherview"</span>
    println <span class="java&#45;quote">"View is now $&#123;modelAndView.viewName&#125;"</span>
&#125;</pre></div><p class="paragraph"/>This allows the view to be changed based on the model returned by the current action. Note that the <code>modelAndView</code> may be <code>null</code> if the action being intercepted called <code>redirect</code> or <code>render</code>.
</div><p class="paragraph"/><h4>后拦截</h4><p class="paragraph"/>使用<code>afterInterceptor</code>属性可以定义一个操作执行之后的拦截器：<p class="paragraph"/><div class="code"><pre>def afterInterceptor = &#123; model &#45;&#62;
    println <span class="java&#45;quote">"Tracing action $&#123;actionUri&#125;"</span>
&#125;</pre></div><p class="paragraph"/>后拦截器使用一个返回结果的model作为参数，因此也就可以操作模型和响应。<p class="paragraph"/>一个后拦截器可以在渲染之前修改Spring MVC的<a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/servlet/ModelAndView.html" class="api">ModelAndView</a>对象。此种情况下，上述的示例将变为：<p class="paragraph"/><div class="code"><pre>def afterInterceptor = &#123; model, modelAndView &#45;&#62;
    println <span class="java&#45;quote">"Current view is $&#123;modelAndView.viewName&#125;"</span>
    <span class="java&#45;keyword">if</span> (model.someVar) modelAndView.viewName = <span class="java&#45;quote">"/mycontroller/someotherview"</span>
    println <span class="java&#45;quote">"View is now $&#123;modelAndView.viewName&#125;"</span>
&#125;</pre></div><p class="paragraph"/>上述示例中，允许当前操作返回之前，可以根据模型来修改视图。不过要注意的是：如果被拦截的操作调用了<code>redirect</code>或者<code>render</code>，其<code>modelAndView</code>可能是<code>null</code>。<p class="paragraph"/><div class="hidden-block">
<h4>Interception Conditions</h4><p class="paragraph"/>Rails users will be familiar with the authentication example and how the 'except' condition was used when executing the interceptor (interceptors are called 'filters' in Rails; this terminology conflicts with Servlet filter terminology in Java):<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, except: 'login'&#93;</pre></div><p class="paragraph"/>This executes the interceptor for all actions except the specified action. A list of actions can also be defined as follows:<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, except: &#91;'login', 'register'&#93;&#93;</pre></div><p class="paragraph"/>The other supported condition is 'only', this executes the interceptor for only the specified action(s):<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, only: &#91;'secure'&#93;&#93;</pre></div>
</div><p class="paragraph"/><h4>拦截条件</h4><p class="paragraph"/>Rails用户将很熟悉验证的示例以及在执行拦截的时候如何使用'except'条件（在Rails中，拦截器被称为‘过滤器’；这个术语跟Java中Servlet的过滤器冲突）：<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, except: 'login'&#93;</pre></div><p class="paragraph"/>除了给定的操作之外，这将在所有操作之前执行拦截。操作的列表也可以被定义为如下所示：<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, except: &#91;'login', 'register'&#93;&#93;</pre></div><p class="paragraph"/>另外所支持的条件是‘only’，它将仅为特定的操作执行拦截：<p class="paragraph"/><div class="code"><pre>def beforeInterceptor = &#91;action: <span class="java&#45;keyword">this</span>.&#38;auth, only: &#91;'secure'&#93;&#93;</pre></div>


<a name="6.1.6 Data Binding"><!-- Legacy link --></a>
<h2 id="dataBinding">6.1.6 数据绑定</h2>
<div class="hidden-block">
Data binding is the act of "binding" incoming request parameters onto the properties of an object or an entire graph of objects. Data binding should deal with all necessary type conversion since request parameters, which are typically delivered by a form submission, are always strings whilst the properties of a Groovy or Java object may well not be.<p class="paragraph"/>Grails uses <a href="http://www.springframework.org" target="blank">Spring</a>'s underlying data binding capability to perform data binding.
</div><p class="paragraph"/>数据绑定是"绑定"输入的请求参数到一个对象的属性或者整个对象的行为。数据绑定将自动转换请求参数的类型，这些参数通常是通过表单提交来的String类型的值，而Groovy或者Java对象的属性很可能不是。<p class="paragraph"/>Grails是使用<a href="http://www.springframework.org" target="blank">Spring</a>的基本数据绑定能力来完成数据绑定。<p class="paragraph"/><div class="hidden-block">
<h4>Binding Request Data to the Model</h4><p class="paragraph"/>There are two ways to bind request parameters onto the properties of a domain class. The first involves using a domain classes' Map constructor:<p class="paragraph"/><div class="code"><pre>def save() &#123;
    def b = <span class="java&#45;keyword">new</span> Book(params)
    b.save()
&#125;</pre></div><p class="paragraph"/>The data binding happens within the code <code>new Book(params)</code>. By passing the <a href="../ref/Controllers/params.html" class="controllers">params</a> object to the domain class constructor Grails automatically recognizes that you are trying to bind from request parameters. So if we had an incoming request like:<p class="paragraph"/><div class="code"><pre>/book/save?title=The%20Stand&#38;author=Stephen%20King</pre></div><p class="paragraph"/>Then the <code>title</code> and <code>author</code> request parameters would automatically be set on the domain class. You can use the <a href="../ref/Domain Classes/properties.html" class="domainClasses">properties</a> property to perform data binding onto an existing instance:<p class="paragraph"/><div class="code"><pre>def save() &#123;
    def b = Book.get(params.id)
    b.properties = params
    b.save()
&#125;</pre></div><p class="paragraph"/>This has the same effect as using the implicit constructor.
</div><p class="paragraph"/><h4>绑定请求数据到领域模型</h4><p class="paragraph"/>有两种方法将请求参数绑定到一个领域类的属性上。第一个是使用领域类的构造函数，只要参数类型是Map类型即可：<p class="paragraph"/><div class="code"><pre>def save() &#123;
    def b = <span class="java&#45;keyword">new</span> Book(params)
    b.save()
&#125;</pre></div><p class="paragraph"/>数据绑定是在<code>new Book(params)</code>代码中发生的。将参数params对象传递给到领域类的构造器时，Grails就可以自动识别你正在试图绑定来自请求中的参数。因此，假设我们有一个如下面所示的输入请求：<p class="paragraph"/><div class="code"><pre>/book/save?title=The%20Stand&#38;author=Stephen%20King</pre></div><p class="paragraph"/>那么，<code>title</code>和<code>author</code>请求参数将自动被设置到领域类上。你也可以使用已经存在实例的<a href="../ref/Domain Classes/properties.html" class="domainClasses">properties</a>属性来执行数据绑定：<p class="paragraph"/><div class="code"><pre>def save() &#123;
    def b = Book.get(params.id)
    b.properties = params
    b.save()
&#125;</pre></div><p class="paragraph"/>这与使用隐式构造函数是完全一样的<p class="paragraph"/><div class="hidden-block">
<h4>Data binding and Single-ended Associations</h4><p class="paragraph"/>If you have a <code>one-to-one</code> or <code>many-to-one</code> association you can use Grails' data binding capability to update these relationships too. For example if you have an incoming request such as:<p class="paragraph"/><div class="code"><pre>/book/save?author.id=20</pre></div><p class="paragraph"/>Grails will automatically detect the <code>.id</code> suffix on the request parameter and look up the <code>Author</code> instance for the given id when doing data binding such as:<p class="paragraph"/><div class="code"><pre>def b = <span class="java&#45;keyword">new</span> Book(params)</pre></div><p class="paragraph"/>An association property can be set to <code>null</code> by passing the literal <code>String</code> "null". For example:<p class="paragraph"/><div class="code"><pre>/book/save?author.id=<span class="java&#45;keyword">null</span></pre></div>
</div><p class="paragraph"/><h4>单关联的数据绑定</h4><p class="paragraph"/>如果你有一个<code>one-to-one</code>或者<code>many-to-one</code>关联，你也可以利用Grails的数据绑定能力来更新它们，比如：<p class="paragraph"/><div class="code"><pre>/book/save?author.id=20</pre></div><p class="paragraph"/>Grails将自动检测后缀为<code>.id</code>请求参数，并且在数据绑定的时候，会查找指定id的<code>Author</code>实例，比如：<p class="paragraph"/><div class="code"><pre>def b = <span class="java&#45;keyword">new</span> Book(params)</pre></div><p class="paragraph"/>一个关联属性也可以被设置为<code>null</code>，只要传给的<code>String</code>类型的"null"即可。比如：<p class="paragraph"/><div class="code"><pre>/book/save?author.id=<span class="java&#45;keyword">null</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Data Binding and Many-ended Associations</h4><p class="paragraph"/>If you have a one-to-many or many-to-many association there are different techniques for data binding depending of the association type.<p class="paragraph"/>If you have a <code>Set</code> based association (the default for a <code>hasMany</code>) then the simplest way to populate an association is to send a list of identifiers. For example consider the usage of <code>&#60;g:select&#62;</code> below:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books"</span>
          from=<span class="xml&#45;quote">"$&#123;Book.list()&#125;"</span>
          size=<span class="xml&#45;quote">"5"</span> multiple=<span class="xml&#45;quote">"yes"</span> optionKey=<span class="xml&#45;quote">"id"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>This produces a select box that lets you select multiple values. In this case if you submit the form Grails will automatically use the identifiers from the select box to populate the <code>books</code> association.<p class="paragraph"/>However, if you have a scenario where you want to update the properties of the associated objects the this technique won't work. Instead you use the subscript operator:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;0&#93;.title"</span> value=<span class="xml&#45;quote">"the Stand"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;1&#93;.title"</span> value=<span class="xml&#45;quote">"the Shining"</span> /&#62;</span></pre></div><p class="paragraph"/>However, with <code>Set</code> based association it is critical that you render the mark-up in the same order that you plan to do the update in. This is because a <code>Set</code> has no concept of order, so although we're referring to <code>books0</code> and <code>books1</code> it is not guaranteed that the order of the association will be correct on the server side unless you apply some explicit sorting yourself.<p class="paragraph"/>This is not a problem if you use <code>List</code> based associations, since a <code>List</code> has a defined order and an index you can refer to. This is also true of <code>Map</code> based associations.<p class="paragraph"/>Note also that if the association you are binding to has a size of two and you refer to an element that is outside the size of association:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;0&#93;.title"</span> value=<span class="xml&#45;quote">"the Stand"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;1&#93;.title"</span> value=<span class="xml&#45;quote">"the Shining"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;2&#93;.title"</span> value=<span class="xml&#45;quote">"Red Madder"</span> /&#62;</span></pre></div><p class="paragraph"/>Then Grails will automatically create a new instance for you at the defined position. If you "skipped" a few elements in the middle:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;0&#93;.title"</span> value=<span class="xml&#45;quote">"the Stand"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;1&#93;.title"</span> value=<span class="xml&#45;quote">"the Shining"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;5&#93;.title"</span> value=<span class="xml&#45;quote">"Red Madder"</span> /&#62;</span></pre></div><p class="paragraph"/>Then Grails will automatically create instances in between. For example in the above case Grails will create 4 additional instances if the association being bound had a size of 2.<p class="paragraph"/>You can bind existing instances of the associated type to a <code>List</code> using the same <code>.id</code> syntax as you would use with a single-ended association. For example:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;0&#93;.id"</span> from=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;0&#93;?.id&#125;"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;1&#93;.id"</span> from=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;1&#93;?.id&#125;"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;2&#93;.id"</span> from=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;2&#93;?.id&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>Would allow individual entries in the <code>books List</code> to be selected separately.<p class="paragraph"/>Entries at particular indexes can be removed in the same way too. For example:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;0&#93;.id"</span>
          from=<span class="xml&#45;quote">"$&#123;Book.list()&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;0&#93;?.id&#125;"</span>
          noSelection=<span class="xml&#45;quote">"&#91;'null': ''&#93;"</span>/&#62;</span></pre></div><p class="paragraph"/>Will render a select box that will remove the association at <code>books0</code> if the empty option is chosen.<p class="paragraph"/>Binding to a <code>Map</code> property works the same way except that the list index in the parameter name is replaced by the map key:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"images&#91;cover&#93;.id"</span>
          from=<span class="xml&#45;quote">"$&#123;Image.list()&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;book?.images&#91;cover&#93;?.id&#125;"</span>
          noSelection=<span class="xml&#45;quote">"&#91;'null': ''&#93;"</span>/&#62;</span></pre></div><p class="paragraph"/>This would bind the selected image into the <code>Map</code> property <code>images</code> under a key of <code>"cover"</code>.
</div><p class="paragraph"/><h4>多关联的数据绑定</h4><p class="paragraph"/>如果你有一个one-to-many或者many-to-many的关联，那么根据关联类型的不同，将对应不同的数据绑定技术。<p class="paragraph"/>如果你使用基于<code>Set</code>的关联（<code>hasMany</code>缺省就是此种关联），那么最简单的方法就是传递一个标识符列表。比如下边<code>&#60;g:select&#62;</code>的用法：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books"</span>
          from=<span class="xml&#45;quote">"$&#123;Book.list()&#125;"</span>
          size=<span class="xml&#45;quote">"5"</span> multiple=<span class="xml&#45;quote">"yes"</span> optionKey=<span class="xml&#45;quote">"id"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>这将产生一个允许选择多个值的下拉框／选择框（select box）。上例中，如果你提交表单的话，Grails根据选择框的传来的标识符来自动关联<code>books</code>。<p class="paragraph"/>即便如此，类似的情况下，你想使用此技术来更新关联对象饿属性，将行不通。不过你可以通过下标（subscript）操作符的方式来实现，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;0&#93;.title"</span> value=<span class="xml&#45;quote">"the Stand"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;1&#93;.title"</span> value=<span class="xml&#45;quote">"the Shining"</span> /&#62;</span></pre></div><p class="paragraph"/>此外，基于<code>Set</code>的关联还是有一个严重问题，那就是你要更新的内容总是以同样的顺序渲染的，这是因为<code>Set</code>本来就没有顺序的概念，虽然你可以通过<code>books0</code>和<code>books1</code>来索引，但这并不能保证其关联顺序在服务器端也一致，当然你可以通过明确指定排序来比避免。<p class="paragraph"/>如果你使用基于<code>List</code>的关联的话，这并不是问题，因为<code>List</code>已经是有序的，并且可以通过索引进行引用。基于<code>Map</code>的关联也是。<p class="paragraph"/>还要注意的是，如果你正在绑定的关联是有大小的，最外侧的那个元素所在位置就是关联的大小：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;0&#93;.title"</span> value=<span class="xml&#45;quote">"the Stand"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;1&#93;.title"</span> value=<span class="xml&#45;quote">"the Shining"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;2&#93;.title"</span> value=<span class="xml&#45;quote">"Red Madder"</span> /&#62;</span></pre></div><p class="paragraph"/>Grails将在你定义的位置自动创建一个实例。如果你中间“跳过”一些元素，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;0&#93;.title"</span> value=<span class="xml&#45;quote">"the Stand"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;1&#93;.title"</span> value=<span class="xml&#45;quote">"the Shining"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"books&#91;5&#93;.title"</span> value=<span class="xml&#45;quote">"Red Madder"</span> /&#62;</span></pre></div><p class="paragraph"/>Grails将会自动创建中间跳过的实例。在上述示例中，关联的边界大小是2,Grails将在此基础上创建4个额外的实例。<p class="paragraph"/>你也可以使用和单关联那样的<code>.id</code>语法来绑定类型是<code>List</code>且已存在的关联，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;0&#93;.id"</span> from=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;0&#93;?.id&#125;"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;1&#93;.id"</span> from=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;1&#93;?.id&#125;"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;2&#93;.id"</span> from=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;2&#93;?.id&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>将允许<code>books List</code>中各自独立的实体分别进行选择。<p class="paragraph"/>同样的方法也可以用来删除特定的索引元素，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"books&#91;0&#93;.id"</span>
          from=<span class="xml&#45;quote">"$&#123;Book.list()&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;author?.books&#91;0&#93;?.id&#125;"</span>
          noSelection=<span class="xml&#45;quote">"&#91;'null': ''&#93;"</span>/&#62;</span></pre></div><p class="paragraph"/>将渲染一个可以删除关联<code>books0</code>的下拉框，当然只有选择项是空的时候才行。<p class="paragraph"/>绑定到<code>Map</code>属性的工作方式也是如此，不过要将参数名称中的列表索引替换为映射（map）的键（key）：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:select name=<span class="xml&#45;quote">"images&#91;cover&#93;.id"</span>
          from=<span class="xml&#45;quote">"$&#123;Image.list()&#125;"</span>
          value=<span class="xml&#45;quote">"$&#123;book?.images&#91;cover&#93;?.id&#125;"</span>
          noSelection=<span class="xml&#45;quote">"&#91;'null': ''&#93;"</span>/&#62;</span></pre></div><p class="paragraph"/>会将选择的图片通过键<code>"cover"</code>绑定到<code>Map</code>类型的<code>images</code>中。<p class="paragraph"/><div class="hidden-block">
<h4>Data binding with Multiple domain classes</h4><p class="paragraph"/>It is possible to bind data to multiple domain objects from the <a href="../ref/Controllers/params.html" class="controllers">params</a> object.<p class="paragraph"/>For example so you have an incoming request to:<p class="paragraph"/><div class="code"><pre>/book/save?book.title=The%20Stand&#38;author.name=Stephen%20King</pre></div><p class="paragraph"/>You'll notice the difference with the above request is that each parameter has a prefix such as <code>author.</code> or <code>book.</code> which is used to isolate which parameters belong to which type. Grails' <code>params</code> object is like a multi-dimensional hash and you can index into it to isolate only a subset of the parameters to bind.<p class="paragraph"/><div class="code"><pre>def b = <span class="java&#45;keyword">new</span> Book(params.book)</pre></div><p class="paragraph"/>Notice how we use the prefix before the first dot of the <code>book.title</code> parameter to isolate only parameters below this level to bind. We could do the same with an <code>Author</code> domain class:<p class="paragraph"/><div class="code"><pre>def a = <span class="java&#45;keyword">new</span> Author(params.author)</pre></div>
</div><p class="paragraph"/><h4>多领域类的数据绑定</h4><p class="paragraph"/>通过<a href="../ref/Controllers/params.html" class="controllers">params</a>对象，是有可能将将数据绑定到多个领域对象的。<p class="paragraph"/>比如下面的输入请求：<p class="paragraph"/><div class="code"><pre>/book/save?book.title=The%20Stand&#38;author.name=Stephen%20King</pre></div><p class="paragraph"/>你将会注意到上述请求的差异，即每一个参数都有一个前缀，比如<code>author.</code>或者<code>book.</code> ，它们通常用来隔离参数所属的类型。Grails的<code>params</code>对象更象是一个多维的哈希表（hash），你可以单独地只绑定参数的一个子集。<p class="paragraph"/><div class="code"><pre>def b = <span class="java&#45;keyword">new</span> Book(params.book)</pre></div><p class="paragraph"/>请注意我们是如何利用<code>book.title</code>参数的前缀（第一个点以前部分）来隔离此领域的子参数的。同样我们也可以用于领域类<code>Author</code>：<p class="paragraph"/><div class="code"><pre>def a = <span class="java&#45;keyword">new</span> Author(params.author)</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Data Binding and Action Arguments</h4><p class="paragraph"/>Controller action arguments are subject to request parameter data binding.  There are 2 categories of controller action arguments.  The first category is command objects.  Complex types are treated as command objects.  See the <a href="../guide/single.html#commandObjects" class="guide">Command Objects</a> section of the user guide for details.  The other category is basic object types.  Supported types are the 8 primitives, their corresponding type wrappers and <a href="http://download.oracle.com/javase/1.5.0/docs/api/java/lang/String.html" class="api">java.lang.String</a>.  The default behavior is to map request parameters to action arguments by name:<p class="paragraph"/><div class="code"><pre>class AccountingController &#123;<p class="paragraph"/>   // accountNumber will be initialized with the value of params.accountNumber
   // accountType will be initialized with params.accountType
   def displayInvoice(<span class="java&#45;object">String</span> accountNumber, <span class="java&#45;object">int</span> accountType) &#123;
       // &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>For primitive arguments and arguments which are instances of any of the primitive type wrapper classes a type conversion has to be carried out before the request parameter value can be bound to the action argument.  The type conversion happens automatically.  In a case like the example shown above, the <code>params.accountType</code> request parameter has to be converted to an <code>int</code>.  If type conversion fails for any reason, the argument will have its default value per normal Java behavior (null for type wrapper references, false for booleans and zero for numbers) and a corresponding error will be added to the <code>errors</code> property of the defining controller.<p class="paragraph"/><div class="code"><pre>/accounting/displayInvoice?accountNumber=B59786&#38;accountType=bogusValue</pre></div><p class="paragraph"/>Since "bogusValue" cannot be converted to type int, the value of accountType will be zero, <code>controller.errors.hasErrors()</code> will be true, <code>controller.errors.errorCount</code> will be equal to 1 and <code>controller.errors.getFieldError('accountType')</code> will contain the corresponding error.<p class="paragraph"/>If the argument name does not match the name of the request parameter then the <code>&#64;grails.web.RequestParameter</code> annotation may be applied to an argument to express the name of the request parameter which should be bound to that argument:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.web.RequestParameter<p class="paragraph"/>class AccountingController &#123;<p class="paragraph"/>   // mainAccountNumber will be initialized with the value of params.accountNumber
   // accountType will be initialized with params.accountType
   def displayInvoice(@RequestParameter('accountNumber') <span class="java&#45;object">String</span> mainAccountNumber, <span class="java&#45;object">int</span> accountType) &#123;
       // &#8230;
   &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>数据绑定和操作参数</h4><p class="paragraph"/>控制器的操作参数是绑定请求参数的主题，目前主要有2大类的操作参数。第一大类是命令对象，复杂类型的都被看作命令对象，更多详细请看本手册的<a href="../guide/single.html#commandObjects" class="guide">命令对象</a>章节。另外一大类是基本的对象类型，所支持的类型包括8个原生类型及其对应的包装类和<a href="http://download.oracle.com/javase/1.5.0/docs/api/java/lang/String.html" class="api">java.lang.String</a>。缺省情况下，从请求参数到操作参数的映射是通过名称来完成的，比如：<p class="paragraph"/><div class="code"><pre>class AccountingController &#123;<p class="paragraph"/>   // accountNumber will be initialized with the value of params.accountNumber
   // accountType will be initialized with params.accountType
   def displayInvoice(<span class="java&#45;object">String</span> accountNumber, <span class="java&#45;object">int</span> accountType) &#123;
       // &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>对于参数是原生类型和其包装类实例来说，在请求参数要绑定到操作参数以前，是要执行一个类型转换的，不过此转换是自动完成的。以上述示例为例，请求参数<code>params.accountType</code>必须要转换成<code>int</code>才行。如果此转换失败了，不管什么原因导致，此参数将根据普通的Java行为进行设置（包装类是null，布尔类型是false，数字类型是0），并且产生一个相应的错误信息到控制器的<code>errors</code>属性中。<p class="paragraph"/><div class="code"><pre>/accounting/displayInvoice?accountNumber=B59786&#38;accountType=bogusValue</pre></div><p class="paragraph"/>因为"bogusValue"不能被转换为int，所以accountType的值为0 ，而<code>controller.errors.hasErrors()</code>将返回true，<code>controller.errors.errorCount</code>的数值是1，并且<code>controller.errors.getFieldError('accountType')</code>将包含其对应的出错信息。<p class="paragraph"/>如果参数名称跟请求参数的名称并不匹配，那么可以使用<code>&#64;grails.web.RequestParameter</code>注解解决，只需要将要转换的请求参数名传递给注解即可：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.web.RequestParameter<p class="paragraph"/>class AccountingController &#123;<p class="paragraph"/>   // mainAccountNumber will be initialized with the value of params.accountNumber
   // accountType will be initialized with params.accountType
   def displayInvoice(@RequestParameter('accountNumber') <span class="java&#45;object">String</span> mainAccountNumber, <span class="java&#45;object">int</span> accountType) &#123;
       // &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Data binding and type conversion errors</h4><p class="paragraph"/>Sometimes when performing data binding it is not possible to convert a particular String into a particular target type. This results in a type conversion error. Grails will retain type conversion errors inside the <a href="../ref/Domain Classes/errors.html" class="domainClasses">errors</a> property of a Grails domain class. For example:<p class="paragraph"/><div class="code"><pre>class Book &#123;
    &#8230;
    URL publisherURL
&#125;</pre></div><p class="paragraph"/>Here we have a domain class <code>Book</code> that uses the <code>java.net.URL</code> class to represent URLs. Given an incoming request such as:<p class="paragraph"/><div class="code"><pre>/book/save?publisherURL=a&#45;bad&#45;url</pre></div><p class="paragraph"/>it is not possible to bind the string <code>a-bad-url</code> to the <code>publisherURL</code> property as a type mismatch error occurs. You can check for these like this:<p class="paragraph"/><div class="code"><pre>def b = <span class="java&#45;keyword">new</span> Book(params)<p class="paragraph"/><span class="java&#45;keyword">if</span> (b.hasErrors()) &#123;
    println <span class="java&#45;quote">"The value $&#123;b.errors.getFieldError('publisherURL').rejectedValue&#125;"</span> +
            <span class="java&#45;quote">" is not a valid URL!"</span>
&#125;</pre></div><p class="paragraph"/>Although we have not yet covered error codes (for more information see the section on <a href="../guide/single.html#validation" class="guide">Validation</a>), for type conversion errors you would want a message from the <code>grails-app/i18n/messages.properties</code> file to use for the error. You can use a generic error message handler such as:<p class="paragraph"/><div class="code"><pre>typeMismatch.java.net.URL=The field &#123;0&#125; is not a valid URL</pre></div><p class="paragraph"/>Or a more specific one:<p class="paragraph"/><div class="code"><pre>typeMismatch.Book.publisherURL=The publisher URL you specified is not a valid URL</pre></div>
</div><p class="paragraph"/><h4>数据绑定和类型转换错误</h4><p class="paragraph"/>有时，在执行数据绑定时，可能不会把一个特殊的String转换到特殊的目标类型。这样，你就得到一个类型转换错误。Grails将类型转换错误保存到领域类的<a href="../ref/Domain Classes/errors.html" class="domainClasses">errors</a>属性中。比如：：<p class="paragraph"/><div class="code"><pre>class Book &#123;
    &#8230;
    URL publisherURL
&#125;</pre></div><p class="paragraph"/>此处，我们拥有一个领域类<code>Book</code>，它使用了类<code>java.net.URL</code>来存储URLs。现在假设请求如下：<p class="paragraph"/><div class="code"><pre>/book/save?publisherURL=a&#45;bad&#45;url</pre></div><p class="paragraph"/>要将字符串<code>a-bad-url</code>绑定到<code>publisherURL</code>属性是不可能的，因为发生了类型不匹配的错误。你可以象下面那样进行检查：<p class="paragraph"/><div class="code"><pre>def b = <span class="java&#45;keyword">new</span> Book(params)<p class="paragraph"/><span class="java&#45;keyword">if</span> (b.hasErrors()) &#123;
    println <span class="java&#45;quote">"The value $&#123;b.errors.getFieldError('publisherURL').rejectedValue&#125;"</span> +
            <span class="java&#45;quote">" is not a valid URL!"</span>
&#125;</pre></div><p class="paragraph"/>虽然我们还没有涉及到错误编码（更多信息请参考<a href="../guide/single.html#validation" class="guide">校验</a>章节），但对于类型转换错误，还是推荐你使用<code>grails-app/i18n/messages.properties</code>文件来定义错误信息。你可以使用通用的错误消息处理，比如：<p class="paragraph"/><div class="code"><pre>typeMismatch.java.net.URL=The field &#123;0&#125; is not a valid URL</pre></div><p class="paragraph"/>或者更准确地指定：<p class="paragraph"/><div class="code"><pre>typeMismatch.Book.publisherURL=The publisher URL you specified is not a valid URL</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Data Binding and Security concerns</h4><p class="paragraph"/>When batch updating properties from request parameters you need to be careful not to allow clients to bind malicious data to domain classes and be persisted in the database. You can limit what properties are bound to a given domain class using the subscript operator:<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)<p class="paragraph"/>p.properties&#91;'firstName','lastName'&#93; = params</pre></div><p class="paragraph"/>In this case only the <code>firstName</code> and <code>lastName</code> properties will be bound.<p class="paragraph"/>Another way to do this is is to use <a href="../guide/single.html#commandObjects" class="guide">Command Objects</a> as the target of data binding instead of domain classes. Alternatively there is also the flexible <a href="../ref/Controllers/bindData.html" class="controllers">bindData</a> method.<p class="paragraph"/>The <code>bindData</code> method allows the same data binding capability, but to arbitrary objects:<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person()
bindData(p, params)</pre></div><p class="paragraph"/>The <code>bindData</code> method also lets you exclude certain parameters that you don't want updated:<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person()
bindData(p, params, &#91;exclude: 'dateOfBirth'&#93;)</pre></div><p class="paragraph"/>Or include only certain properties:<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person()
bindData(p, params, &#91;include: &#91;'firstName', 'lastName&#93;&#93;)</pre></div><p class="paragraph"/><blockquote class="note">
Note that if an empty List is provided as a value for the <code>include</code> parameter then all fields will be subject to binding if they are not explicitly excluded.
</blockquote>
</div><p class="paragraph"/><h4>数据绑定和安全</h4><p class="paragraph"/>当从请求参数进行批量地更新领域类地属性时，你要当心，绝不允许让用户的恶意数据绑定到领域类，并且持久化到数据库中。你可以使用下标操作符来限制那些属性可以被绑定到给定的领域类：<p class="paragraph"/><div class="code"><pre>def p = Person.get(1)<p class="paragraph"/>p.properties&#91;'firstName','lastName'&#93; = params</pre></div><p class="paragraph"/>此处，只有<code>firstName</code>和<code>lastName</code>属性将被绑定。<p class="paragraph"/>另外一种方法是使用<a href="../guide/single.html#commandObjects" class="guide">命令对象</a>来替代领域类进行数据绑定。或者使用更灵活的<a href="../ref/Controllers/bindData.html" class="controllers">bindData</a>方法来绑定。<p class="paragraph"/><code>bindData</code>方法具有同样的数据绑定能力，不过可以是任意对象：<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person()
bindData(p, params)</pre></div><p class="paragraph"/><code>bindData</code>方法还可以排除那些你不想更新的某些参数／属性：<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person()
bindData(p, params, &#91;exclude: 'dateOfBirth'&#93;)</pre></div><p class="paragraph"/>或者仅仅包含某些属性：<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person()
bindData(p, params, &#91;include: &#91;'firstName', 'lastName&#93;&#93;)</pre></div><p class="paragraph"/><blockquote class="note">
注意！如果<code>include</code>参数值是一个空的列表，并且没有指定排除的话，那么所有的字段属性将被绑定。
</blockquote>



<h2 id="xmlAndJSON">6.1.7 XML和JSON响应</h2>
<div class="hidden-block">
<h4>Using the render method to output XML</h4><p class="paragraph"/>Grails supports a few different ways to produce XML and JSON responses. The first is the <a href="../ref/Controllers/render.html" class="controllers">render</a> method.<p class="paragraph"/>The <code>render</code> method can be passed a block of code to do mark-up building in XML:<p class="paragraph"/><div class="code"><pre>def list() &#123;<p class="paragraph"/>    def results = Book.list()<p class="paragraph"/>    render(contentType: <span class="java&#45;quote">"text/xml"</span>) &#123;
        books &#123;
            <span class="java&#45;keyword">for</span> (b in results) &#123;
                book(title: b.title)
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>The result of this code would be something like:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;books&#62;</span>
    <span class="xml&#45;tag">&#60;book title=<span class="xml&#45;quote">"The Stand"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;book title=<span class="xml&#45;quote">"The Shining"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/books&#62;</span></pre></div><p class="paragraph"/>Be careful to avoid naming conflicts when using mark-up building. For example this code would produce an error:<p class="paragraph"/><div class="code"><pre>def list() &#123;<p class="paragraph"/>    def books = Book.list()  // naming conflict here<p class="paragraph"/>    render(contentType: <span class="java&#45;quote">"text/xml"</span>) &#123;
        books &#123;
            <span class="java&#45;keyword">for</span> (b in results) &#123;
                book(title: b.title)
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>This is because there is local variable <code>books</code> which Groovy attempts to invoke as a method.
</div><p class="paragraph"/><h4>使用render方法输出XML</h4><p class="paragraph"/>Grails支持几种不同的方法来产生XML和JSON响应。第一个就是<a href="../ref/Controllers/render.html" class="controllers">render</a>方法。<p class="paragraph"/><code>render</code>方法可以被传递一个代码块，在代码块中，使用标签生成器来构建XML：<p class="paragraph"/><div class="code"><pre>def list() &#123;<p class="paragraph"/>    def results = Book.list()<p class="paragraph"/>    render(contentType: <span class="java&#45;quote">"text/xml"</span>) &#123;
        books &#123;
            <span class="java&#45;keyword">for</span> (b in results) &#123;
                book(title: b.title)
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>这段代码的结果将会像下面这样：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;books&#62;</span>
    <span class="xml&#45;tag">&#60;book title=<span class="xml&#45;quote">"The Stand"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;book title=<span class="xml&#45;quote">"The Shining"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/books&#62;</span></pre></div><p class="paragraph"/>注意！要避免根标签生成器的命名冲突。比如，下面的代码将会产生一个错误：<p class="paragraph"/><div class="code"><pre>def list() &#123;<p class="paragraph"/>    def books = Book.list()  // naming conflict here<p class="paragraph"/>    render(contentType: <span class="java&#45;quote">"text/xml"</span>) &#123;
        books &#123;
            <span class="java&#45;keyword">for</span> (b in results) &#123;
                book(title: b.title)
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>这是因为Groovy的本地变量<code>books</code>试图被当作一个方法来调用。<p class="paragraph"/><div class="hidden-block">
<h4>Using the render method to output JSON</h4><p class="paragraph"/>The <code>render</code> method can also be used to output JSON:<p class="paragraph"/><div class="code"><pre>def list() &#123;<p class="paragraph"/>    def results = Book.list()<p class="paragraph"/>    render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
        books = array &#123;
            <span class="java&#45;keyword">for</span> (b in results) &#123;
                book title: b.title
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case the result would be something along the lines of:<p class="paragraph"/><div class="code"><pre>&#91;
    &#123;title:<span class="java&#45;quote">"The Stand"</span>&#125;,
    &#123;title:<span class="java&#45;quote">"The Shining"</span>&#125;
&#93;</pre></div><p class="paragraph"/>The same dangers with naming conflicts described above for XML also apply to JSON building.
</div><p class="paragraph"/><h4>使用render方法输出JSON</h4><p class="paragraph"/><code>render</code>方法也可以被用来输出JSON：<p class="paragraph"/><div class="code"><pre>def list() &#123;<p class="paragraph"/>    def results = Book.list()<p class="paragraph"/>    render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
        books = array &#123;
            <span class="java&#45;keyword">for</span> (b in results) &#123;
                book title: b.title
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>上述示例的结果输出如下几行的所示：<p class="paragraph"/><div class="code"><pre>&#91;
    &#123;title:<span class="java&#45;quote">"The Stand"</span>&#125;,
    &#123;title:<span class="java&#45;quote">"The Shining"</span>&#125;
&#93;</pre></div><p class="paragraph"/>注意！上面XML命名冲突的危险同样适用于JSON。<p class="paragraph"/><div class="hidden-block">
<h4>Automatic XML Marshalling</h4><p class="paragraph"/>Grails also supports automatic marshalling of <a href="../guide/single.html#GORM" class="guide">domain classes</a> to XML using special converters.<p class="paragraph"/>To start off with, import the <code>grails.converters</code> package into your controller:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.&#42;</pre></div><p class="paragraph"/>Now you can use the following highly readable syntax to automatically convert domain classes to XML:<p class="paragraph"/><div class="code"><pre>render Book.list() as XML</pre></div><p class="paragraph"/>The resulting output would look something like the following::<p class="paragraph"/><div class="code"><pre>&#60;?xml version=<span class="java&#45;quote">"1.0"</span> encoding=<span class="java&#45;quote">"ISO&#45;8859&#45;1"</span>?&#62;
&#60;list&#62;
  &#60;book id=<span class="java&#45;quote">"1"</span>&#62;
    &#60;author&#62;Stephen King&#60;/author&#62;
    &#60;title&#62;The Stand&#60;/title&#62;
  &#60;/book&#62;
  &#60;book id=<span class="java&#45;quote">"2"</span>&#62;
    &#60;author&#62;Stephen King&#60;/author&#62;
    &#60;title&#62;The Shining&#60;/title&#62;
  &#60;/book&#62;
&#60;/list&#62;</pre></div><p class="paragraph"/>An alternative to using the converters is to use the <a href="../guide/single.html#codecs" class="guide">codecs</a> feature of Grails. The codecs feature provides <a href="../guide/single.html#codecs" class="guide">encodeAsXML</a> and <a href="../guide/single.html#codecs" class="guide">encodeAsJSON</a> methods:<p class="paragraph"/><div class="code"><pre>def xml = Book.list().encodeAsXML()
render xml</pre></div><p class="paragraph"/>For more information on XML marshalling see the section on <a href="../guide/single.html#REST" class="guide">REST</a>
</div><p class="paragraph"/><h4>自动XML编组（Marshalling）</h4><p class="paragraph"/>Grails还支持将<a href="../guide/single.html#GORM" class="guide">领域类</a>自动编组为XML的用法，不过要借助于特定的转换器。<p class="paragraph"/>首先，要先在你的控制器中的导入包<code>grails.converters</code>：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.&#42;</pre></div><p class="paragraph"/>现在，你可以使用如下易读性高的语法来将领域类自动转换成XML：<p class="paragraph"/><div class="code"><pre>render Book.list() as XML</pre></div><p class="paragraph"/>上述的输出结果看起来如下所示：<p class="paragraph"/><div class="code"><pre>&#60;?xml version=<span class="java&#45;quote">"1.0"</span> encoding=<span class="java&#45;quote">"ISO&#45;8859&#45;1"</span>?&#62;
&#60;list&#62;
  &#60;book id=<span class="java&#45;quote">"1"</span>&#62;
    &#60;author&#62;Stephen King&#60;/author&#62;
    &#60;title&#62;The Stand&#60;/title&#62;
  &#60;/book&#62;
  &#60;book id=<span class="java&#45;quote">"2"</span>&#62;
    &#60;author&#62;Stephen King&#60;/author&#62;
    &#60;title&#62;The Shining&#60;/title&#62;
  &#60;/book&#62;
&#60;/list&#62;</pre></div><p class="paragraph"/>另外一种转换器的用法是使用Grails的<a href="../guide/single.html#codecs" class="guide">编码（codecs）</a>功能。此功能提供了<a href="../guide/single.html#codecs" class="guide">encodeAsXML</a>和<a href="../guide/single.html#codecs" class="guide">encodeAsJSON</a>方法：<p class="paragraph"/><div class="code"><pre>def xml = Book.list().encodeAsXML()
render xml</pre></div><p class="paragraph"/>更多关于XML编组信息请参考<a href="../guide/single.html#REST" class="guide">REST</a>章节<p class="paragraph"/><div class="hidden-block">
<h4>Automatic JSON Marshalling</h4><p class="paragraph"/>Grails also supports automatic marshalling to JSON using the same mechanism. Simply substitute <code>XML</code> with <code>JSON</code>:<p class="paragraph"/><div class="code"><pre>render Book.list() as JSON</pre></div><p class="paragraph"/>The resulting output would look something like the following:<p class="paragraph"/><div class="code"><pre>&#91;
    &#123;<span class="java&#45;quote">"id"</span>:1,
     <span class="java&#45;quote">"class"</span>:<span class="java&#45;quote">"Book"</span>,
     <span class="java&#45;quote">"author"</span>:<span class="java&#45;quote">"Stephen King"</span>,
     <span class="java&#45;quote">"title"</span>:<span class="java&#45;quote">"The Stand"</span>&#125;,
    &#123;<span class="java&#45;quote">"id"</span>:2,
     <span class="java&#45;quote">"class"</span>:<span class="java&#45;quote">"Book"</span>,
     <span class="java&#45;quote">"author"</span>:<span class="java&#45;quote">"Stephen King"</span>,
     <span class="java&#45;quote">"releaseDate"</span>:<span class="java&#45;keyword">new</span> Date(1194127343161),
     <span class="java&#45;quote">"title"</span>:<span class="java&#45;quote">"The Shining"</span>&#125;
 &#93;</pre></div><p class="paragraph"/>Again as an alternative you can use the <code>encodeAsJSON</code> to achieve the same effect.
</div><p class="paragraph"/><h4>自动JSON编组</h4><p class="paragraph"/>Grails同样也支持自动JSON编组的功能，这跟XML机制完全相同，因此只需要简单地将<code>XML</code>替换为<code>JSON</code>即可：<p class="paragraph"/><div class="code"><pre>render Book.list() as JSON</pre></div><p class="paragraph"/>其输出结果看起来如下所示：<p class="paragraph"/><div class="code"><pre>&#91;
    &#123;<span class="java&#45;quote">"id"</span>:1,
     <span class="java&#45;quote">"class"</span>:<span class="java&#45;quote">"Book"</span>,
     <span class="java&#45;quote">"author"</span>:<span class="java&#45;quote">"Stephen King"</span>,
     <span class="java&#45;quote">"title"</span>:<span class="java&#45;quote">"The Stand"</span>&#125;,
    &#123;<span class="java&#45;quote">"id"</span>:2,
     <span class="java&#45;quote">"class"</span>:<span class="java&#45;quote">"Book"</span>,
     <span class="java&#45;quote">"author"</span>:<span class="java&#45;quote">"Stephen King"</span>,
     <span class="java&#45;quote">"releaseDate"</span>:<span class="java&#45;keyword">new</span> Date(1194127343161),
     <span class="java&#45;quote">"title"</span>:<span class="java&#45;quote">"The Shining"</span>&#125;
 &#93;</pre></div><p class="paragraph"/>跟上面一样，你也可以使用<code>encodeAsJSON</code>来达到相同的效果。


<a name="6.1.8 More on JSONBuilder"><!-- Legacy link --></a>
<h2 id="moreOnJSONBuilder">6.1.8 关于JSONBuilder</h2>
<div class="hidden-block">
The previous section on on XML and JSON responses covered simplistic examples of rendering XML and JSON responses. Whilst the XML builder used by Grails is the standard <a href="http://groovy.codehaus.org/Reading+XML+using+Groovy's+XmlSlurper" target="blank">XmlSlurper</a> found in Groovy, the JSON builder is a custom implementation specific to Grails.<p class="paragraph"/><h4>JSONBuilder and Grails versions</h4><p class="paragraph"/>JSONBuilder behaves different depending on the version of Grails you use. For version below 1.2 the deprecated <a href="../../api/grails/web/JSONBuilder.html" class="api">grails.web.JSONBuilder</a> class is used. This section covers the usage of the Grails 1.2 JSONBuilder<p class="paragraph"/>For backwards compatibility the old <code>JSONBuilder</code> class is used with the <code>render</code> method for older applications; to use the newer/better <code>JSONBuilder</code> class set the following in <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.json.legacy.builder = <span class="java&#45;keyword">false</span></pre></div>
</div><p class="paragraph"/>在以前关于XML和JSON响应的章节中，我们曾经简单地涉猎到渲染XML和JSON响应的例子。而Grails的XML生成器是Groovy标准的 <a href="http://groovy.codehaus.org/Reading+XML+using+Groovy's+XmlSlurper" target="blank">XmlSlurper</a> ，JSON生成器是Grails自己实现的一个规范。<p class="paragraph"/><h4>JSONBuilder和Grails版本</h4><p class="paragraph"/>JSONBuilder的行为根据你使用的Grails版本而有所不同。对于版本低于1.2，使用的是可以被废弃的<a href="../../api/grails/web/JSONBuilder.html" class="api">grails.web.JSONBuilder</a>类。本节将涉及到Grails 1.2 JSONBuilder的用法。<p class="paragraph"/>因为要兼容以前版本的原因，旧的<code>JSONBuilder</code>类被用于旧应用的<code>render</code>方法；而要使用更新更好的<code>JSONBuilder</code>类，需要在<code>Config.groovy</code>中做如下设置：<p class="paragraph"/><div class="code"><pre>grails.json.legacy.builder = <span class="java&#45;keyword">false</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Rendering Simple Objects</h4><p class="paragraph"/>To render a simple JSON object just set properties within the context of the Closure:<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    hello = <span class="java&#45;quote">"world"</span>
&#125;</pre></div><p class="paragraph"/>The above will produce the JSON:<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"hello"</span>:<span class="java&#45;quote">"world"</span>&#125;</pre></div>
</div><p class="paragraph"/><h4>渲染简单对象</h4><p class="paragraph"/>要渲染简单的JSON对象，只需要在闭包的上下内设置属性即可：<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    hello = <span class="java&#45;quote">"world"</span>
&#125;</pre></div><p class="paragraph"/>上述将产生如下JSON输出：<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"hello"</span>:<span class="java&#45;quote">"world"</span>&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Rendering JSON Arrays</h4><p class="paragraph"/>To render a list of objects simple assign a list:<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91;'a', 'b', 'c'&#93;
&#125;</pre></div><p class="paragraph"/>This will produce:<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"categories"</span>:&#91;<span class="java&#45;quote">"a"</span>,<span class="java&#45;quote">"b"</span>,<span class="java&#45;quote">"c"</span>&#93;&#125;</pre></div><p class="paragraph"/>You can also render lists of complex objects, for example:<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91; &#123; a = <span class="java&#45;quote">"A"</span> &#125;, &#123; b = <span class="java&#45;quote">"B"</span> &#125; &#93;
&#125;</pre></div><p class="paragraph"/>This will produce:<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"categories"</span>:&#91; &#123;<span class="java&#45;quote">"a"</span>:<span class="java&#45;quote">"A"</span>&#125; , &#123;<span class="java&#45;quote">"b"</span>:<span class="java&#45;quote">"B"</span>&#125;&#93; &#125;</pre></div><p class="paragraph"/>Use the special <code>element</code> method to return a list as the root:<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    element 1
    element 2
    element 3
&#125;</pre></div><p class="paragraph"/>The above code produces:<p class="paragraph"/><div class="code"><pre>&#91;1,2,3&#93;</pre></div>
</div><p class="paragraph"/><h4>渲染JSON数组</h4><p class="paragraph"/>要渲染一个对象的列表，只需要简单给其赋值一个列表即可：<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91;'a', 'b', 'c'&#93;
&#125;</pre></div><p class="paragraph"/>这将输出：<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"categories"</span>:&#91;<span class="java&#45;quote">"a"</span>,<span class="java&#45;quote">"b"</span>,<span class="java&#45;quote">"c"</span>&#93;&#125;</pre></div><p class="paragraph"/>你也可以渲染复杂对象的列表，比如：<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91; &#123; a = <span class="java&#45;quote">"A"</span> &#125;, &#123; b = <span class="java&#45;quote">"B"</span> &#125; &#93;
&#125;</pre></div><p class="paragraph"/>这将输出：<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"categories"</span>:&#91; &#123;<span class="java&#45;quote">"a"</span>:<span class="java&#45;quote">"A"</span>&#125; , &#123;<span class="java&#45;quote">"b"</span>:<span class="java&#45;quote">"B"</span>&#125;&#93; &#125;</pre></div><p class="paragraph"/>使用特定的<code>element</code>方法可以返回一个根范围的列表：<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    element 1
    element 2
    element 3
&#125;</pre></div><p class="paragraph"/>上述代码产生如下输出：<p class="paragraph"/><div class="code"><pre>&#91;1,2,3&#93;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Rendering Complex Objects</h4><p class="paragraph"/>Rendering complex objects can be done with Closures. For example:<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91;'a', 'b', 'c'&#93;
    title = <span class="java&#45;quote">"Hello JSON"</span>
    information = &#123;
        pages = 10
    &#125;
&#125;</pre></div><p class="paragraph"/>The above will produce the JSON:<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"categories"</span>:&#91;<span class="java&#45;quote">"a"</span>,<span class="java&#45;quote">"b"</span>,<span class="java&#45;quote">"c"</span>&#93;,<span class="java&#45;quote">"title"</span>:<span class="java&#45;quote">"Hello JSON"</span>,<span class="java&#45;quote">"information"</span>:&#123;<span class="java&#45;quote">"pages"</span>:10&#125;&#125;</pre></div>
</div><p class="paragraph"/><h4>渲染复杂对象</h4><p class="paragraph"/>渲染复杂对象要在闭包内完成，比如：<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91;'a', 'b', 'c'&#93;
    title = <span class="java&#45;quote">"Hello JSON"</span>
    information = &#123;
        pages = 10
    &#125;
&#125;</pre></div><p class="paragraph"/>上述将输出JSON：<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"categories"</span>:&#91;<span class="java&#45;quote">"a"</span>,<span class="java&#45;quote">"b"</span>,<span class="java&#45;quote">"c"</span>&#93;,<span class="java&#45;quote">"title"</span>:<span class="java&#45;quote">"Hello JSON"</span>,<span class="java&#45;quote">"information"</span>:&#123;<span class="java&#45;quote">"pages"</span>:10&#125;&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Arrays of Complex Objects</h4><p class="paragraph"/>As mentioned previously you can nest complex objects within arrays using Closures:<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91; &#123; a = <span class="java&#45;quote">"A"</span> &#125;, &#123; b = <span class="java&#45;quote">"B"</span> &#125; &#93;
&#125;</pre></div><p class="paragraph"/>You can use the <code>array</code> method to build them up dynamically:<p class="paragraph"/><div class="code"><pre>def results = Book.list()
render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    books = array &#123;
        <span class="java&#45;keyword">for</span> (b in results) &#123;
            book title: b.title
        &#125;
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>复杂对象数组</h4><p class="paragraph"/>如前面所提到的，你可以在闭包内使用嵌套的复杂对象来实现数组：<p class="paragraph"/><div class="code"><pre>render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    categories = &#91; &#123; a = <span class="java&#45;quote">"A"</span> &#125;, &#123; b = <span class="java&#45;quote">"B"</span> &#125; &#93;
&#125;</pre></div><p class="paragraph"/>你也可以使用<code>array</code>方法来动态地构建它们：<p class="paragraph"/><div class="code"><pre>def results = Book.list()
render(contentType: <span class="java&#45;quote">"text/json"</span>) &#123;
    books = array &#123;
        <span class="java&#45;keyword">for</span> (b in results) &#123;
            book title: b.title
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Direct JSONBuilder API Access</h4><p class="paragraph"/>If you don't have access to the <code>render</code> method, but still want to produce JSON you can use the API directly:<p class="paragraph"/><div class="code"><pre>def builder = <span class="java&#45;keyword">new</span> JSONBuilder()<p class="paragraph"/>def result = builder.build &#123;
    categories = &#91;'a', 'b', 'c'&#93;
    title = <span class="java&#45;quote">"Hello JSON"</span>
    information = &#123;
        pages = 10
    &#125;
&#125;<p class="paragraph"/>// prints the JSON text
println result.toString()<p class="paragraph"/>def sw = <span class="java&#45;keyword">new</span> StringWriter()
result.render sw</pre></div>
</div><p class="paragraph"/><h4>直接使用JSONBuilder API</h4><p class="paragraph"/>如果你不能使用<code>render</code>方法，你还是可以通过直接使用API来产生JSON的：<p class="paragraph"/><div class="code"><pre>def builder = <span class="java&#45;keyword">new</span> JSONBuilder()<p class="paragraph"/>def result = builder.build &#123;
    categories = &#91;'a', 'b', 'c'&#93;
    title = <span class="java&#45;quote">"Hello JSON"</span>
    information = &#123;
        pages = 10
    &#125;
&#125;<p class="paragraph"/>// prints the JSON text
println result.toString()<p class="paragraph"/>def sw = <span class="java&#45;keyword">new</span> StringWriter()
result.render sw</pre></div>


<a name="6.1.9 Uploading Files"><!-- Legacy link --></a>
<h2 id="uploadingFiles">6.1.9 上传文件</h2>
<div class="hidden-block">
<h4>Programmatic File Uploads</h4><p class="paragraph"/>Grails supports file uploads using Spring's <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/multipart/MultipartHttpServletRequest.html" class="api">MultipartHttpServletRequest</a> interface. The first step for file uploading is to create a multipart form like this:<p class="paragraph"/><div class="code"><pre>Upload Form: <span class="xml&#45;tag">&#60;br /&#62;</span>
    <span class="xml&#45;tag">&#60;g:uploadForm action=<span class="xml&#45;quote">"upload"</span>&#62;</span>
        <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"file"</span> name=<span class="xml&#45;quote">"myFile"</span> /&#62;</span>
        <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"submit"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;/g:uploadForm&#62;</span></pre></div><p class="paragraph"/>The <code>uploadForm</code> tag conveniently adds the <code>enctype="multipart/form-data"</code> attribute to the standard <code>&#60;g:form&#62;</code> tag.<p class="paragraph"/>There are then a number of ways to handle the file upload. One is to work with the Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/multipart/MultipartFile.html" class="api">MultipartFile</a> instance directly:<p class="paragraph"/><div class="code"><pre>def upload() &#123;
    def f = request.getFile('myFile')
    <span class="java&#45;keyword">if</span> (f.empty) &#123;
        flash.message = 'file cannot be empty'
        render(view: 'uploadForm')
        <span class="java&#45;keyword">return</span>
    &#125;<p class="paragraph"/>    f.transferTo(<span class="java&#45;keyword">new</span> File('/some/local/dir/myfile.txt'))
    response.sendError(200, 'Done')
&#125;</pre></div><p class="paragraph"/>This is convenient for doing transfers to other destinations and manipulating the file directly as you can obtain an <code>InputStream</code> and so on with the <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/multipart/MultipartFile.html" class="api">MultipartFile</a> interface.
</div><p class="paragraph"/><h4>上传文件编程</h4><p class="paragraph"/>Grails通过Spring的<a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/multipart/MultipartHttpServletRequest.html" class="api">MultipartHttpServletRequest</a>接口来支持文件上传。第一步就是要为文件上传创建一个multipart的表单，比如：<p class="paragraph"/><div class="code"><pre>Upload Form: <span class="xml&#45;tag">&#60;br /&#62;</span>
    <span class="xml&#45;tag">&#60;g:uploadForm action=<span class="xml&#45;quote">"upload"</span>&#62;</span>
        <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"file"</span> name=<span class="xml&#45;quote">"myFile"</span> /&#62;</span>
        <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"submit"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;/g:uploadForm&#62;</span></pre></div><p class="paragraph"/><code>uploadForm</code>标签在标准<code>&#60;g:form&#62;</code>标签的基础上添加了<code>enctype="multipart/form-data"</code>属性。<p class="paragraph"/>此后就可以采用多种方式来处理文件上传。其一就是直接使用Spring的<a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/multipart/MultipartFile.html" class="api">MultipartFile</a>：<p class="paragraph"/><div class="code"><pre>def upload() &#123;
    def f = request.getFile('myFile')
    <span class="java&#45;keyword">if</span> (f.empty) &#123;
        flash.message = 'file cannot be empty'
        render(view: 'uploadForm')
        <span class="java&#45;keyword">return</span>
    &#125;<p class="paragraph"/>    f.transferTo(<span class="java&#45;keyword">new</span> File('/some/local/dir/myfile.txt'))
    response.sendError(200, 'Done')
&#125;</pre></div><p class="paragraph"/>此种方式适合于将文件传送到其他的目的地，直接使用获取到的<code>InputStream</code>来操作文件等，不过这都依赖于<a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/multipart/MultipartFile.html" class="api">MultipartFile</a>接口。<p class="paragraph"/><div class="hidden-block">
<h4>File Uploads through Data Binding</h4><p class="paragraph"/>File uploads can also be performed using data binding. Consider this <code>Image</code> domain class:<p class="paragraph"/><div class="code"><pre>class Image &#123;
    <span class="java&#45;object">byte</span>&#91;&#93; myFile<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        // Limit upload file size to 2MB
        myFile maxSize: 1024 &#42; 1024 &#42; 2
    &#125;
&#125;</pre></div><p class="paragraph"/>If you create an image using the <code>params</code> object in the constructor as in the example below, Grails will automatically bind the file's contents as a <code>byte</code> to the <code>myFile</code> property:<p class="paragraph"/><div class="code"><pre>def img = <span class="java&#45;keyword">new</span> Image(params)</pre></div><p class="paragraph"/>It's important that you set the <a href="../ref/Constraints/size.html" class="constraints">size</a> or <a href="../ref/Constraints/maxSize.html" class="constraints">maxSize</a> constraints, otherwise your database may be created with a small column size that can't handle reasonably sized files. For example, both H2 and MySQL default to a blob size of 255 bytes for <code>byte</code> properties.<p class="paragraph"/>It is also possible to set the contents of the file as a string by changing the type of the <code>myFile</code> property on the image to a String type:<p class="paragraph"/><div class="code"><pre>class Image &#123;
   <span class="java&#45;object">String</span> myFile
&#125;</pre></div>
</div><p class="paragraph"/><h4>文件上传和数据绑定</h4><p class="paragraph"/>文件上传也可以通过数据绑定来完成。假设如下的<code>Image</code>领域类：<p class="paragraph"/><div class="code"><pre>class Image &#123;
    <span class="java&#45;object">byte</span>&#91;&#93; myFile<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        // Limit upload file size to 2MB
        myFile maxSize: 1024 &#42; 1024 &#42; 2
    &#125;
&#125;</pre></div><p class="paragraph"/>如果你如下例所示那样，通过<code>params</code>的构造方法来创建一个图像（image），那么Grails将会自动地把文件内容转换为<code>byte</code>，并且绑定到<code>myFile</code>属性上：<p class="paragraph"/><div class="code"><pre>def img = <span class="java&#45;keyword">new</span> Image(params)</pre></div><p class="paragraph"/>非常重要地一点是你一定要设置<a href="../ref/Constraints/size.html" class="constraints">size</a>或者<a href="../ref/Constraints/maxSize.html" class="constraints">maxSize</a>约束，否则的话，你的数据库可能会创建一个字段太少的列，这样就不能合理的处理文件。比如，对于属性类型是<code>byte</code>的，H2和MySQL缺省的blob大小是255字节。<p class="paragraph"/>你也可以将<code>myFile</code>属性的类型改成字符串来保存文件的内容：<p class="paragraph"/><div class="code"><pre>class Image &#123;
   <span class="java&#45;object">String</span> myFile
&#125;</pre></div>


<a name="6.1.10 Command Objects"><!-- Legacy link --></a>
<h2 id="commandObjects">6.1.10 命令对象</h2>
<div class="hidden-block">
Grails controllers support the concept of command objects. A command object is similar to a form bean in a framework like Struts, and they are useful for populating a subset of the properties needed to update a domain class. Or where there is no domain class required for the interaction, but you need features such as <a href="../guide/single.html#dataBinding" class="guide">data binding</a> and <a href="../guide/single.html#validation" class="guide">validation</a>.
</div><p class="paragraph"/>Grails控制器支持命令对象（command objects）的概念。一个命令对象类似于Struts中的一个表单（form）bean，当你想要更新领域类属性的一个子集的时候，或者虽然没有领域类，你还是需要<a href="../guide/single.html#dataBinding" class="guide">数据绑定</a>和<a href="../guide/single.html#validation" class="guide">校验</a>特性的时候，是非常有用的，<p class="paragraph"/><div class="hidden-block">
<h4>Declaring Command Objects</h4><p class="paragraph"/>Command objects are typically declared in the same source file as a controller, directly below the controller class definition. For example:<p class="paragraph"/><div class="code"><pre>class UserController &#123;
    &#8230;
&#125;<p class="paragraph"/>class LoginCommand &#123;
    <span class="java&#45;object">String</span> username
    <span class="java&#45;object">String</span> password<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        username(blank: <span class="java&#45;keyword">false</span>, minSize: 6)
        password(blank: <span class="java&#45;keyword">false</span>, minSize: 6)
    &#125;
&#125;</pre></div><p class="paragraph"/>As this example shows, you can define <a href="../guide/single.html#constraints" class="guide">constraints</a> in command objects just like in <a href="../guide/single.html#GORM" class="guide">domain classes</a>.
</div><p class="paragraph"/><h4>声明命令对象</h4><p class="paragraph"/>命令对象通常声明在同一个控制器的源文件中，并且直接位于控制器类的下面。比如：<p class="paragraph"/><div class="code"><pre>class UserController &#123;
    &#8230;
&#125;<p class="paragraph"/>class LoginCommand &#123;
    <span class="java&#45;object">String</span> username
    <span class="java&#45;object">String</span> password<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        username(blank: <span class="java&#45;keyword">false</span>, minSize: 6)
        password(blank: <span class="java&#45;keyword">false</span>, minSize: 6)
    &#125;
&#125;</pre></div><p class="paragraph"/>正如上例所示，你可以象<a href="../guide/single.html#GORM" class="guide">领域类</a>那样定义命令对象的<a href="../guide/single.html#constraints" class="guide">约束</a>。<p class="paragraph"/><div class="hidden-block">
<h4>Using Command Objects</h4><p class="paragraph"/>To use command objects, controller actions may optionally specify any number of command object parameters. The parameter types must be supplied so that Grails knows what objects to create, populate and validate.<p class="paragraph"/>Before the controller action is executed Grails will automatically create an instance of the command object class, populate its properties with by binding the request parameters, and validate the command object. For example:<p class="paragraph"/><div class="code"><pre>class LoginController &#123;<p class="paragraph"/>    def login = &#123; LoginCommand cmd &#45;&#62;
        <span class="java&#45;keyword">if</span> (cmd.hasErrors()) &#123;
            redirect(action: 'loginForm')
            <span class="java&#45;keyword">return</span>
        &#125;<p class="paragraph"/>        // work with the command object data
    &#125;
&#125;</pre></div><p class="paragraph"/>When using methods instead of Closures for actions, you can specify command objects in arguments:<p class="paragraph"/><div class="code"><pre>class LoginController &#123;
    def login(LoginCommand cmd) &#123;
        <span class="java&#45;keyword">if</span> (cmd.hasErrors()) &#123;
            redirect(action: 'loginForm')
            <span class="java&#45;keyword">return</span>
        &#125;<p class="paragraph"/>        // work with the command object data
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>使用命令对象</h4><p class="paragraph"/>为了使用命令对象，控制器可以随意指定任何数目的命令对象参数。参数的类型是必需的，因为Grails需要知道什么样的对象被创建，写入和验证。<p class="paragraph"/>在控制器的操作被执行之前，Grails将自动创建一个命令对象类的实例，用相应名字的请求参数写入到命令对象属性，并且验证它们，例如：<p class="paragraph"/><div class="code"><pre>class LoginController &#123;<p class="paragraph"/>    def login = &#123; LoginCommand cmd &#45;&#62;
        <span class="java&#45;keyword">if</span> (cmd.hasErrors()) &#123;
            redirect(action: 'loginForm')
            <span class="java&#45;keyword">return</span>
        &#125;<p class="paragraph"/>        // work with the command object data
    &#125;
&#125;</pre></div><p class="paragraph"/>当操作是用方法来定义时 ，你可以将命令对象直接作为参数，比如：<p class="paragraph"/><div class="code"><pre>class LoginController &#123;
    def login(LoginCommand cmd) &#123;
        <span class="java&#45;keyword">if</span> (cmd.hasErrors()) &#123;
            redirect(action: 'loginForm')
            <span class="java&#45;keyword">return</span>
        &#125;<p class="paragraph"/>        // work with the command object data
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Command Objects and Dependency Injection</h4><p class="paragraph"/>Command objects can participate in dependency injection. This is useful if your command object has some custom validation logic uses Grails <a href="../guide/single.html#services" class="guide">services</a>:<p class="paragraph"/><div class="code"><pre>class LoginCommand &#123;<p class="paragraph"/>    def loginService<p class="paragraph"/>    <span class="java&#45;object">String</span> username
    <span class="java&#45;object">String</span> password<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        username validator: &#123; val, obj &#45;&#62;
            obj.loginService.canLogin(obj.username, obj.password)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example the command object interacts with the <code>loginService</code> bean which is injected by name from the Spring <code>ApplicationContext</code>.
</div><p class="paragraph"/><h4>命令对象和依赖注入</h4><p class="paragraph"/>命令对象也支持依赖注入。这在你自定义校验的逻辑依赖Grails的<a href="../guide/single.html#services" class="guide">服务</a>时，非常有用：<p class="paragraph"/><div class="code"><pre>class LoginCommand &#123;<p class="paragraph"/>    def loginService<p class="paragraph"/>    <span class="java&#45;object">String</span> username
    <span class="java&#45;object">String</span> password<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        username validator: &#123; val, obj &#45;&#62;
            obj.loginService.canLogin(obj.username, obj.password)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>在上述示例中，命令对象跟注入到Spring <code>ApplicationContext</code>中的<code>loginService</code>进行交互。


<a name="6.1.11 Handling Duplicate Form Submissions"><!-- Legacy link --></a>
<h2 id="formtokens">6.1.11 处理重复的表单提交</h2>
<div class="hidden-block">
Grails has built-in support for handling duplicate form submissions using the "Synchronizer Token Pattern". To get started you define a token on the <a href="../ref/Tags/form.html" class="tags">form</a> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form useToken=<span class="xml&#45;quote">"true"</span> ...&#62;</span></pre></div><p class="paragraph"/>Then in your controller code you can use the <a href="../ref/Controllers/withForm.html" class="controllers">withForm</a> method to handle valid and invalid requests:<p class="paragraph"/><div class="code"><pre>withForm &#123;
   // good request
&#125;.invalidToken &#123;
   // bad request
&#125;</pre></div><p class="paragraph"/>If you only provide the <a href="../ref/Controllers/withForm.html" class="controllers">withForm</a> method and not the chained <code>invalidToken</code> method then by default Grails will store the invalid token in a <code>flash.invalidToken</code> variable and redirect the request back to the original page. This can then be checked in the view:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:if test=<span class="xml&#45;quote">"$&#123;flash.invalidToken&#125;"</span>&#62;</span>
  Don't click the button twice!
<span class="xml&#45;tag">&#60;/g:if&#62;</span></pre></div><p class="paragraph"/><blockquote class="warning">
The <a href="../ref/Controllers/withForm.html" class="controllers">withForm</a> tag makes use of the <a href="../ref/Controllers/session.html" class="controllers">session</a> and hence requires session affinity or clustered sessions if used in a cluster.
</blockquote>
</div><p class="paragraph"/>Grails内置了对表单重复提交的处理，其使用的模式是“同步标志模式（Synchronizer Token Pattern）”。作为开始，你需要先在<a href="../ref/Tags/form.html" class="tags">form</a>标签中定义一个标志：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form useToken=<span class="xml&#45;quote">"true"</span> ...&#62;</span></pre></div><p class="paragraph"/>然后在你的控制器代码中使用<a href="../ref/Controllers/withForm.html" class="controllers">withForm</a>方法来处理那些有效和无效的请求：<p class="paragraph"/><div class="code"><pre>withForm &#123;
   // good request
&#125;.invalidToken &#123;
   // bad request
&#125;</pre></div><p class="paragraph"/>如果你只是使用<a href="../ref/Controllers/withForm.html" class="controllers">withForm</a>方法而没有连到<code>invalidToken</code>方法的话，Grails将缺省地存储无效的标志到<code>flash.invalidToken</code>变量中，并且将请求重定向到上一个原始页面。这样就可以在视图中检查了：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:if test=<span class="xml&#45;quote">"$&#123;flash.invalidToken&#125;"</span>&#62;</span>
  Don't click the button twice!
<span class="xml&#45;tag">&#60;/g:if&#62;</span></pre></div><p class="paragraph"/><blockquote class="warning">
<a href="../ref/Controllers/withForm.html" class="controllers">withForm</a>标签使用的是<a href="../ref/Controllers/session.html" class="controllers">session</a>，因此要求是兼容会话的或者支持集群的会话－如果在集群中使用的话。
</blockquote>


<a name="6.1.12 Simple Type Converters"><!-- Legacy link --></a>
<h2 id="typeConverters">6.1.12 简单类型转换器</h2>
<div class="hidden-block">
<h3>Type Conversion Methods</h3><p class="paragraph"/>If you prefer to avoid the overhead of <a href="../guide/single.html#dataBinding" class="guide">Data Binding</a> and simply want to convert incoming parameters (typically Strings) into another more appropriate type the <a href="../ref/Controllers/params.html" class="controllers">params</a> object has a number of convenience methods for each type:<p class="paragraph"/><div class="code"><pre>def total = params.<span class="java&#45;object">int</span>('total')</pre></div><p class="paragraph"/>The above example uses the <code>int</code> method, and there are also methods for <code>boolean</code>, <code>long</code>, <code>char</code>, <code>short</code> and so on. Each of these methods is null-safe and safe from any parsing errors, so you don't have to perform any additional checks on the parameters.<p class="paragraph"/>Each of the conversion methods allows a default value to be passed as an optional second argument.  The default value will be returned if a corresponding entry cannot be found in the map or if an error occurs during the conversion.  Example:<p class="paragraph"/><div class="code"><pre>def total = params.<span class="java&#45;object">int</span>('total', 42)</pre></div><p class="paragraph"/>These same type conversion methods are also available on the <code>attrs</code> parameter of GSP tags.
</div><p class="paragraph"/><h3>类型转换方法</h3><p class="paragraph"/>如果你倾向于避免<a href="../guide/single.html#dataBinding" class="guide">数据绑定</a>的开销，而只想简单地将输入参数（通常是字符串）转换为另外更合适地类型，可以通过<a href="../ref/Controllers/params.html" class="controllers">params</a>对象提供的一些便利方法来实现：<p class="paragraph"/><div class="code"><pre>def total = params.<span class="java&#45;object">int</span>('total')</pre></div><p class="paragraph"/>上述示例使用的是<code>int</code>方法，除此之外还有<code>boolean</code>、<code>long</code>、<code>char</code>、<code>short</code>等方法。每一个方法都是空指针安全的（null-safe）和类型解析安全的，因此你也就不需要执行任何额外的参数检查了。<p class="paragraph"/>每一个转换方法都允许将一个缺省值传递给第二个可选参数。如果映射中没有找到对应的实体或者进行转换的时候出现了错误，此缺省值将被返回。比如：<p class="paragraph"/><div class="code"><pre>def total = params.<span class="java&#45;object">int</span>('total', 42)</pre></div><p class="paragraph"/>同样的这些转换方法也适合于GSP标签的<code>attrs</code>参数。<p class="paragraph"/><div class="hidden-block">
<h3>Handling Multi Parameters</h3><p class="paragraph"/>A common use case is dealing with multiple request parameters of the same name. For example you could get a query string such as <code>?name=Bob&#38;name=Judy</code>.<p class="paragraph"/>In this case dealing with one parameter and dealing with many has different semantics since Groovy's iteration mechanics for <code>String</code> iterate over each character. To avoid this problem the <a href="../ref/Controllers/params.html" class="controllers">params</a> object provides a <code>list</code> method that always returns a list:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">for</span> (name in params.list('name')) &#123;
    println name
&#125;</pre></div>
</div><p class="paragraph"/><h3>处理多个重名参数</h3><p class="paragraph"/>我们会经常碰到要处理多个请求参数名相同的情况。比如得到你得到一个内容是<code>?name=Bob&#38;name=Judy</code>的查询串<p class="paragraph"/>这种情况下，处理一个参数和多个参数的语法是有些不同的，因为Groovy的<code>String</code>迭代是基于字符的。要避免此问题，可以使用<a href="../ref/Controllers/params.html" class="controllers">params</a>对象提供的<code>list</code>方法，此方法总是返回一个列表：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">for</span> (name in params.list('name')) &#123;
    println name
&#125;</pre></div>


<a name="6.1.13 Asynchronous Request Processing"><!-- Legacy link --></a>
<h2 id="asynchronousRequestProcessing">6.1.13 异步请求处理</h2>
<div class="hidden-block">
Grails support asynchronous request processing as provided by the Servlet 3.0 specification. To enable the async features you need to set your servlet target version to 3.0 in BuildConfig.groovy:<p class="paragraph"/><div class="code"><pre>grails.servlet.version = <span class="java&#45;quote">"3.0"</span></pre></div><p class="paragraph"/>With that done ensure you do a clean re-compile as some async features are enabled at compile time.<p class="paragraph"/><blockquote class="note">
With a Servlet target version of 3.0 you can only deploy on Servlet 3.0 containers such as Tomcat 7 and above.
</blockquote>
</div><p class="paragraph"/>Grails支持Servlet 3.0规范的异步请求处理。要使异步功能生效，你需要在BuildConfig.groovy中设置servlet的版本为3.0：<p class="paragraph"/><div class="code"><pre>grails.servlet.version = <span class="java&#45;quote">"3.0"</span></pre></div><p class="paragraph"/>除此之外，你还需要一个干净的支持异步特性的编译环境来重新编译一下。<p class="paragraph"/><blockquote class="note">
使用Servlet 3.0版本以后，你只能将应用部署于支持Servlet 3.0的容器中，比如Tomcat 7及其以上版本。
</blockquote><p class="paragraph"/><div class="hidden-block">
<h4>Asynchronous Rendering</h4><p class="paragraph"/>You can render content (templates, binary data etc.) in an asynchronous manner by calling the <code>startAsync</code> method which returns an instance of the Servlet 3.0 <code>AsyncContext</code>. Once you have a reference to the <code>AsyncContext</code> you can use Grails' regular render method to render content:<p class="paragraph"/><div class="code"><pre>def index() &#123;
    def ctx = startAsync()
    ctx.start &#123;
        <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Stand"</span>).save()
        render template:<span class="java&#45;quote">"books"</span>, model:&#91;books:Book.list()&#93;
        ctx.complete()
    &#125;
&#125;</pre></div><p class="paragraph"/>Note that you must call the <code>complete()</code> method to terminate the connection. 
</div><p class="paragraph"/><h4>异步渲染</h4><p class="paragraph"/>你可以通过调用<code>startAsync</code>方法的方式进行异步的内容渲染（比如模板、二进制数据等），此方法的返回值是Servlet 3.0 <code>AsyncContext</code>的一个实例。一旦获取到了<code>AsyncContext</code>的引用，你就可以使用Grails的render方法来渲染内容了：<p class="paragraph"/><div class="code"><pre>def index() &#123;
    def ctx = startAsync()
    ctx.start &#123;
        <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Stand"</span>).save()
        render template:<span class="java&#45;quote">"books"</span>, model:&#91;books:Book.list()&#93;
        ctx.complete()
    &#125;
&#125;</pre></div><p class="paragraph"/>注意！你必须要调用<code>complete()</code>方法来中止此连接。<p class="paragraph"/><div class="hidden-block">
<h4>Resuming an Async Request</h4><p class="paragraph"/>You resume processing of an async request (for example to delegate to view rendering) by using the <code>dispatch</code> method of the <code>AsyncContext</code> class:<p class="paragraph"/><div class="code"><pre>def index() &#123;
    def ctx = startAsync()
    ctx.start &#123;
        // <span class="java&#45;keyword">do</span> working
        &#8230;
        // render view
        ctx.dispatch()
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>恢复一个异步请求</h4><p class="paragraph"/>你可以通过<code>AsyncContext</code>类的<code>dispatch</code>方法来恢复一个异步请求（比如将其代理到一个视图）：<p class="paragraph"/><div class="code"><pre>def index() &#123;
    def ctx = startAsync()
    ctx.start &#123;
        // <span class="java&#45;keyword">do</span> working
        &#8230;
        // render view
        ctx.dispatch()
    &#125;
&#125;</pre></div>


<a name="6.2 Groovy Server Pages"><!-- Legacy link --></a>
<h2 id="gsp">6.2 Groovy服务器页面(GSP)</h2>
<div class="hidden-block">
Groovy Servers Pages (or GSP for short) is Grails' view technology. It is designed to be familiar for users of technologies such as ASP and JSP, but to be far more flexible and intuitive.<p class="paragraph"/>GSPs live in the <code>grails-app/views</code> directory and are typically rendered automatically (by convention) or with the <a href="../ref/Controllers/render.html" class="controllers">render</a> method such as:<p class="paragraph"/><div class="code"><pre>render(view: <span class="java&#45;quote">"index"</span>)</pre></div><p class="paragraph"/>A GSP is typically a mix of mark-up and GSP tags which aid in view rendering.<p class="paragraph"/><blockquote class="note">
Although it is possible to have Groovy logic embedded in your GSP and doing this will be covered in this document, the practice is strongly discouraged. Mixing mark-up and code is a <strong class="bold">bad</strong> thing and most GSP pages contain no code and needn't do so.
</blockquote><p class="paragraph"/>A GSP typically has a "model" which is a set of variables that are used for view rendering. The model is passed to the GSP view from a controller. For example consider the following controller action:<p class="paragraph"/><div class="code"><pre>def show() &#123;
    &#91;book: Book.get(params.id)&#93;
&#125;</pre></div><p class="paragraph"/>This action will look up a <code>Book</code> instance and create a model that contains a key called <code>book</code>. This key can then be referenced within the GSP view using the name <code>book</code>:<p class="paragraph"/><div class="code"><pre>$&#123;book.title&#125;</pre></div>
</div><p class="paragraph"/>Groovy服务器页面（或者简称为GSP）是Grails的视图技术。它是专为熟悉ASP和JSP技术的用户而设计，不过更加灵活和直观。<p class="paragraph"/>GSPs位于<code>grails-app/views</code>目录下边，通常情况下是自动渲染的（基于规约）或者通过<a href="../ref/Controllers/render.html" class="controllers">render</a>方法，比如：<p class="paragraph"/><div class="code"><pre>render(view: <span class="java&#45;quote">"index"</span>)</pre></div><p class="paragraph"/>GSP混合使用HTML标记（mark-up）和GSP标签技术来辅助视图渲染。<p class="paragraph"/><blockquote class="note">
虽然在你的GSP中可以使用内嵌的Groovy逻辑（本文档将会涉及），但是作为最佳实践，是非常不鼓励这么做的。混合使用标记和代码是一件很 <strong class="bold">不好</strong> 的事情，而且大多数的GSP页面无需也不必包含代码。
</blockquote><p class="paragraph"/>GSP通常都会有一个用以视图渲染所需的变量集合"模型（model）"，此模型是从控制器传递到GSP视图的。以如下的控制器操作为例：<p class="paragraph"/><div class="code"><pre>def show() &#123;
    &#91;book: Book.get(params.id)&#93;
&#125;</pre></div><p class="paragraph"/>此操作将会查找一个<code>Book</code>实例，并且创建一个包含键<code>book</code>的模型。 此键在GSP视图中可以通过名字<code>book</code>来引用：<p class="paragraph"/><div class="code"><pre>$&#123;book.title&#125;</pre></div>


<a name="6.2.1 GSP Basics"><!-- Legacy link --></a>
<h2 id="GSPBasics">6.2.1 GSP基础</h2>
<div class="hidden-block">
In the next view sections we'll go through the basics of GSP and what is available to you. First off let's cover some basic syntax that users of JSP and ASP should be familiar with.<p class="paragraph"/>GSP supports the usage of <code>&#60;% %&#62;</code> scriptlet blocks to embed Groovy code (again this is discouraged):<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
     <span class="xml&#45;tag">&#60;% out &#60;&#60; <span class="xml&#45;quote">"Hello GSP!"</span> %&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>You can also use the <code>&#60;%= %&#62;</code> syntax to output values:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
     <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello GSP!"</span> %&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>GSP also supports JSP-style server-side comments (which are not rendered in the HTML response) as the following example demonstrates:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
     <span class="xml&#45;tag">&#60;%&#45;&#45; This is my comment &#45;&#45;%&#62;</span>
     <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello GSP!"</span> %&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div>
</div><p class="paragraph"/>在下一个视图章节中，我们将涉及GSP的基础部分以及那些是你所需的。本节首先简单介绍一些基础的语法，对于JSP和ASP用户来说，这些应该都很熟悉。<p class="paragraph"/>GSP支持内嵌Groovy代码的用法（再次强调，不提倡这样用）是通过<code>&#60;% %&#62;</code>的脚本代码块的来实现的，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
     <span class="xml&#45;tag">&#60;% out &#60;&#60; <span class="xml&#45;quote">"Hello GSP!"</span> %&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>你也可以使用<code>&#60;%= %&#62;</code>的语法来输出：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
     <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello GSP!"</span> %&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>GSP也支持JSP风格的服务器端注释（其将不会被渲染到HTML响应中），比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
     <span class="xml&#45;tag">&#60;%&#45;&#45; This is my comment &#45;&#45;%&#62;</span>
     <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello GSP!"</span> %&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div>


<a name="6.6.3 Variables and Scopes"><!-- Legacy link --></a>
<h2 id="variablesAndScopes">6.2.1.1 变量和作用域</h2>
<div class="hidden-block">
Within the <code>&#60;% %&#62;</code> brackets you can declare variables:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;% now = new Date() %&#62;</span></pre></div><p class="paragraph"/>and then access those variables later in the page:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;%=now%&#62;</span></pre></div><p class="paragraph"/>Within the scope of a GSP there are a number of pre-defined variables, including:
<ul class="star">
<li><code>application</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/ServletContext.html" class="api">javax.servlet.ServletContext</a> instance</li>
<li><code>applicationContext</code> The Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">ApplicationContext</a> instance</li>
<li><code>flash</code> - The <a href="../ref/Controllers/flash.html" class="controllers">flash</a> object</li>
<li><code>grailsApplication</code> - The <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> instance</li>
<li><code>out</code> - The response writer for writing to the output stream</li>
<li><code>params</code> - The <a href="../ref/Controllers/params.html" class="controllers">params</a> object for retrieving request parameters</li>
<li><code>request</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a> instance</li>
<li><code>response</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html" class="api">HttpServletResponse</a> instance</li>
<li><code>session</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpSession.html" class="api">HttpSession</a> instance</li>
<li><code>webRequest</code> - The <a href="../../api/org/codehaus/groovy/grails/web/servlet/mvc/GrailsWebRequest.html" class="api">GrailsWebRequest</a> instance</li>
</ul><p class="paragraph"/></div><p class="paragraph"/>在<code>&#60;% %&#62;</code>内，你可以声明变量：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;% now = new Date() %&#62;</span></pre></div><p class="paragraph"/>然后在页面中访问使用这些变量：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;%=now%&#62;</span></pre></div><p class="paragraph"/>在GSP的作用域内，已经存在一些预定义的变量，它们是：
<ul class="star">
<li><code>application</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/ServletContext.html" class="api">javax.servlet.ServletContext</a>实例</li>
<li><code>applicationContext</code> Spring的<a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">ApplicationContext</a>实例</li>
<li><code>flash</code> - <a href="../ref/Controllers/flash.html" class="controllers">flash</a>对象</li>
<li><code>grailsApplication</code> - <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a>实例</li>
<li><code>out</code> - 响应输出流输出器</li>
<li><code>params</code> -  <a href="../ref/Controllers/params.html" class="controllers">params</a>对象，用于接收请求参数</li>
<li><code>request</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a>实例</li>
<li><code>response</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html" class="api">HttpServletResponse</a>实例</li>
<li><code>session</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpSession.html" class="api">HttpSession</a>实例</li>
<li><code>webRequest</code> - <a href="../../api/org/codehaus/groovy/grails/web/servlet/mvc/GrailsWebRequest.html" class="api">GrailsWebRequest</a>实例</li>
</ul><p class="paragraph"/>

<a name="6.2.2.2 Logic and Iteration"><!-- Legacy link --></a>
<h2 id="logicAndIteration">6.2.1.2 逻辑和迭代</h2>
<div class="hidden-block">
Using the <code>&#60;% %&#62;</code> syntax you can embed loops and so on using this syntax:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;% &#91;1,2,3,4&#93;.each &#123; num &#45;&#62;</span> %&#62;
         <span class="xml&#45;tag">&#60;p&#62;</span><span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello $&#123;num&#125;!"</span> %&#62;</span><span class="xml&#45;tag">&#60;/p&#62;</span>
      <span class="xml&#45;tag">&#60;%&#125;%&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>As well as logical branching:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;% if (params.hello == 'true')%&#62;</span>
      <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello!"</span>%&#62;</span>
      <span class="xml&#45;tag">&#60;% else %&#62;</span>
      <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Goodbye!"</span>%&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div>
</div><p class="paragraph"/>使用<code>&#60;% %&#62;</code>语法你可以内嵌循环之类的用法，其语法如下：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;% &#91;1,2,3,4&#93;.each &#123; num &#45;&#62;</span> %&#62;
         <span class="xml&#45;tag">&#60;p&#62;</span><span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello $&#123;num&#125;!"</span> %&#62;</span><span class="xml&#45;tag">&#60;/p&#62;</span>
      <span class="xml&#45;tag">&#60;%&#125;%&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>同理，逻辑判断如下：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;% if (params.hello == 'true')%&#62;</span>
      <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Hello!"</span>%&#62;</span>
      <span class="xml&#45;tag">&#60;% else %&#62;</span>
      <span class="xml&#45;tag">&#60;%=<span class="xml&#45;quote">"Goodbye!"</span>%&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div>


<a name="6.2.1.3 Page Directives"><!-- Legacy link --></a>
<h2 id="pageDirectives">6.2.1.3 页面指令</h2>
<div class="hidden-block">
GSP also supports a few JSP-style page directives.<p class="paragraph"/>The import directive lets you import classes into the page. However, it is rarely needed due to Groovy's default imports and <a href="../guide/single.html#tags" class="guide">GSP Tags</a>:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;%@ page import=<span class="xml&#45;quote">"java.awt.&#42;"</span> %&#62;</span></pre></div><p class="paragraph"/>GSP also supports the contentType directive:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;%@ page contentType=<span class="xml&#45;quote">"text/json"</span> %&#62;</span></pre></div><p class="paragraph"/>The contentType directive allows using GSP to render other formats.
</div><p class="paragraph"/>GSP也支持一些JSP风格的页面指令。<p class="paragraph"/>import指令可以让你将Java类导入到页面中。但是它应该很少使用，因为已经有Groovy缺省导入和<a href="../guide/single.html#tags" class="guide">GSP标签</a>：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;%@ page import=<span class="xml&#45;quote">"java.awt.&#42;"</span> %&#62;</span></pre></div><p class="paragraph"/>GSP也支持contentType指令：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;%@ page contentType=<span class="xml&#45;quote">"text/json"</span> %&#62;</span></pre></div><p class="paragraph"/>contentType指令允许将GSP渲染为其他格式。


<a name="6.2.1.4 Expressions"><!-- Legacy link --></a>
<h2 id="expressions">6.2.1.4 表达式</h2>
<div class="hidden-block">
In GSP the <code>&#60;%= %&#62;</code> syntax introduced earlier is rarely used due to the support for GSP expressions. A GSP expression is similar to a JSP EL expression or a Groovy GString and takes the form <code>${expr}</code>:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
  <span class="xml&#45;tag">&#60;body&#62;</span>
    Hello $&#123;params.name&#125;
  <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>However, unlike JSP EL you can have any Groovy expression within the <code>${..}</code> block. Variables within the <code>${..}</code> block are <strong class="bold">not</strong> escaped by default, so any HTML in the variable's string is rendered directly to the page. To reduce the risk of Cross-site-scripting (XSS) attacks, you can enable automatic HTML escaping with the <code>grails.views.default.codec</code> setting in <code>grails-app/conf/Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.views.<span class="java&#45;keyword">default</span>.codec='html'</pre></div><p class="paragraph"/>Other possible values are 'none' (for no default encoding) and 'base64'.
</div><p class="paragraph"/>在GSP中，一开始所介绍的<code>&#60;%= %&#62;</code>语法是很少被应用于GSP表达式的。一个GSP表达式类似于JSP EL表达式或者Groovy GString，使用的是<code>${expr}</code>形式：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
  <span class="xml&#45;tag">&#60;body&#62;</span>
    Hello $&#123;params.name&#125;
  <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>尽管如此，跟JSP EL不同的是，你可以在<code>${..}</code>代码块中使用任意Groovy表达式。<code>${..}</code>块中的变量缺省是 <strong class="bold">不</strong> 被转义的，因此变量中字符串将会直接被渲染到页面HTML。要减少这种Cross-site-scripting (XSS)攻击风险，你可以使用自动HTML转义来避免，只需要在<code>grails-app/conf/Config.groovy</code>中配置<code>grails.views.default.codec</code>即可：<p class="paragraph"/><div class="code"><pre>grails.views.<span class="java&#45;keyword">default</span>.codec='html'</pre></div><p class="paragraph"/>其他可选的值是'none' (用于没有缺省编码情况)和'base64'.


<a name="6.2.2 GSP Tags"><!-- Legacy link --></a>
<h2 id="tags">6.2.2 GSP标签</h2>
<div class="hidden-block">
Now that the less attractive JSP heritage has been set aside, the following sections cover GSP's built-in tags, which are the preferred way to define GSP pages.<p class="paragraph"/><blockquote class="note">
The section on <a href="../guide/single.html#taglibs" class="guide">Tag Libraries</a> covers how to add your own custom tag libraries.
</blockquote><p class="paragraph"/>All built-in GSP tags start with the prefix <code>g:</code>. Unlike JSP, you don't specify any tag library imports. If a tag starts with <code>g:</code> it is automatically assumed to be a GSP tag. An example GSP tag would look like:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example /&#62;</span></pre></div><p class="paragraph"/>GSP tags can also have a body such as:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>Expressions can be passed into GSP tag attributes, if an expression is not used it will be assumed to be a String value:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example attr=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span>&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>Maps can also be passed into GSP tag attributes, which are often used for a named parameter style syntax:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example attr=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> attr2=<span class="xml&#45;quote">"&#91;one:1, two:2, three:3&#93;"</span>&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>Note that within the values of attributes you must use single quotes for Strings:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example attr=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> attr2=<span class="xml&#45;quote">"&#91;one:'one', two:'two'&#93;"</span>&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>With the basic syntax out the way, the next sections look at the tags that are built into Grails by default.
</div><p class="paragraph"/>现在没有吸引力的JSP遗留部分已经被废除了，那么接下来的章节，我们将讨论GSP的内置标签，它们是定义GSP页面非常有力的方法。<p class="paragraph"/><blockquote class="note">
<a href="../guide/single.html#taglibs" class="guide">标签库</a>章节讨论的是如何添加你自己定制的标签库
</blockquote><p class="paragraph"/>所有内置的GSP标签都是以前缀<code>g:</code>开始的。跟JSP不同的是，你不需要指定任何的标签库导入。如果一个标签以<code>g:</code>开头，那么将会自动地被当作GSP标签看待。一个GSP的标签的样子如下所示：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example /&#62;</span></pre></div><p class="paragraph"/>GSP标签还可以有一个主体（body），比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>GSP标签的属性可以使用Groovy表达式，而如果没有明确指定的话，其缺省为一个字符串值：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example attr=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span>&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>Map类型也可以作为GSP标签的属性，其一般被用作命名参数风格的语法：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example attr=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> attr2=<span class="xml&#45;quote">"&#91;one:1, two:2, three:3&#93;"</span>&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>注意！属性里边的字符串值你必须使用单引号：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:example attr=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> attr2=<span class="xml&#45;quote">"&#91;one:'one', two:'two'&#93;"</span>&#62;</span>
   Hello world
<span class="xml&#45;tag">&#60;/g:example&#62;</span></pre></div><p class="paragraph"/>基本的语法已经介绍完毕，接下来的章节将是Grails自带的缺省标签了。



<h2 id="tagVariablesAndScopes">6.2.2.1 变量和作用域</h2>
<div class="hidden-block">
Variables can be defined within a GSP using the <a href="../ref/Tags/set.html" class="tags">set</a> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"now"</span> value=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>Here we assign a variable called <code>now</code> to the result of a GSP expression (which simply constructs a new <code>java.util.Date</code> instance). You can also use the body of the <code>&#60;g:set&#62;</code> tag to define a variable:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"myHTML"</span>&#62;</span>
   Some re&#45;usable code on: $&#123;new Date()&#125;
<span class="xml&#45;tag">&#60;/g:set&#62;</span></pre></div><p class="paragraph"/>Variables can also be placed in one of the following scopes:
<ul class="star">
<li><code>page</code> - Scoped to the current page (default)</li>
<li><code>request</code> - Scoped to the current request</li>
<li><code>flash</code> - Placed within <a href="../ref/Controllers/flash.html" class="controllers">flash</a> scope and hence available for the next request</li>
<li><code>session</code> - Scoped for the user session</li>
<li><code>application</code> - Application-wide scope.</li>
</ul><p class="paragraph"/>To specify the scope, use the <code>scope</code> attribute:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"now"</span> value=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> scope=<span class="xml&#45;quote">"request"</span> /&#62;</span></pre></div>
</div><p class="paragraph"/>在GSP中，可以通过<a href="../ref/Tags/set.html" class="tags">set</a>标签来定义变量：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"now"</span> value=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>此处，我们将一个GSP表达式（只是简单地构造一个<code>java.util.Date</code>实例）的结果赋值给<code>now</code>变量。你也可以使用<code>&#60;g:set&#62;</code>标签的主体来定义一个变量：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"myHTML"</span>&#62;</span>
   Some re&#45;usable code on: $&#123;new Date()&#125;
<span class="xml&#45;tag">&#60;/g:set&#62;</span></pre></div><p class="paragraph"/>变量也可以被置于如下的作用域之一：
<ul class="star">
<li><code>page</code> - 作用于当前页面（缺省）</li>
<li><code>request</code> - 作用于当前请求</li>
<li><code>flash</code> - 置于<a href="../ref/Controllers/flash.html" class="controllers">flash</a>作用域内，因此在下一个请求中是有效的</li>
<li><code>session</code> - 作用于用户会话</li>
<li><code>application</code> - 应用级别的作用域</li>
</ul><p class="paragraph"/>要指定作用域，要使用<code>scope</code>属性：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"now"</span> value=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> scope=<span class="xml&#45;quote">"request"</span> /&#62;</span></pre></div>



<h2 id="tagLogicAndIteration">6.2.2.2 逻辑和迭代</h2>
<div class="hidden-block">
GSP also supports logical and iterative tags out of the box. For logic there are <a href="../ref/Tags/if.html" class="tags">if</a>, <a href="../ref/Tags/else.html" class="tags">else</a> and <a href="../ref/Tags/elseif.html" class="tags">elseif</a> tags for use with branching:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:if test=<span class="xml&#45;quote">"$&#123;session.role == 'admin'&#125;"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;%&#45;&#45; show administrative functions &#45;&#45;%&#62;</span>
<span class="xml&#45;tag">&#60;/g:if&#62;</span>
<span class="xml&#45;tag">&#60;g:else&#62;</span>
   <span class="xml&#45;tag">&#60;%&#45;&#45; show basic functions &#45;&#45;%&#62;</span>
<span class="xml&#45;tag">&#60;/g:else&#62;</span></pre></div><p class="paragraph"/>Use the <a href="../ref/Tags/each.html" class="tags">each</a> and <a href="../ref/Tags/while.html" class="tags">while</a> tags for iteration:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:each in=<span class="xml&#45;quote">"$&#123;&#91;1,2,3&#93;&#125;"</span> var=<span class="xml&#45;quote">"num"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;p&#62;</span>Number $&#123;num&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:each&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"num"</span> value=<span class="xml&#45;quote">"$&#123;1&#125;"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:while test=<span class="xml&#45;quote">"$&#123;num &#60; 5 &#125;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;p&#62;</span>Number $&#123;num++&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:while&#62;</span></pre></div>
</div><p class="paragraph"/>GSP也支持逻辑和迭代地标签。<a href="../ref/Tags/if.html" class="tags">if</a>、<a href="../ref/Tags/else.html" class="tags">else</a>和<a href="../ref/Tags/elseif.html" class="tags">elseif</a>标签用于逻辑，用以处理分支：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:if test=<span class="xml&#45;quote">"$&#123;session.role == 'admin'&#125;"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;%&#45;&#45; show administrative functions &#45;&#45;%&#62;</span>
<span class="xml&#45;tag">&#60;/g:if&#62;</span>
<span class="xml&#45;tag">&#60;g:else&#62;</span>
   <span class="xml&#45;tag">&#60;%&#45;&#45; show basic functions &#45;&#45;%&#62;</span>
<span class="xml&#45;tag">&#60;/g:else&#62;</span></pre></div><p class="paragraph"/><a href="../ref/Tags/each.html" class="tags">each</a>和<a href="../ref/Tags/while.html" class="tags">while</a>标签用于迭代：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:each in=<span class="xml&#45;quote">"$&#123;&#91;1,2,3&#93;&#125;"</span> var=<span class="xml&#45;quote">"num"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;p&#62;</span>Number $&#123;num&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:each&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"num"</span> value=<span class="xml&#45;quote">"$&#123;1&#125;"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;g:while test=<span class="xml&#45;quote">"$&#123;num &#60; 5 &#125;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;p&#62;</span>Number $&#123;num++&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:while&#62;</span></pre></div>


<a name="6.2.2.3 Search and Filtering"><!-- Legacy link --></a>
<h2 id="searchAndFiltering">6.2.2.3 搜索和过滤</h2>
<div class="hidden-block">
If you have collections of objects you often need to sort and filter them. Use the <a href="../ref/Tags/findAll.html" class="tags">findAll</a> and <a href="../ref/Tags/grep.html" class="tags">grep</a> tags for these tasks:<p class="paragraph"/><div class="code"><pre>Stephen King's Books:
<span class="xml&#45;tag">&#60;g:findAll in=<span class="xml&#45;quote">"$&#123;books&#125;"</span> expr=<span class="xml&#45;quote">"it.author == 'Stephen King'"</span>&#62;</span>
     <span class="xml&#45;tag">&#60;p&#62;</span>Title: $&#123;it.title&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:findAll&#62;</span></pre></div><p class="paragraph"/>The <code>expr</code> attribute contains a Groovy expression that can be used as a filter. The <a href="../ref/Tags/grep.html" class="tags">grep</a> tag does a similar job, for example filtering by class:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:grep in=<span class="xml&#45;quote">"$&#123;books&#125;"</span> filter=<span class="xml&#45;quote">"NonFictionBooks.class"</span>&#62;</span>
     <span class="xml&#45;tag">&#60;p&#62;</span>Title: $&#123;it.title&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:grep&#62;</span></pre></div><p class="paragraph"/>Or using a regular expression:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:grep in=<span class="xml&#45;quote">"$&#123;books.title&#125;"</span> filter=<span class="xml&#45;quote">"~/.&#42;?Groovy.&#42;?/"</span>&#62;</span>
     <span class="xml&#45;tag">&#60;p&#62;</span>Title: $&#123;it&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:grep&#62;</span></pre></div><p class="paragraph"/>The above example is also interesting due to its usage of GPath. GPath is an XPath-like language in Groovy. The <code>books</code> variable is a collection of <code>Book</code> instances. Since each <code>Book</code> has a <code>title</code>, you can obtain a list of Book titles using the expression <code>books.title</code>. Groovy will auto-magically iterate the collection, obtain each title, and return a new list!
</div><p class="paragraph"/>如果你的对象是集合，那么你经常需要排序和过滤。使用<a href="../ref/Tags/findAll.html" class="tags">findAll</a>和<a href="../ref/Tags/grep.html" class="tags">grep</a>标签可以完成这些任务：<p class="paragraph"/><div class="code"><pre>Stephen King's Books:
<span class="xml&#45;tag">&#60;g:findAll in=<span class="xml&#45;quote">"$&#123;books&#125;"</span> expr=<span class="xml&#45;quote">"it.author == 'Stephen King'"</span>&#62;</span>
     <span class="xml&#45;tag">&#60;p&#62;</span>Title: $&#123;it.title&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:findAll&#62;</span></pre></div><p class="paragraph"/><code>expr</code>属性使用一个Groovy表达式来作为过滤器。<a href="../ref/Tags/grep.html" class="tags">grep</a>标签完成类似的任务，比如要过滤对象类：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:grep in=<span class="xml&#45;quote">"$&#123;books&#125;"</span> filter=<span class="xml&#45;quote">"NonFictionBooks.class"</span>&#62;</span>
     <span class="xml&#45;tag">&#60;p&#62;</span>Title: $&#123;it.title&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:grep&#62;</span></pre></div><p class="paragraph"/>或者使用一个正则表达式：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:grep in=<span class="xml&#45;quote">"$&#123;books.title&#125;"</span> filter=<span class="xml&#45;quote">"~/.&#42;?Groovy.&#42;?/"</span>&#62;</span>
     <span class="xml&#45;tag">&#60;p&#62;</span>Title: $&#123;it&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:grep&#62;</span></pre></div><p class="paragraph"/>上述示例也展示了GPath用法。Groovy的GPath跟XPath类似。<code>books</code>变量是一个<code>Book</code>实例的集合。因为每一个<code>Book</code>都有<code>title</code>，你可以使用表达式<code>books.title</code>来获取Book标题的列表。Groovy将会自动地对集合迭代，获取每一个标题，最终返回一个新的列表。


<a name="6.2.2.4 Links and Resources"><!-- Legacy link --></a>
<h2 id="linksAndResources">6.2.2.4 链接和资源</h2>
<div class="hidden-block">
GSP also features tags to help you manage linking to controllers and actions. The <a href="../ref/Tags/link.html" class="tags">link</a> tag lets you specify controller and action name pairing and it will automatically work out the link based on the <a href="../guide/single.html#urlmappings" class="guide">URL Mappings</a>, even if you change them! For example:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:link action=<span class="xml&#45;quote">"show"</span> id=<span class="xml&#45;quote">"1"</span>&#62;</span>Book 1<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link action=<span class="xml&#45;quote">"show"</span> id=<span class="xml&#45;quote">"$&#123;currentBook.id&#125;"</span>&#62;</span>$&#123;currentBook.name&#125;<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link controller=<span class="xml&#45;quote">"book"</span>&#62;</span>Book Home<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link controller=<span class="xml&#45;quote">"book"</span> action=<span class="xml&#45;quote">"list"</span>&#62;</span>Book List<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link url=<span class="xml&#45;quote">"&#91;action: 'list', controller: 'book'&#93;"</span>&#62;</span>Book List<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link params=<span class="xml&#45;quote">"&#91;sort: 'title', order: 'asc', author: currentBook.author&#93;"</span>
        action=<span class="xml&#45;quote">"list"</span>&#62;</span>Book List<span class="xml&#45;tag">&#60;/g:link&#62;</span></pre></div>
</div><p class="paragraph"/>GSP标签也能帮助你来管理控制器和操作的超链接。<a href="../ref/Tags/link.html" class="tags">link</a>标签让你来指定控制器和操作名称对,并且标签会自动生成基于<a href="../guide/single.html#urlmappings" class="guide">URL映射</a>的链接，即使映射改变了也没有问题，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:link action=<span class="xml&#45;quote">"show"</span> id=<span class="xml&#45;quote">"1"</span>&#62;</span>Book 1<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link action=<span class="xml&#45;quote">"show"</span> id=<span class="xml&#45;quote">"$&#123;currentBook.id&#125;"</span>&#62;</span>$&#123;currentBook.name&#125;<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link controller=<span class="xml&#45;quote">"book"</span>&#62;</span>Book Home<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link controller=<span class="xml&#45;quote">"book"</span> action=<span class="xml&#45;quote">"list"</span>&#62;</span>Book List<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link url=<span class="xml&#45;quote">"&#91;action: 'list', controller: 'book'&#93;"</span>&#62;</span>Book List<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link params=<span class="xml&#45;quote">"&#91;sort: 'title', order: 'asc', author: currentBook.author&#93;"</span>
        action=<span class="xml&#45;quote">"list"</span>&#62;</span>Book List<span class="xml&#45;tag">&#60;/g:link&#62;</span></pre></div>


<a name="6.2.2.5 Forms and Fields"><!-- Legacy link --></a>
<h2 id="formsAndFields">6.2.2.5 表单和字段</h2>
<div class="hidden-block">
<h4>Form Basics</h4><p class="paragraph"/>GSP supports many different tags for working with HTML forms and fields, the most basic of which is the <a href="../ref/Tags/form.html" class="tags">form</a> tag. This is a controller/action aware version of the regular HTML form tag. The <code>url</code> attribute lets you specify which controller and action to map to:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form name=<span class="xml&#45;quote">"myForm"</span> url=<span class="xml&#45;quote">"&#91;controller:'book',action:'list'&#93;"</span>&#62;</span>...<span class="xml&#45;tag">&#60;/g:form&#62;</span></pre></div><p class="paragraph"/>In this case we create a form called <code>myForm</code> that submits to the <code>BookController</code>'s <code>list</code> action. Beyond that all of the usual HTML attributes apply.
</div><p class="paragraph"/><h4>表单基础</h4><p class="paragraph"/>GSP有很多不同的标签来支持HTML表单和字段，不过最基础的还是<a href="../ref/Tags/form.html" class="tags">form</a>标签。常规的HTML表单标签支持controller/action属性，而<code>url</code>属性让你以映射（map）的方式来指定controller和action：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form name=<span class="xml&#45;quote">"myForm"</span> url=<span class="xml&#45;quote">"&#91;controller:'book',action:'list'&#93;"</span>&#62;</span>...<span class="xml&#45;tag">&#60;/g:form&#62;</span></pre></div><p class="paragraph"/>在这个示例中，我们创建了一个<code>myForm</code>表单，它将会提交到<code>BookController</code>控制器的<code>list</code>操作。此外HTML的所有通用属性都可以使用。<p class="paragraph"/><div class="hidden-block">
<h4>Form Fields</h4><p class="paragraph"/>In addition to easy construction of forms, GSP supports custom tags for dealing with different types of fields, including:
<ul class="star">
<li><a href="../ref/Tags/textField.html" class="tags">textField</a> - For input fields of type 'text'</li>
<li><a href="../ref/Tags/passwordField.html" class="tags">passwordField</a> - For input fields of type 'password'</li>
<li><a href="../ref/Tags/checkBox.html" class="tags">checkBox</a> - For input fields of type 'checkbox'</li>
<li><a href="../ref/Tags/radio.html" class="tags">radio</a> - For input fields of type 'radio'</li>
<li><a href="../ref/Tags/hiddenField.html" class="tags">hiddenField</a> - For input fields of type 'hidden'</li>
<li><a href="../ref/Tags/select.html" class="tags">select</a> - For dealing with HTML select boxes</li>
</ul><p class="paragraph"/>Each of these allows GSP expressions for the value:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"myField"</span> value=<span class="xml&#45;quote">"$&#123;myValue&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>GSP also contains extended helper versions of the above tags such as <a href="../ref/Tags/radioGroup.html" class="tags">radioGroup</a> (for creating groups of <a href="../ref/Tags/radio.html" class="tags">radio</a> tags), <a href="../ref/Tags/localeSelect.html" class="tags">localeSelect</a>, <a href="../ref/Tags/currencySelect.html" class="tags">currencySelect</a> and <a href="../ref/Tags/timeZoneSelect.html" class="tags">timeZoneSelect</a> (for selecting locales, currencies and time zones respectively).
</div><p class="paragraph"/><h4>表单字段</h4><p class="paragraph"/>除了轻松地构造表单之外，GSP自定义的标签支持不同的字段类型，包括：
<ul class="star">
<li><a href="../ref/Tags/textField.html" class="tags">textField</a> - 针对类型是'text'的输入字段</li>
<li><a href="../ref/Tags/passwordField.html" class="tags">passwordField</a> - 针对类型是'password'的输入字段</li>
<li><a href="../ref/Tags/checkBox.html" class="tags">checkBox</a> - 针对类型是'checkbox'的输入字段</li>
<li><a href="../ref/Tags/radio.html" class="tags">radio</a> - 针对类型是'radio'的输入字段</li>
<li><a href="../ref/Tags/hiddenField.html" class="tags">hiddenField</a> - 针对类型是'hidden'的输入字段</li>
<li><a href="../ref/Tags/select.html" class="tags">select</a> - 针对HTML的下拉框（select boxes）</li>
</ul><p class="paragraph"/>这些标签的value属性都允许使用GSP表达式：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:textField name=<span class="xml&#45;quote">"myField"</span> value=<span class="xml&#45;quote">"$&#123;myValue&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>GSP还包含上述标签扩展的助手版本，比如<a href="../ref/Tags/radioGroup.html" class="tags">radioGroup</a>（用于创建一组<a href="../ref/Tags/radio.html" class="tags">radio</a>标签）、<a href="../ref/Tags/localeSelect.html" class="tags">localeSelect</a>、<a href="../ref/Tags/currencySelect.html" class="tags">currencySelect</a>和<a href="../ref/Tags/timeZoneSelect.html" class="tags">timeZoneSelect</a>（用于选择区域、货币和时区）。<p class="paragraph"/><div class="hidden-block">
<h4>Multiple Submit Buttons</h4><p class="paragraph"/>The age old problem of dealing with multiple submit buttons is also handled elegantly with Grails using the <a href="../ref/Tags/actionSubmit.html" class="tags">actionSubmit</a> tag. It is just like a regular submit, but lets you specify an alternative action to submit to:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:actionSubmit value=<span class="xml&#45;quote">"Some update label"</span> action=<span class="xml&#45;quote">"update"</span> /&#62;</span></pre></div>
</div><p class="paragraph"/><h4>多个提交按钮</h4><p class="paragraph"/>处理多个提交按钮这一个古老的问题，也得到优雅的解决，那就是使用Grails的<a href="../ref/Tags/actionSubmit.html" class="tags">actionSubmit</a>标签。跟常规的提交类似，只不过你可以指定另外一个操作来提交：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:actionSubmit value=<span class="xml&#45;quote">"Some update label"</span> action=<span class="xml&#45;quote">"update"</span> /&#62;</span></pre></div>


<a name="6.2.2.6 Tags as Method Calls"><!-- Legacy link --></a>
<h2 id="tagsAsMethodCalls">6.2.2.6 标签的方法调用</h2>
<div class="hidden-block">
One major different between GSP tags and other tagging technologies is that GSP tags can be called as either regular tags or as method calls from <a href="../guide/single.html#controllers" class="guide">controllers</a>, <a href="../guide/single.html#taglibs" class="guide">tag libraries</a> or GSP views.<p class="paragraph"/><h4>Tags as method calls from GSPs</h4><p class="paragraph"/>Tags return their results as a String-like object (a <code>StreamCharBuffer</code> which has all of the same methods as String) instead of writing directly to the response when called as methods. For example:<p class="paragraph"/><div class="code"><pre>Static Resource: $&#123;createLinkTo(dir: <span class="xml&#45;quote">"images"</span>, file: <span class="xml&#45;quote">"logo.jpg"</span>)&#125;</pre></div><p class="paragraph"/>This is particularly useful for using a tag within an attribute:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;img src=<span class="xml&#45;quote">"$&#123;createLinkTo(dir: 'images', file: 'logo.jpg')&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>In view technologies that don't support this feature you have to nest tags within tags, which becomes messy quickly and often has an adverse effect of WYSWIG tools such as Dreamweaver that attempt to render the mark-up as it is not well-formed:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;img src=<span class="xml&#45;quote">"&#60;g:createLinkTo dir="</span>images<span class="xml&#45;quote">" file="</span>logo.jpg<span class="xml&#45;quote">" /&#62;</span>"</span> /&#62;</pre></div>
</div><p class="paragraph"/>One major different between GSP tags and other tagging technologies is that GSP tags can be called as either regular tags or as method calls from <a href="../guide/single.html#controllers" class="guide">controllers</a>, <a href="../guide/single.html#taglibs" class="guide">tag libraries</a> or GSP views.<p class="paragraph"/><h4>在GSP中以方法调用标签</h4><p class="paragraph"/>当标签以方法的方式调用时，其返回一个类似String（一个<code>StreamCharBuffer</code>，有着跟String完全相同的方法）的对象，而不是直接写回到响应器。比如：<p class="paragraph"/><div class="code"><pre>Static Resource: $&#123;createLinkTo(dir: <span class="xml&#45;quote">"images"</span>, file: <span class="xml&#45;quote">"logo.jpg"</span>)&#125;</pre></div><p class="paragraph"/>这在一个属性内使用标签的时候特别有用：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;img src=<span class="xml&#45;quote">"$&#123;createLinkTo(dir: 'images', file: 'logo.jpg')&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>在视图技术中，标签内嵌套标签是不被支持的，因为那将会很快导致混乱，而且像Dreamweaver这样所见即所得（WYSWIG）的工具产生不利的效果，因为那会破坏标签的结构良好性：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;img src=<span class="xml&#45;quote">"&#60;g:createLinkTo dir="</span>images<span class="xml&#45;quote">" file="</span>logo.jpg<span class="xml&#45;quote">" /&#62;</span>"</span> /&#62;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Tags as method calls from Controllers and Tag Libraries</h4><p class="paragraph"/>You can also invoke tags from controllers and tag libraries. Tags within the default <code>g:</code> <a href="../guide/single.html#namespaces" class="guide">namespace</a> can be invoked without the prefix and a <code>StreamCharBuffer</code> result is returned:<p class="paragraph"/><div class="code"><pre>def imageLocation = createLinkTo(dir:<span class="java&#45;quote">"images"</span>, file:<span class="java&#45;quote">"logo.jpg"</span>).toString()</pre></div><p class="paragraph"/>Prefix the namespace to avoid naming conflicts:<p class="paragraph"/><div class="code"><pre>def imageLocation = g.createLinkTo(dir:<span class="java&#45;quote">"images"</span>, file:<span class="java&#45;quote">"logo.jpg"</span>).toString()</pre></div><p class="paragraph"/>For tags that use a <a href="../guide/single.html#namespaces" class="guide">custom namespace</a>, use that prefix for the method call. For example (from the <a href="http://grails.org/plugin/fckeditor" target="blank">FCK Editor plugin</a>):<p class="paragraph"/><div class="code"><pre>def editor = fckeditor.editor(name: <span class="java&#45;quote">"text"</span>, width: <span class="java&#45;quote">"100%"</span>, height: <span class="java&#45;quote">"400"</span>)</pre></div>
</div><p class="paragraph"/><h4>在控制器和标签库中的以方法调用标签</h4><p class="paragraph"/>你可以可以在控制器和标签库中调用标签。<a href="../guide/single.html#namespaces" class="guide">命名空间</a>是<code>g:</code>的标签调用可以忽略其前缀，并且一个<code>StreamCharBuffer</code>类型的结果被返回：<p class="paragraph"/><div class="code"><pre>def imageLocation = createLinkTo(dir:<span class="java&#45;quote">"images"</span>, file:<span class="java&#45;quote">"logo.jpg"</span>).toString()</pre></div><p class="paragraph"/>命名空间前缀是用以避免名称冲突的：<p class="paragraph"/><div class="code"><pre>def imageLocation = g.createLinkTo(dir:<span class="java&#45;quote">"images"</span>, file:<span class="java&#45;quote">"logo.jpg"</span>).toString()</pre></div><p class="paragraph"/>对于那些使用<a href="../guide/single.html#namespaces" class="guide">自定义命名空间</a>的标签，在以方法调用时要使用其前缀。比如（来自<a href="http://grails.org/plugin/fckeditor" target="blank">FCK 编辑器插件</a>）：<p class="paragraph"/><div class="code"><pre>def editor = fckeditor.editor(name: <span class="java&#45;quote">"text"</span>, width: <span class="java&#45;quote">"100%"</span>, height: <span class="java&#45;quote">"400"</span>)</pre></div>


<a name="6.2.3 Views and Templates"><!-- Legacy link --></a>
<h2 id="viewsAndTemplates">6.2.3 视图和模板</h2>
<div class="hidden-block">
Grails also has the concept of templates. These are useful for partitioning your views into maintainable chunks, and combined with <a href="../guide/single.html#layouts" class="guide">Layouts</a> provide a highly re-usable mechanism for structured views.<p class="paragraph"/><h4>Template Basics</h4><p class="paragraph"/>Grails uses the convention of placing an underscore before the name of a view to identify it as a template. For example, you might have a template that renders Books located at <code>grails-app/views/book/_bookTemplate.gsp</code>:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"book"</span> id=<span class="xml&#45;quote">"$&#123;book?.id&#125;"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;div&#62;</span>Title: $&#123;book?.title&#125;<span class="xml&#45;tag">&#60;/div&#62;</span>
   <span class="xml&#45;tag">&#60;div&#62;</span>Author: $&#123;book?.author?.name&#125;<span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div><p class="paragraph"/>Use the <a href="../ref/Tags/render.html" class="tags">render</a> tag to render this template from one of the views in <code>grails-app/views/book</code>:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"bookTemplate"</span> model=<span class="xml&#45;quote">"&#91;book: myBook&#93;"</span> /&#62;</span></pre></div><p class="paragraph"/>Notice how we pass into a model to use using the <code>model</code> attribute of the <code>render</code> tag. If you have multiple <code>Book</code> instances you can also render the template for each <code>Book</code> using the render tag with a <code>collection</code> attribute:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"bookTemplate"</span> var=<span class="xml&#45;quote">"book"</span> collection=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span> /&#62;</span></pre></div>
</div><p class="paragraph"/>Grails也有模板的概念。这对于将你的视图分割成可维护的模块也是颇有裨益的，并且结合<a href="../guide/single.html#layouts" class="guide">布局</a>还可为结构化视图提供一个高复用机制。<p class="paragraph"/><h4>模板基础</h4><p class="paragraph"/>Grails使用在其视图名称前放置一个下划线的方式来标识一个模板。比如，你可能有一个渲染Books的模板，位于<code>grails-app/views/book/_bookTemplate.gsp</code>：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"book"</span> id=<span class="xml&#45;quote">"$&#123;book?.id&#125;"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;div&#62;</span>Title: $&#123;book?.title&#125;<span class="xml&#45;tag">&#60;/div&#62;</span>
   <span class="xml&#45;tag">&#60;div&#62;</span>Author: $&#123;book?.author?.name&#125;<span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div><p class="paragraph"/>你可以在<code>grails-app/views/book</code>中的一个视图中，使用<a href="../ref/Tags/render.html" class="tags">render</a>标签来渲染此模板：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"bookTemplate"</span> model=<span class="xml&#45;quote">"&#91;book: myBook&#93;"</span> /&#62;</span></pre></div><p class="paragraph"/>注意，我们是怎样使用<code>render</code>标签的<code>model</code>属性来传递模型的。如果你有多个<code>Book</code>实例，你还可以通过<code>render</code>标签的<code>collection</code>属性来为每一个<code>Book</code>渲染模板：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"bookTemplate"</span> var=<span class="xml&#45;quote">"book"</span> collection=<span class="xml&#45;quote">"$&#123;bookList&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Shared Templates</h4><p class="paragraph"/>In the previous example we had a template that was specific to the <code>BookController</code> and its views at <code>grails-app/views/book</code>. However, you may want to share templates across your application.<p class="paragraph"/>In this case you can place them in the root views directory at grails-app/views or any subdirectory below that location, and then with the template attribute use an absolute location starting with <code>/</code> instead of a relative location. For example if you had a template called <code>grails-app/views/shared/_mySharedTemplate.gsp</code>, you would reference it as:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"/shared/mySharedTemplate"</span> /&#62;</span></pre></div><p class="paragraph"/>You can also use this technique to reference templates in any directory from any view or controller:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"/book/bookTemplate"</span> model=<span class="xml&#45;quote">"&#91;book: myBook&#93;"</span> /&#62;</span></pre></div>
</div><p class="paragraph"/><h4>共享的模板</h4><p class="paragraph"/>在上一个示例中，我们有了一个跟<code>BookController</code>相关的模板，其视图都位于<code>grails-app/views/book</code>中。然而，有时候，你可能想将你的模板在整个应用中共享。<p class="paragraph"/>在这种情况下，你可以将模板放在grails-app/views这个视图根目录下，或者跟目录下的任意子目录中，然后在template属性中使用以<code>/</code>开头的绝对位置而非相对位置。比如，你有一个<code>grails-app/views/shared/_mySharedTemplate.gsp</code>模板，你就可以这样引用：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"/shared/mySharedTemplate"</span> /&#62;</span></pre></div><p class="paragraph"/>你也可以使用此技术来引用来自视图或者控制器的任意目录模板：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"/book/bookTemplate"</span> model=<span class="xml&#45;quote">"&#91;book: myBook&#93;"</span> /&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>The Template Namespace</h4><p class="paragraph"/>Since templates are used so frequently there is template namespace, called <code>tmpl</code>, available that makes using templates easier. Consider for example the following usage pattern:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"bookTemplate"</span> model=<span class="xml&#45;quote">"&#91;book:myBook&#93;"</span> /&#62;</span></pre></div><p class="paragraph"/>This can be expressed with the <code>tmpl</code> namespace as follows:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;tmpl:bookTemplate book=<span class="xml&#45;quote">"$&#123;myBook&#125;"</span> /&#62;</span></pre></div>
</div><p class="paragraph"/><h4>模板的命名空间</h4><p class="paragraph"/>因为模板是如此频繁地被使用，因此<code>tmpl</code>这个模板命名空间就产生了，这样模板的使用也更简易。比如下例所示地用法：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:render template=<span class="xml&#45;quote">"bookTemplate"</span> model=<span class="xml&#45;quote">"&#91;book:myBook&#93;"</span> /&#62;</span></pre></div><p class="paragraph"/>使用了<code>tmpl</code>命名空间的表达如下所示：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;tmpl:bookTemplate book=<span class="xml&#45;quote">"$&#123;myBook&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Templates in Controllers and Tag Libraries</h4><p class="paragraph"/>You can also render templates from controllers using the <a href="../ref/Controllers/render.html" class="controllers">render</a> controller method. This is useful for <a href="../guide/single.html#ajax" class="guide">Ajax</a> applications where you generate small HTML or data responses to partially update the current page instead of performing new request:<p class="paragraph"/><div class="code"><pre>def bookData() &#123;
    def b = Book.get(params.id)
    render(template:<span class="java&#45;quote">"bookTemplate"</span>, model:&#91;book:b&#93;)
&#125;</pre></div><p class="paragraph"/>The <a href="../ref/Controllers/render.html" class="controllers">render</a> controller method writes directly to the response, which is the most common behaviour. To instead obtain the result of template as a String you can use the <a href="../ref/Tags/render.html" class="tags">render</a> tag:<p class="paragraph"/><div class="code"><pre>def bookData() &#123;
    def b = Book.get(params.id)
    <span class="java&#45;object">String</span> content = g.render(template:<span class="java&#45;quote">"bookTemplate"</span>, model:&#91;book:b&#93;)
    render content
&#125;</pre></div><p class="paragraph"/>Notice the usage of the <code>g</code> namespace which tells Grails we want to use the <a href="../guide/single.html#tagsAsMethodCalls" class="guide">tag as method call</a> instead of the <a href="../ref/Controllers/render.html" class="controllers">render</a> method.
</div><p class="paragraph"/><h4>控制器和标签库的模板</h4><p class="paragraph"/>你还可以在控制器中使用<a href="../ref/Controllers/render.html" class="controllers">render</a>方法来渲染模板。这在<a href="../guide/single.html#ajax" class="guide">Ajax</a>的应用中是非常有用的，你可以通过生成小的HTML或者数据响应来部分的更新当前页面，而不是发起一个新的请求：<p class="paragraph"/><div class="code"><pre>def bookData() &#123;
    def b = Book.get(params.id)
    render(template:<span class="java&#45;quote">"bookTemplate"</span>, model:&#91;book:b&#93;)
&#125;</pre></div><p class="paragraph"/>通常情况下，控制器的<a href="../ref/Controllers/render.html" class="controllers">render</a>方法直接将内容写回到响应器中。如果你只想获得模板的String结果，你可以使用<a href="../ref/Tags/render.html" class="tags">render</a>标签：<p class="paragraph"/><div class="code"><pre>def bookData() &#123;
    def b = Book.get(params.id)
    <span class="java&#45;object">String</span> content = g.render(template:<span class="java&#45;quote">"bookTemplate"</span>, model:&#91;book:b&#93;)
    render content
&#125;</pre></div><p class="paragraph"/>请注意<code>g</code>命名空间的用法，它会让Grails知道我们想用<a href="../guide/single.html#tagsAsMethodCalls" class="guide">标签的方法调用</a>，而不是<a href="../ref/Controllers/render.html" class="controllers">render</a>方法。


<a name="6.2.4 Layouts with Sitemesh"><!-- Legacy link --></a>
<h2 id="layouts">6.2.4 使用Sitemesh布局</h2>
<div class="hidden-block">
<h4>Creating Layouts</h4><p class="paragraph"/>Grails leverages <a href="http://www.opensymphony.com/sitemesh/" target="blank">Sitemesh</a>, a decorator engine, to support view layouts. Layouts are located in the <code>grails-app/views/layouts</code> directory. A typical layout can be seen below:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;head&#62;</span>
        <span class="xml&#45;tag">&#60;title&#62;</span><span class="xml&#45;tag">&#60;g:layoutTitle default=<span class="xml&#45;quote">"An example decorator"</span> /&#62;</span><span class="xml&#45;tag">&#60;/title&#62;</span>
        <span class="xml&#45;tag">&#60;g:layoutHead /&#62;</span>
    <span class="xml&#45;tag">&#60;/head&#62;</span>
    <span class="xml&#45;tag">&#60;body onload=<span class="xml&#45;quote">"$&#123;pageProperty(name:'body.onload')&#125;"</span>&#62;</span>
        <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"menu"</span>&#62;</span><span class="xml&#45;comment">&#60;!&#45;&#45;my common menu goes here&#45;&#45;&#62;</span><span class="xml&#45;tag">&#60;/menu&#62;</span>
            <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"body"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:layoutBody /&#62;</span>
            <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
    <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>The key elements are the <a href="../ref/Tags/layoutHead.html" class="tags">layoutHead</a>, <a href="../ref/Tags/layoutTitle.html" class="tags">layoutTitle</a> and <a href="../ref/Tags/layoutBody.html" class="tags">layoutBody</a> tag invocations:
<ul class="star">
<li><code>layoutTitle</code> - outputs the target page's title</li>
<li><code>layoutHead</code> - outputs the target page's head tag contents</li>
<li><code>layoutBody</code> - outputs the target page's body tag contents</li>
</ul><p class="paragraph"/>The previous example also demonstrates the <a href="../ref/Tags/pageProperty.html" class="tags">pageProperty</a> tag which can be used to inspect and return aspects of the target page.
</div><p class="paragraph"/><h4>创建布局</h4><p class="paragraph"/>Grails使用<a href="http://www.opensymphony.com/sitemesh/" target="blank">Sitemesh</a>（一个装饰引擎）来支持视图布局。布局位于<code>grails-app/views/layouts</code>目录下边。一个典型的布局可以如下所示：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;head&#62;</span>
        <span class="xml&#45;tag">&#60;title&#62;</span><span class="xml&#45;tag">&#60;g:layoutTitle default=<span class="xml&#45;quote">"An example decorator"</span> /&#62;</span><span class="xml&#45;tag">&#60;/title&#62;</span>
        <span class="xml&#45;tag">&#60;g:layoutHead /&#62;</span>
    <span class="xml&#45;tag">&#60;/head&#62;</span>
    <span class="xml&#45;tag">&#60;body onload=<span class="xml&#45;quote">"$&#123;pageProperty(name:'body.onload')&#125;"</span>&#62;</span>
        <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"menu"</span>&#62;</span><span class="xml&#45;comment">&#60;!&#45;&#45;my common menu goes here&#45;&#45;&#62;</span><span class="xml&#45;tag">&#60;/menu&#62;</span>
            <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"body"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:layoutBody /&#62;</span>
            <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
    <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>所涉及到的关键元素是<a href="../ref/Tags/layoutHead.html" class="tags">layoutHead</a>、<a href="../ref/Tags/layoutTitle.html" class="tags">layoutTitle</a>和<a href="../ref/Tags/layoutBody.html" class="tags">layoutBody</a>标签：
<ul class="star">
<li><code>layoutTitle</code> - 输出目标页面的标题（title）</li>
<li><code>layoutHead</code> - 输出目标页面的head标签的内容</li>
<li><code>layoutBody</code> - 输出目标页面的body标签的内容</li>
</ul><p class="paragraph"/>在上述示例中，也演示了<a href="../ref/Tags/pageProperty.html" class="tags">pageProperty</a>标签的用法，其用来检查和返回目标页面的详情。<p class="paragraph"/><div class="hidden-block">
<h4>Triggering Layouts</h4><p class="paragraph"/>There are a few ways to trigger a layout. The simplest is to add a meta tag to the view:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;head&#62;</span>
        <span class="xml&#45;tag">&#60;title&#62;</span>An Example Page<span class="xml&#45;tag">&#60;/title&#62;</span>
        <span class="xml&#45;tag">&#60;meta name=<span class="xml&#45;quote">"layout"</span> content=<span class="xml&#45;quote">"main"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;/head&#62;</span>
    <span class="xml&#45;tag">&#60;body&#62;</span>This is my content!<span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>In this case a layout called <code>grails-app/views/layouts/main.gsp</code> will be used to layout the page. If we were to use the layout from the previous section the output would resemble this:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;head&#62;</span>
        <span class="xml&#45;tag">&#60;title&#62;</span>An Example Page<span class="xml&#45;tag">&#60;/title&#62;</span>
    <span class="xml&#45;tag">&#60;/head&#62;</span>
    <span class="xml&#45;tag">&#60;body onload=<span class="xml&#45;quote">""</span>&#62;</span>
        <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"menu"</span>&#62;</span><span class="xml&#45;comment">&#60;!&#45;&#45;my common menu goes here&#45;&#45;&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"body"</span>&#62;</span>
            This is my content!
        <span class="xml&#45;tag">&#60;/div&#62;</span>
    <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div>
</div><p class="paragraph"/><h4>触发布局</h4><p class="paragraph"/>有几种方法来触发一个布局。最简单的一种就是在视图中增加一个meta标签：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;head&#62;</span>
        <span class="xml&#45;tag">&#60;title&#62;</span>An Example Page<span class="xml&#45;tag">&#60;/title&#62;</span>
        <span class="xml&#45;tag">&#60;meta name=<span class="xml&#45;quote">"layout"</span> content=<span class="xml&#45;quote">"main"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;/head&#62;</span>
    <span class="xml&#45;tag">&#60;body&#62;</span>This is my content!<span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>在上述示例中，一个名为<code>grails-app/views/layouts/main.gsp</code>的布局将被用于安排页面。如果我们使用上一小节的布局，那么其输出类似下面所示：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;head&#62;</span>
        <span class="xml&#45;tag">&#60;title&#62;</span>An Example Page<span class="xml&#45;tag">&#60;/title&#62;</span>
    <span class="xml&#45;tag">&#60;/head&#62;</span>
    <span class="xml&#45;tag">&#60;body onload=<span class="xml&#45;quote">""</span>&#62;</span>
        <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"menu"</span>&#62;</span><span class="xml&#45;comment">&#60;!&#45;&#45;my common menu goes here&#45;&#45;&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"body"</span>&#62;</span>
            This is my content!
        <span class="xml&#45;tag">&#60;/div&#62;</span>
    <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Specifying A Layout In A Controller</h4><p class="paragraph"/>Another way to specify a layout is to specify the name of the layout by assigning a value to the "layout" property in a controller. For example, if you have a controller such as:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    <span class="java&#45;keyword">static</span> layout = 'customer'<p class="paragraph"/>    def list() &#123; &#8230; &#125;
&#125;</pre></div><p class="paragraph"/>You can create a layout called <code>grails-app/views/layouts/customer.gsp</code> which will be applied to all views that the <code>BookController</code> delegates to.  The value of the "layout" property may contain a directory structure relative to the <code>grails-app/views/layouts/</code> directory.  For example:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    <span class="java&#45;keyword">static</span> layout = 'custom/customer'<p class="paragraph"/>    def list() &#123; &#8230; &#125;
&#125;</pre></div><p class="paragraph"/>Views rendered from that controller would be decorated with the <code>grails-app/views/layouts/custom/customer.gsp</code> template.
</div><p class="paragraph"/><h4>在控制器中指定一个布局</h4><p class="paragraph"/>另外一种指定布局的方法是在控制器中为"layout"属性赋值一个布局的名称。举一个例子，假设你有如下一个控制器：<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    <span class="java&#45;keyword">static</span> layout = 'customer'<p class="paragraph"/>    def list() &#123; &#8230; &#125;
&#125;</pre></div><p class="paragraph"/>你就可以创建一个<code>grails-app/views/layouts/customer.gsp</code>布局，这样<code>BookController</code>所有的所有视图将使用此布局。"layout"属性的值还可以包含一个目录结构，不过要相对于<code>grails-app/views/layouts/</code>目录。比如：<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    <span class="java&#45;keyword">static</span> layout = 'custom/customer'<p class="paragraph"/>    def list() &#123; &#8230; &#125;
&#125;</pre></div><p class="paragraph"/>那个控制器所渲染的视图将使用<code>grails-app/views/layouts/custom/customer.gsp</code>模板来装饰。<p class="paragraph"/><div class="hidden-block">
<h4>Layout by Convention</h4><p class="paragraph"/>Another way to associate layouts is to use "layout by convention". For example, if you have this controller:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def list() &#123; &#8230; &#125;
&#125;</pre></div><p class="paragraph"/>You can create a layout called <code>grails-app/views/layouts/book.gsp</code>, which will be applied to all views that the <code>BookController</code> delegates to.<p class="paragraph"/>Alternatively, you can create a layout called <code>grails-app/views/layouts/book/list.gsp</code> which will only be applied to the <code>list</code> action within the <code>BookController</code>.<p class="paragraph"/>If you have both the above mentioned layouts in place the layout specific to the action will take precedence when the list action is executed.<p class="paragraph"/>If a layout may not be located using any of those conventions, the convention of last resort is to look for the application default layout which
is <code>grails-app/views/layouts/application.gsp</code>.  The name of the application default layout may be changed by defining a property
in <code>grails-app/conf/Config.groovy</code> as follows:<p class="paragraph"/><div class="code"><pre>grails.sitemesh.<span class="java&#45;keyword">default</span>.layout = 'myLayoutName'</pre></div><p class="paragraph"/>With that property in place, the application default layout will be <code>grails-app/views/layouts/myLayoutName.gsp</code>.
</div><p class="paragraph"/><h4>布局规约</h4><p class="paragraph"/>另外一种关联布局的方式是使用"布局规约"。比如，你的控制器如下所示：<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def list() &#123; &#8230; &#125;
&#125;</pre></div><p class="paragraph"/>你可以创建<code>grails-app/views/layouts/book.gsp</code>布局，此布局将会应用于一个<code>BookController</code>的所有视图。<p class="paragraph"/>此外，你也可以创建一个<code>grails-app/views/layouts/book/list.gsp</code>布局，其用于<code>BookController</code>的<code>list</code>操作。<p class="paragraph"/>如果你有如上所述的两个布局，那么当list操作被执行时，跟操作相关的布局将优先使用。<p class="paragraph"/>如果一个布局在这些约定中没有找到，那么此规约的最后顺序是查找应用的缺省布局<code>grails-app/views/layouts/application.gsp</code>。应用的缺省布局名称可以通过修改<code>grails-app/conf/Config.groovy</code>中的属性来改变，比如：<p class="paragraph"/><div class="code"><pre>grails.sitemesh.<span class="java&#45;keyword">default</span>.layout = 'myLayoutName'</pre></div><p class="paragraph"/>设置新值后，应用的缺省布局将是<code>grails-app/views/layouts/myLayoutName.gsp</code>。<p class="paragraph"/><div class="hidden-block">
<h4>Inline Layouts</h4><p class="paragraph"/>Grails' also supports Sitemesh's concept of inline layouts with the <a href="../ref/Tags/applyLayout.html" class="tags">applyLayout</a> tag. This can be used to apply a layout to a template, URL or arbitrary section of content. This lets you even further modularize your view structure by "decorating" your template includes.<p class="paragraph"/>Some examples of usage can be seen below:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span> template=<span class="xml&#45;quote">"bookTemplate"</span> collection=<span class="xml&#45;quote">"$&#123;books&#125;"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span> url=<span class="xml&#45;quote">"http://www.google.com"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span>&#62;</span>
The content to apply a layout to
<span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span></pre></div>
</div><p class="paragraph"/><h4>内联布局</h4><p class="paragraph"/>Grails同样支持Sitemesh的内联布局概念，可以使用<a href="../ref/Tags/applyLayout.html" class="tags">applyLayout</a>标签来实现。此标签可以将一个布局应用于一个模板，URL或者任意部分的内容。更甚者，通过“装饰”你的模板你可以将你的视图模块化。<p class="paragraph"/>这些用法的一些示例如下：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span> template=<span class="xml&#45;quote">"bookTemplate"</span> collection=<span class="xml&#45;quote">"$&#123;books&#125;"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span> url=<span class="xml&#45;quote">"http://www.google.com"</span> /&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span>&#62;</span>
The content to apply a layout to
<span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Server-Side Includes</h4><p class="paragraph"/>While the <a href="../ref/Tags/applyLayout.html" class="tags">applyLayout</a> tag is useful for applying layouts to external content, if you simply want to include external content in the current page you use the <a href="../ref/Tags/include.html" class="tags">include</a> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:include controller=<span class="xml&#45;quote">"book"</span> action=<span class="xml&#45;quote">"list"</span> /&#62;</span></pre></div><p class="paragraph"/>You can even combine the <a href="../ref/Tags/include.html" class="tags">include</a> tag and the <a href="../ref/Tags/applyLayout.html" class="tags">applyLayout</a> tag for added flexibility:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;g:include controller=<span class="xml&#45;quote">"book"</span> action=<span class="xml&#45;quote">"list"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span></pre></div><p class="paragraph"/>Finally, you can also call the <a href="../ref/Tags/include.html" class="tags">include</a> tag from a controller or tag library as a method:<p class="paragraph"/><div class="code"><pre>def content = include(controller:<span class="java&#45;quote">"book"</span>, action:<span class="java&#45;quote">"list"</span>)</pre></div><p class="paragraph"/>The resulting content will be provided via the return value of the <a href="../ref/Tags/include.html" class="tags">include</a> tag.
</div><p class="paragraph"/><h4>服务器端的包含</h4><p class="paragraph"/><a href="../ref/Tags/applyLayout.html" class="tags">applyLayout</a>标签可以将布局应用到外部内容，而如果你只想简单地将外部内容包含到当前页面，你可以使用<a href="../ref/Tags/include.html" class="tags">include</a>标签：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:include controller=<span class="xml&#45;quote">"book"</span> action=<span class="xml&#45;quote">"list"</span> /&#62;</span></pre></div><p class="paragraph"/>你甚至可以灵活地组合<a href="../ref/Tags/include.html" class="tags">include</a>和<a href="../ref/Tags/applyLayout.html" class="tags">applyLayout</a>标签，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"myLayout"</span>&#62;</span>
   <span class="xml&#45;tag">&#60;g:include controller=<span class="xml&#45;quote">"book"</span> action=<span class="xml&#45;quote">"list"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span></pre></div><p class="paragraph"/>最后，你还可以从控制器或者标签库中将<a href="../ref/Tags/include.html" class="tags">include</a>标签作为方法来调用：<p class="paragraph"/><div class="code"><pre>def content = include(controller:<span class="java&#45;quote">"book"</span>, action:<span class="java&#45;quote">"list"</span>)</pre></div><p class="paragraph"/>由此产生的内容是通过<a href="../ref/Tags/include.html" class="tags">include</a>标签的返回值提供的。


<a name="6.2.5 Static Resources"><!-- Legacy link --></a>
<h2 id="resources">6.2.5 静态资源</h2>
<div class="hidden-block">
Grails 2.0 integrates with the <a href="http://grails.org/plugin/resources" target="blank">Resources plugin</a> to provide sophisticated static resource management. This plugin is installed by default in new Grails applications.<p class="paragraph"/>The basic way to include a link to a static resource in your application is to use the <a href="../ref/Tags/resource.html" class="tags">resource</a> tag. This simple approach creates a URI pointing to the file.<p class="paragraph"/>However modern applications with dependencies on multiple JavaScript and CSS libraries and frameworks (as well as dependencies on multiple Grails plugins) require something more powerful.<p class="paragraph"/>The issues that the Resources framework tackles are:
<ul class="star">
<li>Web application performance tuning is difficult</li>
<li>Correct ordering of resources, and deferred inclusion of JavaScript</li>
<li>Resources that depend on others that must be loaded first</li>
<li>The need for a standard way to expose static resources in plugins and applications</li>
<li>The need for an extensible processing chain to optimize resources</li>
<li>Preventing multiple inclusion of the same resource</li>
</ul><p class="paragraph"/>The plugin achieves this by introducing new artefacts and processing the resources using the server's local file system.<p class="paragraph"/>It adds artefacts for declaring resources, for declaring "mappers" that can process resources, and a servlet filter to serve processed resources.<p class="paragraph"/>What you get is an incredibly advanced resource system that enables you to easily create highly optimized web applications that run the same in development and in production.<p class="paragraph"/>The Resources plugin documentation provides a more detailed overview of the <a href="http://grails-plugins.github.com/grails-resources/" target="blank">concepts</a> which will be beneficial when reading the following guide.
</div><p class="paragraph"/>Grails 2.0集成了<a href="http://grails.org/plugin/resources" target="blank">资源插件</a>以提供更复杂的静态资源管理。此插件在新建Grails应用中是缺省安装的。<p class="paragraph"/>在你的应用中要引用一个静态资源链接的基本方法，就是使用<a href="../ref/Tags/resource.html" class="tags">resource</a>标签。此种方式会创建一个指向文件的URI。<p class="paragraph"/>但是，现在的应用往往会依赖于多个JavaScript、CSS库和框架（即依赖于多个Grails插件），这就要求一些更强大的功能来支撑。<p class="paragraph"/>本资源（Resources）框架要解决的主要问题如下：
<ul class="star">
<li>Web应用的性能调优是非常困难的</li>
<li>正确地对资源排序，推迟引用JavaScript</li>
<li>依赖于其他的资源必须要优先加载</li>
<li>在插件和应用中需要采用一种标准的方式来暴露静态资源</li>
<li>需要扩展性更好的处理链来优化资源</li>
<li>阻止同样的资源被多次引用</li>
</ul><p class="paragraph"/>本插件通过引入新的工件（artefacts）和服务器端的本地文件系统来达到上述目标。<p class="paragraph"/>新增的工件用以声明资源，这些声明式的“映射（mappers）”可以对资源进行处理，一个servlet过滤器使用那些被处理过的资源。<p class="paragraph"/>通过此高级的资源系统，你能得到的不可思议结果是，在同样的开发和生产环境中，你能够轻松地创建高优化的web应用。<p class="paragraph"/>资源插件的官方文档提供了更详细的<a href="http://grails-plugins.github.com/grails-resources/" target="blank">概念</a>概述，对于阅读后续的内容，颇有裨益。


<a name="6.2.5.1 Including resources using the resource tags"><!-- Legacy link --></a>
<h2 id="includingResourcesUsingTheResourceTags">6.2.5.1 通过资源标签引用资源</h2>
<div class="hidden-block">
<h4>Pulling in resources with r:require</h4><p class="paragraph"/>To use resources, your GSP page must indicate which resource modules it requires. For example with the <a href="http://grails.org/plugin/jquery" target="blank">jQuery plugin</a>, which exposes a "jquery" resource module, to use jQuery in any page on your site you simply add:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;r:require module=<span class="xml&#45;quote">"jquery"</span>/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      &#8230;
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>This will automatically include all resources needed for jQuery, including them at the correct locations in the page. By default the plugin sets the disposition to be "head", so they load early in the page.<p class="paragraph"/>You can call <code>r:require</code> multiple times in a GSP page, and you use the "modules" attribute to provide a list of modules:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;r:require modules=<span class="xml&#45;quote">"jquery, main, blueprint, charting"</span>/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      &#8230;
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>The above may result in many JavaScript and CSS files being included, in the correct order, with some JavaScript files loading at the end of the body to improve the apparent page load time.<p class="paragraph"/>However you cannot use r:require in isolation - as per the examples you must have the &#60;r:layoutResources/&#62; tag to actually perform the render.
</div><p class="paragraph"/><h4>使用r:require获取资源</h4><p class="paragraph"/>要使用资源，你的GSP页面必须要知道那些资源模块是所需要的。以<a href="http://grails.org/plugin/jquery" target="blank">jQuery插件</a>为例，其导出了一个"jquery"的资源模块，要在你站点的任何页面使用jQuery，你需要简单地增加如下代码：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;r:require module=<span class="xml&#45;quote">"jquery"</span>/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      &#8230;
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>这将自动地包含所有需要jQuery的资源，并且要在页面的正确位置引用它们。缺省情况下，插件将其放置到"head"，以便在页面中尽早加载。<p class="paragraph"/>你可以在GSP页面中多次调用<code>r:require</code>，也可以使用"modules"属性提供一个模块列表：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;r:require modules=<span class="xml&#45;quote">"jquery, main, blueprint, charting"</span>/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      &#8230;
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>在上例的结果中，很多的JavaScript和CSS文件以正确的顺序被包含进来，而另外一些JavaScript文件则在body的末尾被加载，以提高页面的加载时间。<p class="paragraph"/>不过，你还是不能单独使用r:require的－正如示例所示，你必须使用&#60;r:layoutResources/&#62;标签来执行实际的渲染。<p class="paragraph"/><div class="hidden-block">
<h4>Rendering the links to resources with r:layoutResources</h4><p class="paragraph"/>When you have declared the resource modules that your GSP page requires, the framework needs to render the links to those resources at the correct time.<p class="paragraph"/>To achieve this correctly, you must include the r:layoutResources tag twice in your page, or more commonly, in your GSP layout:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutTitle/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutBody/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>This represents the simplest Sitemesh layout you can have that supports Resources.<p class="paragraph"/>The Resources framework has the concept of a "disposition" for every resource. This is an indication of where in the page the resource should be included.<p class="paragraph"/>The default disposition applied depends on the type of resource. All CSS must be rendered in &#60;head&#62; in HTML, so "head" is the default for all CSS, and will be rendered by the first r:layoutResources. Page load times are improved when JavaScript is loaded after the page content, so the default for JavaScript files is "defer", which means it is rendered when the second r:layoutResources is invoked.<p class="paragraph"/>Note that both your GSP page and your Sitemesh layout (as well as any GSP template fragments) can call r:require to depend on resources. The only limitation is that you must call r:require before the r:layoutResources that should render it.
</div><p class="paragraph"/><h4>使用r:layoutResources渲染资源链接</h4><p class="paragraph"/>当在你的GSP页面中声明所需要的资源模块时，插件框架需要在正确的时间渲染那些资源的链接。<p class="paragraph"/>要正确地处理，你必须在你的页面中引用两次r:layoutResources标签，或者更通用的方式是在你的GSP布局中处理：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutTitle/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutBody/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>上例描绘了一个最简单的支撑资源的Sitemesh布局。<p class="paragraph"/>资源框架的每一个资源都有“安排（disposition）”的概念。这意味着在页面合适位置，资源将被包含进来。<p class="paragraph"/>缺省的安排依赖于资源的类型。所有的CSS必须在HTML的&#60;head&#62;中渲染，因此对所有的CSS来说，"head"是其缺省值，并且将被第一个r:layoutResources所渲染。当页面内容被加载完后，再加载JavaScript，那么页面的加载时间将得到很好的提高，因此对于JavaScript文件来说，其缺省值是"defer"，这意味着它们将在第二个r:layoutResources被调用的时候被渲染。<p class="paragraph"/>注意！不管你是GSP页面还是Sitemesh布局（即任何GSP模板片段）都可以根据资源来调用r:require。此处唯一的限制就是你必须在r:layoutResources渲染之前调用r:require。<p class="paragraph"/><div class="hidden-block">
<h4>Adding page-specific JavaScript code with r:script</h4><p class="paragraph"/>Grails has the <a href="../ref/Tags/javascript.html" class="tags">javascript</a> tag which is adapted to defer to Resources plugin if installed, but it is recommended that you call <code>r:script</code> directly when you need to include fragments of JavaScript code.<p class="paragraph"/>This lets you write some "inline" JavaScript which is actually <strong class="bold">not</strong> rendered inline, but either in the &#60;head&#62; or at the end of the body, based on the disposition.<p class="paragraph"/>Given a Sitemesh layout like this:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutTitle/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutBody/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>...in your GSP you can inject some JavaScript code into the head or deferred regions of the page like this:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;title&#62;</span>Testing r:script magic!<span class="xml&#45;tag">&#60;/title&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;r:script disposition=<span class="xml&#45;quote">"head"</span>&#62;</span>
         window.alert('This is at the end of <span class="xml&#45;tag">&#60;head&#62;</span>');
      <span class="xml&#45;tag">&#60;/r:script&#62;</span>
      <span class="xml&#45;tag">&#60;r:script disposition=<span class="xml&#45;quote">"defer"</span>&#62;</span>
         window.alert('This is at the end of the body, and the page has loaded.');
      <span class="xml&#45;tag">&#60;/r:script&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>The default disposition is "defer", so the disposition in the latter r:script is purely included for demonstration.<p class="paragraph"/>Note that such r:script code fragments <strong class="bold">always</strong> load after any modules that you have used, to ensure that any required libraries have loaded.
</div><p class="paragraph"/><h4>使用r:script增加特定页面的JavaScript代码</h4><p class="paragraph"/>在资源插件安装以后，Grails的<a href="../ref/Tags/javascript.html" class="tags">javascript</a>标签将被适配到优先使用资源插件，即便如此，如果你需要直接使用JavaScript代码片段，还是推荐你直接调用<code>r:script</code>。<p class="paragraph"/>这可以让你写一些“内联（inline）”的JavaScript，但实际 <strong class="bold">不在</strong> 内联时渲染，而是根据其安排，决定是在&#60;head&#62;或者body的结尾。<p class="paragraph"/>假设一个Sitemesh布局如下所示：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutTitle/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;g:layoutBody/&#62;</span>
      <span class="xml&#45;tag">&#60;r:layoutResources/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>...在你的GSP中，你可以插入一些JavaScript代码到head或者如下面所示的页面推迟区域：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;title&#62;</span>Testing r:script magic!<span class="xml&#45;tag">&#60;/title&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;r:script disposition=<span class="xml&#45;quote">"head"</span>&#62;</span>
         window.alert('This is at the end of <span class="xml&#45;tag">&#60;head&#62;</span>');
      <span class="xml&#45;tag">&#60;/r:script&#62;</span>
      <span class="xml&#45;tag">&#60;r:script disposition=<span class="xml&#45;quote">"defer"</span>&#62;</span>
         window.alert('This is at the end of the body, and the page has loaded.');
      <span class="xml&#45;tag">&#60;/r:script&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>在本演示中，其缺省的安排是"defer"，所以在后面的安排中，r:script只是单纯地被包含进来。<p class="paragraph"/>注意！r:script的代码片段 <strong class="bold">总是</strong> 在你要使用的模块之后加载，因此要保证任何所依赖的都以及加载就绪。<p class="paragraph"/><div class="hidden-block">
<h4>Linking to images with r:img</h4><p class="paragraph"/>This tag is used to render <code>&#60;img&#62;</code> markup, using the Resources framework to process the resource on the fly (if configured to do so - e.g. make it eternally cacheable).<p class="paragraph"/>This includes any extra attributes on the <code>&#60;img&#62;</code> tag if the resource has been previously declared in a module.<p class="paragraph"/>With this mechanism you can specify the width, height and any other attributes in the resource declaration in the module, and they will be pulled in as necessary.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;title&#62;</span>Testing r:img<span class="xml&#45;tag">&#60;/title&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;r:img uri=<span class="xml&#45;quote">"/images/logo.png"</span>/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>Note that Grails has a built-in <code>g:img</code> tag as a shortcut for rendering <code>&#60;img&#62;</code> tags that refer to a static resource. The Grails <a href="../ref/Tags/img.html" class="tags">img</a> tag is Resources-aware and will delegate to <code>r:img</code> if found. However it is recommended that you use <code>r:img</code> directly if using the Resources plugin.<p class="paragraph"/>Alongside the regular Grails <a href="../ref/Tags/resource.html" class="tags">resource</a> tag attributes, this also supports the "uri" attribute for increased brevity.<p class="paragraph"/>See <a href="http://grails-plugins.github.com/grails-resources" target="blank">r:resource documentation</a> for full details.
</div><p class="paragraph"/><h4>使用r:img链接图片</h4><p class="paragraph"/>此标签被用以渲染HTML的<code>&#60;img&#62;</code>标签，并且通过资源框架来处理那些频繁访问的资源（如果配置了的话，比如使其永久的缓存）。<p class="paragraph"/>如果资源在以前已经被声明为一个模块的话，那么r:img会包含<code>&#60;img&#62;</code>标签的任何额外属性。<p class="paragraph"/>基于此机制，你可以在声明资源模块的时候，来指定width、height以及其他任何属性，然后在需要的时候获取一下即可。<p class="paragraph"/>比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
   <span class="xml&#45;tag">&#60;head&#62;</span>
      <span class="xml&#45;tag">&#60;title&#62;</span>Testing r:img<span class="xml&#45;tag">&#60;/title&#62;</span>
   <span class="xml&#45;tag">&#60;/head&#62;</span>
   <span class="xml&#45;tag">&#60;body&#62;</span>
      <span class="xml&#45;tag">&#60;r:img uri=<span class="xml&#45;quote">"/images/logo.png"</span>/&#62;</span>
   <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div><p class="paragraph"/>注意！Grails内置的<code>g:img</code>标签只是渲染静态资源<code>&#60;img&#62;</code>的一个快捷方式而已。Grails的<a href="../ref/Tags/img.html" class="tags">img</a>的标签如果感知到资源插件，那么将会将其代理给<code>r:img</code>。即便如此，如果使用了资源插件的话，还是推荐直接你使用<code>r:img</code>。<p class="paragraph"/>跟常规的Grails的<a href="../ref/Tags/resource.html" class="tags">resource</a>标签属性一样，为了增加简洁性，r:img也支撑"uri"属性。<p class="paragraph"/>更多完整的详细信息请参考<a href="http://grails-plugins.github.com/grails-resources" target="blank">r:resource文档</a>。


<a name="6.2.5.2 Other resource tags"><!-- Legacy link --></a>
<h2 id="otherResourceTags">6.2.5.2 其他资源标签</h2>
<div class="hidden-block">
<h4>r:resource</h4><p class="paragraph"/>This is equivalent to the Grails <a href="../ref/Tags/resource.html" class="Tags">resource</a> tag, returning a link to the processed static resource. Grails' own <code>g:resource</code> tag delegates to this implementation if found, but if your code requires the Resources plugin, you should use <code>r:resource</code> directly.<p class="paragraph"/>Alongside the regular Grails <a href="../ref/Tags/resource.html" class="Tags">resource</a> tag attributes, this also supports the "uri" attribute for increased brevity.<p class="paragraph"/>See <a href="http://grails-plugins.github.com/grails-resources" target="blank">r:resource documentation</a> for full details.
</div><p class="paragraph"/><h4>r:resource</h4><p class="paragraph"/>这跟Grails的<a href="../ref/Tags/resource.html" class="Tags">resource</a>标签相当，都是返回一个处理过的静态资源链接。如果发现资源插件已经安装，Grails自带的<code>g:resource</code>标签将代理给r:resource，但是如果你的代码依赖资源插件，最好还是直接使用<code>r:resource</code>的好。<p class="paragraph"/>跟常规的Grails的<a href="../ref/Tags/resource.html" class="tags">resource</a>标签属性一样，为了增加简洁性，r:resource也支撑"uri"属性。<p class="paragraph"/>更多完整的详细信息请参考<a href="http://grails-plugins.github.com/grails-resources" target="blank">r:resource文档</a>。<p class="paragraph"/><div class="hidden-block">
<h4>r:external</h4><p class="paragraph"/>This is a resource-aware version of Grails <a href="../ref/Tags/external.html" class="Tags">external</a> tag which renders the HTML markup necessary to include an external file resource such as CSS, JS or a favicon.<p class="paragraph"/>See <a href="http://grails-plugins.github.com/grails-resources" target="blank">r:resource documentation</a> for full details.
</div><p class="paragraph"/><h4>r:external</h4><p class="paragraph"/>这是一个资源感知（resource-aware）版本的Grails的<a href="../ref/Tags/external.html" class="Tags">external</a>标签，用以渲染那些必要的HTML标签所需要的外部资源文件，比如CSS、JS或者favicon。<p class="paragraph"/>更多完整的详细信息请参考<a href="http://grails-plugins.github.com/grails-resources" target="blank">r:resource文档</a>。


<a name="6.2.5.3 Declaring resources"><!-- Legacy link --></a>
<h2 id="declaringResources">6.2.5.3 声明资源</h2>
<div class="hidden-block">
A DSL is provided for declaring resources and modules. This can go either in your <code>Config.groovy</code> in the case of application-specific resources, or more commonly in a resources artefact in <code>grails-app/conf</code>.<p class="paragraph"/>Note that you do not need to declare all your static resources, especially images. However you must to establish dependencies or other resources-specific attributes. Any resource that is not declared is called "ad-hoc" and will still be processed using defaults for that resource type.<p class="paragraph"/>Consider this example resource configuration file, <code>grails-app/conf/MyAppResources.groovy</code>:<p class="paragraph"/><div class="code"><pre>modules = &#123;
    core &#123;
        dependsOn 'jquery, utils'<p class="paragraph"/>        resource url: '/js/core.js', disposition: 'head'
        resource url: '/js/ui.js'
        resource url: '/css/main.css',
        resource url: '/css/branding.css'
        resource url: '/css/print.css', attrs: &#91;media: 'print'&#93;
    &#125;<p class="paragraph"/>    utils &#123;
        dependsOn 'jquery'<p class="paragraph"/>        resource url: '/js/utils.js'
    &#125;<p class="paragraph"/>    forms &#123;
        dependsOn 'core,utils'<p class="paragraph"/>        resource url: '/css/forms.css'
        resource url: '/js/forms.js'
    &#125;
&#125;</pre></div><p class="paragraph"/>This defines three resource modules; 'core', 'utils' and 'forms'. The resources in these modules will be automatically bundled out of the box according to the module name, resulting in fewer files. You can override this with <code>bundle:'someOtherName'</code> on each resource, or call <code>defaultBundle</code> on the module (see <a href="http://grails-plugins.github.com/grails-resources" target="blank">resources plugin documentation</a>).<p class="paragraph"/>It declares dependencies between them using <code>dependsOn</code>, which controls the load order of the resources.<p class="paragraph"/>When you include an <code>&#60;r:require module="forms"/&#62;</code> in your GSP, it will pull in all the resources from 'core' and 'utils' as well as 'jquery', all in the correct order.<p class="paragraph"/>You'll also notice the <code>disposition:'head'</code> on the <code>core.js</code> file. This tells Resources that while it can defer all the other JS files to the end of the body, this one must go into the <code>&#60;head&#62;</code>.<p class="paragraph"/>The CSS file for print styling adds custom attributes using the <code>attrs</code> map option, and these are passed through to the <code>r:external</code> tag when the engine renders the link to the resource, so you can customize the HTML attributes of the generated link.<p class="paragraph"/>There is no limit to the number of modules or xxxResources.groovy artefacts you can provide, and plugins can supply them to expose modules to applications, which is exactly how the jQuery plugin works.<p class="paragraph"/>To define modules like this in your application's Config.groovy, you simply assign the DSL closure to the <code>grails.resources.modules</code> Config variable.<p class="paragraph"/>For full details of the resource DSL please see the <a href="http://grails-plugins.github.com/grails-resources" target="blank">resources plugin documentation</a>.
</div><p class="paragraph"/>系统提供了一个DSL专门用于声明资源和模块。其可以位于<code>Config.groovy</code>中特定应用的资源容器，或者更常用的是<code>grails-app/conf</code>下的一个资源工件中。<p class="paragraph"/>注意！你并不需要声明所有的静态资源，尤其是图片。但是你必须要建立所需依赖或者其他资源相关的属性。没有被声明的资源称之为"ad-hoc"，并且根据其资源类型被缺省处理。<p class="paragraph"/>假设如下所示的<code>grails-app/conf/MyAppResources.groovy</code>资源配置文件：<p class="paragraph"/><div class="code"><pre>modules = &#123;
    core &#123;
        dependsOn 'jquery, utils'<p class="paragraph"/>        resource url: '/js/core.js', disposition: 'head'
        resource url: '/js/ui.js'
        resource url: '/css/main.css',
        resource url: '/css/branding.css'
        resource url: '/css/print.css', attrs: &#91;media: 'print'&#93;
    &#125;<p class="paragraph"/>    utils &#123;
        dependsOn 'jquery'<p class="paragraph"/>        resource url: '/js/utils.js'
    &#125;<p class="paragraph"/>    forms &#123;
        dependsOn 'core,utils'<p class="paragraph"/>        resource url: '/css/forms.css'
        resource url: '/js/forms.js'
    &#125;
&#125;</pre></div><p class="paragraph"/>示例定义了三个资源模块：'core'、'utils'和'forms'。这些模块中的资源将根据模块的名称自动地打包到更少的文件中。对于每个资源，你可以使用<code>bundle:'someOtherName'</code> 来覆盖之，或者调用模块的<code>defaultBundle</code>（更多请参考<a href="http://grails-plugins.github.com/grails-resources" target="blank">资源插件文档</a>）。<p class="paragraph"/>通过<code>dependsOn</code>来声明的依赖关系，可以控制资源的加载顺序。<p class="paragraph"/>当你在的GSP中引用<code>&#60;r:require module="forms"/&#62;</code>的时候，它将从'core'和'utils'还有'jquery'中获取所有的资源，并以正确的顺序加载。<p class="paragraph"/>你将会注意到<code>core.js</code>文件中的<code>disposition:'head'</code> 。它将告诉资源插件当所有的其他JS文件推迟到body末尾加载的时候，此文件（core.js）必须要在<code>&#60;head&#62;</code>加载。<p class="paragraph"/>用于打印风格的CSS文件通过<code>attrs</code>映射选项来添加自定义属性，并且在渲染到资源链接的时候，它们将被传递给<code>r:external</code>标签，因此你可以自定义HTML的属性来生成链接。<p class="paragraph"/>模块或者你定义的xxxResources.groovy工件的数量是没有限制的，插件也可以将资源模块暴露给应用，正如jQuery插件所做的那样。<p class="paragraph"/>要在你应用中的Config.groovy定义模块，你可以简单地将DSL闭包赋给<code>grails.resources.modules</code>配置变量。<p class="paragraph"/>完整的资源DSL信息请参考<a href="http://grails-plugins.github.com/grails-resources" target="blank">资源插件文档</a>。


<a name="6.2.5.4 Overriding plugin resources"><!-- Legacy link --></a>
<h2 id="overridingPluginResources">6.2.5.4 覆盖插件资源</h2>
<div class="hidden-block">
Because a resource module can define the bundle groupings and other attributes of resources, you may find that the settings provided are not correct for your application.<p class="paragraph"/>For example, you may wish to bundle jQuery and some other libraries all together in one file. There is a load-time and caching trade-off here, but often it is the case that you'd like to override some of these settings.<p class="paragraph"/>To do this, the DSL supports an "overrides" clause, within which you can change the <code>defaultBundle</code> setting for a module, or attributes of individual resources that have been declared with a unique id:<p class="paragraph"/><div class="code"><pre>modules = &#123;
    core &#123;
        dependsOn 'jquery, utils'
        defaultBundle 'monolith'<p class="paragraph"/>        resource url: '/js/core.js', disposition: 'head'
        resource url: '/js/ui.js'
        resource url: '/css/main.css',
        resource url: '/css/branding.css'
        resource url: '/css/print.css', attrs: &#91;media: 'print'&#93;
    &#125;<p class="paragraph"/>    utils &#123;
        dependsOn 'jquery'
        defaultBundle 'monolith'<p class="paragraph"/>        resource url: '/js/utils.js'
    &#125;<p class="paragraph"/>    forms &#123;
        dependsOn 'core,utils'
        defaultBundle 'monolith'<p class="paragraph"/>        resource url: '/css/forms.css'
        resource url: '/js/forms.js'
    &#125;<p class="paragraph"/>    overrides &#123;
        jquery &#123;
            defaultBundle 'monolith'
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>This will put all code into a single bundle named 'monolith'. Note that this can still result in multiple files, as separate bundles are required for head and defer dispositions, and JavaScript and CSS files are bundled separately.<p class="paragraph"/>Note that overriding individual resources requires the original declaration to have included a unique id for the resource.<p class="paragraph"/>For full details of the resource DSL please see the <a href="http://grails-plugins.github.com/grails-resources" target="blank">resources plugin documentation</a>.
</div><p class="paragraph"/>因为一个资源模块定义了捆绑（bundle）组和资源的其他属性，因此你可能会发现设置所提供的并不适合你的应用。<p class="paragraph"/>比如，你可能希望将jQuery和其他的库捆绑到一个文件中。此处就要根据加载时间和缓存做一个权衡，但是在此种情况下，你经常会想重载这些配置的一部分。<p class="paragraph"/>这时候，DSL提供了"overrides"子句来完成此功能，子句内你可以修改一个模块的<code>defaultBundle</code>，或者每个单独资源的属性，不过每个资源必须要声明一个唯一的id:<p class="paragraph"/><div class="code"><pre>modules = &#123;
    core &#123;
        dependsOn 'jquery, utils'
        defaultBundle 'monolith'<p class="paragraph"/>        resource url: '/js/core.js', disposition: 'head'
        resource url: '/js/ui.js'
        resource url: '/css/main.css',
        resource url: '/css/branding.css'
        resource url: '/css/print.css', attrs: &#91;media: 'print'&#93;
    &#125;<p class="paragraph"/>    utils &#123;
        dependsOn 'jquery'
        defaultBundle 'monolith'<p class="paragraph"/>        resource url: '/js/utils.js'
    &#125;<p class="paragraph"/>    forms &#123;
        dependsOn 'core,utils'
        defaultBundle 'monolith'<p class="paragraph"/>        resource url: '/css/forms.css'
        resource url: '/js/forms.js'
    &#125;<p class="paragraph"/>    overrides &#123;
        jquery &#123;
            defaultBundle 'monolith'
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>上述示例会将所有的代码放到一个单独的'monolith'捆绑束中。注意，结果依然可能分散在多个文件中，因为安排head和defer所需的捆绑束是不同的，JavaScript和CSS文件被分开捆绑的。<p class="paragraph"/>注意重载单独的资源，需要原来的资源声明一个唯一的id。<p class="paragraph"/>更多详细完整的资源DSL信息请参考<a href="http://grails-plugins.github.com/grails-resources" target="blank">资源插件文档</a>。


<a name="6.2.5.5 Optimizing your resources"><!-- Legacy link --></a>
<h2 id="optimizingYourResources">6.2.5.5 优化资源</h2>
<div class="hidden-block">
The Resources framework uses "mappers" to mutate the resources into the final format served to the user.<p class="paragraph"/>The resource mappers are applied to each static resource once, in a specific order. You can create your own resource mappers, and several plugins provide some already for zipping, caching and minifying.<p class="paragraph"/>Out of the box, the Resources plugin provides bundling of resources into fewer files, which is achieved with a few mappers that also perform CSS re-writing to handle when your CSS files are moved into a bundle.
</div><p class="paragraph"/>资源框架使用"映射器（mappers）"来将资源转变为最终用户所需的格式。<p class="paragraph"/>资源映射器以一个特定的顺序将每一个静态资源处理一次。你可以创建你自己的资源映射器，有一些插件已经提供了比如压缩（zipping）、缓存（caching）和缩少（minifying）等映射。<p class="paragraph"/>除此之外，资源插件还提供了捆绑多个资源到较少的文件功能，在将你的CSS文件移动到一个捆绑束的时候，其使用一些映射器执行重写CSS处理。<p class="paragraph"/><div class="hidden-block">
<h4>Bundling multiple resources into fewer files</h4><p class="paragraph"/>The 'bundle' mapper operates by default on any resource with a "bundle" defined - or inherited from a <code>defaultBundle</code> clause on the module. Modules have an implicit default bundle name the same as the name of the module.<p class="paragraph"/>Files of the same kind will be aggregated into this bundle file. Bundles operate across module boundaries:<p class="paragraph"/><div class="code"><pre>modules = &#123;
    core &#123;
        dependsOn 'jquery, utils'
        defaultBundle 'common'<p class="paragraph"/>        resource url: '/js/core.js', disposition: 'head'
        resource url: '/js/ui.js', bundle: 'ui'
        resource url: '/css/main.css', bundle: 'theme'
        resource url: '/css/branding.css'
        resource url: '/css/print.css', attrs: &#91;media: 'print'&#93;
    &#125;<p class="paragraph"/>    utils &#123;
        dependsOn 'jquery'<p class="paragraph"/>        resource url: '/js/utils.js', bundle: 'common'
    &#125;<p class="paragraph"/>    forms &#123;
        dependsOn 'core,utils'<p class="paragraph"/>        resource url: '/css/forms.css', bundle: 'ui'
        resource url: '/js/forms.js', bundle: 'ui'
    &#125;
&#125;</pre></div><p class="paragraph"/>Here you see that resources are grouped into bundles; 'common', 'ui' and 'theme' - across module boundaries.<p class="paragraph"/>Note that auto-bundling by module does <strong class="bold">not</strong> occur if there is only one resource in the module.
</div><p class="paragraph"/><h4>捆绑多个资源到较少的文件</h4><p class="paragraph"/>缺省情况下，'bundle'映射器会操作使用"bundle"定义的任何资源－或者继承自模块的<code>defaultBundle</code>子句。模块有一个隐含的跟模块名称相同的缺省捆绑束名。<p class="paragraph"/>同样类型的文件将会被汇集到当前的捆绑束文件中。捆绑束是通过模块的边界来操作的：<p class="paragraph"/><div class="code"><pre>modules = &#123;
    core &#123;
        dependsOn 'jquery, utils'
        defaultBundle 'common'<p class="paragraph"/>        resource url: '/js/core.js', disposition: 'head'
        resource url: '/js/ui.js', bundle: 'ui'
        resource url: '/css/main.css', bundle: 'theme'
        resource url: '/css/branding.css'
        resource url: '/css/print.css', attrs: &#91;media: 'print'&#93;
    &#125;<p class="paragraph"/>    utils &#123;
        dependsOn 'jquery'<p class="paragraph"/>        resource url: '/js/utils.js', bundle: 'common'
    &#125;<p class="paragraph"/>    forms &#123;
        dependsOn 'core,utils'<p class="paragraph"/>        resource url: '/css/forms.css', bundle: 'ui'
        resource url: '/js/forms.js', bundle: 'ui'
    &#125;
&#125;</pre></div><p class="paragraph"/>此处你可以看到资源被分组到捆绑束：'common'、'ui'和'theme' － 通过模块边界。<p class="paragraph"/>注意！如果模块中只有一个资源，那么根据模块自动捆绑将 <strong class="bold">不会</strong> 发生。<p class="paragraph"/><div class="hidden-block">
<h4>Making resources cache "eternally" in the client browser</h4><p class="paragraph"/>Caching resources "eternally" in the client is only viable if the resource has a unique name that changes whenever the contents change, and requires caching headers to be set on the response.<p class="paragraph"/>The <a href="http://grails.org/plugin/cached-resources" target="blank">cached-resources</a> plugin provides a mapper that achieves this by hashing your files and renaming them based on this hash. It also sets the caching headers on every response for those resources. To use, simply install the cached-resources plugin.<p class="paragraph"/>Note that the caching headers can only be set if your resources are being served by your application. If you have another server serving the static content from your app (e.g. Apache HTTPD), configure it to send caching headers. Alternatively you can configure it to request and proxy the resources from your container.
</div><p class="paragraph"/><h4>让资源“永久”地缓存在客户浏览器</h4><p class="paragraph"/>在客户端“永久”地缓存资源只有在资源有一个唯一的名字的情况下，才切实可行，并且当资源的内容变化时，其名字也要做相应的变化，还要求在响应中设置缓存标头（caching headers）。<p class="paragraph"/><a href="http://grails.org/plugin/cached-resources" target="blank">cached-resources</a>插件提供了一个映射器来完成此功能，它是通过对你的文件做哈稀校验并根据校验值来重命名来实现的。此插件也会在每一次的响应中根据这些资源的情况来设置缓存标头。要使用它，只需要简单的安装cached-resources插件即可。<p class="paragraph"/>注意！只有在你的应用管辖范围内的资源，才会有可能设置缓存标头.如果你有另外一个服务器专门管理你应用的静态资源（比如Apache的HTTPD），那么需要配置此服务器来发送缓存标头。或者你也可以配置它来请求和代理你容器内的资源。<p class="paragraph"/><div class="hidden-block">
<h4>Zipping resources</h4><p class="paragraph"/>Returning gzipped resources is another way to reduce page load times and reduce bandwidth.<p class="paragraph"/>The <a href="http://grails.org/plugin/zipped-resources" target="blank">zipped-resources</a> plugin provides a mapper that automatically compresses your content, excluding by default already compressed formats such as gif, jpeg and png.<p class="paragraph"/>Simply install the zipped-resources plugin and it works.
</div><p class="paragraph"/><h4>压缩资源</h4><p class="paragraph"/>返回用gzip压缩过的资源是另外减少页面加载时间和带宽的方法。<p class="paragraph"/><a href="http://grails.org/plugin/zipped-resources" target="blank">zipped-resources</a>插件提供了一个映射器来自动地压缩你的资源内容。当然那些已经压缩过地除外，比如gif、jpeg和png。<p class="paragraph"/>简单地安装zipped-resources插件后，即可工作。<p class="paragraph"/><div class="hidden-block">
<h4>Minifying</h4><p class="paragraph"/>There are a number of CSS and JavaScript minifiers available to obfuscate and reduce the size of your code. At the time of writing none are publicly released but releases are imminent.
</div><p class="paragraph"/><h4>缩少资源</h4><p class="paragraph"/>已经有很多的CSS和JavaScript缩少器可以用来混淆和减少你代码的大小。这可以解决发布迫在眉睫，而现在编码时没有什么可公开发布的情况。


<a name="6.2.5.6 Debugging"><!-- Legacy link --></a>
<h2 id="debugging">6.2.5.6 调试</h2>
<div class="hidden-block">
When your resources are being moved around, renamed and otherwise mutated, it can be hard to debug client-side issues. Modern browsers, especially Safari, Chrome and Firefox have excellent tools that let you view all the resources requested by a page, including the headers and other information about them.<p class="paragraph"/>There are several debugging features built in to the Resources framework.
</div><p class="paragraph"/>当你的资源正在移动、重命名以及其他变动的时候，要调试客户端的问题是非常困难的。现代的浏览器，尤其是Safari、Chrome和Firefox，都有非常优秀的工具来查看一个请求页面的所有资源，包括其请求头和其他的信息。<p class="paragraph"/>除此之外，Resources框架还提供了几个内置的调试特性。<p class="paragraph"/><div class="hidden-block">
<h4>X-Grails-Resources-Original-Src Header</h4><p class="paragraph"/>Every resource served in development mode will have the X-Grails-Resources-Original-Src: header added, indicating the original source file(s) that make up the response.
</div><p class="paragraph"/><h4>X-Grails-Resources-Original-Src信息头</h4><p class="paragraph"/>在开发模式下，每一个用到的资源都会添加X-Grails-Resources-Original-Src的头信息，用以表示此响应对应的原始代码文件。<p class="paragraph"/><div class="hidden-block">
<h4>Adding the debug flag</h4><p class="paragraph"/>If you add a query parameter <strong class="bold">_debugResources=y</strong> to your URL and request the page, Resources will bypass any processing so that you can see your original source files.<p class="paragraph"/>This also adds a unique timestamp to all your resource URLs, to defeat any caching that browsers may use. This means that you should always see your very latest code when you reload the page.
</div><p class="paragraph"/><h4>添加调试标记</h4><p class="paragraph"/>如果在你的URL和请求页面的参数中增加 <strong class="bold">_debugResources=y</strong> 的话，Resources将会不管任何处理，而直接显示和使用原始的代码文件。<p class="paragraph"/>此外，你资源的URLs还会添加一个唯一的时间戳，用以处理浏览器导致的缓存问题。这意味着在你重现加载页面的时候，你总是得到最新的代码。<p class="paragraph"/><div class="hidden-block">
<h4>Turning on debug all the time</h4><p class="paragraph"/>You can turn on the aforementioned debug mechanism without requiring a query parameter, but turning it on in Config.groovy:<p class="paragraph"/><div class="code"><pre>grails.resources.debug = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>You can of course set this per-environment.
</div><p class="paragraph"/><h4>打开调试</h4><p class="paragraph"/>你可以在不需要额外请求参数的情况下打开如上所述的调试机制，要如此，只要在Config.groovy中配置一下即可：<p class="paragraph"/><div class="code"><pre>grails.resources.debug = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>当然，你也可以在每个单独的环境设置。


<a name="6.2.5.7 Preventing processing of resources"><!-- Legacy link --></a>
<h2 id="preventingProcessingOfResources">6.2.5.7 阻止资源处理</h2>
<div class="hidden-block">
Sometimes you do not want a resource to be processed in a particular way, or even at all. Occasionally you may also want to disable all resource mapping.
</div><p class="paragraph"/>有时候，你并不想以一种特别的方式处理资源，甚至根本就不想。偶尔，你还想禁止所有的资源映射。<p class="paragraph"/><div class="hidden-block">
<h4>Preventing the application of a specific mapper to an individual resource</h4><p class="paragraph"/>All resource declarations support a convention of noXXXX:true where XXXX is a mapper name.<p class="paragraph"/>So for example to prevent the "hashandcache" mapper from being applied to a resource (which renames and moves it, potentially breaking relative links written in JavaScript code), you would do this:<p class="paragraph"/><div class="code"><pre>modules = &#123;
    forms &#123;
        resource url: '/css/forms.css', nohashandcache: <span class="java&#45;keyword">true</span>
        resource url: '/js/forms.js', nohashandcache: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>阻止到一个单独资源的特定映射</h4><p class="paragraph"/>所有的资源声明都支持noXXXX:true的用法，此处的XXXX是一个映射器的名称。<p class="paragraph"/>因此在下例中，要阻止"hashandcache"映射器应用到一个资源（重命名，移动甚至断开JavaScript代码中的相关链接）你可以这样做：<p class="paragraph"/><div class="code"><pre>modules = &#123;
    forms &#123;
        resource url: '/css/forms.css', nohashandcache: <span class="java&#45;keyword">true</span>
        resource url: '/js/forms.js', nohashandcache: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Excluding/including paths and file types from specific mappers</h4><p class="paragraph"/>Mappers have includes/excludes Ant patterns to control whether they apply to a given resource. Mappers set sensible defaults for these based on their activity, for example the zipped-resources plugin's "zip" mapper is set to exclude images by default.<p class="paragraph"/>You can configure this in your <code>Config.groovy</code> using the mapper name e.g:<p class="paragraph"/><div class="code"><pre>// We wouldn't link to .exe files using Resources but <span class="java&#45;keyword">for</span> the sake of example:
grails.resources.zip.excludes = &#91;'&#42;&#42;/&#42;.zip', '&#42;&#42;/&#42;.exe'&#93;<p class="paragraph"/>// Perhaps <span class="java&#45;keyword">for</span> some reason we want to prevent bundling on <span class="java&#45;quote">"less"</span> CSS files:
grails.resources.bundle.excludes = &#91;'&#42;&#42;/&#42;.less'&#93;</pre></div><p class="paragraph"/>There is also an "includes" inverse. Note that settings these replaces the default includes/excludes for that mapper - it is not additive.
</div><p class="paragraph"/><h4>从特定映射器中 排除／包含 路径和文件类型</h4><p class="paragraph"/>映射器的排除／包含使用Ant语法来控制是否要应用到给定的资源上。映射器会根据其活动情况来设置缺省的感知类型，以资源压缩（zipped-resources）插件为例，其"zip"映射器会缺省地排除那些镜像文件。<p class="paragraph"/>你可以通过你的<code>Config.groovy</code>文件地映射器名称来配置相关信息，比如：<p class="paragraph"/><div class="code"><pre>// We wouldn't link to .exe files using Resources but <span class="java&#45;keyword">for</span> the sake of example:
grails.resources.zip.excludes = &#91;'&#42;&#42;/&#42;.zip', '&#42;&#42;/&#42;.exe'&#93;<p class="paragraph"/>// Perhaps <span class="java&#45;keyword">for</span> some reason we want to prevent bundling on <span class="java&#45;quote">"less"</span> CSS files:
grails.resources.bundle.excludes = &#91;'&#42;&#42;/&#42;.less'&#93;</pre></div><p class="paragraph"/>反之，你也可以使用"includes"。要注意的是，上述操作将替换映射器缺省的includes/excludes设置－而不是追加。<p class="paragraph"/><div class="hidden-block">
<h4>Controlling what is treated as an "ad-hoc" (legacy) resource</h4><p class="paragraph"/>Ad-hoc resources are those undeclared, but linked to directly in your application <strong class="bold">without</strong> using the Grails or Resources linking tags (resource, img or external).<p class="paragraph"/>These may occur with some legacy plugins or code with hardcoded paths in.<p class="paragraph"/>There is a Config.groovy setting <strong class="bold">grails.resources.adhoc.patterns</strong> which defines a list of Servlet API compliant filter URI mappings, which the Resources filter will use to detect such "ad-hoc resource" requests.<p class="paragraph"/>By default this is set to:
<div class="code"><pre>grails.resources.adhoc.patterns = &#91;'images/&#42;', '&#42;.js', '&#42;.css'&#93;</pre></div>
</div><p class="paragraph"/><h4>控制"ad-hoc"（遗留）资源</h4><p class="paragraph"/>Ad-hoc资源是那些未声明的，并且 <strong class="bold">不</strong> 使用Grails或者Resources的链接标签（resource, img or external），而是在你的应用中直接链接的资源。<p class="paragraph"/>这可能会在那些遗留插件或者硬编码路径的时候会碰到。<p class="paragraph"/>Config.groovy中的 <strong class="bold">grails.resources.adhoc.patterns</strong> 配置就是用来定义一系列Servlet API兼容的URI映射的过滤器，其资源过滤器通常用来检测那些"ad-hoc resource"请求。<p class="paragraph"/>其缺省值如下：
<div class="code"><pre>grails.resources.adhoc.patterns = &#91;'images/&#42;', '&#42;.js', '&#42;.css'&#93;</pre></div>


<a name="6.2.5.8 Other Resources-aware plugins"><!-- Legacy link --></a>
<h2 id="otherResourcesPlugins">6.2.5.8 其他资源感知的插件</h2>
<div class="hidden-block">
At the time of writing, the following plugins include support for the Resources framework:
<ul class="star">
<li><a href="http://grails.org/plugin/jquery" target="blank">jquery</a></li>
<li><a href="http://grails.org/plugin/jquery-ui" target="blank">jquery-ui</a></li>
<li><a href="http://grails.org/plugin/blueprint" target="blank">blueprint</a></li>
<li><a href="http://grails.org/plugin/lesscss-resources" target="blank">lesscss-resources</a></li>
<li><a href="http://grails.org/plugin/zipped-resources" target="blank">zipped-resources</a></li>
<li><a href="http://grails.org/plugin/cached-resources" target="blank">cached-resources</a></li>
</ul><p class="paragraph"/></div><p class="paragraph"/>截至到书写为止，资源框架已经被下列插件所支撑：
<ul class="star">
<li><a href="http://grails.org/plugin/jquery" target="blank">jquery</a></li>
<li><a href="http://grails.org/plugin/jquery-ui" target="blank">jquery-ui</a></li>
<li><a href="http://grails.org/plugin/blueprint" target="blank">blueprint</a></li>
<li><a href="http://grails.org/plugin/lesscss-resources" target="blank">lesscss-resources</a></li>
<li><a href="http://grails.org/plugin/zipped-resources" target="blank">zipped-resources</a></li>
<li><a href="http://grails.org/plugin/cached-resources" target="blank">cached-resources</a></li>
</ul><p class="paragraph"/>

<a name="6.2.6 Sitemesh Content Blocks"><!-- Legacy link --></a>
<h2 id="sitemeshContentBlocks">6.2.6 Sitemesh的内容块</h2>
<div class="hidden-block">
Although it is useful to decorate an entire page sometimes you may find the need to decorate independent sections of your site. To do this you can use content blocks. To get started, partition the page to be decorated using the <code>&#60;content&#62;</code> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"navbar"</span>&#62;</span>
&#8230; draw the navbar here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"header"</span>&#62;</span>
&#8230; draw the header here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"footer"</span>&#62;</span>
&#8230; draw the footer here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"body"</span>&#62;</span>
&#8230; draw the body here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span></pre></div><p class="paragraph"/>Then within the layout you can reference these components and apply individual layouts to each:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;body&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"header"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"headerLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.header"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"nav"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"navLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.navbar"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"body"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"bodyLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.body"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"footer"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"footerLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.footer"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
    <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div>
</div><p class="paragraph"/>虽然装饰整个页面是有用的，但有时候你可能只需要装饰站点单独的部分。这时，你可以使用内容块来完成。首先，对于要装饰的页面部分使用<code>&#60;content&#62;</code>标签来处理：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"navbar"</span>&#62;</span>
&#8230; draw the navbar here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"header"</span>&#62;</span>
&#8230; draw the header here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"footer"</span>&#62;</span>
&#8230; draw the footer here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;content tag=<span class="xml&#45;quote">"body"</span>&#62;</span>
&#8230; draw the body here&#8230;
<span class="xml&#45;tag">&#60;/content&#62;</span></pre></div><p class="paragraph"/>然后，在布局内，你可以引用这些组件并且将其应用到每一个独立的布局中：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;html&#62;</span>
    <span class="xml&#45;tag">&#60;body&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"header"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"headerLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.header"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"nav"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"navLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.navbar"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"body"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"bodyLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.body"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
        <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"footer"</span>&#62;</span>
            <span class="xml&#45;tag">&#60;g:applyLayout name=<span class="xml&#45;quote">"footerLayout"</span>&#62;</span>
                <span class="xml&#45;tag">&#60;g:pageProperty name=<span class="xml&#45;quote">"page.footer"</span> /&#62;</span>
            <span class="xml&#45;tag">&#60;/g:applyLayout&#62;</span>
        <span class="xml&#45;tag">&#60;/div&#62;</span>
    <span class="xml&#45;tag">&#60;/body&#62;</span>
<span class="xml&#45;tag">&#60;/html&#62;</span></pre></div>


<a name="6.2.7 Making Changes to a Deployed Application"><!-- Legacy link --></a>
<h2 id="makingChangesToADeployedApplication">6.2.7 修改已经部署的应用</h2>
<div class="hidden-block">
One of the main issues with deploying a Grails application (or typically any servlet-based one) is that any change to the views requires that you redeploy your whole application. If all you want to do is fix a typo on a page, or change an image link, it can seem like a lot of unnecessary work. For such simple requirements, Grails does have a solution: the  <code>grails.gsp.view.dir</code>  configuration setting.<p class="paragraph"/>How does this work? The first step is to decide where the GSP files should go. Let's say we want to keep them unpacked in a  <code>/var/www/grails/my-app</code>  directory. We add these two lines to  <code>grails-app/conf/Config.groovy</code> :
<div class="code"><pre>grails.gsp.enable.reload = <span class="java&#45;keyword">true</span>
grails.gsp.view.dir = <span class="java&#45;quote">"/<span class="java&#45;keyword">var</span>/www/grails/my&#45;app/"</span></pre></div>
The first line tells Grails that modified GSP files should be reloaded at runtime. If you don't have this setting, you can make as many changes as you like but they won't be reflected in the running application until you restart. The second line tells Grails where to load the views and layouts from.<p class="paragraph"/><blockquote class="note">
The trailing slash on the  <code>grails.gsp.view.dir</code>  value is important! Without it, Grails will look for views in the parent directory.
</blockquote><p class="paragraph"/>Setting "grails.gsp.view.dir" is optional. If it's not specified, you can update files directly to the application server's deployed war directory. Depending on the application server, these files might get overwritten when the server is restarted. Most application servers support "exploded war deployment" which is recommended in this case.<p class="paragraph"/>With those settings in place, all you need to do is copy the views from your web application to the external directory. On a Unix-like system, this would look something like this:
<div class="code"><pre>mkdir &#45;p /<span class="java&#45;keyword">var</span>/www/grails/my&#45;app/grails&#45;app/views
cp &#45;R grails&#45;app/views/&#42; /<span class="java&#45;keyword">var</span>/www/grails/my&#45;app/grails&#45;app/views</pre></div>
The key point here is that you must retain the view directory structure, including the  <code>grails-app/views</code>  bit. So you end up with the path  <code>/var/www/grails/my-app/grails-app/views/...</code> .<p class="paragraph"/>One thing to bear in mind with this technique is that every time you modify a GSP, it uses up permgen space. So at some point you will eventually hit "out of permgen space" errors unless you restart the server. So this technique is not recommended for frequent or large changes to the views.<p class="paragraph"/>There are also some System properties to control GSP reloading:
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Name</strong></th><th><strong class="bold">Description</strong></th><th><strong class="bold">Default</strong></th></tr><tr class="table-odd"><td>grails.gsp.enable.reload</td><td>altervative system property for enabling the GSP reload mode without changing Config.groovy</td><td>&#160;</td></tr><tr class="table-even"><td>grails.gsp.reload.interval</td><td>interval between checking the lastmodified time of the gsp source file, unit is milliseconds</td><td>5000</td></tr><tr class="table-odd"><td>grails.gsp.reload.granularity</td><td>the number of milliseconds leeway to give before deciding a file is out of date. this is needed because different roundings usually cause a 1000ms difference in lastmodified times</td><td>1000</td></tr></table><p class="paragraph"/>GSP reloading is supported for precompiled GSPs since Grails 1.3.5 .
</div><p class="paragraph"/>部署一个Grails应用（或者任意基于servlet的应用）的一个主要问题是视图的任何修改都需要重新再部署你的整个应用。假如你只是想修复一个页面的打字错误或者修改一个图像链接，那么这种再部署像是比较多余的工作。对于这种比较简单的需求，Grails提供了一个解决方案：配置<code>grails.gsp.view.dir</code>属性。<p class="paragraph"/>那么它是如何工作的呢？第一步就是要确定GSP文件位于什么地方。假设我们想让这些文件解压缩到<code>/var/www/grails/my-app</code>目录，那么我们需要在<code>grails-app/conf/Config.groovy</code>增加如下两行：
<div class="code"><pre>grails.gsp.enable.reload = <span class="java&#45;keyword">true</span>
grails.gsp.view.dir = <span class="java&#45;quote">"/<span class="java&#45;keyword">var</span>/www/grails/my&#45;app/"</span></pre></div>
第一行告诉Grails在运行期间允许重新加载那些修改过的GSP文件。如果你没有设置此值，那在没有重新启动的情况下，你修改的再多也不会在当前运行的应用中生效 。第二行告诉Grails到哪里去加载视图和布局。<p class="paragraph"/><blockquote class="note">
<code>grails.gsp.view.dir</code>值的最后一个反斜杠是很重要的！没有它，Grails将会在其上一级目录寻找视图。
</blockquote><p class="paragraph"/>"grails.gsp.view.dir"的值是可选的。如果没有设置，你可以直接更新部署在应用服务器的war目录下的文件。这些文件可能会在应用服务器重新启动的时候被覆盖，不过这是跟服务器相关的。在这个时候，大部分的应用服务器所支持的“war额外加载部署（exploded war deployment）”模式是值得推荐的。<p class="paragraph"/>所有这些设置完毕以后，你所需要做的就是从你的web应用中拷贝视图文件到外部的目录中。在一个Unix类的系统中，这可能看起来如下所示：
<div class="code"><pre>mkdir &#45;p /<span class="java&#45;keyword">var</span>/www/grails/my&#45;app/grails&#45;app/views
cp &#45;R grails&#45;app/views/&#42; /<span class="java&#45;keyword">var</span>/www/grails/my&#45;app/grails&#45;app/views</pre></div>
此处的关键点是你必须要保留视图的目录结构，包括<code>grails-app/views</code>本身。因此你的路径是<code>/var/www/grails/my-app/grails-app/views/...</code>的形式。<p class="paragraph"/>使用此技术，要牢记的一件事情是在你每一次修改GSP文件的时候，会增加permgen的内存空间。因此最终你将会碰到"permgen内存空间益"的错误，当然你可以通过重新启动服务器来解决。所以，此技术不推荐应用于视图被频繁或者大量修改的情况。<p class="paragraph"/>此外还有一些系统级的属性配置来控制GSP的重新加载：
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">名称</strong></th><th><strong class="bold">描述</strong></th><th><strong class="bold">缺省值</strong></th></tr><tr class="table-odd"><td>grails.gsp.enable.reload</td><td>在不修改Config.groovy的情况下，通过系统设置变量来启动GSP重栽模式</td><td>&#160;</td></tr><tr class="table-even"><td>grails.gsp.reload.interval</td><td>轮询gsp源文件最后修改时间的时间间隔，单位是毫秒</td><td>5000</td></tr><tr class="table-odd"><td>grails.gsp.reload.granularity</td><td>在一个文件超时以前预留的毫秒数，此项是需要的，因为最后修改时间精度会导致1000毫秒的误差</td><td>1000</td></tr></table><p class="paragraph"/>自从Grails 1.3.5以来，GSP的重栽就支持预编译了。


<a name="6.2.8 GSP Debugging"><!-- Legacy link --></a>
<h2 id="GSPDebugging">6.2.8 GSP调试</h2>
<div class="hidden-block">
<h4>Viewing the generated source code</h4>
<ul class="star">
<li>Adding "?showSource=true" or "&#38;showSource=true" to the url shows the generated Groovy source code for the view instead of rendering it. It won't show the source code of included templates. This only works in development mode</li>
<li>The saving of all generated source code can be activated by setting the property "grails.views.gsp.keepgenerateddir" (in Config.groovy) . It must point to a directory that exists and is writable.</li>
<li>During "grails war" gsp pre-compilation, the generated source code is stored in grails.project.work.dir/gspcompile (usually in ~/.grails/(grails_version)/projects/(project name)/gspcompile).</li>
</ul><p class="paragraph"/><h4>Debugging GSP code with a debugger</h4>
<ul class="star">
<li>See <a href="http://contraptionsforprogramming.blogspot.com/2010/08/debuggable-gsps-in-springsource-tool.html" target="blank">Debugging GSP in STS</a></li>
</ul><p class="paragraph"/><h4>Viewing information about templates used to render a single url</h4><p class="paragraph"/>GSP templates are reused in large web applications by using the <code>g:render</code> taglib. Several small templates can be used to render a single page.
It might be hard to find out what GSP template actually renders the html seen in the result.
The debug templates -feature adds html comments to the output. The comments contain debug information about gsp templates used to render the page.<p class="paragraph"/>Usage is simple: append "?debugTemplates" or "&#38;debugTemplates" to the url and view the source of the result in your browser.
"debugTemplates" is restricted to development mode. It won't work in production.<p class="paragraph"/>Here is an example of comments added by debugTemplates :
<div class="code"><pre>&#60;!&#45;&#45; GSP &#35;2 START template: /home/.../views/_carousel.gsp
     precompiled: <span class="java&#45;keyword">false</span> lastmodified: &#8230; &#45;&#45;&#62;
.
.
.
&#60;!&#45;&#45; GSP &#35;2 END template: /home/.../views/_carousel.gsp
     rendering time: 115 ms &#45;&#45;&#62;</pre></div><p class="paragraph"/>Each comment block has a unique id so that you can find the start &#38; end of each template call.
</div><p class="paragraph"/><h4>查看生成的源代码</h4>
<ul class="star">
<li>在url中增加"?showSource=true"或者"&#38;showSource=true"来显示生成的用于查看的Groovy源代码。它将不会显示包含模板的源代码，并且只工作于开发模式。</li>
<li>要保存所有生成的源代码，可以通过配置"grails.views.gsp.keepgenerateddir"（在Config.groovy中）来完成。指向的目录必须存在而且可写。</li>
<li>在"grails war"的gsp预编译阶段，其生成的源代码被保存在grails.project.work.dir/gspcompile中（通常位于~/.grails/(grails_version)/projects/(project name)/gspcompile中）。</li>
</ul><p class="paragraph"/><h4>在调试器中调试GSP代码</h4>
<ul class="star">
<li>详细请参考 <a href="http://contraptionsforprogramming.blogspot.com/2010/08/debuggable-gsps-in-springsource-tool.html" target="blank">在STS中调试GSP</a></li>
</ul><p class="paragraph"/><h4>查看渲染成一个url的模板信息</h4><p class="paragraph"/>在大型的WEB应用中，GSP的模板可以通过使用<code>g:render</code>标签而得以复用。几个小模板可以被渲染到一个单独的页面中。
在最后渲染的html中，很难区分出那些是那个GSP模板被实际渲染到那里。
调试模板功能将会在输出中添加html注释。这些注释包含着关于gsp模板渲染的调试信息。<p class="paragraph"/>用法也很简单：添加"?debugTemplates"或者"&#38;debugTemplates"到url中，然后查看你浏览器中的源代码。
"debugTemplates"仅限于开发模式，在生产环境中将无效。<p class="paragraph"/>下面是增加了debugTemplates后的一个带有注释的示例：
<div class="code"><pre>&#60;!&#45;&#45; GSP &#35;2 START template: /home/.../views/_carousel.gsp
     precompiled: <span class="java&#45;keyword">false</span> lastmodified: &#8230; &#45;&#45;&#62;
.
.
.
&#60;!&#45;&#45; GSP &#35;2 END template: /home/.../views/_carousel.gsp
     rendering time: 115 ms &#45;&#45;&#62;</pre></div><p class="paragraph"/>每一个注释块中都有一个唯一的id，用以让你方便区分每一次模板调用的开始和结束。


<a name="6.3 Tag Libraries"><!-- Legacy link --></a>
<h2 id="taglibs">6.3 标签库</h2>
<div class="hidden-block">
Like <a href="http://www.oracle.com/technetwork/java/javaee/jsp/index.html" target="blank">Java Server Pages</a> (JSP), GSP supports the concept of custom tag libraries. Unlike JSP, Grails' tag library mechanism is simple, elegant and completely reloadable at runtime.<p class="paragraph"/>Quite simply, to create a tag library create a Groovy class that ends with the convention <code>TagLib</code> and place it within the <code>grails-app/taglib</code> directory:<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>Now to create a tag create a Closure property that takes two arguments: the tag attributes and the body content:<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;
    def simple = &#123; attrs, body &#45;&#62;<p class="paragraph"/>    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>attrs</code> argument is a Map of the attributes of the tag, whilst the <code>body</code> argument is a Closure that returns the body content when invoked:<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;
    def emoticon = &#123; attrs, body &#45;&#62;
       out &#60;&#60; body() &#60;&#60; (attrs.happy == '<span class="java&#45;keyword">true</span>' ? <span class="java&#45;quote">" :&#45;)"</span> : <span class="java&#45;quote">" :&#45;("</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>As demonstrated above there is an implicit <code>out</code> variable that refers to the output <code>Writer</code> which you can use to append content to the response. Then you can reference the tag inside your GSP; no imports are necessary:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:emoticon happy=<span class="xml&#45;quote">"true"</span>&#62;</span>Hi John<span class="xml&#45;tag">&#60;/g:emoticon&#62;</span></pre></div><p class="paragraph"/><blockquote class="note">
To help IDEs like SpringSource Tool Suite (STS) and others autocomplete tag attributes, you should add Javadoc comments to your tag closures with <code>&#64;attr</code> descriptions. Since taglibs use Groovy code it can be difficult to reliably detect all usable attributes.<p class="paragraph"/>For example:<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;<p class="paragraph"/>    /&#42;&#42;
     &#42; Renders the body with an emoticon.
     &#42;
     &#42; @attr happy whether to show a happy emoticon ('<span class="java&#45;keyword">true</span>') or
     &#42; a sad emoticon ('<span class="java&#45;keyword">false</span>')
     &#42;/
    def emoticon = &#123; attrs, body &#45;&#62;
       out &#60;&#60; body() &#60;&#60; (attrs.happy == '<span class="java&#45;keyword">true</span>' ? <span class="java&#45;quote">" :&#45;)"</span> : <span class="java&#45;quote">" :&#45;("</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>and any mandatory attributes should include the REQUIRED keyword, e.g.<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;<p class="paragraph"/>    /&#42;&#42;
     &#42; Creates a <span class="java&#45;keyword">new</span> password field.
     &#42;
     &#42; @attr name REQUIRED the field name
     &#42; @attr value the field value
     &#42;/
    def passwordField = &#123; attrs &#45;&#62;
        attrs.type = <span class="java&#45;quote">"password"</span>
        attrs.tagName = <span class="java&#45;quote">"passwordField"</span>
        fieldImpl(out, attrs)
    &#125;
&#125;</pre></div>
</blockquote>
</div><p class="paragraph"/>跟<a href="http://www.oracle.com/technetwork/java/javaee/jsp/index.html" target="blank">Java Server Pages</a> (JSP)类似，GSP支持自定义标签库的概念。而跟JSP不同的是，Grails的标签库机制是简单而优雅的，并且完全可以在运行时重新加载。<p class="paragraph"/>要创建一个标签库是很简单的，只需要根据规约创建一个以<code>TagLib</code>结尾的Groovy类，并且放到<code>grails-app/taglib</code>下边就好了：<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>现在，要创建一个标签，只需要创建一个有两个参数（标签属性和主体内容）的闭包属性：<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;
    def simple = &#123; attrs, body &#45;&#62;<p class="paragraph"/>    &#125;
&#125;</pre></div><p class="paragraph"/><code>attrs</code>参数是此标签的属性，类型为映射（Map），而<code>body</code>参数是一个闭包，它在被调用的时候将返回一个主体内容：<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;
    def emoticon = &#123; attrs, body &#45;&#62;
       out &#60;&#60; body() &#60;&#60; (attrs.happy == '<span class="java&#45;keyword">true</span>' ? <span class="java&#45;quote">" :&#45;)"</span> : <span class="java&#45;quote">" :&#45;("</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>如上述示例所示，隐式的<code>out</code>变量将引用<code>Writer</code>输出器，用以往响应中追加内容。因此，你可以在不导入任何东西的情况下，于你的GSP内使用标签：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:emoticon happy=<span class="xml&#45;quote">"true"</span>&#62;</span>Hi John<span class="xml&#45;tag">&#60;/g:emoticon&#62;</span></pre></div><p class="paragraph"/><blockquote class="note">
为了有助于像SpringSource Tool Suite (STS)这样的IDE来自动补齐标签属性，你应该在Javadoc注释中增加标签闭包的<code>&#64;attr</code>描述。因为标签库也是Groovy代码，因此不能保证检测到的所有属性都是准确可靠的。<p class="paragraph"/>比如：<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;<p class="paragraph"/>    /&#42;&#42;
     &#42; Renders the body with an emoticon.
     &#42;
     &#42; @attr happy whether to show a happy emoticon ('<span class="java&#45;keyword">true</span>') or
     &#42; a sad emoticon ('<span class="java&#45;keyword">false</span>')
     &#42;/
    def emoticon = &#123; attrs, body &#45;&#62;
       out &#60;&#60; body() &#60;&#60; (attrs.happy == '<span class="java&#45;keyword">true</span>' ? <span class="java&#45;quote">" :&#45;)"</span> : <span class="java&#45;quote">" :&#45;("</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>并且，任何必须的属性都应该包含REQUIRED关键字，比如：<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;<p class="paragraph"/>    /&#42;&#42;
     &#42; Creates a <span class="java&#45;keyword">new</span> password field.
     &#42;
     &#42; @attr name REQUIRED the field name
     &#42; @attr value the field value
     &#42;/
    def passwordField = &#123; attrs &#45;&#62;
        attrs.type = <span class="java&#45;quote">"password"</span>
        attrs.tagName = <span class="java&#45;quote">"passwordField"</span>
        fieldImpl(out, attrs)
    &#125;
&#125;</pre></div>
</blockquote>



<h2 id="taglibVariablesAndScopes">6.3.1 变量和作用域</h2>
<div class="hidden-block">
Within the scope of a tag library there are a number of pre-defined variables including:
<ul class="star">
<li><code>actionName</code> - The currently executing action name</li>
<li><code>controllerName</code> - The currently executing controller name</li>
<li><code>flash</code> - The <a href="../ref/Controllers/flash.html" class="controllers">flash</a> object</li>
<li><code>grailsApplication</code> - The <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> instance</li>
<li><code>out</code> - The response writer for writing to the output stream</li>
<li><code>pageScope</code> - A reference to the <a href="../ref/Tag Libraries/pageScope.html" class="tagLibraries">pageScope</a> object used for GSP rendering (i.e. the binding)</li>
<li><code>params</code> - The <a href="../ref/Controllers/params.html" class="controllers">params</a> object for retrieving request parameters</li>
<li><code>pluginContextPath</code> - The context path to the plugin that contains the tag library</li>
<li><code>request</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a> instance</li>
<li><code>response</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html" class="api">HttpServletResponse</a> instance</li>
<li><code>servletContext</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/ServletContext.html" class="api">javax.servlet.ServletContext</a> instance</li>
<li><code>session</code> - The <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpSession.html" class="api">HttpSession</a> instance</li>
</ul><p class="paragraph"/></div><p class="paragraph"/>在一个标签库的作用域内，已经预定义了一些变量，它们包括：
<ul class="star">
<li><code>actionName</code> - 当前正在运行的操作名称</li>
<li><code>controllerName</code> - 当前正在运行的控制器名称</li>
<li><code>flash</code> - <a href="../ref/Controllers/flash.html" class="controllers">flash</a>对象</li>
<li><code>grailsApplication</code> - <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a>实例</li>
<li><code>out</code> - 响应输出器，用于将内容写到输出流中</li>
<li><code>pageScope</code> - 一个<a href="../ref/Tag Libraries/pageScope.html" class="tagLibraries">pageScope</a>对象引用，用于GSP的渲染（比如绑定）</li>
<li><code>params</code> - 用于接受请求参数的<a href="../ref/Controllers/params.html" class="controllers">params</a>对象</li>
<li><code>pluginContextPath</code> - 包含标签库的插件上下文路径</li>
<li><code>request</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletRequest.html" class="api">HttpServletRequest</a>实例</li>
<li><code>response</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpServletResponse.html" class="api">HttpServletResponse</a>实例</li>
<li><code>servletContext</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/ServletContext.html" class="api">javax.servlet.ServletContext</a>实例</li>
<li><code>session</code> - <a href="http://download.oracle.com/javaee/1.4/api/javax/servlet/http/HttpSession.html" class="api">HttpSession</a>实例</li>
</ul><p class="paragraph"/>

<a name="6.3.2 Simple Tags"><!-- Legacy link --></a>
<h2 id="simpleTags">6.3.2 简单标签</h2>
<div class="hidden-block">
As demonstrated it the previous example it is easy to write simple tags that have no body and just output content. Another example is a <code>dateFormat</code> style tag:<p class="paragraph"/><div class="code"><pre>def dateFormat = &#123; attrs, body &#45;&#62;
    out &#60;&#60; <span class="java&#45;keyword">new</span> java.text.SimpleDateFormat(attrs.format).format(attrs.date)
&#125;</pre></div><p class="paragraph"/>The above uses Java's <code>SimpleDateFormat</code> class to format a date and then write it to the response. The tag can then be used within a GSP as follows:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:dateFormat format=<span class="xml&#45;quote">"dd&#45;MM&#45;yyyy"</span> date=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>With simple tags sometimes you need to write HTML mark-up to the response. One approach would be to embed the content directly:<p class="paragraph"/><div class="code"><pre>def formatBook = &#123; attrs, body &#45;&#62;
    out &#60;&#60; <span class="java&#45;quote">"&#60;div id=&#34;$&#123;attrs.book.id&#125;&#34;&#62;"</span>
    out &#60;&#60; <span class="java&#45;quote">"Title : $&#123;attrs.book.title&#125;"</span>
    out &#60;&#60; <span class="java&#45;quote">"&#60;/div&#62;"</span>
&#125;</pre></div><p class="paragraph"/>Although this approach may be tempting it is not very clean. A better approach would be to reuse the <a href="../ref/Tags/render.html" class="tags">render</a> tag:<p class="paragraph"/><div class="code"><pre>def formatBook = &#123; attrs, body &#45;&#62;
    out &#60;&#60; render(template: <span class="java&#45;quote">"bookTemplate"</span>, model: &#91;book: attrs.book&#93;)
&#125;</pre></div><p class="paragraph"/>And then have a separate GSP template that does the actual rendering.
</div><p class="paragraph"/>正如以前示例所演示的那样，要写一个只输出内容而没有主体（body）的标签是很容易的。另外的一个示例是<code>dateFormat</code>风格的标签：<p class="paragraph"/><div class="code"><pre>def dateFormat = &#123; attrs, body &#45;&#62;
    out &#60;&#60; <span class="java&#45;keyword">new</span> java.text.SimpleDateFormat(attrs.format).format(attrs.date)
&#125;</pre></div><p class="paragraph"/>在上例中，使用了Java的<code>SimpleDateFormat</code>类来格式化一个日期，并且将它写回到响应中。然后标签就可以在GSP中像下面所示那样使用：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:dateFormat format=<span class="xml&#45;quote">"dd&#45;MM&#45;yyyy"</span> date=<span class="xml&#45;quote">"$&#123;new Date()&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>在简单标签中，有时候需要你将HTML标记内容写回响应。一种方法是直接将内容内嵌到标签中：<p class="paragraph"/><div class="code"><pre>def formatBook = &#123; attrs, body &#45;&#62;
    out &#60;&#60; <span class="java&#45;quote">"&#60;div id=&#34;$&#123;attrs.book.id&#125;&#34;&#62;"</span>
    out &#60;&#60; <span class="java&#45;quote">"Title : $&#123;attrs.book.title&#125;"</span>
    out &#60;&#60; <span class="java&#45;quote">"&#60;/div&#62;"</span>
&#125;</pre></div><p class="paragraph"/>虽然此种方式很直接诱人，但是很不简洁。更好的一种方式是复用<a href="../ref/Tags/render.html" class="tags">render</a>标签：<p class="paragraph"/><div class="code"><pre>def formatBook = &#123; attrs, body &#45;&#62;
    out &#60;&#60; render(template: <span class="java&#45;quote">"bookTemplate"</span>, model: &#91;book: attrs.book&#93;)
&#125;</pre></div><p class="paragraph"/>这样就分离出一个GSP模板来处理真正的渲染。


<a name="6.3.3 Logical Tags"><!-- Legacy link --></a>
<h2 id="logicalTags">6.3.3 逻辑标签</h2>
<div class="hidden-block">
You can also create logical tags where the body of the tag is only output once a set of conditions have been met. An example of this may be a set of security tags:<p class="paragraph"/><div class="code"><pre>def isAdmin = &#123; attrs, body &#45;&#62;
    def user = attrs.user
    <span class="java&#45;keyword">if</span> (user &#38;&#38; checkUserPrivs(user)) &#123;
        out &#60;&#60; body()
    &#125;
&#125;</pre></div><p class="paragraph"/>The tag above checks if the user is an administrator and only outputs the body content if he/she has the correct set of access privileges:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:isAdmin user=<span class="xml&#45;quote">"$&#123;myUser&#125;"</span>&#62;</span>
    // some restricted content
<span class="xml&#45;tag">&#60;/g:isAdmin&#62;</span></pre></div>
</div><p class="paragraph"/>你也可以创建一个逻辑标签，一旦一组条件表达式满足，就输出标签的主体。一组安全标签的示例如下：<p class="paragraph"/><div class="code"><pre>def isAdmin = &#123; attrs, body &#45;&#62;
    def user = attrs.user
    <span class="java&#45;keyword">if</span> (user &#38;&#38; checkUserPrivs(user)) &#123;
        out &#60;&#60; body()
    &#125;
&#125;</pre></div><p class="paragraph"/>上述标签将检查用户是否为一个管理员，并且只有他／她有正确的访问权限的时候，才可以输出主体内容：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:isAdmin user=<span class="xml&#45;quote">"$&#123;myUser&#125;"</span>&#62;</span>
    // some restricted content
<span class="xml&#45;tag">&#60;/g:isAdmin&#62;</span></pre></div>


<a name="6.3.4 Iterative Tags"><!-- Legacy link --></a>
<h2 id="iterativeTags">6.3.4 迭代标签</h2>
<div class="hidden-block">
Iterative tags are easy too, since you can invoke the body multiple times:<p class="paragraph"/><div class="code"><pre>def repeat = &#123; attrs, body &#45;&#62;
    attrs.times?.toInteger()?.times &#123; num &#45;&#62;
        out &#60;&#60; body(num)
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example we check for a <code>times</code> attribute and if it exists convert it to a number, then use Groovy's <code>times</code> method to iterate the specified number of times:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:repeat times=<span class="xml&#45;quote">"3"</span>&#62;</span>
<span class="xml&#45;tag">&#60;p&#62;</span>Repeat this 3 times! Current repeat = $&#123;it&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:repeat&#62;</span></pre></div><p class="paragraph"/>Notice how in this example we use the implicit <code>it</code> variable to refer to the current number. This works because when we invoked the body we passed in the current value inside the iteration:<p class="paragraph"/><div class="code"><pre>out &#60;&#60; body(num)</pre></div><p class="paragraph"/>That value is then passed as the default variable <code>it</code> to the tag. However, if you have nested tags this can lead to conflicts, so you should should instead name the variables that the body uses:<p class="paragraph"/><div class="code"><pre>def repeat = &#123; attrs, body &#45;&#62;
    def <span class="java&#45;keyword">var</span> = attrs.<span class="java&#45;keyword">var</span> ?: <span class="java&#45;quote">"num"</span>
    attrs.times?.toInteger()?.times &#123; num &#45;&#62;
        out &#60;&#60; body((<span class="java&#45;keyword">var</span>):num)
    &#125;
&#125;</pre></div><p class="paragraph"/>Here we check if there is a <code>var</code> attribute and if there is use that as the name to pass into the body invocation on this line:<p class="paragraph"/><div class="code"><pre>out &#60;&#60; body((<span class="java&#45;keyword">var</span>):num)</pre></div><p class="paragraph"/><blockquote class="note">
Note the usage of the parenthesis around the variable name. If you omit these Groovy assumes you are using a String key and not referring to the variable itself.
</blockquote><p class="paragraph"/>Now we can change the usage of the tag as follows:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:repeat times=<span class="xml&#45;quote">"3"</span> var=<span class="xml&#45;quote">"j"</span>&#62;</span>
<span class="xml&#45;tag">&#60;p&#62;</span>Repeat this 3 times! Current repeat = $&#123;j&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:repeat&#62;</span></pre></div><p class="paragraph"/>Notice how we use the <code>var</code> attribute to define the name of the variable <code>j</code> and then we are able to reference that variable within the body of the tag.
</div><p class="paragraph"/>因为你可以多次调用主体（body），所以迭代标签也是很容易的：<p class="paragraph"/><div class="code"><pre>def repeat = &#123; attrs, body &#45;&#62;
    attrs.times?.toInteger()?.times &#123; num &#45;&#62;
        out &#60;&#60; body(num)
    &#125;
&#125;</pre></div><p class="paragraph"/>在此例中，我们检查标签的<code>times</code>属性，如果存在呢，就将其转换为一个数字，然后使用Groovy的<code>times</code>方法来迭代给定的次数：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:repeat times=<span class="xml&#45;quote">"3"</span>&#62;</span>
<span class="xml&#45;tag">&#60;p&#62;</span>Repeat this 3 times! Current repeat = $&#123;it&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:repeat&#62;</span></pre></div><p class="paragraph"/>注意示例中，我们是如何使用隐式的<code>it</code>变量来引用当前的数字。此种方式是有效的，因为在迭代内部，我们将当前值传给了正在调用的主体（body）：<p class="paragraph"/><div class="code"><pre>out &#60;&#60; body(num)</pre></div><p class="paragraph"/>然后那个值作为缺省<code>it</code>变量传给了标签。但是，如果你有嵌套的标签的话，那么这将会导致冲突，因此你应该给给调用的主体变量命名：<p class="paragraph"/><div class="code"><pre>def repeat = &#123; attrs, body &#45;&#62;
    def <span class="java&#45;keyword">var</span> = attrs.<span class="java&#45;keyword">var</span> ?: <span class="java&#45;quote">"num"</span>
    attrs.times?.toInteger()?.times &#123; num &#45;&#62;
        out &#60;&#60; body((<span class="java&#45;keyword">var</span>):num)
    &#125;
&#125;</pre></div><p class="paragraph"/>此处我们检查是否存在一个<code>var</code>属性，如果有，那么将使用其值作为变量名称传递给正在调用的主体，如下所示：<p class="paragraph"/><div class="code"><pre>out &#60;&#60; body((<span class="java&#45;keyword">var</span>):num)</pre></div><p class="paragraph"/><blockquote class="note">
注意！变量名称两边的括号。如果你忽略它们，那么Groovy将会认为你正在使用一个String类型的键，而不是变量本身。
</blockquote><p class="paragraph"/>现在你可以修改标签的使用方法了，如下所示：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:repeat times=<span class="xml&#45;quote">"3"</span> var=<span class="xml&#45;quote">"j"</span>&#62;</span>
<span class="xml&#45;tag">&#60;p&#62;</span>Repeat this 3 times! Current repeat = $&#123;j&#125;<span class="xml&#45;tag">&#60;/p&#62;</span>
<span class="xml&#45;tag">&#60;/g:repeat&#62;</span></pre></div><p class="paragraph"/>请注意我们是如何使用<code>var</code>属性来将变量名称定义为<code>j</code>，然后就可以在标签的主体内来引用此变量了。 tag.


<a name="6.3.5 Tag Namespaces"><!-- Legacy link --></a>
<h2 id="namespaces">6.3.5 标签命名空间</h2>
<div class="hidden-block">
By default, tags are added to the default Grails namespace and are used with the <code>g:</code> prefix in GSP pages. However, you can specify a different namespace by adding a static property to your <code>TagLib</code> class:<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;
    <span class="java&#45;keyword">static</span> namespace = <span class="java&#45;quote">"my"</span><p class="paragraph"/>    def example = &#123; attrs &#45;&#62;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>Here we have specified a <code>namespace</code> of <code>my</code> and hence the tags in this tag lib must then be referenced from GSP pages like this:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;my:example name=<span class="xml&#45;quote">"..."</span> /&#62;</span></pre></div><p class="paragraph"/>where the prefix is the same as the value of the static <code>namespace</code> property. Namespaces are particularly useful for plugins.<p class="paragraph"/>Tags within namespaces can be invoked as methods using the namespace as a prefix to the method call:<p class="paragraph"/><div class="code"><pre>out &#60;&#60; my.example(name:<span class="java&#45;quote">"foo"</span>)</pre></div><p class="paragraph"/>This works from GSP, controllers or tag libraries
</div><p class="paragraph"/>一般情况下，标签使用Grails的缺省命名空间，并且在GSP页面中使用<code>g:</code>前缀。但是你也可以通过在<code>TagLib</code>类中增加一个静态属性来指定另外一个命名空间：<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;
    <span class="java&#45;keyword">static</span> namespace = <span class="java&#45;quote">"my"</span><p class="paragraph"/>    def example = &#123; attrs &#45;&#62;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>此处我们将<code>namespace</code>指定为<code>my</code>，因此此标签库的标签在GSP页面中必须像如下所示那样引用：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;my:example name=<span class="xml&#45;quote">"..."</span> /&#62;</span></pre></div><p class="paragraph"/>前缀部分跟静态属性<code>namespace</code>的值是一样的。命名空间对插件来说特别有用。<p class="paragraph"/>带命名空间的标签也可以以方法的方式调用，需要将其命名空间作为前缀赋给方法调用：<p class="paragraph"/><div class="code"><pre>out &#60;&#60; my.example(name:<span class="java&#45;quote">"foo"</span>)</pre></div><p class="paragraph"/>这将在GSP、控制器或者标签库中有效


<a name="6.3.6 Using JSP Tag Libraries"><!-- Legacy link --></a>
<h2 id="usingJSPTagLibraries">6.3.6 使用JSP标签库</h2>
In addition to the simplified tag library mechanism provided by GSP, you can also use JSP tags from GSP. To do so simply declare the JSP to use with the <code>taglib</code> directive:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;%@ taglib prefix=<span class="xml&#45;quote">"fmt"</span> uri=<span class="xml&#45;quote">"http://java.sun.com/jsp/jstl/fmt"</span> %&#62;</span></pre></div><p class="paragraph"/>Then you can use it like any other tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;fmt:formatNumber value=<span class="xml&#45;quote">"$&#123;10&#125;"</span> pattern=<span class="xml&#45;quote">".00"</span>/&#62;</span></pre></div><p class="paragraph"/>With the added bonus that you can invoke JSP tags like methods:<p class="paragraph"/><div class="code"><pre>$&#123;fmt.formatNumber(value:10, pattern:<span class="java&#45;quote">".00"</span>)&#125;</pre></div>

<a name="6.3.7 Tag return value"><!-- Legacy link --></a>
<h2 id="tagReturnValue">6.3.7 标签的返回值</h2>
Since Grails 1.2, a tag library call returns an instance of <code>org.codehaus.groovy.grails.web.util.StreamCharBuffer</code> class by default.
This change improves performance by reducing object creation and optimizing buffering during request processing.
In earlier Grails versions, a <code>java.lang.String</code> instance was returned.<p class="paragraph"/>Tag libraries can also return direct object values to the caller since Grails 1.2..
Object returning tag names are listed in a static <code>returnObjectForTags</code> property in the tag library class.<p class="paragraph"/>Example:
<div class="code"><pre>class ObjectReturningTagLib &#123;
    <span class="java&#45;keyword">static</span> namespace = <span class="java&#45;quote">"cms"</span>
    <span class="java&#45;keyword">static</span> returnObjectForTags = &#91;'content'&#93;<p class="paragraph"/>    def content = &#123; attrs, body &#45;&#62;
        CmsContent.findByCode(attrs.code)?.content
    &#125;
&#125;</pre></div>

<a name="6.4 URL Mappings"><!-- Legacy link --></a>
<h2 id="urlmappings">6.4 URL映射</h2>
Throughout the documentation so far the convention used for URLs has been the default of <code>/controller/action/id</code>. However, this convention is not hard wired into Grails and is in fact controlled by a URL Mappings class located at <code>grails-app/conf/UrlMappings.groovy</code>.<p class="paragraph"/>The <code>UrlMappings</code> class contains a single property called <code>mappings</code> that has been assigned a block of code:<p class="paragraph"/><div class="code"><pre>class UrlMappings &#123;
    <span class="java&#45;keyword">static</span> mappings = &#123;
    &#125;
&#125;</pre></div><p class="paragraph"/>

<a name="6.4.1 Mapping to Controllers and Actions"><!-- Legacy link --></a>
<h2 id="mappingToControllersAndActions">6.4.1 映射到控制器和操作</h2>
To create a simple mapping simply use a relative URL as the method name and specify named parameters for the controller and action to map to:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/product"</span>(controller: <span class="java&#45;quote">"product"</span>, action: <span class="java&#45;quote">"list"</span>)</pre></div><p class="paragraph"/>In this case we've mapped the URL <code>/product</code> to the <code>list</code> action of the <code>ProductController</code>. Omit the action definition to map to the default action of the controller:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/product"</span>(controller: <span class="java&#45;quote">"product"</span>)</pre></div><p class="paragraph"/>An alternative syntax is to assign the controller and action to use within a block passed to the method:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/product"</span> &#123;
    controller = <span class="java&#45;quote">"product"</span>
    action = <span class="java&#45;quote">"list"</span>
&#125;</pre></div><p class="paragraph"/>Which syntax you use is largely dependent on personal preference. To rewrite one URI onto another explicit URI (rather than a controller/action pair) do something like this:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/hello"</span>(uri: <span class="java&#45;quote">"/hello.dispatch"</span>)</pre></div><p class="paragraph"/>Rewriting specific URIs is often useful when integrating with other frameworks.


<a name="6.4.2 Embedded Variables"><!-- Legacy link --></a>
<h2 id="embeddedVariables">6.4.2 嵌入式变量</h2>
<h4>Simple Variables</h4><p class="paragraph"/>The previous section demonstrated how to map simple URLs with concrete "tokens". In URL mapping speak tokens are the sequence of characters between each slash, '/'. A concrete token is one which is well defined such as as <code>/product</code>. However, in many circumstances you don't know what the value of a particular token will be until runtime. In this case you can use variable placeholders within the URL for example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
  <span class="java&#45;quote">"/product/$id"</span>(controller: <span class="java&#45;quote">"product"</span>)
&#125;</pre></div><p class="paragraph"/>In this case by embedding a $id variable as the second token Grails will automatically map the second token into a parameter (available via the <a href="../ref/Controllers/params.html" class="controllers">params</a> object) called <code>id</code>. For example given the URL <code>/product/MacBook</code>, the following code will render "MacBook" to the response:<p class="paragraph"/><div class="code"><pre>class ProductController &#123;
     def index() &#123; render params.id &#125;
&#125;</pre></div><p class="paragraph"/>You can of course construct more complex examples of mappings. For example the traditional blog URL format could be mapped as follows:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"/$blog/$year/$month/$day/$id"</span>(controller: <span class="java&#45;quote">"blog"</span>, action: <span class="java&#45;quote">"show"</span>)
&#125;</pre></div><p class="paragraph"/>The above mapping would let you do things like:<p class="paragraph"/><div class="code"><pre>/graemerocher/2007/01/10/my_funky_blog_entry</pre></div><p class="paragraph"/>The individual tokens in the URL would again be mapped into the <a href="../ref/Controllers/params.html" class="controllers">params</a> object with values available for <code>year</code>, <code>month</code>, <code>day</code>, <code>id</code> and so on.<p class="paragraph"/><h4>Dynamic Controller and Action Names</h4><p class="paragraph"/>Variables can also be used to dynamically construct the controller and action name. In fact the default Grails URL mappings use this technique:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/$controller/$action?/$id?"</span>()
&#125;</pre></div><p class="paragraph"/>Here the name of the controller, action and id are implicitly obtained from the variables <code>controller</code>, <code>action</code> and <code>id</code> embedded within the URL.<p class="paragraph"/>You can also resolve the controller name and action name to execute dynamically using a closure:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/$controller"</span> &#123;
        action = &#123; params.goHere &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Optional Variables</h4><p class="paragraph"/>Another characteristic of the default mapping is the ability to append a ? at the end of a variable to make it an optional token. In a further example this technique could be applied to the blog URL mapping to have more flexible linking:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/$blog/$year?/$month?/$day?/$id?"</span>(controller:<span class="java&#45;quote">"blog"</span>, action:<span class="java&#45;quote">"show"</span>)
&#125;</pre></div><p class="paragraph"/>With this mapping all of these URLs would match with only the relevant parameters being populated in the <a href="../ref/Controllers/params.html" class="controllers">params</a> object:<p class="paragraph"/><pre class="bq"><code>
/graemerocher/2007/01/10/my_funky_blog_entry
/graemerocher/2007/01/10
/graemerocher/2007/01
/graemerocher/2007
/graemerocher</code></pre><p class="paragraph"/><h4>Arbitrary Variables</h4><p class="paragraph"/>You can also pass arbitrary parameters from the URL mapping into the controller by just setting them in the block passed to the mapping:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/holiday/win"</span> &#123;
     id = <span class="java&#45;quote">"Marrakech"</span>
     year = 2007
&#125;</pre></div><p class="paragraph"/>This variables will be available within the <a href="../ref/Controllers/params.html" class="controllers">params</a> object passed to the controller.<p class="paragraph"/><h4>Dynamically Resolved Variables</h4><p class="paragraph"/>The hard coded arbitrary variables are useful, but sometimes you need to calculate the name of the variable based on runtime factors. This is also possible by assigning a block to the variable name:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/holiday/win"</span> &#123;
     id = &#123; params.id &#125;
     isEligible = &#123; session.user != <span class="java&#45;keyword">null</span> &#125; // must be logged in
&#125;</pre></div><p class="paragraph"/>In the above case the code within the blocks is resolved when the URL is actually matched and hence can be used in combination with all sorts of logic.


<a name="6.4.3 Mapping to Views"><!-- Legacy link --></a>
<h2 id="mappingToViews">6.4.3 映射到视图</h2>
You can resolve a URL to a view without a controller or action involved. For example to map the root URL <code>/</code> to a GSP at the location <code>grails-app/views/index.gsp</code> you could use:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/"</span>(view: <span class="java&#45;quote">"/index"</span>)  // map the root URL
&#125;</pre></div><p class="paragraph"/>Alternatively if you need a view that is specific to a given controller you could use:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"/help"</span>(controller: <span class="java&#45;quote">"site"</span>, view: <span class="java&#45;quote">"help"</span>) // to a view <span class="java&#45;keyword">for</span> a controller
&#125;</pre></div>


<a name="6.4.4 Mapping to Response Codes"><!-- Legacy link --></a>
<h2 id="mappingToResponseCodes">6.4.4 映射到响应代码</h2>
Grails also lets you map HTTP response codes to controllers, actions or views. Just use a method name that matches the response code you are interested in:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"403"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"forbidden"</span>)
   <span class="java&#45;quote">"404"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"notFound"</span>)
   <span class="java&#45;quote">"500"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"serverError"</span>)
&#125;</pre></div><p class="paragraph"/>Or you can specify custom error pages:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"403"</span>(view: <span class="java&#45;quote">"/errors/forbidden"</span>)
   <span class="java&#45;quote">"404"</span>(view: <span class="java&#45;quote">"/errors/notFound"</span>)
   <span class="java&#45;quote">"500"</span>(view: <span class="java&#45;quote">"/errors/serverError"</span>)
&#125;</pre></div><p class="paragraph"/><h4>Declarative Error Handling</h4><p class="paragraph"/>In addition you can configure handlers for individual exceptions:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"403"</span>(view: <span class="java&#45;quote">"/errors/forbidden"</span>)
   <span class="java&#45;quote">"404"</span>(view: <span class="java&#45;quote">"/errors/notFound"</span>)
   <span class="java&#45;quote">"500"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"illegalArgument"</span>,
         exception: IllegalArgumentException)
   <span class="java&#45;quote">"500"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"nullPointer"</span>,
         exception: NullPointerException)
   <span class="java&#45;quote">"500"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"customException"</span>,
         exception: MyException)
   <span class="java&#45;quote">"500"</span>(view: <span class="java&#45;quote">"/errors/serverError"</span>)
&#125;</pre></div><p class="paragraph"/>With this configuration, an <code>IllegalArgumentException</code> will be handled by the <code>illegalArgument</code> action in <code>ErrorsController</code>, a <code>NullPointerException</code> will be handled by the <code>nullPointer</code> action, and a <code>MyException</code> will be handled by the <code>customException</code> action. Other exceptions will be handled by the catch-all rule and use the <code>/errors/serverError</code> view.<p class="paragraph"/>You can access the exception from your custom error handing view or controller action using the request's <code>exception</code> attribute like so:<p class="paragraph"/><div class="code"><pre>class ErrorController &#123;
    def handleError() &#123;
        def exception = request.exception
        // perform desired processing to handle the exception
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
If your error-handling controller action throws an exception as well, you'll end up with a <code>StackOverflowException</code>.
</blockquote>


<a name="6.4.5 Mapping to HTTP methods"><!-- Legacy link --></a>
<h2 id="mappingHTTP">6.4.5 映射到HTTP方法</h2>
URL mappings can also be configured to map based on the HTTP method (GET, POST, PUT or DELETE). This is very useful for RESTful APIs and for restricting mappings based on HTTP method.<p class="paragraph"/>As an example the following mappings provide a RESTful API URL mappings for the <code>ProductController</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"/product/$id"</span>(controller:<span class="java&#45;quote">"product"</span>) &#123;
       action = &#91;GET:<span class="java&#45;quote">"show"</span>, PUT:<span class="java&#45;quote">"update"</span>, DELETE:<span class="java&#45;quote">"delete"</span>, POST:<span class="java&#45;quote">"save"</span>&#93;
   &#125;
&#125;</pre></div>

<a name="6.4.6 Mapping Wildcards"><!-- Legacy link --></a>
<h2 id="mappingWildcards">6.4.6 映射到通配符</h2>
Grails' URL mappings mechanism also supports wildcard mappings. For example consider the following mapping:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/images/&#42;.jpg"</span>(controller: <span class="java&#45;quote">"image"</span>)
&#125;</pre></div><p class="paragraph"/>This mapping will match all paths to images such as <code>/image/logo.jpg</code>. Of course you can achieve the same effect with a variable:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/images/$name.jpg"</span>(controller: <span class="java&#45;quote">"image"</span>)
&#125;</pre></div><p class="paragraph"/>However, you can also use double wildcards to match more than one level below:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/images/&#42;&#42;.jpg"</span>(controller: <span class="java&#45;quote">"image"</span>)
&#125;</pre></div><p class="paragraph"/>In this cases the mapping will match <code>/image/logo.jpg</code> as well as <code>/image/other/logo.jpg</code>. Even better you can use a double wildcard variable:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    // will match /image/logo.jpg and /image/other/logo.jpg
    <span class="java&#45;quote">"/images/$name&#42;&#42;.jpg"</span>(controller: <span class="java&#45;quote">"image"</span>)
&#125;</pre></div><p class="paragraph"/>In this case it will store the path matched by the wildcard inside a <code>name</code> parameter obtainable from the <a href="../ref/Controllers/params.html" class="controllers">params</a> object:<p class="paragraph"/><div class="code"><pre>def name = params.name
println name // prints <span class="java&#45;quote">"logo"</span> or <span class="java&#45;quote">"other/logo"</span></pre></div><p class="paragraph"/>If you use wildcard URL mappings then you may want to exclude certain URIs from Grails' URL mapping process. To do this you can provide an <code>excludes</code> setting inside the <code>UrlMappings.groovy</code> class:<p class="paragraph"/><div class="code"><pre>class UrlMappings &#123;
    <span class="java&#45;keyword">static</span> excludes = &#91;<span class="java&#45;quote">"/images/&#42;"</span>, <span class="java&#45;quote">"/css/&#42;"</span>&#93;
    <span class="java&#45;keyword">static</span> mappings = &#123;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case Grails won't attempt to match any URIs that start with <code>/images</code> or <code>/css</code>.


<a name="6.4.7 Automatic Link Re-Writing"><!-- Legacy link --></a>
<h2 id="automaticLinkRewriting">6.4.7 自动重写链接</h2>
Another great feature of URL mappings is that they automatically customize the behaviour of the <a href="../ref/Tags/link.html" class="tags">link</a> tag so that changing the mappings don't require you to go and change all of your links.<p class="paragraph"/>This is done through a URL re-writing technique that reverse engineers the links from the URL mappings. So given a mapping such as the blog one from an earlier section:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"/$blog/$year?/$month?/$day?/$id?"</span>(controller:<span class="java&#45;quote">"blog"</span>, action:<span class="java&#45;quote">"show"</span>)
&#125;</pre></div><p class="paragraph"/>If you use the link tag as follows:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:link controller=<span class="xml&#45;quote">"blog"</span> action=<span class="xml&#45;quote">"show"</span>
        params=<span class="xml&#45;quote">"&#91;blog:'fred', year:2007&#93;"</span>&#62;</span>
    My Blog
<span class="xml&#45;tag">&#60;/g:link&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;g:link controller=<span class="xml&#45;quote">"blog"</span> action=<span class="xml&#45;quote">"show"</span>
        params=<span class="xml&#45;quote">"&#91;blog:'fred', year:2007, month:10&#93;"</span>&#62;</span>
    My Blog &#45; October 2007 Posts
<span class="xml&#45;tag">&#60;/g:link&#62;</span></pre></div><p class="paragraph"/>Grails will automatically re-write the URL in the correct format:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;a href=<span class="xml&#45;quote">"/fred/2007"</span>&#62;</span>My Blog<span class="xml&#45;tag">&#60;/a&#62;</span>
<span class="xml&#45;tag">&#60;a href=<span class="xml&#45;quote">"/fred/2007/10"</span>&#62;</span>My Blog &#45; October 2007 Posts<span class="xml&#45;tag">&#60;/a&#62;</span></pre></div>


<a name="6.4.8 Applying Constraints"><!-- Legacy link --></a>
<h2 id="applyingConstraints">6.4.8 应用约束</h2>
URL Mappings also support Grails' unified <a href="../guide/single.html#constraints" class="guide">validation constraints</a> mechanism, which lets you further "constrain" how a URL is matched. For example, if we revisit the blog sample code from earlier, the mapping currently looks like this:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"/$blog/$year?/$month?/$day?/$id?"</span>(controller:<span class="java&#45;quote">"blog"</span>, action:<span class="java&#45;quote">"show"</span>)
&#125;</pre></div><p class="paragraph"/>This allows URLs such as:<p class="paragraph"/><div class="code"><pre>/graemerocher/2007/01/10/my_funky_blog_entry</pre></div><p class="paragraph"/>However, it would also allow:<p class="paragraph"/><div class="code"><pre>/graemerocher/not_a_year/not_a_month/not_a_day/my_funky_blog_entry</pre></div><p class="paragraph"/>This is problematic as it forces you to do some clever parsing in the controller code. Luckily, URL Mappings can be constrained to further validate the URL tokens:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/$blog/$year?/$month?/$day?/$id?"</span> &#123;
     controller = <span class="java&#45;quote">"blog"</span>
     action = <span class="java&#45;quote">"show"</span>
     constraints &#123;
          year(matches:/&#92;d&#123;4&#125;/)
          month(matches:/&#92;d&#123;2&#125;/)
          day(matches:/&#92;d&#123;2&#125;/)
     &#125;
&#125;</pre></div><p class="paragraph"/>In this case the constraints ensure that the <code>year</code>, <code>month</code> and <code>day</code> parameters match a particular valid pattern thus relieving you of that burden later on.

<a name="6.4.9 Named URL Mappings"><!-- Legacy link --></a>
<h2 id="namedMappings">6.4.9 命名URL映射</h2>
URL Mappings also support named mappings, that is mappings which have a name associated with them. The name may be used to refer to a specific mapping when links are generated.<p class="paragraph"/>The syntax for defining a named mapping is as follows:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   name &#60;mapping name&#62;: &#60;url pattern&#62; &#123;
      // &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>For example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    name personList: <span class="java&#45;quote">"/showPeople"</span> &#123;
        controller = 'person'
        action = 'list'
    &#125;
    name accountDetails: <span class="java&#45;quote">"/details/$acctNumber"</span> &#123;
        controller = 'product'
        action = 'accountDetails'
    &#125;
&#125;</pre></div><p class="paragraph"/>The mapping may be referenced in a link tag in a GSP.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:link mapping=<span class="xml&#45;quote">"personList"</span>&#62;</span>List People<span class="xml&#45;tag">&#60;/g:link&#62;</span></pre></div><p class="paragraph"/>That would result in:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;a href=<span class="xml&#45;quote">"/showPeople"</span>&#62;</span>List People<span class="xml&#45;tag">&#60;/a&#62;</span></pre></div><p class="paragraph"/>Parameters may be specified using the params attribute.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:link mapping=<span class="xml&#45;quote">"accountDetails"</span> params=<span class="xml&#45;quote">"&#91;acctNumber:'8675309'&#93;"</span>&#62;</span>
    Show Account
<span class="xml&#45;tag">&#60;/g:link&#62;</span></pre></div><p class="paragraph"/>That would result in:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;a href=<span class="xml&#45;quote">"/details/8675309"</span>&#62;</span>Show Account<span class="xml&#45;tag">&#60;/a&#62;</span></pre></div><p class="paragraph"/>Alternatively you may reference a named mapping using the link namespace.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;link:personList&#62;</span>List People<span class="xml&#45;tag">&#60;/link:personList&#62;</span></pre></div><p class="paragraph"/>That would result in:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;a href=<span class="xml&#45;quote">"/showPeople"</span>&#62;</span>List People<span class="xml&#45;tag">&#60;/a&#62;</span></pre></div><p class="paragraph"/>The link namespace approach allows parameters to be specified as attributes.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;link:accountDetails acctNumber=<span class="xml&#45;quote">"8675309"</span>&#62;</span>Show Account<span class="xml&#45;tag">&#60;/link:accountDetails&#62;</span></pre></div><p class="paragraph"/>That would result in:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;a href=<span class="xml&#45;quote">"/details/8675309"</span>&#62;</span>Show Account<span class="xml&#45;tag">&#60;/a&#62;</span></pre></div><p class="paragraph"/>To specify attributes that should be applied to the generated <code>href</code>, specify a <code>Map</code> value to the <code>attrs</code> attribute.  These attributes will be applied directly to the href, not passed through to be used as request parameters.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;link:accountDetails attrs=<span class="xml&#45;quote">"&#91;class: 'fancy'&#93;"</span> acctNumber=<span class="xml&#45;quote">"8675309"</span>&#62;</span>
    Show Account
<span class="xml&#45;tag">&#60;/link:accountDetails&#62;</span></pre></div><p class="paragraph"/>That would result in:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;a href=<span class="xml&#45;quote">"/details/8675309"</span> class=<span class="xml&#45;quote">"fancy"</span>&#62;</span>Show Account<span class="xml&#45;tag">&#60;/a&#62;</span></pre></div>



<h2 id="customizingUrlFormat">6.4.10 自定义URL格式</h2>
The default URL Mapping mechanism supports camel case names in the URLs.  The default URL for accessing an action named <code>addNumbers</code> in a controller named <code>MathHelperController</code> would be something like <code>/mathHelper/addNumbers</code>.  Grails allows for the customization of this pattern and provides an implementation which replaces the camel case convention with a hyphenated convention that would support URLs like <code>/math-helper/add-numbers</code>.  To enable hyphenated URLs assign a value of "hyphenated" to the <code>grails.web.url.converter</code> property in <code>grails-app/conf/Config.groovy</code>.<p class="paragraph"/><div class="code"><pre>// grails&#45;app/conf/Config.groovy<p class="paragraph"/>grails.web.url.converter = 'hyphenated'</pre></div><p class="paragraph"/>Arbitrary strategies may be plugged in by providing a class which implements the <a href="../../api/grails/web/UrlConverter.html" class="api">UrlConverter</a> interface and adding an instance of that class to the Spring application context with the bean name of <code>grails.web.UrlConverter.BEAN_NAME</code>.  If Grails finds a bean in the context with that name, it will be used as the default converter and there is no need to assign a value to the <code>grails.web.url.converter</code> config property.<p class="paragraph"/><div class="code"><pre>// src/groovy/com/myapplication/MyUrlConverterImpl.groovy<p class="paragraph"/><span class="java&#45;keyword">package</span> com.myapplication<p class="paragraph"/>class MyUrlConverterImpl <span class="java&#45;keyword">implements</span> grails.web.UrlConverter &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> toUrlElement(<span class="java&#45;object">String</span> propertyOrClassName) &#123;
        // <span class="java&#45;keyword">return</span> some representation of a property or class name that should be used in URLs&#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>// grails&#45;app/conf/spring/resources.groovy<p class="paragraph"/>beans = &#123;
    <span class="java&#45;quote">"$&#123;grails.web.UrlConverter.BEAN_NAME&#125;"</span>(com.myapplication.MyUrlConverterImpl)
&#125;</pre></div>


<a name="6.5 Web Flow"><!-- Legacy link --></a>
<h2 id="webflow">6.5 Web工作流</h2>
<h4>Overview</h4><p class="paragraph"/>Grails supports the creation of web flows built on the <a href="http://www.springsource.org/webflow" target="blank">Spring Web Flow</a> project. A web flow is a conversation that spans multiple requests and retains state for the scope of the flow. A web flow also has a defined start and end state.<p class="paragraph"/>Web flows don't require an HTTP session, but instead store their state in a serialized form, which is then restored using a flow execution key that Grails passes around as a request parameter. This makes flows far more scalable than other forms of stateful application that use the HttpSession and its inherit memory and clustering concerns.<p class="paragraph"/>Web flow is essentially an advanced state machine that manages the "flow" of execution from one state to the next. Since the state is managed for you, you don't have to be concerned with ensuring that users enter an action in the middle of some multi step flow, as web flow manages that for you. This makes web flow perfect for use cases such as shopping carts, hotel booking and any application that has multi page work flows.<p class="paragraph"/><blockquote class="note">
From Grails 1.2 onwards Webflow is no longer in Grails core, so you must install the Webflow plugin to use this feature: <code>grails install-plugin webflow</code>
</blockquote><p class="paragraph"/><h4>Creating a Flow</h4><p class="paragraph"/>To create a flow create a regular Grails controller and add an action that ends with the convention <code>Flow</code>. For example:<p class="paragraph"/><div class="code"><pre>class BookController &#123;<p class="paragraph"/>   def index() &#123;
      redirect(action: <span class="java&#45;quote">"shoppingCart"</span>)
   &#125;<p class="paragraph"/>   def shoppingCartFlow = &#123;
        &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>Notice when redirecting or referring to the flow as an action we omit the <code>Flow</code> suffix. In other words the name of the action of the above flow is <code>shoppingCart</code>.


<a name="6.5.1 Start and End States"><!-- Legacy link --></a>
<h2 id="startAndEndStates">6.5.1 开始和结束状态</h2>
As mentioned before a flow has a defined start and end state. A start state is the state which is entered when a user first initiates a conversation (or flow). The start state of a Grails flow is the first method call that takes a block. For example:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
   &#8230;
   def shoppingCartFlow =&#123;
       showCart &#123;
           on(<span class="java&#45;quote">"checkout"</span>).to <span class="java&#45;quote">"enterPersonalDetails"</span>
           on(<span class="java&#45;quote">"continueShopping"</span>).to <span class="java&#45;quote">"displayCatalogue"</span>
       &#125;
       &#8230;
       displayCatalogue &#123;
           redirect(controller: <span class="java&#45;quote">"catalogue"</span>, action: <span class="java&#45;quote">"show"</span>)
       &#125;
       displayInvoice()
   &#125;
&#125;</pre></div><p class="paragraph"/>Here the <code>showCart</code> node is the start state of the flow. Since the showCart state doesn't define an action or redirect it is assumed be a <a href="../guide/single.html#actionStatesAndViewStates" class="guide">view state</a> that, by convention, refers to the view  <code>grails-app/views/book/shoppingCart/showCart.gsp</code>.<p class="paragraph"/>Notice that unlike regular controller actions, the views are stored within a directory that matches the name of the flow: <code>grails-app/views/book/shoppingCart</code>.<p class="paragraph"/>The <code>shoppingCart</code> flow also has two possible end states. The first is <code>displayCatalogue</code> which performs an external redirect to another controller and action, thus exiting the flow. The second is <code>displayInvoice</code> which is an end state as it has no events at all and will simply render a view called <code>grails-app/views/book/shoppingCart/displayInvoice.gsp</code> whilst ending the flow at the same time.<p class="paragraph"/>Once a flow has ended it can only be resumed from the start state, in this case <code>showCart</code>, and not from any other state.


<a name="6.5.2 Action States and View States"><!-- Legacy link --></a>
<h2 id="actionStatesAndViewStates">6.5.2 操作状态和视图状态</h2>
<h4>View states</h4><p class="paragraph"/>A view state is a one that doesn't define an <code>action</code> or a <code>redirect</code>. So for example this is a view state:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   on(<span class="java&#45;quote">"submit"</span>).to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>It will look for a view called <code>grails-app/views/book/shoppingCart/enterPersonalDetails.gsp</code> by default. Note that the <code>enterPersonalDetails</code> state defines two events: <code>submit</code> and <code>return</code>. The view is responsible for <a href="../guide/single.html#flowExecutionEvents" class="guide">triggering</a> these events. Use the <code>render</code> method to change the view to be rendered:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   render(view: <span class="java&#45;quote">"enterDetailsView"</span>)
   on(<span class="java&#45;quote">"submit"</span>).to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>Now it will look for <code>grails-app/views/book/shoppingCart/enterDetailsView.gsp</code>. Start the <code>view</code> parameter with a / to use a shared view:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   render(view: <span class="java&#45;quote">"/shared/enterDetailsView"</span>)
   on(<span class="java&#45;quote">"submit"</span>).to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>Now it will look for <code>grails-app/views/shared/enterDetailsView.gsp</code><p class="paragraph"/><h4>Action States</h4><p class="paragraph"/>An action state is a state that executes code but does not render a view. The result of the action is used to dictate flow transition. To create an action state you define an action to to be executed. This is done by calling the <code>action</code> method and passing it a block of code to be executed:<p class="paragraph"/><div class="code"><pre>listBooks &#123;
   action &#123;
      &#91;bookList: Book.list()&#93;
   &#125;
   on(<span class="java&#45;quote">"success"</span>).to <span class="java&#45;quote">"showCatalogue"</span>
   on(Exception).to <span class="java&#45;quote">"handleError"</span>
&#125;</pre></div><p class="paragraph"/>As you can see an action looks very similar to a controller action and in fact you can reuse controller actions if you want. If the action successfully returns with no errors the <code>success</code> event will be triggered. In this case since we return a Map, which is regarded as the "model" and is automatically placed in <a href="../guide/single.html#flowScopes" class="guide">flow scope</a>.<p class="paragraph"/>In addition, in the above example we also use an exception handler to deal with errors on the line:<p class="paragraph"/><div class="code"><pre>on(Exception).to <span class="java&#45;quote">"handleError"</span></pre></div><p class="paragraph"/>This makes the flow transition to a state called <code>handleError</code> in the case of an exception.<p class="paragraph"/>You can write more complex actions that interact with the flow request context:<p class="paragraph"/><div class="code"><pre>processPurchaseOrder &#123;
    action &#123;
        def a =  flow.address
        def p = flow.person
        def pd = flow.paymentDetails
        def cartItems = flow.cartItems
        flow.clear()<p class="paragraph"/>        def o = <span class="java&#45;keyword">new</span> Order(person: p, shippingAddress: a, paymentDetails: pd)
        o.invoiceNumber = <span class="java&#45;keyword">new</span> Random().nextInt(9999999)
        <span class="java&#45;keyword">for</span> (item in cartItems) &#123; o.addToItems item &#125;
        o.save()
        &#91;order: o&#93;
    &#125;
    on(<span class="java&#45;quote">"error"</span>).to <span class="java&#45;quote">"confirmPurchase"</span>
    on(Exception).to <span class="java&#45;quote">"confirmPurchase"</span>
    on(<span class="java&#45;quote">"success"</span>).to <span class="java&#45;quote">"displayInvoice"</span>
&#125;</pre></div><p class="paragraph"/>Here is a more complex action that gathers all the information accumulated from the flow scope and creates an <code>Order</code> object. It then returns the order as the model. The important thing to note here is the interaction with the request context and "flow scope".<p class="paragraph"/><h4>Transition Actions</h4><p class="paragraph"/>Another form of action is what is known as a  <em class="italic">transition</em>  action. A transition action is executed directly prior to state transition once an <a href="../guide/single.html#flowExecutionEvents" class="guide">event</a> has been triggered. A simple example of a transition action can be seen below:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   on(<span class="java&#45;quote">"submit"</span>) &#123;
       log.trace <span class="java&#45;quote">"Going to enter shipping"</span>
   &#125;.to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>Notice how we pass a block of the code to <code>submit</code> event that simply logs the transition. Transition states are very useful for <a href="../guide/single.html#dataBindingAndValidation" class="guide">data binding and validation</a>, which is covered in a later section.


<a name="6.5.3 Flow Execution Events"><!-- Legacy link --></a>
<h2 id="flowExecutionEvents">6.5.3 工作流执行事件</h2>
In order to  <em class="italic">transition</em>  execution of a flow from one state to the next you need some way of trigger an  <em class="italic">event</em>  that indicates what the flow should do next. Events can be triggered from either view states or action states.<p class="paragraph"/><h4>Triggering Events from a View State</h4><p class="paragraph"/>As discussed previously the start state of the flow in a previous code listing deals with two possible events. A <code>checkout</code> event and a <code>continueShopping</code> event:<p class="paragraph"/><div class="code"><pre>def shoppingCartFlow = &#123;
    showCart &#123;
        on(<span class="java&#45;quote">"checkout"</span>).to <span class="java&#45;quote">"enterPersonalDetails"</span>
        on(<span class="java&#45;quote">"continueShopping"</span>).to <span class="java&#45;quote">"displayCatalogue"</span>
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>Since the <code>showCart</code> event is a view state it will render the view <code>grails-app/book/shoppingCart/showCart.gsp</code>. Within this view you need to have components that trigger flow execution. On a form this can be done use the <a href="../ref/Tags/submitButton.html" class="tags">submitButton</a> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form action=<span class="xml&#45;quote">"shoppingCart"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;g:submitButton name=<span class="xml&#45;quote">"continueShopping"</span> value=<span class="xml&#45;quote">"Continue Shopping"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;g:submitButton name=<span class="xml&#45;quote">"checkout"</span> value=<span class="xml&#45;quote">"Checkout"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/g:form&#62;</span></pre></div><p class="paragraph"/>The form must submit back to the <code>shoppingCart</code> flow. The name attribute of each <a href="../ref/Tags/submitButton.html" class="tags">submitButton</a> tag signals which event will be triggered. If you don't have a form you can also trigger an event with the <a href="../ref/Tags/link.html" class="tags">link</a> tag as follows:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:link action=<span class="xml&#45;quote">"shoppingCart"</span> event=<span class="xml&#45;quote">"checkout"</span> /&#62;</span></pre></div><p class="paragraph"/><h4>Triggering Events from an Action</h4><p class="paragraph"/>To trigger an event from an <code>action</code> you invoke a method. For example there is the built in <code>error()</code> and <code>success()</code> methods. The example below triggers the <code>error()</code> event on validation failure in a transition action:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   on(<span class="java&#45;quote">"submit"</span>) &#123;
         def p = <span class="java&#45;keyword">new</span> Person(params)
         flow.person = p
         <span class="java&#45;keyword">if</span> (!p.validate()) <span class="java&#45;keyword">return</span> error()
   &#125;.to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>In this case because of the error the transition action will make the flow go back to the <code>enterPersonalDetails</code> state.<p class="paragraph"/>With an action state you can also trigger events to redirect flow:<p class="paragraph"/><div class="code"><pre>shippingNeeded &#123;
   action &#123;
       <span class="java&#45;keyword">if</span> (params.shippingRequired) yes()
       <span class="java&#45;keyword">else</span> no()
   &#125;
   on(<span class="java&#45;quote">"yes"</span>).to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"no"</span>).to <span class="java&#45;quote">"enterPayment"</span>
&#125;</pre></div><p class="paragraph"/>

<a name="6.5.4 Flow Scopes"><!-- Legacy link --></a>
<h2 id="flowScopes">6.5.4 工作流的作用域</h2>
<h4>Scope Basics</h4><p class="paragraph"/>You'll notice from previous examples that we used a special object called <code>flow</code> to store objects within "flow scope". Grails flows have five different scopes you can utilize:
<ul class="star">
<li><code>request</code> - Stores an object for the scope of the current request</li>
<li><code>flash</code> - Stores the object for the current and next request only</li>
<li><code>flow</code> - Stores objects for the scope of the flow, removing them when the flow reaches an end state</li>
<li><code>conversation</code> - Stores objects for the scope of the conversation including the root flow and nested subflows</li>
<li><code>session</code> - Stores objects in the user's session</li>
</ul><p class="paragraph"/><blockquote class="note">
Grails service classes can be automatically scoped to a web flow scope. See the documentation on <a href="../guide/single.html#services" class="guide">Services</a> for more information.
</blockquote><p class="paragraph"/>Returning a model Map from an action will automatically result in the model being placed in flow scope. For example, using a transition action, you can place objects within <code>flow</code> scope as follows:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
    on(<span class="java&#45;quote">"submit"</span>) &#123;
        &#91;person: <span class="java&#45;keyword">new</span> Person(params)&#93;
    &#125;.to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>Be aware that a new request is always created for each state, so an object placed in request scope in an action state (for example) will not be available in a subsequent view state. Use one of the other scopes to pass objects from one state to another. Also note that Web Flow:
<ol>
<li>Moves objects from flash scope to request scope upon transition between states;</li>
<li>Merges objects from the flow and conversation scopes into the view model before rendering (so you shouldn't include a scope prefix when referencing these objects within a view, e.g. GSP pages).</li>
</ol><p class="paragraph"/><h4>Flow Scopes and Serialization</h4><p class="paragraph"/>When placing objects in <code>flash</code>, <code>flow</code> or <code>conversation</code> scope they must implement <code>java.io.Serializable</code> or an exception will be thrown. This has an impact on <a href="../guide/single.html#GORM" class="guide">domain classes</a> in that domain classes are typically placed within a scope so that they can be rendered in a view. For example consider the following domain class:<p class="paragraph"/><div class="code"><pre>class Book &#123;
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/>To place an instance of the <code>Book</code> class in a flow scope you will need to modify it as follows:<p class="paragraph"/><div class="code"><pre>class Book <span class="java&#45;keyword">implements</span> Serializable &#123;
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/>This also impacts associations and closures you declare within a domain class. For example consider this:<p class="paragraph"/><div class="code"><pre>class Book <span class="java&#45;keyword">implements</span> Serializable &#123;
    <span class="java&#45;object">String</span> title
    Author author
&#125;</pre></div><p class="paragraph"/>Here if the <code>Author</code> association is not <code>Serializable</code> you will also get an error. This also impacts closures used in <a href="../guide/single.html#eventsAutoTimestamping" class="guide">GORM events</a> such as <code>onLoad</code>, <code>onSave</code> and so on. The following domain class will cause an error if an instance is placed in a flow scope:<p class="paragraph"/><div class="code"><pre>class Book <span class="java&#45;keyword">implements</span> Serializable &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title<p class="paragraph"/>    def onLoad = &#123;
        println <span class="java&#45;quote">"I'm loading"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The reason is that the assigned block on the <code>onLoad</code> event cannot be serialized. To get around this you should declare all events as <code>transient</code>:<p class="paragraph"/><div class="code"><pre>class Book <span class="java&#45;keyword">implements</span> Serializable &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title<p class="paragraph"/>    <span class="java&#45;keyword">transient</span> onLoad = &#123;
        println <span class="java&#45;quote">"I'm loading"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>or as methods:<p class="paragraph"/><div class="code"><pre>class Book <span class="java&#45;keyword">implements</span> Serializable &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title<p class="paragraph"/>    def onLoad() &#123;
        println <span class="java&#45;quote">"I'm loading"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
The flow scope contains a reference to the Hibernate session. As a result, any object loaded into the session through a GORM query will also be in the flow and will need to implement Serializable.<p class="paragraph"/>If you don't want your domain class to be Serializable or stored in the flow, then you will need to evict the entity manually before the end of the state:<p class="paragraph"/><div class="code"><pre>flow.persistenceContext.evict(it)</pre></div>
</blockquote>


<a name="6.5.5 Data Binding and Validation"><!-- Legacy link --></a>
<h2 id="dataBindingAndValidation">6.5.5 数据绑定和验证</h2>
In the section on <a href="../guide/single.html#startAndEndStates" class="guide">start and end states</a>, the start state in the first example triggered a transition to the <code>enterPersonalDetails</code> state. This state renders a view and waits for the user to enter the required information:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   on(<span class="java&#45;quote">"submit"</span>).to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>The view contains a form with two submit buttons that either trigger the submit event or the return event:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:form action=<span class="xml&#45;quote">"shoppingCart"</span>&#62;</span>
    <span class="xml&#45;comment">&#60;!&#45;&#45; Other fields &#45;&#45;&#62;</span>
    <span class="xml&#45;tag">&#60;g:submitButton name=<span class="xml&#45;quote">"submit"</span> value=<span class="xml&#45;quote">"Continue"</span>&#62;</span><span class="xml&#45;tag">&#60;/g:submitButton&#62;</span>
    <span class="xml&#45;tag">&#60;g:submitButton name=<span class="xml&#45;quote">"return"</span> value=<span class="xml&#45;quote">"Back"</span>&#62;</span><span class="xml&#45;tag">&#60;/g:submitButton&#62;</span>
<span class="xml&#45;tag">&#60;/g:form&#62;</span></pre></div><p class="paragraph"/>However, what about the capturing the information submitted by the form? To capture the form info we can use a flow transition action:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   on(<span class="java&#45;quote">"submit"</span>) &#123;
      flow.person = <span class="java&#45;keyword">new</span> Person(params)
      !flow.person.validate() ? error() : success()
   &#125;.to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div><p class="paragraph"/>Notice how we perform data binding from request parameters and place the <code>Person</code> instance within <code>flow</code> scope. Also interesting is that we perform <a href="../guide/single.html#validation" class="guide">validation</a> and invoke the <code>error()</code> method if validation fails. This signals to the flow that the transition should halt and return to the <code>enterPersonalDetails</code> view so valid entries can be entered by the user, otherwise the transition should continue and go to the <code>enterShipping</code> state.<p class="paragraph"/>Like regular actions, flow actions also support the notion of <a href="../guide/single.html#commandObjects" class="guide">Command Objects</a> by defining the first argument of the closure:<p class="paragraph"/><div class="code"><pre>enterPersonalDetails &#123;
   on(<span class="java&#45;quote">"submit"</span>) &#123; PersonDetailsCommand cmd &#45;&#62;
       flow.personDetails = cmd
      !flow.personDetails.validate() ? error() : success()
   &#125;.to <span class="java&#45;quote">"enterShipping"</span>
   on(<span class="java&#45;quote">"<span class="java&#45;keyword">return</span>"</span>).to <span class="java&#45;quote">"showCart"</span>
&#125;</pre></div>


<a name="6.5.6 Subflows and Conversations"><!-- Legacy link --></a>
<h2 id="subflowsAndConversations">6.5.6 子流程和会话</h2>
Grails' Web Flow integration also supports subflows. A subflow is like a flow within a flow. For example take this search flow:<p class="paragraph"/><div class="code"><pre>def searchFlow = &#123;
    displaySearchForm &#123;
        on(<span class="java&#45;quote">"submit"</span>).to <span class="java&#45;quote">"executeSearch"</span>
    &#125;
    executeSearch &#123;
        action &#123;
            &#91;results:searchService.executeSearch(params.q)&#93;
        &#125;
        on(<span class="java&#45;quote">"success"</span>).to <span class="java&#45;quote">"displayResults"</span>
        on(<span class="java&#45;quote">"error"</span>).to <span class="java&#45;quote">"displaySearchForm"</span>
    &#125;
    displayResults &#123;
        on(<span class="java&#45;quote">"searchDeeper"</span>).to <span class="java&#45;quote">"extendedSearch"</span>
        on(<span class="java&#45;quote">"searchAgain"</span>).to <span class="java&#45;quote">"displaySearchForm"</span>
    &#125;
    extendedSearch &#123;
        // Extended search subflow
        subflow(controller: <span class="java&#45;quote">"searchExtensions"</span>, action: <span class="java&#45;quote">"extendedSearch"</span>)
        on(<span class="java&#45;quote">"moreResults"</span>).to <span class="java&#45;quote">"displayMoreResults"</span>
        on(<span class="java&#45;quote">"noResults"</span>).to <span class="java&#45;quote">"displayNoMoreResults"</span>
    &#125;
    displayMoreResults()
    displayNoMoreResults()
&#125;</pre></div><p class="paragraph"/>It references a subflow in the <code>extendedSearch</code> state. The controller parameter is optional if the subflow is defined in the same controller as the calling flow.
<blockquote class="note">
Prior to 1.3.5, the previous subflow call would look like <code>subflow(extendedSearchFlow)</code>, with the requirement that the name of the subflow state be the same as the called subflow (minus <code>Flow</code>). This way of calling a subflow is deprecated and only supported for backward compatibility.
</blockquote><p class="paragraph"/>The subflow is another flow entirely:<p class="paragraph"/><div class="code"><pre>def extendedSearchFlow = &#123;
    startExtendedSearch &#123;
        on(<span class="java&#45;quote">"findMore"</span>).to <span class="java&#45;quote">"searchMore"</span>
        on(<span class="java&#45;quote">"searchAgain"</span>).to <span class="java&#45;quote">"noResults"</span>
    &#125;
    searchMore &#123;
        action &#123;
           def results = searchService.deepSearch(ctx.conversation.query)
           <span class="java&#45;keyword">if</span> (!results) <span class="java&#45;keyword">return</span> error()
           conversation.extendedResults = results
        &#125;
        on(<span class="java&#45;quote">"success"</span>).to <span class="java&#45;quote">"moreResults"</span>
        on(<span class="java&#45;quote">"error"</span>).to <span class="java&#45;quote">"noResults"</span>
    &#125;
    moreResults()
    noResults()
&#125;</pre></div><p class="paragraph"/>Notice how it places the <code>extendedResults</code> in conversation scope. This scope differs to flow scope as it lets you share state that spans the whole conversation not just the flow. Also notice that the end state (either <code>moreResults</code> or <code>noResults</code> of the subflow triggers the events in the main flow:<p class="paragraph"/><div class="code"><pre>extendedSearch &#123;
    // Extended search subflow
    subflow(controller: <span class="java&#45;quote">"searchExtensions"</span>, action: <span class="java&#45;quote">"extendedSearch"</span>)
    on(<span class="java&#45;quote">"moreResults"</span>).to <span class="java&#45;quote">"displayMoreResults"</span>
    on(<span class="java&#45;quote">"noResults"</span>).to <span class="java&#45;quote">"displayNoMoreResults"</span>
&#125;</pre></div>


<a name="6.6 Filters"><!-- Legacy link --></a>
<h2 id="filters">6.6 过滤器</h2>
<div class="hidden-block">
Although Grails <a href="../guide/single.html#controllers" class="guide">controllers</a> support fine grained interceptors, these are only really useful when applied to a few controllers and become difficult to manage with larger applications. Filters on the other hand can be applied across a whole group of controllers, a URI space or to a specific action. Filters are far easier to plugin and maintain completely separately to your main controller logic and are useful for all sorts of cross cutting concerns such as security, logging, and so on.
</div><p class="paragraph"/>虽然，Grails的<a href="../guide/single.html#controllers" class="guide">控制器</a>支持良好的细粒度拦截器，但它们只是对少数控制器有用，当处理大型应用时就会变得很困难。另一方面，过滤器能横跨整组控制器,一个URI空间或者一种具体的操作。相比插件来说，过滤器更容易、更彻底地维护分离你控制器的主要逻辑，也非常有利于像安全，日志等等这样的横切关注点。


<a name="6.6.1 Applying Filters"><!-- Legacy link --></a>
<h2 id="applyingFilters">6.6.1 应用过滤器</h2>
<div class="hidden-block">
To create a filter create a class that ends with the convention <code>Filters</code> in the <code>grails-app/conf</code> directory. Within this class define a code block called <code>filters</code> that contains the filter definitions:<p class="paragraph"/><div class="code"><pre>class ExampleFilters &#123;
   def filters = &#123;
        // your filters here
   &#125;
&#125;</pre></div><p class="paragraph"/>Each filter you define within the <code>filters</code> block has a name and a scope. The name is the method name and the scope is defined using named arguments. For example to define a filter that applies to all controllers and all actions you can use wildcards:<p class="paragraph"/><div class="code"><pre>sampleFilter(controller:'&#42;', action:'&#42;') &#123;
  // interceptor definitions
&#125;</pre></div><p class="paragraph"/>The scope of the filter can be one of the following things:
<ul class="star">
<li>A controller and/or action name pairing with optional wildcards</li>
<li>A URI, with Ant path matching syntax</li>
</ul><p class="paragraph"/>Filter rule attributes:
<ul class="star">
<li><code>controller</code> - controller matching pattern, by default &#42; is replaced with .&#42; and a regex is compiled</li>
<li><code>controllerExclude</code> - controller exclusion pattern, by default &#42; is replaced with .&#42; and a regex is compiled</li>
<li><code>action</code> - action matching pattern, by default &#42; is replaced with .&#42; and a regex is compiled</li>
<li><code>actionExclude</code> - action exclusion pattern, by default &#42; is replaced with .&#42; and a regex is compiled</li>
<li><code>regex</code> (<code>true</code>/<code>false</code>) - use regex syntax (don't replace '&#42;' with '.&#42;')</li>
<li><code>uri</code> - a uri to match, expressed with as Ant style path (e.g. /book/&#42;&#42;)</li>
<li><code>uriExclude</code> - a uri pattern to exclude, expressed with as Ant style path (e.g. /book/&#42;&#42;)</li>
<li><code>find</code> (<code>true</code>/<code>false</code>) - rule matches with partial match (see <code>java.util.regex.Matcher.find()</code>)</li>
<li><code>invert</code> (<code>true</code>/<code>false</code>) - invert the rule (NOT rule)</li>
</ul><p class="paragraph"/>Some examples of filters include:
<ul class="star">
<li>All controllers and actions</li>
</ul><p class="paragraph"/><div class="code"><pre>all(controller: '&#42;', action: '&#42;') &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>Only for the <code>BookController</code></li>
</ul><p class="paragraph"/><div class="code"><pre>justBook(controller: 'book', action: '&#42;') &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>All controllers except the <code>BookController</code></li>
</ul><p class="paragraph"/><div class="code"><pre>notBook(controller: 'book', invert: <span class="java&#45;keyword">true</span>) &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>All actions containing 'save' in the action name</li>
</ul><p class="paragraph"/><div class="code"><pre>saveInActionName(action: '&#42;save&#42;', find: <span class="java&#45;keyword">true</span>) &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>All actions starting with the letter 'b' except for actions beginning with the phrase 'bad*'</li>
</ul><p class="paragraph"/><div class="code"><pre>actionBeginningWithBButNotBad(action: 'b&#42;', actionExclude: 'bad&#42;', find: <span class="java&#45;keyword">true</span>) &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>Applied to a URI space</li>
</ul><p class="paragraph"/><div class="code"><pre>someURIs(uri: '/book/&#42;&#42;') &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>Applied to all URIs</li>
</ul><p class="paragraph"/><div class="code"><pre>allURIs(uri: '/&#42;&#42;') &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>In addition, the order in which you define the filters within the <code>filters</code> code block dictates the order in which they are executed.  To control the order of execution between <code>Filters</code> classes, you can use the <code>dependsOn</code> property discussed in <a href="../guide/single.html#filterDependencies" class="guide">filter dependencies</a> section.<p class="paragraph"/><blockquote class="note">
Note: When exclude patterns are used they take precedence over the matching patterns.  For example, if action is 'b&#42;' and actionExclude is 'bad&#42;' then actions like 'best' and 'bien' will have that filter applied but actions like 'bad' and 'badlands' will not.
</blockquote>
</div><p class="paragraph"/>要创建一个过滤器，只需要在<code>grails-app/conf</code>目录下创建一个符合规约以<code>Filters</code>结尾的类即可。在此类中，定义一个名为<code>filters</code>的代码块，用以包含过滤器的定义：<p class="paragraph"/><div class="code"><pre>class ExampleFilters &#123;
   def filters = &#123;
        // your filters here
   &#125;
&#125;</pre></div><p class="paragraph"/><code>filters</code>代码块内的每一个过滤器有一个名称和作用域。名称就是其方法名，作用域是通过命名参数定义的。比如，要定义一个应用于所有控制器和操作的过滤器，你可以使用通配符：<p class="paragraph"/><div class="code"><pre>sampleFilter(controller:'&#42;', action:'&#42;') &#123;
  // interceptor definitions
&#125;</pre></div><p class="paragraph"/>过滤器的作用域可以是如下内容：
<ul class="star">
<li>一个控制器或者操作名称，支持可选的通配符</li>
<li>一个URI，符合Ant路径（path）匹配语法</li>
</ul><p class="paragraph"/>过滤器的常规属性如下：
<ul class="star">
<li><code>controller</code> - 控制器匹配模式，缺省情况下，其用&#42;可以替代.&#42;，并且被编译为一个正则表达式</li>
<li><code>controllerExclude</code> - 控制器的排除模式，缺省情况下，其用&#42;可以替代.&#42;，并且被编译为一个正则表达式</li>
<li><code>action</code> - 操作匹配模式，缺省情况下，其用&#42;可以替代.&#42;，并且被编译为一个正则表达式</li>
<li><code>actionExclude</code> - 操作排除模式，缺省情况下，其用&#42;可以替代.&#42;，并且被编译为一个正则表达式</li>
<li><code>regex</code> (<code>true</code>/<code>false</code>) - 使用正则表达式语法（不使用'&#42;'代替'.&#42;'）</li>
<li><code>uri</code> - 一个uri匹配，使用Ant风格的路径（path）（比如 /book/&#42;&#42;）</li>
<li><code>uriExclude</code> - 一个uri排除匹配，使用Ant风格的路径（path）（比如 /book/&#42;&#42;）</li>
<li><code>find</code> (<code>true</code>/<code>false</code>) - 符合部分匹配的规则匹配（更多请参考<code>java.util.regex.Matcher.find()</code>）</li>
<li><code>invert</code> (<code>true</code>/<code>false</code>) - 反转规则（不符合此规则的条件）</li>
</ul><p class="paragraph"/>一些过滤器的示例如下：
<ul class="star">
<li>匹配所有的控制器和操作</li>
</ul><p class="paragraph"/><div class="code"><pre>all(controller: '&#42;', action: '&#42;') &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>仅仅匹配<code>BookController</code></li>
</ul><p class="paragraph"/><div class="code"><pre>justBook(controller: 'book', action: '&#42;') &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>匹配所有的控制器，除了<code>BookController</code></li>
</ul><p class="paragraph"/><div class="code"><pre>notBook(controller: 'book', invert: <span class="java&#45;keyword">true</span>) &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>匹配所有操作名包含'save'的操作</li>
</ul><p class="paragraph"/><div class="code"><pre>saveInActionName(action: '&#42;save&#42;', find: <span class="java&#45;keyword">true</span>) &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>匹配所有操作字母以'b'开头的操作，不过'bad*'除外</li>
</ul><p class="paragraph"/><div class="code"><pre>actionBeginningWithBButNotBad(action: 'b&#42;', actionExclude: 'bad&#42;', find: <span class="java&#45;keyword">true</span>) &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>应用于一个URI</li>
</ul><p class="paragraph"/><div class="code"><pre>someURIs(uri: '/book/&#42;&#42;') &#123;<p class="paragraph"/>&#125;</pre></div>
<ul class="star">
<li>应用于所有的URIs</li>
</ul><p class="paragraph"/><div class="code"><pre>allURIs(uri: '/&#42;&#42;') &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>此外，你在<code>filters</code>代码块中定义的过滤器顺序就是它们被执行的顺序。要控制<code>Filters</code>类之间的执行顺序，你可以使用<code>dependsOn</code>属性，更多信息将在<a href="../guide/single.html#filterDependencies" class="guide">过滤器的依赖</a>章节讨论。<p class="paragraph"/><blockquote class="note">
注意：当使用排除模式的时候，其优先级将高于其他的匹配模式。比如一个作用域，其action是'b&#42;'而actionExclude是'bad&#42;'，那么操作名称是'best'和'bien'将应用于此过滤器，而操作名是'bad'和'badlands'却没有。
</blockquote>


<a name="6.6.2 Filter Types"><!-- Legacy link --></a>
<h2 id="filterTypes">6.6.2 过滤器的类型</h2>
<div class="hidden-block">
Within the body of the filter you can then define one or several of the following interceptor types for the filter:
<ul class="star">
<li><code>before</code> - Executed before the action. Return <code>false</code> to indicate that the response has been handled that that all future filters and the action should not execute</li>
<li><code>after</code> - Executed after an action. Takes a first argument as the view model to allow modification of the model before rendering the view</li>
<li><code>afterView</code> - Executed after view rendering.  Takes an Exception as an argument which will be non-<code>null</code> if an exception occurs during processing. Note: this Closure is called before the layout is applied.</li>
</ul><p class="paragraph"/>For example to fulfill the common simplistic authentication use case you could define a filter as follows:<p class="paragraph"/><div class="code"><pre>class SecurityFilters &#123;
   def filters = &#123;
       loginCheck(controller: '&#42;', action: '&#42;') &#123;
           before = &#123;
              <span class="java&#45;keyword">if</span> (!session.user &#38;&#38; !actionName.equals('login')) &#123;
                  redirect(action: 'login')
                  <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
               &#125;
           &#125;
       &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>Here the <code>loginCheck</code> filter uses a <code>before</code> interceptor to execute a block of code that checks if a user is in the session and if not redirects to the login action. Note how returning false ensure that the action itself is not executed.<p class="paragraph"/>Here's a more involved example that demonstrates all three filter types:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> java.util.concurrent.atomic.AtomicLong<p class="paragraph"/>class LoggingFilters &#123;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> AtomicLong REQUEST_NUMBER_COUNTER = <span class="java&#45;keyword">new</span> AtomicLong()
   <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> START_TIME_ATTRIBUTE = 'Controller__START_TIME__'
   <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> REQUEST_NUMBER_ATTRIBUTE = 'Controller__REQUEST_NUMBER__'<p class="paragraph"/>   def filters = &#123;<p class="paragraph"/>      logFilter(controller: '&#42;', action: '&#42;') &#123;<p class="paragraph"/>         before = &#123;
            <span class="java&#45;keyword">if</span> (!log.debugEnabled) <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span><p class="paragraph"/>            <span class="java&#45;object">long</span> start = <span class="java&#45;object">System</span>.currentTimeMillis()
            <span class="java&#45;object">long</span> currentRequestNumber = REQUEST_NUMBER_COUNTER.incrementAndGet()<p class="paragraph"/>            request&#91;START_TIME_ATTRIBUTE&#93; = start
            request&#91;REQUEST_NUMBER_ATTRIBUTE&#93; = currentRequestNumber<p class="paragraph"/>            log.debug <span class="java&#45;quote">"preHandle request &#35;&#36;currentRequestNumber : "</span> +
               <span class="java&#45;quote">"'&#36;request.servletPath'/'&#36;request.forwardURI', "</span> +
               <span class="java&#45;quote">"from &#36;request.remoteHost (&#36;request.remoteAddr) "</span> +
               <span class="java&#45;quote">" at &#36;&#123;<span class="java&#45;keyword">new</span> Date()&#125;, Ajax: &#36;request.xhr, controller: &#36;controllerName, "</span> +
               <span class="java&#45;quote">"action: &#36;actionName, params: &#36;&#123;<span class="java&#45;keyword">new</span> TreeMap(params)&#125;"</span><p class="paragraph"/>            <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span>
         &#125;<p class="paragraph"/>         after = &#123; Map model &#45;&#62;<p class="paragraph"/>            <span class="java&#45;keyword">if</span> (!log.debugEnabled) <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span><p class="paragraph"/>            <span class="java&#45;object">long</span> start = request&#91;START_TIME_ATTRIBUTE&#93;
            <span class="java&#45;object">long</span> end = <span class="java&#45;object">System</span>.currentTimeMillis()
            <span class="java&#45;object">long</span> requestNumber = request&#91;REQUEST_NUMBER_ATTRIBUTE&#93;<p class="paragraph"/>            def msg = <span class="java&#45;quote">"postHandle request &#35;&#36;requestNumber: end &#36;&#123;<span class="java&#45;keyword">new</span> Date()&#125;, "</span> +
                      <span class="java&#45;quote">"controller total time &#36;&#123;end &#45; start&#125;ms"</span>
            <span class="java&#45;keyword">if</span> (log.traceEnabled) &#123;
            	log.trace msg + <span class="java&#45;quote">"; model: &#36;model"</span>
            &#125;
            <span class="java&#45;keyword">else</span> &#123;
            	log.debug msg
            &#125;
         &#125;<p class="paragraph"/>         afterView = &#123; Exception e &#45;&#62;<p class="paragraph"/>            <span class="java&#45;keyword">if</span> (!log.debugEnabled) <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span><p class="paragraph"/>            <span class="java&#45;object">long</span> start = request&#91;START_TIME_ATTRIBUTE&#93;
            <span class="java&#45;object">long</span> end = <span class="java&#45;object">System</span>.currentTimeMillis()
            <span class="java&#45;object">long</span> requestNumber = request&#91;REQUEST_NUMBER_ATTRIBUTE&#93;<p class="paragraph"/>            def msg = <span class="java&#45;quote">"afterCompletion request &#35;&#36;requestNumber: "</span> +
                      <span class="java&#45;quote">"end &#36;&#123;<span class="java&#45;keyword">new</span> Date()&#125;, total time &#36;&#123;end &#45; start&#125;ms"</span>
            <span class="java&#45;keyword">if</span> (e) &#123;
               log.debug <span class="java&#45;quote">"&#36;msg &#92;n&#92;texception: &#36;e.message"</span>, e
            &#125;
            <span class="java&#45;keyword">else</span> &#123;
               log.debug msg
            &#125;
         &#125;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>In this logging example we just log various request information, but note that the <code>model</code> map in the <code>after</code> filter is mutable. If you need to add or remove items from the model map you can do that in the <code>after</code> filter.
</div><p class="paragraph"/>在过滤器的主体内，你可以定义下列过滤器中拦截器类型的一个或者几个：
<ul class="star">
<li><code>before</code> - 在操作之前执行。返回值<code>false</code>表示响应已经被符合条件的过滤器处理过，并且其操作不被执行</li>
<li><code>after</code> - 在操作之后执行。其第一个参数为视图模型（view model），并且允许在渲染视图之前修改此模型</li>
<li><code>afterView</code> - 在渲染视图之后执行。如果有异常发生，其第一个参数为一个非<code>null</code>的异常。注意：此闭包在应用布局以前被调用。</li>
</ul><p class="paragraph"/>比如，要执行一个通用简单的验证，你可以定义如下所示的过滤器：<p class="paragraph"/><div class="code"><pre>class SecurityFilters &#123;
   def filters = &#123;
       loginCheck(controller: '&#42;', action: '&#42;') &#123;
           before = &#123;
              <span class="java&#45;keyword">if</span> (!session.user &#38;&#38; !actionName.equals('login')) &#123;
                  redirect(action: 'login')
                  <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
               &#125;
           &#125;
       &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>此处的<code>loginCheck</code>过滤器使用了<code>before</code>拦截器来执行一个代码块，用以检查一个用户是否在会话当中，如果不在，就重定向到login操作。注意：如何通过返回false的方式来确保操作本身不被执行。<p class="paragraph"/>下面是一个更深入的示例来演示所有的三种过滤器类型：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> java.util.concurrent.atomic.AtomicLong<p class="paragraph"/>class LoggingFilters &#123;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> AtomicLong REQUEST_NUMBER_COUNTER = <span class="java&#45;keyword">new</span> AtomicLong()
   <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> START_TIME_ATTRIBUTE = 'Controller__START_TIME__'
   <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> REQUEST_NUMBER_ATTRIBUTE = 'Controller__REQUEST_NUMBER__'<p class="paragraph"/>   def filters = &#123;<p class="paragraph"/>      logFilter(controller: '&#42;', action: '&#42;') &#123;<p class="paragraph"/>         before = &#123;
            <span class="java&#45;keyword">if</span> (!log.debugEnabled) <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span><p class="paragraph"/>            <span class="java&#45;object">long</span> start = <span class="java&#45;object">System</span>.currentTimeMillis()
            <span class="java&#45;object">long</span> currentRequestNumber = REQUEST_NUMBER_COUNTER.incrementAndGet()<p class="paragraph"/>            request&#91;START_TIME_ATTRIBUTE&#93; = start
            request&#91;REQUEST_NUMBER_ATTRIBUTE&#93; = currentRequestNumber<p class="paragraph"/>            log.debug <span class="java&#45;quote">"preHandle request &#35;&#36;currentRequestNumber : "</span> +
               <span class="java&#45;quote">"'&#36;request.servletPath'/'&#36;request.forwardURI', "</span> +
               <span class="java&#45;quote">"from &#36;request.remoteHost (&#36;request.remoteAddr) "</span> +
               <span class="java&#45;quote">" at &#36;&#123;<span class="java&#45;keyword">new</span> Date()&#125;, Ajax: &#36;request.xhr, controller: &#36;controllerName, "</span> +
               <span class="java&#45;quote">"action: &#36;actionName, params: &#36;&#123;<span class="java&#45;keyword">new</span> TreeMap(params)&#125;"</span><p class="paragraph"/>            <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span>
         &#125;<p class="paragraph"/>         after = &#123; Map model &#45;&#62;<p class="paragraph"/>            <span class="java&#45;keyword">if</span> (!log.debugEnabled) <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span><p class="paragraph"/>            <span class="java&#45;object">long</span> start = request&#91;START_TIME_ATTRIBUTE&#93;
            <span class="java&#45;object">long</span> end = <span class="java&#45;object">System</span>.currentTimeMillis()
            <span class="java&#45;object">long</span> requestNumber = request&#91;REQUEST_NUMBER_ATTRIBUTE&#93;<p class="paragraph"/>            def msg = <span class="java&#45;quote">"postHandle request &#35;&#36;requestNumber: end &#36;&#123;<span class="java&#45;keyword">new</span> Date()&#125;, "</span> +
                      <span class="java&#45;quote">"controller total time &#36;&#123;end &#45; start&#125;ms"</span>
            <span class="java&#45;keyword">if</span> (log.traceEnabled) &#123;
            	log.trace msg + <span class="java&#45;quote">"; model: &#36;model"</span>
            &#125;
            <span class="java&#45;keyword">else</span> &#123;
            	log.debug msg
            &#125;
         &#125;<p class="paragraph"/>         afterView = &#123; Exception e &#45;&#62;<p class="paragraph"/>            <span class="java&#45;keyword">if</span> (!log.debugEnabled) <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span><p class="paragraph"/>            <span class="java&#45;object">long</span> start = request&#91;START_TIME_ATTRIBUTE&#93;
            <span class="java&#45;object">long</span> end = <span class="java&#45;object">System</span>.currentTimeMillis()
            <span class="java&#45;object">long</span> requestNumber = request&#91;REQUEST_NUMBER_ATTRIBUTE&#93;<p class="paragraph"/>            def msg = <span class="java&#45;quote">"afterCompletion request &#35;&#36;requestNumber: "</span> +
                      <span class="java&#45;quote">"end &#36;&#123;<span class="java&#45;keyword">new</span> Date()&#125;, total time &#36;&#123;end &#45; start&#125;ms"</span>
            <span class="java&#45;keyword">if</span> (e) &#123;
               log.debug <span class="java&#45;quote">"&#36;msg &#92;n&#92;texception: &#36;e.message"</span>, e
            &#125;
            <span class="java&#45;keyword">else</span> &#123;
               log.debug msg
            &#125;
         &#125;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>在这个日志示例中，我们只记录不同请求的信息，但要注意到<code>after</code>过滤器中的<code>model</code>是可变的。如果你需要增加或者移除model的内容，可以在<code>after</code>过滤器中实现。



<h2 id="filterVariablesAndScopes">6.6.3 变量和作用域</h2>
<div class="hidden-block">
Filters support all the common properties available to <a href="../guide/single.html#controllers" class="guide">controllers</a> and <a href="../guide/single.html#taglibs" class="guide">tag libraries</a>, plus the application context:
<ul class="star">
<li><a href="../ref/Controllers/request.html" class="controllers">request</a> - The HttpServletRequest object</li>
<li><a href="../ref/Controllers/response.html" class="controllers">response</a> - The HttpServletResponse object</li>
<li><a href="../ref/Controllers/session.html" class="controllers">session</a> - The HttpSession object</li>
<li><a href="../ref/Controllers/servletContext.html" class="controllers">servletContext</a> - The ServletContext object</li>
<li><a href="../ref/Controllers/flash.html" class="controllers">flash</a> - The flash object</li>
<li><a href="../ref/Controllers/params.html" class="controllers">params</a> - The request parameters object</li>
<li><a href="../ref/Controllers/actionName.html" class="controllers">actionName</a> - The action name that is being dispatched to</li>
<li><a href="../ref/Controllers/controllerName.html" class="controllers">controllerName</a> - The controller name that is being dispatched to</li>
<li><a href="../ref/Controllers/grailsApplication.html" class="controllers">grailsApplication</a> - The Grails application currently running</li>
<li><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">applicationContext</a> - The ApplicationContext object</li>
</ul><p class="paragraph"/>However, filters only support a subset of the methods available to controllers and tag libraries. These include:
<ul class="star">
<li><a href="../ref/Controllers/redirect.html" class="controllers">redirect</a> - For redirects to other controllers and actions</li>
<li><a href="../ref/Controllers/render.html" class="controllers">render</a> - For rendering custom responses</li>
</ul><p class="paragraph"/></div><p class="paragraph"/>过滤器支持<a href="../guide/single.html#controllers" class="guide">控制器</a>和<a href="../guide/single.html#taglibs" class="guide">标签库</a>的所有公共属性，外加应用环境上下文（application context）：
<ul class="star">
<li><a href="../ref/Controllers/request.html" class="controllers">request</a> - HttpServletRequest对象</li>
<li><a href="../ref/Controllers/response.html" class="controllers">response</a> - HttpServletResponse对象</li>
<li><a href="../ref/Controllers/session.html" class="controllers">session</a> - HttpSession对象</li>
<li><a href="../ref/Controllers/servletContext.html" class="controllers">servletContext</a> - ServletContext对象</li>
<li><a href="../ref/Controllers/flash.html" class="controllers">flash</a> - flash对象</li>
<li><a href="../ref/Controllers/params.html" class="controllers">params</a> - 请求参数对象</li>
<li><a href="../ref/Controllers/actionName.html" class="controllers">actionName</a> - 正在使用的操作名称</li>
<li><a href="../ref/Controllers/controllerName.html" class="controllers">controllerName</a> - 正在使用的控制器名称</li>
<li><a href="../ref/Controllers/grailsApplication.html" class="controllers">grailsApplication</a> - 当前正在运行的Grails应用</li>
<li><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">applicationContext</a> - ApplicationContext对象</li>
</ul><p class="paragraph"/>尽管支持如此多的属性，但是过滤器所支持的方法仅仅是控制器和标签库的一个子集,它们是：
<ul class="star">
<li><a href="../ref/Controllers/redirect.html" class="controllers">redirect</a> - 用于重定向到其他的控制器和操作</li>
<li><a href="../ref/Controllers/render.html" class="controllers">render</a> - 用于渲染自定义的响应</li>
</ul><p class="paragraph"/>

<a name="6.6.4 Filter Dependencies"><!-- Legacy link --></a>
<h2 id="filterDependencies">6.6.4 过滤器依赖</h2>
<div class="hidden-block">
In a <code>Filters</code> class, you can specify any other <code>Filters</code> classes that should first be executed using the <code>dependsOn</code> property. This is used when a <code>Filters</code> class depends on the behavior of another <code>Filters</code> class (e.g. setting up the environment, modifying the request/session, etc.) and is defined as an array of <code>Filters</code> classes.<p class="paragraph"/>Take the following example <code>Filters</code> classes:<p class="paragraph"/><div class="code"><pre>class MyFilters &#123;
    def dependsOn = &#91;MyOtherFilters&#93;<p class="paragraph"/>    def filters = &#123;
        checkAwesome(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                <span class="java&#45;keyword">if</span> (request.isAwesome) &#123; // <span class="java&#45;keyword">do</span> something awesome &#125;
            &#125;
        &#125;<p class="paragraph"/>        checkAwesome2(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                <span class="java&#45;keyword">if</span> (request.isAwesome) &#123; // <span class="java&#45;keyword">do</span> something <span class="java&#45;keyword">else</span> awesome &#125;
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class MyOtherFilters &#123;
    def filters = &#123;
        makeAwesome(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                request.isAwesome = <span class="java&#45;keyword">true</span>
            &#125;
        &#125;
        doNothing(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                // <span class="java&#45;keyword">do</span> nothing
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>MyFilters specifically <code>dependsOn</code> MyOtherFilters.  This will cause all the filters in MyOtherFilters whose scope matches the current request to be executed before those in MyFilters. For a request of "/test", which will match the scope of every filter in the example, the execution order would be as follows:
<ul class="star">
<li>MyOtherFilters - makeAwesome</li>
<li>MyOtherFilters - doNothing</li>
<li>MyFilters - checkAwesome</li>
<li>MyFilters - checkAwesome2</li>
</ul><p class="paragraph"/>The filters within the MyOtherFilters class are processed in order first, followed by the filters in the MyFilters class.  Execution order between <code>Filters</code> classes are enabled and the execution order of filters within each <code>Filters</code> class are preserved.<p class="paragraph"/>If any cyclical dependencies are detected, the filters with cyclical dependencies will be added to the end of the filter chain and processing will continue.  Information about any cyclical dependencies that are detected will be written to the logs.  Ensure that your root logging level is set to at least WARN or configure an appender for the Grails Filters Plugin (<code>org.codehaus.groovy.grails.plugins.web.filters.FiltersGrailsPlugin</code>) when debugging filter dependency issues.
</div><p class="paragraph"/>在一个<code>Filters</code>类中，你可以使用<code>dependsOn</code>属性来指定其他任意<code>Filters</code>类先被执行。这经常用在一个<code>Filters</code>类依赖于另外一个<code>Filters</code>类的行为的时候（比如，设置环境，修改请求／会话等），并且可以定义为一个<code>Filters</code>类的数组。<p class="paragraph"/>以如下所示的<code>Filters</code>类为例：<p class="paragraph"/><div class="code"><pre>class MyFilters &#123;
    def dependsOn = &#91;MyOtherFilters&#93;<p class="paragraph"/>    def filters = &#123;
        checkAwesome(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                <span class="java&#45;keyword">if</span> (request.isAwesome) &#123; // <span class="java&#45;keyword">do</span> something awesome &#125;
            &#125;
        &#125;<p class="paragraph"/>        checkAwesome2(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                <span class="java&#45;keyword">if</span> (request.isAwesome) &#123; // <span class="java&#45;keyword">do</span> something <span class="java&#45;keyword">else</span> awesome &#125;
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class MyOtherFilters &#123;
    def filters = &#123;
        makeAwesome(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                request.isAwesome = <span class="java&#45;keyword">true</span>
            &#125;
        &#125;
        doNothing(uri: <span class="java&#45;quote">"/&#42;"</span>) &#123;
            before = &#123;
                // <span class="java&#45;keyword">do</span> nothing
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>MyFilters指定<code>dependsOn</code>为MyOtherFilters。这将导致MyOtherFilters中符合当前请求的所有过滤器优先于MyFilters执行。对一个"/test"请求来说，示例中的每一个过滤器都会匹配到，那么其执行的顺序将如下所示：
<ul class="star">
<li>MyOtherFilters - makeAwesome</li>
<li>MyOtherFilters - doNothing</li>
<li>MyFilters - checkAwesome</li>
<li>MyFilters - checkAwesome2</li>
</ul><p class="paragraph"/>MyOtherFilters类的过滤器首先被处理，接着才是MyFilters的过滤器。<code>Filters</code>类之间的执行顺序是定制的，并且每个<code>Filters</code>类内的过滤器顺序是预置的。<p class="paragraph"/>如果任何循环依赖被检测到的话，那么循环依赖的过滤器将被加到过滤器链最后，并且处理将继续进行。任何循环依赖的信息将被记录到日志当中，不过在调试过滤器依赖问题的时候，要确保你的根日志级别至少是WARN或者为Grails的过滤器插件（<code>org.codehaus.groovy.grails.plugins.web.filters.FiltersGrailsPlugin</code>）配置一个输出器。


<a name="6.7 Ajax"><!-- Legacy link --></a>
<h2 id="ajax">6.7 Ajax</h2>
<div class="hidden-block">
Ajax is the driving force behind the shift to richer web applications. These types of applications in general are better suited to agile, dynamic frameworks written in languages like <a href="http://groovy.codehaus.org" target="blank">Groovy</a> and <a href="http://www.ruby-lang.org/." target="blank">Ruby</a> Grails provides support for building Ajax applications through its Ajax tag library. For a full list of these see the Tag Library Reference.
</div><p class="paragraph"/>Ajax是更丰富WEB应用背后的驱动力，这些应该通常都是使用敏捷的，动态的语言来完成的，比如 <a href="http://groovy.codehaus.org" target="blank">Groovy</a> 和 <a href="http://www.ruby-lang.org/" target="blank">Ruby</a> 。 Grails是通过其Ajax标签库来构建Ajax应用的，更完整的列表请参考标签库索引。


<a name="6.7.1 Ajax Support"><!-- Legacy link --></a>
<h2 id="ajaxSupport">6.7.1 Ajax支持</h2>
<div class="hidden-block">
By default Grails ships with the <a href="http://jquery.com/" target="blank">jQuery</a> library, but through the <a href="../guide/single.html#plugins" class="guide">Plugin system</a> provides support for other frameworks such as <a href="http://www.prototypejs.org/" target="blank">Prototype</a>, <a href="Dojo:http://dojotoolkit.org/" target="blank"></a>, <a href="Yahoo UI:http://developer.yahoo.com/yui/" target="blank"></a> and the <a href="http://code.google.com/webtoolkit/" target="blank">Google Web Toolkit</a>.<p class="paragraph"/>This section covers Grails' support for Ajax in general. To get started, add this line to the <code>&#60;head&#62;</code> tag of your page:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"jquery"</span> /&#62;</span></pre></div><p class="paragraph"/>You can replace <code>jQuery</code> with any other library supplied by a plugin you have installed. This works because of Grails' support for adaptive tag libraries. Thanks to Grails' plugin system there is support for a number of different Ajax libraries including (but not limited to):
<ul class="star">
<li>jQuery</li>
<li>Prototype</li>
<li>Dojo</li>
<li>YUI</li>
<li>MooTools</li>
</ul><p class="paragraph"/></div><p class="paragraph"/>缺省情况下，Grails采用的是 <a href="http://jquery.com/" target="blank">jQuery</a> 框架，但是通过其<a href="../guide/single.html#plugins" class="guide">插件系统</a>也提供了对其他框架的支持，比如<a href="http://www.prototypejs.org/" target="blank">Prototype</a>、 <a href="Dojo:http://dojotoolkit.org/" target="blank"></a>、<a href="Yahoo UI:http://developer.yahoo.com/yui/" target="blank"></a>和<a href="http://code.google.com/webtoolkit/" target="blank">Google Web Toolkit</a>。<p class="paragraph"/>本节将介绍Grails对Ajax的通用支持。在开始之前，请先在你页面的<code>&#60;head&#62;</code>标签部分增加如下内容：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"jquery"</span> /&#62;</span></pre></div><p class="paragraph"/>因为Grails支持可适配的标签库，所以你可以用已经安装的其他框架来提到当前的<code>jQuery</code>。这要感谢Grails的插件系统，有了它才能支持这么多不同的Ajax框架库，包括但不限于如下所提到的：
<ul class="star">
<li>jQuery</li>
<li>Prototype</li>
<li>Dojo</li>
<li>YUI</li>
<li>MooTools</li>
</ul><p class="paragraph"/>

<a name="6.7.1.1 Remoting Linking"><!-- Legacy link --></a>
<h2 id="remotingLinking">6.7.1.1 异步超链接</h2>
<div class="hidden-block">
Remote content can be loaded in a number of ways, the most commons way is through the <a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a> tag. This tag allows the creation of HTML anchor tags that perform an asynchronous request and optionally set the response in an element. The simplest way to create a remote link is as follows:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"delete"</span> id=<span class="xml&#45;quote">"1"</span>&#62;</span>Delete Book<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>The above link sends an asynchronous request to the <code>delete</code> action of the current controller with an id of <code>1</code>.
</div><p class="paragraph"/>远程内容可以使用多种方法载入，最常使用的方法是通过<a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a>标签。此标签将创建HTML的锚标记用以执行一个异步请求，并在一个元素中设置响应内容。最简单的创建一个远程连接的方法如下：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"delete"</span> id=<span class="xml&#45;quote">"1"</span>&#62;</span>Delete Book<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>上面的连接发送一个id为1的异步请求给当前控制器的<code>delete</code>操作。


<a name="6.7.1.2 Updating Content"><!-- Legacy link --></a>
<h2 id="updatingContent">6.7.1.2 更新内容</h2>
<div class="hidden-block">
This is great, but usually you provide feedback to the user about what happened:<p class="paragraph"/><div class="code"><pre>def delete() &#123;
    def b = Book.get(params.id)
    b.delete()
    render <span class="java&#45;quote">"Book $&#123;b.id&#125; was deleted"</span>
&#125;</pre></div><p class="paragraph"/>GSP code:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"message"</span>&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"delete"</span> id=<span class="xml&#45;quote">"1"</span> update=<span class="xml&#45;quote">"message"</span>&#62;</span>
Delete Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>The above example will call the action and set the contents of the <code>message</code> <code>div</code> to the response in this case <code>"Book 1 was deleted"</code>. This is done by the <code>update</code> attribute on the tag, which can also take a Map to indicate what should be updated on failure:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"message"</span>&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"error"</span>&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink update=<span class="xml&#45;quote">"&#91;success: 'message', failure: 'error'&#93;"</span>
              action=<span class="xml&#45;quote">"delete"</span> id=<span class="xml&#45;quote">"1"</span>&#62;</span>
Delete Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>Here the <code>error</code> div will be updated if the request failed.
</div><p class="paragraph"/>目前都还不错，但一般来说你会提供一些信息反馈给用户，以告诉都发生过什么，比如：<p class="paragraph"/><div class="code"><pre>def delete() &#123;
    def b = Book.get(params.id)
    b.delete()
    render <span class="java&#45;quote">"Book $&#123;b.id&#125; was deleted"</span>
&#125;</pre></div><p class="paragraph"/>GSP代码：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"message"</span>&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"delete"</span> id=<span class="xml&#45;quote">"1"</span> update=<span class="xml&#45;quote">"message"</span>&#62;</span>
Delete Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>上述示例将调用<code>delete</code>操作，并且将响应内容<code>"Book 1 was deleted"</code>设置到id为<code>message</code>的<code>div</code>中，这是通过标签中的<code>update</code>属性来完成的。此外还可以用Map参数来设定失败时要更新那些，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"message"</span>&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"error"</span>&#62;</span><span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink update=<span class="xml&#45;quote">"&#91;success: 'message', failure: 'error'&#93;"</span>
              action=<span class="xml&#45;quote">"delete"</span> id=<span class="xml&#45;quote">"1"</span>&#62;</span>
Delete Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>如果请求失败，那么此处的<code>error</code>将会被更新。


<a name="6.7.1.3 Remote Form Submission"><!-- Legacy link --></a>
<h2 id="remoteFormSubmission">6.7.1.3 异步Form提交</h2>
<div class="hidden-block">
An HTML form can also be submitted asynchronously in one of two ways. Firstly using the <a href="../ref/Tags/formRemote.html" class="tags">formRemote</a> tag which expects similar attributes to those for the <a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:formRemote url=<span class="xml&#45;quote">"&#91;controller: 'book', action: 'delete'&#93;"</span>
              update=<span class="xml&#45;quote">"&#91;success: 'message', failure: 'error'&#93;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"hidden"</span> name=<span class="xml&#45;quote">"id"</span> value=<span class="xml&#45;quote">"1"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"submit"</span> value=<span class="xml&#45;quote">"Delete Book!"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/g:formRemote &#62;</span></pre></div><p class="paragraph"/>Or alternatively you can use the <a href="../ref/Tags/submitToRemote.html" class="tags">submitToRemote</a> tag to create a submit button. This allows some buttons to submit remotely and some not depending on the action:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;form action=<span class="xml&#45;quote">"delete"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"hidden"</span> name=<span class="xml&#45;quote">"id"</span> value=<span class="xml&#45;quote">"1"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;g:submitToRemote action=<span class="xml&#45;quote">"delete"</span>
                      update=<span class="xml&#45;quote">"&#91;success: 'message', failure: 'error'&#93;"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/form&#62;</span></pre></div>
</div><p class="paragraph"/>HTML的表单可以通过以下两种方式的一种进行异步提交。其一，使用<a href="../ref/Tags/formRemote.html" class="tags">formRemote</a>标签，它的属性跟<a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a>标签类似，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:formRemote url=<span class="xml&#45;quote">"&#91;controller: 'book', action: 'delete'&#93;"</span>
              update=<span class="xml&#45;quote">"&#91;success: 'message', failure: 'error'&#93;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"hidden"</span> name=<span class="xml&#45;quote">"id"</span> value=<span class="xml&#45;quote">"1"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"submit"</span> value=<span class="xml&#45;quote">"Delete Book!"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/g:formRemote &#62;</span></pre></div><p class="paragraph"/>另外一种是通过使用<a href="../ref/Tags/submitToRemote.html" class="tags">submitToRemote</a>标签来创建一个提交按钮。这将允许一些按钮执行远程提交，另外一些不需要：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;form action=<span class="xml&#45;quote">"delete"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"hidden"</span> name=<span class="xml&#45;quote">"id"</span> value=<span class="xml&#45;quote">"1"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;g:submitToRemote action=<span class="xml&#45;quote">"delete"</span>
                      update=<span class="xml&#45;quote">"&#91;success: 'message', failure: 'error'&#93;"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/form&#62;</span></pre></div>


<a name="6.7.1.4 Ajax Events"><!-- Legacy link --></a>
<h2 id="ajaxEvents">6.7.1.4 Ajax事件</h2>
<div class="hidden-block">
Specific JavaScript can be called if certain events occur, all the events start with the "on" prefix and let you give feedback to the user where appropriate, or take other action:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"show"</span>
              id=<span class="xml&#45;quote">"1"</span>
              update=<span class="xml&#45;quote">"success"</span>
              onLoading=<span class="xml&#45;quote">"showProgress()"</span>
              onComplete=<span class="xml&#45;quote">"hideProgress()"</span>&#62;</span>Show Book 1<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>The above code will execute the "showProgress()" function which may show a progress bar or whatever is appropriate. Other events include:
<ul class="star">
<li><code>onSuccess</code>  - The JavaScript function to call if successful</li>
<li><code>onFailure</code>  - The JavaScript function to call if the call failed</li>
<li><code>on_ERROR_CODE</code>  - The JavaScript function to call to handle specified error codes (eg on404="alert('not found!')")</li>
<li><code>onUninitialized</code>  - The JavaScript function to call the a Ajax engine failed to initialise</li>
<li><code>onLoading</code>  - The JavaScript function to call when the remote function is loading the response</li>
<li><code>onLoaded</code>  - The JavaScript function to call when the remote function is completed loading the response</li>
<li><code>onComplete</code>  - The JavaScript function to call when the remote function is complete, including any updates</li>
</ul><p class="paragraph"/>If you need a reference to the <code>XmlHttpRequest</code> object you can use the implicit event parameter <code>e</code> to obtain it:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript&#62;</span>
    function fireMe(e) &#123;
        alert(<span class="xml&#45;quote">"XmlHttpRequest = "</span> + e)
    &#125;
&#125;
<span class="xml&#45;tag">&#60;/g:javascript&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"example"</span>
              update=<span class="xml&#45;quote">"success"</span>
              onSuccess=<span class="xml&#45;quote">"fireMe(e)"</span>&#62;</span>Ajax Link<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div>
</div><p class="paragraph"/>当某个事件发生时，特定的JavaScript将会被调用到，所有这些事件都是以"on"为前缀，并且合适地反馈给用户或者其他处理，比如：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"show"</span>
              id=<span class="xml&#45;quote">"1"</span>
              update=<span class="xml&#45;quote">"success"</span>
              onLoading=<span class="xml&#45;quote">"showProgress()"</span>
              onComplete=<span class="xml&#45;quote">"hideProgress()"</span>&#62;</span>Show Book 1<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div><p class="paragraph"/>上述代码将会执行"showProgress()"函数用以显示一个进度条或者其他什么的。所有事件罗列如下：
<ul class="star">
<li><code>onSuccess</code>  - 成功时要调用的JavaScript函数</li>
<li><code>onFailure</code>  - 失败时要调用的JavaScript函数</li>
<li><code>on_ERROR_CODE</code>  - 处理特定的错误编码（比如on404="alert('not found!')"）时要调用的JavaScript函数</li>
<li><code>onUninitialized</code>  - Ajax引擎初始化失败时要调用的JavaScript函数</li>
<li><code>onLoading</code>  - 远程调用正在加载响应时要调用的JavaScript函数</li>
<li><code>onLoaded</code>  - 远程调用已经加载完响应时要调用的JavaScript函数</li>
<li><code>onComplete</code>  - 远程调用完全结束（包括更新内容）时要调用的JavaScript函数</li>
</ul><p class="paragraph"/>如果你需要使用<code>XmlHttpRequest</code>对象，你可以使用隐式的事件参数<code>e</code>来获取它：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript&#62;</span>
    function fireMe(e) &#123;
        alert(<span class="xml&#45;quote">"XmlHttpRequest = "</span> + e)
    &#125;
&#125;
<span class="xml&#45;tag">&#60;/g:javascript&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"example"</span>
              update=<span class="xml&#45;quote">"success"</span>
              onSuccess=<span class="xml&#45;quote">"fireMe(e)"</span>&#62;</span>Ajax Link<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span></pre></div>


<a name="6.7.2 Ajax with Prototype"><!-- Legacy link --></a>
<h2 id="ajaxWithPrototype">6.7.2 用Prototype实现Ajax</h2>
<div class="hidden-block">
Grails features an external plugin to add <a href="http://www.prototypejs.org/" target="blank">Prototype</a> support to Grails. To install the plugin type the following command from the root of your project in a terminal window:<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin prototype</pre></div><p class="paragraph"/>This will download the current supported version of the Prototype plugin and install it into your Grails project. With that done you can add the following reference to the top of your page:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"prototype"</span> /&#62;</span></pre></div><p class="paragraph"/>If you require <a href="http://script.aculo.us/" target="blank">Scriptaculous</a> too you can do the following instead:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"scriptaculous"</span> /&#62;</span></pre></div><p class="paragraph"/>Now all of Grails tags such as <a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a>, <a href="../ref/Tags/formRemote.html" class="tags">formRemote</a> and <a href="../ref/Tags/submitToRemote.html" class="tags">submitToRemote</a> work with Prototype remoting.
</div><p class="paragraph"/>Grails通过一个外部插件来提供对 <a href="http://www.prototypejs.org/" target="blank">Prototype</a> 的支持。要安装此插件，在字符终端的窗口中，进入你工程的根目录，输入下面命令即可：<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin prototype</pre></div><p class="paragraph"/>插件将为你下载当前支持的Prototype版本，并且安装到你的Grails工程中。此后你就可以在你页面的开头添加如下的引用即可：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"prototype"</span> /&#62;</span></pre></div><p class="paragraph"/>如果你需要 <a href="http://script.aculo.us/" target="blank">Scriptaculous</a> 的话，请使用如下方式：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"scriptaculous"</span> /&#62;</span></pre></div><p class="paragraph"/>现在所有Grails的Ajax标签比如<a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a>、<a href="../ref/Tags/formRemote.html" class="tags">formRemote</a>和<a href="../ref/Tags/submitToRemote.html" class="tags">submitToRemote</a>都使用Prototype来工作了。


<a name="6.7.3 Ajax with Dojo"><!-- Legacy link --></a>
<h2 id="ajaxWithDojo">6.7.3 用Dojo实现Ajax</h2>
<div class="hidden-block">
Grails features an external plugin to add <a href="http://dojotoolkit.org/" target="blank">Dojo</a> support to Grails. To install the plugin type the following command from the root of your project in a terminal window:<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin dojo</pre></div><p class="paragraph"/>This will download the current supported version of Dojo and install it into your Grails project. With that done you can add the following reference to the top of your page:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"dojo"</span> /&#62;</span></pre></div><p class="paragraph"/>Now all of Grails tags such as <a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a>, <a href="../ref/Tags/formRemote.html" class="tags">formRemote</a> and <a href="../ref/Tags/submitToRemote.html" class="tags">submitToRemote</a> work with Dojo remoting.
</div><p class="paragraph"/>Grails通过一个外部插件来提供对 <a href="http://dojotoolkit.org/" target="blank">Dojo</a> 的支持。要安装此插件，在字符终端的窗口中，进入你工程的根目录，输入下面命令即可：<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin dojo</pre></div><p class="paragraph"/>插件将为你下载当前支持的Dojo版本，并且安装到你的Grails工程中。此后你就可以在你页面的开头添加如下的引用即可：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript library=<span class="xml&#45;quote">"dojo"</span> /&#62;</span></pre></div><p class="paragraph"/>现在所有Grails的Ajax标签比如<a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a>、<a href="../ref/Tags/formRemote.html" class="tags">formRemote</a>和<a href="../ref/Tags/submitToRemote.html" class="tags">submitToRemote</a>都使用Dojo来工作了。


<a name="6.7.4 Ajax with GWT"><!-- Legacy link --></a>
<h2 id="ajaxWithGWT">6.7.4 用GWT实现Ajax</h2>
<div class="hidden-block">
Grails also features support for the <a href="http://code.google.com/webtoolkit/" target="blank">Google Web Toolkit</a> through a plugin. There is comprehensive <a href="http://grails.org/plugin/gwt" target="blank">documentation</a> available on the Grails wiki.
</div><p class="paragraph"/>Grails通过插件对 <a href="http://code.google.com/webtoolkit/" target="blank">Google Web Toolkit</a> 也提供了支持，其复杂的<a href="http://grails.org/plugin/gwt" target="blank">文档</a>请参考官方网站。


<a name="6.7.5 Ajax on the Server"><!-- Legacy link --></a>
<h2 id="ajaxOnTheServer">6.7.5 服务端的Ajax</h2>
<div class="hidden-block">
There are a number of different ways to implement Ajax which are typically broken down into:
<ul class="star">
<li>Content Centric Ajax - Where you just use the HTML result of a remote call to update the page</li>
<li>Data Centric Ajax - Where you actually send an XML or JSON response from the server and programmatically update the page</li>
<li>Script Centric Ajax - Where the server sends down a stream of JavaScript to be evaluated on the fly</li>
</ul><p class="paragraph"/>Most of the examples in the <a href="../guide/single.html#ajax" class="guide">Ajax</a> section cover Content Centric Ajax where you are updating the page, but you may also want to use Data Centric or Script Centric. This guide covers the different styles of Ajax.
</div><p class="paragraph"/>实现Ajax有很多种不同的方式，但大体可分为如下几类：
<ul class="star">
<li>内容为中心的Ajax - 使用远程调用返回的HTML结果更新页面</li>
<li>数据为中心的Ajax - 从服务器端发送接收XML或者JSON，并且以编程的方式更新页面</li>
<li>脚本为中心的Ajax - 接收从服务器端发出的JavaScript流，并且运行之</li>
</ul><p class="paragraph"/><a href="../guide/single.html#ajax" class="guide">Ajax</a>章节中的大部分示例都是以内容为中心的方式更新页面，不过你也可以使用数据为中心或者脚本为中心。本节将涵盖这些不同风格的Ajax。<p class="paragraph"/><div class="hidden-block">
<h4>Content Centric Ajax</h4><p class="paragraph"/>Just to re-cap, content centric Ajax involves sending some HTML back from the server and is typically done by rendering a template with the <a href="../ref/Controllers/render.html" class="controllers">render</a> method:<p class="paragraph"/><div class="code"><pre>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    render(template: <span class="java&#45;quote">"bookTemplate"</span>, model: &#91;book: b&#93;)
&#125;</pre></div><p class="paragraph"/>Calling this on the client involves using the <a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"showBook"</span> id=<span class="xml&#45;quote">"$&#123;book.id&#125;"</span>
              update=<span class="xml&#45;quote">"book$&#123;book.id&#125;"</span>&#62;</span>Update Book<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"book$&#123;book.id&#125;"</span>&#62;</span>
   <span class="xml&#45;comment">&#60;!&#45;&#45;existing book mark&#45;up &#45;&#45;&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div>
</div><p class="paragraph"/><h4>内容为中心的Ajax</h4><p class="paragraph"/>重申一下，内容为中心的Ajax主要跟从服务器端返回HTML内容相关，这些内容一般是通过使用<a href="../ref/Controllers/render.html" class="controllers">render</a>渲染模板的方式得到：：<p class="paragraph"/><div class="code"><pre>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    render(template: <span class="java&#45;quote">"bookTemplate"</span>, model: &#91;book: b&#93;)
&#125;</pre></div><p class="paragraph"/>在客户端的调用一般是通过<a href="../ref/Tags/remoteLink.html" class="tags">remoteLink</a>标签来实现：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"showBook"</span> id=<span class="xml&#45;quote">"$&#123;book.id&#125;"</span>
              update=<span class="xml&#45;quote">"book$&#123;book.id&#125;"</span>&#62;</span>Update Book<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"book$&#123;book.id&#125;"</span>&#62;</span>
   <span class="xml&#45;comment">&#60;!&#45;&#45;existing book mark&#45;up &#45;&#45;&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Data Centric Ajax with JSON</h4><p class="paragraph"/>Data Centric Ajax typically involves evaluating the response on the client and updating programmatically. For a JSON response with Grails you would typically use Grails' <a href="../guide/single.html#xmlAndJSON" class="guide">JSON marshalling</a> capability:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.JSON<p class="paragraph"/>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    render b as JSON
&#125;</pre></div><p class="paragraph"/>And then on the client parse the incoming JSON request using an Ajax event handler:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript&#62;</span>
function updateBook(e) &#123;
    var book = eval(<span class="xml&#45;quote">"("</span>+e.responseText+<span class="xml&#45;quote">")"</span>) // evaluate the JSON
    $(<span class="xml&#45;quote">"book"</span> + book.id + <span class="xml&#45;quote">"_title"</span>).innerHTML = book.title
&#125;
<span class="xml&#45;tag">&#60;g:javascript&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"test"</span> update=<span class="xml&#45;quote">"foo"</span> onSuccess=<span class="xml&#45;quote">"updateBook(e)"</span>&#62;</span>
    Update Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span>
<span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"bookId"</span>&#62;</span>book$&#123;book.id&#125;<span class="xml&#45;tag">&#60;/g:set&#62;</span>
<span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;_title"</span>&#62;</span>The Stand<span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div>
</div><p class="paragraph"/><h4>JSON实现的数据为中心的Ajax</h4><p class="paragraph"/>数据为中心的Ajax通常是在客户端以编程的方式处理返回结果和内容更新。在Grails中，一个JSON响应通常是使用<a href="../guide/single.html#xmlAndJSON" class="guide">JSON编组（marshalling）</a>来处理的：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.JSON<p class="paragraph"/>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    render b as JSON
&#125;</pre></div><p class="paragraph"/>在客户端，通过Ajax的事件处理器来进行解析SON的：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript&#62;</span>
function updateBook(e) &#123;
    var book = eval(<span class="xml&#45;quote">"("</span>+e.responseText+<span class="xml&#45;quote">")"</span>) // evaluate the JSON
    $(<span class="xml&#45;quote">"book"</span> + book.id + <span class="xml&#45;quote">"_title"</span>).innerHTML = book.title
&#125;
<span class="xml&#45;tag">&#60;g:javascript&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"test"</span> update=<span class="xml&#45;quote">"foo"</span> onSuccess=<span class="xml&#45;quote">"updateBook(e)"</span>&#62;</span>
    Update Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span>
<span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"bookId"</span>&#62;</span>book$&#123;book.id&#125;<span class="xml&#45;tag">&#60;/g:set&#62;</span>
<span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;_title"</span>&#62;</span>The Stand<span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Data Centric Ajax with XML</h4><p class="paragraph"/>On the server side using XML is equally simple:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.XML<p class="paragraph"/>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    render b as XML
&#125;</pre></div><p class="paragraph"/>However, since DOM is involved the client gets more complicated:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript&#62;</span>
function updateBook(e) &#123;
    var xml = e.responseXML
    var id = xml.getElementsByTagName(<span class="xml&#45;quote">"book"</span>).getAttribute(<span class="xml&#45;quote">"id"</span>)
    $(<span class="xml&#45;quote">"book"</span> + id + <span class="xml&#45;quote">"_title"</span>) = xml.getElementsByTagName(<span class="xml&#45;quote">"title"</span>)&#91;0&#93;.textContent
&#125;
<span class="xml&#45;tag">&#60;g:javascript&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"test"</span> update=<span class="xml&#45;quote">"foo"</span> onSuccess=<span class="xml&#45;quote">"updateBook(e)"</span>&#62;</span>
    Update Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span>
<span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"bookId"</span>&#62;</span>book$&#123;book.id&#125;<span class="xml&#45;tag">&#60;/g:set&#62;</span>
<span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;_title"</span>&#62;</span>The Stand<span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div>
</div><p class="paragraph"/><h4>XML实现的数据为中心的Ajax</h4><p class="paragraph"/>在服务器端，处理XML是很容易的：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.XML<p class="paragraph"/>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    render b as XML
&#125;</pre></div><p class="paragraph"/>但是在客户端却是要复杂很多，因为要通过DOM来实现：<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:javascript&#62;</span>
function updateBook(e) &#123;
    var xml = e.responseXML
    var id = xml.getElementsByTagName(<span class="xml&#45;quote">"book"</span>).getAttribute(<span class="xml&#45;quote">"id"</span>)
    $(<span class="xml&#45;quote">"book"</span> + id + <span class="xml&#45;quote">"_title"</span>) = xml.getElementsByTagName(<span class="xml&#45;quote">"title"</span>)&#91;0&#93;.textContent
&#125;
<span class="xml&#45;tag">&#60;g:javascript&#62;</span>
<span class="xml&#45;tag">&#60;g:remoteLink action=<span class="xml&#45;quote">"test"</span> update=<span class="xml&#45;quote">"foo"</span> onSuccess=<span class="xml&#45;quote">"updateBook(e)"</span>&#62;</span>
    Update Book
<span class="xml&#45;tag">&#60;/g:remoteLink&#62;</span>
<span class="xml&#45;tag">&#60;g:set var=<span class="xml&#45;quote">"bookId"</span>&#62;</span>book$&#123;book.id&#125;<span class="xml&#45;tag">&#60;/g:set&#62;</span>
<span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;div id=<span class="xml&#45;quote">"$&#123;bookId&#125;_title"</span>&#62;</span>The Stand<span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Script Centric Ajax with JavaScript</h4><p class="paragraph"/>Script centric Ajax involves actually sending JavaScript back that gets evaluated on the client. An example of this can be seen below:<p class="paragraph"/><div class="code"><pre>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    response.contentType = <span class="java&#45;quote">"text/javascript"</span>
    <span class="java&#45;object">String</span> title = b.title.encodeAsJavascript()
    render <span class="java&#45;quote">"&#36;('book$&#123;b.id&#125;_title')='$&#123;title&#125;'"</span>
&#125;</pre></div><p class="paragraph"/>The important thing to remember is to set the <code>contentType</code> to <code>text/javascript</code>. If you use Prototype on the client the returned JavaScript will automatically be evaluated due to this <code>contentType</code> setting.<p class="paragraph"/>Obviously in this case it is critical that you have an agreed client-side API as you don't want changes on the client breaking the server. This is one of the reasons Rails has something like RJS. Although Grails does not currently have a feature such as RJS there is a <a href="http://grails.org/plugin/dynamic-javascript" target="blank">Dynamic JavaScript Plugin</a> that offers similar capabilities.
</div><p class="paragraph"/><h4>JavaScript实现的脚本为中心的Ajax</h4><p class="paragraph"/>脚本为中心的Ajax主要在客户端处理从后台返回的JavaScript，并且运行它们。比如如下示例：<p class="paragraph"/><div class="code"><pre>def showBook() &#123;
    def b = Book.get(params.id)<p class="paragraph"/>    response.contentType = <span class="java&#45;quote">"text/javascript"</span>
    <span class="java&#45;object">String</span> title = b.title.encodeAsJavascript()
    render <span class="java&#45;quote">"&#36;('book$&#123;b.id&#125;_title')='$&#123;title&#125;'"</span>
&#125;</pre></div><p class="paragraph"/>需要记住的是要设置<code>contentType</code>为<code>text/javascript</code>。如果你在客户端使用的是Prototype，它会根据<code>contentType</code>的设置而自动执行。<p class="paragraph"/>很明显，这种情况下，有一个很严重的前提，那就是你必须认可服务器端将依赖客户端的API，这也是Rails（Grails就是受其启发而来的－－译者注）存在RJS的一个原因。尽管Grails并没有类似于RJS的功能，但是有一个<a href="http://grails.org/plugin/dynamic-javascript" target="blank">动态JavaScript插件</a>提供了类似的功能。<p class="paragraph"/><div class="hidden-block">
<h4>Responding to both Ajax and non-Ajax requests</h4><p class="paragraph"/>It's straightforward to have the same Grails controller action handle both Ajax and non-Ajax requests. Grails adds the <code>isXhr()</code> method to <code>HttpServletRequest</code> which can be used to identify Ajax requests. For example you could render a page fragment using a template for Ajax requests or the full page for regular HTTP requests:<p class="paragraph"/><div class="code"><pre>def listBooks() &#123;
    def books = Book.list(params)
    <span class="java&#45;keyword">if</span> (request.xhr) &#123;
        render template: <span class="java&#45;quote">"bookTable"</span>, model: &#91;books: books&#93;
    &#125; <span class="java&#45;keyword">else</span> &#123;
        render view: <span class="java&#45;quote">"list"</span>, model: &#91;books: books&#93;
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>响应Ajax和非Ajax请求</h4><p class="paragraph"/>使用同一个控制器和操作来处理Ajax和非Ajax请求是非常直截了当的。Grails为<code>HttpServletRequest</code>增加了一个<code>isXhr()</code>用以标识是否为Ajax请求。比如你可以使用模板为Ajax请求渲染一个页面片段，否则就渲染一个完整的页面：<p class="paragraph"/><div class="code"><pre>def listBooks() &#123;
    def books = Book.list(params)
    <span class="java&#45;keyword">if</span> (request.xhr) &#123;
        render template: <span class="java&#45;quote">"bookTable"</span>, model: &#91;books: books&#93;
    &#125; <span class="java&#45;keyword">else</span> &#123;
        render view: <span class="java&#45;quote">"list"</span>, model: &#91;books: books&#93;
    &#125;
&#125;</pre></div>


<a name="6.8 Content Negotiation"><!-- Legacy link --></a>
<h2 id="contentNegotiation">6.8 内容协商</h2>
<div class="hidden-block">
Grails has built in support for <a href="http://en.wikipedia.org/wiki/Content_negotiation" target="blank">Content negotiation</a> using either the HTTP <code>Accept</code> header, an explicit format request parameter or the extension of a mapped URI.
</div><p class="paragraph"/>Grails通过HTTP的<code>Accept</code>报头（显式的参数请求方式）或者扩展的URI映射来提供对<a href="http://en.wikipedia.org/wiki/Content_negotiation" target="blank">内容协商</a>的支持。<p class="paragraph"/><div class="hidden-block">
<h4>Configuring Mime Types</h4><p class="paragraph"/>Before you can start dealing with content negotiation you need to tell Grails what content types you wish to support. By default Grails comes configured with a number of different content types within <code>grails-app/conf/Config.groovy</code> using the <code>grails.mime.types</code> setting:<p class="paragraph"/><div class="code"><pre>grails.mime.types = &#91; xml: &#91;'text/xml', 'application/xml'&#93;,
                      text: 'text&#45;plain',
                      js: 'text/javascript',
                      rss: 'application/rss+xml',
                      atom: 'application/atom+xml',
                      css: 'text/css',
                      csv: 'text/csv',
                      all: '&#42;/&#42;',
                      json: 'text/json',
                      html: &#91;'text/html','application/xhtml+xml'&#93;
                    &#93;</pre></div><p class="paragraph"/>The above bit of configuration allows Grails to detect to format of a request containing either the 'text/xml' or 'application/xml' media types as simply 'xml'. You can add your own types by simply adding new entries into the map.
</div><p class="paragraph"/><h4>配置Mime类型</h4><p class="paragraph"/>在你开始处理内容协商之前，你必须告诉Grails需要支持什么样的内容类型。缺省情况下，Grails将根据<code>grails-app/conf/Config.groovy</code>中的<code>grails.mime.types</code>设置来配置相关的内容类型：<p class="paragraph"/><div class="code"><pre>grails.mime.types = &#91; xml: &#91;'text/xml', 'application/xml'&#93;,
                      text: 'text&#45;plain',
                      js: 'text/javascript',
                      rss: 'application/rss+xml',
                      atom: 'application/atom+xml',
                      css: 'text/css',
                      csv: 'text/csv',
                      all: '&#42;/&#42;',
                      json: 'text/json',
                      html: &#91;'text/html','application/xhtml+xml'&#93;
                    &#93;</pre></div><p class="paragraph"/>上述示例的配置块中，Grails将媒体类型为'text/xml'或'application/xml'的请求都只当做'xml'看待。你也可以添加自己的类型到类型为map的参数中。<p class="paragraph"/>
<div class="hidden-block">
<h4>Content Negotiation using the Accept header</h4><p class="paragraph"/>Every incoming HTTP request has a special <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html" target="blank">Accept</a> header that defines what media types (or mime types) a client can "accept". In older browsers this is typically:<p class="paragraph"/><div class="code"><pre>&#42;/&#42;</pre></div><p class="paragraph"/>Which simply means anything. However, on newer browser something all together more useful is sent such as (an example of a Firefox <code>Accept</code> header):<p class="paragraph"/><div class="code"><pre>text/xml, application/xml, application/xhtml+xml, text/html;q=0.9,
text/plain;q=0.8, image/png, &#42;/&#42;;q=0.5</pre></div><p class="paragraph"/>Grails parses this incoming format and adds a <code>property</code> to the <a href="../ref/Servlet API/response.html" class="servletAPI">response</a> object that outlines the preferred response format. For the above example the following assertion would pass:<p class="paragraph"/><div class="code"><pre>assert 'html' == response.format</pre></div><p class="paragraph"/>Why? The <code>text/html</code> media type has the highest "quality" rating of 0.9, therefore is the highest priority. If you have an older browser as mentioned previously the result is slightly different:<p class="paragraph"/><div class="code"><pre>assert 'all' == response.format</pre></div><p class="paragraph"/>In this case 'all' possible formats are accepted by the client. To deal with different kinds of requests from <a href="../guide/single.html#controllers" class="guide">Controllers</a> you can use the <a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a> method that acts as kind of a switch statement:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.XML<p class="paragraph"/>class BookController &#123;<p class="paragraph"/>    def list() &#123;
        def books = Book.list()
        withFormat &#123;
            html bookList: books
            js &#123; render <span class="java&#45;quote">"alert('hello')"</span> &#125;
            xml &#123; render books as XML &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>If the preferred format is <code>html</code> then Grails will execute the <code>html()</code> call only. This causes Grails to look for a view called either <code>grails-app/views/books/list.html.gsp</code> or <code>grails-app/views/books/list.gsp</code>. If the format is <code>xml</code> then the closure will be invoked and an XML response rendered.<p class="paragraph"/>How do we handle the "all" format? Simply order the content-types within your <code>withFormat</code> block so that whichever one you want executed comes first. So in the above example, "all" will trigger the <code>html</code> handler.<p class="paragraph"/><blockquote class="note">
When using <a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a> make sure it is the last call in your controller action as the return value of the <code>withFormat</code> method is used by the action to dictate what happens next.
</blockquote>
</div><p class="paragraph"/><h4>使用Accept报头的内容协商</h4><p class="paragraph"/>每一个发送的HTTP请求都有个特别的<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html" target="blank">Accept</a>报头，它定义了客户端能“接受”什么样的媒体类型(或mime类型)。这个在旧的浏览器中通常是：<p class="paragraph"/><div class="code"><pre>&#42;/&#42;</pre></div><p class="paragraph"/>用以简单的表示任何事物。然而，在较新的浏览器中，更多有用的信息将被起发送（比如一个Firefox的<code>Accept</code>报头）：<p class="paragraph"/><div class="code"><pre>text/xml, application/xml, application/xhtml+xml, text/html;q=0.9,
text/plain;q=0.8, image/png, &#42;/&#42;;q=0.5</pre></div><p class="paragraph"/>Grails解析这个输入格式，并为<a href="../ref/Servlet API/response.html" class="servletAPI">response</a>对象添加一个优先响应此格式的<code>property</code>，比如上述示例，如下的断言将会通过：<p class="paragraph"/><div class="code"><pre>assert 'html' == response.format</pre></div><p class="paragraph"/>为什么呢？这个<code>text/html</code>媒体类型拥有的最高"质量"等级是0.9，因此，具有最高优先权。上述同样的示例如果在旧浏览器结果会有些稍微不同：<p class="paragraph"/><div class="code"><pre>assert 'all' == response.format</pre></div><p class="paragraph"/>此处的'all'格式是被客户端所接受的。 要在<a href="../guide/single.html#controllers" class="guide">控制器</a>中处理这些不同类型的请求，你可以使用<a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a>方法，其跟switch语句类似：<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.XML<p class="paragraph"/>class BookController &#123;<p class="paragraph"/>    def list() &#123;
        def books = Book.list()
        withFormat &#123;
            html bookList: books
            js &#123; render <span class="java&#45;quote">"alert('hello')"</span> &#125;
            xml &#123; render books as XML &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>如果优先格式是<code>html</code>，那么Grails将仅仅执行<code>html()</code>的调用。这将导致Grails查找名称为<code>grails-app/views/books/list.html.gsp</code>或者<code>grails-app/views/books/list.gsp</code>视图。 如果是<code>xml</code>格式，那么响应的必包将会被调用，并且渲染为一个XML响应。<p class="paragraph"/>那么我们该如何处理那个"all"格式呢？这要看你<code>withFormat</code>代码块中内容类型（content-types）的顺序了。以上述代码为例，"all"将触发<code>html</code>的处理。<p class="paragraph"/><blockquote class="note">
在使用<a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a>的时候，请确保它是控制器操作的最后一个调用，如此控制器才能知道下一步要做什么。
</blockquote><p class="paragraph"/><div class="hidden-block">
<h4>Request format vs. Response format</h4><p class="paragraph"/>As of Grails 2.0, there is a separate notion of the  <em class="italic">request</em>  format and the  <em class="italic">response</em>  format. The request format is dictated by the <code>CONTENT_TYPE</code> header and is typically used to detect if the incoming request can be parsed into XML or JSON, whilst the response format uses the file extension, format parameter or ACCEPT header to attempt to deliver an appropriate response to the client.<p class="paragraph"/>The <a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a> available on controllers deals specifically with the response format. If you wish to add logic that deals with the request format then you can do so using a separate <code>withFormat</code> method available on the request:<p class="paragraph"/><div class="code"><pre>request.withFormat &#123;
    xml &#123;
        // read XML
    &#125;
    json &#123;
        // read JSON
    &#125;
&#125;</pre></div>
</div><p class="paragraph"/><h4>请求格式和响应格式</h4><p class="paragraph"/>从Grails 2.0以来，就单独提出了  <em class="italic">request</em>  和  <em class="italic">response</em>  格式的概念。对于请求格式，通常是由<code>CONTENT_TYPE</code>报头决定的，并且用以检测收入的请求是否可以被解析为XML或者JSON。而响应格式通常是由文件扩展名、参数格式或者ACCEPT报头决定，并且尝试以合适的响应返回给客户端。<p class="paragraph"/>控制器的<a href="../ref/Controllers/withFormat.html" class="controllers">withFormat</a>方法是针对响应格式而言的。如果你想增加请求格式的逻辑处理，需要单独使用request对象的<code>withFormat</code>方法：<p class="paragraph"/><div class="code"><pre>request.withFormat &#123;
    xml &#123;
        // read XML
    &#125;
    json &#123;
        // read JSON
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Content Negotiation with the format Request Parameter</h4><p class="paragraph"/>If fiddling with request headers if not your favorite activity you can override the format used by specifying a <code>format</code> request parameter:<p class="paragraph"/><div class="code"><pre>/book/list?format=xml</pre></div><p class="paragraph"/>You can also define this parameter in the <a href="../guide/single.html#urlmappings" class="guide">URL Mappings</a> definition:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/book/list"</span>(controller:<span class="java&#45;quote">"book"</span>, action:<span class="java&#45;quote">"list"</span>) &#123;
    format = <span class="java&#45;quote">"xml"</span>
&#125;</pre></div>
</div><p class="paragraph"/><h4>请求参数格式的内容协商</h4><p class="paragraph"/>如果不喜欢摆弄这些请求报头，你可以通过指定请求参数的<code>format</code>来覆盖这些格式：<p class="paragraph"/><div class="code"><pre>/book/list?format=xml</pre></div><p class="paragraph"/>你也可以将此参数定义在<a href="../guide/single.html#urlmappings" class="guide">URL映射</a>中，比如<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/book/list"</span>(controller:<span class="java&#45;quote">"book"</span>, action:<span class="java&#45;quote">"list"</span>) &#123;
    format = <span class="java&#45;quote">"xml"</span>
&#125;</pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Content Negotiation with URI Extensions</h4><p class="paragraph"/>Grails also supports content negotiation using URI extensions. For example given the following URI:<p class="paragraph"/><div class="code"><pre>/book/list.xml</pre></div><p class="paragraph"/>Grails will remove the extension and map it to <code>/book/list</code> instead whilst simultaneously setting the content format to <code>xml</code> based on this extension. This behaviour is enabled by default, so if you wish to turn it off, you must set the <code>grails.mime.file.extensions</code> property in <code>grails-app/conf/Config.groovy</code> to <code>false</code>:<p class="paragraph"/><div class="code"><pre>grails.mime.file.extensions = <span class="java&#45;keyword">false</span></pre></div>
</div><p class="paragraph"/><h4>URI扩展的内容协商</h4><p class="paragraph"/>Grails还提供了对扩展URI的内容协商的支持。比如下面URI示例：<p class="paragraph"/><div class="code"><pre>/book/list.xml</pre></div><p class="paragraph"/>Grails将移除其扩展后缀，而且将其映射为<code>/book/list</code>。与此同时，设置此内容格式为<code>xml</code>。缺省情况下，此行为是开启的。如果你想要关闭它，只需要设置<code>grails-app/conf/Config.groovy</code>中的<code>grails.mime.file.extensions</code>属性为<code>false</code>即可：<p class="paragraph"/><div class="code"><pre>grails.mime.file.extensions = <span class="java&#45;keyword">false</span></pre></div><p class="paragraph"/><div class="hidden-block">
<h4>Testing Content Negotiation</h4><p class="paragraph"/>To test content negotiation in a unit or integration test (see the section on <a href="../guide/single.html#testing" class="guide">Testing</a>) you can either manipulate the incoming request headers:<p class="paragraph"/><div class="code"><pre>void testJavascriptOutput() &#123;
    def controller = <span class="java&#45;keyword">new</span> TestController()
    controller.request.addHeader <span class="java&#45;quote">"Accept"</span>,
              <span class="java&#45;quote">"text/javascript, text/html, application/xml, text/xml, &#42;/&#42;"</span><p class="paragraph"/>    controller.testAction()
    assertEquals <span class="java&#45;quote">"alert('hello')"</span>, controller.response.contentAsString
&#125;</pre></div><p class="paragraph"/>Or you can set the format parameter to achieve a similar effect:<p class="paragraph"/><div class="code"><pre>void testJavascriptOutput() &#123;
    def controller = <span class="java&#45;keyword">new</span> TestController()
    controller.params.format = 'js'<p class="paragraph"/>    controller.testAction()
    assertEquals <span class="java&#45;quote">"alert('hello')"</span>, controller.response.contentAsString
&#125;</pre></div>
</div><p class="paragraph"/><h4>测试内容协商</h4><p class="paragraph"/>要在单元或者集成测试（请参考<a href="../guide/single.html#testing" class="guide">测试</a>章节）中测试内容协商，你可以操作输入请求的报头方式进行，比如：<p class="paragraph"/><div class="code"><pre>void testJavascriptOutput() &#123;
    def controller = <span class="java&#45;keyword">new</span> TestController()
    controller.request.addHeader <span class="java&#45;quote">"Accept"</span>,
              <span class="java&#45;quote">"text/javascript, text/html, application/xml, text/xml, &#42;/&#42;"</span><p class="paragraph"/>    controller.testAction()
    assertEquals <span class="java&#45;quote">"alert('hello')"</span>, controller.response.contentAsString
&#125;</pre></div><p class="paragraph"/>或者设置参数格式的方式来达到类似的效果：<p class="paragraph"/><div class="code"><pre>void testJavascriptOutput() &#123;
    def controller = <span class="java&#45;keyword">new</span> TestController()
    controller.params.format = 'js'<p class="paragraph"/>    controller.testAction()
    assertEquals <span class="java&#45;quote">"alert('hello')"</span>, controller.response.contentAsString
&#125;</pre></div>


<a name="7. Validation"><!-- Legacy link --></a>
<h1 id="validation">7 Validation</h1>
Grails validation capability is built on <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/validation/package-summary.html" target="blank">Spring&#39;s Validator API</a> and data binding capabilities. However Grails takes this further and provides a unified way to define validation "constraints" with its constraints mechanism.<p class="paragraph"/>Constraints in Grails are a way to declaratively specify validation rules. Most commonly they are applied to <a href="../guide/single.html#GORM" class="guide">domain classes</a>, however <a href="../guide/single.html#urlmappings" class="guide">URL Mappings</a> and <a href="../guide/single.html#commandObjects" class="guide">Command Objects</a> also support constraints.


<a name="7.1 Declaring Constraints"><!-- Legacy link --></a>
<h2 id="constraints">7.1 Declaring Constraints</h2>
Within a domain class <a href="../ref/Domain Classes/constraints.html" class="domainClasses">constraints</a> are defined with the constraints property that is assigned a code block:<p class="paragraph"/><div class="code"><pre>class User &#123;
    <span class="java&#45;object">String</span> login
    <span class="java&#45;object">String</span> password
    <span class="java&#45;object">String</span> email
    <span class="java&#45;object">Integer</span> age<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
      &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>You then use method calls that match the property name for which the constraint applies in combination with named parameters to specify constraints:<p class="paragraph"/><div class="code"><pre>class User &#123;
    ...<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        login size: 5..15, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        password size: 5..15, blank: <span class="java&#45;keyword">false</span>
        email email: <span class="java&#45;keyword">true</span>, blank: <span class="java&#45;keyword">false</span>
        age min: 18
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example we've declared that the <code>login</code> property must be between 5 and 15 characters long, it cannot be blank and must be unique. We've also applied other constraints to the <code>password</code>, <code>email</code> and <code>age</code> properties.<p class="paragraph"/><blockquote class="note">
By default, all domain class properties are not nullable (i.e. they have an implicit <code>nullable: false</code> constraint). The same is not true for command object properties, which are nullable by default.
</blockquote><p class="paragraph"/>A complete reference for the available constraints can be found in the Quick Reference section under the Constraints heading.<p class="paragraph"/><h3>A word of warning - referencing domain class properties from constraints</h3><p class="paragraph"/>It's very easy to attempt to reference instance variables from the static constraints block, but this isn't legal in Groovy (or Java). If you do so, you will get a <code>MissingPropertyException</code> for your trouble. For example, you may try
<div class="code"><pre>class Response &#123;
    Survey survey
    Answer answer<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        survey blank: <span class="java&#45;keyword">false</span>
        answer blank: <span class="java&#45;keyword">false</span>, inList: survey.answers
    &#125;
&#125;</pre></div><p class="paragraph"/>See how the <code>inList</code> constraint references the instance property <code>survey</code>? That won't work. Instead, use a custom <a href="../ref/Constraints/validator.html" class="constraints">validator</a>:<p class="paragraph"/><div class="code"><pre>class Response &#123;
    &#8230;
    <span class="java&#45;keyword">static</span> constraints = &#123;
        survey blank: <span class="java&#45;keyword">false</span>
        answer blank: <span class="java&#45;keyword">false</span>, validator: &#123; val, obj &#45;&#62; val in obj.survey.answers &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example, the <code>obj</code> argument to the custom validator is the domain  <em class="italic">instance</em>  that is being validated, so we can access its <code>survey</code> property and return a boolean to indicate whether the new value for the <code>answer</code> property, <code>val</code>, is valid.


<a name="7.2 Validating Constraints"><!-- Legacy link --></a>
<h2 id="validatingConstraints">7.2 Validating Constraints</h2>
<h4>Validation Basics</h4><p class="paragraph"/>Call the <a href="../ref/Domain Classes/validate.html" class="domainClasses">validate</a> method to validate a domain class instance:<p class="paragraph"/><div class="code"><pre>def user = <span class="java&#45;keyword">new</span> User(params)<p class="paragraph"/><span class="java&#45;keyword">if</span> (user.validate()) &#123;
    // <span class="java&#45;keyword">do</span> something with user
&#125;
<span class="java&#45;keyword">else</span> &#123;
    user.errors.allErrors.each &#123;
        println it
    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>errors</code> property on domain classes is an instance of the Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/validation/Errors.html" class="api">Errors</a> interface. The <code>Errors</code> interface provides methods to navigate the validation errors and also retrieve the original values.<p class="paragraph"/><h4>Validation Phases</h4><p class="paragraph"/>Within Grails there are two phases of validation, the first one being <a href="../guide/single.html#dataBinding" class="guide">data binding</a> which occurs when you bind request parameters onto an instance such as:<p class="paragraph"/><div class="code"><pre>def user = <span class="java&#45;keyword">new</span> User(params)</pre></div><p class="paragraph"/>At this point you may already have errors in the <code>errors</code> property due to type conversion (such as converting Strings to Dates). You can check these and obtain the original input value using the <code>Errors</code> API:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">if</span> (user.hasErrors()) &#123;
    <span class="java&#45;keyword">if</span> (user.errors.hasFieldErrors(<span class="java&#45;quote">"login"</span>)) &#123;
        println user.errors.getFieldError(<span class="java&#45;quote">"login"</span>).rejectedValue
    &#125;
&#125;</pre></div><p class="paragraph"/>The second phase of validation happens when you call <a href="../ref/Domain Classes/validate.html" class="domainClasses">validate</a> or <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a>. This is when Grails will validate the bound values againts the <a href="../ref/Domain Classes/constraints.html" class="domainClasses">constraints</a> you defined. For example, by default the <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> method calls <code>validate</code> before executing, allowing you to write code like:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">if</span> (user.save()) &#123;
    <span class="java&#45;keyword">return</span> user
&#125;
<span class="java&#45;keyword">else</span> &#123;
    user.errors.allErrors.each &#123;
        println it
    &#125;
&#125;</pre></div>


<a name="7.3 Validation on the Client"><!-- Legacy link --></a>
<h2 id="validationOnTheClient">7.3 Validation on the Client</h2>
<h4>Displaying Errors</h4><p class="paragraph"/>Typically if you get a validation error you redirect back to the view for rendering. Once there you need some way of displaying errors. Grails supports a rich set of tags for dealing with errors. To render the errors as a list you can use <a href="../ref/Tags/renderErrors.html" class="tags">renderErrors</a>:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:renderErrors bean=<span class="xml&#45;quote">"$&#123;user&#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>If you need more control you can use <a href="../ref/Tags/hasErrors.html" class="tags">hasErrors</a> and <a href="../ref/Tags/eachError.html" class="tags">eachError</a>:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:hasErrors bean=<span class="xml&#45;quote">"$&#123;user&#125;"</span>&#62;</span>
  <span class="xml&#45;tag">&#60;ul&#62;</span>
   <span class="xml&#45;tag">&#60;g:eachError var=<span class="xml&#45;quote">"err"</span> bean=<span class="xml&#45;quote">"$&#123;user&#125;"</span>&#62;</span>
       <span class="xml&#45;tag">&#60;li&#62;</span>$&#123;err&#125;<span class="xml&#45;tag">&#60;/li&#62;</span>
   <span class="xml&#45;tag">&#60;/g:eachError&#62;</span>
  <span class="xml&#45;tag">&#60;/ul&#62;</span>
<span class="xml&#45;tag">&#60;/g:hasErrors&#62;</span></pre></div><p class="paragraph"/><h4>Highlighting Errors</h4><p class="paragraph"/>It is often useful to highlight using a red box or some indicator when a field has been incorrectly input. This can also be done with the <a href="../ref/Tags/hasErrors.html" class="tags">hasErrors</a> by invoking it as a method. For example:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;div class='value $&#123;hasErrors(bean:user,field:'login','errors')&#125;'&#62;</span>
   <span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"text"</span> name=<span class="xml&#45;quote">"login"</span> value=<span class="xml&#45;quote">"$&#123;fieldValue(bean:user,field:'login')&#125;"</span>/&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span></pre></div><p class="paragraph"/>This code checks if the <code>login</code> field of the <code>user</code> bean has any errors and if so it adds an <code>errors</code> CSS class to the <code>div</code>, allowing you to use CSS rules to highlight the <code>div</code>.<p class="paragraph"/><h4>Retrieving Input Values</h4><p class="paragraph"/>Each error is actually an instance of the <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/validation/FieldError.html" class="api">FieldError</a> class in Spring, which retains the original input value within it. This is useful as you can use the error object to restore the value input by the user using the <a href="../ref/Tags/fieldValue.html" class="tags">fieldValue</a> tag:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;input type=<span class="xml&#45;quote">"text"</span> name=<span class="xml&#45;quote">"login"</span> value=<span class="xml&#45;quote">"$&#123;fieldValue(bean:user,field:'login')&#125;"</span>/&#62;</span></pre></div><p class="paragraph"/>This code will check for an existing <code>FieldError</code> in the <code>User</code> bean and if there is obtain the originally input value for the <code>login</code> field.


<a name="7.4 Validation and Internationalization"><!-- Legacy link --></a>
<h2 id="validationAndInternationalization">7.4 Validation and Internationalization</h2>
Another important thing to note about errors in Grails is that error messages are not hard coded anywhere. The <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/validation/FieldError.html" class="api">FieldError</a> class in Spring resolves messages from message bundles using Grails' <a href="../guide/single.html#i18n" class="guide">i18n</a> support.<p class="paragraph"/><h4>Constraints and Message Codes</h4><p class="paragraph"/>The codes themselves are dictated by a convention. For example consider the constraints we looked at earlier:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/>class User &#123;
    ...<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        login size: 5..15, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        password size: 5..15, blank: <span class="java&#45;keyword">false</span>
        email email: <span class="java&#45;keyword">true</span>, blank: <span class="java&#45;keyword">false</span>
        age min: 18
    &#125;
&#125;</pre></div><p class="paragraph"/>If a constraint is violated Grails will by convention look for a message code of the form:<p class="paragraph"/><div class="code"><pre>&#91;<span class="java&#45;object">Class</span> Name&#93;.&#91;Property Name&#93;.&#91;Constraint Code&#93;</pre></div><p class="paragraph"/>In the case of the <code>blank</code> constraint this would be <code>user.login.blank</code> so you would need a message such as the following in your <code>grails-app/i18n/messages.properties</code> file:<p class="paragraph"/><div class="code"><pre>user.login.blank=Your login name must be specified!</pre></div><p class="paragraph"/>The class name is looked for both with and without a package, with the packaged version taking precedence. So for example, com.mycompany.myapp.User.login.blank will be used before user.login.blank. This allows for cases where your domain class message codes clash with a plugin's.<p class="paragraph"/>For a reference on what codes are for which constraints refer to the reference guide for each constraint.<p class="paragraph"/><h4>Displaying Messages</h4><p class="paragraph"/>The <a href="../ref/Tags/renderErrors.html" class="tags">renderErrors</a> tag will automatically look up messages for you using the <a href="../ref/Tags/message.html" class="tags">message</a> tag. If you need more control of rendering you can handle this yourself:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:hasErrors bean=<span class="xml&#45;quote">"$&#123;user&#125;"</span>&#62;</span>
  <span class="xml&#45;tag">&#60;ul&#62;</span>
   <span class="xml&#45;tag">&#60;g:eachError var=<span class="xml&#45;quote">"err"</span> bean=<span class="xml&#45;quote">"$&#123;user&#125;"</span>&#62;</span>
       <span class="xml&#45;tag">&#60;li&#62;</span><span class="xml&#45;tag">&#60;g:message error=<span class="xml&#45;quote">"$&#123;err&#125;"</span> /&#62;</span><span class="xml&#45;tag">&#60;/li&#62;</span>
   <span class="xml&#45;tag">&#60;/g:eachError&#62;</span>
  <span class="xml&#45;tag">&#60;/ul&#62;</span>
<span class="xml&#45;tag">&#60;/g:hasErrors&#62;</span></pre></div><p class="paragraph"/>In this example within the body of the <a href="../ref/Tags/eachError.html" class="tags">eachError</a> tag we use the <a href="../ref/Tags/message.html" class="tags">message</a> tag in combination with its <code>error</code> argument to read the message for the given error.<p class="paragraph"/>

<a name="7.5 Validation Non Domain and Command Object Classes"><!-- Legacy link --></a>
<h2 id="validationNonDomainAndCommandObjectClasses">7.5 Validation Non Domain and Command Object Classes</h2>
<a href="../guide/single.html#domainClasses" class="guide">Domain classes</a> and <a href="../guide/single.html#commandObjects" class="guide">command objects</a> support validation by default.  Other classes may be made validateable by defining the static <code>constraints</code> property in the class (as described above) and then telling the framework about them.  It is important that the application register the validateable classes with the framework.  Simply defining the <code>constraints</code> property is not sufficient.<p class="paragraph"/><h4>The Validateable Annotation</h4><p class="paragraph"/>Classes which define the static <code>constraints</code> property and are annotated with @Validateable can be made validateable by the framework. Consider this example:<p class="paragraph"/><div class="code"><pre>// src/groovy/com/mycompany/myapp/User.groovy
<span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.validation.Validateable<p class="paragraph"/>@Validateable
class User &#123;
    ...<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        login size: 5..15, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        password size: 5..15, blank: <span class="java&#45;keyword">false</span>
        email email: <span class="java&#45;keyword">true</span>, blank: <span class="java&#45;keyword">false</span>
        age min: 18
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Registering Validateable Classes</h4><p class="paragraph"/>If a class is not marked with <code>Validateable, it may still be made validateable by the framework. The steps required to do this are to define the static </code>constraints<code> property in the class (as described above) and then telling the framework about the class by assigning a value to the </code>grails.validateable.classes<code> property in </code>Config.groovy@:<p class="paragraph"/><div class="code"><pre>grails.validateable.classes = &#91;com.mycompany.myapp.User, com.mycompany.dto.Account&#93;</pre></div>


<a name="8. The Service Layer"><!-- Legacy link --></a>
<h1 id="services">8 The Service Layer</h1>
Grails中也有service层的概念. Grails团队不鼓励在controller中嵌入核心应用逻辑，因为这样不利于代码的重用，也影响清晰的分层。<p class="paragraph"/><div class="hidden-block">
Grails defines the notion of a service layer. The Grails team discourages the embedding of core application logic inside controllers, as it does not promote reuse and a clean separation of concerns.
</div><p class="paragraph"/>Grails中,应用的主要逻辑都放在的service层，controller负责处理请求流程。<p class="paragraph"/><div class="hidden-block">
Services in Grails are the place to put the majority of the logic in your application, leaving controllers responsible for handling request flow with redirects and so on.
</div><p class="paragraph"/><h4>创建一个Service</h4><p class="paragraph"/><div class="hidden-block">
<h4>Creating a Service</h4>
</div><p class="paragraph"/>要创建一个Grails service,你只要进入命令行模式，在项目的根目录下，执行<a href="../ref/Command Line/create-service.html" class="commandLine">create-service</a>命令:<p class="paragraph"/><div class="hidden-block">
You can create a Grails service by running the <a href="../ref/Command Line/create-service.html" class="commandLine">create-service</a> command from the root of your project in a terminal window:
</div><p class="paragraph"/><div class="code"><pre>grails create&#45;service helloworld.simple</pre></div><p class="paragraph"/><blockquote class="note">
如果create-service脚本中没有指定package，Grails会自动使用程序的名称为package的名称。
</blockquote><p class="paragraph"/><div class="hidden-block">
<blockquote class="note">
If no package is specified with the create-service script, Grails automatically uses the application name as the package name.
</blockquote>
</div><p class="paragraph"/>这样就会创建一个service，这个service位于<code>grails-app/services/helloworld/SimpleService.groovy</code> .除了名字按照Grails的约定以<code>Service</code>结尾以外,这个文件就是一个普通的Groovy类:<p class="paragraph"/><div class="hidden-block">
The above example will create a service at the location <code>grails-app/services/helloworld/SimpleService.groovy</code>. A service's name ends with the convention <code>Service</code>, other than that a service is a plain Groovy class:
</div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> helloworld<p class="paragraph"/>class SimpleService &#123;
&#125;</pre></div>


<a name="8.1 Declarative Transactions"><!-- Legacy link --></a>
<h2 id="declarativeTransactions">8.1 Declarative Transactions</h2>
<div class="hidden-block">h3. Default Declarative Transactions</div><p class="paragraph"/><h3>声明式事务</h3><p class="paragraph"/><div class="hidden-block">
Services are typically involved with coordinating logic between <a href="../guide/single.html#GORM" class="guide">domain classes</a>, and hence often involved with persistence that spans large operations. Given the nature of services, they frequently require transactional behaviour. You can use programmatic transactions with the <a href="../ref/Domain Classes/withTransaction.html" class=" domainClasses">withTransaction</a> method, however this is repetitive and doesn't fully leverage the power of Spring's underlying transaction abstraction.
</div><p class="paragraph"/>Services通常会包含这样的逻辑--需要多个<a href="../guide/single.html#GORM" class="guide">domain类</a>之间相互配合。因此它常常会出现这样的情况:涉及到的持久化包括大量的数据库操作。这些问题使得service中经常都需要对方法进行事务管理。当然你可以用<a href="../ref/Domain Classes/withTransaction.html" class="domainClasses">withTransaction</a> 方法来管理事务，但是这样很繁琐，也不能充分利用Spring的强大的事务抽象能力。<p class="paragraph"/>Grails中可以对service进行事务划分，它声明service中所有方法都是事务型的。缺省所有的service都进行了事务划分。要禁用这个配置，只需要设置transactional 属性为false：<p class="paragraph"/><div class="hidden-block">
Services enable transaction demarcation, which is a declarative way of defining which methods are to be made transactional. All services are transactional by default. To disable this set the <code>transactional</code> property to <code>false</code>:
</div><p class="paragraph"/><div class="code"><pre>class CountryService &#123;
    <span class="java&#45;keyword">static</span> transactional = <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>
你也可以设置这个属性为true，以防止将来这个默认值改变后对你的应用造成影响，或者是明确声明service是事务型的。<p class="paragraph"/><div class="hidden-block">
You may also set this property to <code>true</code> to make it clear that the service is intentionally transactional.
</div><p class="paragraph"/><blockquote class="warning">
警告: <a href="../guide/single.html#dependencyInjectionServices" class="guide">依赖注入</a>是使声明式事务工作的<strong class="bold">唯一</strong>途径。如果你自己用<code>new</code>操作符，比如<code>new BookService()</code>，将不能得到一个事务型的service.
</blockquote><p class="paragraph"/><div class="hidden-block">
<blockquote class="warning">
Warning: <a href="../guide/single.html#dependencyInjectionServices" class="guide">dependency injection</a> is the <strong class="bold">only</strong> way that declarative transactions work. You will not get a transactional service if you use the <code>new</code> operator such as <code>new BookService()</code>
</blockquote>
</div><p class="paragraph"/>这样的结果是所有的方法被包装在一个事务中，在方法中有抛出<code>Runtime 异常</code>或<code>Error</code>时，将会自动回滚。事务传播级别默认是<a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/TransactionDefinition.html#PROPAGATION_REQUIRED" target="blank">PROPAGATION_REQUIRED</a>.<p class="paragraph"/><blockquote class="warning">
Checked异常不会回滚事务. Groovy认为checked和unchecked异常非常相似，但Spring不知道这个道理并且使用默认值. 因此必须有了解checked和unchecked异常之间的差异。
</blockquote><p class="paragraph"/><div class="hidden-block">
The result is that all methods are wrapped in a transaction and automatic rollback occurs if a method throws a runtime exception (ie one that extends <code>RuntimeException</code>) or an <code>Error</code>. The propagation level of the transaction is by default set to <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/TransactionDefinition.html#PROPAGATION_REQUIRED" target="blank">PROPAGATION_REQUIRED </a>.<p class="paragraph"/><blockquote class="warning">
Checked exceptions do <strong class="bold">not</strong> roll back transactions. Even though Groovy blurs the distinction between checked and unchecked exceptions, Spring isn't aware of this and its default behaviour is used, so it's important to understand the distinction between checked and unchecked exceptions.
</blockquote>
</div><p class="paragraph"/><div class="hidden-block">
<h3>Custom Transaction Configuration</h3><p class="paragraph"/>Grails also fully supports Spring's <code>Transactional</code> annotation for cases where you need more fine-grained control over transactions at a per-method level or need specify an alternative propagation level.<p class="paragraph"/><blockquote class="note">
Annotating a service method with <code>Transactional</code> disables the default Grails transactional behavior for that service (in the same way that adding <code>transactional=false</code> does) so if you use any annotations you must annotate all methods that require transactions.
</blockquote><p class="paragraph"/>In this example <code>listBooks</code> uses a rea​​d-only transaction, <code>updateBook</code> uses a default read-write transaction, and <code>deleteBook</code> is not transactional (probably not a good idea given its name).<p class="paragraph"/></div><p class="paragraph"/><h3>自定事务配置</h3><p class="paragraph"/>当你需要更细粒度的交易控制或需要指定另类传播级别的时候，Grails也支持Spring的<code> Transactional</code>注释。<p class="paragraph"/><blockquote class="note">
使用<code> Transactional</code>注释会停用Grails对该Service的默认行为。所以如果你使用任何注释，你必须注解的所有方法
</blockquote><p class="paragraph"/>在这个例子中<code>listBooks</code>只使用只读的事务，<code>updateBook</code>使用一个读写事务，<code>deleteBook</code>不是事务性的（看它的名称这可能不是一个好主意）。<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.transaction.annotation.Transactional<p class="paragraph"/>class BookService &#123;<p class="paragraph"/>    @Transactional(readOnly = <span class="java&#45;keyword">true</span>)
    def listBooks() &#123;
        Book.list()
    &#125;<p class="paragraph"/>    @Transactional
    def updateBook() &#123;
        // …
    &#125;<p class="paragraph"/>    def deleteBook() &#123;
        // …
    &#125;
&#125;</pre></div><p class="paragraph"/>您也可以注解全程Service的交易行为然后重写每个方法的交易行为。这项Service是相当于一个没有注释的Service（因为默认值总是<code> Transactional= TRUE</code>）：<p class="paragraph"/><div class="hidden-block">
You can also annotate the class to define the default transaction behavior for the whole service, and then override that default per-method. For example, this service is equivalent to one that has no annotations (since the default is implicitly <code>transactional=true</code> ):
</div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.transaction.annotation.Transactional<p class="paragraph"/>@Transactional
class BookService &#123;<p class="paragraph"/>    def listBooks() &#123;
        Book.list()
    &#125;<p class="paragraph"/>    def updateBook() &#123;
        // …
    &#125;<p class="paragraph"/>    def deleteBook() &#123;
        // …
    &#125;
&#125;</pre></div><p class="paragraph"/>为这个例子中类级别的注释保证所有方法为读写事务,但<code> listBooks</code>方法重写为只读的交易:<p class="paragraph"/><div class="hidden-block">
This version defaults to all methods being read-write transactional (due to the class-level annotation), but the <code>listBooks</code> method overrides this to use a rea​​d-only transaction:
</div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.transaction.annotation.Transactional<p class="paragraph"/>@Transactional
class BookService &#123;<p class="paragraph"/>    @Transactional(readOnly = <span class="java&#45;keyword">true</span>)
    def listBooks() &#123;
        Book.list()
    &#125;<p class="paragraph"/>    def updateBook() &#123;
        // …
    &#125;<p class="paragraph"/>    def deleteBook() &#123;
        // …
    &#125;
&#125;</pre></div><p class="paragraph"/>虽然在这个例子中<code> updateBook</code>和<code> deleteBook</code>没有注明注释，它们继承了类级别的注释配置。<p class="paragraph"/>如需详细资讯，请参阅Spring的用户指南<a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/transaction.html#transaction-declarative -annotations" target="blank">Using @Transactional</a>.<p class="paragraph"/>Grails和Spring之间不同的特点是Grails使用<code>Transactional</code>时不需要任何先前的配置。<p class="paragraph"/><div class="hidden-block"><p class="paragraph"/>Although <code>updateBook</code> and <code>deleteBook</code> aren't annotated in this example, they inherit the configuration from the class-level annotation.<p class="paragraph"/>For more information refer to the section of the Spring user guide on <a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/transaction.html#transaction -declarative-annotations" target="blank">Using @Transactional</a>.<p class="paragraph"/>Unlike Spring you do not need any prior configuration to use <code>Transactional</code>; just specify the annotation as needed and Grails will detect them up automatically.
</div>


<a name="8.1.1 Transactions Rollback and the Session"><!-- Legacy link --></a>
<h2 id="transactionsRollbackAndTheSession">8.1.1 Transactions Rollback and the Session</h2>
<h3>Understanding Transactions and the Hibernate Session</h3><p class="paragraph"/>When using transactions there are important considerations you must take into account with regards to how the underlying persistence session is handled by Hibernate. When a transaction is rolled back the Hibernate session used by GORM is cleared. This means any objects within the session become detached and accessing uninitialized lazy-loaded collections will lead to <code>LazyInitializationException</code>s.<p class="paragraph"/>To understand why it is important that the Hibernate session is cleared. Consider the following example:<p class="paragraph"/><div class="code"><pre>class Author &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">Integer</span> age<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;books: Book&#93;
&#125;</pre></div><p class="paragraph"/>If you were to save two authors using consecutive transactions as follows:<p class="paragraph"/><div class="code"><pre>Author.withTransaction &#123; status &#45;&#62;
    <span class="java&#45;keyword">new</span> Author(name: <span class="java&#45;quote">"Stephen King"</span>, age: 40).save()
    status.setRollbackOnly()
&#125;<p class="paragraph"/>Author.withTransaction &#123; status &#45;&#62;
    <span class="java&#45;keyword">new</span> Author(name: <span class="java&#45;quote">"Stephen King"</span>, age: 40).save()
&#125;</pre></div><p class="paragraph"/>Only the second author would be saved since the first transaction rolls back the author <code>save()</code> by clearing the Hibernate session. If the Hibernate session were not cleared then both author instances would be persisted and it would lead to very unexpected results.<p class="paragraph"/>It can, however, be frustrating to get <code>LazyInitializationException</code>s due to the session being cleared.<p class="paragraph"/>For example, consider the following example:<p class="paragraph"/><div class="code"><pre>class AuthorService &#123;<p class="paragraph"/>    void updateAge(id, <span class="java&#45;object">int</span> age) &#123;
        def author = Author.get(id)
        author.age = age
        <span class="java&#45;keyword">if</span> (author.isTooOld()) &#123;
            <span class="java&#45;keyword">throw</span> <span class="java&#45;keyword">new</span> AuthorException(<span class="java&#45;quote">"too old"</span>, author)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class AuthorController &#123;<p class="paragraph"/>    def authorService<p class="paragraph"/>    def updateAge() &#123;
        <span class="java&#45;keyword">try</span> &#123;
            authorService.updateAge(params.id, params.<span class="java&#45;object">int</span>(<span class="java&#45;quote">"age"</span>))
        &#125;
        <span class="java&#45;keyword">catch</span>(e) &#123;
            render <span class="java&#45;quote">"Author books $&#123;e.author.books&#125;"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In the above example the transaction will be rolled back if the <code>Author</code>'s age exceeds the maximum value defined in the <code>isTooOld()</code> method by throwing an <code>AuthorException</code>. The <code>AuthorException</code> references the author but when the <code>books</code> association is accessed a <code>LazyInitializationException</code> will be thrown because the underlying Hibernate session has been cleared.<p class="paragraph"/>To solve this problem you have a number of options. One is to ensure you query eagerly to get the data you will need:<p class="paragraph"/><div class="code"><pre>class AuthorService &#123;
    &#8230;
    void updateAge(id, <span class="java&#45;object">int</span> age) &#123;
        def author = Author.findById(id, &#91;fetch:&#91;books:<span class="java&#45;quote">"eager"</span>&#93;&#93;)
        ...</pre></div><p class="paragraph"/>In this example the <code>books</code> association will be queried when retrieving the <code>Author</code>.<p class="paragraph"/><blockquote class="note">
This is the optimal solution as it requires fewer queries then the following suggested solutions.
</blockquote><p class="paragraph"/>Another solution is to redirect the request after a transaction rollback:<p class="paragraph"/><div class="code"><pre>class AuthorController &#123;<p class="paragraph"/>    AuthorService authorService<p class="paragraph"/>    def updateAge() &#123;
        <span class="java&#45;keyword">try</span> &#123;
            authorService.updateAge(params.id, params.<span class="java&#45;object">int</span>(<span class="java&#45;quote">"age"</span>))
        &#125;
        <span class="java&#45;keyword">catch</span>(e) &#123;
            flash.message <span class="java&#45;quote">"Can't update age"</span>
            redirect action:<span class="java&#45;quote">"show"</span>, id:params.id
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case a new request will deal with retrieving the <code>Author</code> again. And, finally a third solution is to retrieve the data for the <code>Author</code> again to make sure the session remains in the correct state:<p class="paragraph"/><div class="code"><pre>class AuthorController &#123;<p class="paragraph"/>    def authorService<p class="paragraph"/>    def updateAge() &#123;
        <span class="java&#45;keyword">try</span> &#123;
            authorService.updateAge(params.id, params.<span class="java&#45;object">int</span>(<span class="java&#45;quote">"age"</span>))
        &#125;
        <span class="java&#45;keyword">catch</span>(e) &#123;
            def author = Author.read(params.id)
            render <span class="java&#45;quote">"Author books $&#123;author.books&#125;"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><h3>Validation Errors and Rollback</h3><p class="paragraph"/>A common use case is to rollback a transaction if there are validation errors. For example consider this service:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.validation.ValidationException<p class="paragraph"/>class AuthorService &#123;<p class="paragraph"/>    void updateAge(id, <span class="java&#45;object">int</span> age) &#123;
        def author = Author.get(id)
        author.age = age
        <span class="java&#45;keyword">if</span> (!author.validate()) &#123;
            <span class="java&#45;keyword">throw</span> <span class="java&#45;keyword">new</span> ValidationException(<span class="java&#45;quote">"Author is not valid"</span>, author.errors)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>To re-render the same view that a transaction was rolled back in you can re-associate the errors with a refreshed instance before rendering:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.validation.ValidationException<p class="paragraph"/>class AuthorController &#123;<p class="paragraph"/>    def authorService<p class="paragraph"/>    def updateAge() &#123;
        <span class="java&#45;keyword">try</span> &#123;
            authorService.updateAge(params.id, params.<span class="java&#45;object">int</span>(<span class="java&#45;quote">"age"</span>))
        &#125;
        <span class="java&#45;keyword">catch</span> (ValidationException e) &#123;
            def author = Author.read(params.id)
            author.errors = e.errors
            render view: <span class="java&#45;quote">"edit"</span>, model: &#91;author:author&#93;
        &#125;
    &#125;
&#125;</pre></div>


<a name="8.2 Scoped Services"><!-- Legacy link --></a>
<h2 id="scopedServices">8.2 Scoped Services</h2>
By default, access to service methods is not synchronised, so nothing prevents concurrent execution of those methods. In fact, because the service is a singleton and may be used concurrently, you should be very careful about storing state in a service. Or take the easy (and better) road and never store state in a service.<p class="paragraph"/>You can change this behaviour by placing a service in a particular scope. The supported scopes are:
<ul class="star">
<li><code>prototype</code> - A new service is created every time it is injected into another class</li>
<li><code>request</code> - A new service will be created per request</li>
<li><code>flash</code> - A new service will be created for the current and next request only</li>
<li><code>flow</code> - In web flows the service will exist for the scope of the flow</li>
<li><code>conversation</code> - In web flows the service will exist for the scope of the conversation. ie a root flow and its sub flows</li>
<li><code>session</code> - A service is created for the scope of a user session</li>
<li><code>singleton</code> (default) - Only one instance of the service ever exists</li>
</ul><p class="paragraph"/><blockquote class="note">
If your service is <code>flash</code>, <code>flow</code> or <code>conversation</code> scoped it must implement <code>java.io.Serializable</code> and can only be used in the context of a <a href="../guide/single.html#webflow" class="guide">Web Flow</a>
</blockquote><p class="paragraph"/>To enable one of the scopes, add a static scope property to your class whose value is one of the above, for example<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> scope = <span class="java&#45;quote">"flow"</span></pre></div>


<a name="8.3 Dependency Injection and Services"><!-- Legacy link --></a>
<h2 id="dependencyInjectionServices">8.3 Dependency Injection and Services</h2>
<h4>Dependency Injection Basics</h4><p class="paragraph"/>A key aspect of Grails services is the ability to use <a href="http://www.springframework.org/" target="blank">Spring Framework</a>'s dependency injection features. Grails supports "dependency injection by convention". In other words, you can use the property name representation of the class name of a service to automatically inject them into controllers, tag libraries, and so on.<p class="paragraph"/>As an example, given a service called <code>BookService</code>, if you define a property called <code>bookService</code> in a controller as follows:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def bookService
    &#8230;
&#125;</pre></div><p class="paragraph"/>In this case, the Spring container will automatically inject an instance of that service based on its configured scope. All dependency injection is done by name. You can also specify the type as follows:<p class="paragraph"/><div class="code"><pre>class AuthorService &#123;
    BookService bookService
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
NOTE: Normally the property name is generated by lower casing the first letter of the type.  For example, an instance of the <code>BookService</code> class would map to a property named <code>bookService</code>.<p class="paragraph"/>To be consistent with standard JavaBean conventions, if the first 2 letters of the class name are upper case, the property name is the same as the class name.  For example, the property name of the <code>JDBCHelperService</code> class would be <code>JDBCHelperService</code>, not <code>jDBCHelperService</code> or <code>jdbcHelperService</code>.<p class="paragraph"/>See section 8.8 of the JavaBean specification for more information on de-capitalization rules.
</blockquote><p class="paragraph"/><h4>Dependency Injection and Services</h4><p class="paragraph"/>You can inject services in other services with the same technique. If you had an <code>AuthorService</code> that needed to use the <code>BookService</code>, declaring the <code>AuthorService</code> as follows would allow that:<p class="paragraph"/><div class="code"><pre>class AuthorService &#123;
    def bookService
&#125;</pre></div><p class="paragraph"/><h4>Dependency Injection and Domain Classes / Tag Libraries</h4><p class="paragraph"/>You can even inject services into domain classes and tag libraries, which can aid in the development of rich domain models and views:<p class="paragraph"/><div class="code"><pre>class Book &#123;
    &#8230;
    def bookService<p class="paragraph"/>    def buyBook() &#123;
        bookService.buyBook(<span class="java&#45;keyword">this</span>)
    &#125;
&#125;</pre></div>


<a name="8.4 Using Services from Java"><!-- Legacy link --></a>
<h2 id="usingServicesFromJava">8.4 Using Services from Java</h2>
One of the powerful things about services is that since they encapsulate re-usable logic, you can use them from other classes, including Java classes. There are a couple of ways you can reuse a service from Java. The simplest way is to move your service into a package within the <code>grails-app/services</code> directory. The reason this is important is that it is not possible to import classes into Java from the default package (the package used when no package declaration is present). So for example the <code>BookService</code> below cannot be used from Java as it stands:<p class="paragraph"/><div class="code"><pre>class BookService &#123;
    void buyBook(Book book) &#123;
        // logic
    &#125;
&#125;</pre></div><p class="paragraph"/>However, this can be rectified by placing this class in a package, by moving the class into a sub directory such as <code>grails-app/services/bookstore</code> and then modifying the package declaration:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> bookstore<p class="paragraph"/>class BookService &#123;
    void buyBook(Book book) &#123;
        // logic
    &#125;
&#125;</pre></div><p class="paragraph"/>An alternative to packages is to instead have an interface within a package that the service implements:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> bookstore<p class="paragraph"/><span class="java&#45;keyword">interface</span> BookStore &#123;
    void buyBook(Book book)
&#125;</pre></div><p class="paragraph"/>And then the service:<p class="paragraph"/><div class="code"><pre>class BookService <span class="java&#45;keyword">implements</span> bookstore.BookStore &#123;
    void buyBook(Book b) &#123;
        // logic
    &#125;
&#125;</pre></div><p class="paragraph"/>This latter technique is arguably cleaner, as the Java side only has a reference to the interface and not to the implementation class (although it's always a good idea to use packages). Either way, the goal of this exercise to enable Java to statically resolve the class (or interface) to use, at compile time.<p class="paragraph"/>Now that this is done you can create a Java class within the <code>src/java</code> directory and add a setter that uses the type and the name of the bean in Spring:<p class="paragraph"/><div class="code"><pre>// src/java/bookstore/BookConsumer.java
<span class="java&#45;keyword">package</span> bookstore;<p class="paragraph"/><span class="java&#45;keyword">public</span> class BookConsumer &#123;<p class="paragraph"/>    <span class="java&#45;keyword">private</span> BookStore store;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> void setBookStore(BookStore storeInstance) &#123;
        <span class="java&#45;keyword">this</span>.store = storeInstance;
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>Once this is done you can configure the Java class as a Spring bean in <code>grails-app/conf/spring/resources.xml</code> (for more information see the section on <a href="../guide/single.html#spring" class="guide">Grails and Spring</a>):<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;bean id=<span class="xml&#45;quote">"bookConsumer"</span> class=<span class="xml&#45;quote">"bookstore.BookConsumer"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"bookStore"</span> ref=<span class="xml&#45;quote">"bookService"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/bean&#62;</span></pre></div><p class="paragraph"/>or in <code>grails-app/conf/spring/resources.groovy</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> bookstore.BookConsumer<p class="paragraph"/>beans = &#123;
    bookConsumer(BookConsumer) &#123;
        bookStore = ref(<span class="java&#45;quote">"bookService"</span>)
    &#125;
&#125;</pre></div>


<a name="9. Testing"><!-- Legacy link --></a>
<h1 id="testing">9 Testing</h1>
Automated testing is a key part of Grails. Hence, Grails provides many ways to making testing easier from low level unit testing to high level functional tests. This section details the different capabilities that Grails offers for testing.<p class="paragraph"/><blockquote class="note">
Grails 1.3.x and below used the <code>grails.test.GrailsUnitTestCase</code> class hierarchy for testing in a JUnit 3 style. Grails 2.0.x and above deprecates these test harnesses in favour of mixins that can be applied to a range of different kinds of tests (JUnit 3, Junit 4, Spock etc.) without subclassing
</blockquote><p class="paragraph"/>The first thing to be aware of is that all of the <code>create-&#42;</code> and <code>generate-&#42;</code> commands create <code>unit</code> or <code>integration</code> tests automatically. For example if you run the <a href="../ref/Command Line/create-controller.html" class="commandLine">create-controller</a> command as follows:<p class="paragraph"/><div class="code"><pre>grails create&#45;controller com.acme.app.simple</pre></div><p class="paragraph"/>Grails will create a controller at <code>grails-app/controllers/com/acme/app/SimpleController.groovy</code>, and also a unit test at <code>test/unit/com/acme/app/SimpleControllerTests.groovy</code>. What Grails won't do however is populate the logic inside the test! That is left up to you.<p class="paragraph"/><blockquote class="note">
The default class name suffix is <code>Tests</code> but as of Grails 1.2.2, the suffix of <code>Test</code> is also supported.
</blockquote><p class="paragraph"/><h4>Running Tests</h4><p class="paragraph"/>Test are run with the <a href="../ref/Command Line/test-app.html" class="commandLine">test-app</a> command:<p class="paragraph"/><div class="code"><pre>grails test&#45;app</pre></div><p class="paragraph"/>Note that you will be able to run unit tests much quicker if you use an IDE or if you use the "interactive mode" to start-up Grails, thus preventing the need to stop the JVM:<p class="paragraph"/><div class="code"><pre>grails
&#8230;
test&#45;app</pre></div><p class="paragraph"/>The <code>test-app</code> command will produce output such as:<p class="paragraph"/><div class="code"><pre>&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;
Running Unit Tests&#8230;
Running test FooTests...FAILURE
Unit Tests Completed in 464ms &#8230;
&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;<p class="paragraph"/>Tests failed: 0 errors, 1 failures</pre></div><p class="paragraph"/>Whilst reports will have been written out the <code>target/test-reports</code> directory.<p class="paragraph"/><blockquote class="note">
You can force a clean before running tests by passing <code>-clean</code> to the <code>test-app</code> command.
</blockquote><p class="paragraph"/><h4>Targeting Tests</h4><p class="paragraph"/>You can selectively target the test(s) to be run in different ways. To run all tests for a controller named <code>SimpleController</code> you would run:<p class="paragraph"/><div class="code"><pre>grails test&#45;app SimpleController</pre></div><p class="paragraph"/>This will run any tests for the class named <code>SimpleController</code>. Wildcards can be used...<p class="paragraph"/><div class="code"><pre>grails test&#45;app &#42;Controller</pre></div><p class="paragraph"/>This will test all classes ending in <code>Controller</code>. Package names can optionally be specified...<p class="paragraph"/><div class="code"><pre>grails test&#45;app some.org.&#42;Controller</pre></div><p class="paragraph"/>or to run all tests in a package...<p class="paragraph"/><div class="code"><pre>grails test&#45;app some.org.&#42;</pre></div><p class="paragraph"/>or to run all tests in a package including subpackages...<p class="paragraph"/><div class="code"><pre>grails test&#45;app some.org.&#42;&#42;.&#42;</pre></div><p class="paragraph"/>You can also target particular test methods...<p class="paragraph"/><div class="code"><pre>grails test&#45;app SimpleController.testLogin</pre></div><p class="paragraph"/>This will run the <code>testLogin</code> test in the <code>SimpleController</code> tests. You can specify as many patterns in combination as you like...<p class="paragraph"/><div class="code"><pre>grails test&#45;app some.org.&#42; SimpleController.testLogin BookController</pre></div><p class="paragraph"/><h4>Targeting Test Types and/or Phases</h4><p class="paragraph"/>In addition to targeting certain tests, you can also target test  <em class="italic">types</em>  and/or  <em class="italic">phases</em>  by using the <code>phase:type</code> syntax.<p class="paragraph"/><blockquote class="note">
Grails organises tests by phase and by type. A test phase relates to the state of the Grails application during the tests, and the type relates to the testing mechanism.<p class="paragraph"/>Grails comes with support for 4 test phases (<code>unit</code>, <code>integration</code>, <code>functional</code> and <code>other</code>) and JUnit test types for the <code>unit</code> and <code>integration</code> phases. These test types have the same name as the phase.<p class="paragraph"/>Testing plugins may provide new test phases or new test types for existing phases. Refer to the plugin documentation.
</blockquote><p class="paragraph"/>To execute the JUnit <code>integration</code> tests you can run:<p class="paragraph"/><div class="code"><pre>grails test&#45;app integration:integration</pre></div><p class="paragraph"/>Both <code>phase</code> and <code>type</code> are optional. Their absence acts as a wildcard. The following command will run all test types in the <code>unit</code> phase:<p class="paragraph"/><div class="code"><pre>grails test&#45;app unit:</pre></div><p class="paragraph"/>The Grails <a href="http://grails.org/plugin/spock" target="blank">Spock Plugin</a> is one plugin that adds new test types to Grails. It adds a <code>spock</code> test type to the <code>unit</code>, <code>integration</code> and <code>functional</code> phases. To run all spock tests in all phases you would run the following:<p class="paragraph"/><div class="code"><pre>grails test&#45;app :spock</pre></div><p class="paragraph"/>To run the all of the spock tests in the <code>functional</code> phase you would run...<p class="paragraph"/><div class="code"><pre>grails test&#45;app functional:spock</pre></div><p class="paragraph"/>More than one pattern can be specified...<p class="paragraph"/><div class="code"><pre>grails test&#45;app unit:spock integration:spock</pre></div><p class="paragraph"/><h4>Targeting Tests in Types and/or Phases</h4><p class="paragraph"/>Test and type/phase targetting can be applied at the same time:<p class="paragraph"/><div class="code"><pre>grails test&#45;app integration: unit: some.org.&#42;&#42;.&#42;</pre></div><p class="paragraph"/>This would run all tests in the <code>integration</code> and <code>unit</code> phases that are in the package <code>some.org</code> or a subpackage.


<a name="9.1 Unit Testing"><!-- Legacy link --></a>
<h2 id="unitTesting">9.1 Unit Testing</h2>
Unit testing are tests at the "unit" level. In other words you are testing individual methods or blocks of code without consideration for surrounding infrastructure. Unit tests are typically run without the presence of physical resources that involve I/O such databases, socket connections or files. This is to ensure they run as quick as possible since quick feedback is important.<p class="paragraph"/>Since Grails 2.0, a collection of unit testing mixins is provided by Grails that lets you enhance the behavior of a typical JUnit 3, JUnit 4 or Spock test. The following sections cover the usage of these mixins.<p class="paragraph"/><blockquote class="note">
The previous JUnit 3-style <code>GrailsUnitTestCase</code> class hierarchy is still present in Grails for backwards compatibility, but is now deprecated. The previous documentation on the subject can be found in the <a href="http://grails.org/doc/1.3.x/guide/9.%20Testing.html" target="blank">Grails 1.3.x documentation</a>
</blockquote>


<a name="9.1.1 Unit Testing Controllers"><!-- Legacy link --></a>
<h2 id="unitTestingControllers">9.1.1 Unit Testing Controllers</h2>
<h4>The Basics</h4><p class="paragraph"/>You use the <code>grails.test.mixin.TestFor</code> annotation to unit test controllers. Using <code>TestFor</code> in this manner activates the <code>grails.test.mixin.web.ControllerUnitTestMixin</code> and its associated API. For example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.test.mixin.TestFor<p class="paragraph"/>@TestFor(SimpleController)
class SimpleControllerTests &#123;
    void testSomething() &#123;<p class="paragraph"/>    &#125;
&#125;</pre></div><p class="paragraph"/>Adding the <code>TestFor</code> annotation to a controller causes a new <code>controller</code> field to be automatically created for the controller under test.<p class="paragraph"/><blockquote class="note">
The <code>TestFor</code> annotation will also automatically annotate any public methods starting with "test" with JUnit 4's @Test annotation. If any of your test method don't start with "test" just add this manually
</blockquote><p class="paragraph"/>To test the simplest "Hello World"-style example you can do the following:<p class="paragraph"/><div class="code"><pre>// Test class
class SimpleController &#123;
    def hello() &#123;
        render <span class="java&#45;quote">"hello"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>void testHello() &#123;
    controller.hello()<p class="paragraph"/>    assert response.text == 'hello'
&#125;</pre></div><p class="paragraph"/>The <code>response</code> object is an instance of <code>org.codehaus.groovy.grails.plugins.testing.GrailsMockHttpServletResponse</code> which extends Spring's <code>org.springframework.mock.web.MockHttpServletResponse</code> and has a number of useful methods for inspecting the state of the response.<p class="paragraph"/>For example to test a redirect you can use the <code>redirectUrl</code> property:<p class="paragraph"/><div class="code"><pre>// Test class
class SimpleController &#123;
    def index() &#123;
        redirect action: 'hello'
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>void testIndex() &#123;
    controller.index()<p class="paragraph"/>    assert response.redirectedUrl == '/simple/hello'
&#125;</pre></div><p class="paragraph"/><h4>Testing View Rendering</h4><p class="paragraph"/>To test view rendering you can inspect the state of the controller's <code>modelAndView</code> property (an instance of <code>org.springframework.web.servlet.ModelAndView</code>) or you can use the <code>view</code> and <code>model</code> properties provided by the mixin:<p class="paragraph"/><div class="code"><pre>// Test class
class SimpleController &#123;
    def home() &#123;
        render view: <span class="java&#45;quote">"homePage"</span>, model: &#91;title: <span class="java&#45;quote">"Hello World"</span>&#93;
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>void testIndex() &#123;
    controller.home()<p class="paragraph"/>    assert view == <span class="java&#45;quote">"/simple/homePage"</span>
    assert model.title == <span class="java&#45;quote">"Hello World"</span>
&#125;</pre></div><p class="paragraph"/><h4>Testing Template Rendering</h4><p class="paragraph"/>Unlike view rendering, template rendering will actually attempt to write the template directly to the response rather than returning a <code>ModelAndView</code> hence it requires a different approach to testing.<p class="paragraph"/>Consider the following controller action:<p class="paragraph"/><div class="code"><pre>class SimpleController &#123;
    def display() &#123;
        render template:<span class="java&#45;quote">"snippet"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example the controller will look for a template in <code>grails-app/views/simple/_snippet.gsp</code>. You can test this as follows:<p class="paragraph"/><div class="code"><pre>void testDisplay() &#123;
    controller.display()
    assert response.text == 'contents of template'
&#125;</pre></div><p class="paragraph"/>However, you may not want to render the real template, but just test that is was rendered. In this case you can provide mock Groovy Pages:<p class="paragraph"/><div class="code"><pre>void testDisplay() &#123;
    views&#91;'/simple/_snippet.gsp'&#93; = 'mock contents'
    controller.display()
    assert response.text == 'mock contents'
&#125;</pre></div><p class="paragraph"/><h4>Testing XML and JSON Responses</h4><p class="paragraph"/>XML and JSON response are also written directly to the response. Grails' mocking capabilities provide some conveniences for testing XML and JSON response. For example consider the following action:<p class="paragraph"/><div class="code"><pre>def renderXml() &#123;
    render(contentType:<span class="java&#45;quote">"text/xml"</span>) &#123;
        book(title:<span class="java&#45;quote">"Great"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>This can be tested using the <code>xml</code> property of the response:<p class="paragraph"/><div class="code"><pre>void testRenderXml() &#123;
    controller.renderXml()
    assert <span class="java&#45;quote">"&#60;book title='Great'/&#62;"</span> == response.text
    assert <span class="java&#45;quote">"Great"</span> == response.xml.@title.text()
&#125;</pre></div><p class="paragraph"/>The <code>xml</code> property is a parsed result from Groovy's <a href="http://groovy.codehaus.org/Reading+XML+using+Groovy's+XmlSlurper" target="blank">XmlSlurper</a> class which is very convenient for parsing XML.<p class="paragraph"/>Testing JSON responses is pretty similar, instead you use the <code>json</code> property:<p class="paragraph"/><div class="code"><pre>// controller action
def renderJson() &#123;
    render(contentType:<span class="java&#45;quote">"text/json"</span>) &#123;
        book = <span class="java&#45;quote">"Great"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>// test
void testRenderJson() &#123;<p class="paragraph"/>    controller.renderJson()<p class="paragraph"/>    assert '&#123;<span class="java&#45;quote">"book"</span>:<span class="java&#45;quote">"Great"</span>&#125;' == response.text
    assert <span class="java&#45;quote">"Great"</span> == response.json.book
&#125;</pre></div><p class="paragraph"/>The <code>json</code> property is an instance of <code>org.codehaus.groovy.grails.web.json.JSONElement</code> which is a map-like structure that is useful for parsing JSON responses.<p class="paragraph"/><h4>Testing XML and JSON Requests</h4><p class="paragraph"/>Grails provides various convenient ways to automatically parse incoming XML and JSON packets. For example you can bind incoming JSON or XML requests using Grails' data binding:<p class="paragraph"/><div class="code"><pre>def consumeBook() &#123;
    def b = <span class="java&#45;keyword">new</span> Book(params&#91;'book'&#93;)<p class="paragraph"/>    render b.title
&#125;</pre></div><p class="paragraph"/>To test this Grails provides an easy way to specify an XML or JSON packet via the <code>xml</code> or <code>json</code> properties. For example the above action can be tested by specifying a String containing the XML:<p class="paragraph"/><div class="code"><pre>void testConsumeBookXml() &#123;
    request.xml = '&#60;book&#62;&#60;title&#62;The Shining&#60;/title&#62;&#60;/book&#62;'
    controller.consumeBook()<p class="paragraph"/>    assert response.text == 'The Shining'
&#125;</pre></div><p class="paragraph"/>Or alternatively a domain instance can be specified and it will be auto-converted into the appropriate XML request:<p class="paragraph"/><div class="code"><pre>void testConsumeBookXml() &#123;
    request.xml = <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Shining"</span>)
    controller.consumeBook()<p class="paragraph"/>    assert response.text == 'The Shining'
&#125;</pre></div><p class="paragraph"/>The same can be done for JSON requests:<p class="paragraph"/><div class="code"><pre>void testConsumeBookJson() &#123;
    request.json = <span class="java&#45;keyword">new</span> Book(title:<span class="java&#45;quote">"The Shining"</span>)
    controller.consumeBook()<p class="paragraph"/>    assert response.text == 'The Shining'
&#125;</pre></div><p class="paragraph"/>If you prefer not to use Grails' data binding but instead manually parse the incoming XML or JSON that can be tested too. For example consider the controller action below:<p class="paragraph"/><div class="code"><pre>def consume() &#123;
    request.withFormat &#123;
        xml &#123;
            render request.XML.@title
        &#125;
        json &#123;
            render request.JSON.title
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>To test the XML request you can specify the XML as a string:<p class="paragraph"/><div class="code"><pre>void testConsumeXml() &#123;
    request.xml = '&#60;book title=<span class="java&#45;quote">"The Stand"</span> /&#62;'<p class="paragraph"/>    controller.consume()<p class="paragraph"/>    assert response.text == 'The Stand'
&#125;</pre></div><p class="paragraph"/>And, of course, the same can be done for JSON:<p class="paragraph"/><div class="code"><pre>void testConsumeJson() &#123;
    request.json = '&#123;title:<span class="java&#45;quote">"The Stand"</span>&#125;'
    controller.consume()<p class="paragraph"/>    assert response.text == 'The Stand'
&#125;</pre></div><p class="paragraph"/><h4>Testing Spring Beans</h4><p class="paragraph"/>When using <code>TestFor</code> only a subset of the Spring beans available to a running Grails application are available. If you wish to make additional beans available you can do so with the <code>defineBeans</code> method of <code>GrailsUnitTestMixin</code>:<p class="paragraph"/><div class="code"><pre>class SimpleController &#123;
    SimpleService simpleService
    def hello() &#123;
        render simpleService.sayHello()
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>void testBeanWiring() &#123;
    defineBeans &#123;
        simpleService(SimpleService)
    &#125;<p class="paragraph"/>    controller.hello()<p class="paragraph"/>    assert response.text == <span class="java&#45;quote">"Hello World"</span>
&#125;</pre></div><p class="paragraph"/>The controller is auto-wired by Spring just like in a running Grails application. Autowiring even occurs if you instantiate subsequent instances of the controller:<p class="paragraph"/><div class="code"><pre>void testAutowiringViaNew() &#123;
    defineBeans &#123;
        simpleService(SimpleService)
    &#125;<p class="paragraph"/>    def controller1 = <span class="java&#45;keyword">new</span> SimpleController()
    def controller2 = <span class="java&#45;keyword">new</span> SimpleController()<p class="paragraph"/>    assert controller1.simpleService != <span class="java&#45;keyword">null</span>
    assert controller2.simpleService != <span class="java&#45;keyword">null</span>
&#125;</pre></div><p class="paragraph"/><h4>Testing Mime Type Handling</h4><p class="paragraph"/>You can test mime type handling and the <code>withFormat</code> method quite simply by setting the response's <code>format</code> attribute:<p class="paragraph"/><div class="code"><pre>// controller action
def sayHello() &#123;
    def data = &#91;Hello:<span class="java&#45;quote">"World"</span>&#93;
    withFormat &#123;
        xml &#123; render data as XML &#125;
        html data
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>// test
void testSayHello() &#123;
    response.format = 'xml'
    controller.sayHello()<p class="paragraph"/>    <span class="java&#45;object">String</span> expected = '&#60;?xml version=<span class="java&#45;quote">"1.0"</span> encoding=<span class="java&#45;quote">"UTF&#45;8"</span>?&#62;' +
                      '&#60;map&#62;&#60;entry key=<span class="java&#45;quote">"Hello"</span>&#62;World&#60;/entry&#62;&#60;/map&#62;'<p class="paragraph"/>    assert expected == response.text
&#125;</pre></div><p class="paragraph"/><h4>Testing Duplicate Form Submissions</h4><p class="paragraph"/>Testing duplicate form submissions is a little bit more involved. For example if you have an action that handles a form such as:<p class="paragraph"/><div class="code"><pre>def handleForm() &#123;
    withForm &#123;
        render <span class="java&#45;quote">"Good"</span>
    &#125;.invalidToken &#123;
        render <span class="java&#45;quote">"Bad"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>you want to verify the logic that is executed on a good form submission and the logic that is executed on a duplicate submission. Testing the bad submission is simple. Just invoke the controller:<p class="paragraph"/><div class="code"><pre>void testDuplicateFormSubmission() &#123;
    controller.handleForm()
    assert <span class="java&#45;quote">"Bad"</span> == response.text
&#125;</pre></div><p class="paragraph"/>Testing the successful submission requires providing an appropriate <code>SynchronizerToken</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.web.servlet.mvc.SynchronizerToken
...<p class="paragraph"/>void testValidFormSubmission() &#123;
    def token = SynchronizerToken.store(session)
    params&#91;SynchronizerToken.KEY&#93; = token.currentToken.toString()<p class="paragraph"/>    controller.handleForm()
    assert <span class="java&#45;quote">"Good"</span> == response.text
&#125;</pre></div><p class="paragraph"/>If you test both the valid and the invalid request in the same test be sure to reset the response between executions of the controller:<p class="paragraph"/><div class="code"><pre>controller.handleForm() // first execution
&#8230;
response.reset()
&#8230;
controller.handleForm() // second execution</pre></div><p class="paragraph"/><h4>Testing File Upload</h4><p class="paragraph"/>You use the <code>GrailsMockMultipartFile</code> class to test file uploads. For example consider the following controller action:<p class="paragraph"/><div class="code"><pre>def uploadFile() &#123;
    MultipartFile file = request.getFile(<span class="java&#45;quote">"myFile"</span>)
    file.transferTo(<span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/local/disk/myFile"</span>))
&#125;</pre></div><p class="paragraph"/>To test this action you can register a <code>GrailsMockMultipartFile</code> with the request:<p class="paragraph"/><div class="code"><pre>void testFileUpload() &#123;
    <span class="java&#45;keyword">final</span> file = <span class="java&#45;keyword">new</span> GrailsMockMultipartFile(<span class="java&#45;quote">"myFile"</span>, <span class="java&#45;quote">"foo"</span>.bytes)
    request.addFile(file)
    controller.uploadFile()<p class="paragraph"/>    assert file.targetFileLocation.path == <span class="java&#45;quote">"/local/disk/myFile"</span>
&#125;</pre></div><p class="paragraph"/>The <code>GrailsMockMultipartFile</code> constructor arguments are the name and contents of the file. It has a mock implementation of the <code>transferTo</code> method that simply records the <code>targetFileLocation</code> and doesn't write to disk.<p class="paragraph"/><h4>Testing Command Objects</h4><p class="paragraph"/>Special support exists for testing command object handling with the <code>mockCommandObject</code> method. For example consider the following action:<p class="paragraph"/><div class="code"><pre>def handleCommand(SimpleCommand simple) &#123;
    <span class="java&#45;keyword">if</span> (simple.hasErrors()) &#123;
        render <span class="java&#45;quote">"Bad"</span>
    &#125;
    <span class="java&#45;keyword">else</span> &#123;
        render <span class="java&#45;quote">"Good"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>To test this you mock the command object, populate it and then validate it as follows:<p class="paragraph"/><div class="code"><pre>void testInvalidCommand() &#123;
    def cmd = mockCommandObject(SimpleCommand)
    cmd.name = '' // doesn't allow blank names<p class="paragraph"/>    cmd.validate()
    controller.handleCommand(cmd)<p class="paragraph"/>    assert response.text == 'Bad'
&#125;</pre></div><p class="paragraph"/><h4>Testing Calling Tag Libraries</h4><p class="paragraph"/>You can test calling tag libraries using <code>ControllerUnitTestMixin</code>, although the mechanism for testing the tag called varies from tag to tag. For example to test a call to the <code>message</code> tag, add a message to the <code>messageSource</code>. Consider the following action:<p class="paragraph"/><div class="code"><pre>def showMessage() &#123;
    render g.message(code: <span class="java&#45;quote">"foo.bar"</span>)
&#125;</pre></div><p class="paragraph"/>This can be tested as follows:<p class="paragraph"/><div class="code"><pre>void testRenderBasicTemplateWithTags() &#123;
    messageSource.addMessage(<span class="java&#45;quote">"foo.bar"</span>, request.locale, <span class="java&#45;quote">"Hello World"</span>)<p class="paragraph"/>    controller.showMessage()<p class="paragraph"/>    assert response.text == <span class="java&#45;quote">"Hello World"</span>
&#125;</pre></div>


<a name="9.1.2 Unit Testing Tag Libraries"><!-- Legacy link --></a>
<h2 id="unitTestingTagLibraries">9.1.2 Unit Testing Tag Libraries</h2>
<h4>The Basics</h4><p class="paragraph"/>Tag libraries and GSP pages can be tested with the <code>grails.test.mixin.web.GroovyPageUnitTestMixin</code> mixin. To use the mixin declare which tag library is under test with the <code>TestFor</code> annotation:<p class="paragraph"/><div class="code"><pre>@TestFor(SimpleTagLib)
class SimpleTagLibTests &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>Note that if you are testing invocation of a custom tag from a controller you can combine the <code>ControllerUnitTestMixin</code> and the <code>GroovyPageUnitTestMixin</code> using the <code>Mock</code> annotation:<p class="paragraph"/><div class="code"><pre>@TestFor(SimpleController)
@Mock(SimpleTagLib)
class GroovyPageUnitTestMixinTests &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/><h4>Testing Custom Tags</h4><p class="paragraph"/>The core Grails tags don't need to be enabled during testing, however custom tag libraries do. The <code>GroovyPageUnitTestMixin</code> class provides a <code>mockTagLib()</code> method that you can use to mock a custom tag library. For example consider the following tag library:<p class="paragraph"/><div class="code"><pre>class SimpleTagLib &#123;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> namespace = 's'<p class="paragraph"/>    def hello = &#123; attrs, body &#45;&#62;
        out &#60;&#60; <span class="java&#45;quote">"Hello $&#123;attrs.name ?: 'World'&#125;"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>You can test this tag library by using <code>TestFor</code> and supplying the name of the tag library:<p class="paragraph"/><div class="code"><pre>@TestFor(SimpleTagLib)
class SimpleTagLibTests &#123;
    void testHelloTag() &#123;
        assert applyTemplate('&#60;s:hello /&#62;') == 'Hello World'
        assert applyTemplate('&#60;s:hello name=<span class="java&#45;quote">"Fred"</span> /&#62;') == 'Hello Fred'
    &#125;
&#125;</pre></div><p class="paragraph"/>Alternatively, you can use the <code>TestMixin</code> annotation and mock multiple tag libraries using the <code>mockTagLib()</code> method:<p class="paragraph"/><div class="code"><pre>@grails.test.mixin.TestMixin(GroovyPageUnitTestMixin)
class MultipleTagLibraryTests &#123;<p class="paragraph"/>    @Test
    void testMuliple() &#123;
        mockTagLib(FirstTagLib)
        mockTagLib(SecondTagLib)<p class="paragraph"/>        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>GroovyPageUnitTestMixin</code> provides convenience methods for asserting that the template output equals or matches an expected value.<p class="paragraph"/><div class="code"><pre>@grails.test.mixin.TestMixin(GroovyPageUnitTestMixin)
class MultipleTagLibraryTests &#123;<p class="paragraph"/>    @Test
    void testMuliple() &#123;
        mockTagLib(FirstTagLib)
        mockTagLib(SecondTagLib)
        assertOutputEquals ('Hello World', '&#60;s:hello /&#62;')
        assertOutputMatches (/.&#42;Fred.&#42;/, '&#60;s:hello name=<span class="java&#45;quote">"Fred"</span> /&#62;')
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Testing View and Template Rendering</h4><p class="paragraph"/>You can test rendering of views and templates in <code>grails-app/views</code> via the <code>render(Map)</code> method provided by <code>GroovyPageUnitTestMixin</code> :<p class="paragraph"/><div class="code"><pre>def result = render(template: <span class="java&#45;quote">"/simple/hello"</span>)
assert result == <span class="java&#45;quote">"Hello World"</span></pre></div><p class="paragraph"/>This will attempt to render a template found at the location <code>grails-app/views/simple/_hello.gsp</code>. Note that if the template depends on any custom tag libraries you need to call <code>mockTagLib</code> as described in the previous section.


<a name="9.1.3 Unit Testing Domains"><!-- Legacy link --></a>
<h2 id="unitTestingDomains">9.1.3 Unit Testing Domains</h2>
<h4>Overview</h4><p class="paragraph"/><blockquote class="note">
The mocking support described here is best used when testing non-domain artifacts that use domain classes, to let you focus on testing the artifact without needing a database. But when testing persistence it's best to use integration tests which configure Hibernate and use a database.
</blockquote><p class="paragraph"/>Domain class interaction can be tested without involving a database connection using <code>DomainClassUnitTestMixin</code>. This implementation mimics the behavior of GORM against an in-memory <code>ConcurrentHashMap</code> implementation. Note that this has limitations compared to a real GORM implementation. The following features of GORM for Hibernate can only be tested within an integration test:
<ul class="star">
<li>String-based HQL queries</li>
<li>composite identifiers</li>
<li>dirty checking methods</li>
<li>any direct interaction with Hibernate</li>
</ul><p class="paragraph"/>However a large, commonly-used portion of the GORM API can be mocked using <code>DomainClassUnitTestMixin</code> including:
<ul class="star">
<li>Simple persistence methods like <code>save()</code>, <code>delete()</code> etc.</li>
<li>Dynamic Finders</li>
<li>Named Queries</li>
<li>Query-by-example</li>
<li>GORM Events</li>
</ul><p class="paragraph"/>If something isn't supported then <code>GrailsUnitTestMixin</code>'s <code>mockFor</code> method can come in handy to mock the missing pieces. Alternatively you can write an integration test which bootstraps the complete Grails environment at a cost of test execution time.<p class="paragraph"/><h4>The Basics</h4><p class="paragraph"/><code>DomainClassUnitTestMixin</code> is typically used in combination with testing either a controller, service or tag library where the domain is a mock collaborator defined by the <code>Mock</code> annotation:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.test.mixin.&#42;<p class="paragraph"/>@TestFor(SimpleController)
@Mock(Simple)
class SimpleControllerTests &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>The example above tests the <code>SimpleController</code> class and mocks the behavior of the <code>Simple</code> domain class as well. For example consider a typical scaffolded <code>save</code> controller action:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    def save() &#123;
        def book = <span class="java&#45;keyword">new</span> Book(params)
        <span class="java&#45;keyword">if</span> (book.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
            flash.message = message(
                    code: '<span class="java&#45;keyword">default</span>.created.message',
                    args: &#91;message(code: 'book.label',
                                   <span class="java&#45;keyword">default</span>: 'Book'), book.id&#93;)&#125;<span class="java&#45;quote">"
            redirect(action: "</span>show<span class="java&#45;quote">", id: book.id)
        &#125;
        <span class="java&#45;keyword">else</span> &#123;
            render(view: "</span>create", model: &#91;bookInstance: book&#93;)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Tests for this action can be written as follows:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.test.mixin.&#42;<p class="paragraph"/>@TestFor(BookController)
@Mock(Book)
class BookControllerTests &#123;<p class="paragraph"/>    void testSaveInvalidBook() &#123;
        controller.save()<p class="paragraph"/>        assert model.bookInstance != <span class="java&#45;keyword">null</span>
        assert view == '/book/create'
    &#125;<p class="paragraph"/>    void testSaveValidBook() &#123;
        params.title = <span class="java&#45;quote">"The Stand"</span>
        params.pages = <span class="java&#45;quote">"500"</span><p class="paragraph"/>        controller.save()<p class="paragraph"/>        assert response.redirectedUrl == '/book/show/1'
        assert flash.message != <span class="java&#45;keyword">null</span>
        assert Book.count() == 1
    &#125;
&#125;</pre></div><p class="paragraph"/><code>Mock</code> annotation also supports a list of mock collaborators if you have more than one domain to mock:<p class="paragraph"/><div class="code"><pre>@TestFor(BookController)
@Mock(&#91;Book, Author&#93;)
class BookControllerTests &#123;
   &#8230;
&#125;</pre></div><p class="paragraph"/>Alternatively you can also use the <code>DomainClassUnitTestMixin</code> directly with the <code>TestMixin</code> annotation:<p class="paragraph"/><div class="code"><pre>@TestFor(BookController)
@TestMixin(DomainClassUnitTestMixin)
class BookControllerTests &#123;
   &#8230;
&#125;</pre></div><p class="paragraph"/>And then call the <code>mockDomain</code> method to mock domains during your test:<p class="paragraph"/><div class="code"><pre>void testSave() &#123;
    mockDomain(Author)
    mockDomain(Book)
&#125;</pre></div><p class="paragraph"/>The <code>mockDomain</code> method also includes an additional parameter that lets you pass a Map of Maps to configure a domain, which is useful for fixture-like data:<p class="paragraph"/><div class="code"><pre>void testSave() &#123;
    mockDomain(Book, &#91;
            &#91;title: <span class="java&#45;quote">"The Stand"</span>, pages: 1000&#93;,
            &#91;title: <span class="java&#45;quote">"The Shining"</span>, pages: 400&#93;,
            &#91;title: <span class="java&#45;quote">"Along Came a Spider"</span>, pages: 300&#93; &#93;)
&#125;</pre></div><p class="paragraph"/><h4>Testing Constraints</h4><p class="paragraph"/>Your constraints contain logic and that logic is highly susceptible to bugs - the kind of bugs that can be tricky to track down (particularly as by default <code>save()</code> doesn't throw an exception when it fails). If your answer is that it's too hard or fiddly, that is no longer an excuse. Enter the <code>mockForConstraintsTests()</code> method.<p class="paragraph"/>This method is like a much reduced version of the <code>mockDomain()</code> method that simply adds a <code>validate()</code> method to a given domain class. All you have to do is mock the class, create an instance with populated data, and then call <code>validate()</code>. You can then access the <code>errors</code> property to determine if validation failed. So if all we are doing is mocking the <code>validate()</code> method, why the optional list of test instances? That is so that we can test the <code>unique</code> constraint as you will soon see.<p class="paragraph"/>So, suppose we have a simple domain class:<p class="paragraph"/><div class="code"><pre>class Book &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> title
    <span class="java&#45;object">String</span> author<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        title blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        author blank: <span class="java&#45;keyword">false</span>, minSize: 5
    &#125;
&#125;</pre></div><p class="paragraph"/>Don't worry about whether the constraints are sensible (they're not!), they are for demonstration only. To test these constraints we can do the following:<p class="paragraph"/><div class="code"><pre>@TestFor(Book)
class BookTests &#123;
    void testConstraints() &#123;<p class="paragraph"/>        def existingBook = <span class="java&#45;keyword">new</span> Book(
                title: <span class="java&#45;quote">"Misery"</span>,
                author: <span class="java&#45;quote">"Stephen King"</span>)<p class="paragraph"/>        mockForConstraintsTests(Book, &#91;existingBook&#93;)<p class="paragraph"/>        // validation should fail <span class="java&#45;keyword">if</span> both properties are <span class="java&#45;keyword">null</span>
        def book = <span class="java&#45;keyword">new</span> Book()<p class="paragraph"/>        assert !book.validate()
        assert <span class="java&#45;quote">"nullable"</span> == book.errors&#91;<span class="java&#45;quote">"title"</span>&#93;
        assert <span class="java&#45;quote">"nullable"</span> == book.errors&#91;<span class="java&#45;quote">"author"</span>&#93;<p class="paragraph"/>        // So let's demonstrate the unique and minSize constraints<p class="paragraph"/>        book = <span class="java&#45;keyword">new</span> Book(title: <span class="java&#45;quote">"Misery"</span>, author: <span class="java&#45;quote">"JK"</span>)
        assert !book.validate()
        assert <span class="java&#45;quote">"unique"</span> == book.errors&#91;<span class="java&#45;quote">"title"</span>&#93;
        assert <span class="java&#45;quote">"minSize"</span> == book.errors&#91;<span class="java&#45;quote">"author"</span>&#93;<p class="paragraph"/>        // Validation should pass!
        book = <span class="java&#45;keyword">new</span> Book(title: <span class="java&#45;quote">"The Shining"</span>, author: <span class="java&#45;quote">"Stephen King"</span>)
        assert book.validate()
    &#125;
&#125;</pre></div><p class="paragraph"/>You can probably look at that code and work out what's happening without any further explanation. The one thing we will explain is the way the <code>errors</code> property is used. First, is a real Spring <code>Errors</code> instance, so you can access all the properties and methods you would normally expect. Second, this particular <code>Errors</code> object also has map/property access as shown. Simply specify the name of the field you are interested in and the map/property access will return the name of the constraint that was violated. Note that it is the constraint name, not the message code (as you might expect).<p class="paragraph"/>That's it for testing constraints. One final thing we would like to say is that testing the constraints in this way catches a common error: typos in the "constraints" property name! It is currently one of the hardest bugs to track down normally, and yet a unit test for your constraints will highlight the problem straight away.


<a name="9.1.4 Unit Testing Filters"><!-- Legacy link --></a>
<h2 id="unitTestingFilters">9.1.4 Unit Testing Filters</h2>
Unit testing filters is typically a matter of testing a controller where a filter is a mock collaborator. For example consider the following filters class:<p class="paragraph"/><div class="code"><pre>class CancellingFilters &#123;
    def filters = &#123;
        all(controller:<span class="java&#45;quote">"simple"</span>, action:<span class="java&#45;quote">"list"</span>) &#123;
            before = &#123;
                redirect(controller:<span class="java&#45;quote">"book"</span>)
                <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>This filter interceptors the <code>list</code> action of the <code>simple</code> controller and redirects to the <code>book</code> controller. To test this filter you start off with a test that targets the <code>SimpleController</code> class and add the <code>CancellingFilters</code> as a mock collaborator:<p class="paragraph"/><div class="code"><pre>@TestFor(SimpleController)
@Mock(CancellingFilters)
class SimpleControllerTests &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>You can then implement a test that uses the <code>withFilters</code> method to wrap the call to an action in filter execution:<p class="paragraph"/><div class="code"><pre>void testInvocationOfListActionIsFiltered() &#123;
    withFilters(action:<span class="java&#45;quote">"list"</span>) &#123;
        controller.list()
    &#125;
    assert response.redirectedUrl == '/book'
&#125;</pre></div><p class="paragraph"/>Note that the <code>action</code> parameter is required because it is unknown what the action to invoke is until the action is actually called. The <code>controller</code> parameter is optional and taken from the controller under test. If it is a another controller you are testing then you can specify it:<p class="paragraph"/><div class="code"><pre>withFilters(controller:<span class="java&#45;quote">"book"</span>,action:<span class="java&#45;quote">"list"</span>) &#123;
    controller.list()
&#125;</pre></div>


<a name="9.1.5 Unit Testing URL Mappings"><!-- Legacy link --></a>
<h2 id="unitTestingURLMappings">9.1.5 Unit Testing URL Mappings</h2>
<h4>The Basics</h4><p class="paragraph"/>Testing URL mappings can be done with the <code>TestFor</code> annotation testing a particular URL mappings class. For example to test the default URL mappings you can do the following:<p class="paragraph"/><div class="code"><pre>@TestFor(UrlMappings)
class UrlMappingsTests &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/><blockquote class="note">
Note that since the default <code>UrlMappings</code> class is in the default package your test must also be in the default package
</blockquote><p class="paragraph"/>With that done there are a number of useful methods that are defined by the <code>grails.test.mixin.web.UrlMappingsUnitTestMixin</code> for testing URL mappings. These include:
<ul class="star">
<li><code>assertForwardUrlMapping</code> - Asserts a URL mapping is forwarded for the given controller class (note that controller will need to be defined as a mock collaborate for this to work)</li>
<li><code>assertReverseUrlMapping</code> - Asserts that the given URL is produced when reverse mapping a link to a given controller and action</li>
<li><code>assertUrlMapping</code> - Asserts a URL mapping is valid for the given URL. This combines the <code>assertForwardUrlMapping</code> and <code>assertReverseUrlMapping</code> assertions</li>
</ul><p class="paragraph"/><h4>Asserting Forward URL Mappings</h4><p class="paragraph"/>You use <code>assertForwardUrlMapping</code> to assert that a given URL maps to a given controller. For example, consider the following URL mappings:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
    <span class="java&#45;quote">"/action1"</span>(controller: <span class="java&#45;quote">"simple"</span>, action: <span class="java&#45;quote">"action1"</span>)
    <span class="java&#45;quote">"/action2"</span>(controller: <span class="java&#45;quote">"simple"</span>, action: <span class="java&#45;quote">"action2"</span>)
&#125;</pre></div><p class="paragraph"/>The following test can be written to assert these URL mappings:<p class="paragraph"/><div class="code"><pre>void testUrlMappings() &#123;<p class="paragraph"/>    assertForwardUrlMapping(<span class="java&#45;quote">"/action1"</span>, controller: 'simple',
                                        action: <span class="java&#45;quote">"action1"</span>)<p class="paragraph"/>    assertForwardUrlMapping(<span class="java&#45;quote">"/action2"</span>, controller: 'simple',
                                        action: <span class="java&#45;quote">"action2"</span>)<p class="paragraph"/>    shouldFail &#123;
        assertForwardUrlMapping(<span class="java&#45;quote">"/action2"</span>, controller: 'simple',
                                            action: <span class="java&#45;quote">"action1"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Assert Reverse URL Mappings</h4><p class="paragraph"/>You use <code>assertReverseUrlMapping</code> to check that correct links are produced for your URL mapping when using the <code>link</code> tag in GSP views. An example test is largely identical to the previous listing except you use <code>assertReverseUrlMapping</code> instead of <code>assertForwardUrlMapping</code>. Note that you can combine these 2 assertions with <code>assertUrlMapping</code>.<p class="paragraph"/><h4>Simulating Controller Mapping</h4><p class="paragraph"/>In addition to the assertions to check the validity of URL mappings you can also simulate mapping to a controller by using your <code>UrlMappings</code> as a mock collaborator and the <code>mapURI</code> method. For example:<p class="paragraph"/><div class="code"><pre>@TestFor(SimpleController)
@Mock(UrlMappings)
class SimpleControllerTests &#123;<p class="paragraph"/>    void testControllerMapping() &#123;<p class="paragraph"/>        SimpleController controller = mapURI('/simple/list')
        assert controller != <span class="java&#45;keyword">null</span><p class="paragraph"/>        def model = controller.list()
        assert model != <span class="java&#45;keyword">null</span>
    &#125;
&#125;</pre></div>


<a name="9.1.6 Mocking Collaborators"><!-- Legacy link --></a>
<h2 id="mockingCollaborators">9.1.6 Mocking Collaborators</h2>
Beyond the specific targeted mocking APIs there is also an all-purpose <code>mockFor()</code> method that is available when using the <code>TestFor</code> annotation. The signature of <code>mockFor</code> is:<p class="paragraph"/><div class="code"><pre>mockFor(class, loose = <span class="java&#45;keyword">false</span>)</pre></div><p class="paragraph"/>This is general-purpose mocking that lets you set up either strict or loose demands on a class.<p class="paragraph"/>This method is surprisingly intuitive to use. By default it will create a strict mock control object (one for which the order in which methods are called is important) that you can use to specify demands:<p class="paragraph"/><div class="code"><pre>def strictControl = mockFor(MyService)
strictControl.demand.someMethod(0..2) &#123; <span class="java&#45;object">String</span> arg1, <span class="java&#45;object">int</span> arg2 &#45;&#62; &#8230; &#125;
strictControl.demand.<span class="java&#45;keyword">static</span>.aStaticMethod &#123;&#45;&#62; &#8230; &#125;</pre></div><p class="paragraph"/>Notice that you can mock static as well as instance methods by using the "static" property. You then specify the name of the method to mock, with an optional range argument. This range determines how many times you expect the method to be called, and if the number of invocations falls outside of that range (either too few or too many) then an assertion error will be thrown. If no range is specified, a default of "1..1" is assumed, i.e. that the method must be called exactly once.<p class="paragraph"/>The last part of a demand is a closure representing the implementation of the mock method. The closure arguments must match the number and types of the mocked method, but otherwise you are free to add whatever you want in the body.<p class="paragraph"/>As we mentioned before, call <code>mockControl.createMock()</code> to get an actual mock instance of the class that you are mocking. You can call this multiple times to create as many mock instances as you need. And once you have executed the test method, call <code>mockControl.verify()</code> to check that the expected methods were called.<p class="paragraph"/>Lastly, the call:<p class="paragraph"/><div class="code"><pre>def looseControl = mockFor(MyService, <span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>will create a mock control object that has only loose expectations, i.e. the order that methods are invoked does not matter.


<a name="9.2 Integration Testing"><!-- Legacy link --></a>
<h2 id="integrationTesting">9.2 Integration Testing</h2>
Integration tests differ from unit tests in that you have full access to the Grails environment within the test. Grails uses an in-memory H2 database for integration tests and clears out all the data from the database between tests.<p class="paragraph"/>One thing to bear in mind is that logging is enabled for your application classes, but it is different from logging in tests. So if you have something like this:<p class="paragraph"/><div class="code"><pre>class MyServiceTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;
    void testSomething() &#123;
        log.info <span class="java&#45;quote">"Starting tests"</span>
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>the "starting tests" message is logged using a different system than the one used by the application. The <code>log</code> property in the example above is an instance of <code>java.util.logging.Logger</code> (inherited from the base class, not injected by Grails), which doesn't have the same methods as the <code>log</code> property injected into your application artifacts. For example, it doesn't have <code>debug()</code> or <code>trace()</code> methods, and the equivalent of <code>warn()</code> is in fact <code>warning()</code>.<p class="paragraph"/><h4>Transactions</h4><p class="paragraph"/>Integration tests run inside a database transaction by default, which is rolled back at the end of the each test. This means that data saved during a test is not persisted to the database. Add a <code>transactional</code> property to your test class to check transactional behaviour:<p class="paragraph"/><div class="code"><pre>class MyServiceTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;
    <span class="java&#45;keyword">static</span> transactional = <span class="java&#45;keyword">false</span><p class="paragraph"/>    void testMyTransactionalServiceMethod() &#123;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>Be sure to remove any persisted data from a non-transactional test, for example in the <code>tearDown</code> method, so these tests don't interfere with standard transactional tests that expect a clean database.<p class="paragraph"/><h4>Testing Controllers</h4><p class="paragraph"/>To test controllers you first have to understand the Spring Mock Library.<p class="paragraph"/>Grails automatically configures each test with a <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/mock/web/MockHttpServletRequest.html" class="api">MockHttpServletRequest</a>, <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/mock/web/MockHttpServletResponse.html" class="api">MockHttpServletResponse</a>, and <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/mock/web/MockHttpSession.html" class="api">MockHttpSession</a> that you can use in your tests. For example consider the following controller:<p class="paragraph"/><div class="code"><pre>class FooController &#123;<p class="paragraph"/>    def text() &#123;
        render <span class="java&#45;quote">"bar"</span>
    &#125;<p class="paragraph"/>    def someRedirect() &#123;
        redirect(action:<span class="java&#45;quote">"bar"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>The tests for this would be:<p class="paragraph"/><div class="code"><pre>class FooControllerTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;<p class="paragraph"/>    void testText() &#123;
        def fc = <span class="java&#45;keyword">new</span> FooController()
        fc.text()
        assertEquals <span class="java&#45;quote">"bar"</span>, fc.response.contentAsString
    &#125;<p class="paragraph"/>    void testSomeRedirect() &#123;
        def fc = <span class="java&#45;keyword">new</span> FooController()
        fc.someRedirect()
        assertEquals <span class="java&#45;quote">"/foo/bar"</span>, fc.response.redirectedUrl
    &#125;
&#125;</pre></div><p class="paragraph"/>In the above case <code>response</code> is an instance of <code>MockHttpServletResponse</code> which we can use to obtain the generated content with <code>contentAsString</code> (when writing to the response) or the redirected URL. These mocked versions of the Servlet API are completely mutable (unlike the real versions) and hence you can set properties on the request such as the <code>contextPath</code> and so on.<p class="paragraph"/>Grails <strong class="bold">does not</strong> invoke <a href="../guide/single.html#interceptors" class="guide">interceptors</a> or servlet filters when calling actions during integration testing. You should test interceptors and filters in isolation, using <a href="../guide/single.html#functionalTesting" class="guide">functional testing</a> if necessary.<p class="paragraph"/><h4>Testing Controllers with Services</h4><p class="paragraph"/>If your controller references a service (or other Spring beans), you have to explicitly initialise the service from your test.<p class="paragraph"/>Given a controller using a service:<p class="paragraph"/><div class="code"><pre>class FilmStarsController &#123;
    def popularityService<p class="paragraph"/>    def update() &#123;
        // <span class="java&#45;keyword">do</span> something with popularityService
    &#125;
&#125;</pre></div><p class="paragraph"/>The test for this would be:<p class="paragraph"/><div class="code"><pre>class FilmStarsTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;
    def popularityService<p class="paragraph"/>    void testInjectedServiceInController () &#123;
        def fsc = <span class="java&#45;keyword">new</span> FilmStarsController()
        fsc.popularityService = popularityService
        fsc.update()
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Testing Controller Command Objects</h4><p class="paragraph"/>With command objects you just supply parameters to the request and it will automatically do the command object work for you when you call your action with no parameters:<p class="paragraph"/>Given a controller using a command object:<p class="paragraph"/><div class="code"><pre>class AuthenticationController &#123;
    def signup(SignupForm form) &#123;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>You can then test it like this:<p class="paragraph"/><div class="code"><pre>def controller = <span class="java&#45;keyword">new</span> AuthenticationController()
controller.params.login = <span class="java&#45;quote">"marcpalmer"</span>
controller.params.password = <span class="java&#45;quote">"secret"</span>
controller.params.passwordConfirm = <span class="java&#45;quote">"secret"</span>
controller.signup()</pre></div><p class="paragraph"/>Grails auto-magically sees your call to <code>signup()</code> as a call to the action and populates the command object from the mocked request parameters. During controller testing, the <code>params</code> are mutable with a mocked request supplied by Grails.<p class="paragraph"/><h4>Testing Controllers and the render Method</h4><p class="paragraph"/>The <a href="../ref/Controllers/render.html" class="controllers">render</a> method lets you render a custom view at any point within the body of an action. For instance, consider the example below:<p class="paragraph"/><div class="code"><pre>def save() &#123;
    def book = Book(params)
    <span class="java&#45;keyword">if</span> (book.save()) &#123;
        // handle
    &#125;
    <span class="java&#45;keyword">else</span> &#123;
        render(view:<span class="java&#45;quote">"create"</span>, model:&#91;book:book&#93;)
    &#125;
&#125;</pre></div><p class="paragraph"/>In the above example the result of the model of the action is not available as the return value, but instead is stored within the <code>modelAndView</code> property of the controller. The <code>modelAndView</code> property is an instance of Spring MVC's <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/servlet/ModelAndView.html" target="blank">ModelAndView</a> class and you can use it to the test the result of an action:<p class="paragraph"/><div class="code"><pre>def bookController = <span class="java&#45;keyword">new</span> BookController()
bookController.save()
def model = bookController.modelAndView.model.book</pre></div><p class="paragraph"/><h4>Simulating Request Data</h4><p class="paragraph"/>You can use the Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/mock/web/MockHttpServletRequest.html" class="api">MockHttpServletRequest</a> to test an action that requires request data, for example a REST web service. For example consider this action which performs data binding from an incoming request:<p class="paragraph"/><div class="code"><pre>def create() &#123;
    &#91;book: <span class="java&#45;keyword">new</span> Book(params.book)&#93;
&#125;</pre></div><p class="paragraph"/>To simulate the 'book' parameter as an XML request you could do something like the following:<p class="paragraph"/><div class="code"><pre>void testCreateWithXML() &#123;<p class="paragraph"/>    def controller = <span class="java&#45;keyword">new</span> BookController()<p class="paragraph"/>    controller.request.contentType = 'text/xml'
    controller.request.content = '''&#92;&#10;            &#60;?xml version=<span class="java&#45;quote">"1.0"</span> encoding=<span class="java&#45;quote">"ISO&#45;8859&#45;1"</span>?&#62;
            &#60;book&#62;
                &#60;title&#62;The Stand&#60;/title&#62;
                &#8230;
            &#60;/book&#62;
            '''.stripIndent().getBytes() // note we need the bytes<p class="paragraph"/>    def model = controller.create()
    assert model.book
    assertEquals <span class="java&#45;quote">"The Stand"</span>, model.book.title
&#125;</pre></div><p class="paragraph"/>The same can be achieved with a JSON request:<p class="paragraph"/><div class="code"><pre>void testCreateWithJSON() &#123;<p class="paragraph"/>    def controller = <span class="java&#45;keyword">new</span> BookController()<p class="paragraph"/>    controller.request.contentType = <span class="java&#45;quote">"text/json"</span>
    controller.request.content =
            '&#123;<span class="java&#45;quote">"id"</span>:1,<span class="java&#45;quote">"class"</span>:<span class="java&#45;quote">"Book"</span>,<span class="java&#45;quote">"title"</span>:<span class="java&#45;quote">"The Stand"</span>&#125;'.getBytes()<p class="paragraph"/>    def model = controller.create()
    assert model.book
    assertEquals <span class="java&#45;quote">"The Stand"</span>, model.book.title
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
With JSON don't forget the <code>class</code> property to specify the name the target type to bind to. In XML this is implicit within the name of the <code>&#60;book&#62;</code> node, but this property is required as part of the JSON packet.
</blockquote><p class="paragraph"/>For more information on the subject of REST web services see the section on <a href="../guide/single.html#REST" class="guide">REST</a>.<p class="paragraph"/><h4>Testing Web Flows</h4><p class="paragraph"/>Testing <a href="../guide/single.html#webflow" class="guide">Web Flows</a> requires a special test harness called <code>grails.test.WebFlowTestCase</code> which subclasses Spring Web Flow's <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/webflow/test/execution/AbstractFlowExecutionTests.html" class="api">AbstractFlowExecutionTests</a> class.<p class="paragraph"/><blockquote class="note">
Subclasses of <code>WebFlowTestCase</code> <strong class="bold">must</strong> be integration tests
</blockquote><p class="paragraph"/>For example given this simple flow:<p class="paragraph"/><div class="code"><pre>class ExampleController &#123;<p class="paragraph"/>    def exampleFlow() &#123;
        start &#123;
            on(<span class="java&#45;quote">"go"</span>) &#123;
                flow.hello = <span class="java&#45;quote">"world"</span>
            &#125;.to <span class="java&#45;quote">"next"</span>
        &#125;
        next &#123;
            on(<span class="java&#45;quote">"back"</span>).to <span class="java&#45;quote">"start"</span>
            on(<span class="java&#45;quote">"go"</span>).to <span class="java&#45;quote">"subber"</span>
        &#125;
        subber &#123;
            subflow(action: <span class="java&#45;quote">"sub"</span>)
            on(<span class="java&#45;quote">"end"</span>).to(<span class="java&#45;quote">"end"</span>)
        &#125;
        end()
    &#125;<p class="paragraph"/>    def subFlow() &#123;
        subSubflowState &#123;
            subflow(controller: <span class="java&#45;quote">"other"</span>, action: <span class="java&#45;quote">"otherSub"</span>)
            on(<span class="java&#45;quote">"next"</span>).to(<span class="java&#45;quote">"next"</span>)
        &#125;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>You need to tell the test harness what to use for the "flow definition". This is done via overriding the abstract <code>getFlow</code>
 method:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.test.WebFlowTestCase<p class="paragraph"/>class ExampleFlowTests <span class="java&#45;keyword">extends</span> WebFlowTestCase &#123;
    def getFlow() &#123; <span class="java&#45;keyword">new</span> ExampleController().exampleFlow &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>You can specify the flow id by overriding the <code>getFlowId</code> method, otherwise the default is <code>test</code>:
<div class="code"><pre><span class="java&#45;keyword">import</span> grails.test.WebFlowTestCase<p class="paragraph"/>class ExampleFlowTests <span class="java&#45;keyword">extends</span> WebFlowTestCase &#123;
    <span class="java&#45;object">String</span> getFlowId() &#123; <span class="java&#45;quote">"example"</span> &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>If the flow under test calls any subflows, these (or mocks) must be registered before the calling the flow:
<div class="code"><pre><span class="java&#45;keyword">protected</span> void setUp() &#123;
    <span class="java&#45;keyword">super</span>.setUp()<p class="paragraph"/>    registerFlow(<span class="java&#45;quote">"other/otherSub"</span>) &#123; // register a simplified mock
        start &#123;
            on(<span class="java&#45;quote">"next"</span>).to(<span class="java&#45;quote">"end"</span>)
        &#125;
        end()
    &#125;<p class="paragraph"/>    // register the original subflow
    registerFlow(<span class="java&#45;quote">"example/sub"</span>, <span class="java&#45;keyword">new</span> ExampleController().subFlow)
&#125;</pre></div><p class="paragraph"/>Then you kick off the flow with the <code>startFlow</code> method:<p class="paragraph"/><div class="code"><pre>void testExampleFlow() &#123;
    def viewSelection = startFlow()
    &#8230;
&#125;</pre></div><p class="paragraph"/>Use the <code>signalEvent</code> method to trigger an event:<p class="paragraph"/><div class="code"><pre>void testExampleFlow() &#123;
    &#8230;
    signalEvent(<span class="java&#45;quote">"go"</span>)
    assert <span class="java&#45;quote">"next"</span> == flowExecution.activeSession.state.id
    assert <span class="java&#45;quote">"world"</span> == flowScope.hello
&#125;</pre></div><p class="paragraph"/>Here we have signaled to the flow to execute the event "go" which causes a transition to the "next" state. In the example a transition action placed a <code>hello</code> variable into the flow scope.<p class="paragraph"/><h4>Testing Tag Libraries</h4><p class="paragraph"/>Testing tag libraries is simple because when a tag is invoked as a method it returns its result as a string (technically a <code>StreamCharBuffer</code> but this class implements all of the methods of <code>String</code>). So for example if you have a tag library like this:<p class="paragraph"/><div class="code"><pre>class FooTagLib &#123;<p class="paragraph"/>    def bar = &#123; attrs, body &#45;&#62;
        out &#60;&#60; <span class="java&#45;quote">"&#60;p&#62;Hello World!&#60;/p&#62;"</span>
    &#125;<p class="paragraph"/>    def bodyTag = &#123; attrs, body &#45;&#62;
        out &#60;&#60; <span class="java&#45;quote">"&#60;&#36;&#123;attrs.name&#125;&#62;"</span>
        out &#60;&#60; body()
        out &#60;&#60; <span class="java&#45;quote">"&#60;/&#36;&#123;attrs.name&#125;&#62;"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The tests would look like:<p class="paragraph"/><div class="code"><pre>class FooTagLibTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;<p class="paragraph"/>    void testBarTag() &#123;
        assertEquals <span class="java&#45;quote">"&#60;p&#62;Hello World!&#60;/p&#62;"</span>,
                     <span class="java&#45;keyword">new</span> FooTagLib().bar(<span class="java&#45;keyword">null</span>, <span class="java&#45;keyword">null</span>).toString()
    &#125;<p class="paragraph"/>    void testBodyTag() &#123;
        assertEquals <span class="java&#45;quote">"&#60;p&#62;Hello World!&#60;/p&#62;"</span>,
                     <span class="java&#45;keyword">new</span> FooTagLib().bodyTag(name: <span class="java&#45;quote">"p"</span>) &#123;
                         <span class="java&#45;quote">"Hello World!"</span>
                     &#125;.toString()
    &#125;
&#125;</pre></div><p class="paragraph"/>Notice that for the second example, <code>testBodyTag</code>, we pass a block that returns the body of the tag. This is convenient to representing the body as a String.<p class="paragraph"/><h4>Testing Tag Libraries with GroovyPagesTestCase</h4><p class="paragraph"/>In addition to doing simple testing of tag libraries like in the above examples, you can also use the <code>grails.test.GroovyPagesTestCase</code> class to test tag libraries with integration tests.<p class="paragraph"/>The <code>GroovyPagesTestCase</code> class is a subclass of the standard <code>GroovyTestCase</code> class and adds utility methods for testing the output of GSP rendering.<p class="paragraph"/><blockquote class="note">
<code>GroovyPagesTestCase</code> can only be used in an integration test.
</blockquote><p class="paragraph"/>For example, consider this date formatting tag library:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> java.text.SimpleDateFormat<p class="paragraph"/>class FormatTagLib &#123;
    def dateFormat = &#123; attrs, body &#45;&#62;
        out &#60;&#60; <span class="java&#45;keyword">new</span> SimpleDateFormat(attrs.format) &#60;&#60; attrs.date
    &#125;
&#125;</pre></div><p class="paragraph"/>This can be easily tested as follows:<p class="paragraph"/><div class="code"><pre>class FormatTagLibTests <span class="java&#45;keyword">extends</span> GroovyPagesTestCase &#123;
    void testDateFormat() &#123;
        def template =
                '&#60;g:dateFormat format=<span class="java&#45;quote">"dd&#45;MM&#45;yyyy"</span> date=<span class="java&#45;quote">"&#36;&#123;myDate&#125;"</span> /&#62;'<p class="paragraph"/>        def testDate = &#8230; // create the date
        assertOutputEquals('01&#45;01&#45;2008', template, &#91;myDate:testDate&#93;)
    &#125;
&#125;</pre></div><p class="paragraph"/>You can also obtain the result of a GSP using the <code>applyTemplate</code> method of the <code>GroovyPagesTestCase</code> class:<p class="paragraph"/><div class="code"><pre>class FormatTagLibTests <span class="java&#45;keyword">extends</span> GroovyPagesTestCase &#123;
    void testDateFormat() &#123;
        def template =
                '&#60;g:dateFormat format=<span class="java&#45;quote">"dd&#45;MM&#45;yyyy"</span> date=<span class="java&#45;quote">"&#36;&#123;myDate&#125;"</span> /&#62;'<p class="paragraph"/>        def testDate = &#8230; // create the date
        def result = applyTemplate(template, &#91;myDate:testDate&#93;)<p class="paragraph"/>        assertEquals '01&#45;01&#45;2008', result
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Testing Domain Classes</h4><p class="paragraph"/>Testing domain classes is typically a simple matter of using the <a href="../guide/single.html#GORM" class="guide">GORM API</a>, but there are a few things to be aware of. Firstly, when testing queries you often need to "flush" to ensure the correct state has been persisted to the database. For example take the following example:<p class="paragraph"/><div class="code"><pre>void testQuery() &#123;
    def books = &#91;
            <span class="java&#45;keyword">new</span> Book(title: <span class="java&#45;quote">"The Stand"</span>),
            <span class="java&#45;keyword">new</span> Book(title: <span class="java&#45;quote">"The Shining"</span>)&#93;
    books&#42;.save()<p class="paragraph"/>    assertEquals 2, Book.list().size()
&#125;</pre></div><p class="paragraph"/>This test will fail because calling <a href="../ref/Domain Classes/save.html" class="domainClasses">save</a> does not actually persist the <code>Book</code> instances when called. Calling <code>save</code> only indicates to Hibernate that at some point in the future these instances should be persisted. To commit changes immediately you "flush" them:<p class="paragraph"/><div class="code"><pre>void testQuery() &#123;
    def books = &#91;
            <span class="java&#45;keyword">new</span> Book(title: <span class="java&#45;quote">"The Stand"</span>),
            <span class="java&#45;keyword">new</span> Book(title: <span class="java&#45;quote">"The Shining"</span>)&#93;
    books&#42;.save(flush: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>    assertEquals 2, Book.list().size()
&#125;</pre></div><p class="paragraph"/>In this case since we're passing the argument <code>flush</code> with a value of <code>true</code> the updates will be persisted immediately and hence will be available to the query later on.


<a name="9.3 Functional Testing"><!-- Legacy link --></a>
<h2 id="functionalTesting">9.3 Functional Testing</h2>
Functional tests involve making HTTP requests against the running application and verifying the resultant behaviour. Grails does not ship with any support for writing functional tests directly, but there are several plugins available for this.
<ul class="star">
<li><code>Canoo Webtest</code> - <a href="http://grails.org/plugin/webtest" target="blank">http://grails.org/plugin/webtest</a></li>
<li><code>G-Func</code> - <a href="http://grails.org/plugin/functional-test" target="blank">http://grails.org/plugin/functional-test</a></li>
<li><code>Geb</code> - <a href="http://grails.org/plugin/geb" target="blank">http://grails.org/plugin/geb</a></li>
<li><code>Selenium-RC</code> - <a href="http://grails.org/plugin/selenium-rc" target="blank">http://grails.org/plugin/selenium-rc</a></li>
<li><code>WebDriver</code> - <a href="http://grails.org/plugin/webdriver" target="blank">http://grails.org/plugin/webdriver</a></li>
</ul><p class="paragraph"/>Consult the documentation for each plugin for its capabilities.<p class="paragraph"/><h4>Common Options</h4><p class="paragraph"/>There are options that are common to all plugins that control how the Grails application is launched, if at all.<p class="paragraph"/><h5>inline</h5><p class="paragraph"/>The <code>-inline</code> option specifies that the grails application should be started inline (i.e. like <code>run-app</code>).<p class="paragraph"/><strong class="bold">This option is implicitly set unless the <code>baseUrl</code> or <code>war</code> options are set</strong><p class="paragraph"/><h5>war</h5><p class="paragraph"/>The <code>-war</code> option specifies that the grails application should be packaged as a war and started. This is useful as it tests your application in a production-like state, but it has a longer startup time than the <code>-inline</code> option. It also runs the war in a forked JVM, meaning that you cannot access any internal application objects.<p class="paragraph"/><div class="code"><pre>grails test&#45;app functional: &#45;war</pre></div><p class="paragraph"/>Note that the same build/config options for the <a href="../ref/Command Line/run-war.html" class="commandLine">run-war</a> command apply to functional testing against the WAR.<p class="paragraph"/><h5>https</h5><p class="paragraph"/>The <code>-https</code> option results in the application being able to receive https requests as well as http requests. It is compatible with both the <code>-inline</code> and <code>-war</code> options.<p class="paragraph"/><div class="code"><pre>grails test&#45;app functional: &#45;https</pre></div><p class="paragraph"/>Note that this does not change the test  <em class="italic">base url</em>  to be https, it will still be http unless the <code>-httpsBaseUrl</code> option is also given.<p class="paragraph"/><h5>httpsBaseUrl</h5><p class="paragraph"/>The <code>-httpsBaseUrl</code> causes the implicit base url to be used for tests to be a https url.<p class="paragraph"/><div class="code"><pre>grails test&#45;app functional: &#45;httpsBaseUrl</pre></div><p class="paragraph"/>This option is ignored if the <code>-baseUrl</code> option is specified.<p class="paragraph"/><h5>baseUrl</h5><p class="paragraph"/>The <code>baseUrl</code> option allows the base url for tests to be specified.<p class="paragraph"/><div class="code"><pre>grails test&#45;app functional: &#45;baseUrl=http://mycompany.com/grailsapp</pre></div><p class="paragraph"/>This option will prevent the local grails application being started unless <code>-inline</code> or <code>-war</code> are given as well. To use a custom base url but still test against the local Grails application you <strong class="bold">must</strong> specify one of either the <code>-inline</code> or <code>-war</code> options.


<a name="10. Internationalization"><!-- Legacy link --></a>
<h1 id="i18n">10 Internationalization</h1>
Grails supports Internationalization (i18n) out of the box by leveraging the underlying Spring MVC internationalization support. With Grails you are able to customize the text that appears in a view based on the user's Locale. To quote the javadoc for the <a href="http://download.oracle.com/javase/1.5.0/docs/api/java/util/Locale.html" class="api">Locale</a> class:<p class="paragraph"/><blockquote class="quote">
A Locale object represents a specific geographical, political, or cultural region. An operation that requires a Locale to perform its task is called locale-sensitive and uses the Locale  to tailor information for the user. For example, displaying a number is a locale-sensitive operation--the number should be formatted according to the customs/conventions of the user's native country, region, or culture.
</blockquote><p class="paragraph"/>A Locale is made up of a <a href="http://www.loc.gov/standards/iso639-2/englangn.html" target="blank">language code</a> and a <a href="http://www.iso.ch/iso/en/prods-services/iso3166ma/02iso-3166-code-lists/list-en1.html" target="blank">country code</a>. For example "en_US" is the code for US english, whilst "en_GB" is the for British English.


<a name="10.1 Understanding Message Bundles"><!-- Legacy link --></a>
<h2 id="understandingMessageBundles">10.1 Understanding Message Bundles</h2>
Now that you have an idea of locales, to use them in Grails you create message bundle file containing the different languages that you wish to render. Message bundles in Grails are located inside the <code>grails-app/i18n</code> directory and are simple Java properties files.<p class="paragraph"/>Each bundle starts with the name <code>messages</code> by convention and ends with the locale. Grails ships with several message bundles for a whole range of languages within the <code>grails-app/i18n</code> directory. For example:<p class="paragraph"/><div class="code"><pre>messages.properties
messages_da.properties
messages_de.properties
messages_es.properties
messages_fr.properties
...</pre></div><p class="paragraph"/>By default Grails looks in <code>messages.properties</code> for messages unless the user has specified a locale. You can create your own message bundle by simply creating a new properties file that ends with the locale you are interested. For example <code>messages_en_GB.properties</code> for British English.


<a name="10.2 Changing Locales"><!-- Legacy link --></a>
<h2 id="changingLocales">10.2 Changing Locales</h2>
By default the user locale is detected from the incoming <code>Accept-Language</code> header. However, you can provide users the capability to switch locales by simply passing a parameter called <code>lang</code> to Grails as a request parameter:<p class="paragraph"/><div class="code"><pre>/book/list?lang=es</pre></div><p class="paragraph"/>Grails will automatically switch the user's locale and store it in a cookie so subsequent requests will have the new header.


<a name="10.3 Reading Messages"><!-- Legacy link --></a>
<h2 id="readingMessages">10.3 Reading Messages</h2>
<h4>Reading Messages in the View</h4><p class="paragraph"/>The most common place that you need messages is inside the view. Use the <a href="../ref/Tags/message.html" class="tags">message</a> tag for this:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:message code=<span class="xml&#45;quote">"my.localized.content"</span> /&#62;</span></pre></div><p class="paragraph"/>As long as you have a key in your <code>messages.properties</code> (with appropriate locale suffix) such as the one below then Grails will look up the message:<p class="paragraph"/><div class="code"><pre>my.localized.content=Hola, Me llamo John. Hoy es domingo.</pre></div><p class="paragraph"/>Messages can also include arguments, for example:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:message code=<span class="xml&#45;quote">"my.localized.content"</span> args=<span class="xml&#45;quote">"$&#123; &#91;'Juan', 'lunes'&#93; &#125;"</span> /&#62;</span></pre></div><p class="paragraph"/>The message declaration specifies positional parameters which are dynamically specified:<p class="paragraph"/><div class="code"><pre>my.localized.content=Hola, Me llamo &#123;0&#125;. Hoy es &#123;1&#125;.</pre></div><p class="paragraph"/><h4>Reading Messages in Controllers and Tag Libraries</h4><p class="paragraph"/>It's simple to read messages in a controller since you can invoke tags as methods:<p class="paragraph"/><div class="code"><pre>def show() &#123;
    def msg = message(code: <span class="java&#45;quote">"my.localized.content"</span>, args: &#91;'Juan', 'lunes'&#93;)
&#125;</pre></div><p class="paragraph"/>The same technique can be used in <a href="../guide/single.html#taglibs" class="guide">tag libraries</a>, but if your tag library uses a custom <a href="../guide/single.html#namespaces" class="guide">namespace</a> then you must prefix the call with <code>g.</code>:<p class="paragraph"/><div class="code"><pre>def myTag = &#123; attrs, body &#45;&#62;
    def msg = g.message(code: <span class="java&#45;quote">"my.localized.content"</span>, args: &#91;'Juan', 'lunes'&#93;)
&#125;</pre></div>


<a name="10.4 Scaffolding and i18n"><!-- Legacy link --></a>
<h2 id="scaffoldingAndI18n">10.4 Scaffolding and i18n</h2>
Grails <a href="../guide/single.html#scaffolding" class="guide">scaffolding</a> templates for controllers and views are fully i18n-aware. The GSPs use the <a href="../ref/Tags/message.html" class="tags">message</a> tag for labels, buttons etc. and controller <code>flash</code> messages use i18n to resolve locale-specific messages.

<a name="11. Security"><!-- Legacy link --></a>
<h1 id="security">11 Security</h1>
Grails is no more or less secure than Java Servlets. However, Java servlets (and hence Grails) are extremely secure and largely immune to common buffer overrun and malformed URL exploits due to the nature of the Java Virtual Machine underpinning the code.<p class="paragraph"/>Web security problems typically occur due to developer naivety or mistakes, and there is a little Grails can do to avoid common mistakes and make writing secure applications easier to write.<p class="paragraph"/><h4>What Grails Automatically Does</h4><p class="paragraph"/>Grails has a few built in safety mechanisms by default.
<ol>
<li>All standard database access via <a href="../guide/single.html#GORM" class="guide">GORM</a> domain objects is automatically SQL escaped to prevent SQL injection attacks</li>
<li>The default <a href="../guide/single.html#scaffolding" class="guide">scaffolding</a> templates HTML escape all data fields when displayed</li>
<li>Grails link creating tags (<a href="../ref/Tags/link.html" class="tags">link</a>, <a href="../ref/Tags/form.html" class="tags">form</a>, <a href="../ref/Tags/createLink.html" class="tags">createLink</a>, <a href="../ref/Tags/createLinkTo.html" class="tags">createLinkTo</a> and others) all use appropriate escaping mechanisms to prevent code injection</li>
<li>Grails provides <a href="../guide/single.html#codecs" class="guide">codecs</a> to let you trivially escape data when rendered as HTML, JavaScript and URLs to prevent injection attacks here.</li>
</ol><p class="paragraph"/>

<a name="11.1 Securing Against Attacks"><!-- Legacy link --></a>
<h2 id="securingAgainstAttacks">11.1 Securing Against Attacks</h2>
<h4>SQL injection</h4><p class="paragraph"/>Hibernate, which is the technology underlying GORM domain classes, automatically escapes data when committing to database so this is not an issue. However it is still possible to write bad dynamic HQL code that uses unchecked request parameters. For example doing the following is vulnerable to HQL injection attacks:<p class="paragraph"/><div class="code"><pre>def vulnerable() &#123;
    def books = Book.find(<span class="java&#45;quote">"from Book as b where b.title ='"</span> + params.title + <span class="java&#45;quote">"'"</span>)
&#125;</pre></div><p class="paragraph"/>or the analagous call using a GString:<p class="paragraph"/><div class="code"><pre>def vulnerable() &#123;
    def books = Book.find(<span class="java&#45;quote">"from Book as b where b.title ='$&#123;params.title&#125;'"</span>)
&#125;</pre></div><p class="paragraph"/>Do <strong class="bold">not</strong> do this. Use named or positional parameters instead to pass in parameters:<p class="paragraph"/><div class="code"><pre>def safe() &#123;
    def books = Book.find(<span class="java&#45;quote">"from Book as b where b.title = ?"</span>,
                          &#91;params.title&#93;)
&#125;</pre></div><p class="paragraph"/>or<p class="paragraph"/><div class="code"><pre>def safe() &#123;
    def books = Book.find(<span class="java&#45;quote">"from Book as b where b.title = :title"</span>,
                          &#91;title: params.title&#93;)
&#125;</pre></div><p class="paragraph"/><h4>Phishing</h4><p class="paragraph"/>This really a public relations issue in terms of avoiding hijacking of your branding and a declared communication policy with your customers. Customers need to know how to identify valid emails.<p class="paragraph"/><h4>XSS - cross-site scripting injection</h4><p class="paragraph"/>It is important that your application verifies as much as possible that incoming requests were originated from your application and not from another site. Ticketing and page flow systems can help this and Grails' support for <a href="http://www.springsource.org/webflow" target="blank">Spring Web Flow</a> includes security like this by default.<p class="paragraph"/>It is also important to ensure that all data values rendered into views are escaped correctly. For example when rendering to HTML or XHTML you must call <a href="../guide/single.html#codecs" class="guide">encodeAsHTML</a> on every object to ensure that people cannot maliciously inject JavaScript or other HTML into data or tags viewed by others. Grails supplies several <a href="../guide/single.html#codecs" class="guide">Dynamic Encoding Methods</a> for this purpose and if your output escaping format is not supported you can easily write your own codec.<p class="paragraph"/>You must also avoid the use of request parameters or data fields for determining the next URL to redirect the user to. If you use a <code>successURL</code> parameter for example to determine where to redirect a user to after a successful login, attackers can imitate your login procedure using your own site, and then redirect the user back to their own site once logged in, potentially allowing JavaScript code to then exploit the logged-in account on the site.<p class="paragraph"/><h4>Cross-site request forgery</h4><p class="paragraph"/>CSRF involves unauthorized commands being transmitted from a user that a website trusts. A typical example would be another website embedding a link to perform an action on your website if the user is still authenticated.<p class="paragraph"/>The best way to decrease risk against these types of attacks is to use the <code>useToken</code> attribute on your forms. See <a href="../guide/single.html#formtokens" class="guide">Handling Duplicate Form Submissions</a> for more information on how to use it. An additional measure would be to not use remember-me cookies.<p class="paragraph"/><h4>HTML/URL injection</h4><p class="paragraph"/>This is where bad data is supplied such that when it is later used to create a link in a page, clicking it will not cause the expected behaviour, and may redirect to another site or alter request parameters.<p class="paragraph"/>HTML/URL injection is easily handled with the <a href="../guide/single.html#codecs" class="guide">codecs</a> supplied by Grails, and the tag libraries supplied by Grails all use <a href="../guide/single.html#codecs" class="guide">encodeAsURL</a> where appropriate. If you create your own tags that generate URLs you will need to be mindful of doing this too.<p class="paragraph"/><h4>Denial of service</h4><p class="paragraph"/>Load balancers and other appliances are more likely to be useful here, but there are also issues relating to excessive queries for example where a link is created by an attacker to set the maximum value of a result set so that a query could exceed the memory limits of the server or slow the system down. The solution here is to always sanitize request parameters before passing them to dynamic finders or other GORM query methods:<p class="paragraph"/><div class="code"><pre>def safeMax = <span class="java&#45;object">Math</span>.max(params.max?.toInteger(), 100) // limit to 100 results
<span class="java&#45;keyword">return</span> Book.list(max:safeMax)</pre></div><p class="paragraph"/><h4>Guessable IDs</h4><p class="paragraph"/>Many applications use the last part of the URL as an "id" of some object to retrieve from GORM or elsewhere. Especially in the case of GORM these are easily guessable as they are typically sequential integers.<p class="paragraph"/>Therefore you must assert that the requesting user is allowed to view the object with the requested id before returning the response to the user.<p class="paragraph"/>Not doing this is "security through obscurity" which is inevitably breached, just like having a default password of "letmein" and so on.<p class="paragraph"/>You must assume that every unprotected URL is publicly accessible one way or another.


<a name="11.2 Encoding and Decoding Objects"><!-- Legacy link --></a>
<h2 id="codecs">11.2 Encoding and Decoding Objects</h2>
Grails supports the concept of dynamic encode/decode methods.  A set of standard codecs are bundled with Grails.  Grails also supports a simple mechanism for developers to contribute their own codecs that will be recognized at runtime.<p class="paragraph"/><h4>Codec Classes</h4><p class="paragraph"/>A Grails codec class is one that may contain an encode closure, a decode closure or both.  When a Grails application starts up the Grails framework dynamically loads codecs from the <code>grails-app/utils/</code> directory.<p class="paragraph"/>The framework looks under <code>grails-app/utils/</code> for class names that end with the convention <code>Codec</code>.  For example one of the standard codecs that ships with Grails is <code>HTMLCodec</code>.<p class="paragraph"/>If a codec contains an <code>encode</code> closure Grails will create a dynamic <code>encode</code> method and add that method to the <code>Object</code> class with a name representing the codec that defined the encode closure. For example, the <code>HTMLCodec</code> class defines an <code>encode</code> closure, so Grails attaches it with the name <code>encodeAsHTML</code>.<p class="paragraph"/>The <code>HTMLCodec</code> and <code>URLCodec</code> classes also define a <code>decode</code> closure, so Grails attaches those with the names <code>decodeHTML</code> and <code>decodeURL</code> respectively. Dynamic codec methods may be invoked from anywhere in a Grails application. For example, consider a case where a report contains a property called 'description' which may contain special characters that must be escaped to be presented in an HTML document.  One way to deal with that in a GSP is to encode the description property using the dynamic encode method as shown below:<p class="paragraph"/><div class="code"><pre>$&#123;report.description.encodeAsHTML()&#125;</pre></div><p class="paragraph"/>Decoding is performed using <code>value.decodeHTML()</code> syntax.<p class="paragraph"/><h4>Standard Codecs</h4><p class="paragraph"/><strong class="bold">HTMLCodec</strong><p class="paragraph"/>This codec performs HTML escaping and unescaping, so that values can be rendered safely in an HTML page without creating any HTML tags or damaging the page layout. For example, given a value "Don't you know that 2 &#62; 1?" you wouldn't be able to show this safely within an HTML page because the &#62; will look like it closes a tag, which is especially bad if you render this data within an attribute, such as the value attribute of an input field.<p class="paragraph"/>Example of usage:<p class="paragraph"/><div class="code"><pre>&#60;input name=<span class="java&#45;quote">"comment.message"</span> value=<span class="java&#45;quote">"$&#123;comment.message.encodeAsHTML()&#125;"</span>/&#62;</pre></div><p class="paragraph"/><blockquote class="note">
Note that the HTML encoding does not re-encode apostrophe/single quote so you must use double quotes on attribute values to avoid text with apostrophes affecting your page.
</blockquote><p class="paragraph"/><strong class="bold">URLCodec</strong><p class="paragraph"/>URL encoding is required when creating URLs in links or form actions, or any time data is used to create a URL. It prevents illegal characters from getting into the URL and changing its meaning, for example "Apple &#38; Blackberry" is not going to work well as a parameter in a GET request as the ampersand will break parameter parsing.<p class="paragraph"/>Example of usage:<p class="paragraph"/><div class="code"><pre>&#60;a href=<span class="java&#45;quote">"/mycontroller/find?searchKey=$&#123;lastSearch.encodeAsURL()&#125;"</span>&#62;
Repeat last search
&#60;/a&#62;</pre></div><p class="paragraph"/><strong class="bold">Base64Codec</strong><p class="paragraph"/>Performs Base64 encode/decode functions. Example of usage:<p class="paragraph"/><div class="code"><pre>Your registration code is: $&#123;user.registrationCode.encodeAsBase64()&#125;</pre></div><p class="paragraph"/><strong class="bold">JavaScriptCodec</strong><p class="paragraph"/>Escapes Strings so they can be used as valid JavaScript strings. For example:<p class="paragraph"/><div class="code"><pre>Element.update('$&#123;elementId&#125;',
    '$&#123;render(template: <span class="java&#45;quote">"/common/message"</span>).encodeAsJavaScript()&#125;')</pre></div><p class="paragraph"/><strong class="bold">HexCodec</strong><p class="paragraph"/>Encodes byte arrays or lists of integers to lowercase hexadecimal strings, and can decode hexadecimal strings into byte arrays. For example:<p class="paragraph"/><div class="code"><pre>Selected colour: &#35;$&#123;&#91;255,127,255&#93;.encodeAsHex()&#125;</pre></div><p class="paragraph"/><strong class="bold">MD5Codec</strong><p class="paragraph"/>Uses the MD5 algorithm to digest byte arrays or lists of integers, or the bytes of a string (in default system encoding), as a lowercase hexadecimal string. Example of usage:<p class="paragraph"/><div class="code"><pre>Your API Key: $&#123;user.uniqueID.encodeAsMD5()&#125;</pre></div><p class="paragraph"/><strong class="bold">MD5BytesCodec</strong><p class="paragraph"/>Uses the MD5 algorithm to digest byte arrays or lists of integers, or the bytes of a string (in default system encoding), as a byte array. Example of usage:<p class="paragraph"/><div class="code"><pre><span class="java&#45;object">byte</span>&#91;&#93; passwordHash = params.password.encodeAsMD5Bytes()</pre></div><p class="paragraph"/><strong class="bold">SHA1Codec</strong><p class="paragraph"/>Uses the SHA1 algorithm to digest byte arrays or lists of integers, or the bytes of a string (in default system encoding), as a lowercase hexadecimal string. Example of usage:<p class="paragraph"/><div class="code"><pre>Your API Key: $&#123;user.uniqueID.encodeAsSHA1()&#125;</pre></div><p class="paragraph"/><strong class="bold">SHA1BytesCodec</strong><p class="paragraph"/>Uses the SHA1 algorithm to digest byte arrays or lists of integers, or the bytes of a string (in default system encoding), as a byte array. Example of usage:<p class="paragraph"/><div class="code"><pre><span class="java&#45;object">byte</span>&#91;&#93; passwordHash = params.password.encodeAsSHA1Bytes()</pre></div><p class="paragraph"/><strong class="bold">SHA256Codec</strong><p class="paragraph"/>Uses the SHA256 algorithm to digest byte arrays or lists of integers, or the bytes of a string (in default system encoding), as a lowercase hexadecimal string. Example of usage:<p class="paragraph"/><div class="code"><pre>Your API Key: $&#123;user.uniqueID.encodeAsSHA256()&#125;</pre></div><p class="paragraph"/><strong class="bold">SHA256BytesCodec</strong><p class="paragraph"/>Uses the SHA256 algorithm to digest byte arrays or lists of integers, or the bytes of a string (in default system encoding), as a byte array. Example of usage:<p class="paragraph"/><div class="code"><pre><span class="java&#45;object">byte</span>&#91;&#93; passwordHash = params.password.encodeAsSHA256Bytes()</pre></div><p class="paragraph"/><h4>Custom Codecs</h4><p class="paragraph"/>Applications may define their own codecs and Grails will load them along with the standard codecs. A custom codec class must be defined in the <code>grails-app/utils/</code> directory and the class name must end with <code>Codec</code>. The codec may contain a <code>static</code> <code>encode</code> closure, a <code>static</code> <code>decode</code> closure or both. The closure must accept a single argument which will be the object that the dynamic method was invoked on. For Example:<p class="paragraph"/><div class="code"><pre>class PigLatinCodec &#123;
  <span class="java&#45;keyword">static</span> encode = &#123; str &#45;&#62;
    // convert the string to pig latin and <span class="java&#45;keyword">return</span> the result
  &#125;
&#125;</pre></div><p class="paragraph"/>With the above codec in place an application could do something like this:<p class="paragraph"/><div class="code"><pre>$&#123;lastName.encodeAsPigLatin()&#125;</pre></div>


<a name="11.3 Authentication"><!-- Legacy link --></a>
<h2 id="authentication">11.3 Authentication</h2>
Grails has no default mechanism for authentication as it is possible to implement authentication in many different ways. It is however, easy to implement a simple authentication mechanism using either <a href="../guide/single.html#interceptors" class="guide">interceptors</a> or <a href="../guide/single.html#filters" class="guide">filters</a>. This is sufficient for simple use cases but it's highly preferable to use an established security framework, for example by using the <a href="../guide/single.html#springSecurity" class="guide">Spring Security</a> or the <a href="../guide/single.html#shiro" class="guide">Shiro</a> plugin.<p class="paragraph"/>Filters let you apply authentication across all controllers or across a URI space. For example you can create a new set of filters in a class called <code>grails-app/conf/SecurityFilters.groovy</code> by running:<p class="paragraph"/><div class="code"><pre>grails create&#45;filters security</pre></div><p class="paragraph"/>and implement your interception logic there:<p class="paragraph"/><div class="code"><pre>class SecurityFilters &#123;
    def filters = &#123;
        loginCheck(controller: '&#42;', action: '&#42;') &#123;
            before = &#123;
                <span class="java&#45;keyword">if</span> (!session.user &#38;&#38; actionName != <span class="java&#45;quote">"login"</span>) &#123;
                    redirect(controller: <span class="java&#45;quote">"user"</span>, action: <span class="java&#45;quote">"login"</span>)
                    <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
                &#125;
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Here the <code>loginCheck</code> filter intercepts execution  <em class="italic">before</em>  all actions except <code>login</code> are executed, and if there is no user in the session then redirect to the <code>login</code> action.<p class="paragraph"/>The <code>login</code> action itself is simple too:<p class="paragraph"/><div class="code"><pre>def login() &#123;
    <span class="java&#45;keyword">if</span> (request.get) &#123;
        <span class="java&#45;keyword">return</span> // render the login view
    &#125;<p class="paragraph"/>    def u = User.findByLogin(params.login)
    <span class="java&#45;keyword">if</span> (u) &#123;
        <span class="java&#45;keyword">if</span> (u.password == params.password) &#123;
            session.user = u
            redirect(action: <span class="java&#45;quote">"home"</span>)
        &#125;
        <span class="java&#45;keyword">else</span> &#123;
            render(view: <span class="java&#45;quote">"login"</span>, model: &#91;message: <span class="java&#45;quote">"Password incorrect"</span>&#93;)
        &#125;
    &#125;
    <span class="java&#45;keyword">else</span> &#123;
        render(view: <span class="java&#45;quote">"login"</span>, model: &#91;message: <span class="java&#45;quote">"User not found"</span>&#93;)
    &#125;
&#125;</pre></div>


<a name="11.4 Security Plug-ins"><!-- Legacy link --></a>
<h2 id="securityPlugins">11.4 Security Plugins</h2>
If you need more advanced functionality beyond simple authentication such as authorization, roles etc. then you should consider using one of the available security plugins.


<a name="11.4.1 Spring Security"><!-- Legacy link --></a>
<h2 id="springSecurity">11.4.1 Spring Security</h2>
The Spring Security plugins are built on the <a href="http://static.springsource.org/spring-security/site/" target="blank">Spring Security</a> project which provides a flexible, extensible framework for building all sorts of authentication and authorization schemes. The plugins are modular so you can install just the functionality that you need for your application. The Spring Security plugins are the official security plugins for Grails and are actively maintained and supported.<p class="paragraph"/>There is a <a href="http://grails.org/plugin/spring-security-core" target="blank">Core plugin</a> which supports form-based authentication, encrypted/salted passwords, HTTP Basic authentication, etc. and secondary dependent plugins provide alternate functionality such as <a href="http://grails.org/plugin/spring-security-openid" target="blank">OpenID authentication</a>, <a href="http://grails.org/plugin/spring-security-acl" target="blank">ACL support</a>, <a href="http://grails.org/plugin/spring-security-cas" target="blank">single sign-on with Jasig CAS</a>, <a href="http://grails.org/plugin/spring-security-ldap" target="blank">LDAP authentication</a>, <a href="http://grails.org/plugin/spring-security-kerberos" target="blank">Kerberos authentication</a>, and a plugin providing <a href="http://grails.org/plugin/spring-security-ui" target="blank">user interface extensions</a> and security workflows.<p class="paragraph"/>See the <a href="http://grails.org/plugin/spring-security-core" target="blank">Core plugin page</a> for basic information and the <a href="http://burtbeckwith.github.com/grails-spring-security-core/" target="blank">user guide</a> for detailed information.


<a name="11.4.2 Shiro"><!-- Legacy link --></a>
<h2 id="shiro">11.4.2 Shiro</h2>
<a href="http://shiro.apache.org/" target="blank">Shiro</a> is a Java POJO-oriented security framework that provides a default domain model that models realms, users, roles and permissions. With Shiro you extend a controller base class called called <code>JsecAuthBase</code> in each controller you want secured and then provide an <code>accessControl</code> block to setup the roles. An example below:<p class="paragraph"/><div class="code"><pre>class ExampleController <span class="java&#45;keyword">extends</span> JsecAuthBase &#123;
    <span class="java&#45;keyword">static</span> accessControl = &#123;
        // All actions require the 'Observer' role.
        role(name: 'Observer')<p class="paragraph"/>        // The 'edit' action requires the 'Administrator' role.
        role(name: 'Administrator', action: 'edit')<p class="paragraph"/>        // Alternatively, several actions can be specified.
        role(name: 'Administrator', only: &#91; 'create', 'edit', 'save', 'update' &#93;)
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>For more information on the Shiro plugin refer to the <a href="http://grails.org/plugin/shiro" target="blank">documentation</a>.


<a name="12. Plug-ins"><!-- Legacy link --></a>
<h1 id="plugins">12 Plugins</h1>
Grails is first and foremost a web application framework, but it is also a platform. By exposing a number of extension points that let you extend anything from the command line interface to the runtime configuration engine, Grails can be customised to suit almost any needs. To hook into this platform, all you need to do is create a plugin.<p class="paragraph"/>Extending the platform may sound complicated, but plugins can range from trivially simple to incredibly powerful. If you know how to build a Grails application, you'll know how to create a plugin for <a href="../guide/single.html#providingBasicArtefacts" class="guide">sharing a data model</a> or some static resources.


<a name="12.1 Creating and Installing Plug-ins"><!-- Legacy link --></a>
<h2 id="creatingAndInstallingPlugins">12.1 Creating and Installing Plugins</h2>
<h4>Creating Plugins</h4><p class="paragraph"/>Creating a Grails plugin is a simple matter of running the command:<p class="paragraph"/><div class="code"><pre>grails create&#45;plugin &#91;PLUGIN NAME&#93;</pre></div><p class="paragraph"/>This will create a plugin project for the name you specify. For example running <code>grails create-plugin example</code> would create a new plugin project called <code>example</code>.<p class="paragraph"/>The structure of a Grails plugin is very nearly the same as a Grails application project's except that in the root of the plugin directory you will find a plugin Groovy file called the "plugin descriptor".<p class="paragraph"/>Being a regular Grails project has a number of benefits in that you can immediately test your plugin by running:<p class="paragraph"/><div class="code"><pre>grails run&#45;app</pre></div><p class="paragraph"/>The plugin descriptor name ends with the convention <code>GrailsPlugin</code> and is found in the root of the plugin project. For example:<p class="paragraph"/><div class="code"><pre>class ExampleGrailsPlugin &#123;
   def version = <span class="java&#45;quote">"0.1"</span><p class="paragraph"/>   &#8230;
&#125;</pre></div><p class="paragraph"/>All plugins must have this class in the root of their directory structure. The plugin class defines the version of the plugin and other metadata, and optionally various hooks into plugin extension points (covered shortly).<p class="paragraph"/>You can also provide additional information about your plugin using several special properties:
<ul class="star">
<li><code>title</code> - short one-sentence description of your plugin</li>
<li><code>version</code> - The version of your plugin. Valid values include example "0.1", "0.2-SNAPSHOT", "1.1.4" etc.</li>
<li><code>grailsVersion</code> - The version of version range of Grails that the plugin supports. eg. "1.2 &#62; *" (indicating 1.2 or higher)</li>
<li><code>author</code> - plugin author's name</li>
<li><code>authorEmail</code> - plugin author's contact e-mail</li>
<li><code>description</code> - full multi-line description of plugin's features</li>
<li><code>documentation</code> - URL of the plugin's documentation</li>
</ul><p class="paragraph"/>Here is an example from the <a href="http://grails.org/plugin/quartz" target="blank">Quartz Grails plugin</a>:<p class="paragraph"/><div class="code"><pre>class QuartzGrailsPlugin &#123;
    def version = <span class="java&#45;quote">"0.1"</span>
    def grailsVersion = <span class="java&#45;quote">"1.1 &#62; &#42;"</span>
    def author = <span class="java&#45;quote">"Sergey Nebolsin"</span>
    def authorEmail = <span class="java&#45;quote">"nebolsin@gmail.com"</span>
    def title = <span class="java&#45;quote">"Quartz Plugin"</span>
    def description = '''&#92;
The Quartz plugin allows your Grails application to schedule jobs&#92;
to be executed using a specified interval or cron expression. The&#92;
underlying system uses the Quartz Enterprise Job Scheduler configured&#92;
via Spring, but is made simpler by the coding by convention paradigm.&#92;
'''
    def documentation = <span class="java&#45;quote">"http://grails.org/plugin/quartz"</span><p class="paragraph"/>   &#8230;
&#125;</pre></div><p class="paragraph"/><h4>Installing and Distributing Plugins</h4><p class="paragraph"/>To distribute a plugin you navigate to its root directory in a console and run:<p class="paragraph"/><div class="code"><pre>grails <span class="java&#45;keyword">package</span>&#45;plugin</pre></div><p class="paragraph"/>This will create a zip file of the plugin starting with <code>grails-</code> then the plugin name and version. For example with the example plugin created earlier this would be <code>grails-example-0.1.zip</code>. The <code>package-plugin</code> command will also generate a <code>plugin.xml</code> file which contains machine-readable information about plugin's name, version, author, and so on.<p class="paragraph"/>Once you have a plugin distribution file you can navigate to a Grails project and run:<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin /path/to/grails&#45;example&#45;0.1.zip</pre></div><p class="paragraph"/>If the plugin is hosted on an HTTP server you can install it with:<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin http://myserver.com/plugins/grails&#45;example&#45;0.1.zip</pre></div><p class="paragraph"/><h4>Notes on excluded Artefacts</h4><p class="paragraph"/>Although the <a href="../ref/Command Line/create-plugin.html" class="commandLine">create-plugin</a> command creates certain files for you so that the plugin can be run as a Grails application, not all of these files are included when packaging a plugin. The following is a list of artefacts created, but not included by <a href="../ref/Command Line/package-plugin.html" class="commandLine">package-plugin</a>:
<ul class="star">
<li><code>grails-app/conf/BootStrap.groovy</code></li>
<li><code>grails-app/conf/BuildConfig.groovy</code> (although it is used to generate <code>dependencies.groovy</code>)</li>
<li><code>grails-app/conf/Config.groovy</code></li>
<li><code>grails-app/conf/DataSource.groovy</code> (and any other <code>*DataSource.groovy</code>)</li>
<li><code>grails-app/conf/UrlMappings.groovy</code></li>
<li><code>grails-app/conf/spring/resources.groovy</code></li>
<li>Everything within <code>/web-app/WEB-INF</code></li>
<li>Everything within <code>/web-app/plugins/&#42;&#42;</code></li>
<li>Everything within <code>/test/&#42;&#42;</code></li>
<li>SCM management files within <code>&#42;&#42;/.svn/&#42;&#42;</code> and <code>&#42;&#42;/CVS/&#42;&#42;</code></li>
</ul><p class="paragraph"/>If you need artefacts within <code>WEB-INF</code> it is recommended you use the <code>_Install.groovy</code> script (covered later), which is executed when a plugin is installed, to provide such artefacts. In addition, although <code>UrlMappings.groovy</code> is excluded you are allowed to include a <code>UrlMappings</code> definition with a different name, such as <code>MyPluginUrlMappings.groovy</code>.<p class="paragraph"/><h4>Specifying Plugin Locations</h4><p class="paragraph"/>An application can load plugins from anywhere on the file system, even if they have not been installed. Specify the location of the (unpacked) plugin in the application's <code>grails-app/conf/BuildConfig.groovy</code> file:<p class="paragraph"/><div class="code"><pre>// Useful to test plugins you are developing.
grails.plugin.location.shiro =
        <span class="java&#45;quote">"/home/dilbert/dev/plugins/grails&#45;shiro"</span><p class="paragraph"/>// Useful <span class="java&#45;keyword">for</span> modular applications where all plugins and
// applications are in the same directory.
grails.plugin.location.'grails&#45;ui' = <span class="java&#45;quote">"../grails&#45;grails&#45;ui"</span></pre></div><p class="paragraph"/>This is particularly useful in two cases:
<ul class="star">
<li>You are developing a plugin and want to test it in a real application without packaging and installing it first.</li>
<li>You have split an application into a set of plugins and an application, all in the same "super-project" directory.</li>
</ul><p class="paragraph"/><h4>Global plugins</h4><p class="paragraph"/>Plugins can also be installed globally for all applications for a particular version of Grails using the <code>&#45;global</code> flag, for example:<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin webtest &#45;global</pre></div><p class="paragraph"/>The default location is &#36;USER_HOME/.grails/&#60;grailsVersion&#62;/global-plugins but this can be customized with the <code>grails.global.plugins.dir</code> setting in <code>BuildConfig.groovy</code>.


<a name="12.2 Plugin Repositories"><!-- Legacy link --></a>
<h2 id="repositories">12.2 Plugin Repositories</h2>
<h4>Distributing Plugins in the Grails Central Plugins Repository</h4><p class="paragraph"/>The preferred way to distribute plugin is to publish to the official Grails Plugins Repository. This will make your plugin visible to the <a href="../ref/Command Line/list-plugins.html" class="commandLine">list-plugins</a> command:<p class="paragraph"/><div class="code"><pre>grails list&#45;plugins</pre></div><p class="paragraph"/>which lists all plugins in the Grails Plugin repository, and also the <a href="../ref/Command Line/plugin-info.html" class="commandLine">plugin-info</a> command:<p class="paragraph"/><div class="code"><pre>grails plugin&#45;info &#91;plugin&#45;name&#93;</pre></div><p class="paragraph"/>which outputs more information based on the meta info entered into the plugin descriptor.<p class="paragraph"/><blockquote class="note">
If you have created a Grails plugin and want it to be hosted in the central repository take a look at <a href="http://grails.org/Creating+Plugins" target="blank">this wiki page</a> which details how release your plugin.
</blockquote><p class="paragraph"/>When you have access to the Grails Plugin repository, execute the release-plugin command to release your plugin:<p class="paragraph"/><div class="code"><pre>grails release&#45;plugin</pre></div><p class="paragraph"/>This will automatically commit changes to SVN, create tags, and make your changes available to the <a href="../ref/Command Line/list-plugins.html" class="commandLine">list-plugins</a> command.<p class="paragraph"/><h4>Configuring Additional Repositories</h4><p class="paragraph"/>The process for configuring repositories in Grails differs between versions. For version of Grails 1.2 and earlier please refer to the <a href="http://grails.org/doc/1.2.x/guide/12.%20Plug-ins.html#12.2%20Plugin%20Repositories" target="blank">Grails 1.2 documentation</a> on the subject. The following sections cover Grails 1.3 and above.<p class="paragraph"/>Grails 1.3 and above use Ivy under the hood to resolve plugin dependencies. The mechanism for defining additional plugin repositories is largely the same as <a href="../guide/single.html#ivy" class="guide">defining repositories for JAR dependencies</a>. For example you can define a remote Maven repository that contains Grails plugins using the following syntax in <code>grails-app/conf/BuildConfig.groovy</code>:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    mavenRepo <span class="java&#45;quote">"http://repository.codehaus.org"</span>
&#125;</pre></div><p class="paragraph"/>You can also define a SVN-based Grails repository (such as the one hosted at <a href="http://plugins.grails.org/" target="blank">http://plugins.grails.org</a>) using the <code>grailsRepo</code> method:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    grailsRepo <span class="java&#45;quote">"http://myserver/mygrailsrepo"</span>
&#125;</pre></div><p class="paragraph"/>There is a shortcut to setup the Grails central repository:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    grailsCentral()
&#125;</pre></div><p class="paragraph"/>The order in which plugins are resolved is based on the ordering of the repositories. So in this case the Grails central repository will be searched last:<p class="paragraph"/><div class="code"><pre>repositories &#123;
    grailsRepo <span class="java&#45;quote">"http://myserver/mygrailsrepo"</span>
    grailsCentral()
&#125;</pre></div><p class="paragraph"/>All of the above examples use HTTP; however you can specify any <a href="http://ant.apache.org/ivy/history/latest-milestone/settings/resolvers.html" target="blank">Ivy resolver</a> to resolve plugins with. Below is an example that uses an SSH resolver:<p class="paragraph"/><div class="code"><pre>def sshResolver = <span class="java&#45;keyword">new</span> SshResolver(user:<span class="java&#45;quote">"myuser"</span>, host:<span class="java&#45;quote">"myhost.com"</span>)
sshResolver.addArtifactPattern(
        <span class="java&#45;quote">"/path/to/repo/grails&#45;&#91;artifact&#93;/tags/"</span> +
        <span class="java&#45;quote">"LATEST_RELEASE/grails&#45;&#91;artifact&#93;&#45;&#91;revision&#93;.&#91;ext&#93;"</span>)
sshResolver.latestStrategy =
        <span class="java&#45;keyword">new</span> org.apache.ivy.plugins.latest.LatestTimeStrategy()<p class="paragraph"/>sshResolver.changingPattern = <span class="java&#45;quote">".&#42;SNAPSHOT"</span>
sshResolver.setCheckmodified(<span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>The above example defines an artifact pattern which tells Ivy how to resolve a plugin zip file. For a more detailed explanation on Ivy patterns see the <a href="http://ant.apache.org/ivy/history/2.1.0/concept.html#patterns" target="blank">relevant section</a> in the Ivy user guide.<p class="paragraph"/><h4>Publishing to Maven Compatible Repositories</h4><p class="paragraph"/>In general it is recommended for Grails 1.3 and above to use standard Maven-style repositories to self host plugins. The benefits of doing so include the ability for existing tooling and repository managers to interpret the structure of a Maven repository. In addition Maven compatible repositories are not tied to SVN as Grails repositories are.<p class="paragraph"/>You use the Maven publisher plugin to publish a plugin to a Maven repository. Please refer to the section of the <a href="../guide/single.html#mavendeploy" class="guide">Maven deployment</a> user guide on the subject.<p class="paragraph"/><h4>Publishing to Grails Compatible Repositories</h4><p class="paragraph"/>Specify the <code>grails.plugin.repos.distribution.myRepository</code> setting within the grails-app/conf/BuildConfig.groovy file to publish a Grails plugin to a Grails-compatible repository:<p class="paragraph"/><div class="code"><pre>grails.plugin.repos.distribution.myRepository =
        <span class="java&#45;quote">"https://svn.codehaus.org/grails/trunk/grails&#45;test&#45;plugin&#45;repo"</span></pre></div><p class="paragraph"/>You can also provide this settings in the &#36;USER_HOME/.grails/settings.groovy file if you prefer to share the same settings across multiple projects.<p class="paragraph"/>Once this is done use the <code>repository</code> argument of the <code>release-plugin</code> command to specify the repository to release the plugin into:<p class="paragraph"/><div class="code"><pre>grails release&#45;plugin &#45;repository = myRepository</pre></div>


<a name="12.3 Understanding a Plug-ins Structure"><!-- Legacy link --></a>
<h2 id="understandingPluginStructure">12.3 Understanding a Plugin's Structure</h2>
As as mentioned previously, a plugin is basically a regular Grails application with a plugin descriptor. However when installed, the structure of a plugin differs slightly. For example, take a look at this plugin directory structure:<p class="paragraph"/><div class="code"><pre>+ grails&#45;app
     + controllers
     + domain
     + taglib
     etc.
 + lib
 + src
     + java
     + groovy
 + web&#45;app
     + js
     + css</pre></div><p class="paragraph"/>When a plugin is installed the contents of the <code>grails-app</code> directory will go into a directory such as <code>plugins/example-1.0/grails-app</code>. They <strong class="bold">will not</strong> be copied into the main source tree. A plugin never interferes with a project's primary source tree.<p class="paragraph"/>Dealing with static resources is slightly different. When developing a plugin, just like an application, all static resources go in the <code>web-app</code> directory. You can then link to static resources just like in an application. This example links to a JavaScript source:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;g:resource dir=<span class="xml&#45;quote">"js"</span> file=<span class="xml&#45;quote">"mycode.js"</span> /&#62;</span></pre></div><p class="paragraph"/>When you run the plugin in development mode the link to the resource will resolve to something like <code>/js/mycode.js</code>. However, when the plugin is installed into an application the path will automatically change to something like <code>/plugin/example-0.1/js/mycode.js</code> and Grails will deal with making sure the resources are in the right place.<p class="paragraph"/>There is a special <code>pluginContextPath</code> variable that can be used whilst both developing the plugin and when in the plugin is installed into the application to find out what the correct path to the plugin is.<p class="paragraph"/>At runtime the <code>pluginContextPath</code> variable will either evaluate to an empty string or <code>/plugins/example</code> depending on whether the plugin is running standalone or has been installed in an application<p class="paragraph"/>Java and Groovy code that the plugin provides within the lib and <code>src/java</code> and <code>src/groovy</code> directories will be compiled into the main project's <code>web-app/WEB-INF/classes</code> directory so that they are made available at runtime.


<a name="12.4 Providing Basic Artefacts"><!-- Legacy link --></a>
<h2 id="providingBasicArtefacts">12.4 Providing Basic Artefacts</h2>
<h4>Adding a new Script</h4><p class="paragraph"/>A plugin can add a new script simply by providing the relevant Gant script in its scripts directory:<p class="paragraph"/><div class="code"><pre>+ MyPlugin.groovy
   + scripts     &#60;&#45;&#45; additional scripts here
   + grails&#45;app
        + controllers
        + services
        + etc.
    + lib</pre></div><p class="paragraph"/><h4>Adding a new grails-app artifact (Controller, Tag Library, Service, etc.)</h4><p class="paragraph"/>A plugin can add new artifacts by creating the relevant file within the <code>grails-app</code> tree. Note that the plugin is loaded from where it is installed and not copied into the main application tree.<p class="paragraph"/><div class="code"><pre>+ ExamplePlugin.groovy
   + scripts
   + grails&#45;app
        + controllers  &#60;&#45;&#45; additional controllers here
        + services &#60;&#45;&#45; additional services here
        + etc.  &#60;&#45;&#45; additional XXX here
    + lib</pre></div><p class="paragraph"/><h4>Providing Views, Templates and View resolution</h4><p class="paragraph"/>When a plugin provides a controller it may also provide default views to be rendered. This is an excellent way to modularize your application through plugins. Grails' view resolution mechanism will first look for the view in the application it is installed into and if that fails will attempt to look for the view within the plugin. This means that you can override views provided by a plugin by creating corresponding GSPs in the application's <code>grails-app/views</code> directory.<p class="paragraph"/>For example, consider a controller called <code>BookController</code> that's provided by an 'amazon' plugin. If the action being executed is <code>list</code>, Grails will first look for a view called <code>grails-app/views/book/list.gsp</code> then if that fails it will look for the same view relative to the plugin.<p class="paragraph"/>However if the view uses templates that are also provided by the plugin then the following syntax may be necessary:<p class="paragraph"/><div class="code"><pre>&#60;g:render template=<span class="java&#45;quote">"fooTemplate"</span> plugin=<span class="java&#45;quote">"amazon"</span>/&#62;</pre></div><p class="paragraph"/>Note the usage of the <code>plugin</code> attribute, which contains the name of the plugin where the template resides. If this is not specified then Grails will look for the template relative to the application.<p class="paragraph"/><h4>Excluded Artefacts</h4><p class="paragraph"/>By default Grails excludes the following files during the packaging process:
<ul class="star">
<li><code>grails-app/conf/BootStrap.groovy</code></li>
<li><code>grails-app/conf/BuildConfig.groovy</code> (although it is used to generate <code>dependencies.groovy</code>)</li>
<li><code>grails-app/conf/Config.groovy</code></li>
<li><code>grails-app/conf/DataSource.groovy</code> (and any other <code>*DataSource.groovy</code>)</li>
<li><code>grails-app/conf/UrlMappings.groovy</code></li>
<li><code>grails-app/conf/spring/resources.groovy</code></li>
<li>Everything within <code>/web-app/WEB-INF</code></li>
<li>Everything within <code>/web-app/plugins/&#42;&#42;</code></li>
<li>Everything within <code>/test/&#42;&#42;</code></li>
<li>SCM management files within <code>&#42;&#42;/.svn/&#42;&#42;</code> and <code>&#42;&#42;/CVS/&#42;&#42;</code></li>
</ul><p class="paragraph"/>If your plugin requires files under the <code>web-app/WEB-INF</code> directory it is recommended that you modify the plugin's <code>scripts/_Install.groovy</code> Gant script to install these artefacts into the target project's directory tree.<p class="paragraph"/>In addition, the default <code>UrlMappings.groovy</code> file is excluded to avoid naming conflicts, however you are free to add a UrlMappings definition under a different name which <strong class="bold">will</strong> be included. For example a file called <code>grails-app/conf/BlogUrlMappings.groovy</code> is fine.<p class="paragraph"/>The list of excludes is extensible with the <code>pluginExcludes</code> property:<p class="paragraph"/><div class="code"><pre>// resources that are excluded from plugin packaging
def pluginExcludes = &#91;
    <span class="java&#45;quote">"grails&#45;app/views/error.gsp"</span>
&#93;</pre></div><p class="paragraph"/>This is useful for example to include demo or test resources in the plugin repository, but not include them in the final distribution.


<a name="12.5 Evaluating Conventions"><!-- Legacy link --></a>
<h2 id="evaluatingConventions">12.5 Evaluating Conventions</h2>
Before looking at providing runtime configuration based on conventions you first need to understand how to evaluate those conventions from a plugin. Every plugin has an implicit <code>application</code> variable which is an instance of the <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> interface.<p class="paragraph"/>The <code>GrailsApplication</code> interface provides methods to evaluate the conventions within the project and internally stores references to all artifact classes within your application.<p class="paragraph"/>Artifacts implement the <a href="../../api/org/codehaus/groovy/grails/commons/GrailsClass.html" class="api">GrailsClass</a> interface, which represents a Grails resource such as a controller or a tag library. For example to get all <code>GrailsClass</code> instances you can do:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">for</span> (grailsClass in application.allClasses) &#123;
    println grailsClass.name
&#125;</pre></div><p class="paragraph"/><code>GrailsApplication</code> has a few "magic" properties to narrow the type of artefact you are interested in. For example to access controllers you can use:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">for</span> (controllerClass in application.controllerClasses) &#123;
    println controllerClass.name
&#125;</pre></div><p class="paragraph"/>The dynamic method conventions are as follows:
<ul class="star">
<li><code>*Classes</code> - Retrieves all the classes for a particular artefact name. For example <code>application.controllerClasses</code>.</li>
<li><code>get*Class</code> - Retrieves a named class for a particular artefact. For example <code>application.getControllerClass("PersonController")</code></li>
<li><code>is*Class</code> - Returns <code>true</code> if the given class is of the given artefact type. For example <code>application.isControllerClass(PersonController)</code></li>
</ul><p class="paragraph"/>The <code>GrailsClass</code> interface has a number of useful methods that let you further evaluate and work with the conventions. These include:
<ul class="star">
<li><code>getPropertyValue</code> - Gets the initial value of the given property on the class</li>
<li><code>hasProperty</code> - Returns <code>true</code> if the class has the specified property</li>
<li><code>newInstance</code> - Creates a new instance of this class.</li>
<li><code>getName</code> -  Returns the logical name of the class in the application without the trailing convention part if applicable</li>
<li><code>getShortName</code> - Returns the short name of the class without package prefix</li>
<li><code>getFullName</code> - Returns the full name of the class in the application with the trailing convention part and with the package name</li>
<li><code>getPropertyName</code> - Returns the name of the class as a property name</li>
<li><code>getLogicalPropertyName</code> - Returns the logical property name of the class in the application without the trailing convention part if applicable</li>
<li><code>getNaturalName</code> - Returns the name of the property in natural terms (eg. 'lastName' becomes 'Last Name')</li>
<li><code>getPackageName</code> - Returns the package name</li>
</ul><p class="paragraph"/>For a full reference refer to the <a href="../../api/org/codehaus/groovy/grails/commons/GrailsClass.html" class="api">javadoc API</a>.


<a name="12.6 Hooking into Build Events"><!-- Legacy link --></a>
<h2 id="hookingIntoBuildEvents">12.6 Hooking into Build Events</h2>
<h4>Post-Install Configuration and Participating in Upgrades</h4><p class="paragraph"/>Grails plugins can do post-install configuration and participate in application upgrade process (the <a href="../ref/Command Line/upgrade.html" class="commandLine">upgrade</a> command). This is achieved using two specially named scripts under the <code>scripts</code> directory of the plugin - <code>_Install.groovy</code> and <code>_Upgrade.groovy</code>.<p class="paragraph"/><code>_Install.groovy</code> is executed after the plugin has been installed and <code>_Upgrade.groovy</code> is executed each time the user upgrades the application (but not the plugin) with <a href="../ref/Command Line/upgrade.html" class="commandLine">upgrade</a> command.<p class="paragraph"/>These scripts are <a href="../guide/single.html#commandLine" class="guide">Gant</a> scripts, so you can use the full power of Gant. An addition to the standard Gant variables there is also a <code>pluginBasedir</code> variable which points at the plugin installation basedir.<p class="paragraph"/>As an example this <code>_Install.groovy</code> script will create a new directory type under the <code>grails-app</code> directory and install a configuration template:<p class="paragraph"/><div class="code"><pre>ant.mkdir(dir: <span class="java&#45;quote">"$&#123;basedir&#125;/grails&#45;app/jobs"</span>)<p class="paragraph"/>ant.copy(file: <span class="java&#45;quote">"$&#123;pluginBasedir&#125;/src/samples/SamplePluginConfig.groovy"</span>,
         todir: <span class="java&#45;quote">"$&#123;basedir&#125;/grails&#45;app/conf"</span>)</pre></div><p class="paragraph"/><h4>Scripting events</h4><p class="paragraph"/>It is also possible to hook into command line scripting events. These are events triggered during execution of Grails target and plugin scripts.<p class="paragraph"/>For example, you can hook into status update output (i.e. "Tests passed", "Server running") and the creation of files or artefacts.<p class="paragraph"/>A plugin just has to provide an <code>_Events.groovy</code> script to listen to the required events. Refer the documentation on <a href="../guide/single.html#events" class="guide">Hooking into Events</a> for further information.


<a name="12.7 Hooking into Runtime Configuration"><!-- Legacy link --></a>
<h2 id="hookingIntoRuntimeConfiguration">12.7 Hooking into Runtime Configuration</h2>
Grails provides a number of hooks to leverage the different parts of the system and perform runtime configuration by convention.<p class="paragraph"/><h4>Hooking into the Grails Spring configuration</h4><p class="paragraph"/>First, you can hook in Grails runtime configuration by providing a property called <code>doWithSpring</code> which is assigned a block of code. For example the following snippet is from one of the core Grails plugins that provides <a href="../guide/single.html#i18n" class="guide">i18n</a> support:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.web.servlet.i18n.CookieLocaleResolver
<span class="java&#45;keyword">import</span> org.springframework.web.servlet.i18n.LocaleChangeInterceptor
<span class="java&#45;keyword">import</span> org.springframework.context.support.ReloadableResourceBundleMessageSource<p class="paragraph"/>class I18nGrailsPlugin &#123;<p class="paragraph"/>    def version = <span class="java&#45;quote">"0.1"</span><p class="paragraph"/>    def doWithSpring = &#123;
        messageSource(ReloadableResourceBundleMessageSource) &#123;
            basename = <span class="java&#45;quote">"WEB&#45;INF/grails&#45;app/i18n/messages"</span>
        &#125;
        localeChangeInterceptor(LocaleChangeInterceptor) &#123;
            paramName = <span class="java&#45;quote">"lang"</span>
        &#125;
        localeResolver(CookieLocaleResolver)
    &#125;
&#125;</pre></div><p class="paragraph"/>This plugin configures the Grails <code>messageSource</code> bean and a couple of other beans to manage Locale resolution and switching. It using the <a href="../guide/single.html#spring" class="guide">Spring Bean Builder</a> syntax to do so.<p class="paragraph"/><h4>Participating in web.xml Generation</h4><p class="paragraph"/>Grails generates the <code>WEB-INF/web.xml</code> file at load time, and although plugins cannot change this file directly, they can participate in the generation of the file. A plugin can provide a <code>doWithWebDescriptor</code> property that is assigned a block of code that gets passed the <code>web.xml</code> as an <code>XmlSlurper</code> <code>GPathResult</code>.<p class="paragraph"/><h5>Add <code>servlet</code> and <code>servlet-mapping</code></h5><p class="paragraph"/>Consider this example from the <code>ControllersPlugin</code>:<p class="paragraph"/><div class="code"><pre>def doWithWebDescriptor = &#123; webXml &#45;&#62;<p class="paragraph"/>    def mappingElement = webXml.'servlet&#45;mapping'<p class="paragraph"/>    def lastMapping = mappingElement&#91;mappingElement.size() &#45; 1&#93;
    lastMapping + &#123;
        'servlet&#45;mapping' &#123;
            'servlet&#45;name'(<span class="java&#45;quote">"grails"</span>)
            'url&#45;pattern'(<span class="java&#45;quote">"&#42;.dispatch"</span>)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Here the plugin gets a reference to the last <code>&#60;servlet-mapping&#62;</code> element and appends Grails' servlet after it using XmlSlurper's ability to programmatically modify XML using closures and blocks.<p class="paragraph"/><h5>Add <code>filter</code> and <code>filter-mapping</code></h5><p class="paragraph"/>Adding a filter with its mapping works a little differently. The location of the <code>&#60;filter&#62;</code> element doesn't matter since order is not important, so it's simplest to insert your custom filter definition immediately after the last <code>&#60;context-param&#62;</code> element. Order  <em class="italic">is</em>  important for mappings, but the usual approach is to add it immediately after the last <code>&#60;filter&#62;</code> element like so:<p class="paragraph"/><div class="code"><pre>def doWithWebDescriptor = &#123; webXml &#45;&#62;<p class="paragraph"/>    def contextParam = webXml.'context&#45;param'<p class="paragraph"/>    contextParam&#91;contextParam.size() &#45; 1&#93; + &#123;
        'filter' &#123;
            'filter&#45;name'('springSecurityFilterChain')
            'filter&#45;class'(DelegatingFilterProxy.name)
        &#125;
    &#125;<p class="paragraph"/>    def filter = webXml.'filter'
    filter&#91;filter.size() &#45; 1&#93; + &#123;
        'filter&#45;mapping'&#123;
            'filter&#45;name'('springSecurityFilterChain')
            'url&#45;pattern'('/&#42;')
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In some cases you need to ensure that your filter comes after one of the standard Grails filters, such as the Spring character encoding filter or the SiteMesh filter. Fortunately you can insert filter mappings immediately after the standard ones (more accurately, any that are in the template web.xml file) like so:<p class="paragraph"/><div class="code"><pre>def doWithWebDescriptor = &#123; webXml &#45;&#62;
    ...<p class="paragraph"/>    // Insert the Spring Security filter after the Spring
    // character encoding filter.
    def filter = webXml.'filter&#45;mapping'.find &#123;
        it.'filter&#45;name'.text() == <span class="java&#45;quote">"charEncodingFilter"</span>
    &#125;<p class="paragraph"/>    filter + &#123;
        'filter&#45;mapping'&#123;
            'filter&#45;name'('springSecurityFilterChain')
            'url&#45;pattern'('/&#42;')
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Doing Post Initialisation Configuration</h4><p class="paragraph"/>Sometimes it is useful to be able do some runtime configuration after the Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">ApplicationContext</a> has been built. In this case you can define a <code>doWithApplicationContext</code> closure property.<p class="paragraph"/><div class="code"><pre>class SimplePlugin &#123;<p class="paragraph"/>    def name = <span class="java&#45;quote">"simple"</span>
    def version = <span class="java&#45;quote">"1.1"</span><p class="paragraph"/>    def doWithApplicationContext = &#123; appCtx &#45;&#62;
        def sessionFactory = appCtx.sessionFactory
        // <span class="java&#45;keyword">do</span> something here with session factory
    &#125;
&#125;</pre></div>


<a name="12.8 Adding Dynamic Methods at Runtime"><!-- Legacy link --></a>
<h2 id="addingDynamicMethodsAtRuntime">12.8 Adding Dynamic Methods at Runtime</h2>
<h4>The Basics</h4><p class="paragraph"/>Grails plugins let you register dynamic methods with any Grails-managed or other class at runtime. This work is done in a <code>doWithDynamicMethods</code> closure.<p class="paragraph"/>For Grails-managed classes like controllers, tag libraries and so forth you can add methods, constructors etc. using the <a href="http://groovy.codehaus.org/ExpandoMetaClass" target="blank">ExpandoMetaClass</a> mechanism by accessing each controller's <a href="api:http://groovy.codehaus.org/api/groovy/lang/MetaObjectProtocol.html" target="blank">MetaClass</a>:<p class="paragraph"/><div class="code"><pre>class ExamplePlugin &#123;
    def doWithDynamicMethods = &#123; applicationContext &#45;&#62;
        <span class="java&#45;keyword">for</span> (controllerClass in application.controllerClasses) &#123;
             controllerClass.metaClass.myNewMethod = &#123;&#45;&#62; println <span class="java&#45;quote">"hello world"</span> &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case we use the implicit application object to get a reference to all of the controller classes' MetaClass instances and add a new method called <code>myNewMethod</code> to each controller. If you know beforehand the class you wish the add a method to you can simply reference its <code>metaClass</code> property.<p class="paragraph"/>For example we can add a new method <code>swapCase</code> to <code>java.lang.String</code>:<p class="paragraph"/><div class="code"><pre>class ExamplePlugin &#123;<p class="paragraph"/>    def doWithDynamicMethods = &#123; applicationContext &#45;&#62;
        <span class="java&#45;object">String</span>.metaClass.swapCase = &#123;&#45;&#62;
             def sb = <span class="java&#45;keyword">new</span> StringBuilder()
             delegate.each &#123;
                 sb &#60;&#60; (<span class="java&#45;object">Character</span>.isUpperCase(it as <span class="java&#45;object">char</span>) ?
                        <span class="java&#45;object">Character</span>.toLowerCase(it as <span class="java&#45;object">char</span>) :
                        <span class="java&#45;object">Character</span>.toUpperCase(it as <span class="java&#45;object">char</span>))
             &#125;
             sb.toString()
        &#125;<p class="paragraph"/>        assert <span class="java&#45;quote">"UpAndDown"</span> == <span class="java&#45;quote">"uPaNDdOWN"</span>.swapCase()
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Interacting with the ApplicationContext</h4><p class="paragraph"/>The <code>doWithDynamicMethods</code> closure gets passed the Spring <code>ApplicationContext</code> instance. This is useful as it lets you interact with objects within it. For example if you were implementing a method to interact with Hibernate you could use the <code>SessionFactory</code> instance in combination with a <code>HibernateTemplate</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.orm.hibernate3.HibernateTemplate<p class="paragraph"/>class ExampleHibernatePlugin &#123;<p class="paragraph"/>   def doWithDynamicMethods = &#123; applicationContext &#45;&#62;<p class="paragraph"/>       <span class="java&#45;keyword">for</span> (domainClass in application.domainClasses) &#123;<p class="paragraph"/>           domainClass.metaClass.<span class="java&#45;keyword">static</span>.load = &#123; <span class="java&#45;object">Long</span> id&#45;&#62;
                def sf = applicationContext.sessionFactory
                def template = <span class="java&#45;keyword">new</span> HibernateTemplate(sf)
                template.load(delegate, id)
           &#125;
       &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>Also because of the autowiring and dependency injection capability of the Spring container you can implement more powerful dynamic constructors that use the application context to wire dependencies into your object at runtime:<p class="paragraph"/><div class="code"><pre>class MyConstructorPlugin &#123;<p class="paragraph"/>    def doWithDynamicMethods = &#123; applicationContext &#45;&#62;
         <span class="java&#45;keyword">for</span> (domainClass in application.domainClasses) &#123;
              domainClass.metaClass.constructor = &#123;&#45;&#62;
                  <span class="java&#45;keyword">return</span> applicationContext.getBean(domainClass.name)
              &#125;
         &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Here we actually replace the default constructor with one that looks up prototyped Spring beans instead!


<a name="12.9 Participating in Auto Reload Events"><!-- Legacy link --></a>
<h2 id="participatingInAutoReloadEvents">12.9 Participating in Auto Reload Events</h2>
<h4>Monitoring Resources for Changes</h4><p class="paragraph"/>Often it is valuable to monitor resources for changes and perform some action when they occur. This is how Grails implements advanced reloading of application state at runtime. For example, consider this simplified snippet from the Grails <code>ServicesPlugin</code>:<p class="paragraph"/><div class="code"><pre>class ServicesGrailsPlugin &#123;
    &#8230;
    def watchedResources = <span class="java&#45;quote">"file:./grails&#45;app/services/&#42;Service.groovy"</span><p class="paragraph"/>    &#8230;
    def onChange = &#123; event &#45;&#62;
        <span class="java&#45;keyword">if</span> (event.source) &#123;
            def serviceClass = application.addServiceClass(event.source)
            def serviceName = <span class="java&#45;quote">"&#36;&#123;serviceClass.propertyName&#125;"</span>
            def beans = beans &#123;
                <span class="java&#45;quote">"$serviceName"</span>(serviceClass.getClazz()) &#123; bean &#45;&#62;
                    bean.autowire =  <span class="java&#45;keyword">true</span>
                &#125;
            &#125;
            <span class="java&#45;keyword">if</span> (event.ctx) &#123;
                event.ctx.registerBeanDefinition(
                        serviceName,
                        beans.getBeanDefinition(serviceName))
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>First it defines <code>watchedResources</code> as either a String or a List of strings that contain either the references or patterns of the resources to watch. If the watched resources specify a Groovy file, when it is changed it will automatically be reloaded and passed into the <code>onChange</code> closure in the <code>event</code> object.<p class="paragraph"/>The <code>event</code> object defines a number of useful properties:
<ul class="star">
<li><code>event.source</code> - The source of the event, either the reloaded <code>Class</code> or a Spring <code>Resource</code></li>
<li><code>event.ctx</code> - The Spring <code>ApplicationContext</code> instance</li>
<li><code>event.plugin</code> - The plugin object that manages the resource (usually <code>this</code>)</li>
<li><code>event.application</code> - The <code>GrailsApplication</code> instance</li>
<li><code>event.manager</code> - The <code>GrailsPluginManager</code> instance</li>
</ul><p class="paragraph"/>These objects are available to help you apply the appropriate changes based on what changed. In the "Services" example above, a new service bean is re-registered with the <code>ApplicationContext</code> when one of the service classes changes.<p class="paragraph"/><h4>Influencing Other Plugins</h4><p class="paragraph"/>In addition to reacting to changes, sometimes a plugin needs to "influence" another.<p class="paragraph"/>Take for example the Services and Controllers plugins. When a service is reloaded, unless you reload the controllers too, problems will occur when you try to auto-wire the reloaded service into an older controller Class.<p class="paragraph"/>To get around this, you can specify which plugins another plugin "influences". This means that when one plugin detects a change, it will reload itself and then reload its influenced plugins. For example consider this snippet from the <code>ServicesGrailsPlugin</code>:<p class="paragraph"/><div class="code"><pre>def influences = &#91;'controllers'&#93;</pre></div><p class="paragraph"/><h4>Observing other plugins</h4><p class="paragraph"/>If there is a particular plugin that you would like to observe for changes but not necessary watch the resources that it monitors you can use the "observe" property:<p class="paragraph"/><div class="code"><pre>def observe = &#91;<span class="java&#45;quote">"controllers"</span>&#93;</pre></div><p class="paragraph"/>In this case when a controller is changed you will also receive the event chained from the controllers plugin.<p class="paragraph"/>It is also possible for a plugin to observe all loaded plugins by using a wildcard:<p class="paragraph"/><div class="code"><pre>def observe = &#91;<span class="java&#45;quote">"&#42;"</span>&#93;</pre></div><p class="paragraph"/>The Logging plugin does exactly this so that it can add the <code>log</code> property back to  <em class="italic">any</em>  artefact that changes while the application is running.


<a name="12.10 Understanding Plug-in Load Order"><!-- Legacy link --></a>
<h2 id="understandingPluginLoadOrder">12.10 Understanding Plugin Load Order</h2>
<h4>Controlling Plugin Dependencies</h4><p class="paragraph"/>Plugins often depend on the presence of other plugins and can adapt depending on the presence of others. This is implemented with two properties. The first is called <code>dependsOn</code>. For example, take a look at this snippet from the Hibernate plugin:<p class="paragraph"/><div class="code"><pre>class HibernateGrailsPlugin &#123;<p class="paragraph"/>    def version = <span class="java&#45;quote">"1.0"</span><p class="paragraph"/>    def dependsOn = &#91;dataSource: <span class="java&#45;quote">"1.0"</span>,
                     domainClass: <span class="java&#45;quote">"1.0"</span>,
                     i18n: <span class="java&#45;quote">"1.0"</span>,
                     core: <span class="java&#45;quote">"1.0"</span>&#93;
&#125;</pre></div><p class="paragraph"/>The Hibernate plugin is dependent on the presence of four plugins: the <code>dataSource</code>, <code>domainClass</code>, <code>i18n</code> and <code>core</code> plugins.<p class="paragraph"/>The dependencies will be loaded before the Hibernate plugin and if all dependencies do not load, then the plugin will not load.<p class="paragraph"/>The <code>dependsOn</code> property also supports a mini expression language for specifying version ranges. A few examples of the syntax can be seen below:<p class="paragraph"/><div class="code"><pre>def dependsOn = &#91;foo: <span class="java&#45;quote">"&#42; &#62; 1.0"</span>&#93;
def dependsOn = &#91;foo: <span class="java&#45;quote">"1.0 &#62; 1.1"</span>&#93;
def dependsOn = &#91;foo: <span class="java&#45;quote">"1.0 &#62; &#42;"</span>&#93;</pre></div><p class="paragraph"/>When the wildcard * character is used it denotes "any" version. The expression syntax also excludes any suffixes such as -BETA, -ALPHA etc. so for example the expression "1.0 &#62; 1.1" would match any of the following versions:
<ul class="star">
<li>1.1</li>
<li>1.0</li>
<li>1.0.1</li>
<li>1.0.3-SNAPSHOT</li>
<li>1.1-BETA2</li>
</ul><p class="paragraph"/><h4>Controlling Load Order</h4><p class="paragraph"/>Using <code>dependsOn</code> establishes a "hard" dependency in that if the dependency is not resolved, the plugin will give up and won't load.  It is possible though to have a weaker dependency using the <code>loadAfter</code> property:<p class="paragraph"/><div class="code"><pre>def loadAfter = &#91;'controllers'&#93;</pre></div><p class="paragraph"/>Here the plugin will be loaded after the <code>controllers</code> plugin if it exists, otherwise it will just be loaded. The plugin can then adapt to the presence of the other plugin, for example the Hibernate plugin has this code in its <code>doWithSpring</code> closure:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">if</span> (manager?.hasGrailsPlugin(<span class="java&#45;quote">"controllers"</span>)) &#123;
    openSessionInViewInterceptor(OpenSessionInViewInterceptor) &#123;
        flushMode = HibernateAccessor.FLUSH_MANUAL
        sessionFactory = sessionFactory
    &#125;
    grailsUrlHandlerMapping.interceptors &#60;&#60; openSessionInViewInterceptor
&#125;</pre></div><p class="paragraph"/>Here the Hibernate plugin will only register an <code>OpenSessionInViewInterceptor</code> if the <code>controllers</code> plugin has been loaded. The <code>manager</code> variable is an instance of the <a href="../../api/org/codehaus/groovy/grails/plugins/GrailsPluginManager.html" class="api">GrailsPluginManager</a> interface and it provides methods to interact with other plugins.<p class="paragraph"/>
<h4>Scopes and Environments</h4><p class="paragraph"/>It's not only plugin load order that you can control. You can also specify which environments your plugin should be loaded in and which scopes (stages of a build). Simply declare one or both of these properties in your plugin descriptor:<p class="paragraph"/><div class="code"><pre>def environments = &#91;'development', 'test', 'myCustomEnv'&#93;
def scopes = &#91;excludes:'war'&#93;</pre></div><p class="paragraph"/>In this example, the plugin will only load in the 'development' and 'test' environments. Nor will it be packaged into the WAR file, because it's excluded from the 'war' phase. This allows <code>development-only</code> plugins to not be packaged for production use.<p class="paragraph"/>The full list of available scopes are defined by the enum <a href="../../api/grails/util/BuildScope.html" class="api">BuildScope</a>, but here's a summary:
<ul class="star">
<li><code>test</code> - when running tests</li>
<li><code>functional-test</code> - when running functional tests</li>
<li><code>run</code> - for run-app and run-war</li>
<li><code>war</code> - when packaging the application as a WAR file</li>
<li><code>all</code> - plugin applies to all scopes (default)</li>
</ul><p class="paragraph"/>Both properties can be one of:
<ul class="star">
<li>a string - a sole inclusion</li>
<li>a list - a list of environments or scopes to include</li>
<li>a map - for full control, with 'includes' and/or 'excludes' keys that can have string or list values</li>
</ul><p class="paragraph"/>For example,<p class="paragraph"/><div class="code"><pre>def environments = <span class="java&#45;quote">"test"</span></pre></div><p class="paragraph"/>will only include the plugin in the test environment, whereas<p class="paragraph"/><div class="code"><pre>def environments = &#91;<span class="java&#45;quote">"development"</span>, <span class="java&#45;quote">"test"</span>&#93;</pre></div><p class="paragraph"/>will include it in both the development  <em class="italic">and</em>  test environments. Finally,<p class="paragraph"/><div class="code"><pre>def environments = &#91;includes: &#91;<span class="java&#45;quote">"development"</span>, <span class="java&#45;quote">"test"</span>&#93;&#93;</pre></div><p class="paragraph"/>will do the same thing.



<h2 id="artefactApi">12.11 The Artefact API</h2>
You should by now understand that Grails has the concept of artefacts: special types of classes that it knows about and can treat differently from normal Groovy and Java classes, for example by enhancing them with extra properties and methods. Examples of artefacts include domain classes and controllers. What you may not be aware of is that Grails allows application and plugin developers access to the underlying infrastructure for artefacts, which means you can find out what artefacts are available and even enhance them yourself. You can even provide your own custom artefact types.



<h2 id="queryingArtefacts">12.11.1 Asking About Available Artefacts</h2>
As a plugin developer, it can be important for you to find out about what domain classes, controllers, or other types of artefact are available in an application. For example, the <a href="http://grails.org/plugin/searchable" target="blank">Searchable plugin</a> needs to know what domain classes exist so it can check them for any <code>searchable</code> properties and index the appropriate ones. So how does it do it? The answer lies with the <code>grailsApplication</code> object, and instance of <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> that's available automatically in controllers and GSPs and can be <a href="../guide/single.html#dependencyInjectionServices" class="guide">injected</a> everywhere else.<p class="paragraph"/>The <code>grailsApplication</code> object has several important properties and methods for querying artefacts. Probably the most common is the one that gives you all the classes of a particular artefact type:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">for</span> (cls in grailsApplication.&#60;artefactType&#62;Classes) &#123;
    &#8230;
&#125;</pre></div><p class="paragraph"/>In this case, <code>artefactType</code> is the property name form of the artefact type. With core Grails you have:
<ul class="star">
<li>domain</li>
<li>controller</li>
<li>tagLib</li>
<li>service</li>
<li>codec</li>
<li>bootstrap</li>
<li>urlMappings</li>
</ul><p class="paragraph"/>So for example, if you want to iterate over all the domain classes, you use:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">for</span> (cls in grailsApplication.domainClasses) &#123;
    &#8230;
&#125;</pre></div><p class="paragraph"/>and for URL mappings:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">for</span> (cls in grailsApplication.urlMappingsClasses) &#123;
    &#8230;
&#125;</pre></div><p class="paragraph"/>You need to be aware that the objects returned by these properties are not instances of <a href="http://download.oracle.com/javase/1.5.0/docs/api/java/lang/Class.html" class="api">Class</a>. Instead, they are instances of <a href="../../api/org/codehaus/groovy/grails/commons/GrailsClass.html" class="api">GrailsClass</a> that has some particularly useful properties and methods, including one for the underlying <code>Class</code>:
<ul class="star">
<li><code>shortName</code> - the class name of the artefact without the package (equivalent of <code>Class.simpleName</code>).</li>
<li><code>logicalPropertyName</code> - the artefact name in property form without the 'type' suffix. So <code>MyGreatController</code> becomes 'myGreat'.</li>
<li><code>isAbstract()</code> - a boolean indicating whether the artefact class is abstract or not.</li>
<li><code>getPropertyValue(name)</code> - returns the value of the given property, whether it's a static or an instance one. This works best if the property is initialised on declaration, e.g. <code>static transactional = true</code>.</li>
</ul><p class="paragraph"/>The artefact API also allows you to fetch classes by name and check whether a class is an artefact:
<ul class="star">
<li>get&#60;type&#62;Class(String name)</li>
<li>is&#60;type&#62;Class(Class clazz)</li>
</ul><p class="paragraph"/>The first method will retrieve the <code>GrailsClass</code> instance for the given name, e.g. 'MyGreatController'. The second will check whether a class is a particular type of artefact. For example, you can use <code>grailsApplication.isControllerClass(org.example.MyGreatController)</code> to check whether <code>MyGreatController</code> is in fact a controller.



<h2 id="customArtefacts">12.11.2 Adding Your Own Artefact Types</h2>
Plugins can easily provide their own artefacts so that they can easily find out what implementations are available and take part in reloading. All you need to do is create an <code>ArtefactHandler</code> implementation and register it in your main plugin class:<p class="paragraph"/><div class="code"><pre>class MyGrailsPlugin &#123;
    def artefacts = &#91; org.somewhere.MyArtefactHandler &#93;
    &#8230;
&#125;</pre></div><p class="paragraph"/>The <code>artefacts</code> list can contain either handler classes (as above) or instances of handlers.<p class="paragraph"/>So, what does an artefact handler look like? Well, put simply it is an implementation of the <a href="../../api/org/codehaus/groovy/grails/commons/ArtefactHandler.html" class="api">ArtefactHandler</a> interface. To make life a bit easier, there is a skeleton implementation that can readily be extended: <a href="../../api/org/codehaus/groovy/grails/commons/ArtefactHandlerAdapter.html" class="api">ArtefactHandlerAdapter</a>.<p class="paragraph"/>In addition to the handler itself, every new artefact needs a corresponding wrapper class that implements <a href="../../api/org/codehaus/groovy/grails/commons/GrailsClass.html" class="api">GrailsClass</a>. Again, skeleton implementations are available such as <a href="../../api/org/codehaus/groovy/grails/commons/AbstractInjectableGrailsClass.html" class="api">AbstractInjectableGrailsClass</a>, which is particularly useful as it turns your artefact into a Spring bean that is auto-wired, just like controllers and services.<p class="paragraph"/>The best way to understand how both the handler and wrapper classes work is to look at the Quartz plugin:
<ul class="star">
<li><a href="http://github.com/nebolsin/grails-quartz/blob/master/src/java/grails/plugins/quartz/GrailsJobClass.java" target="blank">GrailsJobClass</a></li>
<li><a href="http://github.com/nebolsin/grails-quartz/blob/master/src/java/grails/plugins/quartz/DefaultGrailsJobClass.java" target="blank">DefaultGrailsJobClass</a></li>
<li><a href="http://github.com/nebolsin/grails-quartz/blob/master/src/java/grails/plugins/quartz/JobArtefactHandler.java" target="blank">JobArtefactHandler</a></li>
</ul><p class="paragraph"/>Another example is the <a href="http://github.com/pledbrook/grails-shiro" target="blank">Shiro plugin</a> which adds a realm artefact.


<a name="12.11 Binary Plugins"><!-- Legacy link --></a>
<h2 id="binaryPlugins">12.12 Binary Plugins</h2>
Regular Grails plugins are packaged as zip files containing the full source of the plugin. This has some advantages in terms of being an open distribution system (anyone can see the source), in addition to avoiding problems with the source compatibility level used for compilation.<p class="paragraph"/>As of Grails 2.0 you can pre-compile Grails plugins into regular JAR files known as "binary plugins". This has several advantages (and some disadvantages as discussed in the advantages of source plugins above) including:
<ul class="star">
<li>Binary plugins can be published as standard JAR files to a Maven repository</li>
<li>Binary plugins can be declared like any other JAR dependency</li>
<li>Commercial plugins are more viable since the source isn't published</li>
<li>IDEs have a better understanding since binary plugins are regular JAR files containing classes</li>
</ul><p class="paragraph"/><h4>Packaging</h4><p class="paragraph"/>To package a plugin in binary form you can use the package-plugin command and the <code>--binary</code> flag:<p class="paragraph"/><div class="code"><pre>grails <span class="java&#45;keyword">package</span>&#45;plugin &#45;&#45;binary</pre></div><p class="paragraph"/>Supported artefacts include:
<ul class="star">
<li>Grails artifact classes such as controllers, domain classes and so on</li>
<li>I18n Message bundles</li>
<li>GSP Views, layouts and templates</li>
</ul><p class="paragraph"/>You can also specify the packaging in the plugin descriptor:<p class="paragraph"/><div class="code"><pre>def packaging = <span class="java&#45;quote">"binary"</span></pre></div><p class="paragraph"/>in which case the packaging will default to binary.<p class="paragraph"/><h4>Using Binary Plugins</h4><p class="paragraph"/>The packaging process creates a JAR file in the <code>target</code> directory of the plugin, for example <code>target/foo-plugin-0.1.jar</code>. There are two ways to incorporate a binary plugin into an application.<p class="paragraph"/>One is simply placing the plugin JAR file in your application's <code>lib</code> directory. The other is to publish the plugin JAR to a compatible Maven repository and declare it as a dependency in <code>grails-app/conf/BuildConfig.groovy</code>:<p class="paragraph"/><div class="code"><pre>dependencies &#123;
    compile <span class="java&#45;quote">"mycompany:myplugin:0.1"</span>
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
Since binary plugins are packaged as JAR files, they are declared as dependencies in the <code>dependencies</code> block,  <em class="italic">not</em>  in the <code>plugins</code> block as you may be naturally inclined to do. The <code>plugins</code> block is used for declaring traditional source plugins packaged as zip files
</blockquote>


<a name="13. Web Services"><!-- Legacy link --></a>
<h1 id="webServices">13 Web Services</h1>
Web services are all about providing a web API onto your web application and are typically implemented in either <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer" target="blank">REST</a> or <a href="http://en.wikipedia.org/wiki/SOAP." target="blank">SOAP</a>


<a name="13.1 REST"><!-- Legacy link --></a>
<h2 id="REST">13.1 REST</h2>
REST is not really a technology in itself, but more an architectural pattern. REST is very simple and just involves using plain XML or JSON as a communication medium, combined with URL patterns that are "representational" of the underlying system, and HTTP methods such as GET, PUT, POST and DELETE.<p class="paragraph"/>Each HTTP method maps to an action type. For example GET for retrieving data, PUT for creating data, POST for updating and so on. In this sense REST fits quite well with <a href="../guide/single.html#scaffolding" class="guide">CRUD</a>.<p class="paragraph"/><h4>URL patterns</h4><p class="paragraph"/>The first step to implementing REST with Grails is to provide RESTful <a href="../guide/single.html#urlmappings" class="guide">URL mappings</a>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mappings = &#123;
   <span class="java&#45;quote">"/product/$id?"</span>(resource:<span class="java&#45;quote">"product"</span>)
&#125;</pre></div><p class="paragraph"/>This maps the URI <code>/product</code> onto a <code>ProductController</code>. Each HTTP method such as GET, PUT, POST and DELETE map to unique actions within the controller as outlined by the table below:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Method</th><th>Action</th></tr><tr class="table-odd"><td><code>GET</code></td><td><code>show</code></td></tr><tr class="table-even"><td><code>PUT</code></td><td><code>update</code></td></tr><tr class="table-odd"><td><code>POST</code></td><td><code>save</code></td></tr><tr class="table-even"><td><code>DELETE</code></td><td><code>delete</code></td></tr></table><p class="paragraph"/>In addition, Grails provides automatic XML or JSON marshalling for you.<p class="paragraph"/>You can alter how HTTP methods are handled by using URL Mappings to <a href="../guide/single.html#mappingHTTP" class="guide">map to HTTP methods</a>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/product/$id"</span>(controller: <span class="java&#45;quote">"product"</span>) &#123;
    action = &#91;GET: <span class="java&#45;quote">"show"</span>, PUT: <span class="java&#45;quote">"update"</span>, DELETE: <span class="java&#45;quote">"delete"</span>, POST: <span class="java&#45;quote">"save"</span>&#93;
&#125;</pre></div><p class="paragraph"/>However, unlike the <code>resource</code> argument used previously, in this case Grails will not provide automatic XML or JSON marshalling unless you specify the <code>parseRequest</code> argument:<p class="paragraph"/><div class="code"><pre><span class="java&#45;quote">"/product/$id"</span>(controller: <span class="java&#45;quote">"product"</span>, parseRequest: <span class="java&#45;keyword">true</span>) &#123;
    action = &#91;GET: <span class="java&#45;quote">"show"</span>, PUT: <span class="java&#45;quote">"update"</span>, DELETE: <span class="java&#45;quote">"delete"</span>, POST: <span class="java&#45;quote">"save"</span>&#93;
&#125;</pre></div><p class="paragraph"/><h4>HTTP Methods</h4><p class="paragraph"/>In the previous section you saw how you can easily define URL mappings that map specific HTTP methods onto specific controller actions. Writing a REST client that then sends a specific HTTP method is then easy (example in Groovy's HTTPBuilder module):<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> groovyx.net.http.&#42;
<span class="java&#45;keyword">import</span> <span class="java&#45;keyword">static</span> groovyx.net.http.ContentType.JSON<p class="paragraph"/>def http = <span class="java&#45;keyword">new</span> HTTPBuilder(<span class="java&#45;quote">"http://localhost:8080/amazon"</span>)<p class="paragraph"/> http.request(Method.GET, JSON) &#123;
     url.path = '/book/list'
     response.success = &#123; resp, json &#45;&#62;
         <span class="java&#45;keyword">for</span> (book in json.books) &#123;
             println book.title
         &#125;
     &#125;
 &#125;</pre></div><p class="paragraph"/>Issuing a request with a method other than <code>GET</code> or <code>POST</code> from a regular browser is not possible without some help from Grails. When defining a <a href="../ref/Tags/form.html" class="tags">form</a> you can specify an alternative method such as <code>DELETE</code>:<p class="paragraph"/><div class="code"><pre>&#60;g:form controller=<span class="java&#45;quote">"book"</span> method=<span class="java&#45;quote">"DELETE"</span>&#62;
    ..
&#60;/g:form&#62;</pre></div><p class="paragraph"/>Grails will send a hidden parameter called <code>_method</code>, which will be used as the request's HTTP method. Another alternative for changing the method for non-browser clients is to use the <code>X-HTTP-Method-Override</code> to specify the alternative method name.<p class="paragraph"/><h4>XML Marshalling - Reading</h4><p class="paragraph"/>The controller can use Grails' <a href="../guide/single.html#xmlAndJSON" class="guide">XML marshalling</a> support to implement the GET method:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.converters.XML<p class="paragraph"/>class ProductController &#123;
    def show() &#123;
        <span class="java&#45;keyword">if</span> (params.id &#38;&#38; Product.exists(params.id)) &#123;
            def p = Product.findByName(params.id)
            render p as XML
        &#125;
        <span class="java&#45;keyword">else</span> &#123;
            def all = Product.list()
            render all as XML
        &#125;
    &#125;
    ..
&#125;</pre></div><p class="paragraph"/>If there is an <code>id</code> we search for the <code>Product</code> by name and return it, otherwise we return all Products. This way if we go to <code>/products</code> we get all products, otherwise if we go to <code>/product/MacBook</code> we only get a MacBook.<p class="paragraph"/><h4>XML Marshalling - Updating</h4><p class="paragraph"/>To support updates such as <code>PUT</code> and <code>POST</code> you can use the <a href="../ref/Controllers/params.html" class="controllers">params</a> object which Grails enhances with the ability to read an incoming XML packet. Given an incoming XML packet of:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;?xml version=<span class="xml&#45;quote">"1.0"</span> encoding=<span class="xml&#45;quote">"ISO&#45;8859&#45;1"</span>?&#62;</span>
<span class="xml&#45;tag">&#60;product&#62;</span>
    <span class="xml&#45;tag">&#60;name&#62;</span>MacBook<span class="xml&#45;tag">&#60;/name&#62;</span>
    <span class="xml&#45;tag">&#60;vendor id=<span class="xml&#45;quote">"12"</span>&#62;</span>
        <span class="xml&#45;tag">&#60;name&#62;</span>Apple<span class="xml&#45;tag">&#60;/name&#62;</span>
     <span class="xml&#45;tag">&#60;/vender&#62;</span>
<span class="xml&#45;tag">&#60;/product&#62;</span></pre></div><p class="paragraph"/>you can read this XML packet using the same techniques described in the <a href="../guide/single.html#dataBinding" class="guide">Data Binding</a> section, using the <a href="../ref/Controllers/params.html" class="controllers">params</a> object:<p class="paragraph"/><div class="code"><pre>def save() &#123;
    def p = <span class="java&#45;keyword">new</span> Product(params.product)<p class="paragraph"/>    <span class="java&#45;keyword">if</span> (p.save()) &#123;
        render p as XML
    &#125;
    <span class="java&#45;keyword">else</span> &#123;
        render p.errors
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example by indexing into the <code>params</code> object using the <code>product</code> key we can automatically create and bind the XML using the <code>Product</code> constructor. An interesting aspect of the line:<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Product(params.product)</pre></div><p class="paragraph"/>is that it requires no code changes to deal with a form submission that submits form data, or an XML request, or a JSON request.<p class="paragraph"/><blockquote class="note">
If you require different responses to different clients (REST, HTML etc.) you can use <a href="../guide/single.html#contentNegotiation" class="guide">content negotation</a>
</blockquote><p class="paragraph"/>The <code>Product</code> object is then saved and rendered as XML, otherwise an error message is produced using Grails' <a href="../guide/single.html#validation" class="guide">validation</a> capabilities in the form:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;error&#62;</span>
   <span class="xml&#45;tag">&#60;message&#62;</span>The property 'title' of class 'Person' must be specified<span class="xml&#45;tag">&#60;/message&#62;</span>
<span class="xml&#45;tag">&#60;/error&#62;</span></pre></div><p class="paragraph"/><h4>REST with JAX-RS</h4><p class="paragraph"/>There also is a <a href="http://grails.org/plugin/jaxrs" target="blank">JAX-RS Plugin</a> which can be used to build web services based on the Java API for RESTful Web Services (<a href="http://jcp.org/en/jsr/summary?id=311" target="blank">JSR 311: JAX-RS</a>).


<a name="13.2 SOAP"><!-- Legacy link --></a>
<h2 id="SOAP">13.2 SOAP</h2>
There are several plugins that add SOAP support to Grails depending on your preferred approach. For Contract First SOAP services there is a <a href="http://grails.org/plugin/springws" target="blank">Spring WS</a> plugin, whilst if you want to generate a SOAP API from Grails services there are several plugins that do this including:
<ul class="star">
<li><a href="http://grails.org/plugin/cxf/" target="blank">CXF</a> plugin which uses the <a href="http://cxf.apache.org/" target="blank">CXF</a> SOAP stack</li>
<li><a href="http://grails.org/plugin/axis2" target="blank">Axis2</a> plugin which uses <a href="http://ws.apache.org/axis2/" target="blank">Axis2</a></li>
<li><a href="https://jax-ws-commons.dev.java.net/grails/" target="blank">Metro</a> plugin which uses the <a href="https://jax-ws-commons.dev.java.net/grails/" target="blank">Metro</a> framework (and can also be used for <a href="http://docs.codehaus.org/pages/viewpage.action?pageId=88342530" target="blank">Contract First</a>)</li>
</ul><p class="paragraph"/>Most of the SOAP integrations integrate with Grails <a href="../guide/single.html#services" class="guide">services</a> via the <code>exposes</code> static property. This example is taken from the CXF plugin:<p class="paragraph"/><div class="code"><pre>class BookService &#123;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> expose = &#91;'cxf'&#93;<p class="paragraph"/>    Book&#91;&#93; getBooks() &#123;
        Book.list() as Book&#91;&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>The WSDL can then be accessed at the location: <code>http://127.0.0.1:8080/your_grails_app/services/book?wsdl</code><p class="paragraph"/>For more information on the CXF plugin refer to <a href="http://grails.org/plugin/cxf" target="blank">the documentation</a> on the wiki.


<a name="13.3 RSS and Atom"><!-- Legacy link --></a>
<h2 id="RSSAndAtom">13.3 RSS and Atom</h2>
No direct support is provided for RSS or Atom within Grails. You could construct RSS or ATOM feeds with the <a href="../ref/Controllers/render.html" class="controllers">render</a> method's XML capability. There is however a <a href="http://grails.org/plugin/feeds" target="blank">Feeds plugin</a> available for Grails that provides a RSS and Atom builder using the popular <a href="https://rome.dev.java.net/" target="blank">ROME</a> library. An example of its usage can be seen below:<p class="paragraph"/><div class="code"><pre>def feed() &#123;
    render(feedType: <span class="java&#45;quote">"rss"</span>, feedVersion: <span class="java&#45;quote">"2.0"</span>) &#123;
        title = <span class="java&#45;quote">"My test feed"</span>
        link = <span class="java&#45;quote">"http://your.test.server/yourController/feed"</span><p class="paragraph"/>        <span class="java&#45;keyword">for</span> (article in Article.list()) &#123;
            entry(article.title) &#123;
                link = <span class="java&#45;quote">"http://your.test.server/article/&#36;&#123;article.id&#125;"</span>
                article.content // <span class="java&#45;keyword">return</span> the content
            &#125;
        &#125;
    &#125;
&#125;</pre></div>


<a name="14. Grails and Spring"><!-- Legacy link --></a>
<h1 id="spring">14 Grails and Spring</h1>
This section is for advanced users and those who are interested in how Grails integrates with and builds on the <a href="http://www.springframework.org/." target="blank">Spring Framework</a> It is also useful for <a href="../guide/single.html#plugins" class="guide">plugin developers</a> considering doing runtime configuration Grails.


<a name="14.1 The Underpinnings of Grails"><!-- Legacy link --></a>
<h2 id="theUnderpinningsOfGrails">14.1 The Underpinnings of Grails</h2>
Grails is actually a <a href="http://www.springframework.org/docs/MVC-step-by-step/Spring-MVC-step-by-step.html" target="blank">Spring MVC</a> application in disguise. Spring MVC is the Spring framework's built-in MVC web application framework. Although Spring MVC suffers from some of the same difficulties as frameworks like Struts in terms of its ease of use, it is superbly designed and architected and was, for Grails, the perfect framework to build another framework on top of.<p class="paragraph"/>Grails leverages Spring MVC in the following areas:
<ul class="star">
<li>Basic controller logic - Grails subclasses Spring's <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/servlet/DispatcherServlet.html" class="api">DispatcherServlet</a> and uses it to delegate to Grails <a href="../guide/single.html#controllers" class="guide">controllers</a></li>
<li>Data Binding and Validation - Grails' <a href="../guide/single.html#validation" class="guide">validation</a> and <a href="../guide/single.html#dataBinding" class="guide">data binding</a> capabilities are built on those provided by Spring</li>
<li>Runtime configuration - Grails' entire runtime convention based system is wired together by a Spring <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationContext.html" class="api">ApplicationContext</a></li>
<li>Transactions - Grails uses Spring's transaction management in <a href="../guide/single.html#GORM" class="guide">GORM</a></li>
</ul><p class="paragraph"/>In other words Grails has Spring embedded running all the way through it.<p class="paragraph"/><h4>The Grails ApplicationContext</h4><p class="paragraph"/>Spring developers are often keen to understand how the Grails <code>ApplicationContext</code> instance is constructed. The basics of it are as follows.
<ul class="star">
<li>Grails constructs a parent <code>ApplicationContext</code> from the <code>web-app/WEB-INF/applicationContext.xml</code> file. This <code>ApplicationContext</code> configures the <a href="../../api/org/codehaus/groovy/grails/commons/GrailsApplication.html" class="api">GrailsApplication</a> instance and the <a href="../../api/org/codehaus/groovy/grails/plugins/GrailsPluginManager.html" class="api">GrailsPluginManager</a>.</li>
<li>Using this <code>ApplicationContext</code> as a parent Grails' analyses the conventions with the <code>GrailsApplication</code> instance and constructs a child <code>ApplicationContext</code> that is used as the root <code>ApplicationContext</code> of the web application</li>
</ul><p class="paragraph"/><h4>Configured Spring Beans</h4><p class="paragraph"/>Most of Grails' configuration happens at runtime. Each <a href="../guide/single.html#plugins" class="guide">plugin</a> may configure Spring beans that are registered in the <code>ApplicationContext</code>. For a reference as to which beans are configured, refer to the reference guide which describes each of the Grails plugins and which beans they configure.


<a name="14.2 Configuring Additional Beans"><!-- Legacy link --></a>
<h2 id="springdslAdditional">14.2 Configuring Additional Beans</h2>
<h4>Using the Spring Bean DSL</h4><p class="paragraph"/>You can easily register new (or override existing) beans by configuring them in <code>grails-app/conf/spring/resources.groovy</code> which uses the Grails <a href="../guide/single.html#springdsl" class="guide">Spring DSL</a>. Beans are defined inside a <code>beans</code> property (a Closure):<p class="paragraph"/><div class="code"><pre>beans = &#123;
    // beans here
&#125;</pre></div><p class="paragraph"/>As a simple example you can configure a bean with the following syntax:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> my.company.MyBeanImpl<p class="paragraph"/>beans = &#123;
    myBean(MyBeanImpl) &#123;
        someProperty = 42
        otherProperty = <span class="java&#45;quote">"blue"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Once configured, the bean can be auto-wired into Grails artifacts and other classes that support dependency injection (for example <code>BootStrap.groovy</code> and integration tests) by declaring a public field whose name is your bean's name (in this case <code>myBean</code>):<p class="paragraph"/><div class="code"><pre>class ExampleController &#123;<p class="paragraph"/>     def myBean
     &#8230;
&#125;</pre></div><p class="paragraph"/>Using the DSL has the advantage that you can mix bean declarations and logic, for example based on the <a href="../guide/single.html#environments" class="guide">environment</a>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.util.Environment
<span class="java&#45;keyword">import</span> my.company.mock.MockImpl
<span class="java&#45;keyword">import</span> my.company.MyBeanImpl<p class="paragraph"/>beans = &#123;
    <span class="java&#45;keyword">switch</span>(Environment.current) &#123;
        <span class="java&#45;keyword">case</span> Environment.PRODUCTION:
            myBean(MyBeanImpl) &#123;
                someProperty = 42
                otherProperty = <span class="java&#45;quote">"blue"</span>
            &#125;
            <span class="java&#45;keyword">break</span><p class="paragraph"/>        <span class="java&#45;keyword">case</span> Environment.DEVELOPMENT:
            myBean(MockImpl) &#123;
                someProperty = 42
                otherProperty = <span class="java&#45;quote">"blue"</span>
            &#125;
            <span class="java&#45;keyword">break</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>GrailsApplication</code> object can be accessed with the <code>application</code> variable and can be used to access the Grails configuration (amongst other things):<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.util.Environment
<span class="java&#45;keyword">import</span> my.company.mock.MockImpl
<span class="java&#45;keyword">import</span> my.company.MyBeanImpl<p class="paragraph"/>beans = &#123;
    <span class="java&#45;keyword">if</span> (application.config.my.company.mockService) &#123;
        myBean(MockImpl) &#123;
            someProperty = 42
            otherProperty = <span class="java&#45;quote">"blue"</span>
        &#125;
    &#125; <span class="java&#45;keyword">else</span> &#123;
        myBean(MyBeanImpl) &#123;
            someProperty = 42
            otherProperty = <span class="java&#45;quote">"blue"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
If you define a bean in <code>resources.groovy</code> with the same name as one previously registered by Grails or an installed plugin, your bean will replace the previous registration. This is a convenient way to customize behavior without resorting to editing plugin code or other approaches that would affect maintainability.
</blockquote><p class="paragraph"/><h4>Using XML</h4><p class="paragraph"/>Beans can also be configured using a <code>grails-app/conf/spring/resources.xml</code>. In earlier versions of Grails this file was automatically generated for you by the <code>run-app</code> script, but the DSL in <code>resources.groovy</code> is the preferred approach now so it isn't automatically generated now. But it is still supported - you just need to create it yourself.<p class="paragraph"/>This file is typical Spring XML file and the Spring documentation has an <a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/beans.html#beans-basics" target="blank">excellent reference</a> on how to configure Spring beans.<p class="paragraph"/>The <code>myBean</code> bean that we configured using the DSL would be configured with this syntax in the XML file:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;bean id=<span class="xml&#45;quote">"myBean"</span> class=<span class="xml&#45;quote">"my.company.MyBeanImpl"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"someProperty"</span> value=<span class="xml&#45;quote">"42"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"otherProperty"</span> value=<span class="xml&#45;quote">"blue"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/bean&#62;</span></pre></div><p class="paragraph"/>Like the other bean it can be auto-wired into any class that supports dependency injection:<p class="paragraph"/><div class="code"><pre>class ExampleController &#123;<p class="paragraph"/>     def myBean
&#125;</pre></div><p class="paragraph"/><h4>Referencing Existing Beans</h4><p class="paragraph"/>Beans declared in <code>resources.groovy</code> or <code>resources.xml</code> can reference other beans by convention. For example if you had a <code>BookService</code> class its Spring bean name would be <code>bookService</code>, so your bean would reference it like this in the DSL:<p class="paragraph"/><div class="code"><pre>beans = &#123;
    myBean(MyBeanImpl) &#123;
        someProperty = 42
        otherProperty = <span class="java&#45;quote">"blue"</span>
        bookService = ref(<span class="java&#45;quote">"bookService"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>or like this in XML:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;bean id=<span class="xml&#45;quote">"myBean"</span> class=<span class="xml&#45;quote">"my.company.MyBeanImpl"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"someProperty"</span> value=<span class="xml&#45;quote">"42"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"otherProperty"</span> value=<span class="xml&#45;quote">"blue"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"bookService"</span> ref=<span class="xml&#45;quote">"bookService"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/bean&#62;</span></pre></div><p class="paragraph"/>The bean needs a public setter for the bean reference (and also the two simple properties), which in Groovy would be defined like this:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> my.company<p class="paragraph"/>class MyBeanImpl &#123;
    <span class="java&#45;object">Integer</span> someProperty
    <span class="java&#45;object">String</span> otherProperty
    BookService bookService // or just <span class="java&#45;quote">"def bookService"</span>
&#125;</pre></div><p class="paragraph"/>or in Java like this:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> my.company;<p class="paragraph"/>class MyBeanImpl &#123;<p class="paragraph"/>    <span class="java&#45;keyword">private</span> BookService bookService;
    <span class="java&#45;keyword">private</span> <span class="java&#45;object">Integer</span> someProperty;
    <span class="java&#45;keyword">private</span> <span class="java&#45;object">String</span> otherProperty;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> void setBookService(BookService theBookService) &#123;
        <span class="java&#45;keyword">this</span>.bookService = theBookService;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> void setSomeProperty(<span class="java&#45;object">Integer</span> someProperty) &#123;
        <span class="java&#45;keyword">this</span>.someProperty = someProperty;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> void setOtherProperty(<span class="java&#45;object">String</span> otherProperty) &#123;
        <span class="java&#45;keyword">this</span>.otherProperty = otherProperty;
    &#125;
&#125;</pre></div><p class="paragraph"/>Using <code>ref</code> (in XML or the DSL) is very powerful since it configures a runtime reference, so the referenced bean doesn't have to exist yet. As long as it's in place when the final application context configuration occurs, everything will be resolved correctly.<p class="paragraph"/>For a full reference of the available beans see the plugin reference in the reference guide.


<a name="14.3 Runtime Spring with the Beans DSL"><!-- Legacy link --></a>
<h2 id="springdsl">14.3 Runtime Spring with the Beans DSL</h2>
This Bean builder in Grails aims to provide a simplified way of wiring together dependencies that uses Spring at its core.<p class="paragraph"/>In addition, Spring's regular way of configuration (via XML and annotations) is static and difficult to modify and configure at runtime, other than programmatic XML creation which is both error prone and verbose. Grails' <a href="../../api/grails/spring/BeanBuilder.html" class="api">BeanBuilder</a> changes all that by making it possible to programmatically wire together components at runtime, allowing you to adapt the logic based on system properties or environment variables.<p class="paragraph"/>This enables the code to adapt to its environment and avoids unnecessary duplication of code (having different Spring configs for test, development and production environments)<p class="paragraph"/><h4>The BeanBuilder class</h4><p class="paragraph"/>Grails provides a <a href="../../api/grails/spring/BeanBuilder.html" class="api">grails.spring.BeanBuilder</a> class that uses dynamic Groovy to construct bean definitions. The basics are as follows:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.commons.dbcp.BasicDataSource
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.orm.hibernate.ConfigurableLocalSessionFactoryBean
<span class="java&#45;keyword">import</span> org.springframework.context.ApplicationContext
<span class="java&#45;keyword">import</span> grails.spring.BeanBuilder<p class="paragraph"/>def bb = <span class="java&#45;keyword">new</span> BeanBuilder()<p class="paragraph"/>bb.beans &#123;<p class="paragraph"/>    dataSource(BasicDataSource) &#123;
        driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
        url = <span class="java&#45;quote">"jdbc:h2:mem:grailsDB"</span>
        username = <span class="java&#45;quote">"sa"</span>
        password = <span class="java&#45;quote">""</span>
    &#125;<p class="paragraph"/>    sessionFactory(ConfigurableLocalSessionFactoryBean) &#123;
        dataSource = ref('dataSource')
        hibernateProperties = &#91;<span class="java&#45;quote">"hibernate.hbm2ddl.auto"</span>: <span class="java&#45;quote">"create&#45;drop"</span>,
                               <span class="java&#45;quote">"hibernate.show_sql"</span>:     <span class="java&#45;quote">"<span class="java&#45;keyword">true</span>"</span>&#93;
    &#125;
&#125;<p class="paragraph"/>ApplicationContext appContext = bb.createApplicationContext()</pre></div><p class="paragraph"/><blockquote class="note">
Within <a href="../guide/single.html#plugins" class="guide">plugins</a> and the <a href="../guide/single.html#springdslAdditional" class="guide">grails-app/conf/spring/resources.groovy</a> file you don't need to create a new instance of <code>BeanBuilder</code>. Instead the DSL is implicitly available inside the <code>doWithSpring</code> and <code>beans</code> blocks respectively.
</blockquote><p class="paragraph"/>This example shows how you would configure Hibernate with a data source with the <code>BeanBuilder</code> class.<p class="paragraph"/>Each method call (in this case <code>dataSource</code> and <code>sessionFactory</code> calls) maps to the name of the bean in Spring. The first argument to the method is the bean's class, whilst the last argument is a block. Within the body of the block you can set properties on the bean using standard Groovy syntax.<p class="paragraph"/>Bean references are resolved automatically using the name of the bean. This can be seen in the example above with the way the <code>sessionFactory</code> bean resolves the <code>dataSource</code> reference.<p class="paragraph"/>Certain special properties related to bean management can also be set by the builder, as seen in the following code:<p class="paragraph"/><div class="code"><pre>sessionFactory(ConfigurableLocalSessionFactoryBean) &#123; bean &#45;&#62;
    // Autowiring behaviour. The other option is 'byType'. &#91;autowire&#93;
    bean.autowire = 'byName'
    // Sets the initialisation method to 'init'. &#91;init&#45;method&#93;
    bean.initMethod = 'init'
    // Sets the destruction method to 'destroy'. &#91;destroy&#45;method&#93;
    bean.destroyMethod = 'destroy'
    // Sets the scope of the bean. &#91;scope&#93;
    bean.scope = 'request'
    dataSource = ref('dataSource')
    hibernateProperties = &#91;<span class="java&#45;quote">"hibernate.hbm2ddl.auto"</span>: <span class="java&#45;quote">"create&#45;drop"</span>,
                           <span class="java&#45;quote">"hibernate.show_sql"</span>:     <span class="java&#45;quote">"<span class="java&#45;keyword">true</span>"</span>&#93;
&#125;</pre></div><p class="paragraph"/>The strings in square brackets are the names of the equivalent bean attributes in Spring's XML definition.<p class="paragraph"/><h4>Using BeanBuilder with Spring MVC</h4><p class="paragraph"/>Include the <code>grails-spring-&#60;version&#62;.jar</code> file in your classpath to use BeanBuilder in a regular Spring MVC application. Then add the following <code>&#60;context-param&#62;</code> values to your <code>/WEB-INF/web.xml</code> file:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;context&#45;param&#62;</span>
    <span class="xml&#45;tag">&#60;param&#45;name&#62;</span>contextConfigLocation<span class="xml&#45;tag">&#60;/param&#45;name&#62;</span>
    <span class="xml&#45;tag">&#60;param&#45;value&#62;</span>/WEB&#45;INF/applicationContext.groovy<span class="xml&#45;tag">&#60;/param&#45;value&#62;</span>
<span class="xml&#45;tag">&#60;/context&#45;param&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;context&#45;param&#62;</span>
    <span class="xml&#45;tag">&#60;param&#45;name&#62;</span>contextClass<span class="xml&#45;tag">&#60;/param&#45;name&#62;</span>
    <span class="xml&#45;tag">&#60;param&#45;value&#62;</span>
      org.codehaus.groovy.grails.commons.spring.GrailsWebApplicationContext
    <span class="xml&#45;tag">&#60;/param&#45;value&#62;</span>
<span class="xml&#45;tag">&#60;/context&#45;param&#62;</span></pre></div><p class="paragraph"/>Then create a <code>/WEB-INF/applicationContext.groovy</code> file that does the rest:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.commons.dbcp.BasicDataSource<p class="paragraph"/>beans &#123;
    dataSource(BasicDataSource) &#123;
        driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
        url = <span class="java&#45;quote">"jdbc:h2:mem:grailsDB"</span>
        username = <span class="java&#45;quote">"sa"</span>
        password = <span class="java&#45;quote">""</span>
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Loading Bean Definitions from the File System</h4><p class="paragraph"/>You can use the <code>BeanBuilder</code> class to load external Groovy scripts that define beans using the same path matching syntax defined here. For example:<p class="paragraph"/><div class="code"><pre>def bb = <span class="java&#45;keyword">new</span> BeanBuilder()
bb.loadBeans(<span class="java&#45;quote">"classpath:&#42;SpringBeans.groovy"</span>)<p class="paragraph"/>def applicationContext = bb.createApplicationContext()</pre></div><p class="paragraph"/>Here the <code>BeanBuilder</code> loads all Groovy files on the classpath ending with <code>SpringBeans.groovy</code> and parses them into bean definitions. An example script can be seen below:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.commons.dbcp.BasicDataSource
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.orm.hibernate.ConfigurableLocalSessionFactoryBean<p class="paragraph"/>beans &#123;<p class="paragraph"/>    dataSource(BasicDataSource) &#123;
        driverClassName = <span class="java&#45;quote">"org.h2.Driver"</span>
        url = <span class="java&#45;quote">"jdbc:h2:mem:grailsDB"</span>
        username = <span class="java&#45;quote">"sa"</span>
        password = <span class="java&#45;quote">""</span>
    &#125;<p class="paragraph"/>    sessionFactory(ConfigurableLocalSessionFactoryBean) &#123;
        dataSource = dataSource
        hibernateProperties = &#91;<span class="java&#45;quote">"hibernate.hbm2ddl.auto"</span>: <span class="java&#45;quote">"create&#45;drop"</span>,
                               <span class="java&#45;quote">"hibernate.show_sql"</span>:     <span class="java&#45;quote">"<span class="java&#45;keyword">true</span>"</span>&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Adding Variables to the Binding (Context)</h4><p class="paragraph"/>If you're loading beans from a script you can set the binding to use by creating a Groovy <code>Binding</code>:<p class="paragraph"/><div class="code"><pre>def binding = <span class="java&#45;keyword">new</span> Binding()
binding.maxSize = 10000
binding.productGroup = 'finance'<p class="paragraph"/>def bb = <span class="java&#45;keyword">new</span> BeanBuilder()
bb.binding = binding
bb.loadBeans(<span class="java&#45;quote">"classpath:&#42;SpringBeans.groovy"</span>)<p class="paragraph"/>def ctx = bb.createApplicationContext()</pre></div><p class="paragraph"/>Then you can access the <code>maxSize</code> and <code>productGroup</code> properties in your DSL files.


<a name="14.4 The BeanBuilder DSL Explained"><!-- Legacy link --></a>
<h2 id="theBeanBuilderDSLExplained">14.4 The BeanBuilder DSL Explained</h2>
<h4>Using Constructor Arguments</h4><p class="paragraph"/>Constructor arguments can be defined using parameters to each bean-defining method. Put them after the first argument (the Class):
<div class="code"><pre>bb.beans &#123;
    exampleBean(MyExampleBean, <span class="java&#45;quote">"firstArgument"</span>, 2) &#123;
        someProperty = &#91;1, 2, 3&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>This configuration corresponds to a <code>MyExampleBean</code> with a constructor that looks like this:<p class="paragraph"/><div class="code"><pre>MyExampleBean(<span class="java&#45;object">String</span> foo, <span class="java&#45;object">int</span> bar) &#123;
   &#8230;
&#125;</pre></div><p class="paragraph"/><h4>Configuring the BeanDefinition (Using factory methods)</h4><p class="paragraph"/>The first argument to the closure is a reference to the bean configuration instance, which you can use to configure factory methods and invoke any method on the <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/beans/factory/support/AbstractBeanDefinition.html" class="api">AbstractBeanDefinition</a> class:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
    exampleBean(MyExampleBean) &#123; bean &#45;&#62;
        bean.factoryMethod = <span class="java&#45;quote">"getInstance"</span>
        bean.singleton = <span class="java&#45;keyword">false</span>
        someProperty = &#91;1, 2, 3&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>As an alternative you can also use the return value of the bean defining method to configure the bean:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
    def example = exampleBean(MyExampleBean) &#123;
        someProperty = &#91;1, 2, 3&#93;
    &#125;
    example.factoryMethod = <span class="java&#45;quote">"getInstance"</span>
&#125;</pre></div><p class="paragraph"/><h4>Using Factory beans</h4><p class="paragraph"/>Spring defines the concept of factory beans and often a bean is created not directly from a new instance of a Class, but from one of these factories. In this case the bean has no Class argument and instead you must pass the name of the factory bean to the bean defining method:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;<p class="paragraph"/>    myFactory(ExampleFactoryBean) &#123;
        someProperty = &#91;1, 2, 3&#93;
    &#125;<p class="paragraph"/>    myBean(myFactory) &#123;
        name = <span class="java&#45;quote">"blah"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Another common approach is provide the name of the factory method to call on the factory bean. This can be done using Groovy's named parameter syntax:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;<p class="paragraph"/>    myFactory(ExampleFactoryBean) &#123;
        someProperty = &#91;1, 2, 3&#93;
    &#125;<p class="paragraph"/>    myBean(myFactory: <span class="java&#45;quote">"getInstance"</span>) &#123;
        name = <span class="java&#45;quote">"blah"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Here the <code>getInstance</code> method on the <code>ExampleFactoryBean</code> bean will be called to create the <code>myBean</code> bean.<p class="paragraph"/><h4>Creating Bean References at Runtime</h4><p class="paragraph"/>Sometimes you don't know the name of the bean to be created until runtime. In this case you can use a string interpolation to invoke a bean defining method dynamically:<p class="paragraph"/><div class="code"><pre>def beanName = <span class="java&#45;quote">"example"</span>
bb.beans &#123;
    <span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>(MyExampleBean) &#123;
        someProperty = &#91;1, 2, 3&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>In this case the <code>beanName</code> variable defined earlier is used when invoking a bean defining method. The example has a hard-coded value but would work just as well with a name that is generated programmatically based on configuration, system properties, etc.<p class="paragraph"/>Furthermore, because sometimes bean names are not known until runtime you may need to reference them by name when wiring together other beans, in this case using the <code>ref</code> method:<p class="paragraph"/><div class="code"><pre>def beanName = <span class="java&#45;quote">"example"</span>
bb.beans &#123;<p class="paragraph"/>    <span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>(MyExampleBean) &#123;
        someProperty = &#91;1, 2, 3&#93;
    &#125;<p class="paragraph"/>    anotherBean(AnotherBean) &#123;
        example = ref(<span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>Here the example property of <code>AnotherBean</code> is set using a runtime reference to the <code>exampleBean</code>. The <code>ref</code> method can also be used to refer to beans from a parent <code>ApplicationContext</code> that is provided in the constructor of the <code>BeanBuilder</code>:<p class="paragraph"/><div class="code"><pre>ApplicationContext parent = ...//
der bb = <span class="java&#45;keyword">new</span> BeanBuilder(parent)
bb.beans &#123;
    anotherBean(AnotherBean) &#123;
        example = ref(<span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>, <span class="java&#45;keyword">true</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>Here the second parameter <code>true</code> specifies that the reference will look for the bean in the parent context.<p class="paragraph"/><h4>Using Anonymous (Inner) Beans</h4><p class="paragraph"/>You can use anonymous inner beans by setting a property of the bean to a block that takes an argument that is the bean type:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;<p class="paragraph"/>    marge(Person) &#123;
        name = <span class="java&#45;quote">"Marge"</span>
        husband = &#123; Person p &#45;&#62;
            name = <span class="java&#45;quote">"Homer"</span>
            age = 45
            props = &#91;overweight: <span class="java&#45;keyword">true</span>, height: <span class="java&#45;quote">"1.8m"</span>&#93;
        &#125;
        children = &#91;bart, lisa&#93;
    &#125;<p class="paragraph"/>    bart(Person) &#123;
        name = <span class="java&#45;quote">"Bart"</span>
        age = 11
    &#125;<p class="paragraph"/>    lisa(Person) &#123;
        name = <span class="java&#45;quote">"Lisa"</span>
        age = 9
    &#125;
&#125;</pre></div><p class="paragraph"/>In the above example we set the <code>marge</code> bean's husband property to a block that creates an inner bean reference. Alternatively if you have a factory bean you can omit the type and just use the specified bean definition instead to setup the factory:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;<p class="paragraph"/>    personFactory(PersonFactory)<p class="paragraph"/>    marge(Person) &#123;
        name = <span class="java&#45;quote">"Marge"</span>
        husband = &#123; bean &#45;&#62;
            bean.factoryBean = <span class="java&#45;quote">"personFactory"</span>
            bean.factoryMethod = <span class="java&#45;quote">"newInstance"</span>
            name = <span class="java&#45;quote">"Homer"</span>
            age = 45
            props = &#91;overweight: <span class="java&#45;keyword">true</span>, height: <span class="java&#45;quote">"1.8m"</span>&#93;
        &#125;
        children = &#91;bart, lisa&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/><h4>Abstract Beans and Parent Bean Definitions</h4><p class="paragraph"/>To create an abstract bean definition define a bean without a <code>Class</code> parameter:<p class="paragraph"/><div class="code"><pre>class HolyGrailQuest &#123;
    def start() &#123; println <span class="java&#45;quote">"lets begin"</span> &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class KnightOfTheRoundTable &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">String</span> leader
    HolyGrailQuest quest<p class="paragraph"/>    KnightOfTheRoundTable(<span class="java&#45;object">String</span> name) &#123;
        <span class="java&#45;keyword">this</span>.name = name
    &#125;<p class="paragraph"/>    def embarkOnQuest() &#123;
        quest.start()
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.spring.BeanBuilder<p class="paragraph"/>def bb = <span class="java&#45;keyword">new</span> BeanBuilder()
bb.beans &#123;
    abstractBean &#123;
        leader = <span class="java&#45;quote">"Lancelot"</span>
    &#125;
    &#8230;
&#125;</pre></div><p class="paragraph"/>Here we define an abstract bean that has a <code>leader</code> property with the value of <code>"Lancelot"</code>. To use the abstract bean set it as the parent of the child bean:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
    &#8230;
    quest(HolyGrailQuest)<p class="paragraph"/>    knights(KnightOfTheRoundTable, <span class="java&#45;quote">"Camelot"</span>) &#123; bean &#45;&#62;
        bean.parent = abstractBean
        quest = ref('quest')
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
When using a parent bean you must set the parent property of the bean before setting any other properties on the bean!
</blockquote><p class="paragraph"/>If you want an abstract bean that has a <code>Class</code> specified you can do it this way:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.spring.BeanBuilder<p class="paragraph"/>def bb = <span class="java&#45;keyword">new</span> BeanBuilder()
bb.beans &#123;<p class="paragraph"/>    abstractBean(KnightOfTheRoundTable) &#123; bean &#45;&#62;
        bean.'<span class="java&#45;keyword">abstract</span>' = <span class="java&#45;keyword">true</span>
        leader = <span class="java&#45;quote">"Lancelot"</span>
    &#125;<p class="paragraph"/>    quest(HolyGrailQuest)<p class="paragraph"/>    knights(<span class="java&#45;quote">"Camelot"</span>) &#123; bean &#45;&#62;
        bean.parent = abstractBean
        quest = quest
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example we create an abstract bean of type <code>KnightOfTheRoundTable</code> and use the bean argument to set it to abstract. Later we define a knights bean that has no <code>Class</code> defined, but inherits the <code>Class</code> from the parent bean.<p class="paragraph"/><h4>Using Spring Namespaces</h4><p class="paragraph"/>Since Spring 2.0, users of Spring have had easier access to key features via XML namespaces. You can use a Spring namespace in BeanBuilder by declaring it with this syntax:<p class="paragraph"/><div class="code"><pre>xmlns context:<span class="java&#45;quote">"http://www.springframework.org/schema/context"</span></pre></div><p class="paragraph"/>and then invoking a method that matches the names of the Spring namespace tag and its associated attributes:<p class="paragraph"/><div class="code"><pre>context.'component&#45;scan'('base&#45;<span class="java&#45;keyword">package</span>': <span class="java&#45;quote">"my.company.domain"</span>)</pre></div><p class="paragraph"/>You can do some useful things with Spring namespaces, such as looking up a JNDI resource:<p class="paragraph"/><div class="code"><pre>xmlns jee:<span class="java&#45;quote">"http://www.springframework.org/schema/jee"</span><p class="paragraph"/>jee.'jndi&#45;lookup'(id: <span class="java&#45;quote">"dataSource"</span>, 'jndi&#45;name': <span class="java&#45;quote">"java:comp/env/myDataSource"</span>)</pre></div><p class="paragraph"/>This example will create a Spring bean with the identifier <code>dataSource</code> by performing a JNDI lookup on the given JNDI name. With Spring namespaces you also get full access to all of the powerful AOP support in Spring from BeanBuilder. For example given these two classes:<p class="paragraph"/><div class="code"><pre>class Person &#123;<p class="paragraph"/>    <span class="java&#45;object">int</span> age
    <span class="java&#45;object">String</span> name<p class="paragraph"/>    void birthday() &#123;
        ++age;
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class BirthdayCardSender &#123;<p class="paragraph"/>    List peopleSentCards = &#91;&#93;<p class="paragraph"/>    void onBirthday(Person person) &#123;
        peopleSentCards &#60;&#60; person
    &#125;
&#125;</pre></div><p class="paragraph"/>You can define an aspect that uses a pointcut to detect whenever the <code>birthday()</code> method is called:<p class="paragraph"/><div class="code"><pre>xmlns aop:<span class="java&#45;quote">"http://www.springframework.org/schema/aop"</span><p class="paragraph"/>fred(Person) &#123;
    name = <span class="java&#45;quote">"Fred"</span>
    age = 45
&#125;<p class="paragraph"/>birthdayCardSenderAspect(BirthdayCardSender)<p class="paragraph"/>aop &#123;
    config(<span class="java&#45;quote">"proxy&#45;target&#45;class"</span>: <span class="java&#45;keyword">true</span>) &#123;
        aspect(id: <span class="java&#45;quote">"sendBirthdayCard"</span>, ref: <span class="java&#45;quote">"birthdayCardSenderAspect"</span>) &#123;
            after method: <span class="java&#45;quote">"onBirthday"</span>,
            pointcut: <span class="java&#45;quote">"execution(void ..Person.birthday()) and <span class="java&#45;keyword">this</span>(person)"</span>
        &#125;
    &#125;
&#125;</pre></div>


<a name="14.5 Property Placeholder Configuration"><!-- Legacy link --></a>
<h2 id="propertyPlaceholderConfiguration">14.5 Property Placeholder Configuration</h2>
Grails supports the notion of property placeholder configuration through an extended version of Spring's <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/beans/factory/config/PropertyPlaceholderConfigurer.html" class="api">PropertyPlaceholderConfigurer</a>, which is typically useful in combination with <a href="../guide/single.html#configExternalized" class="guide">externalized configuration</a>.<p class="paragraph"/>Settings defined in either <a href="http://groovy.codehaus.org/ConfigSlurper" target="blank">ConfigSlurper</a> scripts or Java properties files can be used as placeholder values for Spring configuration in <code>grails-app/conf/spring/resources.xml</code>. For example given the following entries in <code>grails-app/conf/Config.groovy</code> (or an externalized config):<p class="paragraph"/><div class="code"><pre>database.driver=<span class="java&#45;quote">"com.mysql.jdbc.Driver"</span>
database.dbname=<span class="java&#45;quote">"mysql:mydb"</span></pre></div><p class="paragraph"/>You can then specify placeholders in <code>resources.xml</code> as follows using the familiar ${..} syntax:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;bean id=<span class="xml&#45;quote">"dataSource"</span>
      class=<span class="xml&#45;quote">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"driverClassName"</span>&#62;</span>
        <span class="xml&#45;tag">&#60;value&#62;</span>$&#123;database.driver&#125;<span class="xml&#45;tag">&#60;/value&#62;</span>
    <span class="xml&#45;tag">&#60;/property&#62;</span>
    <span class="xml&#45;tag">&#60;property name=<span class="xml&#45;quote">"url"</span>&#62;</span>
        <span class="xml&#45;tag">&#60;value&#62;</span>jdbc:$&#123;database.dbname&#125;<span class="xml&#45;tag">&#60;/value&#62;</span>
    <span class="xml&#45;tag">&#60;/property&#62;</span>
 <span class="xml&#45;tag">&#60;/bean&#62;</span></pre></div>


<a name="14.6 Property Override Configuration"><!-- Legacy link --></a>
<h2 id="propertyOverrideConfiguration">14.6 Property Override Configuration</h2>
Grails supports setting of bean properties via <a href="../guide/single.html#conf" class="guide">configuration</a>. This is often useful when used in combination with <a href="../guide/single.html#configExternalized" class="guide">externalized configuration</a>.<p class="paragraph"/>You define a <code>beans</code> block with the names of beans and their values:<p class="paragraph"/><div class="code"><pre>beans &#123;
    bookService &#123;
        webServiceURL = <span class="java&#45;quote">"http://www.amazon.com"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The general format is:<p class="paragraph"/><div class="code"><pre>&#91;bean name&#93;.&#91;property name&#93; = &#91;value&#93;</pre></div><p class="paragraph"/>The same configuration in a Java properties file would be:<p class="paragraph"/><div class="code"><pre>beans.bookService.webServiceURL=http://www.amazon.com</pre></div>

<a name="15. Grails and Hibernate"><!-- Legacy link --></a>
<h1 id="hibernate">15 Grails and Hibernate</h1>
If <a href="../guide/single.html#GORM" class="guide">GORM</a> (Grails Object Relational Mapping) is not flexible enough for your liking you can alternatively map your domain classes using Hibernate, either with XML mapping files or JPA annotations. You will be able to map Grails domain classes onto a wider range of legacy systems and have more flexibility in the creation of your database schema. Best of all, you will still be able to call all of the dynamic persistent and query methods provided by GORM!


<a name="15.1 Using Hibernate XML Mapping Files"><!-- Legacy link --></a>
<h2 id="usingHibernateXMLMappingFiles">15.1 Using Hibernate XML Mapping Files</h2>
Mapping your domain classes with XML is pretty straightforward. Simply create a <code>hibernate.cfg.xml</code> file in your project's <code>grails-app/conf/hibernate</code> directory, either manually or with the <a href="../ref/Command Line/create-hibernate-cfg-xml.html" class="commandLine">create-hibernate-cfg-xml</a> command, that contains the following:<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;?xml version='1.0' encoding='UTF&#45;8'?&#62;</span>
&#60;!DOCTYPE hibernate&#45;configuration PUBLIC
        <span class="xml&#45;quote">"&#45;//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="xml&#45;quote">"http://hibernate.sourceforge.net/hibernate&#45;configuration&#45;3.0.dtd"</span>&#62;
<span class="xml&#45;tag">&#60;hibernate&#45;configuration&#62;</span>
    <span class="xml&#45;tag">&#60;session&#45;factory&#62;</span>
        <span class="xml&#45;comment">&#60;!&#45;&#45; Example mapping file inclusion &#45;&#45;&#62;</span>
        <span class="xml&#45;tag">&#60;mapping resource=<span class="xml&#45;quote">"org.example.Book.hbm.xml"</span>/&#62;</span>
        &#8230;
    <span class="xml&#45;tag">&#60;/session&#45;factory&#62;</span>
<span class="xml&#45;tag">&#60;/hibernate&#45;configuration&#62;</span></pre></div><p class="paragraph"/>The individual mapping files, like 'org.example.Book.hbm.xml' in the above example, also go into the <code>grails-app/conf/hibernate</code> directory. To find out how to map domain classes with XML, check out the <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/mapping.html" target="blank">Hibernate manual</a>.<p class="paragraph"/>If the default location of the <code>hibernate.cfg.xml</code> file doesn't suit you, you can change it by specifying an alternative location in <code>grails-app/conf/DataSource.groovy</code>:<p class="paragraph"/><div class="code"><pre>hibernate &#123;
    config.location = <span class="java&#45;quote">"file:/path/to/my/hibernate.cfg.xml"</span>
&#125;</pre></div><p class="paragraph"/>or even a list of locations:<p class="paragraph"/><div class="code"><pre>hibernate &#123;
    config.location = &#91;<span class="java&#45;quote">"file:/path/to/one/hibernate.cfg.xml"</span>,
                       <span class="java&#45;quote">"file:/path/to/two/hibernate.cfg.xml"</span>&#93;
&#125;</pre></div><p class="paragraph"/>Grails also lets you write your domain model in Java or reuse an existing one that already has Hibernate mapping files. Simply place the mapping files into <code>grails-app/conf/hibernate</code> and either put the Java files in <code>src/java</code> or the classes in the project's <code>lib</code> directory if the domain model is packaged as a JAR. You still need the <code>hibernate.cfg.xml</code> though!


<a name="15.2 Mapping with Hibernate Annotations"><!-- Legacy link --></a>
<h2 id="mappingWithHibernateAnnotations">15.2 Mapping with Hibernate Annotations</h2>
To map a domain class with annotations, create a new class in <code>src/java</code> and use the annotations defined as part of the EJB 3.0 spec (for more info on this see the <a href="http://annotations.hibernate.org/" target="blank">Hibernate Annotations Docs</a>):<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.books;<p class="paragraph"/><span class="java&#45;keyword">import</span> javax.persistence.Entity;
<span class="java&#45;keyword">import</span> javax.persistence.GeneratedValue;
<span class="java&#45;keyword">import</span> javax.persistence.Id;<p class="paragraph"/>@Entity
<span class="java&#45;keyword">public</span> class Book &#123;
    <span class="java&#45;keyword">private</span> <span class="java&#45;object">Long</span> id;
    <span class="java&#45;keyword">private</span> <span class="java&#45;object">String</span> title;
    <span class="java&#45;keyword">private</span> <span class="java&#45;object">String</span> description;
    <span class="java&#45;keyword">private</span> Date date;<p class="paragraph"/>    @Id
    @GeneratedValue
    <span class="java&#45;keyword">public</span> <span class="java&#45;object">Long</span> getId() &#123;
        <span class="java&#45;keyword">return</span> id;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> void setId(<span class="java&#45;object">Long</span> id) &#123;
        <span class="java&#45;keyword">this</span>.id = id;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> <span class="java&#45;object">String</span> getTitle() &#123;
        <span class="java&#45;keyword">return</span> title;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> void setTitle(<span class="java&#45;object">String</span> title) &#123;
        <span class="java&#45;keyword">this</span>.title = title;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> <span class="java&#45;object">String</span> getDescription() &#123;
        <span class="java&#45;keyword">return</span> description;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">public</span> void setDescription(<span class="java&#45;object">String</span> description) &#123;
        <span class="java&#45;keyword">this</span>.description = description;
    &#125;
&#125;</pre></div><p class="paragraph"/>Then register the class with the Hibernate <code>sessionFactory</code> by adding relevant entries to the <code>grails-app/conf/hibernate/hibernate.cfg.xml</code> file as follows:<p class="paragraph"/><div class="code"><pre>&#60;!DOCTYPE hibernate&#45;configuration SYSTEM
  <span class="xml&#45;quote">"http://hibernate.sourceforge.net/hibernate&#45;configuration&#45;3.0.dtd"</span>&#62;
<span class="xml&#45;tag">&#60;hibernate&#45;configuration&#62;</span>
    <span class="xml&#45;tag">&#60;session&#45;factory&#62;</span>
        <span class="xml&#45;tag">&#60;mapping package=<span class="xml&#45;quote">"com.books"</span> /&#62;</span>
        <span class="xml&#45;tag">&#60;mapping class=<span class="xml&#45;quote">"com.books.Book"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;/session&#45;factory&#62;</span>
<span class="xml&#45;tag">&#60;/hibernate&#45;configuration&#62;</span></pre></div>
See the previous section for more information on the <code>hibernate.cfg.xml</code> file.<p class="paragraph"/>When Grails loads it will register the necessary dynamic methods with the class. To see what else you can do with a Hibernate domain class see the section on <a href="../guide/single.html#scaffolding" class="guide">Scaffolding</a>.


<a name="15.3 Adding Constraints"><!-- Legacy link --></a>
<h2 id="addingConstraints">15.3 Adding Constraints</h2>
You can still use GORM validation even if you use a Java domain model. Grails lets you define constraints through separate scripts in the <code>src/java</code> directory. The script must be in a directory that matches the package of the corresponding domain class and its name must have a  <em class="italic">Constraints</em>  suffix. For example, if you had a domain class <code>org.example.Book</code>, then you would create the script <code>src/java/org/example/BookConstraints.groovy</code>&#46;<p class="paragraph"/>Add a standard GORM <code>constraints</code> block to the script:
<div class="code"><pre>constraints = &#123;
    title blank: <span class="java&#45;keyword">false</span>
    author blank: <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>Once this is in place you can validate instances of your domain class!


<a name="16. Scaffolding"><!-- Legacy link --></a>
<h1 id="scaffolding">16 Scaffolding</h1>
Scaffolding lets you auto-generate a whole application for a given domain class including:
<ul class="star">
<li>The necessary <a href="../guide/single.html#gsp" class="guide">views</a></li>
<li>Controller actions for create/read/update/delete (CRUD) operations</li>
</ul><p class="paragraph"/><h4>Dynamic Scaffolding</h4><p class="paragraph"/>The simplest way to get started with scaffolding is to enable it with the <code>scaffold</code> property. Set the <code>scaffold</code> property in the controller to <code>true</code> for the <code>Book</code> domain class:<p class="paragraph"/><div class="code"><pre>class BookController &#123;
    <span class="java&#45;keyword">static</span> scaffold = <span class="java&#45;keyword">true</span>
&#125;</pre></div><p class="paragraph"/>This works because the <code>BookController</code> follows the same naming convention as the <code>Book</code> domain class. To scaffold a specific domain class we could reference the class directly in the scaffold property:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;
    <span class="java&#45;keyword">static</span> scaffold = Author
&#125;</pre></div><p class="paragraph"/>With this configured, when you start your application the actions and views will be auto-generated at runtime. The following actions are dynamically implemented by default by the runtime scaffolding mechanism:
<ul class="star">
<li>list</li>
<li>show</li>
<li>edit</li>
<li>delete</li>
<li>create</li>
<li>save</li>
<li>update</li>
</ul><p class="paragraph"/>A CRUD interface will also be generated. To access this open <code>http://localhost:8080/app/book</code> in a browser.<p class="paragraph"/>If you prefer to keep your domain model in Java and <a href="../guide/single.html#hibernate" class="guide">mapped with Hibernate</a> you can still use scaffolding, simply import the domain class and set its name as the <code>scaffold</code> argument.<p class="paragraph"/>You can add new actions to a scaffolded controller, for example:<p class="paragraph"/><div class="code"><pre>class BookController &#123;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> scaffold = Book<p class="paragraph"/>    def changeAuthor() &#123;
        def b = Book.get(params.id)
        b.author = Author.get(params&#91;<span class="java&#45;quote">"author.id"</span>&#93;)
        b.save()<p class="paragraph"/>        // redirect to a scaffolded action
        redirect(action:show)
    &#125;
&#125;</pre></div><p class="paragraph"/>You can also override the scaffolded actions:<p class="paragraph"/><div class="code"><pre>class BookController &#123;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> scaffold = Book<p class="paragraph"/>    // overrides scaffolded action to <span class="java&#45;keyword">return</span> both authors and books
    def list() &#123;
        &#91;bookInstanceList: Book.list(),
         bookInstanceTotal: Book.count(),
         authorInstanceList: Author.list()&#93;
    &#125;<p class="paragraph"/>    def show() &#123;
        def book = Book.get(params.id)
        log.error(book)
        &#91;bookInstance : book&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>All of this is what is known as "dynamic scaffolding" where the CRUD interface is generated dynamically at runtime.<p class="paragraph"/><blockquote class="note">
By default, the size of text areas in scaffolded views is defined in the CSS, so adding 'rows' and 'cols' attributes will have no effect.<p class="paragraph"/>Also, the standard scaffold views expect model variables of the form <code>&#60;propertyName&#62;InstanceList</code> for collections and <code>&#60;propertyName&#62;Instance</code> for single instances. It's tempting to use properties like 'books' and 'book', but those won't work.
</blockquote><p class="paragraph"/><h4>Customizing the Generated Views</h4><p class="paragraph"/>The views adapt to <a href="../guide/single.html#constraints" class="guide">Validation constraints</a>. For example you can change the order that fields appear in the views simply by re-ordering the constraints in the builder:<p class="paragraph"/><div class="code"><pre>def constraints = &#123;
    title()
    releaseDate()
&#125;</pre></div><p class="paragraph"/>You can also get the generator to generate lists instead of text inputs if you use the <code>inList</code> constraint:<p class="paragraph"/><div class="code"><pre>def constraints = &#123;
    title()
    category(inList: &#91;<span class="java&#45;quote">"Fiction"</span>, <span class="java&#45;quote">"Non&#45;fiction"</span>, <span class="java&#45;quote">"Biography"</span>&#93;)
    releaseDate()
&#125;</pre></div><p class="paragraph"/>Or if you use the <code>range</code> constraint on a number:<p class="paragraph"/><div class="code"><pre>def constraints = &#123;
    age(range:18..65)
&#125;</pre></div><p class="paragraph"/>Restricting the size with a constraint also effects how many characters can be entered in the generated view:<p class="paragraph"/><div class="code"><pre>def constraints = &#123;
    name(size:0..30)
&#125;</pre></div><p class="paragraph"/><h4>Static Scaffolding</h4><p class="paragraph"/>Grails also supports "static" scaffolding.<p class="paragraph"/>The above scaffolding features are useful but in real world situations it's likely that you will want to customize the logic and views. Grails lets you generate a controller and the views used to create the above interface from the command line. To generate a controller type:<p class="paragraph"/><div class="code"><pre>grails generate&#45;controller Book</pre></div><p class="paragraph"/>or to generate the views:<p class="paragraph"/><div class="code"><pre>grails generate&#45;views Book</pre></div><p class="paragraph"/>or to generate everything:<p class="paragraph"/><div class="code"><pre>grails generate&#45;all Book</pre></div><p class="paragraph"/>If you have a domain class in a package or are generating from a <a href="../guide/single.html#hibernate" class="guide">Hibernate mapped class</a> remember to include the fully qualified package name:<p class="paragraph"/><div class="code"><pre>grails generate&#45;all com.bookstore.Book</pre></div><p class="paragraph"/><h4>Customizing the Scaffolding templates</h4><p class="paragraph"/>The templates used by Grails to generate the controller and views can be customized by installing the templates with the <a href="../ref/Command Line/install-templates.html" class="commandLine">install-templates</a> command.


<a name="17. Deployment"><!-- Legacy link --></a>
<h1 id="deployment">17 Deployment</h1>
Grails applications can be deployed in a number of ways, each of which has its pros and cons.<p class="paragraph"/><h3>"grails run-app"</h3><p class="paragraph"/>You should be very familiar with this approach by now, since it is the most common method of running an application during the development phase. An embedded Tomcat server is launched that loads the web application from the development sources, thus allowing it to pick up an changes to application files.<p class="paragraph"/>This approach is not recommended at all for production deployment because the performance is poor. Checking for and loading changes places a sizable overhead on the server. Having said that, <code>grails prod run-app</code> removes the per-request overhead and lets you fine tune how frequently the regular check takes place.<p class="paragraph"/>Setting the system property "disable.auto.recompile" to <code>true</code> disables this regular check completely, while the property "recompile.frequency" controls the frequency. This latter property should be set to the number of seconds you want between each check. The default is currently 3.<p class="paragraph"/><h3>"grails run-war"</h3><p class="paragraph"/>This is very similar to the previous option, but Tomcat runs against the packaged WAR file rather than the development sources. Hot-reloading is disabled, so you get good performance without the hassle of having to deploy the WAR file elsewhere.<p class="paragraph"/><h3>WAR file</h3><p class="paragraph"/>When it comes down to it, current java infrastructures almost mandate that web applications are deployed as WAR files, so this is by far the most common approach to Grails application deployment in production. Creating a WAR file is as simple as executing the <a href="../ref/Command Line/war.html" class="commandLine">war</a> command:<p class="paragraph"/><div class="code"><pre>grails war</pre></div><p class="paragraph"/>There are also many ways in which you can customise the WAR file that is created. For example, you can specify a path (either absolute or relative) to the command that instructs it where to place the file and what name to give it:<p class="paragraph"/><div class="code"><pre>grails war /opt/java/tomcat&#45;5.5.24/foobar.war</pre></div><p class="paragraph"/>Alternatively, you can add a line to <code>grails-app/conf/BuildConfig.groovy</code> that changes the default location and filename:<p class="paragraph"/><div class="code"><pre>grails.project.war.file = <span class="java&#45;quote">"foobar&#45;prod.war"</span></pre></div><p class="paragraph"/>Any command line argument that you provide overrides this setting.<p class="paragraph"/>It is also possible to control what libraries are included in the WAR file, for example to avoid conflicts with libraries in a shared directory. The default behavior is to include in the WAR file all libraries required by Grails, plus any libraries contained in plugin "lib" directories, plus any libraries contained in the application's "lib" directory. As an alternative to the default behavior you can explicitly specify the complete list of libraries to include in the WAR file by setting the property <code>grails.war.dependencies</code> in BuildConfig.groovy to either lists of Ant include patterns or closures containing AntBuilder syntax. Closures are invoked from within an Ant "copy" step, so only elements like "fileset" can be included, whereas each item in a pattern list is included. Any closure or pattern assigned to the latter property will be included in addition to <code>grails.war.dependencies</code>.<p class="paragraph"/>Be careful with these properties: if any of the libraries Grails depends on are missing, the application will almost certainly fail. Here is an example that includes a small subset of the standard Grails dependencies:<p class="paragraph"/><div class="code"><pre>def deps = &#91;
    <span class="java&#45;quote">"hibernate3.jar"</span>,
    <span class="java&#45;quote">"groovy&#45;all&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"standard&#45;&#36;&#123;servletVersion&#125;.jar"</span>,
    <span class="java&#45;quote">"jstl&#45;&#36;&#123;servletVersion&#125;.jar"</span>,
    <span class="java&#45;quote">"oscache&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"commons&#45;logging&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"sitemesh&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"spring&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"log4j&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"ognl&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"commons&#45;&#42;.jar"</span>,
    <span class="java&#45;quote">"xstream&#45;1.2.1.jar"</span>,
    <span class="java&#45;quote">"xpp3_min&#45;1.1.3.4.O.jar"</span> &#93;<p class="paragraph"/>grails.war.dependencies = &#123;
    fileset(dir: <span class="java&#45;quote">"libs"</span>) &#123;
        <span class="java&#45;keyword">for</span> (pattern in deps) &#123;
            include(name: pattern)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>This example only exists to demonstrate the syntax for the properties. If you attempt to use it as is in your own application, the application will probably not work. You can find a list of dependencies required by Grails in the "dependencies.txt" file in the root directory of the unpacked distribution. You can also find a list of the default dependencies included in WAR generation in the "War.groovy" script - see the <code>DEFAULT_DEPS</code> and <code>DEFAULT_J5_DEPS</code> variables.<p class="paragraph"/>The remaining two configuration options available to you are <code>grails.war.copyToWebApp</code> and <code>grails.war.resources</code>. The first of these lets you customise what files are included in the WAR file from the "web-app" directory. The second lets you do any extra processing you want before the WAR file is finally created.<p class="paragraph"/><div class="code"><pre>// This closure is passed the command line arguments used to start the
// war process.
grails.war.copyToWebApp = &#123; args &#45;&#62;
    fileset(dir:<span class="java&#45;quote">"web&#45;app"</span>) &#123;
        include(name: <span class="java&#45;quote">"js/&#42;&#42;"</span>)
        include(name: <span class="java&#45;quote">"css/&#42;&#42;"</span>)
        include(name: <span class="java&#45;quote">"WEB&#45;INF/&#42;&#42;"</span>)
    &#125;
&#125;<p class="paragraph"/>// This closure is passed the location of the staging directory that
// is zipped up to make the WAR file, and the command line arguments.
// Here we override the standard web.xml with our own.
grails.war.resources = &#123; stagingDir, args &#45;&#62;
    copy(file: <span class="java&#45;quote">"grails&#45;app/conf/custom&#45;web.xml"</span>,
         tofile: <span class="java&#45;quote">"&#36;&#123;stagingDir&#125;/WEB&#45;INF/web.xml"</span>)
&#125;</pre></div><p class="paragraph"/><h2>Application servers</h2><p class="paragraph"/>Ideally you should be able to simply drop a WAR file created by Grails into any application server and it should work straight away. However, things are rarely ever this simple. The <a href="http://grails.org/Deployment" target="blank">Grails website</a> contains an up-to-date list of application servers that Grails has been tested with, along with any additional steps required to get a Grails WAR file working.



<h1 id="contributing">18 Contributing to Grails</h1>
You can contribute to Grails in a number of different ways.



<h2 id="issues">18.1 Report Issues in JIRA</h2>
Grails uses <a href="http://jira.grails.org" target="blank">JIRA</a> to track issues. If you’ve found a bug, this is the place to start. You’ll need to create a (free) JIRA account in order to either submit an issue or comment on them.


<h2 id="build">18.2 Build From Source and Run Tests</h2>
In order to build Grails from source and run the tests, you need to first have the following pre-requisites.
<ul class="star">
<li>JDK (1.6+)</li>
<li>Git client</li>
</ul><p class="paragraph"/>Once you have all the pre-requisite packages installed, the next step is to download the Grails source code. The source code is hosted at <a href="http://github.com" target="blank">GitHub</a> in several different git repositories owned by the <a href="http://github.com/grails" target="blank">&#34;grails&#34; GitHub user</a>.<p class="paragraph"/>To download the source using git, use the "git clone" command followed by the public URL of the repository you want to clone (download). For example, to clone the "grails-core" repository, run the following:
<div class="code"><pre>git clone http://github.com/grails/grails&#45;core.git</pre></div><p class="paragraph"/>The above will create a "grails-core" directory in your current working directory populated with the project source and the git repository.<p class="paragraph"/><h3>Create the required jars</h3>
<div class="code"><pre>./gradlew libs</pre></div><p class="paragraph"/>This will create everything you need to run Grails. This target also skips running the extensive collection of Grails test classes (Grails' 1000+ tests can bring a single core processor to a grinding halt for some time).<p class="paragraph"/>Once the jars have been built, simply set GRAILS_HOME to the checkout directory and add the "bin" directory to your path.<p class="paragraph"/><h3>Run the test suite</h3><p class="paragraph"/>All you have to do to run the full suite of tests is:
<div class="code"><pre>./gradlew test</pre></div><p class="paragraph"/>These will take a while (15-30 mins), so consider running individual tests using the command line. For example, to run the tests in src/test/org/codehaus/groovy/grails/orm/hibernate/MappingDslTests.groovy, run the following command:
<div class="code"><pre>./gradlew &#45;Dtest.single=MappingDslTest grails&#45;test&#45;suite&#45;persistence:test</pre></div><p class="paragraph"/>You need to give it the specific test suite that the test exists in, just using the "test" target won't work.<p class="paragraph"/><h3>Developing in IntelliJ IDEA</h3><p class="paragraph"/>You need to run the following gradle task:
<div class="code"><pre>./gradlew idea</pre></div><p class="paragraph"/>Then open the project file which is generated in IDEA. Simple!<p class="paragraph"/><h3>Developing in STS / Eclipse</h3><p class="paragraph"/>You need to run the following gradle task:
<div class="code"><pre>./gradlew cleanEclipse eclipse</pre></div><p class="paragraph"/>Before importing projects to STS do the following action:
<ul class="star">
<li>Edit grails-scripts/.classpath and remove the line "&#60;classpathentry kind="src" path="../scripts"/&#62;".</li>
</ul><p class="paragraph"/>Use "Import-&#62;General-&#62;Existing Projects into Workspace" to import all projects to STS. There will be a few build errors. To fix them do the following actions:
<ul class="star">
<li>Add "~/.gradle/cache/com.springsource.springloaded/springloaded-core/jars/springloaded-core-XXXX.jar" to grails-core's classpath.</li>
<li>Remove "src/test/groovy" from grails-plugin-testing's source path GRECLIPSE-1067</li>
<li>Add "~/.gradle/cache/javax.servlet.jsp/jsp-api/jars/jsp-api-2.1.jar" to the classpath of grails-web</li>
<li>Fix the source path of grails-scripts. Add linked source folder linking to "../scripts". If you get build errors in grails-scripts, do "../gradlew cleanEclipse eclipse" in that directory and edit the .classpath file again (remove the line "&#60;classpathentry kind="src" path="../scripts"/&#62;"). Remove possible empty "scripts" directory under grails-scripts if you are not able to add the linked folder.</li>
<li>Do a clean build for the whole workspace.</li>
<li>To use Eclipse GIT scm team provider: Select all projects (except "Servers") in the navigation and right click -&#62; Team -&#62; Share project (not "Share projects"). Choose "Git". Then check "Use or create repository in parent folder of project" and click "Finish".</li>
<li>Get the recommended code style settings from the <a href="http://grails.1312388.n4.nabble.com/Grails-development-code-style-IDE-formatting-settings-tp3854216p3854216.html" target="blank">mailing list thread</a> (final style not decided yet, currently <a href="http://grails.1312388.n4.nabble.com/attachment/3854262/0/profile.xml" target="blank">profile.xml</a>). Import the code style xml file to STS in Window-&#62;Preferences-&#62;Java-&#62;Code Style-&#62;Formatter-&#62;Import . Grails code uses spaces instead of tabs for indenting.</li>
</ul><p class="paragraph"/><h3>Debug</h3><p class="paragraph"/>To debug Grails run the Grails application using:
<div class="code"><pre>grails&#45;debug &#60;command&#62;</pre></div><p class="paragraph"/>and then connect to it remotely via the IDE. There should be an option for "remote debugging". Unless you modify the "grails-debug" script, you should connect to port 5005.<p class="paragraph"/>If you need to debug stuff that happens during application start-up, then you should modify the "grails-debug" script and change the "suspend" option from 'n' to 'y'.<p class="paragraph"/>You can read more about the JPDA Connection settings here: <a href="http://java.sun.com/j2se/1.5.0/docs/guide/jpda/conninv.html#Invocation" target="blank">http://java.sun.com/j2se/1.5.0/docs/guide/jpda/conninv.html#Invocation</a><p class="paragraph"/>It's also possible to get Eclipse to wait for incoming debugger connections and instead of using "-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005" you could use this "-Xrunjdwp:transport=dt_socket,server=n,address=8000" (which assumes the Eclipse default port for remote java applications) Inside eclipse you create a new "Remote Java Application" launch configuration and change the connection type to "Standard (Socket Listen)" and click debug. This allows you to start a debugger session in eclipse and just leave it running and you're free to debug anything without having to keep remembering to relaunch a "Socket Attach" launch configuration. You might find it handy to have 2 scripts, one called "grails-debug", and another called "grails-debug-attach"



<h2 id="patchesCore">18.3 Submit Patches to Grails Core</h2>
If you want to submit patches to the project, you simply need to fork the repository on GitHub rather than clone it directly. Then you will commit your changes to your fork and send a pull request for a core team member to review.<p class="paragraph"/><h3>Forking and Pull Requests</h3>
One of the benefits of <a href="http://github.com" target="blank">GitHub</a> is the way that you can easily contribute to a project by <a href="http://help.github.com/fork-a-repo/" target="blank">forking the repository</a> and <a href="http://help.github.com/send-pull-requests/" target="blank">sending pull requests</a> with your changes.<p class="paragraph"/>What follows are some guidelines to help ensure that your pull requests are speedily dealt with and provide the information we need. They will also make your life easier!<p class="paragraph"/><h4>Create a local branch for your changes</h4><p class="paragraph"/>Your life will be greatly simplified if you create a local branch to make your changes on. For example, as soon as you fork a repository and clone the fork locally, execute
<div class="code"><pre>git checkout &#45;b mine</pre></div><p class="paragraph"/>This will create a new local branch called "mine" based off the "master" branch. Of course, you can name the branch whatever you like - you don't have to use "mine".<p class="paragraph"/><h4>Create JIRAs for non-trivial changes</h4><p class="paragraph"/>For any non-trivial changes, raise a JIRA issue if one doesn't already exist. That helps us keep track of what changes go into each new version of Grails.<p class="paragraph"/><h4>Include JIRA issue ID in commit messages</h4><p class="paragraph"/>This may not seem particularly important, but having a JIRA issue ID in a commit message means that we can find out at a later date why a change was made. Include the ID in any and all commits that relate to that issue. If a commit isn't related to an issue, then there's no need to include an issue ID.<p class="paragraph"/><h4>Make sure your fork is up to date</h4><p class="paragraph"/>Since the core developers must merge your commits into the main repository, it makes life much easier if your fork on GitHub is up to date before you send a pull request.<p class="paragraph"/>Let's say you have the main repository set up as a remote called "upstream" and you want to submit a pull request. Also, all your changes are currently on the local "mine" branch but not on "master". The first step involves pulling any changes from the main repository that have been added since you last fetched and merged:
<div class="code"><pre>git checkout master
git pull upstream</pre></div><p class="paragraph"/>This should complete without any problems or conflicts. Next, rebase your local branch against the now up-to-date master:
<div class="code"><pre>git checkout mine
git rebase master</pre></div><p class="paragraph"/>What this does is rearrange the commits such that all of your changes come after the most recent one in master. Think adding some cards to the top of a deck rather than shuffling them into the pack.<p class="paragraph"/>You'll now be able to do a clean merge from your local branch to master:
<div class="code"><pre>git checkout master
git merge mine</pre></div><p class="paragraph"/>Finally, you must push your changes to your remote repository on GitHub, otherwise the core developers won't be able to pick them up:
<div class="code"><pre>git push</pre></div><p class="paragraph"/>You're now ready to send the pull request from the GitHub user interface.<p class="paragraph"/><h4>Say what your pull request is for</h4><p class="paragraph"/>A pull request can contain any number of commits and it may be related to any number of issues. In the pull request message, please specify the IDs of all issues that the request relates to. Also give a brief description of the work you have done, such as: "I refactored the data binder and added support for custom number editors (GRAILS-xxxx)".


<h2 id="patchesDoc">18.4 Submit Patches to Grails Documentation</h2>
Contributing to the documentation is much simpler from the core framework because there is a replica of the <a href="http://github.com/grails/grails-doc" target="blank">http://github.com/grails/grails-doc</a> project that anyone can request commit access on. So, if you want to submit patches to the documentation, you simply need to request commit access to the following repository <a href="http://github.com/pledbrook/grails-doc" target="blank">http://github.com/pledbrook/grails-doc</a> and commit your patches just as you would any other GitHub repository.<p class="paragraph"/><h3>Building the Guide</h3>
To build the documentation, simply type:
<div class="code"><pre>./gradlew docs</pre></div><p class="paragraph"/>Be warned: this command can take a while to complete and you should probably increase your Gradle memory settings by giving the <code>GRADLE_OPTS</code> environment variable a value like
<div class="code"><pre>export GRADLE_OPTS=<span class="java&#45;quote">"&#45;Xmx512m &#45;XX:MaxPermSize=384m"</span></pre></div><p class="paragraph"/>Fortunately, you can reduce the overall build time with a couple of useful options. The first allows you to specify the location of the Grails source to use:
<div class="code"><pre>./gradlew &#45;Dgrails.home=/home/user/projects/grails&#45;core docs</pre></div><p class="paragraph"/>The Grails source is required because the guide links to its API documentation and the build needs to ensure it's generated. If you don't specify a <code>grails.home</code> property, then the build will fetch the Grails source - a download of 10s of megabytes. It must then compile the Grails source which can take a while too.<p class="paragraph"/>Additionally you can create a local.properties file with this variable set:
<div class="code"><pre>grails.home=/home/user/projects/grails&#45;core</pre></div>
or
<div class="code"><pre>grails.home=../grails&#45;core</pre></div><p class="paragraph"/>The other useful option allows you to disable the generation of the API documentation, since you only need to do it once:
<div class="code"><pre>./gradlew &#45;Ddisable.groovydocs=<span class="java&#45;keyword">true</span> docs</pre></div><p class="paragraph"/>Again, this can save a significant amount of time and memory.<p class="paragraph"/>The main English user guide is generated in the <code>build/docs</code> directory, with the <code>guide</code> sub-directory containing the user guide part and the <code>ref</code> folder containing the reference material. To view the user guide, simply open <code>build/docs/index.html</code>.<p class="paragraph"/><h3>Publishing</h3>
The publishing system for the user guide is the same as <a href="http://grails.org/doc/2.0.0.M1/guide/conf.html#docengine" target="blank">the one for Grails projects</a>. You write your chapters and sections in the gdoc wiki format which is then converted to HTML for the final guide. Each chapter is a top-level gdoc file in the <code>src/&#60;lang&#62;/guide</code> directory. Sections and sub-sections then go into directories with the same name as the chapter gdoc but without the suffix.<p class="paragraph"/>The structure of the user guide is defined in the <code>src/&#60;lang&#62;/guide/toc.yml</code> file, which is a YAML file. This file also defines the (language-specific) section titles. If you add or remove a gdoc file, you must update the TOC as well!<p class="paragraph"/>The <code>src/&#60;lang&#62;/ref</code> directory contains the source for the reference sidebar. Each directory is the name of a category, which also appears in the docs. Hence the directories need different names for the different languages. Inside the directories go the gdoc files, whose names match the names of the methods, commands, properties or whatever that the files describe.<p class="paragraph"/><h3>Translations</h3>
This project can host multiple translations of the user guide, with <code>src/en</code> being the main one. To add another one, simply create a new language directory under <code>src</code> and copy into it all the files under <code>src/en</code>. The build will take care of the rest.<p class="paragraph"/>Once you have a copy of the original guide, you can use the <code>&#123;hidden&#125;</code> macro to wrap the English text that you have replaced, rather than remove it. This makes it easier to compare changes to the English guide against your translation. For example:
<div class="code"><pre>&#123;hidden&#125;
When you create a Grails application with the &#91;create&#45;app|commandLine&#93; command,
Grails doesn't automatically create an Ant <code>build.xml</code> file but you can generate
one with the &#91;integrate&#45;with|commandLine&#93; command:
&#123;hidden&#125;<p class="paragraph"/>Quando crias uma aplicação Grails com o comando &#91;create&#45;app|commandLine&#93;, Grails
não cria automaticamente um ficheiro de construção Ant <code>build.xml</code> mas podes gerar
um com o comando &#91;integrate&#45;with|commandLine&#93;:</pre></div><p class="paragraph"/>Because the English text remains in your gdoc files, <code>diff</code> will show differences on the English lines. You can then use the output of <code>diff</code> to see which bits of your translation need updating. On top of that, the <code>&#123;hidden&#125;</code> macro ensures that the text inside it is not displayed in the browser, although you can display it by adding this URL as a bookmark: <code>javascript:toggleHidden();</code> (requires you to build the user guide with Grails 2.0 M2 or later).<p class="paragraph"/>Even better, you can use the <code>left_to_do.groovy</code> script in the root of the project to see what still needs translating. You run it like so:
<div class="code"><pre>./left_to_do.groovy es</pre></div><p class="paragraph"/>This will then print out a recursive diff of the given translation against the reference English user guide. Anything in <code>&#123;hidden&#125;</code> blocks that hasn't changed since being translated will  <em class="italic">not</em>  appear in the diff output. In other words, all you will see is content that hasn't been translated yet and content that has changed since it was translated. Note that <code>&#123;code&#125;</code> blocks are ignored, so you  <em class="italic">don't</em>  need to include them inside <code>&#123;hidden&#125;</code> macros.<p class="paragraph"/>To provide translations for the headers, such as the user guide title and subtitle, just add language specific entries in the 'resources/doc.properties' file like so:
<div class="code"><pre>es.title=El Grails Framework
es.subtitle=...</pre></div><p class="paragraph"/>For each language translation, properties beginning <code>&#60;lang&#62;</code>. will override the standard ones. In the above example, the user guide title will be El Grails Framework for the Spanish translation. Also, translators can be credited by adding a '&#60;lang&#62;.translators' property:
<div class="code"><pre>fr.translators=Stéphane Maldini</pre></div><p class="paragraph"/>This should be a comma-separated list of names (or the native language equivalent) and it will be displayed as a "Translated by" header in the user guide itself.<p class="paragraph"/>You can build specific translations very easily using the <code>publishGuide_&#42;</code> and <code>publishPdf_&#42;</code> tasks. For example, to build both the French HTML and PDF user guides, simply execute
<div class="code"><pre>./gradlew publishPdf_fr</pre></div><p class="paragraph"/>Each translation is generated in its own directory, so for example the French guide will end up in <code>build/docs/fr</code>. You can then view the translated guide by opening <code>build/docs/&#60;lang&#62;/index.html</code>.<p class="paragraph"/>All translations are created as part of the <a href="http://hudson.grails.org/job/grails_docs_2.0.x/lastSuccessfulBuild/artifact/build/docs/" target="blank">Hudson CI build for the grails-doc</a> project, so you can easily see what the current state is without having to build the docs yourself.

                    </div>
                </td>
                <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Command Line</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/add-proxy.html">add-proxy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/bootstrap.html">bootstrap</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/bug-report.html">bug-report</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/clean.html">clean</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/clear-proxy.html">clear-proxy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/compile.html">compile</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/console.html">console</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-app.html">create-app</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-controller.html">create-controller</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-domain-class.html">create-domain-class</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-filters.html">create-filters</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-hibernate-cfg-xml.html">create-hibernate-cfg-xml</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-integration-test.html">create-integration-test</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-plugin.html">create-plugin</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-scaffold-controller.html">create-scaffold-controller</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-script.html">create-script</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-service.html">create-service</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-tag-lib.html">create-tag-lib</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/create-unit-test.html">create-unit-test</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/dependency-report.html">dependency-report</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/doc.html">doc</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/generate-all.html">generate-all</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/generate-controller.html">generate-controller</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/generate-views.html">generate-views</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/help.html">help</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/init.html">init</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/install-dependency.html">install-dependency</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/install-plugin.html">install-plugin</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/install-templates.html">install-templates</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/integrate-with.html">integrate-with</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/interactive.html">interactive</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/list-plugin-updates.html">list-plugin-updates</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/list-plugins.html">list-plugins</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/migrate-docs.html">migrate-docs</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/package-plugin.html">package-plugin</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/package.html">package</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/plugin-info.html">plugin-info</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/remove-proxy.html">remove-proxy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/run-app.html">run-app</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/run-script.html">run-script</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/run-war.html">run-war</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/schema-export.html">schema-export</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/set-proxy.html">set-proxy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/set-version.html">set-version</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/shell.html">shell</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/stats.html">stats</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/test-app.html">test-app</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/uninstall-plugin.html">uninstall-plugin</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/upgrade.html">upgrade</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Command%20Line/war.html">war</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Constraints</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Constraints/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Constraints/attributes.html">attributes</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/blank.html">blank</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/creditCard.html">creditCard</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/email.html">email</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/inList.html">inList</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/matches.html">matches</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/max.html">max</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/maxSize.html">maxSize</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/min.html">min</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/minSize.html">minSize</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/notEqual.html">notEqual</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/nullable.html">nullable</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/range.html">range</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/scale.html">scale</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/size.html">size</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/unique.html">unique</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/url.html">url</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/validator.html">validator</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Constraints/widget.html">widget</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Controllers</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Controllers/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Controllers/actionName.html">actionName</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/afterInterceptor.html">afterInterceptor</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/allowedMethods.html">allowedMethods</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/beforeInterceptor.html">beforeInterceptor</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/bindData.html">bindData</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/chain.html">chain</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/controllerName.html">controllerName</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/defaultAction.html">defaultAction</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/flash.html">flash</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/forward.html">forward</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/grailsApplication.html">grailsApplication</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/params.html">params</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/redirect.html">redirect</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/render.html">render</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/request.html">request</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/response.html">response</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/servletContext.html">servletContext</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/session.html">session</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/withForm.html">withForm</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Controllers/withFormat.html">withFormat</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Database Mapping</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/autoImport.html">autoImport</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/autoTimestamp.html">autoTimestamp</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/batchSize.html">batchSize</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/cache.html">cache</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/cascade.html">cascade</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/column.html">column</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/discriminator.html">discriminator</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/dynamicInsert.html">dynamicInsert</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/dynamicUpdate.html">dynamicUpdate</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/fetch.html">fetch</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/id.html">id</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/ignoreNotFound.html">ignoreNotFound</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/indexColumn.html">indexColumn</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/insertable.html">insertable</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/joinTable.html">joinTable</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/lazy.html">lazy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/order.html">order</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/sort.html">sort</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/table.html">table</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/type.html">type</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/updateable.html">updateable</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Database%20Mapping/version.html">version</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Domain Classes</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/addTo.html">addTo</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/attach.html">attach</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/belongsTo.html">belongsTo</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/clearErrors.html">clearErrors</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/constraints.html">constraints</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/count.html">count</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/countBy.html">countBy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/createCriteria.html">createCriteria</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/delete.html">delete</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/discard.html">discard</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/embedded.html">embedded</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/errors.html">errors</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/executeQuery.html">executeQuery</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/executeUpdate.html">executeUpdate</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/exists.html">exists</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/fetchMode.html">fetchMode</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/find.html">find</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findAll.html">findAll</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findAllBy.html">findAllBy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findAllWhere.html">findAllWhere</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findBy.html">findBy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findOrCreateBy.html">findOrCreateBy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findOrCreateWhere.html">findOrCreateWhere</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findOrSaveBy.html">findOrSaveBy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findOrSaveWhere.html">findOrSaveWhere</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/findWhere.html">findWhere</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/get.html">get</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/getAll.html">getAll</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/getDirtyPropertyNames.html">getDirtyPropertyNames</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/getPersistentValue.html">getPersistentValue</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/hasErrors.html">hasErrors</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/hasMany.html">hasMany</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/hasOne.html">hasOne</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/ident.html">ident</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/instanceOf.html">instanceOf</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/isAttached.html">isAttached</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/isDirty.html">isDirty</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/list.html">list</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/listOrderBy.html">listOrderBy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/load.html">load</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/lock.html">lock</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/mappedBy.html">mappedBy</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/mapping.html">mapping</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/merge.html">merge</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/namedQueries.html">namedQueries</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/properties.html">properties</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/read.html">read</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/refresh.html">refresh</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/removeFrom.html">removeFrom</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/save.html">save</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/transients.html">transients</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/validate.html">validate</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/where.html">where</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/withCriteria.html">withCriteria</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/withNewSession.html">withNewSession</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/withSession.html">withSession</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Domain%20Classes/withTransaction.html">withTransaction</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Plug-ins</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/URL%20mappings.html">URL mappings</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/codecs.html">codecs</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/controllers.html">controllers</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/core.html">core</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/dataSource.html">dataSource</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/domainClasses.html">domainClasses</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/filters.html">filters</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/hibernate.html">hibernate</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/i18n.html">i18n</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/logging.html">logging</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/scaffolding.html">scaffolding</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/services.html">services</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/servlets.html">servlets</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Plug-ins/web%20flow.html">web flow</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Services</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Services/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Services/scope.html">scope</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Services/transactional.html">transactional</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Servlet API</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Servlet%20API/request.html">request</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Servlet%20API/response.html">response</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Servlet%20API/servletContext.html">servletContext</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Servlet%20API/session.html">session</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Tag Libraries</h1><div class="menu-sub">
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/Usage.html">Usage</a></div>
                        
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/actionName.html">actionName</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/controllerName.html">controllerName</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/flash.html">flash</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/pageScope.html">pageScope</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/params.html">params</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/request.html">request</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/response.html">response</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/servletContext.html">servletContext</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/session.html">session</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Tags</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Tags/actionSubmit.html">actionSubmit</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/actionSubmitImage.html">actionSubmitImage</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/applyLayout.html">applyLayout</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/checkBox.html">checkBox</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/collect.html">collect</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/cookie.html">cookie</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/country.html">country</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/countrySelect.html">countrySelect</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/createLink.html">createLink</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/createLinkTo.html">createLinkTo</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/currencySelect.html">currencySelect</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/datePicker.html">datePicker</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/each.html">each</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/eachError.html">eachError</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/else.html">else</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/elseif.html">elseif</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/external.html">external</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/fieldValue.html">fieldValue</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/findAll.html">findAll</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/form.html">form</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/formRemote.html">formRemote</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/formatBoolean.html">formatBoolean</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/formatDate.html">formatDate</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/formatNumber.html">formatNumber</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/grep.html">grep</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/hasErrors.html">hasErrors</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/header.html">header</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/hiddenField.html">hiddenField</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/if.html">if</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/img.html">img</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/include.html">include</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/javascript.html">javascript</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/join.html">join</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/layoutBody.html">layoutBody</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/layoutHead.html">layoutHead</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/layoutTitle.html">layoutTitle</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/link.html">link</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/localeSelect.html">localeSelect</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/message.html">message</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/meta.html">meta</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/pageProperty.html">pageProperty</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/paginate.html">paginate</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/passwordField.html">passwordField</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/radio.html">radio</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/radioGroup.html">radioGroup</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/remoteField.html">remoteField</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/remoteFunction.html">remoteFunction</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/remoteLink.html">remoteLink</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/render.html">render</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/renderErrors.html">renderErrors</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/resource.html">resource</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/select.html">select</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/set.html">set</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/setProvider.html">setProvider</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/sortableColumn.html">sortableColumn</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/submitButton.html">submitButton</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/submitToRemote.html">submitToRemote</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/textArea.html">textArea</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/textField.html">textField</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/timeZoneSelect.html">timeZoneSelect</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/unless.html">unless</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/uploadForm.html">uploadForm</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tags/while.html">while</a>
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
            </div>
        </td>
            </tr>
        </table>

        <div id="footer">
            Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.
            Sponsored by <a href="http://springsource.com">SpringSource</a>
        </div>



<script type="text/javascript" src="../../js/docs.js"></script>

    </body>
</html>
